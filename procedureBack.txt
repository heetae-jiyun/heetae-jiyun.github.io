create proc dbo.dt_addtosourcecontrol
    @vchSourceSafeINI varchar(255) = '',
    @vchProjectName   varchar(255) ='',
    @vchComment       varchar(255) ='',
    @vchLoginName     varchar(255) ='',
    @vchPassword      varchar(255) =''

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId = 0

declare @iStreamObjectId int
select @iStreamObjectId = 0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

declare @vchDatabaseName varchar(255)
select @vchDatabaseName = db_name()

declare @iReturnValue int
select @iReturnValue = 0

declare @iPropertyObjectId int
declare @vchParentId varchar(255)

declare @iObjectCount int
select @iObjectCount = 0

    exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
    if @iReturn <> 0 GOTO E_OAError


    /* Create Project in SS */
    exec @iReturn = sp_OAMethod @iObjectId,
                                'AddProjectToSourceSafe',
                                NULL,
                                @vchSourceSafeINI,
                                @vchProjectName output,
                                @@SERVERNAME,
                                @vchDatabaseName,
                                @vchLoginName,
                                @vchPassword,
                                @vchComment


    if @iReturn <> 0 GOTO E_OAError

    exec @iReturn = sp_OAGetProperty @iObjectId, 'GetStreamObject', @iStreamObjectId OUT

    if @iReturn <> 0 GOTO E_OAError

    /* Set Database Properties */

    begin tran SetProperties

    /* add high level object */

    exec @iPropertyObjectId = dbo.dt_adduserobject_vcs 'VCSProjectID'

    select @vchParentId = CONVERT(varchar(255),@iPropertyObjectId)

    exec dbo.dt_setpropertybyid @iPropertyObjectId, 'VCSProjectID', @vchParentId , NULL
    exec dbo.dt_setpropertybyid @iPropertyObjectId, 'VCSProject' , @vchProjectName , NULL
    exec dbo.dt_setpropertybyid @iPropertyObjectId, 'VCSSourceSafeINI' , @vchSourceSafeINI , NULL
    exec dbo.dt_setpropertybyid @iPropertyObjectId, 'VCSSQLServer', @@SERVERNAME, NULL
    exec dbo.dt_setpropertybyid @iPropertyObjectId, 'VCSSQLDatabase', @vchDatabaseName, NULL

    if @@error <> 0 GOTO E_General_Error

    commit tran SetProperties

    declare cursorProcNames cursor for
        select convert(varchar(255), name) from sysobjects where type = 'P' and name not like 'dt_%'
    open cursorProcNames

    while 1 = 1
    begin
        declare @vchProcName varchar(255)
        fetch next from cursorProcNames into @vchProcName
        if @@fetch_status <> 0
            break

        select colid, text into #ProcLines
        from syscomments
        where id = object_id(@vchProcName)
        order by colid

        declare @iCurProcLine int
        declare @iProcLines int
        select @iCurProcLine = 1
        select @iProcLines = (select count(*) from #ProcLines)
        while @iCurProcLine <= @iProcLines
        begin
            declare @pos int
            select @pos = 1
            declare @iCurLineSize int
            select @iCurLineSize = len((select text from #ProcLines where colid = @iCurProcLine))
            while @pos <= @iCurLineSize
            begin
                declare @vchProcLinePiece varchar(255)
                select @vchProcLinePiece = convert(varchar(255),
                    substring((select text from #ProcLines where colid = @iCurProcLine),
                              @pos, 255 ))
                exec @iReturn = sp_OAMethod @iStreamObjectId, 'AddStream', @iReturnValue OUT, @vchProcLinePiece
                if @iReturn <> 0 GOTO E_OAError
                select @pos = @pos + 255
            end
            select @iCurProcLine = @iCurProcLine + 1
        end
        drop table #ProcLines

        exec @iReturn = sp_OAMethod @iObjectId,
                                    'CheckIn_StoredProcedure',
                      NULL,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sServerName = @@SERVERNAME,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sObjectName = @vchProcName,
                                    @sComment = @vchComment,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword,
                                    @iVCSFlags = 0,
                                    @iActionFlag = 0,
                                    @sStream = ''

        if @iReturn = 0 select @iObjectCount = @iObjectCount + 1

    end

CleanUp:
	close cursorProcNames
	deallocate cursorProcNames
    select @vchProjectName
    select @iObjectCount
    return

E_General_Error:
    /* this is an all or nothing.  No specific error messages */
    goto CleanUp

E_OAError:
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    goto CleanUp;

create proc dbo.dt_addtosourcecontrol_u
    @vchSourceSafeINI nvarchar(255) = '',
    @vchProjectName   nvarchar(255) ='',
    @vchComment       nvarchar(255) ='',
    @vchLoginName     nvarchar(255) ='',
    @vchPassword      nvarchar(255) =''

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId = 0

declare @iStreamObjectId int
select @iStreamObjectId = 0

declare @VSSGUID nvarchar(100)
select @VSSGUID = N'SQLVersionControl.VCS_SQL'

declare @vchDatabaseName varchar(255)
select @vchDatabaseName = db_name()

declare @iReturnValue int
select @iReturnValue = 0

declare @iPropertyObjectId int
declare @vchParentId nvarchar(255)

declare @iObjectCount int
select @iObjectCount = 0

    exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
    if @iReturn <> 0 GOTO E_OAError


    /* Create Project in SS */
    exec @iReturn = sp_OAMethod @iObjectId,
                                'AddProjectToSourceSafe',
                                NULL,
                                @vchSourceSafeINI,
                                @vchProjectName output,
                                @@SERVERNAME,
                                @vchDatabaseName,
                                @vchLoginName,
                                @vchPassword,
                                @vchComment


    if @iReturn <> 0 GOTO E_OAError

    exec @iReturn = sp_OAGetProperty @iObjectId, N'GetStreamObject', @iStreamObjectId OUT

    if @iReturn <> 0 GOTO E_OAError

    /* Set Database Properties */

    begin tran SetProperties

    /* add high level object */

    exec @iPropertyObjectId = dbo.dt_adduserobject_vcs 'VCSProjectID'

    select @vchParentId = CONVERT(nvarchar(255),@iPropertyObjectId)

    exec dbo.dt_setpropertybyid_u @iPropertyObjectId, 'VCSProjectID', @vchParentId , NULL
    exec dbo.dt_setpropertybyid_u @iPropertyObjectId, 'VCSProject' , @vchProjectName , NULL
    exec dbo.dt_setpropertybyid_u @iPropertyObjectId, 'VCSSourceSafeINI' , @vchSourceSafeINI , NULL
    exec dbo.dt_setpropertybyid_u @iPropertyObjectId, 'VCSSQLServer', @@SERVERNAME, NULL
    exec dbo.dt_setpropertybyid_u @iPropertyObjectId, 'VCSSQLDatabase', @vchDatabaseName, NULL

    if @@error <> 0 GOTO E_General_Error

    commit tran SetProperties

    declare cursorProcNames cursor for
        select convert(nvarchar(255), name) from sysobjects where type = N'P' and name not like N'dt_%'
    open cursorProcNames

    while 1 = 1
    begin
        declare @vchProcName nvarchar(255)
        fetch next from cursorProcNames into @vchProcName
        if @@fetch_status <> 0
            break

        select colid, text into #ProcLines
        from syscomments
        where id = object_id(@vchProcName)
        order by colid

        declare @iCurProcLine int
        declare @iProcLines int
        select @iCurProcLine = 1
        select @iProcLines = (select count(*) from #ProcLines)
        while @iCurProcLine <= @iProcLines
        begin
            declare @pos int
            select @pos = 1
            declare @iCurLineSize int
            select @iCurLineSize = len((select text from #ProcLines where colid = @iCurProcLine))
            while @pos <= @iCurLineSize
            begin
                declare @vchProcLinePiece nvarchar(255)
                select @vchProcLinePiece = convert(nvarchar(255),
                    substring((select text from #ProcLines where colid = @iCurProcLine),
                              @pos, 255 ))
                exec @iReturn = sp_OAMethod @iStreamObjectId, N'AddStream', @iReturnValue OUT, @vchProcLinePiece
                if @iReturn <> 0 GOTO E_OAError
                select @pos = @pos + 255
            end
            select @iCurProcLine = @iCurProcLine + 1
        end
        drop table #ProcLines

        exec @iReturn = sp_OAMethod @iObjectId,
                                    'CheckIn_StoredProcedure',
                                    NULL,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sServerName = @@SERVERNAME,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sObjectName = @vchProcName,
                                    @sComment = @vchComment,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword,
                                    @iVCSFlags = 0,
                                    @iActionFlag = 0,
                                    @sStream = ''

        if @iReturn = 0 select @iObjectCount = @iObjectCount + 1

    end

CleanUp:
	close cursorProcNames
	deallocate cursorProcNames
    select @vchProjectName
    select @iObjectCount
    return

E_General_Error:
    /* this is an all or nothing.  No specific error messages */
    goto CleanUp

E_OAError:
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    goto CleanUp;

/*
**	Add an object to the dtproperties table
*/
create procedure dbo.dt_adduserobject
as
	set nocount on
	/*
	** Create the user object if it does not exist already
	*/
	begin transaction
		insert dbo.dtproperties (property) VALUES ('DtgSchemaOBJECT')
		update dbo.dtproperties set objectid=@@identity 
			where id=@@identity and property='DtgSchemaOBJECT'
	commit
	return @@identity;

create procedure dbo.dt_adduserobject_vcs
    @vchProperty varchar(64)

as

set nocount on

declare @iReturn int
    /*
    ** Create the user object if it does not exist already
    */
    begin transaction
        select @iReturn = objectid from dbo.dtproperties where property = @vchProperty
        if @iReturn IS NULL
        begin
            insert dbo.dtproperties (property) VALUES (@vchProperty)
            update dbo.dtproperties set objectid=@@identity
                    where id=@@identity and property=@vchProperty
            select @iReturn = @@identity
        end
    commit
    return @iReturn;

create proc dbo.dt_checkinobject
    @chObjectType  char(4),
    @vchObjectName varchar(255),
    @vchComment    varchar(255)='',
    @vchLoginName  varchar(255),
    @vchPassword   varchar(255)='',
    @iVCSFlags     int = 0,
    @iActionFlag   int = 0,   /* 0 => AddFile, 1 => CheckIn */
    @txStream1     Text = '', /* There is a bug that if items are NULL they do not pass to OLE servers */
    @txStream2     Text = '',
    @txStream3     Text = ''


as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId = 0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'


declare @iPropertyObjectId int
select @iPropertyObjectId  = 0

    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   varchar(255)
    declare @vchSourceSafeINI varchar(255)
    declare @vchServerName    varchar(255)
    declare @vchDatabaseName  varchar(255)
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        if @iActionFlag = 1
        begin
            /* Procedure Can have up to three streams
            Drop Stream, Create Stream, GRANT stream */

            begin tran compile_all

            /* try to compile the streams */
            exec (@txStream1)
            if @@error <> 0 GOTO E_Compile_Fail

            exec (@txStream2)
            if @@error <> 0 GOTO E_Compile_Fail

            exec (@txStream3)
            if @@error <> 0 GOTO E_Compile_Fail
        end

        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
        if @iReturn <> 0 GOTO E_OAError

        if @iActionFlag = 1
        begin
            exec @iReturn = sp_OAMethod @iObjectId,
                                        'CheckIn_StoredProcedure',
                                        NULL,
                                        @sProjectName = @vchProjectName,
                                        @sSourceSafeINI = @vchSourceSafeINI,
                                        @sServerName = @vchServerName,
                                        @sDatabaseName = @vchDatabaseName,
                                        @sObjectName = @vchObjectName,
                                        @sComment = @vchComment,
                                        @sLoginName = @vchLoginName,
                                        @sPassword = @vchPassword,
                                        @iVCSFlags = @iVCSFlags,
                                        @iActionFlag = @iActionFlag,
                                        @sStream = @txStream2
        end
        else
        begin
            declare @iStreamObjectId int
            declare @iReturnValue int

            exec @iReturn = sp_OAGetProperty @iObjectId, 'GetStreamObject', @iStreamObjectId OUT
            if @iReturn <> 0 GOTO E_OAError

            select colid, text into #ProcLines
            from syscomments
            where id = object_id(@vchObjectName)
            order by colid

            declare @iCurProcLine int
            declare @iProcLines int
            select @iCurProcLine = 1
            select @iProcLines = (select count(*) from #ProcLines)
            while @iCurProcLine <= @iProcLines
            begin
                declare @pos int
                select @pos = 1
                declare @iCurLineSize int
                select @iCurLineSize = len((select text from #ProcLines where colid = @iCurProcLine))
                while @pos <= @iCurLineSize
                begin
               declare @vchProcLinePiece varchar(255)
                    select @vchProcLinePiece = convert(varchar(255),
                        substring((select text from #ProcLines where colid = @iCurProcLine),
                                  @pos, 255 ))
                    exec @iReturn = sp_OAMethod @iStreamObjectId, 'AddStream', @iReturnValue OUT, @vchProcLinePiece
                    if @iReturn <> 0 GOTO E_OAError
                    select @pos = @pos + 255
                end
                select @iCurProcLine = @iCurProcLine + 1
            end
            drop table #ProcLines

            exec @iReturn = sp_OAMethod @iObjectId,
                                        'CheckIn_StoredProcedure',
                                        NULL,
                                        @sProjectName = @vchProjectName,
                                        @sSourceSafeINI = @vchSourceSafeINI,
                                        @sServerName = @vchServerName,
                                        @sDatabaseName = @vchDatabaseName,
                                        @sObjectName = @vchObjectName,
                                        @sComment = @vchComment,
                                        @sLoginName = @vchLoginName,
                                        @sPassword = @vchPassword,
                                        @iVCSFlags = @iVCSFlags,
                                        @iActionFlag = @iActionFlag,
                                        @sStream = ''
        end

        if @iReturn <> 0 GOTO E_OAError

        if @iActionFlag = 1
        begin
            commit tran compile_all
            if @@error <> 0 GOTO E_Compile_Fail
        end

    end

CleanUp:
    return

E_Compile_Fail:
    declare @lerror int
    select @lerror = @@error
    rollback tran compile_all
    RAISERROR (@lerror,16,-1)
    goto CleanUp

E_OAError:
    if @iActionFlag = 1 rollback tran compile_all
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    goto CleanUp;

create proc dbo.dt_checkinobject_u
    @chObjectType  char(4),
    @vchObjectName nvarchar(255),
    @vchComment    nvarchar(255)='',
    @vchLoginName  nvarchar(255),
    @vchPassword   nvarchar(255)='',
    @iVCSFlags     int = 0,
    @iActionFlag   int = 0,   /* 0 => AddFile, 1 => CheckIn */
    @txStream1     Text = '', /* There is a bug that if items are NULL they do not pass to OLE servers */
    @txStream2     Text = '',
    @txStream3     Text = ''


as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId = 0

declare @VSSGUID nvarchar(100)
select @VSSGUID = N'SQLVersionControl.VCS_SQL'


declare @iPropertyObjectId int
select @iPropertyObjectId  = 0

    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   nvarchar(255)
    declare @vchSourceSafeINI nvarchar(255)
    declare @vchServerName    nvarchar(255)
    declare @vchDatabaseName  nvarchar(255)
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        if @iActionFlag = 1
        begin
            /* Procedure Can have up to three streams
            Drop Stream, Create Stream, GRANT stream */

            begin tran compile_all

            /* try to compile the streams */
            exec (@txStream1)
            if @@error <> 0 GOTO E_Compile_Fail

            exec (@txStream2)
            if @@error <> 0 GOTO E_Compile_Fail

            exec (@txStream3)
            if @@error <> 0 GOTO E_Compile_Fail
        end

        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
        if @iReturn <> 0 GOTO E_OAError

        if @iActionFlag = 1
        begin
            exec @iReturn = sp_OAMethod @iObjectId,
                                        N'CheckIn_StoredProcedure',
                                        NULL,
                                        @sProjectName = @vchProjectName,
                                        @sSourceSafeINI = @vchSourceSafeINI,
                                        @sServerName = @vchServerName,
                                        @sDatabaseName = @vchDatabaseName,
                                        @sObjectName = @vchObjectName,
                                        @sComment = @vchComment,
                                        @sLoginName = @vchLoginName,
                                        @sPassword = @vchPassword,
                                        @iVCSFlags = @iVCSFlags,
                                        @iActionFlag = @iActionFlag,
                                        @sStream = @txStream2
        end
        else
        begin
            declare @iStreamObjectId int
            declare @iReturnValue int

            exec @iReturn = sp_OAGetProperty @iObjectId, N'GetStreamObject', @iStreamObjectId OUT
            if @iReturn <> 0 GOTO E_OAError

            select colid, text into #ProcLines
            from syscomments
            where id = object_id(@vchObjectName)
            order by colid

            declare @iCurProcLine int
            declare @iProcLines int
            select @iCurProcLine = 1
            select @iProcLines = (select count(*) from #ProcLines)
            while @iCurProcLine <= @iProcLines
            begin
                declare @pos int
                select @pos = 1
                declare @iCurLineSize int
                select @iCurLineSize = len((select text from #ProcLines where colid = @iCurProcLine))
                while @pos <= @iCurLineSize
          begin
                    declare @vchProcLinePiece nvarchar(255)
                    select @vchProcLinePiece = convert(nvarchar(255),
                        substring((select text from #ProcLines where colid = @iCurProcLine),
                                  @pos, 255 ))
                    exec @iReturn = sp_OAMethod @iStreamObjectId, N'AddStream', @iReturnValue OUT, @vchProcLinePiece
                    if @iReturn <> 0 GOTO E_OAError
                    select @pos = @pos + 255
                end
                select @iCurProcLine = @iCurProcLine + 1
            end
            drop table #ProcLines

            exec @iReturn = sp_OAMethod @iObjectId,
                                        N'CheckIn_StoredProcedure',
                                        NULL,
                                        @sProjectName = @vchProjectName,
                                        @sSourceSafeINI = @vchSourceSafeINI,
                                        @sServerName = @vchServerName,
                                        @sDatabaseName = @vchDatabaseName,
                                        @sObjectName = @vchObjectName,
                                        @sComment = @vchComment,
                                        @sLoginName = @vchLoginName,
                                        @sPassword = @vchPassword,
                                        @iVCSFlags = @iVCSFlags,
                                        @iActionFlag = @iActionFlag,
                                        @sStream = ''
        end

        if @iReturn <> 0 GOTO E_OAError

        if @iActionFlag = 1
        begin
            commit tran compile_all
            if @@error <> 0 GOTO E_Compile_Fail
        end

    end

CleanUp:
    return

E_Compile_Fail:
    declare @lerror int
    select @lerror = @@error
    rollback tran compile_all
    RAISERROR (@lerror,16,-1)
    goto CleanUp

E_OAError:
    if @iActionFlag = 1 rollback tran compile_all
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    goto CleanUp;

create proc dbo.dt_checkoutobject
    @chObjectType  char(4),
    @vchObjectName varchar(255),
    @vchComment    varchar(255),
    @vchLoginName  varchar(255),
    @vchPassword   varchar(255),
    @iVCSFlags     int = 0,
    @iActionFlag   int = 0/* 0 => Checkout, 1 => GetLatest, 2 => UndoCheckOut */

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

declare @iReturnValue int
select @iReturnValue = 0

declare @vchTempText varchar(255)

/* this is for our strings */
declare @iStreamObjectId int
select @iStreamObjectId = 0

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   varchar(255)
    declare @vchSourceSafeINI varchar(255)
    declare @vchServerName    varchar(255)
    declare @vchDatabaseName  varchar(255)
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        /* Procedure Can have up to three streams
           Drop Stream, Create Stream, GRANT stream */

        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAMethod @iObjectId,
                                    'CheckOut_StoredProcedure',
                                    NULL,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sObjectName = @vchObjectName,
                                    @sServerName = @vchServerName,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sComment = @vchComment,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword,
                                    @iVCSFlags = @iVCSFlags,
                                    @iActionFlag = @iActionFlag

        if @iReturn <> 0 GOTO E_OAError


        exec @iReturn = sp_OAGetProperty @iObjectId, 'GetStreamObject', @iStreamObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        create table #commenttext (id int identity, sourcecode varchar(255))


        select @vchTempText = 'STUB'
        while @vchTempText IS NOT NULL
        begin
            exec @iReturn = sp_OAMethod @iStreamObjectId, 'GetStream', @iReturnValue OUT, @vchTempText OUT
            if @iReturn <> 0 GOTO E_OAError

            if (@vchTempText IS NOT NULL) insert into #commenttext (sourcecode) select @vchTempText
        end

        select 'VCS'=sourcecode from #commenttext order by id
        select 'SQL'=text from syscomments where id = object_id(@vchObjectName) order by colid

    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    GOTO CleanUp;

create proc dbo.dt_checkoutobject_u
    @chObjectType  char(4),
    @vchObjectName nvarchar(255),
    @vchComment    nvarchar(255),
    @vchLoginName  nvarchar(255),
    @vchPassword   nvarchar(255),
    @iVCSFlags     int = 0,
    @iActionFlag   int = 0/* 0 => Checkout, 1 => GetLatest, 2 => UndoCheckOut */

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID nvarchar(100)
select @VSSGUID = N'SQLVersionControl.VCS_SQL'

declare @iReturnValue int
select @iReturnValue = 0

declare @vchTempText nvarchar(255)

/* this is for our strings */
declare @iStreamObjectId int
select @iStreamObjectId = 0

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   nvarchar(255)
    declare @vchSourceSafeINI nvarchar(255)
    declare @vchServerName    nvarchar(255)
    declare @vchDatabaseName  nvarchar(255)
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        /* Procedure Can have up to three streams
           Drop Stream, Create Stream, GRANT stream */

        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAMethod @iObjectId,
                                    N'CheckOut_StoredProcedure',
                                    NULL,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sObjectName = @vchObjectName,
                                    @sServerName = @vchServerName,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sComment = @vchComment,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword,
                                    @iVCSFlags = @iVCSFlags,
                                    @iActionFlag = @iActionFlag

        if @iReturn <> 0 GOTO E_OAError


        exec @iReturn = sp_OAGetProperty @iObjectId, N'GetStreamObject', @iStreamObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        create table #commenttext (id int identity, sourcecode nvarchar(255))


        select @vchTempText = N'STUB'
        while @vchTempText IS NOT NULL
        begin
            exec @iReturn = sp_OAMethod @iStreamObjectId, N'GetStream', @iReturnValue OUT, @vchTempText OUT
            if @iReturn <> 0 GOTO E_OAError

            if (@vchTempText IS NOT NULL) insert into #commenttext (sourcecode) select @vchTempText
        end

        select N'VCS'=sourcecode from #commenttext order by id
        select N'SQL'=text from syscomments where id = object_id(@vchObjectName) order by colid

    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    GOTO CleanUp;

CREATE PROCEDURE dbo.dt_displayoaerror
    @iObject int,
    @iresult int
as

set nocount on

declare @vchOutput      varchar(255)
declare @hr             int
declare @vchSource      varchar(255)
declare @vchDescription varchar(255)

    exec @hr = sp_OAGetErrorInfo @iObject, @vchSource OUT, @vchDescription OUT

    select @vchOutput = @vchSource + ': ' + @vchDescription
    raiserror (@vchOutput,16,-1)

    return;

CREATE PROCEDURE dbo.dt_displayoaerror_u
    @iObject int,
    @iresult int
as

set nocount on

declare @vchOutput      nvarchar(255)
declare @hr             int
declare @vchSource      nvarchar(255)
declare @vchDescription nvarchar(255)

    exec @hr = sp_OAGetErrorInfo @iObject, @vchSource OUT, @vchDescription OUT

    select @vchOutput = @vchSource + ': ' + @vchDescription
    raiserror (@vchOutput,16,-1)

    return;

/*
**	Drop one or all the associated properties of an object or an attribute 
**
**	dt_dropproperties objid, null or '' -- drop all properties of the object itself
**	dt_dropproperties objid, property -- drop the property
*/
create procedure dbo.dt_droppropertiesbyid
	@id int,
	@property varchar(64)
as
	set nocount on

	if (@property is null) or (@property = '')
		delete from dbo.dtproperties where objectid=@id
	else
		delete from dbo.dtproperties 
			where objectid=@id and property=@property;

/*
**	Drop an object from the dbo.dtproperties table
*/
create procedure dbo.dt_dropuserobjectbyid
	@id int
as
	set nocount on
	delete from dbo.dtproperties where objectid=@id;

/* 
**	Generate an ansi name that is unique in the dtproperties.value column 
*/ 
create procedure dbo.dt_generateansiname(@name varchar(255) output) 
as 
	declare @prologue varchar(20) 
	declare @indexstring varchar(20) 
	declare @index integer 
 
	set @prologue = 'MSDT-A-' 
	set @index = 1 
 
	while 1 = 1 
	begin 
		set @indexstring = cast(@index as varchar(20)) 
		set @name = @prologue + @indexstring 
		if not exists (select value from dtproperties where value = @name) 
			break 
		 
		set @index = @index + 1 
 
		if (@index = 10000) 
			goto TooMany 
	end 
 
Leave: 
 
	return 
 
TooMany: 
 
	set @name = 'DIAGRAM' 
	goto Leave;

/*
**	Retrieve the owner object(s) of a given property
*/
create procedure dbo.dt_getobjwithprop
	@property varchar(30),
	@value varchar(255)
as
	set nocount on

	if (@property is null) or (@property = '')
	begin
		raiserror('Must specify a property name.',-1,-1)
		return (1)
	end

	if (@value is null)
		select objectid id from dbo.dtproperties
			where property=@property

	else
		select objectid id from dbo.dtproperties
			where property=@property and value=@value;

/*
**	Retrieve the owner object(s) of a given property
*/
create procedure dbo.dt_getobjwithprop_u
	@property varchar(30),
	@uvalue nvarchar(255)
as
	set nocount on

	if (@property is null) or (@property = '')
	begin
		raiserror('Must specify a property name.',-1,-1)
		return (1)
	end

	if (@uvalue is null)
		select objectid id from dbo.dtproperties
			where property=@property

	else
		select objectid id from dbo.dtproperties
			where property=@property and uvalue=@uvalue;

/*
**	Retrieve properties by id's
**
**	dt_getproperties objid, null or '' -- retrieve all properties of the object itself
**	dt_getproperties objid, property -- retrieve the property specified
*/
create procedure dbo.dt_getpropertiesbyid
	@id int,
	@property varchar(64)
as
	set nocount on

	if (@property is null) or (@property = '')
		select property, version, value, lvalue
			from dbo.dtproperties
			where  @id=objectid
	else
		select property, version, value, lvalue
			from dbo.dtproperties
			where  @id=objectid and @property=property;

/*
**	Retrieve properties by id's
**
**	dt_getproperties objid, null or '' -- retrieve all properties of the object itself
**	dt_getproperties objid, property -- retrieve the property specified
*/
create procedure dbo.dt_getpropertiesbyid_u
	@id int,
	@property varchar(64)
as
	set nocount on

	if (@property is null) or (@property = '')
		select property, version, uvalue, lvalue
			from dbo.dtproperties
			where  @id=objectid
	else
		select property, version, uvalue, lvalue
			from dbo.dtproperties
			where  @id=objectid and @property=property;

create procedure dbo.dt_getpropertiesbyid_vcs
    @id       int,
    @property varchar(64),
    @value    varchar(255) = NULL OUT

as

    set nocount on

    select @value = (
        select value
                from dbo.dtproperties
                where @id=objectid and @property=property
                );

create procedure dbo.dt_getpropertiesbyid_vcs_u
    @id       int,
    @property varchar(64),
    @value    nvarchar(255) = NULL OUT

as

    set nocount on

    select @value = (
        select uvalue
                from dbo.dtproperties
                where @id=objectid and @property=property
                );

create proc dbo.dt_isundersourcecontrol
    @vchLoginName varchar(255) = '',
    @vchPassword  varchar(255) = '',
    @iWhoToo      int = 0 /* 0 => Just check project; 1 => get list of objs */

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId = 0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

declare @iReturnValue int
select @iReturnValue = 0

declare @iStreamObjectId int
select @iStreamObjectId   = 0

declare @vchTempText varchar(255)

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   varchar(255)
    declare @vchSourceSafeINI varchar(255)
    declare @vchServerName    varchar(255)
    declare @vchDatabaseName  varchar(255)
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if (@vchProjectName IS NULL) or (@vchSourceSafeINI  IS NULL) or (@vchServerName IS NULL) or (@vchDatabaseName IS NULL)
    begin
        RAISERROR('Not Under Source Control',16,-1)
        return
    end

    if @iWhoToo = 1
    begin

        /* Get List of Procs in the project */
        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAMethod @iObjectId,
                                    'GetListOfObjects',
                                    NULL,
                                    @vchProjectName,
                                    @vchSourceSafeINI,
                                    @vchServerName,
                                    @vchDatabaseName,
                                    @vchLoginName,
                                    @vchPassword

        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAGetProperty @iObjectId, 'GetStreamObject', @iStreamObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        create table #ObjectList (id int identity, vchObjectlist varchar(255))

        select @vchTempText = 'STUB'
        while @vchTempText IS NOT NULL
        begin
            exec @iReturn = sp_OAMethod @iStreamObjectId, 'GetStream', @iReturnValue OUT, @vchTempText OUT
            if @iReturn <> 0 GOTO E_OAError

            if (@vchTempText IS NOT NULL) insert into #ObjectList (vchObjectlist ) select @vchTempText
        end

        select vchObjectlist from #ObjectList order by id
    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    goto CleanUp;

create proc dbo.dt_isundersourcecontrol_u
    @vchLoginName nvarchar(255) = '',
    @vchPassword  nvarchar(255) = '',
    @iWhoToo      int = 0 /* 0 => Just check project; 1 => get list of objs */

as

	set nocount on

	declare @iReturn int
	declare @iObjectId int
	select @iObjectId = 0

	declare @VSSGUID nvarchar(100)
	select @VSSGUID = N'SQLVersionControl.VCS_SQL'

	declare @iReturnValue int
	select @iReturnValue = 0

	declare @iStreamObjectId int
	select @iStreamObjectId   = 0

	declare @vchTempText nvarchar(255)

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   nvarchar(255)
    declare @vchSourceSafeINI nvarchar(255)
    declare @vchServerName    nvarchar(255)
    declare @vchDatabaseName  nvarchar(255)
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if (@vchProjectName IS NULL) or (@vchSourceSafeINI  IS NULL) or (@vchServerName IS NULL) or (@vchDatabaseName IS NULL)
    begin
        RAISERROR(N'Not Under Source Control',16,-1)
        return
    end

    if @iWhoToo = 1
    begin

        /* Get List of Procs in the project */
        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAMethod @iObjectId,
                                    N'GetListOfObjects',
                                    NULL,
                                    @vchProjectName,
                                    @vchSourceSafeINI,
                                    @vchServerName,
                                    @vchDatabaseName,
                                    @vchLoginName,
                                    @vchPassword

        if @iReturn <> 0 GOTO E_OAError

        exec @iReturn = sp_OAGetProperty @iObjectId, N'GetStreamObject', @iStreamObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        create table #ObjectList (id int identity, vchObjectlist nvarchar(255))

        select @vchTempText = N'STUB'
        while @vchTempText IS NOT NULL
        begin
            exec @iReturn = sp_OAMethod @iStreamObjectId, N'GetStream', @iReturnValue OUT, @vchTempText OUT
            if @iReturn <> 0 GOTO E_OAError

            if (@vchTempText IS NOT NULL) insert into #ObjectList (vchObjectlist ) select @vchTempText
        end

        select vchObjectlist from #ObjectList order by id
    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    goto CleanUp;

create procedure dbo.dt_removefromsourcecontrol

as

    set nocount on

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    exec dbo.dt_droppropertiesbyid @iPropertyObjectId, null

    /* -1 is returned by dt_droppopertiesbyid */
    if @@error <> 0 and @@error <> -1 return 1

    return 0;

/*
**	If the property already exists, reset the value; otherwise add property
**		id -- the id in sysobjects of the object
**		property -- the name of the property
**		value -- the text value of the property
**		lvalue -- the binary value of the property (image)
*/
create procedure dbo.dt_setpropertybyid
	@id int,
	@property varchar(64),
	@value varchar(255),
	@lvalue image
as
	set nocount on
	declare @uvalue nvarchar(255) 
	set @uvalue = convert(nvarchar(255), @value) 
	if exists (select * from dbo.dtproperties 
			where objectid=@id and property=@property)
	begin
		--
		-- bump the version count for this row as we update it
		--
		update dbo.dtproperties set value=@value, uvalue=@uvalue, lvalue=@lvalue, version=version+1
			where objectid=@id and property=@property
	end
	else
	begin
		--
		-- version count is auto-set to 0 on initial insert
		--
		insert dbo.dtproperties (property, objectid, value, uvalue, lvalue)
			values (@property, @id, @value, @uvalue, @lvalue)
	end;

/*
**	If the property already exists, reset the value; otherwise add property
**		id -- the id in sysobjects of the object
**		property -- the name of the property
**		uvalue -- the text value of the property
**		lvalue -- the binary value of the property (image)
*/
create procedure dbo.dt_setpropertybyid_u
	@id int,
	@property varchar(64),
	@uvalue nvarchar(255),
	@lvalue image
as
	set nocount on
	-- 
	-- If we are writing the name property, find the ansi equivalent. 
	-- If there is no lossless translation, generate an ansi name. 
	-- 
	declare @avalue varchar(255) 
	set @avalue = null 
	if (@uvalue is not null) 
	begin 
		if (convert(nvarchar(255), convert(varchar(255), @uvalue)) = @uvalue) 
		begin 
			set @avalue = convert(varchar(255), @uvalue) 
		end 
		else 
		begin 
			if 'DtgSchemaNAME' = @property 
			begin 
				exec dbo.dt_generateansiname @avalue output 
			end 
		end 
	end 
	if exists (select * from dbo.dtproperties 
			where objectid=@id and property=@property)
	begin
		--
		-- bump the version count for this row as we update it
		--
		update dbo.dtproperties set value=@avalue, uvalue=@uvalue, lvalue=@lvalue, version=version+1
			where objectid=@id and property=@property
	end
	else
	begin
		--
		-- version count is auto-set to 0 on initial insert
		--
		insert dbo.dtproperties (property, objectid, value, uvalue, lvalue)
			values (@property, @id, @avalue, @uvalue, @lvalue)
	end;

create proc dbo.dt_validateloginparams
    @vchLoginName  varchar(255),
    @vchPassword   varchar(255)
as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchSourceSafeINI varchar(255)
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT

    exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
    if @iReturn <> 0 GOTO E_OAError

    exec @iReturn = sp_OAMethod @iObjectId,
                                'ValidateLoginParams',
                                NULL,
                                @sSourceSafeINI = @vchSourceSafeINI,
                                @sLoginName = @vchLoginName,
                                @sPassword = @vchPassword
    if @iReturn <> 0 GOTO E_OAError

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    GOTO CleanUp;

create proc dbo.dt_validateloginparams_u
    @vchLoginName  nvarchar(255),
    @vchPassword   nvarchar(255)
as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID nvarchar(100)
select @VSSGUID = N'SQLVersionControl.VCS_SQL'

    declare @iPropertyObjectId int
    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchSourceSafeINI nvarchar(255)
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT

    exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
    if @iReturn <> 0 GOTO E_OAError

    exec @iReturn = sp_OAMethod @iObjectId,
                                N'ValidateLoginParams',
                                NULL,
                                @sSourceSafeINI = @vchSourceSafeINI,
                                @sLoginName = @vchLoginName,
                                @sPassword = @vchPassword
    if @iReturn <> 0 GOTO E_OAError

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    GOTO CleanUp;

create proc dbo.dt_vcsenabled

as

set nocount on

declare @iObjectId int
select @iObjectId = 0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

    declare @iReturn int
    exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT
    if @iReturn <> 0 raiserror('', 16, -1) /* Can't Load Helper DLLC */;

/*
**	This procedure returns the version number of the stored
**    procedures used by the Microsoft Visual Database Tools.
**    Current version is 7.0.00.
*/
create procedure dbo.dt_verstamp006
as
	select 7000;

create proc dbo.dt_whocheckedout
        @chObjectType  char(4),
        @vchObjectName varchar(255),
        @vchLoginName  varchar(255),
        @vchPassword   varchar(255)

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID varchar(100)
select @VSSGUID = 'SQLVersionControl.VCS_SQL'

    declare @iPropertyObjectId int

    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   varchar(255)
    declare @vchSourceSafeINI varchar(255)
    declare @vchServerName    varchar(255)
    declare @vchDatabaseName  varchar(255)
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        declare @vchReturnValue varchar(255)
        select @vchReturnValue = ''

        exec @iReturn = sp_OAMethod @iObjectId,
                                    'WhoCheckedOut',
                                    @vchReturnValue OUT,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sObjectName = @vchObjectName,
                                    @sServerName = @vchServerName,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword

        if @iReturn <> 0 GOTO E_OAError

        select @vchReturnValue

    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror @iObjectId, @iReturn
    GOTO CleanUp;

create proc dbo.dt_whocheckedout_u
        @chObjectType  char(4),
        @vchObjectName nvarchar(255),
        @vchLoginName  nvarchar(255),
        @vchPassword   nvarchar(255)

as

set nocount on

declare @iReturn int
declare @iObjectId int
select @iObjectId =0

declare @VSSGUID nvarchar(100)
select @VSSGUID = N'SQLVersionControl.VCS_SQL'

    declare @iPropertyObjectId int

    select @iPropertyObjectId = (select objectid from dbo.dtproperties where property = 'VCSProjectID')

    declare @vchProjectName   nvarchar(255)
    declare @vchSourceSafeINI nvarchar(255)
    declare @vchServerName    nvarchar(255)
    declare @vchDatabaseName  nvarchar(255)
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSProject',       @vchProjectName   OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSourceSafeINI', @vchSourceSafeINI OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLServer',     @vchServerName    OUT
    exec dbo.dt_getpropertiesbyid_vcs_u @iPropertyObjectId, 'VCSSQLDatabase',   @vchDatabaseName  OUT

    if @chObjectType = 'PROC'
    begin
        exec @iReturn = sp_OACreate @VSSGUID, @iObjectId OUT

        if @iReturn <> 0 GOTO E_OAError

        declare @vchReturnValue nvarchar(255)
        select @vchReturnValue = ''

        exec @iReturn = sp_OAMethod @iObjectId,
                                    N'WhoCheckedOut',
                                    @vchReturnValue OUT,
                                    @sProjectName = @vchProjectName,
                                    @sSourceSafeINI = @vchSourceSafeINI,
                                    @sObjectName = @vchObjectName,
                                    @sServerName = @vchServerName,
                                    @sDatabaseName = @vchDatabaseName,
                                    @sLoginName = @vchLoginName,
                                    @sPassword = @vchPassword

        if @iReturn <> 0 GOTO E_OAError

        select @vchReturnValue

    end

CleanUp:
    return

E_OAError:
    exec dbo.dt_displayoaerror_u @iObjectId, @iReturn
    GOTO CleanUp;

/*******************************************************************************************************************/
/*  SP NAME      : fCheckBatchOption                                                                                                                                                    */
/*  DISCRIPTION  : batch option read                                                                                                                                */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE FUNCTION [dbo].[fCheckBatchOption] ( 
	@job_id varchar(30),@page_option varchar(255)) RETURNS varchar(50) 
AS
--select mrp.dbo.fCheckBatchOption('DOWN_8A6','Gaijung=ELES&From_date=20100321&To_date=2010&Supply=&Vendor1=&Vendor2=&Vendor3=&Vendor4=&Vendor5=')

begin
	declare	@indx_equal			int,
			@indx_amps			int,
			@check_method_1		varchar(10),
			@check_method_2		varchar(10),
			@must_fill			char(01),
			@token				varchar(255),
			@option_Code		varchar(20),
			@option_Value		varchar(255)
	
	
	while(len(@page_option)>0)
	begin
		select @indx_amps=charindex('&',@page_option)
		
		if @indx_amps > 0
		begin
			select @token=left(@page_option,@indx_amps-1)
			select @page_option=substring(@page_option,@indx_amps+1,255)
		end
		else
		begin
			select @token=@page_option
			select @page_option=''
		end

		select @indx_equal = charindex('=',@token)
		
		if @indx_equal = 0
			return('')
		
		select @option_Code = left(@token,@indx_equal-1)
		select @option_Value = substring(@token,@indx_equal+1,255)
		
		select	@check_method_1=check_method_1,
				@check_method_2=check_method_2,
				@must_fill = must_fill
		from X_Batch_Job_Option_Field
		where job_id = @job_id
		and option_field = @option_Code
		
		if @must_fill = 'Y' and @option_Value < '0'
			return(@option_Code)
			
		if @option_Value > '0' 
		begin
			if @check_method_1 = 'Date' and ( len(@option_Value)<>8 or isdate(@option_Value)=0 )
				return(@option_Code)
			
			if @check_method_1 = 'Month' and ( len(@option_Value)<>6 or isdate(@option_Value+'01')=0 )
				return(@option_Code)
			
			if @check_method_1 = 'year' and ( len(@option_Value)<>4 or isdate(@option_Value+'0101')=0 )
				return(@option_Code)
				
			if @check_method_1 = 'CodeG'
				if not exists ( select *
								from el_cd..t_ex_000 with (nolock)
								where code_select = @check_method_2
								and code = @option_Value)
					return(@option_Code)
					
			if @check_method_1 = 'CodeM'
			begin
				if @check_method_2 = 'Vendor'
					if not exists ( select *
								from el_cd..t_cx_080 with (nolock)
								where trade_no = @option_Value)
						return(@option_Code)
				else if @check_method_2 = 'Item'
					if not exists ( select *
								from el_cd..t_cx_060 with (nolock)
								where item_no = @option_Value)
						return(@option_Code)
			end
		end
	end

	return ''
end;

/*******************************************************************************************************************/
/*  SP NAME      : fGetOption                                                                                                                                                    */
/*  DISCRIPTION  : batch option read                                                                                                                                */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE FUNCTION [dbo].[fGetOption] ( @job_id varchar(20),@page datetime,@option varchar(20)) RETURNS varchar(20) AS

begin
	declare	@page_option	varchar(255)

	select @page_option=page_option
	from mrp.dbo.x_batch_job_option
	where job_id=@job_id
	and page=@page

	while(len(@page_option)>0)
	begin
		if substring(@page_option,1,charindex('=',@page_option)-1) = @option
		begin
			if charindex('&',@page_option)=0
			begin
				return (substring(@page_option,charindex('=',@page_option)+1,255))
			end
			else
			begin
				select @page_option=substring(@page_option,charindex('=',@page_option)+1,255)
				return  substring(@page_option,1,charindex('&',@page_option)-1)
			end
		end
		else if charindex('&',@page_option) > 0
			select @page_option=substring(@page_option,charindex('&',@page_option)+1,255)
		else
			return ''	
	end

	return ''
end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_Due_Date_Set                                                                                                                                                    */
/*  DISCRIPTION  : 작업,계정별 납기 계산                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

--select 

CREATE FUNCTION [dbo].[fn_Common_Due_Date_Set] ( 
	@JOB_ID			varchar(10),
	@gaijung		varchar(04),
	@o_due_date		varchar(08),
	@special		char(01),
	@market_flag	char(01),
	@order_period	int,
	@order_range	int,
	@o_curr_date	varchar(08)	) RETURNS char(08) 
AS

begin


--select mrp.dbo.fn_Common_Due_Date_Set('MRP_6EI','ELES','20091225','','D',5,0,'20090101')

	declare	@cnt				int,
			@term				int,
			@limit_date			smalldatetime,
			@result_due_date	smalldatetime,
			@due_date			smalldatetime,
			@curr_date			smalldatetime

	select	@due_date =convert(smalldatetime,@o_due_date),
			@curr_date =convert(smalldatetime,@o_curr_date)
		

	select	@order_period=isnull(@order_period,0),@order_range=isnull(@order_range,0)

	select @term=0,@cnt=0

	select @due_date=(case when @curr_date > @due_date then @curr_date else @due_date end)

	
--	if @JOB_ID = 'MRP_6EI'  /***ELES 발송발주 ***/
	if @JOB_ID in ('MRP_6EI','MRP_6EC')  /***ELES 발송발주 ***/
	begin
		if @gaijung='SYHP'
			select @term=0,@cnt=5             -- 납기가 현재로 부터 5일이내이면 5일로                
		else
			select	@term=@order_period + (case when @market_flag='E' then @order_range else 0 end),
					@cnt=(case when datepart(dw,@curr_date)= 5  then 2 else 3 end)-- 목요일이면
	end 

	if @JOB_ID = 'MRP_6EH' /*** ELES 종속발주 ***/
	begin
		if @gaijung='SYHP'
			select @term=(case when @special='Y'  then -14 else -9 end),@cnt=0     
		else
			select	@term= -7,
					@cnt=(case when datepart(dw,@curr_date)= 5  then 2 else 3 end)-- 목요일이면
	end

-- 현재로 부터 @limit_date  , 납기로 부터 @result_due_date
	--select @result_due_date=dateadd(day,@term,@due_date)
	select @result_due_date=master.dbo.fgetworkdate(@due_date, @term)
	select @limit_date=dateadd(day,@cnt,@curr_date)


-- 각각의 일자 휴일감안

	declare	@day		int

	select @day=datepart(dw,@result_due_date)

	if @day in (1,7) --과거로
		select @result_due_date=dateadd(d,(case when @day = 1 then -2 else -1 end),@result_due_date)


	select @day=datepart(dw,@limit_date)
	if @day in (1,7) --미래로
		select @limit_date=dateadd(d,(case when @day = 1 then 1 else 2 end),@limit_date)

	return convert(char(08),(case when @result_due_date >= @limit_date then @result_due_date else @limit_date end),112)

end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_Due_Date_Set                                                                                                                                                    */
/*  DISCRIPTION  : 작업,계정별 납기 계산                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

--select 

CREATE FUNCTION [dbo].[fn_Common_Due_Date_Set_jjg] ( 
	@JOB_ID			varchar(10),
	@gaijung		varchar(04),
	@o_due_date		varchar(08),
	@special		char(01),
	@market_flag	char(01),
	@order_period	int,
	@order_range	int,
	@o_curr_date	varchar(08)	) RETURNS char(08) 
AS

begin


--select mrp.dbo.fn_Common_Due_Date_Set('MRP_6EI','ELES','20091225','','D',5,0,'20090101')

	declare	@cnt				int,
			@term				int,
			@limit_date			smalldatetime,
			@result_due_date	smalldatetime,
			@due_date			smalldatetime,
			@curr_date			smalldatetime

	select	@due_date =convert(smalldatetime,@o_due_date),
			@curr_date =convert(smalldatetime,@o_curr_date)
		

	select	@order_period=isnull(@order_period,0),@order_range=isnull(@order_range,0)

	select @term=0,@cnt=0

	select @due_date=(case when @curr_date > @due_date then @curr_date else @due_date end)

	
	if @JOB_ID = 'MRP_6EI'  /***ELES 발송발주 ***/
	begin
		if @gaijung='SYHP'
			select @term=0,@cnt=5             -- 납기가 현재로 부터 5일이내이면 5일로                
		else
			select	@term=@order_period + (case when @market_flag='E' then @order_range else 0 end),
					@cnt=(case when datepart(dw,@curr_date)= 5  then 2 else 3 end)-- 목요일이면
	end 

	if @JOB_ID = 'MRP_6EH' /*** ELES 종속발주 ***/
	begin
		if @gaijung='SYHP'
			select @term=(case when @special='Y'  then -14 else -9 end),@cnt=0     
		else
			select	@term= -7,
					@cnt=(case when datepart(dw,@curr_date)= 5  then 2 else 3 end)-- 목요일이면
	end

-- 현재로 부터 @limit_date  , 납기로 부터 @result_due_date
--	select @result_due_date=dateadd(day,@term,@due_date)

	select @result_due_date=master.dbo.fgetworkdate(@due_date, @term)
	select @limit_date=dateadd(day,@cnt,@curr_date)


-- 각각의 일자 휴일감안

	declare	@day		int

	select @day=datepart(dw,@result_due_date)

	if @day in (1,7) --과거로
		select @result_due_date=dateadd(d,(case when @day = 1 then -2 else -1 end),@result_due_date)


	select @day=datepart(dw,@limit_date)
	if @day in (1,7) --미래로
		select @limit_date=dateadd(d,(case when @day = 1 then 1 else 2 end),@limit_date)

	return convert(char(08),(case when @result_due_date >= @limit_date then @result_due_date else @limit_date end),112)

end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_Job_Option_UserID                                                                                                                                                    */
/*  DISCRIPTION  : batch job option 요청자                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/25     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE FUNCTION fn_Common_Job_Option_Request_UserID ( 
	@job_id			varchar(100),
	@page			datetime
) RETURNS varchar(20)
AS
begin

	declare	@request_emp_id	varchar(20)

	select @request_emp_id=request_emp_id
	from mrp.dbo.X_batch_JOB_OPTION a
	where a.job_id = @job_id
	and a.page=@page

	return(@request_emp_id)
	
end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_Next_schedule_Date                                                                                                                                                    */
/*  DISCRIPTION  : Next_schedule_Date Search                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/16     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE FUNCTION fn_Common_Next_schedule_Date ( 
	@job_id			varchar(100),
	@planned_date_time		datetime
) RETURNS datetime
AS
begin
	if  exists (select *
			from X_Batch_Job a
			where a.job_id = @job_id
			and (a.use_flag='N' or a.job_type <> 'S') )
		return (null)



	declare	@period_type	char(01),
		@run_week	int,
		@run_weekday	char(07)

	select @period_type=period_type,@run_week=run_week,@run_weekday=run_weekday
	from X_batch_JOB_OPTION_PERIOD a
	where a.job_id = @job_id
	


	declare	@1stWeekDay	int,
		@1stWeek	int,
		@CurrWeekDay	int,
		@CurrWeek	int,
		@WeekSeq	int,
		@cnt		int

	select @cnt=0

	while (@cnt < 40)
	begin
	
		select @cnt=@cnt + 1

		select @planned_date_time=dateadd(day,1,@planned_date_time)

		select @CurrWeekDay=datepart(dw,@planned_date_time)
		select @1stWeekDay=datepart(dw,left(convert(char(08),@planned_date_time,112),6)+'01')
	
		select @1stWeek=datepart(wk,left(convert(char(08),@planned_date_time,112),6)+'01')
		select @CurrWeek=datepart(wk,@planned_date_time)
	
		select @WeekSeq = @CurrWeek - @1stWeek - (case when @1stWeekDay <= @CurrWeekDay then 0 else 1 end) + 1

		if (	@period_type='D'  or 
			@period_type='W'  and substring(@run_weekday,@CurrWeekDay,1)='1' or
			@period_type = 'M' and @run_week = @WeekSeq and substring(@run_weekday,@CurrWeekDay,1)='1')
			break
	end
	
	return (case when @cnt >= 40 then null else @planned_date_time end)


end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_Packing_Vendor                                                                                                                                                    */
/*  DISCRIPTION  : Packing Vendor Find                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE FUNCTION [dbo].[fn_Common_Packing_Vendor] ( 
	@gaijung			varchar(04),
	@market_flag		char(01),
	@product_code		varchar(03),
	@item_group_sub		varchar(10),
	@part				varchar(02) 
) RETURNS VARCHAR(08) 
AS
begin
	declare	@packing_vendor		varchar(08)

	select @item_group_sub=(case when charindex('-',@item_group_sub) > 0
					then left(@item_group_sub, charindex('-',@item_group_sub)-1)
					else @item_group_sub end) 


	if exists (select * from EL_CD..T_EX_013 y
						where  y.gaijung=@gaijung
						and y.product_code =@product_code
						and y.part = @part
						and y.item_group_sub = @item_group_sub
						and ( 	@market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							@market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y')  )
	begin
		select	@packing_vendor=isnull((select (case when @market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
										from EL_CD..T_EX_013 y
										where  y.gaijung=@gaijung
										and y.product_code =@product_code
										and y.part = @part
										and y.item_group_sub = (case when charindex('-',@item_group_sub) > 0
													then left(@item_group_sub, charindex('-',@item_group_sub)-1)
													else @item_group_sub end)
										and ( 	@market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
											@market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') ),'')
							
		return(@packing_vendor)
	end
	
	if exists (select (case when @market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
			from EL_CD..T_EX_013 y
			where  y.gaijung=@gaijung
			and y.product_code =@product_code
			and y.part = @part
			and y.item_group_sub = '*' 
			and ( 	@market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
				@market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
	begin
		select	@packing_vendor=isnull((select (case when @market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
										from EL_CD..T_EX_013 y
										where  y.gaijung=@gaijung
										and y.product_code =@product_code
										and y.part = @part
										and y.item_group_sub = '*' 
										and ( 	@market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
											@market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') ),'')
				
		return(@packing_vendor)
	end
		
	select	@packing_vendor=isnull((select (case when @market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
									from EL_CD..T_EX_013 y
									where  y.gaijung=@gaijung
									and y.product_code =@product_code
									and y.part = '*'
									and (	y.item_group_sub = (case when charindex('-',@item_group_sub) > 0
												then left(@item_group_sub, charindex('-',@item_group_sub)-1)
												else @item_group_sub end) )
									and ( 	@market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
										@market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') ),'')

	return(@packing_vendor)

end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_PO_Run_status                                                                                                                                                    */
/*  DISCRIPTION  : PO Runstatus decision                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/27     MRP Downsizing Project   J.G.Jeon      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE FUNCTION [dbo].[fn_Common_PO_Run_status] ( 
	@gaijung		varchar(04),
	@post_person	varchar(04),
	@part			char(02),
	@supply			char(01),
	@item_no		varchar(15),
	@vednor			varchar(08))
 RETURNS char(01) 
AS
begin

--select mrp.dbo.fn_Common_PO_Run_status('SY','JGEP','01','D','H6','')
	declare	@post	varchar(02),
			@person	varchar(02)
			
	if @post_person is null
		select @post_person=''
		
	select	@post=left(@post_person,2),
			@person=substring(@post_person,3,2)

	if left(@gaijung,2) = 'SY'  
		return('1')
	else if @supply = 'I' 
		begin
			if left(@item_no,2)='H6'
				return('3')
			else
				return('1')
		end
	else 
	begin
		if @vednor < '0'
			return('1')
		else if (	@post = 'JG' and @person in ('EB','EC','EE','EF','EH','EJ','EK','EO','ES','EY','EZ') or
				@post = 'ZG' and @person in ('EG') or
				@post = 'PO' and @person in ('ZZ') or 
				@part = 'CM' )
				return('3')
	end

	return('1')

end;

/*******************************************************************************************************************/
/*  SP NAME      : fn_Common_PO_Vendor                                                                                                                                                    */
/*  DISCRIPTION  : PO Vendor Find                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE FUNCTION [dbo].[fn_Common_PO_Vendor] ( 
	@project_no			varchar(11),
	@mfg_no				varchar(03),
	@gaijung			varchar(04),
	@product_code		varchar(03),
	@market_flag		char(01),
	@item_group_sub		varchar(10),
	@part				varchar(02),
 	@cx_060_vendor		varchar(08)
) RETURNS VARCHAR(09) 	--@gss_apply_flag+@PO_vendor
AS
begin
	declare	@PO_vendor		VARCHAR(08),
			@gss_apply_flag		char(01)

	select @item_group_sub=(case when charindex('-',@item_group_sub) > 0
					then left(@item_group_sub, charindex('-',@item_group_sub)-1)
					else @item_group_sub end) 


	declare	@informal_flag		char(01),
			@gss_check_flag		char(01),
			@gss_vendor		   varchar(08)

	select	@informal_flag='N',@gss_apply_flag='N',@gss_check_flag='N'


--	if left(@mfg_no,1)= 'K' or @gaijung = 'SPSS'
--	if left(@mfg_no,1)= 'K' or (@gaijung = 'SPSS' and left(@mfg_no,1) <> 'R')
--	if left(@mfg_no,1)= 'K' or (@gaijung = 'SPSS' and @market_flag <> 'X')
	if left(@mfg_no,1)= 'K' or (@gaijung = 'SPSS' and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R'))
		select @gss_check_flag='Y'
	else if substring(@project_no,5,2) = 'CE' and left(@mfg_no,1)='P'
		select @gss_apply_flag='N'
	else if (@market_flag = 'E' AND left(@mfg_no,1) = 'P') or @market_flag = 'C'          
	begin                  
      	select @informal_flag='Y'
      	select @gss_vendor =  '35024405'
		select @gss_apply_flag='Y'
	end
	else
	begin
		select @gss_check_flag='Y'
		IF  @PART in ('QA','CM','SR','CE','CS')                              
			select @informal_flag='Y'
	end
                                           
	if  @gss_check_flag='Y'
	begin
		if not exists (select *
			from el_cd..t_ex_013 a
			where a.gaijung=@gaijung
			and a.product_code=@product_code
			and a.part=@part    
			and a.item_group_sub=@item_group_sub
			and a.PO_Apply_flag = 'Y')
		begin
			if not exists (select *
				from el_cd..t_ex_013 a
				where a.gaijung=@gaijung
				and a.product_code=@product_code
				and a.part=@part    
				and a.item_group_sub='*'		-- all Pumbun
				and a.PO_Apply_flag = 'Y')
			begin
				if not exists (select *
					from el_cd..t_ex_013 a
					where a.gaijung=@gaijung
					and a.product_code=@product_code
					and a.part='*'    		-- all Part
					and a.item_group_sub=@item_group_sub
					and a.PO_Apply_flag = 'Y')
				begin
					select @gss_apply_flag='N'
				end
				else
					select @gss_apply_flag=PO_Apply_flag,@gss_vendor=PO_Vendor
					from el_cd..t_ex_013 a
					where a.gaijung=@gaijung
					and a.product_code=@product_code
					and a.part='*'    
					and a.item_group_sub=@item_group_sub
			end
			else
				select @gss_apply_flag=PO_Apply_flag,@gss_vendor=PO_Vendor
				from el_cd..t_ex_013 a
				where a.gaijung=@gaijung
				and a.product_code=@product_code
				and a.part=@part    
				and a.item_group_sub='*'
		end
		else
			select @gss_apply_flag=PO_Apply_flag,@gss_vendor=PO_Vendor
			from el_cd..t_ex_013 a
			where a.gaijung=@gaijung
			and a.product_code=@product_code
			and a.part=@part    
			and a.item_group_sub=@item_group_sub
	end


	if @gss_apply_flag='Y'        
	begin
		-- if @cx_060_vendor = '1142334'    
		if @cx_060_vendor = '35027102'         
			select @PO_vendor=@cx_060_vendor
		--else if  @informal_flag = 'Y' and @cx_060_vendor in ('1010941','1195056','1147256','1165707','1011572','1182903' )    
		  else if  @informal_flag = 'Y' and @cx_060_vendor in ('35023688','35024523','35023757','35027139','35024369','1182903' )                     
			select	@PO_vendor = @cx_060_vendor
		else
			select	@PO_vendor = @gss_vendor
	end 
	else                                                      
		select	@PO_vendor = @cx_060_vendor
                                                                     
	return(@gss_apply_flag+@PO_vendor)

end;

CREATE FUNCTION dbo.fn_diagramobjects() 
	RETURNS int
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		declare @id_upgraddiagrams		int
		declare @id_sysdiagrams			int
		declare @id_helpdiagrams		int
		declare @id_helpdiagramdefinition	int
		declare @id_creatediagram	int
		declare @id_renamediagram	int
		declare @id_alterdiagram 	int 
		declare @id_dropdiagram		int
		declare @InstalledObjects	int

		select @InstalledObjects = 0

		select 	@id_upgraddiagrams = object_id(N'dbo.sp_upgraddiagrams'),
			@id_sysdiagrams = object_id(N'dbo.sysdiagrams'),
			@id_helpdiagrams = object_id(N'dbo.sp_helpdiagrams'),
			@id_helpdiagramdefinition = object_id(N'dbo.sp_helpdiagramdefinition'),
			@id_creatediagram = object_id(N'dbo.sp_creatediagram'),
			@id_renamediagram = object_id(N'dbo.sp_renamediagram'),
			@id_alterdiagram = object_id(N'dbo.sp_alterdiagram'), 
			@id_dropdiagram = object_id(N'dbo.sp_dropdiagram')

		if @id_upgraddiagrams is not null
			select @InstalledObjects = @InstalledObjects + 1
		if @id_sysdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 2
		if @id_helpdiagrams is not null
			select @InstalledObjects = @InstalledObjects + 4
		if @id_helpdiagramdefinition is not null
			select @InstalledObjects = @InstalledObjects + 8
		if @id_creatediagram is not null
			select @InstalledObjects = @InstalledObjects + 16
		if @id_renamediagram is not null
			select @InstalledObjects = @InstalledObjects + 32
		if @id_alterdiagram  is not null
			select @InstalledObjects = @InstalledObjects + 64
		if @id_dropdiagram is not null
			select @InstalledObjects = @InstalledObjects + 128
		
		return @InstalledObjects 
	END;

/*******************************************************************************************************************/
/*  SP NAME      : S_SG_070_2                                                                                                                                                    */
/*  DISCRIPTION  : 사급처재고 집계처리                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  -----------------------------------------------------------------------                                                                                  */
/* 2016/11/11   사급처 재고 관리                J.J.G           Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[S_SG_070_2]
	@job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

/*
truncate table x_batch_job_error
declare	@status		char(01),
	@out_msg	varchar(50) 
exec SP_MRP_8JP 'MRP_8JP','2010-01-29 17:58:49.720',@status output,@out_msg output
select @status,@out_msg
select * from x_batch_job_error


*/
	exec SP_MRP_010_2 'MRP_8JP'

	declare	@o_Year_Month		char(06),
			@prev_Year_Month	char(06),
			@o_gaijung		varchar(04),
			@o_store		varchar(06),
			@o_supply		char(01)

	select	@o_year_month=mrp.dbo.fGetOption(@job_ID,@page,'AccountMonth'),
			@o_gaijung=mrp.dbo.fGetOption(@job_ID,@page,'Gaijung'),
			@o_store=mrp.dbo.fGetOption(@job_ID,@page,'store'),
			@o_supply=mrp.dbo.fGetOption(@job_ID,@page,'supply')

	select	@prev_year_month=left(convert(char(08),dateadd(month,-1,convert(smalldatetime,@o_year_month+'01')),112),6)

	

--월수불처리 대상 선정

	select distinct a.gaijung,a.order_select,a.store
	into #GISF8JP1
	from T_MVA_060 a with (index=IX_T_MVA_060_1 nolock),EL_CD..T_EX_000 b
	where a.year_month=@o_year_month
	and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
	and (@o_store < '0' or a.store=@o_store)
	and (@o_supply < '0' or a.order_select=@o_supply)
	and left(master.dbo.fGetCodeDesc('A92',a.store),1)='B'


	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),gaijung+store+order_select+' 수불 option 없음 ???'
	from #GISF8JP1 a
	where not exists (select *
			from T_MZR_A1 b
			where b.gaijung=a.gaijung
			and b.store=a.store
			and b.order_select = a.order_select)

	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 수불 option 없음 ???'
		return
	end

	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),a.gaijung+a.store+a.order_select+' 수불 마감 되었음 ???'
	from #GISF8JP1 a,T_MZR_A1 b
	where a.gaijung > '0'
	and b.gaijung=a.gaijung
	and b.store=a.store
	and b.order_select = a.order_select
	and b.close_year_month >= @o_year_month
	
	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 수불 마감 되었음 ???'
		return
	end
	

--대상 선정

	declare	@from_date		char(08),
			@to_date		char(08),
			@item_no		varchar(15),
			@gaijung		varchar(04),
			@store			varchar(06),
			@order_select	char(01)

	exec master.dbo.s_cx_month_1 @o_year_month,@from_date output, @to_date output

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select distinct item_no,gaijung,store,order_select
		from T_MVA_060 a with (index=IX_T_MVA_060_1)
		where a.year_month between @prev_year_month and @o_year_month
		and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
		and (	a.year_month=@prev_year_month and a.qty_stock > 0 or
			a.year_month=@o_year_month)
		

	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	@item_no,@gaijung,@store,@order_select

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec      SP_Common_IO_Each_Accounting
			@item_no,
			@gaijung,
			@store,
			@order_select,
			@o_year_month,
			@prev_Year_Month,
			@from_date,
			@to_date,
			@status output,
			@out_msg output


		select @out_msg= @item_no + ' ' + @gaijung + ' ' + @store+ ' ' + @order_select + ' ' + @out_msg
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	   	FETCH NEXT FROM TTT0 INTO 	@item_no,@gaijung,@store,@order_select
	end
	CLOSE TTT0
   	DEALLOCATE TTT0

	select status='0',out_msg='월수불 처리 OK ...결과 확인 요망 '


	
SET NOCOUNT OFF;

CREATE PROCEDURE dbo.sp_alterdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null,
		@version 	int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId 			int
		declare @retval 		int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @ShouldChangeUID	int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid ARG', 16, 1)
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();	 
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		revert;
	
		select @ShouldChangeUID = 0
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		
		if(@DiagId IS NULL or (@IsDbo = 0 and @theId <> @UIDFound))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end
	
		if(@IsDbo <> 0)
		begin
			if(@UIDFound is null or USER_NAME(@UIDFound) is null) -- invalid principal_id
			begin
				select @ShouldChangeUID = 1 ;
			end
		end

		-- update dds data			
		update dbo.sysdiagrams set definition = @definition where diagram_id = @DiagId ;

		-- change owner
		if(@ShouldChangeUID = 1)
			update dbo.sysdiagrams set principal_id = @theId where diagram_id = @DiagId ;

		-- update dds version
		if(@version is not null)
			update dbo.sysdiagrams set version = @version where diagram_id = @DiagId ;

		return 0
	END;

--1.  발송주문 미 수행건

CREATE PROCEDURE [dbo].[SP_CFM_6EH_PO_ORDER_CREATE]	@gaijung varchar(8),
													@o_date_due varchar(8)
as
BEGIN
/*
	SP_CFM_6EH_PO_ORDER_CREATE 'SYHP','20101031'
*/

	if @gaijung = 'SYHP'
	begin
		select	project_no,mfg_no,part,part_seq,item_no,
			cont_qty,
			due_date= convert(char(08),due_date,112),
			order_select=(case when order_select in ('A','M') then 'M' else order_select end),
			ship_flag = (case when treat_method = 'D' and cause_code = '@@' or ship_flag <> 'Y' then 'N' else 'Y' end),
			a.market_flag
		from EL_CD..T_CA_011 a with (index=ix_ca_011_4)
		where a.date_po is null
		and a.Gaijung='SYHP'
		and a.due_date between '20090101' and @o_date_due
		and a.confirm_flag in ('Y','A')
		and not (a.order_select in ('D','I','L') or 
			a.treat_method='D' and a.cause_code <> '@@' or 
			a.part = 'RA' or 
			a.cause_code  in ('IM','ZZ') or
			a.order_select = 'M' and out_factory_flag = 'S' or
			a.ship_flag = 'N' or
			out_factory_flag  in ('K','D','A','Y') )
	end
END;

--1.  발송주문 미 수행건

CREATE PROCEDURE [dbo].[SP_CFM_6EI_AO_ORDER_CREATE]	@gaijung varchar(8),
													@o_DueDate varchar(8)
as
BEGIN
/*
	SP_CFM_6EI_AO_ORDER_CREATE 'SYHP','20101031'
	SP_CFM_6EI_AO_ORDER_CREATE 'ELES','20101016'
	SP_CFM_6EI_AO_ORDER_CREATE 'SPSS','20101016'
*/

	if @gaijung = 'SYHP'
	begin
		select	a.project_no,a.mfg_no,a.part,a.part_seq,
			order_select=(case when a.order_select in ('A','M')	then 'D'
								else a.order_select end)
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung='SYHP'
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and (	substring(part_seq,3,1) = 'A'  and a.order_select not in ('A','M') or 
				substring(part_seq,3,1) = 'A'  and a.order_select in ('A','M') and out_factory_flag = 'S' or 
				substring(part_seq,3,1) <> 'A'  and a.order_select not in ('A','M')  and out_factory_flag <> 'S')
		and b.item_no=a.item_no
		and not (b.item_select in ('D','H') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@' )
	end
	if @gaijung = 'ELES'
	begin
		select	a.project_no,a.mfg_no,a.part,part_seq,a.order_select
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung='ELES'
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and a.order_select  in ('S','X','Z','D') 
		and b.item_no=a.item_no
		and not (b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@')
	end
	if @gaijung = 'SPSS'
	begin
		select	a.project_no,a.mfg_no,a.part,part_seq,a.order_select
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung='SPSS'
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and a.order_select  in ('S','X','Z','D') 
		and b.item_no=a.item_no
		and not (b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@')
	end
END;

--9.  단가 있는데 집행안된 건 확인

CREATE PROCEDURE [dbo].[SP_CFM_NO_CREATOR]	@gaijung varchar(8),
												@date_start varchar(8)
as
BEGIN
/*
	SP_CFM_NO_CREATOR 'ELES','20100917'
*/

	select a.* 
	from el_cd..t_va_020 a
	where order_no >= '0C01%'	-- 0C01	
	and a.date_start >= @date_start
	and a.gaijung = @gaijung
	and a.creator < '0'
	
END;

/** 주문 M/S의 Packing Vendor vs 기준정보의 Packing Vendor 비교 ***/


CREATE PROCEDURE [dbo].[SP_CFM_PackingVendor]	@date_start varchar(8)

as
BEGIN
/*
-- GSS는 ELES만 적용되므로 ELES만 수행하기.

	SP_CFM_PackingVendor '20100917'
	SP_CFM_PackingVendor '20100918'
*/

SELECT	order_packing_vendor=j.packing_vendor, 
		base_packing_vendor = isnull(
				(case when exists (select * from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
									then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
									else x.item_group_sub end) 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y')  )
				then

					(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
					from el_cd..T_EX_013 y
					where  y.product_code =x.product_code
					and y.part = j.part
					and y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
								then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
								else x.item_group_sub end)
					and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
						j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )


				else
					(case when exists (select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = '*' 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					then

						(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = '*' 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					else
						(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = '*'
						and (	y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
									then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
									else x.item_group_sub end) )
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					end)
				end),' '), 
	j.*
	from EL_CD..T_VA_020 j, el_cd..t_ca_011 x 
	where	j.order_no >= '0C01%'	-- 0C01
	and		j.date_start >= @date_start
	and		left(j.gaijung,2) = 'EL'  
	and		x.project_no = left(j.prod_no,11) 
	and		x.mfg_no = substring(j.prod_no,12,3) 
	and		x.part = j.part 
	and		x.part_seq = j.part_seq
	and		j.packing_vendor <> isnull(
				(case when exists (select * from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
									then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
									else x.item_group_sub end) 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y')  )
				then

					(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
					from el_cd..T_EX_013 y
					where  y.product_code =x.product_code
					and y.part = j.part
					and y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
								then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
								else x.item_group_sub end)
					and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
						j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )


				else
					(case when exists (select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = '*' 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					then

						(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = j.part
						and y.item_group_sub = '*' 
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					else
						(select (case when j.market_flag = 'E' then y.packing_e_vendor else y.packing_d_vendor end)
						from el_cd..T_EX_013 y
						where  y.product_code =x.product_code
						and y.part = '*'
						and (	y.item_group_sub = (case when charindex('-',x.item_group_sub) > 0
									then left(x.item_group_sub, charindex('-',x.item_group_sub)-1)
									else x.item_group_sub end) )
						and ( 	j.market_flag = 'E' and y.Packing_E_Apply_flag = 'Y' or  
							j.market_flag <> 'E' and y.Packing_D_Apply_flag = 'Y') )
					end)
				end),' ')
	


/*
where	j.order_no like '0%'	-- 0C01
and		j.date_start >= '20100917'
and		j.gaijung = 'ELES'
위의 조건으로 원래 틀린 내역이 있음.

select * 
from jjg_pk_vdr_T_VA_020
where packing_vendor <> base_packing_vendor


0BC76740		1012686
0BC76735		1012686
0BC76745		1012686
0BC91485	1209315	 
0BC91450	1209315	 
0BC91455	1209315	 
0BC88410	1012686	 
0BC88415	1012686	 
0BC88480	1146325	 

*/


END;

/** 완료 이전 주문이 제통상 출고 완료된 데이터 조회 ***/


CREATE PROCEDURE [dbo].[SP_CFM_prod_qty]	@gaijung	varchar(4),
										@year_month varchar(6),
										@from_date	varchar(8),
										@to_date	varchar(8)

as
BEGIN
/*
	SP_CFM_output_vs_subul 'ELES','201009','20100826', '20100925'
	SP_CFM_output_vs_subul 'ELES','201008','20100726', '20100825'
	SP_CFM_output_vs_subul 'ELES','201007','20100626', '20100725'
	SP_CFM_output_vs_subul 'ELES','201006','20100526', '20100625'

	SP_CFM_output_vs_subul 'SPSS','201009','20100826', '20100925'
	SP_CFM_output_vs_subul 'SPSS','201008','20100726', '20100825'
	SP_CFM_output_vs_subul 'SPSS','201007','20100626', '20100725'
	SP_CFM_output_vs_subul 'SPSS','201006','20100526', '20100625'

	SP_CFM_output_vs_subul 'SYHP','201009','20100826', '20100925'
	SP_CFM_output_vs_subul 'SYHP','201008','20100726', '20100825'
	SP_CFM_output_vs_subul 'SYHP','201007','20100626', '20100725'
	SP_CFM_output_vs_subul 'SYHP','201006','20100526', '20100625'

*/
	

	
	select a.order_no, b.cont_qty, b.prod_qty, b.sale_qty, b.* 
	from el_cd..t_va_020 a, el_cd..t_ca_011 b
	where a.order_no like '0%'	-- 0C01	
	and	a.run_status <= '4'
	and a.gaijung = 'ELES'
	and	a.ship_flag = 'Y'
	and b.project_no = left(a.prod_no,11)
	and b.mfg_no =  substring(a.prod_no,12,3)
	and b.part = a.part
	and b.part_seq = a.part_seq 
	and b.prod_qty = b.cont_qty
	and b.cont_qty > 0
	
	
END;

-- 대일정 제통과 상이건 체크

CREATE PROCEDURE [dbo].[SP_CFM_T7M]	@o_gaijung varchar(8)
as
BEGIN
/*  47초 정도 걸림. -- 속도는 나중에.
	exec SP_CFM_T7M 'ELES'
*/

	DECLARE @upd_date_from	datetime,
			@upd_date_to	datetime
		
	select @upd_date_from = dateadd(day,-2,getdate())
	select @upd_date_to = getdate()

	select x.project_no,x.mfg_no,x.part,x.plan_date, k.last_in_date, k.last_in_date, k.rslt_date
	from EL_CD..T_CC_030 x with (index=IX_T_CC_030_1 nolock), EL_CD..T_CA_011 k
	where	x.point='4'
	and	x.confirm_date BETWEEN @upd_date_from AND @upd_date_to
	and	x.confirm_flag='Y' 
	and exists (select * 
				from EL_CD..T_CC_010 y  with (index=PK_T_CC_010_1__15 nolock)
				where 	y.project_no=x.project_no 
				and	y.mfg_no=x.mfg_no
	 			and	left(y.gaijung,2)=left(@o_gaijung,2)  )
	and	k.project_no=x.project_no 
	and	k.mfg_no=x.mfg_no 
	and	k.part=x.part
	and	k.due_date <> x.plan_date
	and	k.cont_qty > 0
	 			
	 					
END;

-- 주문은 납품 되었는데 전표 생성 안된건

CREATE PROCEDURE [dbo].[SP_CFM_va020_junpyo_error]	@gaijung varchar(4),
													@date_start varchar(8)
as
BEGIN
/*
	SP_CFM_va020_junpyo_error 'ELES','20100917'
	SP_CFM_va020_junpyo_error 'SYHP','20100917'
	SP_CFM_va020_junpyo_error 'SPSS','20100917'
*/


	select a.* 
	from el_cd..t_va_020 a 
	where a.order_no >= '0C01%'	-- 0C01	
	and a.date_start >= @date_start
	and a.run_status >= '4'
	and a.gaijung = @gaijung
	and a.qty_deliv > 0
	and not exists ( select 'y' from el_cd..t_va_040 b where b.order_no = a.order_no )


END;

--1.  주문 번호 제통 반영 

CREATE PROCEDURE [dbo].[SP_CFM_va020_vs_ca011]	@gaijung varchar(4),
												@date_start varchar(8)
as
BEGIN
/*
	SP_CFM_va020_vs_ca011 'ELES','20100917'
	SP_CFM_va020_vs_ca011 'SYHP','20100917'
	SP_CFM_va020_vs_ca011 'SPSS','20100917'
*/

	select b.* 
	from el_cd..t_va_020 a, el_cd..t_ca_011 b
	where a.order_no >= '0C01%'	-- 0C01	
	and a.date_start >= @date_start
	and b.project_no = left(a.prod_no,11)
	and b.mfg_no =  substring(a.prod_no,12,3)
	and a.part = b.part
	and a.part_seq = b.part_seq 
	and a.gaijung = @gaijung
	and a.order_no <> b.concern_order_no


END;

/*****************************************************************************************************************/
/*  SP NAME      : SP_CHK_001                                                                                                                                              */
/*  DISCRIPTION  :  입고,출고,수불 CHeck                                                                                                            */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/09/20     MRP Downsizing Project   J.G. Jeon     Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_CHK_001]
	@job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

/*

declare	@status		char(01),
	@out_msg	varchar(50) 
exec SP_CHK_001 'CHK_001','2010-09-29 07:00:17.900',@status output,@out_msg output
select @status,@out_msg



*/
	exec SP_MRP_010_2 'CHK_001'

	declare	@Year_Month		varchar(06)

	declare	@from_date	smalldatetime,
			@to_date	smalldatetime
			
	select @year_month=master.dbo.fGetNextCloseMonthMatl('ELES')
	
	select @from_date=from_date,@to_date=to_date
	from el_cd..T_CX_month
	where year_month=@year_month
	

--output_vs_subul
	select a.item_no, a.gaijung, a.store, a.order_select, 
			output_qty1 = sum(qty),output_qty2 =CONVERT(float,0)
	into #AA
	from t_mva_041 a with (nolock)
	where a.date_io between @from_date and @to_date + ' 23:59:00'
	group by a.item_no, a.gaijung, a.store, a.order_select
	
	insert into #AA
	select a.item_no, a.gaijung, a.store, a.order_select, 
			output_qty1 =CONVERT(float,0),output_qty2 = qty_output
	from mrp..t_mva_060 a with (nolock)
	where a.year_month = @year_month	


	insert into X_Batch_JOB_Error 
	select @page,@job_id,'1',getdate(),out_msg='output_vs_subul/'+a.item_no+'/'+a.gaijung+'/'+ a.store+'/'+ a.order_select
			+'/output_qty_jp='+convert(varchar(20),SUM(output_qty1))+'/output_qty_ms='+convert(varchar(20),SUM(output_qty2))
	from #AA a
	GROUP by a.item_no, a.gaijung, a.store, a.order_select
	having abs(SUM(output_qty1) - SUM(output_qty2)) > 0.01						


----input_vs_subul
	select a.item_no, a.gaijung, a.store, order_select=a.supply, 
			input_qty1 = sum(qty),input_qty2 =CONVERT(float,0),
			input_amt1 = sum(amut+MATR_AMOUNT),input_amt2 =CONVERT(float,0)
	into #BB
	from el_cd..t_va_040 a (nolock)
	where a.date_io between @from_date and @to_date + ' 23:59:00'
	group by a.item_no, a.gaijung, a.store, a.supply
	
	
	
	insert into #BB
	select a.item_no, a.gaijung, a.store, a.order_select, 
			input_qty1 =CONVERT(float,0),input_qty2 = qty_input,
			input_amt1 =CONVERT(float,0),input_amt2 = amt_input
	from mrp..t_mva_060 a (nolock)
	where a.year_month = @year_month	

	insert into X_Batch_JOB_Error 
	select @page,@job_id,'2',getdate(),out_msg='input_vs_subul/'+a.item_no+'/'+a.gaijung+'/'+ a.store+'/'+ a.order_select
			+'/input_qty_jp='+convert(varchar(20),SUM(input_qty1))+'/input_qty_ms='+convert(varchar(20),SUM(input_qty2))
			+'/input_amt_jp='+convert(varchar(20),SUM(input_amt1))+'/input_amt_ms='+convert(varchar(20),SUM(input_amt2))
	from #BB a
	GROUP by a.item_no, a.gaijung, a.store, a.order_select
	having	abs(SUM(input_qty1) - SUM(input_qty2)) > 0.01	or
			abs(SUM(input_amt1) - SUM(input_amt2)) > 0.01			
			
--Stock_vs_subul

	select a.item_no, a.gaijung, a.store, a.order_select,year_month=max(a.year_month)
	into #sos
	from t_mva_060 a(nolock)
	where left(year_month,4) >= left(convert(char(8),(dateadd(Year,-1,@year_month+'01')),112),4)
--	where left(year_month,4) >= left(@year_month,4)	
	group by a.item_no, a.gaijung, a.store, a.order_select

	select a.item_no, a.gaijung, a.store, a.order_select, 
			qty_stock1 = sum(qty_stock),qty_stock2 =CONVERT(float,0),
			amt_stock1 = sum(amt_stock),amt_stock2 =CONVERT(float,0)
	into #CC
	from #sos x,t_mva_060 a (nolock)
	where x.item_no > '0'
	and	a.item_no=x.item_no
	and a.gaijung=x.gaijung
	and a.store=x.store
	and a.order_select = x.order_select
	and a.year_month = x.year_month
	group by a.item_no, a.gaijung, a.store, a.order_select
	
	
	
	insert into #CC
	select a.item_no, a.gaijung, a.store, a.order_select, 
			qty_stock1 =CONVERT(float,0),qty_stock2 = sum(qty_stock),
			amt_stock1 =CONVERT(float,0),amt_stock2 = sum(amt_stock)
	from t_mva_061 a (nolock)
	group by a.item_no, a.gaijung, a.store, a.order_select
		

	insert into X_Batch_JOB_Error 
	select @page,@job_id,'3',getdate(),out_msg='Stock_vs_subul/'+a.item_no+'/'+a.gaijung+'/'+ a.store+'/'+ a.order_select
			+'/stock_qty_mon='+convert(varchar(20),SUM(qty_stock1))+'/stock_qty_ms='+convert(varchar(20),SUM(qty_stock2))
			+'/stock_amt_mon='+convert(varchar(20),SUM(amt_stock1))+'/stock_amt_ms='+convert(varchar(20),SUM(amt_stock2))
	from #CC a
	where gaijung <> 'SYHP'
	GROUP by a.item_no, a.gaijung, a.store, a.order_select
	having	abs(SUM(qty_stock1) - SUM(qty_stock2)) > 0.01	or
			abs(SUM(amt_stock1) - SUM(amt_stock2)) > 0.01	
			
	select @status='0',@out_msg=' OK ....,결과확인바람';

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_BOM_EXPL                                                                                                                                                    */
/*  DISCRIPTION  : 종속발주용,제조용 BOM을 전개하여 저장하는 Common Module                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/15     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_BOM_EXPL]
	@order_flag	char(01),		/** M:자작용,   S:종속구매발주 R:불출대기용 **/
	@job_id		varchar(30),
	@page		datetime
	
AS

SET NOCOUNT ON

	declare	@level		int,
			@status		char(01),
			@out_msg	char(50)

	select @status='',@out_msg=''

	create table #result_by_item (
		item_no			varchar(15), 
		order_select   	char(01),
		unit_qty		float,
		special			char(01)
	)

	declare	@item_no		varchar(15),
			@order_select	char(01),
			@unit_qty		float,
			@cnt			int

	select @cnt=0

	DECLARE TTT CURSOR LOCAL SCROLL STATIC FOR
		select 	a.item_no,a.order_select
		from #selected a
	OPEN TTT

   	FETCH NEXT FROM TTT INTO @item_no,@order_select
   	
	WHILE (@@FETCH_STATUS = 0 )	
	begin
		truncate table #result_by_item

		select @cnt=@cnt+1	

		SELECT @level=1,@unit_qty=1

		select @status='0',@out_msg='OK ???'

		EXEC SP_Common_BOM_EXPL_SUB 
			@item_no,
			@order_select,
			@unit_qty,
			@order_flag,	/** M:자작용,   S:종속구매발주 R:불출대기용 **/
			'',
			@level,
			@status		output,
			@out_msg	output

		if @status > '0'
		begin
			insert into X_Batch_JOB_Error values (@page,@job_id,'1',getdate(),@item_no+ '/'+@order_select+'/'+@out_msg)
		end
		else
		begin
			insert into T_MTP_01
			select  @page,@order_flag,@item_no,@order_select,a.item_no,a.order_select,qty=sum(a.unit_qty),special
			from #result_by_item a
			where (@order_flag = 'M' or a.item_no <> @item_no)
			group by a.item_no,a.order_select,special

		end
		
	   	FETCH NEXT FROM TTT INTO @item_no,@order_select	
	end
	CLOSE TTT
   	DEALLOCATE TTT;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_BOM_EXPL_SUB                                                                                                                                              */
/*  DISCRIPTION  :  BOM을 전개하는 COmmon SP (Recursively)                                                                                                                         */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_BOM_EXPL_SUB] 
	@item_no		varchar(15),
	@order_select	char(01),
	@qty			float,
	@order_flag		char(01),	/** M:자작용,   S:종속구매발주 **/
	@special		char(01),
	@level			int,
	@status			char(01)	output,
	@out_msg		varchar(50)	output
AS

SET NOCOUNT ON

	declare	@t_special		char(01),
			@item_select	char(01)

	select @t_special=''

	if not exists (select * from EL_CD..T_CX_060 where item_no = @item_no)
	begin
		select @status='4',@out_msg=':' + @item_no + ' Item no Not Found  ?? '
		return
	end


	if @level > 10
	begin
		select @status='1',@out_msg='Bom looping ?? '
		return
	end

	if @order_select not in ('A','M','S','X','Z','D','I') 
	begin
		select @status='2',@out_msg=':' + @item_no + ' BOM Explosion err(Item Not found or 조달)  ?? '
		return
	end

	select @item_select = @item_select from EL_CD..T_CX_060 where item_no = @item_no

	if @order_flag = 'M' 
	begin
		if @order_select in ('D','I','L')
			return

		 if @order_select in ('A','M')  and @item_select <> 'D'
			insert into #result_by_item values (@item_no,@order_select,@qty,'')
	end
	else if @order_flag in ( 'S','R')
	begin
		if @order_select not in ('A','M') 
		begin
			insert into #result_by_item values (@item_no,@order_select,@qty,@special)
			if @order_select  in ('D','I','L') 
				return
		end
	end

	if @order_flag = 'R' and @level <> 1 and @item_select <> 'D'
		return
	
	if @order_select in ('A','M')
		select @t_special = (case when exists (select * from EL_CD..T_CX_060 where  item_no = @item_no and wc_code in ('EEPC','FCPC','DMPC')) then 'M' else '' end)

	declare	@c_item_no		char(15),
			@c_order_select	char(01),
			@mark			char(04),
			@unit_qty		float,
			@child_special	char(01),
			@cnt			int,
			@c_level		integer

	select @cnt=0
	select @c_level = @level + 1

	DECLARE TTT CURSOR LOCAL SCROLL STATIC FOR
		select 	a.citem_no,
				c_order_select=(case when substring(a.mark,4,1) in ('D','I','L','S','X','Z','A','M') 
						then substring(a.mark,4,1)
						else isnull((select b.order_select from EL_CD..T_CX_060 b where b.item_no=a.citem_no),'') end),
				unit_qty=round((@qty*a.unit_qty*(case when a.weight = 0.0 then 1 else a.weight end)),3),
				child_special=(case when @order_select  in ('S','X','Z') and substring(a.mark,3,1) in ('S','X') then substring(a.mark,3,1) else '' end)
		from EL_CD..T_CX_062 a
		where a.item_no = @item_no
		and (@order_select not in ('X','Z') or substring(a.mark,3,1) in ('S','X'))

	OPEN TTT

   	FETCH NEXT FROM TTT INTO @c_item_no,@c_order_select,@unit_qty,@child_special

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @cnt=@cnt+1

		select @child_special=(case when @child_special > '0' then @child_special else @t_special end)

		EXEC SP_Common_BOM_EXPL_SUB
			@c_item_no,
			@c_order_select,
			@unit_qty,
			@order_flag,
			@child_special,
			@c_level,
			@status	output,
			@out_msg	output

		if @status > '0'
		begin
			CLOSE TTT
			DEALLOCATE TTT
			return
		end
		
	   	FETCH NEXT FROM TTT INTO @c_item_no,@c_order_select,@unit_qty,@child_special	
	end
	CLOSE TTT
   	DEALLOCATE TTT

	if @cnt = 0 
	begin
		select @status='3',@out_msg=':' + @item_no + ' Bom Explosion error (자품목 없음)?? '
		return
	end;

--*****************************************************************************************************************--
--  SP NAME      : SP_Common_Confirm_Input_Amt                                                                --
--  DISCRIPTION  : 입고금액 확정   Common SP (GISSZ4R0)                                                       -- 
--                                                                                                            --
--  >> MODIFICATION LOG <<                                                                                    -- 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                   --
--  ---------------------------------------------------------------                                           --
-- 2010/02/09     MRP Downsizing Project   J.J.Park      Initialize                                           --
-- 2023-08-08                   UNGJ          거래선  VARCHAR(8)변경                                          --
--************************************************************************************************************--

CREATE PROCEDURE [dbo].[SP_Common_Confirm_Input_Amt]
	@o_gaijung		varchar(04),
	@junpyo_no		varchar(13),
	@date_action	char(08),
	@status			char(01)		output,
	@out_msg		varchar(100)	output
	
AS
SET NOCOUNT ON

	if not exists (select * from el_cd..t_va_040 where junpyo_no=@junpyo_no)
	begin
		select status='1',out_msg=' 납품서MASTER에　존재하지않읍니다.???'
		return
	end

	declare	@qty			float,
			@va020_price	float,
			@gaijung		varchar(04),
			@item_no		varchar(15),
			@order_select	char(01),
			@run_status		char(01),
			@vendor			varchar(08),
			@money_unit		varchar(03),
			@order_no		varchar(08),
			@date_print_po	varchar(08),
			@due_date		varchar(08),
			@date_start		varchar(08),
			@store			varchar(06),
			@date_io		varchar(08),
			@matr_amount	float,
			@result_amt		float

	select	@qty=a.qty,@gaijung=gaijung,@order_select=supply,@item_no=item_no,@run_status=run_status,
			@vendor=trade_no,@money_unit=money_unit,@store=store,@date_io=convert(char(08),date_io,112)
	from el_cd..t_va_040 a
	where a.junpyo_no=@junpyo_no


	if @order_select not in ('X','Z')
	begin
		select @status='1',@out_msg=' 조달이 X,Z 만 가능 ???'
		return
	end


	if @qty = 0
	begin
		select @status='1',@out_msg=' 입고수량이 없읍니다 ???'
		return
	end

	if left(@gaijung,2) <> left(@o_gaijung,2)
	begin
		select @status='1',@out_msg=' 처리할 권한이 없읍니다 ???'
		return
	end

	select 	@date_print_po=date_print_po,@due_date=date_due,@date_start=date_start,
			@va020_price=price
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	declare	@entry_price		float,
			@proc_price			float,
			@ya14_matl_price	float

	select	@entry_price=0

	exec SP_Common_Input_Price_Search
		@gaijung,
		@order_select,
		@item_no,
		@vendor,
		@entry_price,
		@va020_price,
		@money_unit,
		@date_print_po,
		@due_date,
		@date_start,
		@proc_price			output,
		@ya14_matl_price	output,           --**추가logic ????*
		@status				output,
		@out_msg			output

	if @status > '0'
		return
	
	exec SP_Common_Stock_Update
		@item_no	,
		@gaijung	,
		@store		,
		@order_select	,
		'A',			-- A:입고 B:출고 **
	 	@date_io	,
		0,			--@io_qty		
		0,			--@io_amt 	
		@matr_amount	,
		@result_amt		output,
		@status		 	output,
		@out_msg		output
	
	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	select	status=@status,out_msg=@out_msg;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Information_ZRA1                                                                                                                                              */
/*  DISCRIPTION  :  수불 옵션을 Fetch하는  Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_Information_ZRA1]
	@gaijung			varchar(04),
	@store				varchar(06),
	@order_select		char(01),
	@date_io			char(08),
	@zra1_price_option	char(01)		output,
	@zra1_account_opt	char(01)		output,
	@zra1_close_month	char(06)		output,
	@next_from_date		char(08)		output,
	@next_to_date		char(08)		output,
	@status				char(01)		output,
	@out_msg			varchar(100)	output
	
--sp_find_str SP_Common_Information_ZRA1
AS
SET NOCOUNT ON

	select @status='0',@out_msg='Information_ZRA1 OK ..'

	declare	@next_year_month	char(06),
			@temp_date		char(08),
			@close_io_date varchar(08)

	if isdate(@date_io)=0
	begin
		select @status='1',@out_msg='Please Check 입출고일자  ???'
		return
	end

	select	@zra1_price_option=price_option,@zra1_price_option=price_option,@zra1_close_month=close_year_month,
			@zra1_account_opt=account_option
	from T_MZR_A1
	where gaijung=@gaijung
	and store=@store
	and order_select=@order_select

	
	select @next_year_month=left(convert(char(08),dateadd(m,1,@zra1_close_month+'01'),112),6)
	exec master.dbo.s_cx_month_1 @next_year_month,@next_from_date output, @next_to_date output
	select @close_io_date = convert(char(8),close_date,112)
	from el_cd..t_ex_080
	where close_code = 'K'
	
	if @next_from_date > @date_io or @close_io_date >= @date_io
	begin
		select @status='1',@out_msg=' 입출고일자는 마감일 이후이어야 함 ???'
		return
	end
	
/*
insert into t_ex_080
select	close_code = 'K',
		close_desc = '입출고 마감',
		close_date = '2011-11-30 00:00:00',
		update_man,
		date_update = getdate()
from t_ex_080
where close_code = 'G'

sp_fields t_ex_080
*/;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Input_Expect_No                                                                                                                                              */
/*  DISCRIPTION  :  납품예정정보 마스타 반영                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/03/29     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Input_Expect_No]
	@receipt_expect_no	varchar(20)
AS
SET NOCOUNT ON

	if left(@receipt_expect_no,1) in ('B','A','N') or left(@receipt_expect_no,1)='C'  ---BOX납품
	begin
		update a set 
			receipt_date=getdate()
		from EL_CD..t_vj_401_BOX a
		where receipt_expect_no=@receipt_expect_no
		and receipt_date is null
	
		update a set 
			input_date=getdate()
		from EL_CD..t_vj_401_BOX a
		where receipt_expect_no=@receipt_expect_no
		and input_date is null
	end
	else  --- 개별납품
	begin
		update a set 
			receipt_date=getdate()
		from EL_CD..t_vj_401 a
		where receipt_expect_no=@receipt_expect_no
		and receipt_date is null
	
		update a set 
			input_date=getdate()
		from EL_CD..t_vj_401 a
		where receipt_expect_no=@receipt_expect_no
		and input_date is null
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Input_Price_Search                                                                                                                                              */
/*  DISCRIPTION  :  입고단가 찾기 Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/
--grant exec on SP_Common_Input_Price_Search to applications
CREATE PROCEDURE [dbo].[SP_Common_Input_Price_Search]
	@gaijung			varchar(04),
	@order_select		char(01),
	@item_no			varchar(15),
	@vendor				varchar(08),
	@entry_price		float,
	@va020_price		float,
	@money_unit			varchar(03),
	@date_print_po		varchar(08),
	@due_date			varchar(08),
	@date_start			varchar(08),
	@proc_price			float			output,
	@ya14_matl_price	float			output,           /**추가logic ????*/
	@status				char(01)		output,
	@out_msg			varchar(100)	output
AS
SET NOCOUNT ON

	declare	@ya14_price			float,
			@ya14_date_apply	varchar(08),
			@date_apply			varchar(08),
			@loop_cnt			int,
			@acpt_option		char(1)

-- 납품단가 Fetch

	declare	@zr03_acpt_option1		char(1)		,	/** 납품단가적용구분 (1)입력단가 (2)적용단가 (3)주문시단가적용**/
			@zr03_acpt_option2		char(1)		,	
			@zr03_acpt_option3		char(1)		,
			@zr03_acpt_zero_flag	char(1)		,	/**납품시단가허용구분(Y)단가ZERO허용(N)단가ZERO처리불가**/
			@zr03_date_flag			char(1)		,	/** 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자**/
			@zr03_to_store			varchar(6)		/** 대표창고 **/
	
	if not exists (select * from T_MZR_03
					where gaijung=@gaijung
					and order_select=@order_select)
	begin
		select @status='1',@out_msg='납품 Option Not Found in Common_Input_Price_Search '
		return
	end
	
	select	@zr03_acpt_option1=acpt_option1,
			@zr03_acpt_option2=acpt_option2,
			@zr03_acpt_option3=acpt_option3,
			@zr03_acpt_zero_flag=acpt_zero_flag,
			@zr03_date_flag=date_flag,
			@zr03_to_store=to_store
	from T_MZR_03
	where gaijung=@gaijung
	and order_select=@order_select		
		
	select @proc_price=0,@loop_cnt=1,@ya14_matl_price=0,@ya14_price=0

	while (@proc_price=0 and @loop_cnt < 4 )
	begin
		if @loop_cnt = 1
			select @acpt_option=@zr03_acpt_option1
		else if @loop_cnt = 2
			select @acpt_option=@zr03_acpt_option2
		else
			select @acpt_option=@zr03_acpt_option3


		if @acpt_option =1
			select @proc_price=@entry_price
		else if @acpt_option = 2
		begin
			select @date_apply = (case when @zr03_date_flag = '1' 
				then @due_date 
				else (case when @zr03_date_flag='2' then @date_print_po else @date_start end) end)

			exec SP_Common_Price_Fetch
				@item_no,
				'A',			--** price_sort ****
				@vendor,@order_select,	
				'',			--** work_mtd  ****
				@money_unit,
				@date_apply,		--** apply_date ****   
				'N',			--** etc_apply_flag ****
				@ya14_price		output,
				@ya14_matl_price		output,
				@ya14_date_apply	output,
				@status			output,
				@out_msg		output

			if @ya14_price >0
				select @proc_price=@ya14_price
		end
		else if @acpt_option = 3
		begin
			select @proc_price=@va020_price
		end

		select @loop_cnt=@loop_cnt+1
	end
			
	if @zr03_acpt_zero_flag <> 'Y' and @proc_price=0
	begin
		select @status='1',@out_msg = '단가가 없읍니다???'
		return
	end

	select @ya14_matl_price = (case when @order_select in ('X','Z') then @ya14_matl_price else 0 end)

	if @zr03_acpt_zero_flag <> 'Y' and @order_select in ('X','Z') and @ya14_matl_price=0
	begin
		select @status='2',@out_msg = '재료비 단가가 없읍니다???'
		return
	end

	select @status='0',@out_msg = 'Input_Price_Fetch OK ...';

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Inspection_Base_Update                                                                                                                                              */
/*  DISCRIPTION  :  품목별 검사기준 Update Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Inspection_Base_Update]
	@item_no	varchar(15),
	@vendor		varchar(08),
	@insp_mtd	char(02),
	@lot_flag	varchar(01),
	@qty_acpt	float,
	@qty_reject	float,
	@last_range	char(02)	output,
	@insp_range	char(02)	output
AS
SET NOCOUNT ON


	declare	@qty_acpt_cont_cnt int

	select @last_range='',@insp_range=''

	update a set
		qty_acpt_total=a.qty_acpt_total+@qty_acpt,
		qty_return_total=a.qty_return_total+@qty_reject,
		date_update=getdate()
	from T_MYA_151 a
	where a.item_no=@item_no
	and a.vendor=@vendor

	if @insp_mtd <> 'SA'
		return


	if @lot_flag in ('A','C')
	begin
		select @qty_acpt_cont_cnt=(case when a.insp_range = 'TI' then 4 else 9 end)
		from T_MYA_151 a
		where a.item_no=@item_no
		and a.vendor=@vendor

		update a set
			qty_lot_acpt=a.qty_lot_acpt+1,
			qty_acpt_cont=(case when a.qty_acpt_cont  =  @qty_acpt_cont_cnt 
						then 0 else a.qty_acpt_cont+1 end),
			qty_fail_cont=0,

			last_range=(case when a.qty_acpt_cont =  @qty_acpt_cont_cnt 
						then a.insp_range else a.last_range end),
			insp_range=(case when a.qty_acpt_cont =  @qty_acpt_cont_cnt 
						then  (case a.insp_range when 'TI' then 'NI' else 'RI' end)
						else a.insp_range end),
			insp_advan=(case when a.qty_acpt_cont =  @qty_acpt_cont_cnt 
						then 'U' else a.insp_advan end),
			date_insp_range=(case when a.qty_acpt_cont =  @qty_acpt_cont_cnt 
						then getdate() else a.date_insp_range end)
		from T_MYA_151 a
		where a.item_no=@item_no
		and a.vendor=@vendor
	end
	else
	begin
		update a set
			QTY_LOT_FAIL=a.QTY_LOT_FAIL+1,
			qty_fail_cont=(case when a.qty_fail_cont =  1
						then 0 else a.qty_fail_cont+1 end),
			qty_acpt_cont=0,
			last_range=(case when a.qty_fail_cont =  1
						then a.insp_range else a.last_range end),
			insp_range=(case when a.qty_fail_cont  =  1
						then (case a.insp_range when 'RI' then 'NI' else 'TI' end)
						else a.insp_range end),
			insp_advan=(case when a.qty_fail_cont  =  1
						then (case a.insp_range when 'TI' then 'R' else 'D' end)
						else a.insp_advan end),
			date_insp_range=(case when a.qty_fail_cont = 1
						then getdate() else a.date_insp_range end)
		where a.item_no=@item_no
		and a.vendor=@vendor
	end

	select @last_range=last_range,@insp_range=insp_range
	from T_MYA_151 a
	where a.item_no=@item_no
	and a.vendor=@vendor;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Inspection_Decision                                                                                                                                              */
/*  DISCRIPTION  :  검사결과처판정 Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Inspection_Decision]
	@insp_mtd			char(02),
	@insp_qty			float,
	@lot_flag			char(01),
	@entry_fail_qty		float,   --1   A
	@sample_qty			float,  -- 1
	@sample_reject_qty	float,   --1

	@acpt_qty			float			output,
	@reject_qty			float			output,
	@status				char(01)		output,
	@out_msg			varchar(100)	output

AS
SET NOCOUNT ON

	select @status='0',@out_msg='Inspection_Decision OK..'

	if  @insp_mtd not in ('AL','SA','NO')
		select @status='1',@out_msg='검사방식을 확인하세요???'
    	else if @insp_mtd = 'NO'  --무검사
		select @acpt_qty=@insp_qty,@reject_qty=0
	else if  @insp_mtd = 'SA'  --포본검사
	begin
		if  @lot_flag not in ('A','C','R')
			select @status='1',@out_msg='Lot합부판정확인(A,R,C)????'
		else if  @sample_qty < @entry_fail_qty
			select @status='1',@out_msg='샘플불량수량이 샘플수량보다 큽니다????'
		else if  @sample_reject_qty <= @entry_fail_qty
		begin
			if  @lot_flag in ('C')
				select @acpt_qty=0,@reject_qty=@insp_qty
			else
				select @status='1',@out_msg='불합격시Ａ는 않됨'
		end
		else
		begin
			if  @lot_flag = 'R'
				select @status='1',@out_msg='합격시 Ｒ은 않됨'
				select @acpt_qty=@insp_qty,@reject_qty=0
		end
	end
	else -- 'AL' 전수검사
	begin
		if  @insp_qty < @entry_fail_qty
			select @status='1',@out_msg='검사수량은 납품수량보다 작아야 합니다???'
		else
			select @acpt_qty=@insp_qty-@entry_fail_qty,@reject_qty=@entry_fail_qty
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_IO_Each_Accounting                                                                                                                                                    */
/*  DISCRIPTION  : 재고 1개 레코드별 월수불처리     (수불옵션 Check 제외 )                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_IO_Each_Accounting]
	@item_no			varchar(15),	
	@gaijung			varchar(04),
	@store				varchar(06),
	@order_select		varchar(01),
	@year_month			char(06),
	@prev_Year_Month	char(06),
	@from_date			char(08),
	@to_date			char(08),
	@status				char(01)		output,
	@out_msg			varchar(100)	output
AS
SET NOCOUNT ON

/*
declare	@item_no		varchar(15),	
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select		varchar(01),
	@year_month		char(06),
	@prev_Year_Month	char(06),
	@from_date		char(08),
	@to_date		char(08),
	@status			char(01),
	@out_msg		varchar(100)

select	@item_no	='AEG08C734*E',
	@gaijung		='ELES',
	@store			='WHELES',
	@order_select		='D',
	@year_month		='201008',
	@prev_Year_Month	='201007',
	@from_date		='20100726',
	@to_date		='20100825'

exec SP_Common_IO_Each_Accounting
	@item_no,
	@gaijung,
	@store	,
	@order_select,
	@year_month,
	@prev_Year_Month,
	@from_date	,
	@to_date	,
	@status		output,
	@out_msg	output

select @status,@out_msg
*/


							
--당월 입출고가 없는 item에 대한 월수불 생성 
	
	declare	@before_amt_stock	float,
			@after_amt_stock	float,
			@before_amt_output	float,
			@after_amt_output	float,
			@price_output		float

	select @status='0'

	if not exists (select * from T_MVA_060 b with (index=PK_T_MVA_060 nolock)
					where b.item_no=@item_no
					and b.gaijung = @gaijung
					and b.store=@store
					and b.order_select=@order_select
					and b.year_month=@year_month)
	begin
		insert into T_MVA_060
		select	item_no=a.item_no,
				gaijung=a.gaijung,
				store=a.store,
				order_select=a.order_select,
				year_month=@year_month,
				qty_trans=a.qty_stock,
				amt_trans=a.amt_stock,
				qty_input=0,
				amt_input=0,
				qty_output=0,
				amt_output=0,
				qty_stock=a.qty_stock,
				amt_stock=a.amt_stock,
				price_avg=a.price_avg
		from T_MVA_060 a with (index=PK_T_MVA_060 nolock)
		where a.item_no=@item_no
		and a.gaijung = @gaijung
		and a.store=@store
		and a.order_select=@order_select
		and a.year_month=(select max(b.year_month)
							from T_MVA_060 b with (index=PK_T_MVA_060 nolock)
							where b.item_no=a.item_no
							and b.gaijung = a.gaijung
							and b.store=a.store
							and b.order_select=a.order_select
							and b.year_month < @year_month)

		select @status='0',@out_msg=' OK ...'
		return
	end


	if exists (select a.*
		from 	T_MVA_060 a with (index=PK_T_MVA_060 nolock),
			(select qty_input=isnull(sum(qty),0.0),amt_input=isnull(sum(amut+MATR_AMOUNT),0.0)
				from el_cd..T_VA_040 b with (index=ix_t_va_040_4 nolock)
				where b.item_no=@item_no
				and b.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'
				and b.gaijung = @gaijung
				and b.store=@store
				and b.supply=@order_select) b
		where a.item_no=@item_no
		and a.gaijung = @gaijung
		and a.store=@store
		and a.order_select=@order_select
		and a.year_month=@year_month
		and (abs(a.qty_input -b.qty_input) > 0.01 or abs(a.amt_input - b.amt_input) > 0.01) )
	begin
		select @status='1',@out_msg=' 월전표의 입고수량금액이 월누계와 불일치 ????'
		return
	end


	if exists (select a.*
		from 	T_MVA_060 a with (index=PK_T_MVA_060 nolock),
				(select qty_output=isnull(sum(qty),0.0)
				from mrp..T_MVA_041 b with (index=IX_T_MVA_041_1 nolock)
				where b.item_no=@item_no
				and b.gaijung = @gaijung
				and b.store=@store
				and b.order_select=@order_select
				and b.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59') b
		where a.item_no=@item_no
		and a.gaijung = @gaijung
		and a.store=@store
		and a.order_select=@order_select
		and a.year_month=@year_month
		and abs(a.qty_output -b.qty_output) > 0.01 )
	begin
		select @status='1',@out_msg=' 월전표의 출고수량과 월누계와 불일치 ????'
		return
	end


begin tran Common_IO_Each_Accounting

	select @before_amt_stock=a.amt_stock,@before_amt_output=a.amt_output
	from T_MVA_060 a with (index=PK_T_MVA_060 rowlock)
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.year_month=@year_month


--y 월수불처리(재고마스터)
	update a set 
		price_avg= (a.amt_trans + a.amt_input ) / (a.qty_trans + a.qty_input)
	from T_MVA_060 a with (index=PK_T_MVA_060 )
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.year_month=@year_month
	and (a.qty_trans + a.qty_input > 0 and  a.amt_trans + a.amt_input > 0)

	update a set
		amt_output = a.amt_trans + a.amt_input - round(a.qty_stock * a.price_avg,0),
		amt_stock= round(a.qty_stock * a.price_avg,0)
	from T_MVA_060 a with (index=PK_T_MVA_060 rowlock)
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.year_month=@year_month

	select	@after_amt_stock = amt_stock,@after_amt_output=a.amt_output,
			@price_output=(case when a.qty_output  = 0
							then A.price_avg
							else a.amt_output / a.qty_output end)
	from T_MVA_060 a with (index=PK_T_MVA_060 rowlock)
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.year_month=@year_month

--x.1 전표출고금액 계산
	update a set
		amt=round(a.qty*@price_output,0)
	from T_MVA_041 a with (index=IX_T_MVA_041_1)
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'

--x.2 배부금액 차이계산
	declare	@amt_output	float,
	--		@amt		float,
			@max_amt	float,
			@jp_no		varchar(13)

	select @amt_output=isnull(sum(a.amt),0.0),@max_amt=isnull(max(a.amt),0.0)
	from T_MVA_041 a with (index=IX_T_MVA_041_1)
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'

--x.3 금액이 제일 큰 전표 찾기
	if @amt_output <> @after_amt_output
	begin
		select	@jp_no=(select max(b.jp_no) from T_MVA_041 b with (index=IX_T_MVA_041_1 nolock)
						where b.item_no=@item_no
						and b.gaijung=@gaijung
						and b.store=@store
						and b.order_select = @order_select
						and b.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'
						and b.amt = @max_amt)
		if @jp_no is null
		begin
			rollback tran Common_IO_Each_Accounting
			select @status='4',@out_msg=@item_no+@gaijung+@store+@order_select+'  출고금액배부 Error(출고전표없음) ???'
			return
		end
	end

--x.4 배부금액 차이 전표에 반영
	update b set
		amt=b.amt + (@after_amt_output - @amt_output)
	from T_MVA_041 b with (index=PK_T_MVA_041 )
	where b.jp_no=@jp_no

-- z 월,년재고 Update
	declare	@diff_stock	float,
		@diff_output	float

	select @diff_stock=@after_amt_stock-@before_amt_stock
	select @diff_output=@after_amt_output-@before_amt_output

	update a set
		amt_trans=a.amt_trans+ @diff_stock,
		amt_stock=a.amt_stock + @diff_stock
	from T_MVA_060 a
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	AND year_month > @year_month

	update a set
		amt_output=a.amt_output + @diff_output,
		amt_stock=a.amt_stock + @diff_stock,
		price_avg=(case when amt_stock > 0 and a.qty_stock>0
				then (a.amt_stock + @diff_stock) / a.qty_stock
				else a.price_avg end)
	from mrp..T_MVA_061 a
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	


-- 수불결과 Check

	declare	@jp_qty_output_sum	float,
			@jp_amt_output_sum	float,
			@jp_qty_input_sum	float,
			@jp_amt_input_sum	float,
			@mm_qty_output_sum	float,
			@mm_amt_output_sum	float,
			@mm_qty_input_sum	float,
			@mm_amt_input_sum	float

	select	@jp_qty_output_sum=isnull(sum(qty),0),@jp_amt_output_sum=isnull(sum(amt),0)
	from T_MVA_041 b with (index=IX_T_MVA_041_1 nolock)
	where b.item_no=@item_no
	and b.gaijung=@gaijung
	and b.store=@store
	and b.order_select = @order_select
	and b.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'

	select	@jp_qty_input_sum=isnull(sum(qty),0),@jp_amt_input_sum=isnull(sum(amut+MATR_AMOUNT),0)
	from EL_CD..T_VA_040 b with (index=ix_t_va_040_4 nolock)
	where b.item_no=@item_no
	and b.date_io between @from_date + ' 00:00:00' and @to_date +  ' 23:59:59'
	and b.gaijung=@gaijung
	and b.store=@store
	and b.supply = @order_select


	select	@mm_qty_output_sum=qty_output,@mm_amt_output_sum=amt_output,
		@mm_qty_input_sum=qty_input,@mm_amt_input_sum=amt_input
	from T_MVA_060 a with (index=PK_T_MVA_060 )
	where a.item_no=@item_no
	and a.gaijung =@gaijung
	and a.store=@store
	and a.order_select=@order_select
	and a.year_month=@year_month

	if ABS(@mm_qty_output_sum - @jp_qty_output_sum) > 0.01
	begin
		select @status='1',@out_msg=' 전표의 출고수량과 월출고수량 상이 ????  ' 
		+ convert(varchar(10),@jp_qty_output_sum) + ' ' + convert(varchar(10),@mm_qty_output_sum)
	end
	else if ABS(@mm_amt_output_sum - @jp_amt_output_sum) > 0.01
	begin
		select @status='1',@out_msg=' 전표의 출고금액과 월출고금액 상이 ????'+convert(varchar(20),@mm_amt_output_sum - @jp_amt_output_sum)
	end
	else if ABS(@mm_qty_input_sum - @jp_qty_input_sum) > 0.01
	begin
		select @status='1',@out_msg=' 전표의 입고수량과 월입고수량 상이 ????'
	end
	else if ABS(@mm_amt_input_sum - @jp_amt_input_sum) > 0.01
	begin
		select @status='1',@out_msg=' 전표의 입고금액과 월입고금액 상이 ????'
	end
	else
		select @status='0',@out_msg=' OK ...'

	 if @status >'0' 
		rollback tran Common_IO_Each_Accounting
	else
		commit tran Common_IO_Each_Accounting;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Issuance_By_PartSeq                                                                                                                                                    */
/*  DISCRIPTION  : 수불항번별 창고이동처리                                                                                                                                */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Issuance_By_PartSeq]
	@gaijung	char(04),
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02),
	@part_seq	varchar(04),
	@io_date	char(08),
	@qty		float,
	@user_id	varchar(10),
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON
/*

declare	@qty_out			float	,
	@status			char(01)	,
	@out_msg		varchar(100)	

exec SP_Common_Issuance_By_PartSeq 'ELES','2006F  1476','E03','03','AIA0','20100401',1,
	@status			output,
	@out_msg		output

select 	@status			,
	@out_msg		

*/
	declare	@item_no		varchar(15),
			@tn01_qty		float,
			@order_select	char(01),
			@qty_out		float,
			@proc_qty		float
		
	declare	@issue_qty		float,
			@result_qty		float



	select 	@item_no=item_no,
			@tn01_qty=(case when @qty = 0 
					then  a.cont_qty-a.prod_qty 
					else (case when @qty <= a.cont_qty-a.prod_qty 
						then @qty else a.cont_qty-a.prod_qty  end)
					end),
			@gaijung=gaijung,
			@order_select=(case when left(a.gaijung,2)='SY' and a.order_select = 'M' and a.out_factory_flag = 'S' and a.ship_flag = 'N'
						then 'D'
						else a.order_select
						end)
	from EL_CD..T_CA_011 a
	where project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq
	and gaijung=@gaijung

	if @tn01_qty is null or @tn01_qty <= 0
	begin
		select @status='1',@out_msg=' 처리할 수량이 없읍니다 ???'
		return
	end

	create table #store (
		store			varchar(10),
		store_priority	int
	)

	exec SP_Common_Issuance_Store_table_load @gaijung

	create table #order_select (
		order_select	char(01),
		select_priority	int
	)

	exec SP_Common_Issuance_order_select_table_load @gaijung, @order_select,'N'

	create table #repl_item (
		item_no_r	varchar(15),
		priority	int
	)

	select @status='0',@out_msg=''

	insert into #repl_item values (@item_no,1)

	insert into #repl_item
	select item_no_r,2
	from T_MYA_16
	where item_no=@item_no

	select @proc_qty=@tn01_qty,@issue_qty=0

	select @status='0',@out_msg='출고처리 OK ...'

begin tran Common_Issuance_By_PartSeq

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select	a.item_no_r
		from #repl_item a
		order by a.priority
	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	@item_no

	WHILE (@@FETCH_STATUS = 0 and @status < '1' and @proc_qty > 0)	
	begin
        exec SP_Common_Issuance_By_PartSeq_SUB
			@project_no,
			@mfg_no,
			@part,
			@part_seq,
			@item_no,
			@io_date,
			@proc_qty,		-- 출고요구수량
			@user_id,
			@qty_out		output,	--실제출고수량
			@status		output,
			@out_msg	output

		if @status > '0'
		begin
			if @issue_qty+@qty_out = 0
			begin
				CLOSE TTT0
			   	DEALLOCATE TTT0
				rollback tran Common_Issuance_By_PartSeq
				return
			end

			select 	@out_msg=convert(varchar(10),@tn01_qty) + '개중 ' + 
					convert(varchar(10),@issue_qty+@qty_out) + '개 출고,'+
					@out_msg
		end

		select 	@issue_qty=@issue_qty+@qty_out
		select 	@proc_qty = @proc_qty - @qty_out

	   	FETCH NEXT FROM TTT0 INTO 	@item_no
	end
	CLOSE TTT0
   	DEALLOCATE TTT0


	if  @issue_qty > 0
	begin
		exec	SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				'L',		--@run_status
				@issue_qty,
				@io_date,
				@result_qty	output
	
		if @result_qty <> @issue_qty
		begin
			rollback tran Common_Issuance_By_PartSeq
			select @status='1',@out_msg=@out_msg+'제통입고 수량 Set Error ????'
			return
		end
	end

	if @status ='0'
	begin
		if @issue_qty = 0
			select @status='1',@out_msg=' 재고가 없읍니다 ????'
		else if  @issue_qty <>  @tn01_qty
			select @status='0',@out_msg=' 부분출고 ...'
		else
			select @status='0',@out_msg=' 출고처리 OK ...'
	end

	if @status > '0'
		rollback tran Common_Issuance_By_PartSeq
	else
		commit tran Common_Issuance_By_PartSeq;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Issuance_By_PartSeq_SUB                                                                                                                                                    */
/*  DISCRIPTION  : 수불항번별 창고이동처리    sub                                                                                                                           */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Issuance_By_PartSeq_SUB]
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02),
	@part_seq	varchar(04),
	@item_no	varchar(15),
	@date_io	char(08),
	@qty		float,
	@user_id	varchar(10),
	@qty_out	float			output,
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON

/*
declare	@qty_out			float	,
	@status			char(01)	,
	@out_msg		varchar(100)	

exec SP_Common_Issuance_By_PartSeq_SUB '2006F  1467','E03','03','AIA0','AEN62C958*Z','',1,
	@qty_out			output,
	@status			output,
	@out_msg		output

select 	@qty_out			,
	@status			,
	@out_msg		

*/

	declare	@gaijung		varchar(04),
			@order_select	char(01),
			@store			varchar(06),
			@code			varchar(08),
			@issue_slip_no	varchar(13),
			@item_group_sub	varchar(10),
			@curr_date_8	char(08)

	declare	@item_unit		varchar(02),
			@qty_stock		float,
			@proc_qty		float,
			@io_qty			float,
			@result_amt		float,
			@result_qty		float
	
	select @curr_date_8 = convert(char(08),getdate(),112)

	select 	@gaijung=gaijung,@item_group_sub=item_group_sub
	from EL_CD..T_CA_011 a
	where project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq

	select @proc_qty=@qty

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select	a.store,a.order_select,a.qty_stock
		from T_MVA_061 a,#store b,#order_select c
		where a.gaijung=@gaijung
		and a.item_no=@item_no
		and a.qty_stock > 0
		and b.store=a.store
		and c.order_select=a.order_select
		order by c.select_priority,b.store_priority
	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	@store,@order_select,@qty_stock

	WHILE (@@FETCH_STATUS = 0 and @status <= '0' and @proc_qty > 0 )	
	begin
		if @proc_qty > @qty_stock
			select @io_qty=@qty_stock,@proc_qty=@proc_qty-@qty_stock
		else
			select @io_qty=@proc_qty,@proc_qty=0
		

		exec SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@order_select,
			'B',	-- A:입고 B:출고
		 	@date_io,
			@io_qty,
			0,	-- io_amt 
			0,	-- io_matl_amt 
			@result_amt	output,
			@status		output,
			@out_msg	output

		if @status > '0'
		begin
			select @qty_out=@qty - @proc_qty - @io_qty
			return
		end

		select @code='G1'+ right(@curr_date_8,6)
		exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output

		insert into T_MVA_041
		select	jp_no=@issue_slip_no,
				date_io=(case when @date_io = @curr_date_8 then getdate() else @date_io end),
				gaijung=@gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp='1',

				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,

				qty=@io_qty,
				amt=@result_amt,
				order_no='',
				vendor='',
				work_center='',
				out_use=(case  left(@mfg_no,1) 
					when 'B' then 'E'
					when 'J' then 'L'
					when 'K' then 'C'
					when 'N' then 'B'
					--when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '1' end)
					else '1' end),
				item_group_sub=@item_group_sub,
				scrap_qty=0,
				creator=@user_id

	   	FETCH NEXT FROM TTT0 INTO 	@store,@order_select,@qty_stock
	end
	CLOSE TTT0
   	DEALLOCATE TTT0

	select @qty_out = @qty - @proc_qty

	select @status='0',@out_msg='...';

CREATE PROCEDURE [dbo].[SP_Common_Issuance_order_select_table_load]
	@gaijung		char(04),
	@order_select	char(01),
	@specific		char(01)
	
AS
SET NOCOUNT ON

	declare	@cnt			int,
			@order_selects	varchar(10)

	truncate table #order_select	

	select @cnt=0

	if @order_select > '0'
	begin
		select @cnt=@cnt+1
		insert into #order_select values (@order_select,@cnt)
		if @specific='Y'
			return
	end
		
	 if @gaijung = 'SPSS'
	  select @order_selects='SIDXZDL'
	 else
	  select @order_selects='DSXZDIL'

--	select @order_selects='DSXZDIL'

	while len(rtrim(@order_selects))> 0
	begin

		if left(@order_selects,1) = @order_select
			select @order_selects=substring(@order_selects,2,10)
		else 
		begin
			select @cnt=@cnt+1
			insert into #order_select values (left(@order_selects,1),@cnt)
			select @order_selects=substring(@order_selects,2,10)
		end
	end;

CREATE PROCEDURE [dbo].[SP_Common_Issuance_Store_table_load]
	@gaijung	varchar(04)
AS
SET NOCOUNT ON

	declare	@cnt			int,
			@stores_ELES	varchar(100),
			@stores_SYHP	varchar(100),
			@stores			varchar(100)

	truncate table #store

	select @stores_ELES='WHELES,1573'
	select @stores_SYHP='WHSYHP',@stores=''

	if @gaijung = 'ELES'
		select @stores = @stores_ELES
	else if @gaijung = 'SYHP'
		select @stores = 'WHSYHP'
	else if @gaijung = 'SPSS'
		select @stores = 'WHSPSS'
	else if @gaijung = 'OSES'
		select @stores = 'WHOSES'

	select @cnt=0

	while len(rtrim(@stores))> 0
	begin
		select @cnt=@cnt+1
		if charindex(',',@stores) > 0
		begin
			insert into #store values (left(@stores,charindex(',',@stores)-1),@cnt)
			select @stores=substring(@stores,charindex(',',@stores)+1,100)
		end
		else
		begin
			insert into #store values (@stores,@cnt)
			select @stores=''
		end
	end;

/********************************************************************************/
/*  SP NAME          : SP_Common_Issue_ready_Creation_AO						*/
/*  DESCRIPTION      : 제조 생산 계획 - 불출대기 생성							*/
/*  RELATIVE_FORM    : mes_005,  MRP_TTG										*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_Common_Issue_ready_Creation_AO]
	@order_no	varchar(08),
	@user_id	varchar(10),
	@stat		char(01)		output,
	@msg		varchar(100)	output
AS

SET NOCOUNT ON
--grant exec on SP_Common_Issue_ready_Creation_AO to applications
/*
declare	@status		char(01),
		@out_msg	varchar(50) 

EXEC SP_Common_Issue_ready_Creation_AO 'A2002006', 'T00494', @status output, @out_msg output

select @status, @out_msg
*/

	declare	@last_ot_no		tinyint,
			@run_status		char(01),
			@item_no		varchar(15),
			@curr_year		char(04),
			@gaijung		varchar(04),
			@str			varchar(10),
			@leadtime		int,
			@out_use		char(01),
			@date_start		smalldatetime,
			@parent_item_no	varchar(15),
			@wc_code		varchar(06),
			@due_date		smalldatetime  --,
--			@base_flag		char(01)		/** 1:제조시작일자  2:제조납기기준 ***/

	select @stat='0',@msg='OK(불출대기 생성)',@last_ot_no = null

	if not exists (	select	'Y'
					from t_MYO_01 a with (nolock), el_cd..t_ca_011 b with (nolock)  
					where a.order_no = @order_no
				--	and a.run_status = '1'
                    and a.run_status in ('0','1')
					and b.project_no = a.project_no  
					and b.mfg_no = a.mfg_no  
					and b.part = a.part  
					and b.part_seq = a.part_seq  
					and b.cont_qty > 0 )
	begin
		select @stat='2',@msg='Error(불출대기 대상 제조지시번호 없음)'
		return
	end
	
	select @curr_year=left(convert(char(08),getdate(),112),4)

	select 	@last_ot_no=last_ot_no, @run_status=run_status, @gaijung=gaijung,        @out_use=ao_need,
			@date_start=date_start, @due_date=due_date,     @parent_item_no=item_no, @wc_code=wc_code
	from T_MYO_01
	where order_no = @order_no
	

	--if (@last_ot_no > 0 or @run_status <> '1' or @gaijung <> 'SPSS')
	if (@last_ot_no > 0 or @run_status not in ('0', '1') or @gaijung <> 'SPSS')
	begin
		select @stat='3',@msg='Error(불출대기 생성 대상 아님)'
		return
	end

	if not exists (select 'Y'
					from T_MYO_01 x, EL_CD..T_CX_069 a
					where x.order_no=@order_no
					and a.item_no = x.item_no)
	begin
		select @stat='4',@msg='Error(불출대기 생산 BOM 없음)'
		return
	end

	select @str=substring(master.dbo.fGetCodeDesc('Z28',@gaijung+@curr_year),2,2)

	declare	@child_item_no	varchar(15),
			@order_select	char(01),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part			char(02),
			@part_seq		varchar(04),
			--@special		char(01),
			@qty			real,
			@cnt			int=0,
			@unit_qty		real
	
begin tran Issue_ready_Creation_AO


	DECLARE TTT CURSOR LOCAL SCROLL  FOR
		select 	a.citem_no, 
				--order_select= (case when substring(a.mark,4,1) in ('D','I','L','S','X','Z','A','M') 
				--					then substring(a.mark,4,1)
				--					else isnull((select c.order_select from EL_CD..T_CX_060 c where c.item_no=a.citem_no),'') end),
				order_select= isnull((select c.order_select from EL_CD..T_CX_060 c where c.item_no=a.citem_no),'') ,
				qty=round(a.unit_qty*x.qty_ao,3),
				x.project_no,x.mfg_no,x.part,x.part_seq,--a.special,
				unit_qty=a.unit_qty
		from T_MYO_01 x, EL_CD..T_CX_069 a --, T_MZW_12 b with (index=idx_T_MZW_12_001 nolock)
		where x.order_no=@order_no
		and a.item_no = x.item_no
		order by a.sh_no

	OPEN TTT

   	FETCH NEXT FROM TTT INTO @child_item_no,	@order_select,	@qty,
							 @project_no,		@mfg_no,		@part,	@part_seq,	--@special,	
							 @unit_qty

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @cnt=@cnt+1

		insert into T_MZE_01
		select	jp_no= 'X'+ @order_no + master.dbo.fMakeStrSeq(@cnt, 3) + '0',
				item_no=@child_item_no,
				order_no=@order_no,
				order_select=@order_select,
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				parent_item_no=@parent_item_no,
				vendor='',
				wc_code=@wc_code,
				gaijung=@gaijung,
				store='WH' + @gaijung,
				skp='',
				out_use='',
				shortage_mark='',
				last_jp_seq=0,
				qty=@qty,
				qty_out=0,
				date_start=@date_start,
				date_due=@due_date,
				date_out=NULL,  --dateadd(d,0-@leadtime,(case when @base_flag='1' then @date_start else @due_date end)),
				unit_qty=@unit_qty,
				creator = @user_id,
				date_entry = getdate(),
				status = '1',
				create_pgm=(case when @user_id = 'MRP_TTG' then 'Batch' 
							 	 else 'Online'
								 end),
				NULL,
				''

		/*** 품번별 불량율 적용 ZR50 ***/
	
	   	FETCH NEXT FROM TTT INTO @child_item_no,@order_select,@qty,
			@project_no,@mfg_no,@part,@part_seq, --,@special
			@unit_qty
	end
	CLOSE TTT
   	DEALLOCATE TTT


	update a set
		run_status='2',
		out_create_date=getdate(),
		last_ot_no=@cnt
	from T_MYO_01 a
	where order_no = @order_no


	IF @@ERROR = 0
	BEGIN
		COMMIT TRAN Issue_ready_Creation_AO
		select @stat='0',@msg='OK(불출대기 생성)',@last_ot_no = null
	END
	ELSE
	BEGIN	
		ROLLBACK TRAN Issue_ready_Creation_AO
		select @stat='5',@msg='Error(불출대기 오류)',@last_ot_no = null
	END;

/********************************************************************************/
/*                                                                        					*/
/*  PROCEDURE    :  SP_Common_Issue_ready_Creation_PO                  				*/
/*  DISCRIPTION  :  주문번호별 불출대기 생성         			 		*/
/*                                                                        					*/
/*      >> MODIFICATION LOG <                                             				*/
/*                                                                        					*/
/*                                                                        					*/
/*  DATE        	REQUEST #       	S.E NAME         	DESCRIPTION              		*/
/*  -----------------------------------------------------------------------------*/
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/03/16     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Issue_ready_Creation_PO]
	@order_no	varchar(08),
	@store		varchar(06),
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS

--sp_find_str SP_Common_Issue_ready_Creation_PO
SET NOCOUNT ON

	declare	@last_ot_no		tinyint,
			@run_status		char(01),
			@curr_year		char(04),
			@gaijung		varchar(04),
			@str			varchar(10),
			@leadtime		int,
			@out_use		char(01),
			@skp			char(01),
			@date_start		smalldatetime,
			@parent_item_no	varchar(15),
			@vendor			varchar(08),
			@due_date		smalldatetime,
			@base_flag		char(01)		/** 1:제조시작일자  2:제조납기기준 ***/


	select @curr_year=left(convert(char(08),getdate(),112),4)

	select 	@last_ot_no=last_ot_no,@run_status=run_status,@gaijung=gaijung,@vendor=trade_no,
		@date_start=date_start,@due_date=date_due,@parent_item_no=item_no,@skp=skp
	from EL_CD..T_VA_020
	where order_no = @order_no

	if @last_ot_no > 0
	begin
		select @status='4',@out_msg='이미　사급불출전개가　끝난　주문서입니다  ?? '
		return
	end

	if @skp not in ('S','X','Z')
	begin
		select @status='4',@out_msg='사급전개 품목이 아닙니다  ?? '
		return
	end

	select @str=substring(master.dbo.fGetCodeDesc('Z28',@gaijung+@curr_year),2,2)
	select @base_flag=left(@str,1),@leadtime=(case when convert(int,right(@str,1))=0 then 7 else convert(int,right(@str,1)) end)

	select distinct item_no,order_select=supply
	into #selected
	from EL_CD..T_VA_020
	where order_no = @order_no

	declare	@page	datetime,
			@job_id	varchar(10)

	select @page=getdate(),@job_id='XXX'


	delete from T_MTP_01 where page=@page and order_flag='R'
	delete from X_Batch_JOB_Error where page=@page and job_id=@job_id

	exec SP_Common_BOM_EXPL 'R',@job_id,@page

	if  not exists (select *
			from T_MTP_01 where page=@page and order_flag='R')
	begin
		select @status='4',@out_msg=' BOM Explosion Error ??? '
		return
	end

	declare	@child_item_no	varchar(15),
			@order_select	char(01),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part			char(02),
			@part_seq		varchar(04),
			@special		char(01),
			@qty			real,
			@unit_qty		real,
			@cnt			int
	
	select @cnt=0
--sp_find_str T_QC_012

	DECLARE TTT CURSOR LOCAL SCROLL  FOR
		select 	a.child_item_no,a.child_order_select,qty=round(a.qty*x.qty_order,3),
				project_no=left(x.prod_no,11),mfg_no=substring(x.prod_no,12,3),x.part,x.part_seq,a.special,unit_qty=a.qty
		from EL_CD..T_VA_020 x,T_MTP_01 a
		where x.order_no=@order_no
		and a.page=@page
		and a.order_flag = 'R'
		and a.parent_item_no = x.item_no
		and a.parent_order_select = x.supply
		order by left(x.prod_no,11),substring(x.prod_no,12,3),x.part,x.part_seq
	OPEN TTT

   	FETCH NEXT FROM TTT INTO @child_item_no,@order_select,@qty,
			@project_no,@mfg_no,@part,@part_seq,@special,@unit_qty

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @cnt=@cnt+1

		insert into T_MZE_01
		select	jp_no= 'I'+@order_no + right('000'+convert(varchar(03),@cnt),3)+'0',
				item_no=@child_item_no,
				order_no=@order_no,
				order_select=@order_select,

				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				parent_item_no=@parent_item_no,
				vendor=@vendor,
				wc_code='',
				gaijung=@gaijung,
				store=(case when @store > '0' then @store else 'WH' + @gaijung end),
				skp=(case when @special < '0' then '1' else @special end),
				out_use=(case when @special < '0' then '1' else @special end),
				shortage_mark='',
				last_jp_seq=0,
				qty=@qty,
				qty_out=0,
				date_start=@date_start,
				date_due=@due_date,
				date_out=dateadd(d,-7,(case when @base_flag='1' then @date_start else @due_date end)),
				unit_qty=@unit_qty
 
/*** 품번별 불량율 적용 ZR50 ***/
	
	   	FETCH NEXT FROM TTT INTO @child_item_no,@order_select,@qty,
			@project_no,@mfg_no,@part,@part_seq,@special,@unit_qty
	end
	CLOSE TTT
   	DEALLOCATE TTT

	update a set
--		run_status='1',
		last_ot_no=@cnt*10
	from EL_CD..T_VA_020 a
	where order_no = @order_no

	select @status='0',@out_msg='Issue_ready_Creation_PO OK ..',@last_ot_no = null;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Item_Sale                                                                           */
/*  DISCRIPTION  :  유상판매입력                                                                                 */ 
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/02/22     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Item_Sale]
	@o_order_no		varchar(08)='',
	@o_item_no		varchar(15)='',
	@o_gaijung		varchar(04)='',
	@o_store		varchar(06)='',
	@o_supply		char(01)='',
	@o_vendor		varchar(08)='',
	@o_prod_no		varchar(14)='',
	@o_red_gubun	char(01)='',
	@o_date_io		varchar(08)='',
	@o_sale_qty		varchar(10)='0',
	@o_sale_price	varchar(10)='0',
	@o_out_use		char(01)='',
	@o_req_date		varchar(08),
	@o_seq     		int,
	@user_id		varchar(08)='',
	@jp_no			varchar(13)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
as
	declare	@sale_qty	float,
			@sale_price	float,
			@result_amt	float,
			@sale_amt	float

	declare	@slip_no	varchar(13),
			@curr_date	varchar(08),
			@code		varchar(08)

	select	@curr_date=convert(char(08),getdate(),112)


--창고코드 Check 요

	if @o_out_use = 'V'
	begin
		if not exists (select * from el_cd..t_va_020 where order_no=@o_order_no)
		begin
			select @status='1',@out_msg=' Order No Error ???'
			return
		end

		select	@o_item_no=item_no,@o_Supply=supply,@sale_qty= qty_input,@o_prod_no=prod_no,
				@o_gaijung=gaijung
		from EL_CD..T_VA_020 a
		where order_no=@o_order_no
	end
	else
	begin

		if @o_Supply not in ('D','I','L','S','X','Z')
		begin
			select @status='1',@out_msg=' Supply Error ???'
			return
		end

		if not exists (select * from el_cd..t_cx_060 where item_no=@o_item_no)
		begin
			select @status='1',@out_msg=' item No Error ????'
			return
		end

		IF   isnumeric( @o_sale_qty) = 0
		begin
			select @status='1',@out_msg=' 판매수량 Error ???'
			return
		end
	
		select @sale_qty=convert(float,@o_sale_qty)
	end

	IF   @sale_qty <= 0 
	begin
		select @status='1',@out_msg=' 판매수량 Error ???'
		return
	end
	
	if	@o_red_gubun = '1'
	begin
		select @sale_qty = 0 - @sale_qty

		IF   isnumeric( @o_sale_price) = 0
		begin
			select @status='1',@out_msg=' 판매단가 Error ???'
			return
		end
	
	
		select @sale_price=convert(float,@o_sale_price)
	
		IF   @sale_price <= 0 
		begin
			select @status='1',@out_msg=' 판매단가 Error ???'
			return
		end
	end

	if @o_date_io < '0'
		select @o_date_io = convert(char(08),getdate(),112)

	if isdate(@o_date_io)=0
	begin
		select @status='1',@out_msg=' 판매일자 Error ???'
		return
	end

	if not exists (select * from el_cd..t_cx_080 where trade_no=@o_vendor)
	begin
		select @status='1',@out_msg=' Vendor Error ???'
		return
	end
	
	if  exists (select * from el_cd..t_cx_080 where trade_no=@o_vendor and value_vendor='Z')
	begin
		select @status='1',@out_msg=' 거래중지 Vendor  ???'
		return
	end

	declare	@ya14_price			float,
			@ya14_matl_price	float,
			@ya14_date_apply	varchar(08),
			@matr_amt			float

	IF  @o_red_gubun <> '1'
	begin
		exec SP_Common_Price_Fetch
			@o_item_no,
			'D',			--** price_sort ****
			@o_vendor,@o_supply,	
			'',			--** work_mtd  ****
			'WON',
			@o_date_io,		--** apply_date **** 
			'N',			--** etc_apply_flag ****
			@ya14_price		output,
			@ya14_matl_price		output,
			@ya14_date_apply	output,
			@status			output,
			@out_msg		output
	
		if @status > '0'
			return

        select  @sale_price=@ya14_price
	end


begin tran Common_Item_Sale

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
		@o_item_no,
		@o_gaijung,
		@o_store,
		@o_supply,
		'B',	--* A:입고 B:출고 *
	 	@o_date_io,
		@sale_qty,
		0,
		@matr_amt,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran Common_Item_Sale
		return	
	end


--2.출고전표 생성

	select @code='GY'+ right(@curr_date,6)
	exec master.dbo.sp_Numbering_output 'A10',@code,	@slip_no output

	insert into t_mva_041
	select	jp_no=@slip_no,
			date_io=(case when @o_date_io = @curr_date then getdate() else @o_date_io end),
			gaijung=@o_gaijung,
			item_no=@o_item_no,
			store=@o_store,
			order_select=@o_supply,
			skp=(case when @o_out_use in ('X' ,'S') then  @o_out_use else '' end),
			project_no='',
			mfg_no='',
			part='',
			part_seq='',
			qty=@sale_qty,
			amt=@result_amt,
			order_no='',
			vendor=@o_vendor,
			work_center='',
 			out_use=@o_out_use,
	-- 		,out_use=(case  left(@mfg_no,1) 
	-- 			when 'B' then 'E'
	-- 			when 'J' then 'L'
	-- 			when 'K' then 'C'
	-- 			when 'N' then 'B'
	-- 			when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '' end)
	-- 			else '' end)
			item_group_sub='',
			scrap_qty=0,
			creator=@user_id

	if  @@rowcount = 0
	begin
		rollback tran Common_Item_Sale
		select @status='1',@out_msg='출고전표 Insert Error (' + @slip_no + ') ???'
		return
	end

	select @sale_amt=round(@sale_price*@sale_qty,0)

	insert into EL_CD..t_va_050 
	select	jp_no=right(@slip_no,12),
			trade_no=@o_vendor,
			item_no=@o_item_no,
			supply=@o_supply,
			date_issue=@o_date_io,
			order_no=@o_order_no,
			prod_no=@o_prod_no,
			qty=@sale_qty,
			price=@sale_price,
			amut=@sale_amt,
			post_person='',
			date_account=null,
			pass_no='',
			price_buy=@result_amt/@sale_qty,
			gaijung=@o_gaijung,
			out_use=@o_out_use,
			print_cnt=0,
			invoice_no=null,
			cancel_date=null,
			issue_amt=@result_amt

	if  @@rowcount = 0
	begin
		rollback tran Common_Item_Sale
		select @status='1',@out_msg='유상판매전표 Insert Error (' + right(@slip_no,12) + ') ???'
		return
	end


	update i 	set 	
		sale_amt =i.sale_amt + @sale_amt
	from	EL_CD..t_va_010  i
	where	i.trade_no = @o_vendor
	  and	i.in_date =@o_date_io
	  and	i.gaijung =@o_gaijung


	if  @@rowcount = 0
		insert into EL_CD..t_va_010
		select 	trade_no=@o_vendor,
				in_date=@o_date_io,
				gaijung=@o_gaijung,
				amut_won = 0,
				amut_won_not = 0,
				amut_mold = 0,
				amut_mold_not = 0,
				sale_amt = @sale_amt,
				amut_won_all_acnt = 0,
				amut_etc_acnt = 0,
				amut_confirm = 0,
				amut_import=0


	IF @o_out_use in ('S','K','A')
		update  a set
			jp_no = right(@slip_no,12),
			confirm_date = convert(varchar(08), getdate(), 112),
			confirm_flag = 'Y'
		from EL_CD..t_vj_300 a
		where 	item_no = @o_item_no
		and	trade_no = @o_vendor
		and	req_date = @o_req_date
		and	seq = @o_seq
	ELSE
		update  a	set
			jp_no = right(@slip_no,12),
			sagub_date = convert(varchar(08), getdate(), 112),
			sagub_flag = 'Y',
			step = 10
		from EL_CD..t_vj_310 a
		where 	id_identity = @o_seq	

	select @status='0',@out_msg=' 판매처리 OK..',@jp_no=right(@slip_no,12)	

	commit tran Common_Item_Sale;

CREATE PROCEDURE [dbo].[SP_Common_M_Order_Cancel]
	@flag		char(01),	/** M:제조지시, E:불출대기 Only ***/
	@project_no	varchar(11),
	@mfg_no	varchar(03),
	@part		varchar(02),
	@part_seq	varchar(04),
	@order_no	varchar(08),
	@order_qty	real,
	@qty_cancel	real,
	@status		char(01)		output,
	@out_msg	varchar(50)	output

AS
SET NOCOUNT ON

	declare	@zw_proc_qty	real,
		@yo_proc_qty	real,
		@yo_save_qty	real


	if @flag ='E'
	begin
--불출대기관련처리
		select @yo_proc_qty=@order_qty-@qty_cancel

		delete a
		from T_MZE_01 a
		where jp_no between 'IX' + @order_no and 'IX' + @order_no + 'ZZZZ'
		and project_no=@project_no
		and mfg_no=@mfg_no
		and part=@part
		and part_seq=@part_seq
		and a.unit_qty * @yo_proc_qty <= a.qty_out
	
		update a set
			qty = a.unit_qty * @yo_proc_qty
		from T_MZE_01 a
		where jp_no between 'IX' + @order_no and 'IX' + @order_no + 'ZZZZ'
		and project_no=@project_no
		and mfg_no=@mfg_no
		and part=@part
		and part_seq=@part_seq

		return
	end


	if @qty_cancel <= 0
	begin
		select @status='1',@out_msg='취소수량은 0보다 커야 합니다???'
		return
	end

	if not exists (select *
		from T_MYO_01
		where order_no=@order_no)
	begin
		select @status='1',@out_msg='제조지시번호가 존재하지 않읍니다???'
		return
	end

	if not exists (select *
		from T_MYO_01
		where order_no=@order_no
		and run_status < '3'
		and (qty_ao - qty_cancel - qty_finish) >= @qty_cancel )
	begin
		select @status='1',@out_msg='취소 불가능 제조지시번호입니다???'
		return
	end

	if not exists (select *
		from EL_QC..T_QC_012
		where concern_order_no=@order_no
		and project_no=@project_no
		and mfg_no=@mfg_no
		and part=@part
		and part_seq=@part_seq
		and order_qty >= @qty_cancel)
	begin
		select @status='1',@out_msg='해당수량을 취소할수 없읍니다????'
		return
	end
	
--제번추적관련처리
	update a set
		order_qty = a.order_qty - @qty_cancel
	from EL_QC..T_QC_012 a
	where concern_order_no=@order_no
	and project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq

	select @zw_proc_qty=order_qty
	from EL_QC..T_QC_012 a
	where concern_order_no=@order_no
	and project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq

--제조지시관련처리
	update a set
		qty_ao = a.qty_ao - @qty_cancel,
		run_status = (case when a.qty_ao = 0 then '3' else a.run_status end),
		date_chg=getdate(),
		qty_input=(case when a.qty_ao - @qty_cancel <= a.qty_input then a.qty_ao - @qty_cancel else a.qty_input end)
	from T_MYO_01 a
	where order_no=@order_no

	select @yo_proc_qty=qty_ao
	from T_MYO_01 a
	where order_no=@order_no

	select @yo_save_qty = @yo_proc_qty + @qty_cancel
--작업상세관련처리

	if @yo_proc_qty = 0
	begin
		update a set
			qty_finish=0,
			std_run_time=0,
			act_run_time=0
		from T_MYO_11 a
		where order_no=@order_no
	end
	else
	begin
		update a set
			qty_finish=(case when a.qty_finish > @yo_proc_qty then @yo_proc_qty else a.qty_finish end),
			std_run_time = round(a.std_run_time / @yo_save_qty,3) * @yo_proc_qty
		from T_MYO_11 a
		where order_no=@order_no
	end
	

--불출대기관련처리
	delete a
	from T_MZE_01 a
	where jp_no between 'IX' + @order_no and 'IX' + @order_no + 'ZZZZ'
	and project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq
	and a.unit_qty * @zw_proc_qty <= a.qty_out

	update a set
		qty = a.unit_qty * @zw_proc_qty
	from T_MZE_01 a
	where jp_no between 'IX' + @order_no and 'IX' + @order_no + 'ZZZZ'
	and project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq

   

SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[SP_Common_M_Order_Cancel_time]
	@order_no	varchar(08),
	@rout_seq	varchar(03),
	@cancel_time	real,
	@status		char(01)		output,
	@out_msg	varchar(50)	output


AS
SET NOCOUNT ON

  

	if not exists (select *
		from T_MYO_01
		where order_no=@order_no)
	begin
		select @status='1',@out_msg='제조지시번호가 존재하지 않읍니다???'
		return
	end

	if not exists (select *
		from T_MYO_01
		where order_no=@order_no
		and run_status < '3')
	begin
		select @status='1',@out_msg='취소 불가능 제조지시번호입니다???'
		return
	end

	if not exists (select *
		from T_MYO_11 a
		where order_no=@order_no
		and rout_seq = @rout_seq
		and std_run_time >= @cancel_time)
	begin
		select @status='1',@out_msg='취소할 시간이 모자랍니다???'
		return
	end
--특정공정 작업시간 취소처리
    

	
	update a set
		std_run_time=a.std_run_time-@cancel_time
	from T_MYO_11 a
	where order_no=@order_no
	and rout_seq = @rout_seq
	and std_run_time >= @cancel_time
	
SET NOCOUNT OFF;

/****************************************************************************************************************/
/*  SP NAME      : SP_Common_M_Order_PriceSet                                                                   */
/*  DISCRIPTION  :  제조단가 셋팅(재료비+Burden)                                                                  */ 
/*  >> MODIFICATION LOG <<                                                                                      */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                     */
/*  ---------------------------------------------------------------                                             */
/* 2024-10-11   GJDE Wave2 자작단가 셋팅			lgssha	제조단가 재료비셋팅(보수자재 단가 입력용)					*/
/****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_M_Order_PriceSet]
	@o_order_no		varchar(08)=''
as
begin
-- grant exec on SP_Common_M_Order_PriceSet to applications
-- EXEC SP_Common_M_Order_PriceSet 'A2401590'
/*

select order_no,project_no, mfg_no, part, part_seq,item_no,*
from mrp.dbo.T_MYO_01
where labor is null
and order_no like 'A24%'
and run_status<>'Z'
and run_status in ('6','7','8','9')
and date_out<'20240925'
and date_out>'20240901'


*/
	declare	@amt	float,
			@labor	float,
			@amt_burden	float 

	declare	@project_no	varchar(13),
			@mfg_no		varchar(13),
			@part		varchar(13),
			@part_seq	varchar(13),
			@item_no	varchar(13),
			@curr_date	varchar(08)

	select	@curr_date=convert(char(08),getdate(),112)
	--select	@curr_date='20230101'

	select	@project_no=project_no, 
			@mfg_no=mfg_no, 
			@part=part, 
			@part_seq=part_seq,
			@item_no=item_no
	from mrp.dbo.T_MYO_01
	where order_no = @o_order_no
	and run_status<>'Z'

	select @amt=sum(amt)
	from mrp.dbo.t_mva_041
	where project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq
	and jp_no like 'XA%'

	select	@labor=round(d.labor_multi * d.work_time_multi,0),
			@amt_burden=d.labor_single
	from EL_CD.dbo.t_cj_020 d
	where year=left(@curr_date,4)
	and usage='M'
	and item_no=@item_no

	-- 자작원가 업데이트
	--/*
	update a set 
		amt=@amt,
		labor=isnull(@labor,0),
		amt_burden=isnull(@amt_burden,0)
	from mrp.dbo.T_MYO_01 a
	where order_no = @o_order_no
	--*/

	-- 원가 검증 확인
	/*
	select	@item_no,
			@amt,
			@amt_burden,
			@labor,
			amt,
			amt_burden,
			labor			
	from mrp.dbo.T_MYO_01 a
	where order_no = @o_order_no

	
	select matl_domestic+matl_import,matl_other,labor,*
	from el_cd.dbo.t_na_040_m_ssi_transfer
	where project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq


	select a.matl_domestic+a.matl_import,a.matl_other,a.labor,b.*
	from el_cd.dbo.t_na_040_m_ssi_transfer a
	inner join el_cd.dbo.t_na_040_m_ssi b
	on b.project_no=a.project_no_to and b.mfg_no=a.mfg_no_to and b.part=a.part_to and b.part_seq=a.part_seq_to
	where a.project_no=@project_no
	and a.mfg_no=@mfg_no
	and a.part=@part
	and a.part_seq=@part_seq
	*/	 
end;

/****************************************************************************************************************/
/*  SP NAME      : SP_Common_M_Order_PriceSet_Batch                                                             */
/*  DISCRIPTION  :  미셋팅분 일괄반영                                                                            */ 
/*  >> MODIFICATION LOG <<                                                                                      */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                     */
/*  ---------------------------------------------------------------                                             */
/* 2024-10-11   GJDE Wave2 자작단가 셋팅			lgssha	제조단가 재료비셋팅(보수자재 단가 입력용)					*/
/****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_M_Order_PriceSet_Batch]
	
as
begin
-- grant exec on SP_Common_M_Order_PriceSet_Batch to applications
-- EXEC SP_Common_M_Order_PriceSet_Batch
 
	declare @order_no varchar(8)
	DECLARE TTT CURSOR LOCAL SCROLL  FOR
	
		select top 50 order_no
		from mrp.dbo.T_MYO_01
		where labor is null
		and order_no like 'A%'
		and run_status<>'Z'
		and date_inspect is not null

	OPEN TTT

	FETCH NEXT FROM TTT INTO @order_no

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @order_no
		EXEC SP_Common_M_Order_PriceSet @order_no

		FETCH NEXT FROM TTT INTO @order_no
	end
	CLOSE TTT
	DEALLOCATE TTT
end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Arrival                                                                        */
/*  DISCRIPTION  :  남품 처리  Common SP                                                                         */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023/10/30     ITSR72315               UNGJ           거래선 변경                                             */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Matl_Arrival]
	@opt_order_no	varchar(08),
	@opt_qty		float=0,		-- 0:이면 전량
	@entry_price	float=0,		-- 입력 단가적용시 
	@user_id		varchar(08)='',
	@slip_no		varchar(13)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
SET NOCOUNT ON

	declare	@curr_date_8		char(08),
			@curr_date			smalldatetime,
			@proc_matl_price	float,
			@temp_qty			float,
			@va020_price		float

	declare	@zr03_acpt_delay1	smallint,		--* 납기전허용일수 ***
			@zr03_acpt_delay2	smallint,		--* 납기후허용일수***
			@zr03_qty_acpt		float,		--* 납품허용수량% ***
			@zr03_to_store		varchar(6),	--* 대표창고 ***
			@zr03_insp_qty_flag	char(01)		--* 검수여부 *

	select @curr_date = getdate()
	select @curr_date_8 = convert(char(08),@curr_date,112)

	declare	@order_select	char(01),
			@item_no		varchar(15),		--* 지정하면 지정한 품목으로 출고 : 대치출고시 사용 ***
			@date_apply		varchar(08),
			@run_status		char(01),
			@gaijung		varchar(04),
			@insp_advan		char(01)

	declare	@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part			varchar(02),
			@part_seq		varchar(04),
			@store			varchar(06),
			@ship_flag		char(01),
			@post_person	char(04),
			@product_code	varchar(03),
			@money_unit		varchar(03),
			@item_unit		char(02),
			@code			char(08),
			@vendor			varchar(08),
			@qty_order		float,
			@qty_cancel		float,
			@qty_reject		float,
			@proc_qty		float,
			@proc_price		float,
			@qty_deliv		float,
			@loop_cnt		int,
			@date_print_po	varchar(08),
			@due_date		varchar(08),
			@date_start		varchar(08),
			@insp_select	char(01),
			@insp_mtd		char(02),
			@insp_level		char(02),
			@insp_range		char(02),
			@po_status		char(01),
			@po_run_status	char(01),
			@sample_qty		int,
			@acpt_qty		int,
			@reject_qty		int,
			@approve_flag	char(1)

	select 	@gaijung=gaijung,@order_select=supply,
			@item_no=(case when @item_no > '0' then @item_no else item_no end),
			@project_no=left(prod_no,11),@mfg_no=substring(prod_no,12,3),@part=part,@part_seq=part_seq,
			@vendor=trade_no,
			@date_print_po=convert(char(08),date_print_po,112),
			@date_start=convert(char(08),date_start,112),
			@qty_order=qty_order,@qty_cancel=qty_cancel,@qty_reject=qty_reject,
			@qty_deliv=qty_deliv,@money_unit=money_unit,
			@due_date=convert(char(08),date_due,112),
			@post_person=post_person,@po_status=po_status,@po_run_status=run_status,
			@insp_select=isnull(insp_select,'N'),@ship_flag=ship_flag,
			@item_unit=item_unit,			
			@va020_price=price,
			@approve_flag=approve_flag
	from EL_CD..T_VA_020 a
	where order_no=@opt_order_no
	
	--if left(@gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	--begin
	--	select @status='1',@out_msg=' 담당사업부가 아닙니다 ???'
	--	return
	--end	

	if @po_status in ('4','5') or @po_run_status <> '4'
	begin
		select @status='1',@out_msg='납품 불가한 주문번호입니다. 확인바람????'
		return
	end

--** 납품관련정보 ***
	if not exists (select * from T_MZR_03
					where gaijung=@gaijung
					and order_select=@order_select)
	begin
		select @status='1',@out_msg='납품 Option Not Found in SP_Common_Matl_Arrival '
		return
	end
	
	select	@zr03_acpt_delay1	=acpt_delay1,
			@zr03_acpt_delay2	=acpt_delay2,		--* 납기후허용일수***
			@zr03_qty_acpt		=qty_acpt,		--* 납품허용수량% ***
			@zr03_to_store		=to_store,	--* 대표창고 ***
			@zr03_insp_qty_flag	=insp_qty_flag		--* 검수여부 *
	from T_MZR_03
	where gaijung=@gaijung
	and order_select=@order_select		
	
--납기허용check 

	if @curr_date_8 > @due_date and datediff(d,convert(smalldatetime,@due_date),@curr_date) > @zr03_acpt_delay2 
	begin
		select @status='2',@out_msg=' 납기를 ' + convert(varchar(04),@zr03_acpt_delay2) + 
			'일 초과하여 납품 불가합니다 ???'
		return
	end

	if @curr_date_8 < @due_date and datediff(d,getdate(),convert(smalldatetime,@due_date)) > @zr03_acpt_delay1
	begin
		select @status='2',@out_msg=' 납기전 ' + convert(varchar(04),@zr03_acpt_delay1) + 
			'일 이전에 납품 불가합니다 ???'
		return
	end

--납품수량 결정  납품허용율 감안
  	select @proc_qty = @qty_order + round(@zr03_qty_acpt * @qty_order / 100,0) - @qty_cancel - (@qty_deliv - @qty_reject)

	if @opt_qty > 0
	begin
		if @proc_qty < @opt_qty
		begin
			select @status='2',@out_msg=' 납품수량을 재입력하세요 ???'
			return
		end

		select @proc_qty=(case when @opt_qty < @proc_qty then @opt_qty else @proc_qty end)
	end

	if @proc_qty <= 0
	begin
		select @status='2',@out_msg=' 납품할수량이 없읍니다 ???'
		return
	end
	
	if ISNULL(@approve_flag,'N') <> 'Y' and @gaijung <> 'SYHP' and @order_select <> 'I' -- By 신종표K 20110415 09:13
	begin
		select @status='1',@out_msg='주문 미승인으로 납품불가합니다'
		return
	end	

-- 납품단가 Fetch
	exec SP_Common_Input_Price_Search
		@gaijung,
		@order_select,
		@item_no,
		@vendor,
		@entry_price,
		@va020_price,
		@money_unit,
		@date_print_po,
		@due_date,
		@date_start,
		@proc_price			output,
		@proc_matl_price	output,
		@status				output,
		@out_msg			output
	
	if @status > '0'
		return

--** 검사 관련 정보 (Sampling) **
	exec  SP_Common_Sampling_For_Inspect
		@item_no,
		@vendor,
		@gaijung,
		@proc_qty,
		@insp_select,
		@insp_mtd	output,
		@insp_level	output,
		@insp_range	output,
		@insp_advan	output,
		@sample_qty	output,
		@acpt_qty	output,
		@reject_qty	output,
		@status		output,
		@out_msg	output

	if @status > '0'
		return

	select @run_status = (case when @zr03_insp_qty_flag = 'Y' then '1' else '2' end)
	
	select @run_status = (case when @insp_select <> 'Y' or @insp_select = 'Y' and @insp_mtd = 'NO' then '3' else @run_status end)

	if @post_person in ('ZFRM','ZF01','ZFRJ','ZFRI')
		select @run_status='3'

			--- 20241227 일시반영  아주 MCM 처리
   --IF ( @vendor = '35024926'  AND   @curr_date_8 > '20241227'     )
   --BEGIN
   --   SELECT  @curr_date_8 = '20241227' 
   --END 	
-- 납품전표번호 생성
	select @code='2'+(case when @order_select = 'I' then 'I' else 'X' end) + right(@curr_date_8,6)
	exec master.dbo.sp_Numbering_output 'A09',@code,	@slip_no output

begin tran Common_Matl_Arrival

--**납품전표 생성      part_seq 없음????
	insert into EL_CD..T_VA_040
	select	junpyo_no=@slip_no,
			date_io=null,
			item_no=@item_no,
			gaijung=@gaijung,
			store=@zr03_to_store,
			supply=@order_select,
			prod_no=@project_no+@mfg_no,
			order_no=@opt_order_no,
			qty=0,
			qty_add=0,
			amut=0,
			trade_no=@vendor,
			wc_code='',
			post_person=@post_person,
			date_issue=getdate(),
			item_unit=@item_unit,
			io_select='',
			matr_amount = round(@proc_matl_price * @proc_qty,0),
			appl_mold_qty=0,
			run_status=@run_status,
			tr='',
			insp_select=@insp_select,
			insp_mtd=@insp_mtd,
			file_no='',
			qty_deliv=@proc_qty,
			qty_insp=(case when @run_status > '1' then @proc_qty else 0 end),
			qty_acpt=(case when @run_status > '2' then @proc_qty else 0 end),
			qty_special=0,
			qty_fail=0,
			price_won=(case when @money_unit = 'won' or @money_unit < '0' then @proc_price else 0 end),
			price_foreign=(case when @money_unit = 'won' or @money_unit < '0' then 0 else @proc_price end),
			amut_won=(case when @money_unit = 'won' or @money_unit < '0' then round(@proc_price*@proc_qty,0) else 0 end),
			amut_foreign=(case when @money_unit = 'won' or @money_unit < '0' then round(@proc_price*@proc_qty,0) else 0 end),
			money_unit=@money_unit,
			amut_mold=0,
			date_price=null,
			date_insp=(case when @run_status > '1' then getdate() else null end),
			date_modif=getdate(),
			gu_select='',
			red_jp_no='',
			red_code='',
			red_status='',
			special_rej_code='',
			factory_gubun='',
			part=@part,
			creator=@user_id

	if  @@rowcount = 0
	begin
		rollback tran Common_Matl_Arrival
		select @status='1',@out_msg='납품전표 Insert Error (' + @slip_no + ') ???'
		return
	end



	if @insp_select = 'Y' and @insp_mtd = 'SA'
	begin
		insert into mrp..T_MVA_040_inspection
		select	junpyo_no=@slip_no,
				lot_flag='',
				date_decision=(case when @run_status > '1' then getdate() else null end),
				fail_code_1='',
				fail_code_2='',
				fail_code_3='',
				fail_reason='',
				vendor_grade='',
				qty_sample=(case when @insp_mtd = 'sa' then @sample_qty else 0 end),
				sample_fail=@reject_qty,
				acpt=0,
				rjt=0,
				insp_level=@insp_level,
				sample_times=1,
				range_cur=@insp_range,
				range_result='',
				test_append='',
				grade_append='',
				INSP_EMP_ID=''

		if  @@rowcount = 0
		begin
			rollback tran Common_Matl_Arrival
			select @status='1',@out_msg='납품검사전표 Insert Error (' + @slip_no + ') ???'
			return
		end
	end

--주문정보 Update

	update a set
		qty_deliv = a.qty_deliv + @proc_qty,
		qty_insp = a.qty_insp + (case when @run_status > '1' then @proc_qty else 0 end),
--		qty_queue = a.qty_queue + (case when @run_status = '2' then @proc_qty else 0 end),
		qty_acpt = a.qty_acpt + (case when @run_status > '2' then @proc_qty else 0 end),
		date_deliv = getdate(),
		date_last = getdate(),
		date_delay=(case when convert(char(08),date_due,112) = @curr_date_8 
				then '0' else (case when date_due > @curr_date_8 then '2' else '1' end)end)
	from EL_CD..T_VA_020 a
	where order_no=@opt_order_no

	if @ship_flag = 'Y'
	begin
		select @run_status=(case when @run_status = '3' then 'E' else 'C' end)

		exec	SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				@run_status,		
				0,
				'',		--@opt_date_io_8,
				@temp_qty	output
	end

	select @status='0',@out_msg='Arrial OK ...'

	commit tran Common_Matl_Arrival;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Input                                                                              */
/*  DISCRIPTION  :  자재입고 처리  Common SP                                                                         */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_Matl_Input]
	@slip_no		varchar(13),
	@opt_date_io_8	char(08),
	@store			varchar(06),
	@user_id		varchar(10),
	@amut			float			output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output,
	@receipt_method_flag	char(01)='L'
AS
SET NOCOUNT ON
/*

declare	@amut		float		,
	@status		char(01)		,
	@out_msg	varchar(100)	

exec SP_Common_Matl_Input '2X09102403220','20100324','',@amut output,@status output,@out_msg output

*/

	declare	@curr_date_8			char(08),
			@proc_date_io_datetime	datetime,
			@proc_date_io_8			char(08),
			@proc_matl_price		float

	select @curr_date_8 = convert(char(08),getdate(),112)

	if @opt_date_io_8 < '0'
		select @opt_date_io_8=@curr_date_8

	else if @opt_date_io_8 > @curr_date_8
	begin
		select @status='1',@out_msg='입고일자가 현재일자보다 큽니다???'
		return
	end

	if  @opt_date_io_8 = @curr_date_8
		select @proc_date_io_datetime = getdate()
	else
		select @proc_date_io_datetime = convert(datetime,@opt_date_io_8)
		

	declare	@ze01_qty		float,
			@order_select	char(01),
			@item_no		varchar(15),		--* 지정하면 지정한 품목으로 출고 : 대치출고시 사용 ***
			@io_date		varchar(08),
			@date_apply		varchar(08),
			@run_status		char(01),
			@va040_gaijung	varchar(04),
			@item_no_p		varchar(15),
			@speacfic		varchar(01),
			@out_use		char(01),
			@order_no		varchar(08)

	declare	@project_no			varchar(11),
			@mfg_no				varchar(03),
			@part				varchar(02),
			@part_seq			varchar(04),
			@va020_ship_flag	char(01),
			@post_person		char(02),
			@product_code		varchar(03),
			@money_unit			varchar(03),
			@code				char(08),
			@vendor				varchar(08),
			@va020_qty_order	float,
			@va040_qty_deliv	float,
			@va040_qty_acpt		float,
			@va020_qty_cancel	float,
			@va020_qty_reject	float,
			@va020_price		float,
			@proc_qty			float,
			@proc_price			float,
			@result_amt			float,
			@price				float,
			@loop_cnt			int,
			@date_print_po		varchar(08),
			@due_date			varchar(08),
			@date_start			varchar(08),
			@insp_select		char(01),
			@insp_mtd			char(02),
			@insp_level			char(02),
			@insp_range			char(02),
			@va020_po_status	char(01),
			@va020_run_status	char(01),
			@test_append		char(01),
			@grade_append		char(01),
			@pay_con			varchar(04),
			@insp_advan			char(01),
			@va040_run_status	char(01),
			@va040_price		float,
			@po_gubun			char(01)


	if not exists (select * 
						from EL_CD..T_VA_040 
						where junpyo_no=@slip_no
						--and left(gaijung,2) = left(master.dbo.fGetGaijung(@user_id),2)  
						)
	begin
		select @status='1',@out_msg='납품전표가 없읍니다 ???'
		return
	end

	select	@va040_run_status = run_status,@order_no=order_no,@va040_qty_deliv=qty_deliv,
			@va040_qty_acpt=qty_acpt,
			@va040_gaijung=gaijung,@order_select=supply,@item_no=item_no,@vendor=trade_no,
			@project_no=left(prod_no,11),@mfg_no=substring(prod_no,12,3),@part=part,@money_unit=money_unit,
			@va040_price=price_won,
			@store=(case when @store < '0' then a.store  else @store end)
	from  EL_CD..T_VA_040  a
	where junpyo_no=@slip_no

	if @store < '0'
	begin
		select @store=isnull((select to_store
						from t_mzr_03
						where gaijung=@va040_gaijung
						and order_select = @order_select),'')
	end

	if @va040_run_status <> '3'
	begin
		select @status='1',@out_msg='입고처리할수 없는 전표입니다 ???'
		return
	end

	if @va040_qty_acpt= 0
	begin
		select @status='1',@out_msg=' 입고처리할 수량이 없읍니다 ???'
		return
	end

	if not exists (select * from EL_CD..T_VA_020 where order_no=@order_no)
	begin
		select @status='1',@out_msg='주문서가 없읍니다 ???'
		return
	end

	select 	@date_print_po=convert(char(08),date_print_po,112),
			@date_start=convert(char(08),date_start,112),
			@va020_qty_order=qty_order,@va020_qty_cancel=qty_cancel,@va020_qty_reject=qty_reject,
			@due_date=convert(char(08),date_due,112),
			@price=price,@va020_ship_flag=ship_flag,
			@post_person=post_person,@va020_po_status=po_status,@va020_run_status=run_status,
			@pay_con=pay_con,@part_seq=part_seq,
			@po_gubun=po_gubun,
			@va020_price=price
	from EL_CD..T_VA_020 a
	where order_no=@order_no

--** 납품관련정보 ***
	

-- 납품단가 Fetch
	declare	@entry_price	float
	select	@proc_matl_price=0,@entry_price=0

	if @va040_price = 0
	begin
		exec SP_Common_Input_Price_Search
			@va040_gaijung,
			@order_select,
			@item_no,
			@vendor,
			@entry_price,
			@va040_price,
			@money_unit,
			@date_print_po,
			@due_date,
			@date_start,
			@va040_price		output,
			@proc_matl_price	output,
			@status				output,
			@out_msg			output
		
		if @status > '0'
			return
	end

--** JJG 아래 로직 추가 2011-12-21 start 
	if @order_select in ('X','Z')
	begin
		declare @CX610_price float

		exec SP_Common_Input_Price_Search
			@va040_gaijung,
			@order_select,
			@item_no,
			@vendor,
			@entry_price,
			@va040_price,
			@money_unit,
			@date_print_po,
			@due_date,
			@date_start,
			@CX610_price		output,
			@proc_matl_price	output,
			@status				output,
			@out_msg			output
		
		if @status > '0'
			return			
	end
--** JJG 위 로직 추가 2011-12-21 end 

	if @po_gubun = '2' or @order_select not in ('X','Z')
		select @proc_matl_price=0

--** 금형비 계산
	
	declare	@mold_price		float,
			@amut_mold		float,
			@qty_mold_apply	float

	select @mold_price=0,@qty_mold_apply=0,@amut_mold=0

	if @order_select not in ('I')
	begin
		exec SP_Common_Mold_Compute_and_Base_Update '1',
			@item_no,@vendor,@va040_qty_acpt,@mold_price output,@qty_mold_apply output

		select @amut_mold=round(@mold_price*@qty_mold_apply,0)
	end

begin tran Common_Matl_Input

--납품전표마스터 Update
	
	declare	@amt		float,
			@matr_amt	float,
			@amut_won	float

	select	@amut_won=round(@va040_price*@va040_qty_acpt,0)

	select	@amt=@amut_won + @amut_mold,
			@matr_amt=@proc_matl_price * @va040_qty_acpt

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
		@item_no,
		@va040_gaijung,
		@store,
		@order_select,
		'A',	/* A:입고 B:출고 **/
	 	@opt_date_io_8,
		@va040_qty_acpt,
		@amt,
		@matr_amt,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran Common_Matl_Input
		return
	end

	select @mold_price=0,@qty_mold_apply=0,@amut_mold=0

	if @order_select not in ('I')
	begin
		exec SP_Common_Mold_Compute_and_Base_Update '2',
			@item_no,@vendor,@va040_qty_acpt,@mold_price output,@qty_mold_apply output

		select @amut_mold=round(@mold_price*@qty_mold_apply,0)
	end

--주문마스터 Update
	update a set
		qty_input=a.qty_input+@va040_qty_acpt,
		run_status=(case when a.qty_order - a.qty_cancel - a.qty_input = @va040_qty_acpt
					then '5' else a.run_status end),
		date_last=getdate()
	from EL_CD..T_VA_020 a
	where order_no=@order_no

--전표 Update
	update a set
		qty=@va040_qty_acpt,
		io_select='1',
		date_io=@proc_date_io_datetime,
		run_status=(case when @amt <> 0 and (supply not in ('X','Z') or @matr_amt <> 0 or @po_gubun = '2' )
--			then '5' else  '4' end),
			then '5' else  '5' end),
		date_modif=getdate(),
		amut_won=@amut_won,
		amut=@amt,
		matr_amount = @matr_amt,
		appl_mold_qty=@qty_mold_apply,
		amut_mold=@amut_mold
	from EL_CD..T_VA_040 a
	where junpyo_no=@slip_no
	
	update a set
		input_flag = 'Y',
		input_date = getdate(),
		step = 9,
		jp_no = @slip_no
	from el_cd..T_VJ_310 a
	where order_no = @order_no
	and (input_flag is null or input_flag <> 'Y')
					
--입고금액 집계 Update

	update a set	
		amut_won = a.amut_won +(case when @order_select <> 'i' then @amut_won else 0.0 end),
		amut_mold = a.amut_mold +@amut_mold,
		amut_import = a.amut_import + (case when @order_select = 'i' then @amut_won else 0.0 end)
	from EL_CD..t_va_010 a with (index=PK___1__40)
	where trade_no = @vendor
	  and in_date = @opt_date_io_8
	  and gaijung = @va040_gaijung

	if @@rowcount = 0
	begin	
		insert EL_CD..t_va_010
		select @vendor,@opt_date_io_8,@va040_gaijung, 
				amut_won=(case when @order_select <> 'i' then @amut_won else 0.0 end),
				0,
				@amut_mold,
				0,0,0,0,0,
				amut_import=(case when @order_select = 'i' then @amut_won else 0.0 end)
	end


--*  발송품이면 입고동시 부품창고에서 출고 
	declare	@issue_slip_no	varchar(13)

--	if @va040_gaijung not in ('SYHP') and (@va020_ship_flag = 'Y' or @po_gubun = '2')
	if @va040_gaijung not in ('SYHP') and @po_gubun <> '7' and (@va020_ship_flag = 'Y' or @po_gubun = '2')
	begin
		if @va020_ship_flag = 'Y'
		begin
--제통(수불대장) Update
			exec SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				@receipt_method_flag,		--@run_status
				@va040_qty_acpt,
				@opt_date_io_8,
				@va040_qty_acpt	output

			if @va040_qty_acpt <= 0	--제통에 입고수량이 있으면 아래 출고 처리 안함
			begin
				commit tran Common_Matl_Input
				select @status='0',@out_msg='Matl_Input OK ...'
				return
			end
		end

--입출고동시의 출고처리
---1.재고 & 월수불 Update(출고)

		exec SP_Common_Stock_Update
			@item_no,
			@va040_gaijung,
			@store,
			@order_select,
			'B',	/* A:입고 B:출고 **/
		 	@opt_date_io_8,
			@va040_qty_acpt,
			0,
			0,
			@result_amt	output,
			@status 		output,
			@out_msg	output

		if @status > '0'
		begin
			rollback tran Common_Matl_Input
			return
		end
	
		select @code='G1'+ right(@curr_date_8,6)
		exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output

--2.출고전표 생성
		insert into t_mva_041
		select	jp_no=@issue_slip_no,
				date_io=@proc_date_io_datetime,
				gaijung=@va040_gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp='',
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				qty=@va040_qty_acpt,
				amt=@result_amt,
				order_no=@order_no,
				vendor='',
				work_center='',
				out_use=(case  left(@mfg_no,1) 
					when 'B' then 'E'
					when 'J' then 'L'
					when 'K' then 'C'
					when 'N' then 'B'
					--when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '' end)
					else '' end),
				item_group_sub='',
				scrap_qty=0,
				creator=@user_id

		if  @@rowcount = 0
		begin
			rollback tran Common_Matl_Input
			select @status='1',@out_msg='출고전표 Insert Error (' + @slip_no + ') ???'
			return
		end
	end

	select @status='0',@out_msg='Matl_Input OK ...'

	commit tran Common_Matl_Input;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Input_Import_AUTO                                                                                                                                                    */
/*  DISCRIPTION  : 도입품 수동/자동 입고 처리  Common SP                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/11     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/
--
CREATE PROCEDURE  [dbo].[SP_Common_Matl_Input_Import_AUTO]
	@item_no		varchar(15),		
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	char(01),
	@input_date		varchar(08),
	@input_qty		float,
	@amt_won		float,
	@currency		varchar(03),
	@amt_foreign	float,
	@vendor			varchar(08),
	@prod_no		varchar(14),
	@part			varchar(02),
	@file_no		varchar(20),
	@order_no		varchar(08),
	@user_id		varchar(08),
	@junpyo_no		varchar(13)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS

	select @status='0',@out_msg= (case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	declare	@matr_amt		float,
			@result_amt		float,
			@curr_date		char(08),
			@va020_item_no	varchar(15),
			@ship_flag		char(01),
			@po_gubun		char(01),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part_seq		varchar(04),
			@skp			char(01)

	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@order_select=upper(@order_select)

	--if left(@gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	--begin
	--	select @status='1',@out_msg=' 담당사업부가 아닙니다 ???'
	--	return
	--end

	select	@ship_flag='',@po_gubun='',@project_no='',@mfg_no='',@part='',@part_seq='',@skp=''

	select @curr_date=convert(char(08),getdate(),112)

	if not exists (select * from el_cd..t_cx_060 where item_no = @item_no)
	begin
		select @status='1',@out_msg=@item_no + '  Item No Error ???'
		return
	end

	if @input_date < '0'
		select @input_date=@curr_date
	else if isdate(@input_date)=0
	begin
		select @status='1',@out_msg=@item_no + ' 입고일자 Error ???'
		return
	end

	if @input_qty = 0
	begin
		select @status='1',@out_msg=@item_no + ' 입고수량 Zero, Error ???'
		return
	end

	if @amt_won=0
	begin
		select @status='1',@out_msg=@item_no + ' 원화금액 Zero, Error ???'
		return
	end


	if @amt_foreign = 0 and @order_select = 'I'
	begin
		select @status='1',@out_msg=@item_no + ' 외화금액 zero ,Error ????'
		return
	end

	if 	@input_qty > 0 and (@amt_won < 0 or @amt_foreign < 0) or
		@input_qty < 0 and (@amt_won > 0 or @amt_foreign > 0) 
	begin
		select @status='1',@out_msg=@item_no + ' 수량과 금액의 Sign 불일치 ???'
		return
	end

-- 차수에 대한 필드 확보 여부를 결정해야 ??????

	declare	@run_status	char(01),
			@qty_remain	float

	if @order_no > '0' 
	begin
		if not exists (select * from el_cd..T_VA_020 where order_no = @order_no)
		begin
			select @status='1',@out_msg=@order_no + ' 주문마스터가 미존재 ???'
			return
		end

		select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				@va020_item_no=item_no,@vendor=trade_no,
				@ship_flag=ship_flag,@po_gubun=po_gubun,
				@prod_no=prod_no,
				@part=part,@part_seq=part_seq,@gaijung=gaijung,@skp=skp
		from EL_CD..T_VA_020 a
		where a.order_no=@order_no

		if @run_status not in ('3','4')
		begin
			select @status='1',@out_msg=@order_no + '  주문상태(3,4)에서만 입고 가능 ???'
			return
		end

		if @qty_remain = 0
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 없읍니다 ???'
			return
		end

		if @qty_remain < @input_qty
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 모자랍니다 ???'
			return
		end

		if @va020_item_no <> @item_no
		begin
			select @status='1',@out_msg=@order_no + ' 주문Item vs 처리 Item 불일치 ???'
			return
		end
	end


	select	@project_no=left(@prod_no,11),@mfg_no=substring(@prod_no,12,3)

	if @vendor < '0' or not exists (select * from el_cd..t_cx_080 where trade_no = @vendor)
	begin
		select @status='1',@out_msg= @item_no +' / ' + @order_no + ' / '  + @vendor + ' 거래처코드 Error ???'
		return
	end


	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@currency=upper(@currency),
			@vendor	=upper(@vendor),
			@prod_no=upper(@prod_no),
			@part=upper(@part),
			@file_no=upper(@file_no),
			@order_no=upper(@order_no)

begin tran Common_Matl_Input_Import_AUTO
--재고 & 월수불 Update

	exec SP_Common_Stock_Update
		@item_no,
		@gaijung,
		@store,
		@order_select,
		'A',	--* A:입고 B:출고 **
	 	@input_date,
		@input_qty,
		@amt_won,
		0,
		@result_amt	output,
		@status 	output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		return
	end

--order No Numbering
	declare	@initial	varchar(08)

--
		--- 20241227 일시반영  아주 MCM 처리
   --IF ( @vendor = '35024926'  AND   @curr_date > '20241227'     )
   --BEGIN
   --   SELECT  @curr_date = '20241227' 
   --END 
-- 납품전표번호 생성

	select @initial='2'+(case when @order_select = 'I' then 'I' else 'X' end) + right(@curr_date,6)
	exec master.dbo.sp_Numbering_output 'A09',@Initial,@junpyo_no output


--입고전표 생성
	insert into EL_CD..T_VA_040
	select	junpyo_no=@junpyo_no,
	       -- date_io= ( CASE WHEN @vendor = '35024926' AND   @curr_date > '20241227' 
			     --            THEN  '2024-12-27 15:15:00'  
							 --ELSE  (case when @input_date=@curr_date then getdate() else @input_date end) END ),
			date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
			item_no=@item_no,
			gaijung=@gaijung,
			store=@store,
			supply=@order_select,
			prod_no=@prod_no,
			order_no=@order_no,
			qty=@input_qty,
			qty_add=0,
			amut=@amt_won,
			trade_no=@vendor,
			wc_code='',
			post_person='',
			date_issue=getdate(),
			item_unit=a.item_unit,
			io_select='1',
			MATR_AMOUNT=0,
			APPL_MOLD_QTY=0,
			run_status='5',
			TR='',
			INSP_SELECT='N',
			INSP_MTD='',
			FILE_NO=@file_no,
			QTY_DELIV=@input_qty,
			QTY_INSP=@input_qty,
			QTY_ACPT=@input_qty,
			QTY_SPECIAL=0,
			QTY_FAIL=0,
			PRICE_WON=@amt_won/@input_qty,
			PRICE_FOREIGN=@amt_foreign/@input_qty,
			AMUT_WON=@amt_won,
			AMUT_FOREIGN=@amt_foreign,
			MONEY_UNIT=@currency,
			AMUT_MOLD=0,
			DATE_PRICE=getdate(),
			DATE_INSP=getdate(),
			DATE_MODIF=getdate(),
			GU_SELECT='',
			RED_JP_NO='',
			RED_CODE='',
			RED_@status='',
			SPECIAL_REJ_CODE='',
			FACTORY_GUBUN='',
			PART=@part,
			creator=@user_id
	from EL_CD..t_cx_060 a
	where a.item_no=@item_no
	
	if  @@rowcount = 0
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		select @status='1',@out_msg='납품전표 Insert Error (' + @junpyo_no + ') ???'
		return
	end


--주문마스터 Update
	if @order_no > '0'
	begin
		update a set
			qty_deliv=a.qty_deliv + @input_qty,
			qty_insp=a.qty_insp + @input_qty,
			qty_acpt=a.qty_acpt + @input_qty,
			qty_input=a.qty_input + @input_qty,
			run_status = (case when a.qty_order - a.qty_cancel - a.qty_input = @input_qty
					 then '5' else a.run_status end)
		from EL_CD..t_va_020 a
		where a.order_no=@order_no
	end

--*  발송품이면 입고동시 부품창고에서 출고 
	declare	@issue_slip_no	varchar(13),
			@out_qty		float,
			@code			varchar(10)

--	if @ship_flag = 'Y' or @po_gubun = '2'
	if @po_gubun <> '7' and (@ship_flag = 'Y' or @po_gubun = '2')
	begin
		if @ship_flag = 'Y'
		begin
--제통(수불대장) Update
			exec SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				'N',		--@run_status
				@input_qty,
				@input_date,
				@out_qty	output

			if @out_qty <= 0	--제통에 입고수량이 있으면 아래 출고 처리 안함
			begin
				commit tran Common_Matl_Input_Import_AUTO
				return
			end
		end

--입출고동시의 출고처리
---1.재고 & 월수불 Update(출고)

		exec SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@order_select,
			'B',	/* A:입고 B:출고 **/
		 	@input_date,
			@out_qty,
			0,
			0,
			@result_amt	output,
			@status 		output,
			@out_msg	output

		if @status > '0'
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			return
		end	

		select @code='GT'+ right(@input_date,6)
		exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output

--2.출고전표 생성
		insert into t_mva_041
		select	jp_no=@issue_slip_no,
				date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
				gaijung=@gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp=@skp,
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				qty=@out_qty,
				amt=@result_amt,
				order_no=@order_no,
				vendor='',
				work_center='',
				out_use=(case  left(@mfg_no,1) 
					when 'B' then 'E'
					when 'J' then 'L'
					when 'K' then 'C'
					when 'N' then 'B'
					--when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '' end)
					else '' end),
				item_group_sub='',
				scrap_qty=0,
				creator=@user_id
		if  @@rowcount = 0
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			select @status='1',@out_msg='출고전표 Insert Error (' + @issue_slip_no + ') ???'
			return
		end

	end

	select @status='0',@out_msg=(case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	commit tran Common_Matl_Input_Import_AUTO;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_Common_Matl_Input_Manual]                                                                                                                                                    */
/*  DISCRIPTION  : 수동 입고 처리  Common SP                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/11     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/
CREATE PROCEDURE  [dbo].[SP_Common_Matl_Input_Manual]
	@item_no		varchar(15),		
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	char(01),
	@input_date		varchar(08),
	@input_qty		float,
	@amt_won		float,
	@currency		varchar(03),
	@amt_foreign	float,
	@vendor			varchar(08),
	@prod_no		varchar(14),
	@part			varchar(02),
	@file_no		varchar(20),
	@order_no		varchar(08),
	@user_id		varchar(08),
	@junpyo_no		varchar(13)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS

	if left(@gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	begin
		select @status='1',@out_msg=' 담당사업부가 아닙니다 ???'
		return
	end
	
	select @status='0',@out_msg= (case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	declare	@matr_amt		float,
			@result_amt		float,
			@curr_date		char(08),
			@va020_item_no	varchar(15),
			@ship_flag		char(01),
			@po_gubun		char(01),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part_seq		varchar(04),
			@skp			char(01)

	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@order_select=upper(@order_select)


	select	@ship_flag='',@po_gubun='',@project_no='',@mfg_no='',@part='',@part_seq='',@skp=''

	select @curr_date=convert(char(08),getdate(),112)

	if not exists (select * from el_cd..t_cx_060 where item_no = @item_no)
	begin
		select @status='1',@out_msg=@item_no + '  Item No Error ???'
		return
	end

	if @input_date < '0'
		select @input_date=@curr_date
	else if isdate(@input_date)=0
	begin
		select @status='1',@out_msg=@item_no + ' 입고일자 Error ???'
		return
	end

	if @input_qty = 0
	begin
		select @status='1',@out_msg=@item_no + ' 입고수량 Zero, Error ???'
		return
	end

	if @amt_won=0
	begin
		select @status='1',@out_msg=@item_no + ' 원화금액 Zero, Error ???'
		return
	end

/* jjg 강창길C 요청: 미착잔액 정리시 원화금액으로만 정리하므로 아래 체크 없앰.
	if @amt_foreign = 0 and @order_select = 'I'
	begin
		select @status='1',@out_msg=@item_no + ' 외화금액 zero ,Error ????'
		return
	end
*/

	if 	@input_qty > 0 and (@amt_won < 0 or @amt_foreign < 0) or
		@input_qty < 0 and (@amt_won > 0 or @amt_foreign > 0) 
	begin
		select @status='1',@out_msg=@item_no + ' 수량과 금액의 Sign 불일치 ???'
		return
	end


-- 차수에 대한 필드 확보 여부를 결정해야 ??????


	declare	@run_status	char(01),
		@qty_remain	float

	if @order_no > '0' 
	begin
		if not exists (select * from el_cd..T_VA_020 where order_no = @order_no)
		begin
			select @status='1',@out_msg=@order_no + ' 주문마스터가 미존재 ???'
			return
		end

		select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				@va020_item_no=item_no,@vendor=trade_no,
				@ship_flag=ship_flag,@po_gubun=po_gubun,
				@prod_no=prod_no,
				@part=part,@part_seq=part_seq,@gaijung=gaijung,@skp=skp
		from EL_CD..T_VA_020 a
		where a.order_no=@order_no

		if @run_status not in ('3','4')
		begin
			select @status='1',@out_msg=@order_no + '  주문상태(3,4)에서만 입고 가능 ???'
			return
		end

		if @qty_remain = 0
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 없읍니다 ???'
			return
		end

		if @qty_remain < @input_qty
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 모자랍니다 ???'
			return
		end

		if @va020_item_no <> @item_no
		begin
			select @status='1',@out_msg=@order_no + ' 주문Item vs 처리 Item 불일치 ???'
			return
		end

	end


	select	@project_no=left(@prod_no,11),@mfg_no=substring(@prod_no,12,3)

	if @vendor < '0' or not exists (select * from el_cd..t_cx_080 where trade_no = @vendor)
	begin
		select @status='1',@out_msg=@vendor + ' 거래처코드 Error ???'
		return
	end


	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@currency=upper(@currency),
			@vendor	=upper(@vendor),
			@prod_no=upper(@prod_no),
			@part=upper(@part),
			@file_no=upper(@file_no),
			@order_no=upper(@order_no)


begin tran Common_Matl_Input_Import_AUTO
--재고 & 월수불 Update

	exec SP_Common_Stock_Update
		@item_no,
		@gaijung,
		@store,
		@order_select,
		'A',	--* A:입고 B:출고 **
	 	@input_date,
		@input_qty,
		@amt_won,
		0,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		return
	end

--order No Numbering
	declare	@initial	varchar(08)

--
-- 20241227 일시반영  아주 MCM 처리
   --IF ( @vendor = '35024926'  AND   @curr_date > '20241227'     )
   --BEGIN
   --   SELECT  @curr_date = '20241227' 
   --END 

-- 납품전표번호 생성

	select @initial='2'+(case when @order_select = 'I' then 'I' else 'X' end) + right(@curr_date,6)
	exec sp_Numbering_output 'A09',@Initial,@junpyo_no output


--입고전표 생성
	insert into EL_CD..T_VA_040
	select	junpyo_no=@junpyo_no,
			--date_io= ( CASE WHEN @vendor = '35024926' AND   @input_date > '20241227' 
			--                 THEN  '2024-12-27 15:15:00'  
			--				 ELSE  (case when @input_date=@curr_date then getdate() else @input_date end) END ),
			date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
			item_no=@item_no,
			gaijung=@gaijung,
			store=@store,
			supply=@order_select,
			prod_no=@prod_no,
			order_no=@order_no,
			qty=@input_qty,
			qty_add=0,
			amut=@amt_won,
			trade_no=@vendor,
			wc_code='',
			post_person='',
			date_issue=getdate(),
			item_unit=a.item_unit,
			io_select='1',
			MATR_AMOUNT=0,
			APPL_MOLD_QTY=0,
			run_status='5',
			TR='',
			INSP_SELECT='N',
			INSP_MTD='',
			FILE_NO=@file_no,
			QTY_DELIV=@input_qty,
			QTY_INSP=@input_qty,
			QTY_ACPT=@input_qty,
			QTY_SPECIAL=0,
			QTY_FAIL=0,
			PRICE_WON=@amt_won/@input_qty,
			PRICE_FOREIGN=@amt_foreign/@input_qty,
			AMUT_WON=@amt_won,
			AMUT_FOREIGN=@amt_foreign,
			MONEY_UNIT=@currency,
			AMUT_MOLD=0,
			DATE_PRICE=getdate(),
			DATE_INSP=getdate(),
			DATE_MODIF=getdate(),
			GU_SELECT='',
			RED_JP_NO='',
			RED_CODE='',
			RED_@status='',
			SPECIAL_REJ_CODE='',
			FACTORY_GUBUN='',
			PART=@part,
			creator=@user_id
	from EL_CD..t_cx_060 a
	where a.item_no=@item_no
	
	if  @@rowcount = 0
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		select @status='1',@out_msg='납품전표 Insert Error (' + @junpyo_no + ') ???'
		return
	end


--주문마스터 Update
	if @order_no > '0'
	begin
		update a set
			qty_deliv=a.qty_deliv + @input_qty,
			qty_insp=a.qty_insp + @input_qty,
			qty_acpt=a.qty_acpt + @input_qty,
			qty_input=a.qty_input + @input_qty,
			run_status = (case when a.qty_order - a.qty_cancel - a.qty_input = @input_qty
					 then '5' else a.run_status end)
		from EL_CD..t_va_020 a
		where a.order_no=@order_no
	end

--*  발송품이면 입고동시 부품창고에서 출고 
	declare	@issue_slip_no	varchar(13),
			@out_qty		float,
			@code			varchar(10)

--	if @ship_flag = 'Y' or @po_gubun = '2'
	if @po_gubun <> '7' and  (@ship_flag = 'Y' or @po_gubun = '2')
	begin
		if @ship_flag = 'Y'
		begin
--제통(수불대장) Update
			exec SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				'N',		--@run_status
				@input_qty,
				@input_date,
				@out_qty	output

			if @out_qty <= 0	--제통에 입고수량이 있으면 아래 출고 처리 안함
			begin
				commit tran Common_Matl_Input_Import_AUTO
				return
			end
		end

--입출고동시의 출고처리
---1.재고 & 월수불 Update(출고)

		exec SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@order_select,
			'B',	/* A:입고 B:출고 **/
		 	@input_date,
			@out_qty,
			0,
			0,
			@result_amt	output,
			@status 	output,
			@out_msg	output

		if @status > '0'
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			return
		end	

		select @code='GT'+ right(@input_date,6)
		exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output

--2.출고전표 생성
		insert into t_mva_041
		select	jp_no=@issue_slip_no,
				date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
				gaijung=@gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp=@skp,
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				qty=@out_qty,
				amt=@result_amt,
				order_no=@order_no,
				vendor='',
				work_center='',
				out_use=(case  left(@mfg_no,1) 
					when 'B' then 'E'
					when 'J' then 'L'
					when 'K' then 'C'
					when 'N' then 'B'
					--when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '' end)
					else '' end),
				item_group_sub='',
				scrap_qty=0,
				creator=@user_id
		if  @@rowcount = 0
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			select @status='1',@out_msg='출고전표 Insert Error (' + @issue_slip_no + ') ???'
			return
		end

	end

	select @status='0',@out_msg=(case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	commit tran Common_Matl_Input_Import_AUTO;

/**************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Input_Manual_Gaijung_Change                                                 */
/*  DISCRIPTION  : 도입품 수동 입고 처리_계정대체용. (MRPCS의 F_CP_370에서만 사용함)                          */ 
/*               : SP_MRP_8AD_1_Gaijung_Change 에서만 CALL 함.                                                */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                S.E NAME         DESCRIPTION                                         */
/*  ---------------------------------------------------------------                                           */
/* 2021/03/02   META 계정 대체용         LGJJG            Initialize                                          */
/**************************************************************************************************************/
CREATE PROCEDURE  [dbo].[SP_Common_Matl_Input_Manual_Gaijung_Change]
	@item_no		varchar(15),		
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	char(01),
	@input_date		varchar(08),
	@input_qty		float,
	@amt_won		float,
	@currency		varchar(03),
	@amt_foreign	float,
	@vendor			varchar(08),
	@prod_no		varchar(14),
	@part			varchar(02),
	@file_no		varchar(20),
	@order_no		varchar(08),
	@user_id		varchar(08),
	@junpyo_no		varchar(13)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
-- grant exec on SP_Common_Matl_Input_Manual_Gaijung_Change to applications

/* 계정 대체에서는 막음.
	if left(@gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	begin
		select @status='1',@out_msg=' 담당사업부가 아닙니다 ???'
		return
	end
*/	
	select @status='0',@out_msg= (case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	declare	@matr_amt		float,
			@result_amt		float,
			@curr_date		char(08),
			@va020_item_no	varchar(15),
			@ship_flag		char(01),
			@po_gubun		char(01),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part_seq		varchar(04),
			@skp			char(01)

	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@order_select=upper(@order_select)


	select	@ship_flag='',@po_gubun='',@project_no='',@mfg_no='',@part='',@part_seq='',@skp=''

	select @curr_date=convert(char(08),getdate(),112)

	if not exists (select * from el_cd..t_cx_060 where item_no = @item_no)
	begin
		select @status='1',@out_msg=@item_no + '  Item No Error ???'
		return
	end

	if @input_date < '0'
		select @input_date=@curr_date
	else if isdate(@input_date)=0
	begin
		select @status='1',@out_msg=@item_no + ' 입고일자 Error ???'
		return
	end

	if @input_qty = 0
	begin
		select @status='1',@out_msg=@item_no + ' 입고수량 Zero, Error ???'
		return
	end

	if @amt_won=0
	begin
		select @status='1',@out_msg=@item_no + ' 원화금액 Zero, Error ???'
		return
	end

/* jjg 강창길C 요청: 미착잔액 정리시 원화금액으로만 정리하므로 아래 체크 없앰.
	if @amt_foreign = 0 and @order_select = 'I'
	begin
		select @status='1',@out_msg=@item_no + ' 외화금액 zero ,Error ????'
		return
	end
*/

	if 	@input_qty > 0 and (@amt_won < 0 or @amt_foreign < 0) or
		@input_qty < 0 and (@amt_won > 0 or @amt_foreign > 0) 
	begin
		select @status='1',@out_msg=@item_no + ' 수량과 금액의 Sign 불일치 ???'
		return
	end


-- 차수에 대한 필드 확보 여부를 결정해야 ??????


	declare	@run_status	char(01),
		@qty_remain	float

	if @order_no > '0' 
	begin
		if not exists (select * from el_cd..T_VA_020 where order_no = @order_no)
		begin
			select @status='1',@out_msg=@order_no + ' 주문마스터가 미존재 ???'
			return
		end

		select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				@va020_item_no=item_no,@vendor=trade_no,
				@ship_flag=ship_flag,@po_gubun=po_gubun,
				@prod_no=prod_no,
				@part=part,@part_seq=part_seq,@gaijung=gaijung,@skp=skp
		from EL_CD..T_VA_020 a
		where a.order_no=@order_no

		if @run_status not in ('3','4')
		begin
			select @status='1',@out_msg=@order_no + '  주문상태(3,4)에서만 입고 가능 ???'
			return
		end

		if @qty_remain = 0
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 없읍니다 ???'
			return
		end

		if @qty_remain < @input_qty
		begin
			select @status='1',@out_msg=@order_no + ' 주문잔량이 모자랍니다 ???'
			return
		end

		if @va020_item_no <> @item_no
		begin
			select @status='1',@out_msg=@order_no + ' 주문Item vs 처리 Item 불일치 ???'
			return
		end

	end


	select	@project_no=left(@prod_no,11),@mfg_no=substring(@prod_no,12,3)

	if @vendor < '0' or not exists (select * from el_cd..t_cx_080 where trade_no = @vendor)
	begin
		select @status='1',@out_msg=@vendor + ' 거래처코드 Error ???'
		return
	end


	select	@item_no=upper(@item_no),
			@gaijung=upper(@gaijung),
			@store=upper(@store),
			@currency=upper(@currency),
			@vendor	=upper(@vendor),
			@prod_no=upper(@prod_no),
			@part=upper(@part),
			@file_no=upper(@file_no),
			@order_no=upper(@order_no)


begin tran Common_Matl_Input_Import_AUTO
--재고 & 월수불 Update

	exec SP_Common_Stock_Update
		@item_no,
		@gaijung,
		@store,
		@order_select,
		'A',	--* A:입고 B:출고 **
	 	@input_date,
		@input_qty,
		@amt_won,
		0,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		return
	end

--order No Numbering
	declare	@initial	varchar(08)

--
	-- 20241227 일시반영  아주 MCM 처리
   --IF ( @vendor = '35024926'  AND   @curr_date > '20241227'     )
   --BEGIN
   --   SELECT  @curr_date = '20241227' 
   --END 
-- 납품전표번호 생성

	select @initial='2'+(case when @order_select = 'I' then 'I' else 'X' end) + right(@curr_date,6)
	exec sp_Numbering_output 'A09',@Initial,@junpyo_no output


--입고전표 생성
	insert into EL_CD..T_VA_040
	select	junpyo_no=@junpyo_no,
	       -- date_io= ( CASE WHEN @vendor = '35024926' AND   @input_date > '20241227' 
			     --            THEN  '2024-12-27 15:15:00'  
							 --ELSE  (case when @input_date=@curr_date then getdate() else @input_date end) END ),
			date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
			item_no=@item_no,
			gaijung=@gaijung,
			store=@store,
			supply=@order_select,
			prod_no=@prod_no,
			order_no=@order_no,
			qty=@input_qty,
			qty_add=0,
			amut=@amt_won,
			trade_no=@vendor,
			wc_code='',
			post_person='',
			date_issue=getdate(),
			item_unit=a.item_unit,
			io_select='1',
			MATR_AMOUNT=0,
			APPL_MOLD_QTY=0,
			run_status='5',
			TR='',
			INSP_SELECT='N',
			INSP_MTD='',
			FILE_NO=@file_no,
			QTY_DELIV=@input_qty,
			QTY_INSP=@input_qty,
			QTY_ACPT=@input_qty,
			QTY_SPECIAL=0,
			QTY_FAIL=0,
			PRICE_WON=@amt_won/@input_qty,
			PRICE_FOREIGN=@amt_foreign/@input_qty,
			AMUT_WON=@amt_won,
			AMUT_FOREIGN=@amt_foreign,
			MONEY_UNIT=@currency,
			AMUT_MOLD=0,
			DATE_PRICE=getdate(),
			DATE_INSP=getdate(),
			DATE_MODIF=getdate(),
			GU_SELECT='',
			RED_JP_NO='',
			RED_CODE='',
			RED_@status='',
			SPECIAL_REJ_CODE='',
			FACTORY_GUBUN='',
			PART=@part,
			creator=@user_id
	from EL_CD..t_cx_060 a
	where a.item_no=@item_no
	
	if  @@rowcount = 0
	begin
		rollback tran Common_Matl_Input_Import_AUTO
		select @status='1',@out_msg='납품전표 Insert Error (' + @junpyo_no + ') ???'
		return
	end


--주문마스터 Update
	if @order_no > '0'
	begin
		update a set
			qty_deliv=a.qty_deliv + @input_qty,
			qty_insp=a.qty_insp + @input_qty,
			qty_acpt=a.qty_acpt + @input_qty,
			qty_input=a.qty_input + @input_qty,
			run_status = (case when a.qty_order - a.qty_cancel - a.qty_input = @input_qty
					 then '5' else a.run_status end)
		from EL_CD..t_va_020 a
		where a.order_no=@order_no
	end

--*  발송품이면 입고동시 부품창고에서 출고 
	declare	@issue_slip_no	varchar(13),
			@out_qty		float,
			@code			varchar(10)

--	if @ship_flag = 'Y' or @po_gubun = '2'
	if @po_gubun <> '7' and  (@ship_flag = 'Y' or @po_gubun = '2')
	begin
		if @ship_flag = 'Y'
		begin
--제통(수불대장) Update
			exec SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				'N',		--@run_status
				@input_qty,
				@input_date,
				@out_qty	output

			if @out_qty <= 0	--제통에 입고수량이 있으면 아래 출고 처리 안함
			begin
				commit tran Common_Matl_Input_Import_AUTO
				return
			end
		end

--입출고동시의 출고처리
---1.재고 & 월수불 Update(출고)

		exec SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@order_select,
			'B',	/* A:입고 B:출고 **/
		 	@input_date,
			@out_qty,
			0,
			0,
			@result_amt	output,
			@status 	output,
			@out_msg	output

		if @status > '0'
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			return
		end	

		select @code='GT'+ right(@input_date,6)
		exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output

--2.출고전표 생성
		insert into t_mva_041
		select	jp_no=@issue_slip_no,
				date_io=(case when @input_date=@curr_date then getdate() else @input_date end),
				gaijung=@gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp=@skp,
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				qty=@out_qty,
				amt=@result_amt,
				order_no=@order_no,
				vendor='',
				work_center='',
				out_use=(case  left(@mfg_no,1) 
					when 'B' then 'E'
					when 'J' then 'L'
					when 'K' then 'C'
					when 'N' then 'B'
					--when 'X' then (case when substring(@project_no,8,1) = 'C' then 'A' else '' end)
					else '' end),
				item_group_sub='',
				scrap_qty=0,
				creator=@user_id
		if  @@rowcount = 0
		begin
			rollback tran Common_Matl_Input_Import_AUTO
			select @status='1',@out_msg='출고전표 Insert Error (' + @issue_slip_no + ') ???'
			return
		end

	end

	select @status='0',@out_msg=(case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	commit tran Common_Matl_Input_Import_AUTO;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Inspection                                                                         */
/*  DISCRIPTION  :  검사결과처리 Common SP                                                                           */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_Matl_Inspection]
	@slip_no		varchar(13),
	@entry_fail_qty	float=0,		
	@entry_lot_flag	char(01),
  	@fail_code_1	varchar(03),
  	@fail_code_2	varchar(03),
  	@fail_code_3	varchar(03),
	@user_id		varchar(08),
	@acpt_qty		float			output,
	@reject_qty		float			output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
SET NOCOUNT ON

	declare	@ya14_price			float,
			@proc_matl_price	float,
			@ya14_date_apply	varchar(08)

	declare	@ze01_qty		float,
			@order_select	char(01),
			@item_no		varchar(15),		--* 지정하면 지정한 품목으로 출고 : 대치출고시 사용 ***
			@io_date		varchar(08),
			@date_apply		varchar(08),
			@run_status		char(01),
			@va040_gaijung	varchar(04),
			@item_no_p		varchar(15),
			@speacfic		varchar(01),
			@skp			char(01),
			@out_use		char(01),
			@order_no		varchar(08)

	declare	@project_no			varchar(11),
			@mfg_no				varchar(03),
			@part				varchar(02),
			@part_seq			varchar(04),
			@store				varchar(06),
			@va020_ship_flag	char(01),
			@post_person		char(02),
			@product_code		varchar(03),
			@money_unit			varchar(03),
			@code				char(08),
			@vendor				varchar(08),
			@va020_qty_order	float,
			@va040_qty_deliv	float,
			@va040_qty_insp		float,
			@va020_qty_cancel	float,
			@va020_qty_reject	float,
			@va020_price		float,
			@proc_price			float,
			@io_qty				float,
			@result_amt			float,
			@loop_cnt			int,
			@date_print_po		varchar(08),
			@due_date			varchar(08),
			@date_start			varchar(08),
			@insp_mtd			char(02),
			@insp_level			char(02),
			@va020_po_status	char(01),
			@va020_run_status	char(01),
			@qty_sample			float,
			@qty_sample_acpt	float,
			@qty_sample_rjt		float,
			@test_append		char(01),
			@grade_append		char(01),
			@pay_con			varchar(04),
			@insp_advan			char(01),
			@va040_run_status	char(01),
			@entry_price		float,
			@ship_flag			char(01)


	if not exists (select * from EL_CD..T_VA_040 where junpyo_no=@slip_no)
	begin
		select @status='1',@out_msg='납품전표가 없읍니다 ???'
		return
	end

	select	@va040_run_status = run_status,@order_no=order_no,@va040_qty_deliv=qty_deliv,@va040_qty_insp=qty_insp,
			@va040_gaijung=gaijung,@order_select=supply,@item_no=item_no,@vendor=trade_no,
			@project_no=left(prod_no,11),@mfg_no=substring(prod_no,12,3),@part=part,
			@money_unit=money_unit,
			@entry_price=PRICE_WON,@insp_mtd=insp_mtd
	from  EL_CD..T_VA_040 
	where junpyo_no=@slip_no

	--if left(@va040_gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	--begin
	--	select @status='1',@out_msg=' 담당사업부가 아닙니다 ???'
	--	return
	--end

	select	@qty_sample=qty_sample,
			@qty_sample_acpt=@qty_sample_acpt,
			@qty_sample_rjt=@qty_sample_rjt
	from  mrp..T_mVA_040_Inspection
	where junpyo_no=@slip_no


	if @va040_run_status <> '2'
	begin
		select @status='1',@out_msg='검사처리할수 없는 전표입니다 ???'
		return
	end

	if @va040_qty_deliv= 0 or  @va040_qty_insp = 0
	begin
		select @status='1',@out_msg=' 검사처리할 수량이 없읍니다 ???'
		return
	end


	if @insp_mtd = 'SA'
	begin
		if @entry_lot_flag in ('A','R') and @entry_fail_qty = 0
		begin
			if @entry_lot_flag = 'A'
				select @entry_fail_qty=0
			else
				select @entry_fail_qty=@qty_sample_rjt
		end
			
		if @qty_sample < @entry_fail_qty
		begin
			select @status='1',@out_msg=' Sample 수량을 초과할수 없읍니다 ???'
			return
		end 
	end
	else   -- 'AL'
	begin
		if @entry_lot_flag in ('A','R') and @entry_fail_qty = 0
		begin
			if @entry_lot_flag = 'A'
				select @entry_fail_qty=0
			else
				select @entry_fail_qty=@va040_qty_insp
		end

		if @va040_qty_insp < @entry_fail_qty
		begin
			select @status='1',@out_msg=' 검사대상 수량을 초과할수 없읍니다 ???'
			return
		end 
	end

	
	select 	@date_print_po=convert(char(08),date_print_po,112),
			@date_start=convert(char(08),date_start,112),
			@va020_qty_order=qty_order,@va020_qty_cancel=qty_cancel,@va020_qty_reject=qty_reject,
			@due_date=convert(char(08),date_due,112),
			@va020_ship_flag=ship_flag,
			@post_person=post_person,@va020_po_status=po_status,@va020_run_status=run_status,
			@ship_flag=ship_flag,@part_seq=part_seq,
			@va020_price=price
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	if @va020_po_status in ('4','5') or @va020_run_status <> '4'
	begin
		select @status='1',@out_msg='검사 불가한 납품번호입니다  확인바람????'
		return
	end

	exec SP_Common_Inspection_Decision
		@insp_mtd,        
		@va040_qty_insp,	
		@entry_lot_flag,	
		@entry_fail_qty,		
		@qty_sample,	
		@qty_sample_rjt,		
		@acpt_qty		output,
		@reject_qty		output,
		@status			output,
		@out_msg		output

	if @status > '0'
		return
	
	
	if @va040_gaijung = 'ELES' and @va020_ship_flag='Y' and  @va040_qty_insp <> @acpt_qty and @va040_qty_insp <> @reject_qty
	begin
		select @status='1',@out_msg='발송은 전량합격 혹은 불합격만 가능합니다????'
		return
	end

   	IF  @insp_advan = 'R'
	begin
		select @status='3',@out_msg='MSG037 검사중지ITEM임 확인요망 ???'
		return
	end


-- 납품단가 Fetch

	exec SP_Common_Input_Price_Search
		@va040_gaijung,
		@order_select,
		@item_no,
		@vendor,
		@entry_price,
		@va020_price,
		@money_unit,
		@date_print_po,
		@due_date,
		@date_start,
		@proc_price			output,
		@proc_matl_price	output,
		@status				output,
		@out_msg			output
	
	if @status > '0'
		return


begin tran Common_Matl_Inspection

--**inspection 결과 Update

	declare	@last_range	char(02),
			@insp_range	char(02)

	if @insp_mtd = 'SA'
	begin
		exec SP_Common_Inspection_Base_Update
			@item_no,
			@vendor,
			@insp_mtd,
			@entry_lot_flag,
			@acpt_qty,
			@reject_qty,
			@last_range	output,
			@insp_range	output
	end


  --** 금형비 계산 & Update
	
/*
	declare	@mold_price	float,
		@amt_mold	float,
		@apply_qty_mold	float

	select @mold_price=0,@apply_qty_mold=0,@amt_mold=0

	exec    SP_Common_Mold_Compute_and_Base_Update
		@item_no,@vendor,@acpt_qty,@mold_price output,@apply_qty_mold output

	select @amt_mold=round(@mold_price*@apply_qty_mold,0)
*/

	update a set
		qty_acpt=a.qty_acpt+@acpt_qty,
		qty_reject=a.qty_reject+@reject_qty,
		date_last=getdate()
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	update a set
		run_status=(case when @va040_qty_insp = @reject_qty then '6' else '3' end),
		qty_acpt=@acpt_qty,
		qty_fail=@reject_qty,
		date_modif=getdate(),
--    		amut_mold=@amt_mold,
--          		appl_mold_qty=@apply_qty_mold,
		matr_amount = @proc_matl_price * @acpt_qty
	from EL_CD..T_VA_040 a
	where junpyo_no=@slip_no

	if @ship_flag = 'Y' and @va040_qty_insp <> @reject_qty
	begin
		exec SP_Common_Subul_Update
				@project_no,
				@mfg_no,
				@part	,
				@part_seq,
				'E',		
				0,
				'',		--@opt_date_io_8,
				@va040_qty_insp	output
	end


	if @insp_mtd = 'SA'
		update a set
			fail_code_1=@fail_code_1,
			fail_code_2=@fail_code_2,
			fail_code_3=@fail_code_3,
			lot_flag=@entry_lot_flag,
			acpt=@qty_sample-@entry_fail_qty,
			rjt=@entry_fail_qty,
			range_result=@insp_range,
			date_decision=getdate(),
			insp_emp_id=@user_id
		from mrp..t_mva_040_inspection a
		where junpyo_no=@slip_no

	select @status='0',@out_msg='Inspection OK....'

	commit tran Common_Matl_Inspection;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Matl_Year_Carry_Process                                                                                                                                                    */
/*  DISCRIPTION  : 년이월처리                                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/31     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Matl_Year_Carry_Process]
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	varchar(01),
	@to_year		char(04),
	@prev_Year		char(04),
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
SET NOCOUNT ON


							
--당월 입출고가 없는 item에 대한 월수불 생성 
	
	declare	@before_amt_stock	float,
			@after_amt_stock	float,
			@before_amt_output	float,
			@after_amt_output	float,
			@price_output		float

	select @status='0'


	if exists (select *
		from T_MVA_061_Year with (index=IX_T_MVA_061_Year_1)
		where gaijung=@gaijung
		and store=@store
		and order_select = @order_select
		and year between @prev_year and '9999' )
	begin
		select @status='1',@out_msg=@gaijung+'/'+@store+'/'+@order_select+' 에 대한 이월이 기완료 ????'
		return
	end



--재고Master정보
	select	item_no,
			gaijung,
			store,
			order_select,
			qty_trans=convert(float,0),
			amt_trans=convert(float,0),
			qty_input=convert(float,0),
			amt_input=convert(float,0),
			qty_output=convert(float,0),
			amt_output=convert(float,0),
			qty_stock=convert(float,0),
			amt_stock=convert(float,0),
			price_avg=convert(float,price_avg),
			date_price_avg,
			date_first_input,
			date_last_input,
			date_first_output,
			date_last_output,
			post_person
	into #aa
	from T_MVA_061 a with (index=IX_T_MVA_061_1 nolock)
	where gaijung=@gaijung
	and store=@store
	and order_select = @order_select
	


	insert into #aa
	select	item_no,
			gaijung,
			store,
			order_select,
			qty_trans=a.qty_stock,
			amt_trans=a.amt_stock,
			qty_input=0,
			amt_input=0,
			qty_output=0,
			amt_output=0,
			qty_stock=a.qty_stock,
			amt_stock=a.amt_stock,
			price_avg=0,
			date_price_avg=0,
			date_first_input='19100101',
			date_last_input='19100101',
			date_first_output='19100101',
			date_last_output='19100101',
			post_person=''
	from T_MVA_060 a with (index=IX_T_MVA_060_1 nolock)
	where year_month = @prev_Year + '12'
	--where year_month = (select MAX(year_month) 
	--								from T_MVA_060 b 
	--								where b.year_month <= @prev_Year+'12'
	--								and b.item_no = a.item_no
	--								and b.gaijung = a.gaijung
	--								and b.store = a.store
	--								and b.order_select = a.order_select)
	and gaijung=@gaijung
	and store=@store
	and order_select = @order_select
	and (qty_stock <> 0 or amt_stock <> 0)
	

	insert into #aa
	select	item_no,
			gaijung,
			store,
			order_select,
			qty_trans=0,
			amt_trans=0,
			qty_input=a.qty_input,
			amt_input=a.amt_input,
			qty_output=a.qty_output,
			amt_output=a.amt_output,
			qty_stock=a.qty_input-a.qty_output,
			amt_stock=a.amt_input-a.amt_output,
			price_avg=0,
			date_price_avg=0,
			date_first_input='19100101',
			date_last_input='19100101',
			date_first_output='19100101',
			date_last_output='19100101',
			post_person=''
	from T_MVA_060 a with (index=IX_T_MVA_060_1 nolock)
	where year_month between @to_year + '01' and @to_year+'12'
	and gaijung=@gaijung
	and store=@store
	and order_select = @order_select
	

begin tran Common_Matl_Year_Carry_Process

--현재고 화일 Save
	insert into T_MVA_061_Year
	select	item_no,
			gaijung,
			store,
			order_select,
			year=@prev_Year,
			qty_trans,
			amt_trans,
			qty_input,
			amt_input,
			qty_output,
			amt_output,
			qty_stock,
			amt_stock,
			price_avg,
			date_price_avg,
			date_first_input,
			date_last_input,
			date_first_output,
			date_last_output,
			post_person
	from T_MVA_061 a with (index=IX_T_MVA_061_1 nolock)
	where gaijung=@gaijung
	and store=@store
	and order_select = @order_select



--현재고 화일 Delete	
	delete a
	from T_MVA_061 a with (index=IX_T_MVA_061_1 nolock)
	where gaijung=@gaijung
	and store=@store
	and order_select = @order_select

--현재고 재생성
	insert into T_MVA_061
	select	item_no,
			gaijung,
			store,
			order_select,
			qty_trans=sum(qty_trans),
			amt_trans=sum(amt_trans),
			qty_input=sum(qty_input),
			amt_input=sum(amt_input),
			qty_output=sum(qty_output),
			amt_output=sum(amt_output),
			qty_stock=sum(qty_stock),
			amt_stock=sum(amt_stock),
			price_avg=max(price_avg),
			date_price_avg=max(date_price_avg),
			date_first_input=max(date_first_input),
			date_last_input=max(date_last_input),
			date_first_output=max(date_first_output),
			date_last_output=max(date_last_output),
			post_person=max(post_person)
	from #aa a 
	group by item_no	,gaijung	,store,order_select
	having 	sum(qty_trans) <> 0.0 or 
		sum(amt_trans) <> 0.0 or 
		sum(qty_input) <> 0.0 or 
		sum(amt_input) <> 0.0 or 
		sum(qty_output) <> 0.0 or 
		sum(amt_output) <> 0.0 or 
		sum(qty_stock) <> 0.0 or 
		sum(amt_stock) <> 0.0 

	update a set 
		current_year=@to_year
	from t_MZR_A1 a
	where gaijung=@gaijung
	and store=@store
	and order_select = @order_select

	
	commit tran Common_Matl_Year_Carry_Process
	select @status='0',@out_msg=' 년이월 처리 OK ...';

CREATE PROCEDURE [dbo].[SP_Common_Migration_chanwon]
	@segment		varchar(10)
AS

	declare	@temp_name	varchar(100),
		@conv_name	varchar(100)

	select	@temp_name='AA_' + @segment,
		@conv_name='Conv_' + @segment

	exec('select AA=SUBSTRING(AA,14,1000) INTO ' +@temp_name + ' from AAAA where left(aa,8)='''+ @segment + '''')

	exec('EXEC SP_BULK_EXPORT ''' + @temp_name + 
		''',''\\OTKRCWDS25\FTPROOT$\99박스\창원 MRP Data 보관\' + @temp_name + '.TXT''')

	exec('truncate table ' + @conv_name)
	exec('EXEC SP_BULK_IMPORT ''' + @conv_name + 
		''',''\\OTKRCWDS25\FTPROOT$\99박스\창원 MRP Data 보관\' + @temp_name + '.TXT'',''@@''');

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Mold_Compute_and_Base_Update                                                                                                                                              */
/*  DISCRIPTION  :  금형비 적용 Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Mold_Compute_and_Base_Update]
	@flag			char(01),	/** 1:Simulation   2:update **/
	@item_no		varchar(15),
	@vendor			varchar(08),
	@proc_qty		float,
	@mold_price		float	output,
	@qty_mold_apply	float	output
AS
SET NOCOUNT ON

	declare	@curr_date_8	char(08)

	select @curr_date_8 = convert(char(08),getdate(),112)

	declare	@qty_mold_limit	float,
			@qty_mold_total	float,
			@mold_status	char(01),
			@date_mold		varchar(08)	--금형적용시작일자

	select @mold_price=0,@qty_mold_limit=0,@qty_mold_total=0,@mold_status='',@qty_mold_apply=0

	if exists (select * from EL_CD..T_CX_060 where item_no=@item_no and mold_flag = 'Y')
	begin
		select	@mold_price=(case when mold_status = 'B' then 0 else mold_price end),
				@qty_mold_limit=qty_mold_limit,
				@qty_mold_total=qty_mold_total,	
				@mold_status=mold_status,
				@date_mold=convert(char(08),date_mold,112)
		from T_MYA_152
		where mold_sort='A'
		and item_no=@item_no
		and vendor=@vendor
		and qty_mold_limit > qty_mold_total
		and mold_status = 'A'

		if @proc_qty < 0
		begin
			select @qty_mold_apply = @proc_qty

			if @flag <> '1'
			     update a set
					qty_mold_total =a. qty_mold_total + @qty_mold_apply,
					mold_status='A'
				from mrp..T_MYA_152 a
				where mold_sort = 'A'
				and item_no=@item_no
				and vendor=@vendor
		end
		else if @mold_status in ( 'A','B') and @date_mold <= @curr_date_8
		begin 
			if @qty_mold_limit > @qty_mold_total + @proc_qty
				select @qty_mold_apply=@proc_qty
			else 
				select @qty_mold_apply= @qty_mold_limit - @qty_mold_total

			if @flag <> '1'
			     update a set
					qty_mold_total =a. qty_mold_total + @qty_mold_apply,
					mold_status=(case when abs(a.qty_mold_limit - a.qty_mold_total - @qty_mold_apply) < 0.5
							then 'F' else a.mold_status end)
				from mrp..T_MYA_152 a
				where mold_sort = 'A'
				and item_no=@item_no
				and vendor=@vendor
		end
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Order_Change                                                                                                                                              */
/*  DISCRIPTION  :  주문일정변경                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/27     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Order_Change]
	@change_type	char(01),	-- D:duedate V:vendor Q:qty C:전량취소
	@order_no		varchar(08),
	@change_data	varchar(10),
	@base_no		varchar(30),
	@user_id		varchar(08),
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS

set nocount on

BEGIN 

	if @change_type not in ('D','V','Q','C')	
	begin
		select @status='1',@out_msg='부문변경Type Error ???'
		return
	end

	declare	@run_status		char(01),
			@qty_remain		float,
			@curr_date		char(08),
			@date_due		varchar(08),
			@qty_order		float,
			@qty_deliv		float,
			@ship_flag		char(01),
			@prod_no		varchar(14),
			@part			varchar(02),
			@part_seq		varchar(04),
			@post_person	varchar(07),
			@gaijung		varchar(04),
			@item_no		varchar(15),
			@supply			char(01),
			@po_gubun		char(01),
			@money_unit		varchar(03),
			@after_order_no	varchar(08)

	select	@curr_date=convert(char(08),getdate(),112)

	select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			@date_due=convert(char(08),date_due,112),
			@qty_order=qty_order,@qty_deliv=qty_deliv,
			@ship_flag=ship_flag,@prod_no=prod_no,@part=part,@part_seq=part_seq,
			@post_person=post_person,@supply=supply,@money_unit=money_unit,
			@gaijung=gaijung,@item_no=item_no,@po_gubun=po_gubun
	FROM el_cd.dbo.T_va_020 a	
	WHERE a.order_no = @order_no 
	
	if left(@gaijung,2) <> left(master.dbo.fGetGaijung(@user_id),2)
	begin
		select @status='1',@out_msg=' 담당사업부 자료가 아닙니다 ???'
		return
	end	

	if @run_status > '4'
	begin
		select @status='1',@out_msg='주문완료 상태에선 작업불가  ???'
		return
	end

	if @qty_remain <= 0
	begin
		select @status='2',@out_msg='주문잔량이 없읍니다 ???'
		return
	end

	if @change_type = 'D'   --납기변경
	begin
		if isdate(@change_data) <> 1 
		begin
			select @status='2',@out_msg='날짜가 틀립니다 ????'
			return
		end

		if @change_data <= @curr_date
		begin
			select @status='2',@out_msg='변경날자가 현재이후이어야 합니다 ????'
			return
		end

		update a set
			date_due = convert(varchar(08),@change_data),
			date_chg=getdate(),
			date_last=getdate()
		from EL_CD..t_va_020 a
		where order_no=@order_no 

		if @run_status < '4'
		begin
			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end

		insert into EL_CD..T_VA_030
		select	@ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=a.date_start,
				DATE_CHG=convert(varchar(08),@change_data),
				CHG_TYPE=(case when a.date_due < @change_data then 'D' else 'E' end),
				QTY_CHG=a.qty_order,
				OPEN_ORDER=a.qty_order,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG='',
				APPROVE_DATE=null,
				RECEIPT_FLAG='',
				RECEIPT_DATE=null,
				REJECT_FLAG='',
				REJECT_DATE=null,
				new_order_no=''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 
	end

	if @change_type = 'Q'   --수량변경
	begin

		if isnumeric(@change_data) = 0 
		begin
			select @status='2',@out_msg='수량을 다시 입력하세요 ????'
			return
		end

		declare	@qty	float

		select @qty=convert(float,@change_data)

		if @qty >= @qty_remain
		begin
			select @status='2',@out_msg='변경할 수량은 잔량보다 적어야 함 ????'
			return
		end

		update a set
			qty_cancel=a.qty_cancel + (@qty_remain - @qty),
			date_chg=getdate(),
			date_last=getdate(),
			run_status=(case when a.qty_order - a.qty_cancel - (@qty_remain-@qty) - a.qty_input <= 0 
					then '5' else '4' end)
		from	EL_CD..t_va_020 a
		where order_no=@order_no 


		if @run_status < '4'
		begin
			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end

		insert into EL_CD..T_VA_030
		select	@ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=a.date_start,
				DATE_CHG=date_due,
				CHG_TYPE=(case when @qty_order=@qty_remain and @qty = 0  
							then 'C' else 'P' end),
				QTY_CHG=@qty_remain-@qty,
				OPEN_ORDER=@qty_remain,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG='',
				APPROVE_DATE=null,
				RECEIPT_FLAG='',
				RECEIPT_DATE=null,
				REJECT_FLAG='',
				REJECT_DATE=null,
				new_order_no=''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 
	end


	if @change_type = 'V'   --업체변경
	begin

		if not exists (select * from EL_CD..T_CX_080 where trade_no=@change_data)
		begin
			select @status='2',@out_msg='업체코드를  다시 입력하세요 ????'
			return
		end

		if @qty_deliv > 0
		begin
			select @status='2',@out_msg='납품된것은 업체변경 불가 적어야 함 ????'
			return
		end


		if @run_status < '4'
		begin
			update a set
				trade_no=@change_data,
				date_chg=getdate(),
				date_last=getdate()
			from EL_CD..t_va_020 a
			where order_no=@order_no 

			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end

		exec SP_Common_P_Order_Informal_Creation
			@gaijung,
			@item_no,
			@change_data,	--@o_vendor,
			@supply,
			@money_unit	,
			@qty_order,
			@ship_flag,
			@po_gubun,
			@date_due,
			@prod_no,
			@part,
			@part_seq,
			@after_order_no	output,
			@status			output,
			@out_msg		output		
		if @status > '0'
		begin
			return
		end

		update a set
			qty_cancel=a.qty_order,
			date_chg=getdate(),
			date_last=getdate(),
			run_status='5'
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		insert into EL_CD..T_VA_030
		select	a.ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=getdate(),
				DATE_CHG=a.date_due,
				CHG_TYPE='C',
				QTY_CHG=a.qty_order,
				OPEN_ORDER=a.qty_order,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG='',
				APPROVE_DATE=null,
				RECEIPT_FLAG='',
				RECEIPT_DATE=null,
				REJECT_FLAG='',
				REJECT_DATE=null,
				new_order_no=''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

	end

	if @change_type = 'C'   --주문취소
	begin

		if @qty_deliv > 0
		begin
			select @status='2',@out_msg='납품된것은 업체변경 불가 적어야 함 ????'
			return
		end

		if @run_status < '4'
		begin
			delete a
			from	EL_CD..t_va_020 a
			where order_no=@order_no 

			select @status='0',@out_msg='주문이 취소되었읍니다 ....'
			return
		end

		update a set
			qty_cancel=a.qty_order,
			date_chg=getdate(),
			date_last=getdate(),
			run_status='5'
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		insert into EL_CD..T_VA_030
		select	a.ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=getdate(),
				DATE_CHG=a.date_due,
				CHG_TYPE='C',
				QTY_CHG=a.qty_order,
				OPEN_ORDER=a.qty_order,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG='',
				APPROVE_DATE=null,
				RECEIPT_FLAG='',
				RECEIPT_DATE=null,
				REJECT_FLAG='',
				REJECT_DATE=null,
				new_order_no=''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 
	end

	update a set
	 	a.MRP_UPDATE_FLAG = 'Y',
		a.MRP_UPDATE_DATE = getdate()
	from el_cd..t_vj_200 a
	where a.order_no = @order_no 
	and a.request_flag = 'Y'
	and a.confirm_flag = 'Y'
	and	(a.mrp_update_flag = 'N' or a.mrp_update_flag is null)

	if @change_type = 'C'
		select @status='0',@out_msg='주문이 취소되었읍니다 ....'
	else
		select @status='0',@out_msg='변경 처리 되었읍니다....'

end;

--*******************************************************************************************************************
--  SP NAME      : SP_Common_Order_Qty_Compute                                                                                                                                                    **
--  DISCRIPTION  : Multiple,기초과발주량을  감안한  수량 계산                                                                                                                                   ** 
--                                                                                                                                                                                                  **
--  >> MODIFICATION LOG <<                                                                                                                                                       ** 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           **
--  ---------------------------------------------------------------                                                                                  **
-- 2010/01/23     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 **
--**************************************************************************************************************

CREATE PROCEDURE [dbo].[SP_Common_Order_Qty_Compute]
	@qty_order_prev			int,		--요구수량
	@over_order_qty			int,		--기초과발주량
	@multiple_qty			int,
	@qty_order				int	output,	--발주할 수량
	@over_order_qty_diff	int	output	--감안할 초과 수량
AS
SET NOCOUNT ON

/*

declare	@qty			int,
	@over_order_qty_diff	int

exec	SP_Common_Order_Qty_Compute
	11,
	10,
	100,
	@qty				output,	--발주할 수량
	@over_order_qty_diff		output	--차이

select	@qty,@over_order_qty_diff


*/

	declare	@temp_qty				int,
			@save_over_order_qty	int


	select @over_order_qty_diff=0,@qty_order=@qty_order_prev

	IF  @over_order_qty  > 0
	begin
		IF  @over_order_qty > @qty_order_prev 
		begin
			select   @over_order_qty_diff = (0-@qty_order_prev)
			select   @qty_order = 0
		end
		else
		begin
			select   @over_order_qty_diff = (0-@over_order_qty)
			select  @qty_order  =  @qty_order_prev - @over_order_qty
		end
	end

	if   @qty_order > 0 and @multiple_qty > 0
	begin
		select @temp_qty=@qty_order

		if convert(float,@qty_order) / convert(float,@multiple_qty) - convert(int,@qty_order / @multiple_qty) > 0
			select @qty_order=(convert(int,@qty_order / @multiple_qty)+1)*@multiple_qty
		else
			select @qty_order=convert(int,@qty_order / @multiple_qty)*@multiple_qty

		select   @over_order_qty_diff = @over_order_qty_diff + (@qty_order-@temp_qty)
	end;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Common_Order_Update                                                                            */
/*  DISCRIPTION  :  주문수정                                                                                         */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/01/27     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Order_Update]
	@flag			char(01),	-- M:Update D:Delete
	@order_no		varchar(08),
	@vendor			varchar(08)='',
	@supply			char(01)='',
	@prod_no_all	varchar(20)='',

	@item_unit		varchar(02),
	@gaijung		varchar(04),
	@money_unit		varchar(03),
	@market_flag	char(01),
	@po_gubun		char(01),

	@due_date		varchar(08)='',
	@date_start		varchar(08)='',
	@ship_flag		char(01)='',
	@user_id		varchar(08)='',
	@post_person	varchar(04)='',
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
--exec SP_MRP_6QJ_1 '7DRU4500'
set nocount on

	declare	@run_status			char(01),
			@qty_remain			float,
			@old_trade_no		varchar(08),
			@old_supply			char(01),
			@item_no			varchar(15),
			@order_select		char(01),
			@curr_date			char(08),
			@ya14_price			float,
			@ya14_matl_price	float,
			@ya14_date_apply	char(08),
			@check_gaijung		varchar(04)
			
	select @curr_date=convert(char(08),getdate(),112)

	select	@vendor=(case when @vendor < '0' then trade_no else @vendor end),
			@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			@item_no=a.item_no,
			@order_select=a.supply,
			@old_trade_no=trade_no,
			@old_supply=supply,
			@post_person=(case when @post_person < '0' then post_person else @post_person end),
			@item_unit=(case when @item_unit < '0' then item_unit else @item_unit end),
			@money_unit=(case when supply <> 'I' 
							then 'WON'
							else (case when @money_unit < '0' 
									then a.money_unit 
									else @money_unit end)
							end),
			@market_flag=(case when @market_flag < '0' then market_flag else @market_flag end),
			@po_gubun=(case when @po_gubun < '0' then po_gubun else @po_gubun end),
			@supply=(case when @supply < '0' then a.supply else @supply end),
			@prod_no_all=(case when @prod_no_all < '0' then prod_no+part+part_seq else @prod_no_all end),
			@date_start=(case when @date_start < '0' then convert(char(08),date_start,112) else @date_start end),
			@due_date=(case when @due_date < '0' then convert(char(08),date_due,112) else @due_date end),
			@ship_flag=(case when @ship_flag < '0' then ship_flag else @ship_flag end),
			@check_gaijung=gaijung
	FROM el_cd.dbo.T_va_020 a	
	WHERE a.order_no = @order_no 


	if left(@gaijung,2) <> left(@check_gaijung,2)
	begin
		select @status='1',@out_msg=' 담당사업부 자료가 아닙니다 ???'
		return
	end

	if @run_status >= '5'
	begin
		select @status='2',@out_msg=' 주문완료이후 작업 불가  ???'
		return
	end


	if @run_status >= '4' and @flag = 'D'
	begin
		select @status='2',@out_msg=' 주문집행이후 주문삭제 불가  ???'
		return
	end


	if @flag='M'
	begin

		if @qty_remain <= 0
		begin
			select @status='2',@out_msg='주문잔량이 없읍니다 ???'
			return
		end

		if isdate(@due_date) <> 1 
		begin
			select @status='2',@out_msg='납기가 틀립니다 ????'
			return
		end

		if isdate(@date_start) <> 1 
		begin
			select @status='2',@out_msg='시작일자가 틀립니다 ????'
			return
		end

		if @due_date < convert(char(08),getdate(),112)
		begin
			select @status='2',@out_msg='변경납기가 현재이후이어야 합니다 ????'
			return
		end

		if @run_status <> '1' and not exists (select * from el_cd..T_CX_080 where trade_no=@vendor)
		begin
			select @status='2',@out_msg='거래처코드 Error  ????'
			return
		end
		

		if @ship_flag='Y' and not exists (select * from el_cd..T_Ca_011
				 where project_no=substring(@prod_no_all,1,11)
				and mfg_no=substring(@prod_no_all,12,3)
				and part=substring(@prod_no_all,15,2)
				and part_seq=substring(@prod_no_all,17,4) )
		begin
			select @status='2',@out_msg=' 수불Key Error ????'
			return
		end

		declare	@run_status1	char(01)

		select @run_status1 = (case when @run_status = '4' and (@old_trade_no<>@vendor or @old_supply<>@supply)
								then '3' else @run_status end)

		select @ya14_price=0
		
		if @run_status1 <= '3' OR @supply = 'I'
		begin
			exec SP_Common_Price_Fetch
				@item_no,
				'A',			--*** price_sort ***
				@vendor,	
				@supply,	
				'',			--*** work_mtd  ***
				@money_unit,
				@curr_date,		--*** apply_date ***   
				'N',			--*** etc_apply_flag ***
				
				@ya14_price		output,
				@ya14_matl_price		output,
				@ya14_date_apply	output,
				@status			output,
				@out_msg		output
			
			if @status > '0'
			begin
				select @ya14_price=0,@status='0',@out_msg=''
			end
		end


		insert into el_cd.dbo.T_va_020_history
		select order_no,		item_no,		gaijung,		supply,		run_status,		date_due,		keep_flag,		item_unit,		money_unit,		price,
		price_r,		qty_order,		qty_deliv,		qty_insp,		qty_acpt,		qty_input,		qty_cancel,		date_start,		date_deliv,		date_chg,
		po_status,		date_delay,		insp_select,		pay_con,		post_wc,		prod_no,		lc_no,		req,		ao_no,		date_po,		post_person,
		date_last,		date_print_po,		trade_no,		skp,		po_post_person,		order_type,		etc_price,		last_ot_no,		po_gubun,		qty_reject,
		issue_no,		issue_last_no,		import_flag,		market_flag,		part_seq,		part,		ship_flag,		draw_no,		approve_flag,
		approve_date,		receipt_flag,		receipt_date,		reject_flag,		reject_date,		receipt_expect_no,		packing_vendor,		box_receipt_expect_no,
		approver,		box_no,		creator,		updater=@user_id,	update_date=GETDATE()
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 

		
		update a set
			trade_no=@vendor,
			prod_no=substring(@prod_no_all,1,14),
			part=substring(@prod_no_all,15,2),
			part_seq=substring(@prod_no_all,17,4),
			date_due=@due_date,
			ship_flag=@ship_flag,
			supply=@supply,
			date_start=@date_start,
			post_person=@post_person,
			item_unit	=@item_unit,
			gaijung	=@gaijung,
			money_unit	=@money_unit,
			market_flag	=@market_flag,
			po_gubun	=@po_gubun,
			run_status =@run_status1,
			price=(case when @run_status1 < '4' AND  @supply <> 'I' then @ya14_price else price end),
			price_R=(case when @supply='I' THEN @ya14_price else 0 end),
			date_print_po=(case when @run_status1 < '4' then null else a.date_print_po end),
			approve_flag=(case when @run_status1 < '4' then '' else approve_flag end),
			approve_date=(case when @run_status1 < '4' then null else approve_date end),
			receipt_flag=(case when @run_status1 < '4' then '' else receipt_flag end),
			receipt_date=(case when @run_status1 < '4' then null else receipt_date end),
			reject_flag=(case when @run_status1 < '4' then '' else reject_flag end),
			reject_date=(case when @run_status1 < '4' then null else reject_date end)
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
		
		if exists ( select 'y' 
					from EL_CD..t_ca_011 a
					where 	a.project_no=substring(@prod_no_all,1,11)
					and a.mfg_no=substring(@prod_no_all,12,3)
					and a.part=substring(@prod_no_all,15,2)
					and a.part_seq=substring(@prod_no_all,17,4)
					and a.trade_no <> @vendor )
		begin		
			update a set trade_no=@vendor
			from EL_CD..t_ca_011 a
			where 	a.project_no=substring(@prod_no_all,1,11)
			and a.mfg_no=substring(@prod_no_all,12,3)
			and a.part=substring(@prod_no_all,15,2)
			and a.part_seq=substring(@prod_no_all,17,4)
		end				
				
		

		if @run_status1 = '3' and @gaijung <> 'SY' 
		begin
			exec SP_Common_Purchasing_Order_Release
				@gaijung	,
				@order_no	,
				@status		output,
				@out_msg	output
		end

		select @status='0',@out_msg=' Update OK ....'
	end

	if @flag='D'
	begin
		update a set 
			run_status='6'
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 

		select @status='0',@out_msg=' Delete OK ....'
	end;

--sp_find_str SP_Common_P_Order_Informal_Creation

/**************************************************************************************************************/
/*  SP NAME      : SP_Common_P_Order_Informal_Creation                                                        */
/*  DISCRIPTION  : 비정규 주문처리                                                                            */ 
/*                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                   */
/*  ---------------------------------------------------------------                                           */
/* 2010/02/05     MRP Downsizing Project   J.J.Park      Initialize                                           */
/* 2023-08-08                                UNGJ         거래선  VARCHAR(8)변경                              */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_P_Order_Informal_Creation]
	@o_gaijung		varchar(04),
	@o_item_no		varchar(15),
	@o_vendor		varchar(08),
	@o_supply		char(01),
	@o_money_unit	varchar(03),
	@o_qty			float,
	@o_ship_flag	char(01),
	@po_gubun		char(01),
	@due_date		varchar(08),
	@prod_no		varchar(14),
	@part			char(02),
	@part_seq		varchar(04),
	@user_id		varchar(10),
	@order_no		varchar(08)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
	
AS
SET NOCOUNT ON
--exec MRP.dbo.SP_MRP_6EA_1 'ELES','','','','','','Y','','','2009F  0500E01','01','AUA0'
--exec MRP.dbo.SP_MRP_6EA_1 'ELES','Aeg11c995*d','1088096','d','','1','N','2','20100210','','',''

	declare	@project_no	varchar(11),
			@mfg_no		varchar(03)

	declare	@curr_date		char(08),
			@market_flag	char(01)


	declare	@item_no	varchar(30),
			@gaijung	varchar(04),
			@vendor		varchar(08),
			@supply		char(01),
			@money_unit	varchar(03),
			@qty		float,
			@Initial	char(03)

	select @o_money_unit=''
	
	select @project_no=left(@prod_no,11),@mfg_no=substring(@prod_no,12,3)

	select @curr_date = convert(char(08),getdate(),112)


	if @o_gaijung = 'SPSS'
		select @Initial=substring(@curr_date,4,1)+'XX'
	else if @o_gaijung = 'SYHP'
		select @Initial=substring(@curr_date,4,1)+'YY'
	else
		select @Initial=substring(@curr_date,4,1)+'ZZ'

	if @o_ship_flag not in ('Y','N')
	begin
		select @status='1',@out_msg=' Ship Flag를 재입력 하세요 ???'
		return
	end

	if @o_ship_flag = 'Y'
	begin
		if not exists (select *
			from el_cd..t_ca_011 a
			where a.project_no=@project_no
			and a.mfg_no=@mfg_no
			and a.part=@part
			and a.part_seq=@part_seq)
		begin
			select @status='1',@out_msg=' 제번+수불항번을 재입력 하세요 ???'
			return
		end
	end

	if exists (select *
		from el_cd..t_ca_011 a
		where a.project_no=@project_no
		and a.mfg_no=@mfg_no
		and a.part=@part
		and a.part_seq=@part_seq)
	begin
		select	@gaijung=a.gaijung,
				@supply=order_select,
				@market_flag=a.market_flag,
				@item_no=a.item_no,
				@qty=a.cont_qty
		from el_cd..t_ca_011 a
		where a.project_no=@project_no
		and a.mfg_no=@mfg_no
		and a.part=@part
		and a.part_seq=@part_seq
	end

	if @o_ship_flag = 'N'
	begin
		if @o_gaijung < '0'
		begin
			select @status='1',@out_msg=' 계정을 입력하세요 ???'
			return
		end
	end



	if @o_ship_flag = 'Y'
	begin
		if @gaijung is null
		begin
			select @status='1',@out_msg=' 해당제번이 미존재 ???'
			return
		end

		if @o_gaijung <> @gaijung
		begin
			select @status='1',@out_msg=' 해당제번의 주문자격이 없읍니다 ???'
			return
		end


		if @o_supply < '0'
			select @o_supply=@supply

		if @o_item_no < '0'
			select @o_item_no=@item_no

		else if @o_item_no  <> @item_no
		begin
			select @status='1',@out_msg=' 제통의 Item No와 불일치 ???'
			return
		end

		if @o_qty = 0
			select @o_qty=@qty
		else if @o_qty  <> @qty
		begin
			select @status='1',@out_msg=' 제통의 수량과 불일치 ???'
			return
		end

	end

	if @market_flag is null
		select @market_flag=''

	if @o_item_no < '0' or not exists (select *  from el_cd..t_cx_060 a  where a.item_no=@o_item_no)
	begin
		select @status='1',@out_msg=' Item No를 재입력하세요 ???'
		return
	end
	

	if @o_supply < '0' or @o_supply not in ('S','X','Z','I','D')
	begin
		select @status='1',@out_msg=' 조달을 재입력하세요 ???'
		return
	end
	
	if @o_qty <= 0
	begin
		select @status='1',@out_msg=' 발주수량을 재입력하세요 ???'
		return
	end
	

	select	@vendor=isnull(a.vendor,''),
			@money_unit=(case when @o_supply = 'I' then a.money_unit else 'WON' end)
	from el_cd..t_cx_060 a
	where a.item_no=@o_item_no
	
	if @o_vendor < '0'
		select @o_vendor=@vendor


	if @vendor > '0' and not exists (select *  from el_cd..t_cx_080 a  where a.trade_no=@o_vendor)
	begin
		select @status='1',@out_msg=' 거래처를 재입력하세요 ???'
		return
	end

	if @o_money_unit < '0'
		select @o_money_unit=@money_unit

	IF @due_date > '0' AND ISDATE(@due_date)=0
	begin
		select @status='1',@out_msg=' 납기를  재입력하세요 ???'
		return
	end

	if @due_date < convert(varchar(8),GETDATE(),112)
	begin
		select @status='1',@out_msg=' 납기일은 현재일 이상이어야 합니다.'
		return
	end	

	if @due_date < '0'
		select @due_date = convert(char(08),dateadd(d,2,getdate()),112)

	exec sp_Numbering_output 'A11',@Initial,@order_no output

	insert into EL_CD..T_VA_020
	select	order_no=@order_no,
			item_no=upper(@o_item_no),
			Gaijung=(case when @part='RA' then 'ELRA' else @o_gaijung end),
			supply=upper(@o_supply),
			run_status='3',
			Due_Date=@Due_Date,
			keep_flag='K',
			item_unit=b.item_unit,
			money_unit=@o_money_unit,
			price=0,
			price_r=0,
			qty_order=@o_qty,
			qty_deliv=0,
			qty_insp=0,
			qty_acpt=0,
			qty_input=0,
			qty_cancel=0,
			date_start=@curr_date,
			date_deliv=null,
			date_chg=null,
			po_status=(case when @curr_date  > @due_Date then 'P' else (case when @curr_date > @curr_date then 'E' else 'N' end) end),
			date_delay=null,
			insp_select=b.insp_select,
			pay_con='',
			post_wc='',
			prod_no=upper(@prod_no),
			lc_no='',
			req=@o_qty,
			ao_no='NONE',
			date_po=getdate(),
			post_person=isnull(b.plan_post_person,''),
			date_last=null,
			date_print_po=null,
			trade_no=@o_vendor,
			skp=upper(case when @o_supply in ('S','X','Z') then @o_supply else ' ' end),
			po_post_person=isnull((case when @o_gaijung in ('ELES') then c.post+c.person else b.po_post_person end),''),
			order_type=@curr_date,
			etc_price=0,
			last_ot_no=0,
--			po_gubun=(case when left(@mfg_no,1) in ( 'P','X','C','B') then '5' else (case when @part = 'CM' then '4' else '1' end)end),
			po_gubun=(case when substring(@prod_no,5,1) = 'D' then '7' 
						   when left(@mfg_no,1) in ( 'P','X','C','B') then '5' 
						   else (case when @part = 'CM' then '4' 
									  when @po_gubun > '' then @po_gubun 
									  else '1' 
								      end)
					       end),
--			po_gubun=(case when left(@mfg_no,1) in ( 'P','X','C','B') then '5' else (case when @part = 'CM' then '4' when @po_gubun > '' then @po_gubun else '1' end)end),
			qty_reject=0,
			issue_no='',
			issue_last_no=0,
			import_flag='',
			market_flag=@market_flag,
			part_seq=upper(@part_seq),
			part=upper(@part),
			ship_flag=@o_ship_flag,
			draw_no=isnull(b.draw_no,''),
			approve_flag='',
			approve_date=null,
			receipt_flag='',
			receipt_date=null,
			reject_flag='',
			reject_date=null,
			receipt_expect_no='','','','','',creator=@user_id
	from EL_CD..T_CX_060 b
		left outer join EL_CD..T_CX_080 c 
			on c.trade_no=@vendor
	where b.item_no=@o_item_no

--주문집행
	exec SP_Common_Purchasing_Order_Release
		@o_gaijung,
		@order_no,
		@status		output,
		@out_msg	output

	if @o_ship_flag = 'Y'
	begin
		update y set 		
			date_ao=@curr_date,
			date_po=(case when y.date_po is null and y.order_select in ('D','I','L') then @curr_date else y.date_po end),
			upd_date=getdate(),
			run_date=getdate(),
			concern_order_no=@order_no,
			confirm_flag='A',
			cause_code=(case when y.cause_code='@@' then '$$' else y.cause_code end),
			trade_no=@vendor
		from EL_CD..T_CA_011 y
		where y.project_no=@project_no
		and y.mfg_no=@mfg_no
		and y.part=@part
		and y.part_seq=@part_seq
	end
	
	select @status='0',@out_msg=' 비정규 발주 OK ..';

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_P_Order_Informal_Creation_RB  (ROLB포함)                                                                                                                                                */
/*  DISCRIPTION  : 비정규 주문처리                                                                                                                      */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/05     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_P_Order_Informal_Creation_RB]
	@o_gaijung		varchar(04),
	@o_item_no		varchar(15),
	@o_vendor		varchar(08),
	@o_supply		char(01),
	@o_money_unit	varchar(03),
	@o_qty			float,
	@o_ship_flag	char(01),
	@po_gubun		char(01),
	@due_date		varchar(08),
	@prod_no		varchar(14),
	@part			char(02),
	@part_seq		varchar(04),
	@user_id		varchar(10),
	@order_no		varchar(08)		output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
SET NOCOUNT ON


begin tran Common_P_Order_Informal_Creat_RB

	exec SP_Common_P_Order_Informal_Creation
		@o_gaijung,
		@o_item_no,
		@o_vendor,
		@o_supply,
		@o_money_unit,
		@o_qty,
		@o_ship_flag,
		@po_gubun,
		@due_date,
		@prod_no,
		@part	,
		@part_seq,
		@user_id,
		@order_no	output,
		@status		output,
		@out_msg	output

	if @status > '0'
		rollback tran Common_P_Order_Informal_Creat_RB
	else
		commit tran Common_P_Order_Informal_Creat_RB;

/*** 사급일괄일정변경 ****/


CREATE          PROCEDURE SP_Common_P_Order_SXZ_Cancel
	@order_no	varchar(08),
	@post_person	varchar(04),
	@base_no	varchar(12),
	@item_no	varchar(15),
	@prod_no	varchar(12),
	
	@status		char(01)		output,
	@out_msg	varchar(50)	output
AS
SET NOCOUNT ON

	         
	if not exists (select *
		from T_VA_020
		where order_no=@order_no)
	begin
		select @status='1',@out_msg='해당 주문번호가 없읍니다???'
		return
	end

	if not exists (select *
		from T_VA_020
		where order_no=@order_no
		and run_status <> '5'
		and supply in ('S','X','Z'))
	begin
		select @status='1',@out_msg='취소할수 업는 주문입니다???'
		return
	end

	if not exists (select *
		from T_VA_020
		where order_no=@order_no
		and (qty_order - qty_cancel - (qty_deliv - qty_reject)) > 0 )
	begin
		select @status='1',@out_msg='취소할 수량이 없읍니다'
		return
	end

     -------------아래 
/*
	declare	@remain_qty	real,
		@price		float

	select	@remain_qty  =  qty_order - qty_cancel - (qty_deliv - qty_reject)
	from T_VA_020
	where order_no=@order_no

	insert into EL_CD..T_VA_030
	select	a.order_no
		,date_act=getdate()
		,date_due=a.date_due
		,date_start=a.date_start
		,date_chg=getdate()
		,chg_type='C'
		,qty_chg=@remain_qty
		,open_order=@remain_qty
		,post_person=@post_person
		,base_no=@base_no
		,price=a.price
		,price_r=a.price
		,trade_no=a.trade_no
		,gaijung=a.gaijung
		,approve_flag=''
		,approve_date=null
		,receipt_flag=''
		,receipt_date=null
		,reject_flag=''
		,reject_date=null
	from T_VA_020 a
	where order_no=@order_no
	
	update a set
		qty_cancel =  a.qty_cancel + @remain_qty,
		run_status='5',
		po_status='5',
		date_chg=getdate(),
		date_last=getdate()	
	from T_VA_020
	where order_no=@order_no

*/	


	
	
	
SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Price_Fetch                                                                                                                                              */
/*  DISCRIPTION  :  작용할 적용단가/판매단가 Fetch하는  Common SP                                                                                                                              */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Price_Fetch]
	@item_no			varchar(15),
	@price_sort			char(01),
	@vendor				varchar(08),
	@order_select		char(01),
	@work_mtd			varchar(02),
	@money_unit			varchar(03),
	@apply_date			 varchar(08),
	@etc_apply_flag		char(01),
	
	@ya14_price			float			output,
	@ya14_matl_price	float			output,
	@ya14_date_apply	varchar(08)		output,
	@status				char(01)		output,
	@out_msg			varchar(100)	output
AS
SET NOCOUNT ON
 
	select @ya14_price = 0

	select @status='0',@out_msg=@item_no+' Price_Fetch OK ...'

	if @vendor < '0'
	begin
		select	@status='1',@out_msg=@item_no+' Vendor not found',
				@ya14_price=0,@ya14_matl_price=0,@ya14_date_apply=null

		return
	end
		
	if @price_sort = 'D'
		select @order_select='S'

	if @order_select not in ('D','I','S','X','Z')
	begin
		select	@status='2',@out_msg=@item_no+' Supply Error',
				@ya14_price=0,@ya14_matl_price=0,@ya14_date_apply=null

		return
	end
		
	if @item_no < '0'  or @apply_date < '0'
	begin
		select	@status='3',@out_msg=@item_no+' 필수 Input 항목 누락  ',
				@ya14_price=0,@ya14_matl_price=0,@ya14_date_apply=null

		return
	end

	---- unique item 은 모도번 단가 사용

	if exists ( select * from el_cd..t_cx_060 where item_no = @item_no and pdmUniquNo > '0')
	begin
		select @item_no = master.dbo.fGetMRPSeedItemNo(@item_no)
	end


 	select	@ya14_price=a.apply_price+(case when @etc_apply_flag='Y' then a.etc_price else 0 end) ,
			@ya14_matl_price=(case when @order_select in ('X','Z') then a.matl_price else 0 end),
			@ya14_date_apply=convert(char(08),a.date_apply_from,112)
	from el_cd..t_cx_610 a
	where a.item_no = @item_no
	and a.price_sort=@price_sort
	and a.vendor = @vendor
	and a.order_select=@order_select
	and a.work_mtd=@work_mtd
	and a.money_unit=@money_unit
	and a.apply_flag='Y'
	and a.date_apply_from = (select max(b.date_apply_from)
				from  el_cd..t_cx_610 b
				where b.item_no = @item_no
				and b.price_sort=@price_sort
				and b.vendor = @vendor
				and b.order_select=@order_select
				and b.work_mtd=@work_mtd
				and b.money_unit=@money_unit
				and b.apply_flag='Y'
				and b.date_apply_from <= @apply_date)


	if @ya14_price is null or @ya14_price = 0
	begin
		select @status='4',@out_msg=@item_no+'/'+@order_select+'/'+@vendor+'/'+(case when @price_sort = 'A' 
						then ' 적용단가' else ' 판매단가' end)+' Not Found'
		select @ya14_price=0,@ya14_matl_price=0,@ya14_date_apply=''
	end;

/***대일정 변경에 따른 오더 일정변경 ***/


CREATE PROCEDURE [dbo].[SP_Common_Production_Sched_Update]
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02),
	@plan_date	smalldatetime
AS
SET NOCOUNT ON

--SP_Common_Production_Sched_Update '2009F  0031','E01','01','20100621'
	declare	@curr_date	smalldatetime
		
	select	@curr_date=convert(smalldatetime,convert(char(08),getdate(),112))

	if left(@mfg_no,1) <> 'P'
	begin
--수불대장 납기변경
		select	part_seq,
				order_select,concern_order_no,
				due_date,date_diff=datediff(day,due_date,@plan_date)
		into #Sched_Update1
		from EL_CD..T_CA_011 a
		where project_no=@project_no
		and mfg_no=@mfg_no
		and part=@part
		and last_out_date is null
		and last_in_date is null
		and rslt_date is null
		and cont_qty > 0
		and @plan_date <> due_date

		update a set
			upd_date=getdate(),
			due_date=@plan_date
		from #Sched_Update1 x,EL_CD..T_CA_011 a
		where x.part_seq > '0'
		and a.project_no=@project_no
		and a.mfg_no=@mfg_no
		and a.part=@part
		and a.part_seq=x.part_seq

-- 
-- 		select distinct a.*,c.order_no
-- 		into #Sched_Update2
-- 		from #Sched_Update1 a,EL_QC..T_QC_012 b,T_MYO_01 c
-- 		where a.part_seq>'0'
-- 		and b.project_no=@project_no
-- 		and b.mfg_no=@mfg_no
-- 		and b.part=@part
-- 		and b.part_seq=a.part_seq
-- 		and b.manu_purch_flag='M'
-- 		and (b.qty-b.cancel_qty) > b.complete_qty
-- 		and c.order_no=b.order_no
-- 		and (c.qty_ao - c.qty_cancel) = b.qty
-- 		and (c.qty_ao - c.qty_cancel) > c.qty_finish

-- 		if @@rowcount > 0
-- 		begin
-- --제조납기 변경
-- -- 			update b set
-- -- 				start_date=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.start_date),@curr_date),
-- -- 				due_date=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.date_due),@curr_date)
-- -- 			from #Sched_Update2 a,T_MYO_01 b
-- -- 			where a.part_seq>'0'
-- -- 			and b.order_no=a.order_no
-- 
-- --불출에정일자 변경
-- 			update b set
-- 				date_out=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.date_out),@curr_date),
-- 				date_start=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.date_start),@curr_date)
-- 			from #Sched_Update2 a,T_MZE_01 b
-- 			where a.project_no>'0'
-- 			and jp_no between 'IX'+a.order_no and 'IX' + a.order_no +'ZZZZ'
-- 		end

		select distinct a.*,c.order_no
		into #Sched_Update3
		from #Sched_Update1 a,EL_CD..T_VA_020 c
		where a.part_seq>'0'
		and c.order_no=b.order_no
		and (c.qty_order - c.qty_cancel) > 0
		and c.qty_deliv = 0
		and c.receipt_expect_no < '0'

--주문변경이력
		if @@rowcount > 0
		begin
--sp_fields T_MVA_030
			insert into EL_CD..T_VA_030
			select	a.order_no,
					date_act=getdate(),
					date_due=b.date_due,
					date_start=b.date_start,
					date_chg=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.due_date),@curr_date),
					chg_type=(case when a.date_diff > 0 then 'D' else 'E' end),
					qty_chg=b.qty_order-b.qty_cancel,
					open_order=b.qty_order-b.qty_cancel,
					post_person=b.post_person,
					base_no='',
					price=a.price,
					price_r=a.price_r,
					vendor=b.vendor,
					gaijung=b.gaijung,
					approve_flag=null,
					approve_date=null,
					receipt_flag=null,
					receipt_date=null,
					reject_flag=null,
					reject_date=null
			from #Sched_Update2 a,EL_CD..T_VA_020 b
			where a.part_seq>'0'
			and b.order_no=a.order_no

--주문변경
			update b set
				date_start=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.date_start),@curr_date),
				due_date=master.dbo.fn_Common_Z3K2_Base(dateadd(day,a.date_diff,b.due_date),@curr_date)
			from #Sched_Update2 a,EL_CD..T_VA_020 b
			where a.part_seq>'0'
			and b.order_no=a.order_no
		end
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Purchasing_Order_Change                                                                                                                                              */
/*  DISCRIPTION  :  주문일정변경                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/27     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Purchasing_Order_Change]
	@change_type	char(01),	-- D:duedate V:vendor Q:qty C:전량취소
	@order_no		varchar(08),
	@change_data	varchar(10),
	@base_no		varchar(40),
	@user_id		varchar(08),
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
set nocount on

	if @change_type not in ('D','V','Q','C')	
	begin
		select @status='1',@out_msg='부문변경Type Error ???'
		return
	end

	declare	@run_status		char(01),
			@qty_remain		float,
			@curr_date		char(08),
			@date_due		varchar(08),
			@qty_order		float,
			@qty_deliv		float,
			@ship_flag		char(01),
			@prod_no		varchar(14),
			@part			varchar(02),
			@part_seq		varchar(04),
			@post_person	varchar(07),
			@gaijung		varchar(04),
			@item_no		varchar(15),
			@supply			char(01),
			@po_gubun		char(01),
			@money_unit		varchar(03),
			@after_order_no	varchar(08)

	select	@curr_date=convert(char(08),getdate(),112)


	select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			@date_due=convert(char(08),date_due,112),
			@qty_order=qty_order,@qty_deliv=qty_deliv,
			@ship_flag=ship_flag,@prod_no=prod_no,@part=part,@part_seq=part_seq,
			@post_person=post_person,@supply=supply,@money_unit=money_unit,
			@gaijung=gaijung,@item_no=item_no,@po_gubun=po_gubun
	FROM el_cd.dbo.T_va_020 a	
	WHERE a.order_no = @order_no 

	if @run_status > '4'
	begin
		select @status='1',@out_msg='주문완료 상태에선 작업불가  ???'
		return
	end


	if @qty_remain <= 0
	begin
		select @status='2',@out_msg='주문잔량이 없읍니다 ???'
		return
	end

	if @change_type = 'D'   --납기변경
	begin
		if isdate(@change_data) <> 1 
		begin
			select @status='2',@out_msg='날짜가 틀립니다 ????'
			return
		end

		if @change_data < @curr_date
		begin
			select @status='2',@out_msg='변경날자가 현재이후이어야 합니다 ????'
			return
		end

		if @date_due = @change_data
		begin
			select @status='3',@out_msg='변경날짜가 동일, 확인하세요 ????'
			return
		end
	end

	declare	@qty	float

	if @change_type = 'Q'   --수량변경
	begin
		if isnumeric(@change_data) = 0 
		begin
			select @status='2',@out_msg='수량을 다시 입력하세요 ????'
			return
		end

		select @qty=convert(float,@change_data)

		if @qty >= @qty_remain
		begin
			select @status='2',@out_msg='변경할 수량은 잔량보다 적어야 함 ????'
			return
		end
	end


	if @change_type = 'V'   --업체변경
	begin
		if not exists (select * from EL_CD..T_CX_080 where trade_no=@change_data)
		begin
			select @status='2',@out_msg='업체코드를  다시 입력하세요 ????'
			return
		end

		if @qty_deliv > 0
		begin
			select @status='2',@out_msg='납품된것은 업체변경 불가 적어야 함 ????'
			return
		end
	end

	if @change_type = 'C'   --주문취소
	begin
		if @qty_deliv > 0
		begin
			select @status='2',@out_msg='납품된것은 주문취소 불가 ????'
			return
		end
	end

	
begin tran  Common_Purchasing_Order_Change

	if @change_type = 'D'   --납기변경
	begin
		if @run_status = '4'
		begin
			insert into EL_CD..T_VA_030
			select	@ORDER_NO,
					DATE_ACT=getdate(),
					DATE_DUE=a.date_due,
					DATE_START=a.date_start,
					DATE_CHG=convert(varchar(08),@change_data),
					CHG_TYPE=(case when a.date_due < @change_data then 'D' else 'E' end),
					QTY_CHG=a.qty_order,
					OPEN_ORDER=a.qty_order,
					POST_PERSON=@user_id,
					BASE_NO=@base_no,
					PRICE=a.price,
					PRICE_R=a.price_r,
					TRADE_NO=a.trade_no,
					GAIJUNG,
					APPROVE_FLAG=null,
					APPROVE_DATE=null,
					RECEIPT_FLAG=null,
					RECEIPT_DATE=null,
					REJECT_FLAG=null,
					REJECT_DATE=null,
					''
			from	EL_CD..t_va_020 a
			where order_no=@order_no 
		end

		update a set
			date_due = convert(varchar(08),@change_data),
			date_chg=getdate(),
			date_last=getdate()
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		if @run_status < '4'
		begin
			commit tran  Common_Purchasing_Order_Change
			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end
	end

	if @change_type = 'Q'   --수량변경
	begin
		update a set
			qty_cancel=a.qty_cancel + (@qty_remain - @qty),
			date_chg=getdate(),
			date_last=getdate(),
			run_status=(case when a.qty_cancel + a.qty_input - a.qty_reject +  (@qty_remain-@qty) >= a.qty_order then '5' else '4' end)
		from	EL_CD..t_va_020 a
		where order_no=@order_no 


		if @run_status < '4'
		begin
			commit tran  Common_Purchasing_Order_Change
			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end

		insert into EL_CD..T_VA_030
		select	@ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=a.date_start,
				DATE_CHG=date_due,
				CHG_TYPE=(case when @qty_order=@qty_remain and    @qty = 0  
							then 'C' else 'P' end),
				QTY_CHG=@qty_remain-@qty,
				OPEN_ORDER=@qty_remain,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG=null,
				APPROVE_DATE=null,
				RECEIPT_FLAG=null,
				RECEIPT_DATE=null,
				REJECT_FLAG=null,
				REJECT_DATE=null,
				''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 
	end


	if @change_type = 'V'   --업체변경
	begin
		if @run_status < '4'
		begin
			update a set
				trade_no=@change_data,
				date_chg=getdate(),
				date_last=getdate()
			from EL_CD..t_va_020 a
			where order_no=@order_no 

			commit tran  Common_Purchasing_Order_Change
			select @status='0',@out_msg='변경 처리 되었읍니다....'
			return
		end

		if @date_due < convert(char(08),dateadd(day,1,getdate()),112)
			select @date_due = convert(char(08),dateadd(day,1,getdate()),112)

		exec SP_Common_P_Order_Informal_Creation
			@gaijung,
			@item_no,
			@change_data,	--@o_vendor,
			@supply,
			@money_unit	,
			@qty_order,
			@ship_flag,
			@po_gubun,
			@date_due,
			@prod_no,
			@part,
			@part_seq,
			@user_id,
			@after_order_no	output,
			@status			output,
			@out_msg		output		
		if @status > '0'
		begin
			rollback tran  Common_Purchasing_Order_Change
			return
		end

		update a set
			qty_cancel=a.qty_order,
			date_chg=getdate(),
			date_last=getdate(),
			run_status='5'
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		insert into EL_CD..T_VA_030
		select	a.ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=getdate(),
				DATE_CHG=a.date_due,
				CHG_TYPE='C',
				QTY_CHG=a.qty_order,
				OPEN_ORDER=a.qty_order,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG=null,
				APPROVE_DATE=null,
				RECEIPT_FLAG=null,
				RECEIPT_DATE=null,
				REJECT_FLAG=null,
				REJECT_DATE=null,
				new_order_no=@after_order_no
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		if  @@rowcount = 0
		begin
			rollback tran Common_Purchasing_Order_Change
			select @status='1',@out_msg='주문변경 Insert Error (' + @order_no + ') ???'
			return
		end
	end

	if @change_type = 'C'   --주문취소
	begin
		update a set
			qty_cancel=a.qty_order,
			date_chg=getdate(),
			date_last=getdate(),
			run_status='5'
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		if @run_status < '4'
		begin
			commit tran  Common_Purchasing_Order_Change
			select @status='0',@out_msg='주문이 취소되었읍니다 ....'
			return
		end

		insert into EL_CD..T_VA_030
		select	a.ORDER_NO,
				DATE_ACT=getdate(),
				DATE_DUE=a.date_due,
				DATE_START=getdate(),
				DATE_CHG=a.date_due,
				CHG_TYPE='C',
				QTY_CHG=a.qty_order,
				OPEN_ORDER=a.qty_order,
				POST_PERSON=@user_id,
				BASE_NO=@base_no,
				PRICE=a.price,
				PRICE_R=a.price_r,
				TRADE_NO=a.trade_no,
				GAIJUNG,
				APPROVE_FLAG=null,
				APPROVE_DATE=null,
				RECEIPT_FLAG=null,
				RECEIPT_DATE=null,
				REJECT_FLAG=null,
				REJECT_DATE=null,
				''
		from	EL_CD..t_va_020 a
		where order_no=@order_no 

		if  @@rowcount = 0
		begin
			rollback tran Common_Purchasing_Order_Change
			select @status='1',@out_msg='주문변경 Insert Error (' + @order_no + ') ???'
			return
		end
	end

	update a set
	 	a.MRP_UPDATE_FLAG = 'Y',
		a.MRP_UPDATE_DATE = getdate()
	from el_cd..t_vj_200 a
	where  a.order_no = @order_no 
	and         a.request_flag = 'Y'
	and 	a.confirm_flag = 'Y'
	and	(a.mrp_update_flag = 'N' or a.mrp_update_flag is null)

	if @change_type = 'C'
		select @status='0',@out_msg='주문이 취소되었읍니다 ....'
	else
		select @status='0',@out_msg='변경 처리 되었읍니다....'

	commit tran Common_Purchasing_Order_Change;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Common_Purchasing_Order_Release                                                                */
/*  DISCRIPTION  :  주문집행 (오더별)                                                                                */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/02/04     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Purchasing_Order_Release]
	@gaijung	varchar(04),
	@order_no	varchar(08),
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON

/*

declare	@status		char(01)		,
	@out_msg	varchar(100)	

exec SP_Common_Purchasing_Order_Confirm 'ELES','0AAT0030',@status output,@out_msg output

select @status ,@out_msg 

*/

	declare	@curr_date_8		char(08)

	declare	@zr03_date_flag		char(1),		--* 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자***
			@order_select		char(01),
			@item_no			varchar(15),
			@run_status			char(01),
			@money_unit			varchar(03),
			@vendor				varchar(08),
			@ya14_price			float,
			@ya14_matl_price	float,
			@due_date			varchar(08),
			@date_start			varchar(08),
			@ya14_date_apply	char(08)

	select	@curr_date_8=convert(char(08),getdate(),112)

	select 	@item_no=item_no,
			@order_select=supply,
			@vendor=trade_no,
			@date_start=convert(char(08),date_start,112),
			@due_date=convert(char(08),date_due,112),
			@money_unit=money_unit,
			@run_status = run_status,
			@gaijung=(case when @gaijung < '0' then a.gaijung else @gaijung end)
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	if @run_status > '3'
	begin
		select @status='1',@out_msg= ' 주문 집행 상태이후는 불가 ' + @order_no
		return
	end

	if @run_status <> '3'
	begin
		select @status='1',@out_msg= ' 주문확정상태이여야 함 ??? ' + @order_no
		return
	end

	if @vendor < '0' or @vendor is null
		select 	@vendor=vendor
		from el_cd..t_cx_060
		where item_no=@item_no

	if @vendor < '0' or @vendor is null
	begin
		select @status='1',@out_msg= ' vendor not nound in ' + @item_no
		return
	end

--** 납품관련정보 ***

	if not exists (select * from T_MZR_03
					where gaijung=@gaijung
					and order_select=@order_select)
	begin
		select @status='1',@out_msg='납품 Option Not Found in Purchasing_Order_Release '
		return
	end
	
	select	@zr03_date_flag=date_flag
	from T_MZR_03
	where gaijung=@gaijung
	and order_select=@order_select		
	
-- 주문단가 Fetch

	declare	@date_apply	varchar(08)

	select @date_apply = (case when @zr03_date_flag = '1' 
							then @due_date 
							else (case when @zr03_date_flag='2' then @curr_date_8 else @curr_date_8 end) end)

	exec SP_Common_Price_Fetch
		@item_no,
		'A',			--*** price_sort ***
		@vendor,	
		@order_select,	
		'',			--*** work_mtd  ***
		@money_unit,
		@date_apply,		--*** apply_date ***   
		'N',			--*** etc_apply_flag ***
		
		@ya14_price		output,
		@ya14_matl_price		output,
		@ya14_date_apply	output,
		@status			output,
		@out_msg		output

	if @status > '0'
	begin
		if @order_select = 'I'
			select @status='0',@out_msg=''
		else
			return
	end

--주문마스터 Update
	update a set
		run_status=(case when @ya14_price > 0 or @order_select = 'I' and @vendor > '0'
						then '4' else a.run_status end),
		date_print_po=(case when @ya14_price > 0 then convert(char(08),getdate(),112) else a.date_print_po end),
		price=(case when @order_select = 'I' then 0 else @ya14_price end),
		price_r=(case when @order_select = 'I' then @ya14_price else 0 end)
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	
	--주문마스터 Update
	update a set approve_flag = 'Y', approve_date = convert(char(08),getdate(),112)
	from EL_CD..T_VA_020 a
	where order_no=@order_no
	and part = 'CM'
	and substring(prod_no,12,1) in ('M','H')
	and run_status = '4'
	and (approve_flag is null or approve_flag < '0')


	if @ya14_price > 0
	begin
		declare	@project_no	varchar(11),
				@mfg_no	varchar(03),
				@part		varchar(02),
				@part_seq	varchar(04)

		select	@project_no=left(a.prod_no,11),
				@mfg_no=substring(a.prod_no,12,3),
				@part=a.part,
				@part_seq=a.part_seq
		from EL_CD..T_VA_020 a
		where order_no=@order_no

		update a set
			run_status=(case when isnull(a.run_status,'') < 'A' then 'A' else a.run_status end),
			run_date=getdate(),
			trade_no=@vendor
		from EL_CD..t_ca_011 a
		where 	a.project_no=@project_no
		and a.mfg_no=@mfg_no
		and a.part=@part
		and a.part_seq=@part_seq

		exec el_cd..S_EB_300_Packing_confirm_Subsidiary
			@project_no,@mfg_no,@part,@part_seq
	end

	select @status='0',@out_msg='Order Confirm OK ...';

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Purchasing_Order_Release_RB                                                                                                                                            */
/*  DISCRIPTION  :  주문집행 (오더별) - rolb 포함                                                                                                                    */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/04     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Common_Purchasing_Order_Release_RB]
	@gaijung	varchar(04),
	@order_no	varchar(08),
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON


begin tran Common_Purchasing_Order_Rel_ROLB

	exec SP_Common_Purchasing_Order_Release
		@gaijung,
		@order_no,
		@status		output,
		@out_msg	output

	if @status > '0'
		rollback tran Common_Purchasing_Order_Rel_ROLB
	else
		commit tran Common_Purchasing_Order_Rel_ROLB;

/********************************************************************************/
/*  SP NAME          : SP_Common_Rounting_EXPL									*/
/*  DESCRIPTION      : 제조 생산 계획 - 제조 상세 생성							*/
/*  RELATIVE_FORM    : mes_005,  MRP_TTF										*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/


create PROCEDURE [dbo].[SP_Common_Rounting_EXPL]
	@order_no	varchar(08),
	@stat		char(01)		output,
	@msg		varchar(50)	output
AS

SET NOCOUNT ON

	declare	@rout_type	varchar(05),
			@run_status	char(01)

	select @stat='0',@msg='OK(제조지시 생성)',@rout_type = null

	if not exists (select * from T_MYO_01 where order_no = @order_no)
	begin
		select @stat='4',@msg='Error(제조지시 NO 없음) '
		return
	end
	
	select @rout_type=rout_type,
		   @run_status=run_status
	from T_MYO_01
	where order_no = @order_no

	if @run_status > '0'
	begin
		select @stat='5',@msg='Error(제조지시 상태 에러)'
		return
	end

	if @rout_type < '0'
	begin
		select @stat='6',@msg='Error(제조지시 Rout_Type 미존재)'
		return
	end

	if not exists (select * from EL_CD..T_CX_630 where rout_type=@rout_type)
	begin
		select @stat='7',@msg='Rout-type('+@rout_type +') not found in Rout Master'
		return
	end

	
	begin tran Rounting_EXPL

	insert into T_MYO_11
	select	order_no=a.order_no
		,rout_seq=b.rout_seq
		,wc_code=b.wc_code
		,qty_finish=0
		,std_ready_time=b.ready_time
		,std_run_time=b.run_time*a.qty_ao
		,std_move_time=b.move_time
		,act_ready_time=0
		,act_run_time=0
		,act_move_time=0
		,date_start=NULL -- 미사용 필드
		,date_due=a.due_date
		,date_finish=NULL -- 미사용 필드
		,pre_rout_seq=b.prev_seq
		,next_rout_seq=b.next_seq
		,status='1'  
		,skp=b.skp_select
		,manage_point=b.manage_point
		,last_trans_no=0
		,work_mtd=b.work_mtd
		,start_time=NULL
		,end_time=NULL
		,update_date=NULL
		,update_user=NULL
		,entry_date=getdate()
	from T_MYO_01 a,EL_CD..T_CX_630 b
	where a.order_no = @order_no
	and b.rout_type = a.rout_type
	order by b.rout_seq desc



	update a set
		run_status='1',
--		rout_select='Y',
		last_ot_no=0 --, --(case when left(a.item_no,12) = substring(a.project_no,3,9)+mfg_no then 10 else 0 end) ,
--		date_ao=getdate()
	from T_MYO_01 a
	where order_no = @order_no

	IF @@ERROR = 0
	BEGIN
		COMMIT TRAN Rounting_EXPL
		select @stat='0',@msg='OK(제조지시 생성)'
	END
	ELSE
	BEGIN	
		ROLLBACK TRAN Rounting_EXPL
		select @stat='8',@msg='Error(제조지시 상세 생성 오류)'
	END

/*

	if @cnt = 0 
	begin
		select @stat='3',@msg='Bom Explosion error (자품목 없음)?? '
		return
	end
*/;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Sampling_For_Inspect                                                                                                                                                    */
/*  DISCRIPTION  : Sampling for Inspection common Module                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/15     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Sampling_For_Inspect]
	@item_no		varchar(15),
	@vendor			varchar(08),
	@gaijung		varchar(04),
	@qty			float,
	@insp_select	char(01),
	@insp_mtd		char(02)		output,
	@insp_level		char(02)		output,
	@insp_range		char(02)		output,
	@insp_advan		char(01)		output,
	@sample_qty		float			output,
	@acpt_qty		float			output,
	@reject_qty		float			output,
	@status			char(01)		output,
	@out_msg		varchar(100)	output

AS
SET NOCOUNT ON

	declare	@acpt_quality_level	float,
			@sampe_letter		char(01)

	
	select	@insp_level = '', @insp_range='',@insp_mtd='',
		@status='0',@out_msg='Sampling_For_Inspect OK...'

	if @insp_select <> 'Y'
	begin
		select @insp_mtd='NT',@insp_level='',@insp_range='',@insp_advan='',@sample_qty=0,@acpt_qty=0,@reject_qty=''
		return
	end

	if not exists (select *
		from T_MYA_151
		where item_no=@item_no
		and vendor=@vendor)
	begin
		insert into T_MYA_151
		select	item_no=@item_no,
				vendor=@vendor,
				insp_mtd=(case when @gaijung in ('SPSS','ELES') then 'SA' else 'NO' end),
				insp_level=(case when @gaijung in ('SPSS','ELES') then 'S3' else '' end),
				sample_times=1,
				insp_range=(case when @gaijung in ('SPSS','ELES') then 'NI' else '' end),
				acpt_quality_level=(case when @gaijung in ('SPSS','ELES') then 1.000 else 0 end),
				last_range=(case when @gaijung in ('SPSS','ELES') then 'NI' else '' end),
				insp_advan=(case when @gaijung in ('SPSS','ELES') then 'U' else '' end),
				date_insp_range=getdate(),
				date_mtd=getdate(),
				deliv_total=0,
				qty_lot_acpt=0,
				qty_lot_fail=0,
				qty_acpt_cont=0,
				qty_fail_cont=0,
				insp_cont_flag='',
				deliv_delay=0,
				amut_deliv=0,
				date_deliv=getdate(),
				date_order=0,
				qty_acpt_total=0,
				qty_return_total=0,
				date_entry=getdate(),
				date_update=getdate()
	end
		
      
	select	@insp_level = insp_level, @insp_range=insp_range,@insp_mtd=insp_mtd,
			@acpt_quality_level=acpt_quality_level,@insp_advan=insp_advan
	from T_MYA_151
	where item_no=@item_no
	and vendor=@vendor

	if @insp_mtd = 'AL'
	begin
		select @sample_qty=@qty
		return
	end

	if @insp_mtd <> 'SA'
	begin
		select @sample_qty=@qty
		return
	end

	select	@sample_qty = (case when @qty < sample_size then @qty else sample_size end),
			@acpt_qty=acpt_qty,@reject_qty=reject_qty
	from T_MYI_11 a
	where a.insp_range=@insp_range
	and a.sample_times = 1
	and a.acpt_quality_level = @acpt_quality_level
	and a.sample_letter = (select sample_letter
				from T_MYI_13 b
				where b.insp_level=@insp_level
				and  @qty between b.lot_size_from and b.lot_size_to)

/*
	if exists (select * from EL_CD..T_VA_040 where junpyo_no=@slip_no)
	begin
		update a set
			insp_mtd=@insp_mtd,
			qty_sample=@sample_qty,
			sample_fail=0,
			acpt=@acpt_qty,
			rjt=@reject_qty,
			insp_level=@insp_level,
			sample_times=1
		from EL_CD..T_VA_040 
		where junpyo_no=@slip_no
	end
*/
	if @sample_qty = 0
		select @status = '1',@out_msg='Sampling 정보가 없읍니다???';

/************************************************************************************************************/  
/*  SP NAME      : SP_Common_ShipItem_Regen                                                                 */  
/*  DISCRIPTION  : 구매발송 Regn by project_no,mfg_no,part,part_seq                                         */   
/*                                                                                                          */  
/*  >> MODIFICATION LOG <<                                                                                  */   
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                 */  
/*  ---------------------------------------------------------------                                         */  
/* 2010/01/15     MRP Downsizing Project   J.J.Park      Initialize                                         */
/* 2023-08-09          ITSR72315             UNGJ     거래선  VARCHAR(8)변경                                */
/* 2024-05-30          ITSR87255             UNGJ     자재 발주 Regen E(수출)도 D(내수), X(보수)와 동일 적용*/
/************************************************************************************************************/ 
CREATE PROCEDURE [dbo].[SP_Common_ShipItem_Regen]  
                  @job_id          varchar(30),  
                  @page            datetime,  
                  @project_no      varchar(11),  
                  @mfg_no          varchar(03),  
                  @part            char(02),  
                  @part_seq        varchar(04),  
                  @zr03_date_flag  char(01),  
                  @order_no        varchar(08),  
                  @user_id         varchar(10),  
                  @status          char(01) output,  
                  @out_msg         varchar(100) output  
AS  
SET NOCOUNT ON  
  
 declare @gaijung         varchar(04),  
         @Due_Date        varchar(08),  
         @curr_date       char(08),  
         @order_select    char(01),  
         @item_no         varchar(15),  
         @vendor          varchar(08),  
         @money_unit      varchar(03),  
         @product_code    varchar(03),  
         @market_flag     char(01),  
         @due_date_011    char(08),  
         @item_group_sub  varchar(10),  
         @cx_060_vendor   varchar(08),  
         @keep_flag       char(01),  
         @gss_apply_flag  char(01),  
         @temp_order_flag char(01)  
  
 select @curr_date = convert(char(08),getdate(),112)  
  
 select @gaijung=a.gaijung,@market_flag=a.market_flag,@item_no=a.item_no,  
        @order_select=(case when left(a.gaijung,2)='SY' and a.order_select = 'M' and a.out_factory_flag = 'S' and a.ship_flag = 'N'  
                        then 'D'  else  a.order_select  end),  
        @due_date_011=convert(char(08),a.Due_Date,112),  
        @item_group_sub=a.item_group_sub,  
        @temp_order_flag=temp_order_flag,  
        @product_code=product_code  
  from el_cd..t_ca_011 a  
 where a.project_no=@project_no  
   and a.mfg_no=@mfg_no  
   and a.part=@part  
   and a.part_seq=@part_seq  
  
        -- if @gaijung='SPSS'  
 if (@gaijung in ('SPSS','OSES') and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R'))  
         -- if (@gaijung='SPSS' and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R'))  
  select  @item_group_sub=isnull((select item_group_sub from el_cd..T_CX_060 where item_no=@item_no),'')  
    
 select @Due_Date=mrp.dbo.fn_Common_Due_Date_Set ( @job_id,@gaijung,@due_date_011,'',@market_flag,  
                                                   b.lead_time1,  b.lead_time2,  @curr_date),  
             --12월 26일부터 아래 적용  
             -- @vendor=isnull((case when (@gaijung='SPSS' and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R')) then b.vendor2 else b.vendor end),''),  
             -- @vendor=isnull((case when (@gaijung in ('SPSS','OSES') and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R')) then b.vendor2 else b.vendor end),''),  
             -- 수출건에 대하여  VENDOR가 2로 매핑되게 처리 관계로 변경 반영 함 (2024/05/30) ITSR87255
        @vendor=isnull((case when (@gaijung in ('SPSS','OSES') and @market_flag not in ('X','D','E')) then b.vendor2 else  b.vendor end),'') ,

             -- @vendor=isnull((case when @gaijung='SPSS' then b.vendor2 else b.vendor end),''),  
             --   @vendor=isnull(b.vendor,''),  
        @money_unit=(case when b.money_unit > '0' then b.money_unit else 'WON' end),  
             --   @cx_060_vendor=isnull((case when (@gaijung='SPSS' and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R')) then b.vendor2 else b.vendor end),''),  
        @cx_060_vendor=isnull((case when (@gaijung in ('SPSS','OSES') and @market_flag not in ('X','D') and not (@market_flag = 'E' and left(@mfg_no,1) = 'R')) then b.vendor2 else b.vendor end),''),  
             --   @cx_060_vendor=isnull((case when @gaijung='SPSS' then b.vendor2 else b.vendor end),''),  
             --   @cx_060_vendor=isnull(b.vendor,''),  
        @keep_flag=isnull(b.keep_flag,'')  
   from el_cd..t_cx_060 b  
  where b.item_no=@item_no  
  
  
			-- if @gaijung = 'ELES' or @gaijung = 'SPSS' and @temp_order_flag = 'S' --Set  
			-- if @gaijung = 'ELES' or @gaijung = 'SPSS' and (@temp_order_flag = 'S' or (@market_flag = 'X' and LEFT(@mfg_no,1) = 'R'))  
			-- if @gaijung = 'ELES' or (@gaijung = 'SPSS' and (@temp_order_flag = 'S' or @market_flag in ('X','D')  or (@market_flag = 'E' and left(@mfg_no,1) = 'R')))   
 if @gaijung = 'ELES' or (@gaijung in ('SPSS','OSES') and (@temp_order_flag = 'S' or @market_flag in ('X','D')  or (@market_flag = 'E' and left(@mfg_no,1) = 'R')))   
 begin  
   if @item_no in ('AEA01D447*A','AEA01D447*B','AEA01D447*C')  
   begin  
             --select @vendor='1088096'                 -- by sjm 10.10.12 requested by LJS  
                        /* 2024-05-30 거래처 반영 부분 삭제 처리    */
       select @vendor = ( SELECT  b.vendor  from el_cd..t_cx_060 b   where b.item_no=@item_no )   --20240530 반영 처리    
             --select @vendor='35024405'                -- 20240530 기존 방법 막음  -- by sjm 10.10.12 requested by LJS  
  end  
			  --else if @item_no in ('AEA27C180*E','AEA27C180*F','AEA27C180*G','AEA29C244*E','AEA29C244*F','AEA29C244*G','AEA26C182*E','AEA26C182*F','AEA26C182*G')   
			  --begin  
			  -- select @vendor='1182903'                -- by sjm 10.10.12 requested by LJS  
			  --end  
  else  
  begin  
   declare @temp varchar(9)  --char(08)  
   
   select @temp=mrp.dbo.fn_Common_PO_Vendor ( @project_no,@mfg_no,  @gaijung,@product_code,@market_flag,  
                                              @item_group_sub,@part,@cx_060_vendor)  
   
   select @gss_apply_flag=left(@temp,1),@vendor=substring(@temp,2,8)  
     
   if @gss_apply_flag = 'Y'  
      select @keep_flag='K'  
  end  
 end  
  
 if exists (select *  
              from EL_CD..T_VA_020  
             where order_no=@order_no)  
  begin  
      select @status='9',@out_msg='이미 존재하는 OrderNo 입니다????'  
      return  
   end  
  
 declare @ya14_price      float,  
         @ya14_matl_price float,  
         @ya14_date_apply char(08)  
   
 exec SP_Common_Price_Fetch  
                @item_no,  
                'A',            --*** price_sort ***  
                @vendor,   
                @order_select,   
                '',             --*** work_mtd  ***  
                @money_unit,  
                @curr_date,     --*** apply_date ***     
                'N',            --*** etc_apply_flag ***  
     
                @ya14_price       output,  
                @ya14_matl_price  output,  
                @ya14_date_apply  output,  
                @status           output,  
                @out_msg          output  

 if @status > '0'  
 begin  
     select @ya14_price=0,@status='0',@out_msg=''  
 end  
     
begin tran Common_ShipItem_Regen  
  
 insert into EL_CD..T_VA_020  
 select order_no=@order_no,  
        item_no=a.item_no,  
        Gaijung=(case when a.part='RA' then 'ELRA' else a.gaijung end),  
        supply=@order_select,  
        run_status=mrp.dbo.fn_Common_PO_Run_status(@gaijung,b.plan_post_person,a.part,@order_select,a.item_no,@vendor),  
        Due_Date=@Due_Date,  
        keep_flag=@keep_flag,  
        item_unit=isnull(b.item_unit,'EA'),  
        money_unit=(case when b.money_unit > '0' then b.money_unit else 'WON' end),  
        price=@ya14_price,  
        price_r=0,  
        qty_order=a.cont_qty,  
        qty_deliv=0,  
        qty_insp=0,  
        qty_acpt=0,  
        qty_input=0,  
        qty_cancel=0,  
        date_start=getdate(),  
        date_deliv=null,  
        date_chg=null,  
        po_status=(case when @curr_date  > @due_Date then 'P' else (case when @curr_date > @curr_date then 'E' else 'N' end) end),  
        date_delay=null,  
        insp_select='N',  --b.insp_select  
        pay_con='',  
        post_wc='',  
        prod_no=a.project_no+a.mfg_no,  
        lc_no='',  
        req=a.cont_qty,  
        ao_no='NONE',  
        date_po=getdate(),  
        post_person=isnull(b.plan_post_person,''),  
        date_last=null,  
        date_print_po=null,  
        trade_no=@vendor,  
        skp=(case when @order_select in ('S','X','Z') then @order_select else ' ' end),  
        po_post_person=isnull((case when @gaijung in ('ELES') then c.post+c.person else b.po_post_person end),''),  
        order_type=@curr_date,  
        etc_price=0,  
        last_ot_no=0,  
        po_gubun=(case when substring(a.project_no,5,1) = 'D' then '7'    
                       when left(a.mfg_no,1) in ( 'P','X','C','B') then '5'    
                            else (case when a.part = 'CM' then '4' else '1'   
                        end)  
                    end),  
              --   po_gubun=(case when left(a.mfg_no,1) in ( 'P','X','C','B') then '5' else (case when a.part = 'CM' then '4' else '1' end)end),  
        qty_reject=0,  
        issue_no='',  
        issue_last_no=0,  
        import_flag='',  
        market_flag=a.market_flag,  
        part_seq=a.part_seq,  
        part=a.part,  
        ship_flag=(case when a.treat_method = 'D' and a.cause_code = '@@' or ship_flag <> 'Y' then 'N' else 'Y' end),  
        draw_no=isnull(b.draw_no,''),  
        approve_flag='',  
        approve_date=null,  
        receipt_flag='',  
        receipt_date=null,  
        reject_flag='',  
        reject_date=null,  
        receipt_expect_no='',  
                                   --12월 26일부터 아래 적용  
        packing_vendor= case when left(a.mfg_no,1) = 'K' then ''   
                                 -- when (a.gaijung = 'SPSS' and a.market_flag in ('D','X') and a.part in ('CE','CS')) then '' --jjg 추가(1/1) SCE)Logistics 080-14-20 20140922  
                                -- when (a.gaijung in ('SPSS','ELES') and a.market_flag in ('D','X') and a.part in ('CE','CS')) then '' --jjg 추가(1/1) SCE)Logistics 080-14-20 20141208  
                            when (a.gaijung in ('SPSS','OSES','ELES') and a.market_flag in ('D','X') and a.part in ('CE','CS')) then '' --jjg 추가(1/1) SCE)Logistics 080-14-20 20141208  
                             else  
                                mrp.dbo.fn_Common_Packing_Vendor (a.gaijung,a.market_flag,a.product_code,@item_group_sub,a.part)  
                         end ,  
                        --packing_vendor= (case when @gaijung='ELES'  
                        --     then mrp.dbo.fn_Common_Packing_Vendor (   
                        --      a.gaijung,a.market_flag,a.product_code,@item_group_sub,a.part)  
                        --     else '' end),  
         '','','',creator=@user_id  
 from EL_CD..T_CA_011 a  
     left outer join EL_CD..T_CX_060 b  on b.item_no = a.item_no  
     left outer join EL_CD..T_CX_080 c  on c.trade_no=@vendor  
 where a.project_no=@project_no  
   and a.mfg_no=@mfg_no  
   and a.part=@part  
   and a.part_seq=@part_seq  
  
 if  @@rowcount = 0  
 begin  
    rollback tran Common_ShipItem_Regen  
    select @status='1',@out_msg='주문 Insert Error (' + @order_no + ') ???'  
    return  
 end  
  
 update y set     
      date_ao=@curr_date,  
      date_po=(case when y.date_po is null and @order_select in ('D','I','L') then @curr_date else y.date_po end),  
      upd_date=getdate(),  
      run_date=getdate(),  
      concern_order_no=@order_no,  
      concern_order_date=getdate(),  
      confirm_flag='A',  
      cause_code=(case when y.cause_code='@@' then '$$' else y.cause_code end),  
      trade_no=@vendor  
 from EL_CD..T_CA_011 y  
 where y.project_no=@project_no  
   and y.mfg_no=@mfg_no  
   and y.part=@part  
   and y.part_seq=@part_seq  
  
--주문집행  
 if left(@gaijung,2) <> 'SY'   
 begin  
  if exists ( select *  
               from EL_CD..T_VA_020   
              where order_no=@order_no  
                and run_status='3')  
   exec SP_Common_Purchasing_Order_Release  
                               @gaijung,  
                               @order_no,  
                               @status  output,  
                               @out_msg  output  
   
 end  
 else  
  select @status='0',@out_msg=' 발주 OK ..'  
    
 commit tran Common_ShipItem_Regen;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Sampling_For_Inspect                                                                  */
/*  DISCRIPTION  : Sampling for Inspection common Module                                                           */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #                  S.E NAME         DESCRIPTION                                            */
/*  ---------------------------------------------------------------------------------------------------------------*/
/* 2010/03/15     MRP Downsizing Project   J.J.Park      Initialize                                                */
/* 2023/05/03     ITSR68908                UNGJ          운반비 변동 적용 ( 매출시 적용율 재 계산 반영 )           */
/*******************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Shipping_by_ShipNo]
	@gaijung		varchar(04),
	@ship_no		varchar(12),
	@date_action	char(08),
	@status			char(01)		output,
	@out_msg		varchar(100)	output
AS
set nocount on

	declare @amt float

	declare	@project_no	varchar(11),
			@mfg_no		char(03),
			@part		char(02),
			@part_seq	char(04),
			@qty		real

	declare @claim_no		varchar(10),
			@claim_no_seq	tinyint,
			@abs_box_no		varchar(100),
			@error_code		smallint

	if not exists( select * from el_cd..t_ec_020 with (index=PK_T_EC_020_1__75 nolock) 
			where ship_no = @ship_no)
	begin
		select @status = '1' ,@out_msg = ' 출하할 전표 미존재 (' + @ship_no + ') ?????'
		return
	end

	if not exists( select * from el_cd..t_ec_020 with (index=PK_T_EC_020_1__75 nolock) 
			where ship_no = @ship_no and ship_status ='N')
	begin
		select @status = '1' ,@out_msg = ' 출하처리 할수 없는 전표입니다 ?????'
		return
	end

begin tran Common_Shipping_by_ShipNo

	DECLARE p_block SCROLL CURSOR FOR
		select 	project_no,	mfg_no,part,part_seq,qty
		from	el_cd..t_eb_050 with (index=IX_t_eb_050_5 nolock)		
		where 	ship_no = @ship_no
		order by project_no , mfg_no ,part,part_seq
	OPEN p_block

   	FETCH NEXT FROM p_block INTO @project_no,@mfg_no,@part,@part_seq,@qty

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec EL_CD..S_SUBUL_PROCESS @project_no,@mfg_no,1,@part,@part_seq,'R','A',@qty,0,@date_action,@ship_no

		FETCH NEXT FROM p_block INTO @project_no,@mfg_no,@part,@part_seq,@qty
	end
	CLOSE p_block
	DEALLOCATE p_block 

	update x set
		date_ship = @date_action,
		ibm_tx_flag ='Y'
	from el_cd..t_eb_050 x with (index=IX_t_eb_050_5 nolock)
	where	x.ship_no = @ship_no

	
	if substring(@ship_no,3,1) ='Z'	-- Claim
	begin
		--if @gaijung in ('ELES','SPSS')  -- META Project 
		if @gaijung <> 'SYHP'
		begin
				
			select 	a.claim_no,a.claim_no_seq,qty=sum(x.qty)
			into #claim_el
			from el_cd..t_eb_050 x with (index=IX_t_eb_050_5 nolock), el_cd..t_ed_011 a with (index=IX_T_ED_011_6)
			where	x.ship_no = @ship_no
			and	x.part ='CM'
			and	a.prod_no = x.project_no+x.mfg_no
			and	a.part between '' and 'ZZ'
			and	a.item_no_re = x.item_no
			and	a.part_seq = x.part_seq
			group by a.claim_no,a.claim_no_seq
						
			update a set
				qty_ship = (case when a.qty_ship is null 
													or a.qty_ship < a.qty_send_re 
												then isnull(a.qty_ship,0)+b.qty 
												else a.qty_ship end )			
			from el_cd..T_ED_011 a, #claim_el b
			where a.claim_no=b.claim_no
			and a.claim_no_seq=b.claim_no_seq
					
			update a set
				date_ship = case when qty_send_re = qty_ship then @date_action else a.date_ship end,
				ship_flag =case when qty_send_re = qty_ship then 'Y' else a.ship_flag end,
				date_update = convert(char(08),getdate(),112)
			from el_cd..t_eb_050 x with (index=IX_t_eb_050_5 nolock),el_cd..t_ed_011 a with (index=IX_T_ED_011_6)
			where	x.ship_no = @ship_no
			and	x.part ='CM'
			and	a.prod_no = x.project_no+x.mfg_no
			and	a.part between '' and 'ZZ'
			and	a.item_no_re = x.item_no
			and	a.part_seq = x.part_seq
			
		end
		--else -- 주차없음
		--begin
		
		--	select 	a.claim_no,a.claim_no_seq,qty=sum(x.qty)
		--	into #claim_ps
		--	from el_cd..t_eb_050 x with (index=IX_t_eb_050_5 nolock), el_cd..T_EE_011 a with (index=IX_T_EE_011_2)
		--	where	x.ship_no = @ship_no
		--	and	x.part ='CM'
		--	and	a.prod_no = x.project_no+x.mfg_no
		--	and	a.part between '' and 'ZZ'
		--	and	a.item_no_re = x.item_no
		--	and	a.part_seq = x.part_seq
		--	group by a.claim_no,a.claim_no_seq
			
		--	update a
		--	set	qty_ship = (case when a.qty_ship is null 
		--											or a.qty_ship < a.qty_send_re 
		--										then isnull(a.qty_ship,0)+b.qty 
		--										else a.qty_ship end )			
		--	from el_cd..T_EE_011 a, #claim_ps b
		--	where a.claim_no=b.claim_no
		--	and a.claim_no_seq=b.claim_no_seq		

		--	update a set
		--		date_ship = case when qty_send_re = qty_ship then @date_action else a.date_ship end,
		--		ship_flag =case when qty_send_re = qty_ship then 'Y' else a.ship_flag end,
		--		date_update = convert(char(08),getdate(),112)
		--	from el_cd..t_eb_050 x with (index=IX_t_eb_050_5 nolock),el_cd..T_EE_011 a with (index=IX_T_EE_011_2)
		--	where	x.ship_no = @ship_no
		--	and	x.part ='CM'
		--	and	a.prod_no = x.project_no + x.mfg_no
		--	and	a.part between '' and 'ZZ'
		--	and	a.item_no_re = x.item_no
		--	and	a.part_seq = x.part_seq
		--end
	end
	
	
/* pass data:pass-date,ship-status,ship-date update */
	update a	set 
		date_ship = @date_action,
		date_pass = @date_action,
		ship_status ='Y'
	from el_cd..t_ec_020 a with (index=PK_T_EC_020_1__75)
	where ship_no = @ship_no

/* ship_item(eb_050) ship-date update */
	update a set		
		date_ship = @date_action
	from el_cd..t_eb_050 a with (index=IX_t_eb_050_5)
	where	ship_no = @ship_no
	
	update a set		
		date_ship = @date_action
	from el_cd..t_eb_040 a with (index=IX_T_EB_040_4)
	where	ship_no = @ship_no

/* 운반비 회계일자(account-date)정보 update */


  update x set
		X.date_account=@date_action		
		/*  20230503  국내 운반비 적용시  작업 실수로 인한  회계일자 수정이 발생 할수 있는 관계로  매출 시점에 적용율과 금액을 재 세팅 한다. ( 최정학 소장님 ) */


	 , X.APPLY_YUL  =  ISNULL( (	SELECT ISNULL(T1.APPLY_YUL, 0 )           
									  FROM EL_CD.DBO.T_NZ_071 T1
									 WHERE T1.TRADE_NO            = X.TRADE_NO
									   AND ISNULL(T1.CONFIRM_EMPID,'')  !=  ''
									   AND T1.YYYYMMDD                   =  ( SELECT ISNULL(MAX(T.YYYYMMDD),'')
															                    FROM EL_CD.DBO.T_NZ_071 T
															                   WHERE T.TRADE_NO      =  X.TRADE_NO
																                 AND ISNULL(T.CONFIRM_EMPID,'')  !=  ''
																                 AND T.YYYYMMDD  <=  @date_action	 
																              ) 
								  ),100 )

    , X.AMT  =  ROUND(X.BASE_AMT * (ISNULL( (	SELECT ISNULL(T1.APPLY_YUL, 0 )           
									  FROM EL_CD.DBO.T_NZ_071 T1
									 WHERE T1.TRADE_NO            = X.TRADE_NO
									   AND ISNULL(T1.CONFIRM_EMPID,'')  !=  ''
									   AND T1.YYYYMMDD                   =  ( SELECT ISNULL(MAX(T.YYYYMMDD),'')
															                    FROM EL_CD.DBO.T_NZ_071 T
															                   WHERE T.TRADE_NO      =  X.TRADE_NO
																                 AND ISNULL(T.CONFIRM_EMPID,'')  !=  ''
																                 AND T.YYYYMMDD  <=  @date_action	 
																              ) 
								  ), 100 ) / 100 ), 0)

	from el_cd..t_ec_022  x with (index=PK_t_ec_022_1__75 )	
	where x.ship_no = @ship_no	  
	and x.cost1_flag between '0' and 'Z'
	and x.cost2_flag = 'C'
--	and (x.amt > 0 and @gaijung in('ELES','SPSS') or @gaijung ='SYHP')  -- META Project 
	and x.amt > 0


	update a set
		date_account=@date_action
	from el_cd..t_ec_022  a with (index=PK_t_ec_022_1__75 )
	where a.ship_no = @ship_no	  
	and a.cost1_flag between '0' and 'Z'	  
	and a.cost2_flag = 'A'
--	and (a.amt > 0 and @gaijung in('ELES','SPSS') or @gaijung ='SYHP')  -- META Project 
	and a.amt > 0

/* 해상운송비 set**********************/
	update a set
		date_account=convert(char(08),dateadd(dd,1,@date_action),112)
	from el_cd..t_ec_022 a with (index=PK_t_ec_022_1__75 )
	where a.ship_no = @ship_no
	and a.cost1_flag = 'B'
	and a.cost2_flag = 'D'
	and a.seq = 1
--	and ( amt > 0 AND @gaijung in('ELES','SPSS') OR @gaijung ='SYHP' )  -- META Project 
	and amt > 0

	select @status='0',@out_msg=' 출하처리 OK...'

	commit tran Common_Shipping_by_ShipNo;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Stock_Update                                                                                                                                                    */
/*  DISCRIPTION  : 입풀고에 따른 재고마스터와 월수불 마스터 Update Common Module                                                                                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/15     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE  PROCEDURE [dbo].[SP_Common_Stock_Update]
	@item_no		varchar(15),
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	char(01),
	@io_flag		char(01),	/* A:입고 B:출고 **/
 	@io_date		char(08),
	@io_qty			float,
	@io_amt 		float,
	@io_matl_amt	float,
	@result_amt		float			output,
	@status			char(01) 		output,
	@out_msg		varchar(100)	output

AS
SET NOCOUNT ON
/*

declare	@item_no	varchar(15),
	@gaijung	varchar(04),
	@store		varchar(06),
	@order_select	char(01),
	@io_flag		char(01),	-- A:입고 B:출고 
 	@io_date	char(08),
	@io_qty		float,
	@io_amt 		float,
	@io_matl_amt	float,
	@result_amt	float,
	@status		char(01),
	@out_msg	varchar(100)

select	@item_no	='AEA19C642*A',
	@gaijung	='ELES',
	@store		='WHELES',
	@order_select	='D',
	@io_flag		='A',
 	@io_date	='20100901',
	@io_qty		=2,
	@io_amt 		=200.0,
	@io_matl_amt	=0
--AEA27C736*A 처리중 Error, 재처리바람 ???

exec SP_Common_Stock_Update
	@item_no,
	@gaijung,
	@store,
	@order_select,
	@io_flag,
 	@io_date,
	@io_qty,
	@io_amt ,
	@io_matl_amt	,
	@result_amt	output,
	@status		output,
	@out_msg	output

select	@result_amt,
	@status,
	@out_msg

*/
 /***************************************************************

월수불시 재고가 있음년 익월 월별 자료가 선행 생성되어야 함 
년이월작업시 1월의 수량,금액을 년누계로 Setting

 * 재고　계산　SUBPROGRAM *
 * *
 * 1.입출고　최초，최종일자 SET *
 * 2.출고금액　없을시　일일이동평균법에　의해　계산 *
 * 3.현재고수량，금액　계산 *
 * 4.현재까지　입출고　수량，금액　누적 *
 * 5.월별　　　입출고　수량，금액　누적 *
 * 6.입출고　건수　증가 *
 * 7.입고시 단가 검증 *
 * 8.입출고일자와　수불마감일자와　비교검증 *
 ***************************************************************/

    -- 아래 5줄은 재물조사를 위해 사용함. 1.경리팀에서 재물조사 메일발송-> 2.조차장님승인-> 3.아래2줄(select줄,return줄) 주석풀고 입출고 불가하게 함. 2011.10.25

/*    
	if getdate() >= '20111026 08:00' and getdate() <= '20111027 08:00:00'
	begin
		select @status='1',@out_msg='재고실사 관계로 입출고 불가 ...'
		return
	end

	if getdate() >= '20141025 00:00:00' and getdate() <= '20141028 00:00:00'
	begin
		select @status='1',@out_msg='재고실사 관계로 입출고 불가 ...'
		return
	end
	
	if getdate() >= '20141025 00:00:00' and getdate() <= '20141030 00:00:00' and @gaijung = 'SYHP'
 	begin
		select @status='1',@out_msg='재고실사 관계로 입출고 불가 ...'
		return
	end
*/	
	
--	if getdate() >= '20171025 17:30:00' and getdate() <= '20171026 23:59:00'
--	if getdate() >= '20181025 21:00:00' and getdate() <= '20181026 23:59:00'
--	if getdate() >= '20191025 17:30:00' and getdate() <= '20191029 00:01:00'
--	if getdate() >= '20201024 12:30:00' and getdate() <= '20201026 15:00:00'
--	if getdate() >= '20211025 17:00:00' and getdate() <= '20211026 15:00:00'
--  if getdate() >= '20221025 17:00:00' and getdate() <= '20221026 15:00:00'
--    if getdate() >= '20231025 17:00:00' and getdate() <= '20231026 15:00:00'--20231025 KDG
	if getdate() >= '20241025 17:00:00' and getdate() <= '20241028 15:00:00'--20241025_KDG
	begin
		select @status='1',@out_msg='재고실사 관계로 입출고 불가 ...'
		return
	end


	declare	@a_amt_sum	float
 
	declare	@year_month			varchar(06),
			@zra1_price_option	char(01),
			@zra1_account_opt	char(01),
			@zra1_close_month	char(06),
			@next_from_date		char(08),
			@next_to_date		char(08)

	declare	@Curr_amt_trans			float,
			@Curr_qty_trans			float,
			@Curr_amt_input			float,
			@Curr_qty_input			float,
			@Curr_amt_output		float,
			@Curr_qty_output		float,
			@Curr_amt_stock			float,
			@Curr_qty_stock			float,
			@Curr_amt_stock_save	float,
			@Curr_qty_stock_save	float,
			@Curr_price_avg			float,
			@Curr_date_price_avg	smalldatetime,
			@Curr_date_first_output	smalldatetime,
			@Curr_date_last_output	smalldatetime,
			@Curr_date_first_input	smalldatetime,
			@Curr_date_last_input	smalldatetime

	declare	@Month_qty_trans		float,
			@Month_amt_trans		float,
			@Month_qty_input		float,
			@Month_amt_input		float,
			@Month_qty_output		float,
			@Month_amt_output		float,
			@Month_qty_stock		float,
			@Month_amt_stock		float,
			@Month_qty_stock_save	float,
			@Month_amt_stock_save	float,
			@Month_price_avg		float

	exec SP_Common_Information_ZRA1 
		@gaijung,@store,@order_select,@io_date,
		@zra1_price_option	output,
		@zra1_account_opt	output,
		@zra1_close_month	output,
		@next_from_date		output,
		@next_to_date		output,
		@status				output,
		@out_msg			output

	
	if @status > '0'
		return

	if @next_from_date  > @io_date 
	begin
		select @status='1',@out_msg=@item_no + ' 당월수불마감됨 ???'
		return
	end

	 
 	if @io_flag = 'A' and @zra1_price_option = 'N' and @io_amt+ @io_matl_amt = 0 and  @io_qty > 0
	begin
		select @status= '2',@out_msg= @item_no + ' 입고금액이 ZEROS입니다 ???'
		return
	end

	select	@year_month=master.dbo.fGetAccountMonthOfDate(@io_date)

	if not exists (select *
		from T_MVA_061 a with (index=PK_T_MVA_061 nolock)
		where item_no = @item_no
		and gaijung = @gaijung
		and store = @store
		and order_select = @order_select)
	begin	
		if exists (select *
			from T_MVA_061_year a with (index=PK_T_MVA_061_Year nolock)
			where item_no = @item_no
			and gaijung = @gaijung
			and store = @store
			and order_select = @order_select)
		begin
			insert into mrp..T_MVA_061
			select	a.item_no,
					a.gaijung,
					a.store,
					a.order_select,
					qty_trans=0,
					amt_trans=0,
					qty_input=0,
					amt_input=0,
					qty_output=0,
					amt_output=0,
					qty_stock=0,
					amt_stock=0,
					a.price_avg,
					a.date_price_avg,
					a.date_first_input,
					a.date_last_input,
					a.date_first_output,
					a.date_last_output,
					a.post_person
			from T_MVA_061_year a with (index=PK_T_MVA_061_Year nolock)
			where a.item_no = @item_no
			and a.gaijung = @gaijung
			and a.store = @store
			and a.order_select = @order_select
			and a.year=(select max(b.year)
					from T_MVA_061_year b with (index=PK_T_MVA_061_Year nolock)
					where b.item_no = a.item_no
					and b.gaijung = a.gaijung
					and b.store = a.store
					and b.order_select = a.order_select)
		end
		else
		begin
			insert into mrp..T_MVA_061
			select	item_no=@item_no,
					gaijung=@gaijung,
					store=@store,
					order_select=@order_select,
					qty_trans=0,
					amt_trans=0,
					qty_input=0,
					amt_input=0,
					qty_output=0,
					amt_output=0,
					qty_stock=0,
					amt_stock=0,
					price_avg=0,
					date_price_avg=null,
					date_first_input=null,
					date_last_input=null,
					date_first_output=null,
					date_last_output=null,
					post_person=''
		end
	end

	if not exists (select *
		from T_MVA_060 (nolock)
		where item_no = @item_no
		and gaijung = @gaijung
		and store = @store
		and order_select = @order_select
		and year_month = @year_month)
	begin	
		if not exists (select *
				from T_MVA_060 (nolock)
				where item_no = @item_no
				and gaijung = @gaijung
				and store = @store
				and order_select = @order_select
				and year_month < @year_month)
		begin	
			insert into T_MVA_060
			select	item_no=@item_no,
					gaijung=@gaijung,
					store=@store,
					order_select=@order_select,
					year_month=@year_month,
					qty_trans=0,
					amt_trans=0,
					qty_input=0,
					amt_input=0,
					qty_output=0,
					amt_output=0,
					qty_stock=0,
					amt_stock=0,
					price_avg=0
		end
		else
		begin
--*** 당월자료가 없으면 가까운 전월 재고를 당월에 Setting ***
	
			insert into T_MVA_060
			select	item_no,
					gaijung,
					store,
					order_select,
					year_month=@year_month,
					qty_trans=a.qty_stock,
					amt_trans=a.amt_stock,
					qty_input=0,
					amt_input=0,
					qty_output=0,
					amt_output=0,
					qty_stock=a.qty_stock,
					amt_stock=a.amt_stock,
					price_avg
			from T_MVA_060 a
			where a.item_no=@item_no
			and a.gaijung=@gaijung
			and a.store=@store
			and a.order_select=@order_select
			and a.year_month = (select max(b.year_month)
								from T_MVA_060 b
								where b.item_no=@item_no
								and b.gaijung=@gaijung
								and b.store=@store
								and b.order_select=@order_select
								and b.year_month < @year_month)
		end
	end

	
--**** 현재고 Read ****

	select	@Curr_qty_trans=qty_trans,
			@Curr_amt_trans=amt_trans,
			@Curr_qty_input=qty_input,
			@Curr_amt_input=amt_input,
			@Curr_qty_output=qty_output,
			@Curr_amt_output=amt_output,
			@Curr_qty_stock=qty_stock,
			@Curr_amt_stock=amt_stock,	
			@Curr_price_avg=price_avg,
			@Curr_date_price_avg=date_price_avg,
			@Curr_date_first_input=date_first_input,
			@Curr_date_last_input=date_last_input,
			@Curr_date_first_output=date_first_output,
			@Curr_date_last_output=date_last_output
	from T_MVA_061 
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select

	
	if @Curr_qty_stock + (case when @io_flag = 'A' then @io_qty else 0-@io_qty end) < 0
	begin
 		select @status='3',@out_msg=@item_no + ' 현재고수량이 부족합니다 ???'
		return
	end

	--if @io_flag = 'A'  
	--begin
	--	--if	@Curr_amt_stock + @io_amt < 0
	--	--begin
	-- --		select @status='3',@out_msg=@item_no + ' 현재고금액이 부족합니다 ???'
	--	--	return
	--	--end
	--	--else
	--	if @Curr_qty_stock + @io_qty = 0 and @Curr_amt_stock + @io_amt <> 0
	--	begin
	-- 		select @status='4',@out_msg=@item_no + ' 재고수량 0,재고금액이 남습니다???'
	--		return
	--	end
	--end



--*** 당월 Read ***
	
	select	@Month_qty_trans=qty_trans,	@Month_amt_trans=amt_trans,	
			@Month_qty_input=qty_input,	@Month_amt_input=amt_input,	
			@Month_qty_output=qty_output,	@Month_amt_output=amt_output,	
			@Month_qty_stock=qty_stock,	@Month_amt_stock=amt_stock,	
			@Month_price_avg=price_avg
	from T_MVA_060 
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	and year_month = @year_month


 	
	if @Month_qty_stock + (case when @io_flag = 'A' then @io_qty else 0-@io_qty end) < 0
	begin
 		select @status='3',@out_msg=@item_no + ' 월재고수량이 부족합니다 ???'
		return
	end
	
	--if @io_flag = 'A'  and @io_amt < 0
	--begin
	--	--if @Month_qty_output <> 0
	--	--begin
	--	--	if @Month_amt_trans + @Month_amt_input + @io_amt < 0
	--	--	begin
	--	-- 		select @status='3',@out_msg=@item_no + ' 월재고금액이 부족합니다 ???'
	--	--		return
	--	--	end
	--	--end
	--	--else
	--	begin
	--		if @Month_amt_stock + @io_amt < 0
	--		begin
	--	 		select @status='3',@out_msg=@item_no + ' 월재고금액이 부족합니다 ???'
	--			return
	--		end
	--	end
	--end

	select @Curr_qty_stock_save=@Curr_qty_stock,	@Curr_amt_stock_save=@Curr_amt_stock
	select @month_qty_stock_save=@month_qty_stock,	@month_amt_stock_save=@month_amt_stock


	declare	@temp_amt	float

	select @temp_amt=0


	 if @io_flag= 'A'  --***입고 ***
	begin
	
		select @a_amt_sum = @io_amt+ @io_matl_amt
	

		-- Current (input all)
		select	@Curr_qty_input=@Curr_qty_input + @io_qty,
			@Curr_amt_input=@Curr_amt_input +@a_amt_sum

		-- Monthly (input all)
		select	@Month_qty_input=@Month_qty_input + @io_qty 
		select	@Month_amt_input= @Month_amt_input + @a_amt_sum

		-- Current (stock qty)
		select	@Curr_qty_stock=@Curr_qty_stock + @io_qty
		-- Monthly (stock all)
		select	@Month_qty_stock=@Month_qty_stock + @io_qty


		if @Month_qty_stock = 0 and @Month_amt_stock + @a_amt_sum <> 0
		begin
			select @temp_amt=@Month_amt_stock + @a_amt_sum
		-- Monthly (out amt)
			select @Month_amt_output = @Month_amt_output + @temp_amt
		-- current (out amt)
			select @curr_amt_output = @curr_amt_output + @temp_amt
		end
			

		-- Monthly (stock amt)
		select	@Month_amt_stock=@Month_amt_stock + @a_amt_sum - @temp_amt
		-- Current (stock amt)
		select	@Curr_amt_stock=@Curr_amt_stock + @a_amt_sum - @temp_amt


		if @Curr_qty_stock > 0 and @Curr_amt_stock > 0
		begin
			select @Curr_price_avg = (@Curr_amt_stock) / (@Curr_qty_stock)
			select @Curr_date_price_avg=getdate()
		end
	
	
		if @Month_qty_stock > 0 and @Month_amt_stock > 0
			select @Month_price_avg = (@Month_amt_stock) / (@Month_qty_stock)
		
		if @Curr_date_first_input is null
			select @Curr_date_first_input= @io_date
		
		if @Curr_date_last_input is null or @Curr_date_last_input < @io_date
			select @Curr_date_last_input= @io_date
	end
	else	/** 출고 **/
	begin
		-- Current (stock qty)
		select @Curr_qty_stock = @Curr_qty_stock - @io_qty

		-- Monthly (stock qty)
		select @Month_qty_stock = @Month_qty_stock - @io_qty

		IF @io_amt= 0
		begin
			IF @Month_qty_stock = 0
				select @result_amt=@Month_amt_stock
			else
				select @result_amt= @Month_amt_stock - round(@Month_qty_stock * @Month_price_avg,0)
		end
		else
			select	@result_amt=@io_amt

		-- Current (stock amt)
		select	@Curr_amt_stock=@Curr_amt_stock - @result_amt
		-- monthly (stock amt)
		select	@Month_amt_stock=@Month_amt_stock - @result_amt
	
		-- Current (output all)
		select @Curr_qty_output=@Curr_qty_output + @io_qty
		select @Curr_amt_output=@Curr_amt_output + @result_amt
		
		-- monthly (output all)
		select @Month_qty_output=@Month_qty_output + @io_qty 
		select @Month_amt_output=@Month_amt_output + @result_amt

		if @Curr_date_first_output is null
			select @Curr_date_first_output=@io_date
		
		if @Curr_date_last_output is null or @Curr_date_last_output < @io_date
			select @Curr_date_last_output=@io_date
	end


	update a set
		qty_input=@Curr_qty_input,
		amt_input=@Curr_amt_input,
		qty_output=@Curr_qty_output,
		amt_output=@Curr_amt_output,
		qty_stock=@Curr_qty_stock,
		amt_stock=@Curr_amt_stock,
		price_avg=@Curr_price_avg,
		date_price_avg=@Curr_date_price_avg,
		date_first_input=@Curr_date_first_input,
		date_first_output=@Curr_date_first_output,
		date_last_input=@Curr_date_last_input,
		date_last_output=@Curr_date_last_output
	from mrp..T_MVA_061 a
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	and amt_stock=@Curr_amt_stock_save
	and qty_stock=@Curr_qty_stock_save

	if @@rowcount = 0
	begin
 		select @status='4',@out_msg=@item_no + ' 처리중 Error, 재처리바람 ???'
		return
	end

	update a set
		qty_trans=@Month_qty_trans,
		amt_trans=@Month_amt_trans,	
		qty_input=@Month_qty_input,
		amt_input=@Month_amt_input,	
		qty_output=@Month_qty_output,
		amt_output=@Month_amt_output,
		qty_stock=@Month_qty_stock,
		amt_stock=@Month_amt_stock,	
		price_avg=@Month_price_avg
	from T_MVA_060 a
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	AND year_month = @year_month
	and qty_stock = @Month_qty_stock_save
	and amt_stock = @Month_amt_stock_save


	if @@rowcount = 0
	begin
		select @status='5',@out_msg='월별 처리중, 시스템 이상 ???'
		return
	end

	update a set
		qty_trans=a.qty_trans  + (case when @io_flag = 'A' then @io_qty else 0.0-@io_qty end),
		amt_trans=a.amt_trans+ (case when @io_flag = 'A' then @a_amt_sum-@temp_amt else 0-@result_amt end),
		qty_stock=a.qty_stock  + (case when @io_flag = 'A' then @io_qty else 0.0-@io_qty end),
		amt_stock=a.amt_stock + (case when @io_flag = 'A' then @a_amt_sum-@temp_amt else 0-@result_amt end)
	from T_MVA_060 a
	where item_no = @item_no
	and gaijung = @gaijung
	and store = @store
	and order_select = @order_select
	AND year_month > @year_month
		
	select @status='0',@out_msg='Stock_Update OK ..';

--sp_find_str SP_Common_Subul_Update

/*******************************************************************************************************************/
/*  SP NAME      : SP_Common_Subul_Update                                                                                                                                                    */
/*  DISCRIPTION  : 수불대장 정보 Update & Log 생성 Common Module                                                                                                           */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/15     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/
--sp_find_str SP_Common_Subul_Update
CREATE PROCEDURE [dbo].[SP_Common_Subul_Update]
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		char(02),
	@part_seq	varchar(04),
	@run_status	char(01),	
	@io_qty		float,
	@proc_date	char(08),
	@proc_qty	float	output

AS
SET NOCOUNT ON

	--이재상 요청 20100928
	--select @proc_qty=(case when a.cont_qty <= a.prod_qty then 0 
	--			else (case when a.cont_qty - a.prod_qty > @io_qty 
	--				then  @io_qty
	--				else a.cont_qty - a.prod_qty end)
	--			end)
	--from el_cd..t_ca_011 a
	--where project_no=@project_no
	--and mfg_no=@mfg_no
	--and part=@part
	--and part_seq=@part_seq
	
	select @proc_qty=@io_qty

	exec EL_CD..S_SUBUL_PROCESS @project_no,@mfg_no,1,@part,@part_seq,
		@run_status	,
		'A',		-- A:매출 B:취소
		@io_qty		,
		0,		--amt
		@proc_date	,
		''		--@remark;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Va020_Inquiry                                                                                                                                              */
/*  DISCRIPTION  :  주문 조회                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/06/16     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Va020_Inquiry]
	@type		varchar(02),	--1:
	@order_no	varchar(08)
AS

--SP_MRP_8AA_1 'S',''
--exec SP_Common_Va020_Inquiry '1','0A410600'
set nocount on

	if @type = '1' --SP_MRP_6QJ_1
	begin
		SELECT  a.order_no,
				a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		
				a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				price=(case when a.supply = 'I' then a.price_r else a.price end),
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
	 			a.approve_flag,								--승인여부	추가 20040620
	 			approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
	 			a.receipt_flag,								--접수여부	추가 20040620
	 			receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
	 			a.receipt_expect_no,						--납품예정번호		추가 20040620
	 			box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
	 			--insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				a.insp_select,
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''  ),
				box_no=isnull(a.box_no,''),
				amt=(case when a.supply = 'I' then a.price_r else a.price end)*a.qty_order,
				a.qty_insp,
				a.post_person,
				a.po_post_person,
				creator=master.dbo.fGetUserName(a.creator),
				item_group_sub = (select (case when charindex('-',d.item_group_sub) > 0 
								then left(d.item_group_sub,charindex('-',d.item_group_sub)-1)
								else d.item_group_sub end)
								from el_cd..t_ca_011 d
								where d.project_no = left(a.prod_no,11)
								and d.mfg_no = substring(a.prod_no,12,3)
								and d.part = a.part
								and d.part_seq = a.part_seq)
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end
	else if @type = '2'
	begin	
		SELECT  A.ORDER_NO,
				a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		
				a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
 				a.approve_flag,								--승인여부	추가 20040620
 				approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
 				a.receipt_flag,								--접수여부	추가 20040620
 				receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
 				a.receipt_expect_no,						--납품예정번호		추가 20040620
 				box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
 				insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor)  from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no ),''),
				box_no=isnull(a.box_no,''),
				amt=a.price*a.qty_order,
				a.qty_insp
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	END
	else if @type = '3'
	begin	
		SELECT  a.order_no,
				a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		
				a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
 				a.approve_flag,								--승인여부	추가 20040620
 				approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
 				a.receipt_flag,								--접수여부	추가 20040620
 				receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
 				a.receipt_expect_no,						--납품예정번호		추가 20040620
 				box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
 				insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''),
				box_no=isnull(a.box_no,''),
				amt=a.price*a.qty_order,
				a.qty_insp
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end
	else if @type = '4'
	begin	
		SELECT  a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
 				a.approve_flag,								--승인여부	추가 20040620
 				approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
 				a.receipt_flag,								--접수여부	추가 20040620
 				receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
 				a.receipt_expect_no,						--납품예정번호		추가 20040620
 				box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
 				insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''),
				box_no=isnull(a.box_no,''),
				amt=a.price*a.qty_order,
				a.qty_insp
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end	
--exec mrp.dbo.SP_Common_Va020_Inquiry '5',@order_no
	else if @type = '5'
	begin
		SELECT  a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		
				a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
	 			a.approve_flag,								--승인여부	추가 20040620
	 			approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
	 			a.receipt_flag,								--접수여부	추가 20040620
	 			receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
	 			a.receipt_expect_no,						--납품예정번호		추가 20040620
	 			box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
	 			insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''),
				box_no=isnull(a.box_no,''),
				amt=a.price*a.qty_order,
				a.qty_insp
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end
	else if @type = '6'
	begin
		SELECT  a.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.prod_no,
				a.qty_order,		
				a.qty_deliv,
				a.qty_acpt,
				a.qty_input,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_acpt-a.qty_reject,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_chg=convert(CHAR(08),a.date_chg, 112),
				date_last=convert(CHAR(08),a.date_last, 112),
				date_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				a.run_status,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				a.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
 				a.approve_flag,								--승인여부	추가 20040620
 				approve_date=convert(CHAR(08),a.approve_date, 112),	--승인일자	추가 20040620
 				a.receipt_flag,								--접수여부	추가 20040620
 				receipt_date=convert(CHAR(08),a.receipt_date, 112),		--접수일자	추가 20040620
 				a.receipt_expect_no,						--납품예정번호		추가 20040620
 				box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
						then a.box_receipt_expect_no
						else isnull((select max(c.receipt_expect_no) 
							from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
							where b.project_no=left(a.prod_no,11)
							and b.mfg_no=substring(a.prod_no,12,3)
							and b.part=a.part
							and b.part_seq=a.part_seq
							and b.ref_project_no < '0'
							and c.project_no=b.project_no	
							and c.mfg_no=b.mfg_no
							and c.box_no=b.box_no
							and c.divide_seq = b.divide_seq
							and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
 				insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = a.ship_flag,	--발송구분		추가 20040716
				part = a.part+a.part_seq,
				po_vendor=isnull(a.trade_no,''),
				po_brief_trade=master.dbo.fGetVendorName(a.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no ),''),
				box_no=isnull(a.box_no,''),
				amt=a.price*a.qty_order,
				a.qty_insp
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end
	else if @type = '7'
	begin
		select	a.*,
				qty_queue=a.qty_deliv-a.qty_input-a.Qty_reject,
				qty_balance=a.qty_order-a.qty_cancel-(a.qty_deliv-a.qty_reject),
				prod_no_all=a.prod_no+'/' + a.part+'/'+a.part_seq,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				curr_date=convert(char(08),getdate(),112),
				mold_flag=isnull((select c.mold_flag from EL_CD..T_CX_060 c where c.item_no=a.item_no),'')
		from EL_CD..T_VA_020 a
		where a.order_no = @order_no
	end
	else if @type = '8'
	begin
		select ''
	end
	else if @type = '9'
	begin
		select ''
	end
	else if @type = '10'
	begin
		select ''
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Common_Va040_Inquiry                                                                                                                                              */
/*  DISCRIPTION  :  입고  전표 조회                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/06/16     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Common_Va040_Inquiry]
	@flag		char(01),	--1:
	@slip_no	varchar(13)
AS

--SP_MRP_8AA_1 'S',''
--SP_MRP_8AA_1 '2I08100600001'
set nocount on

	if @flag = '1'
	begin
		SELECT  b.item_no,
				b.trade_no,
				eng_desc=master.dbo.fGetItemDesc(b.item_no),
				prod_no=a.prod_no+a.part+a.part_seq,
				a.qty_order,		
				b.qty_deliv,
				b.qty_acpt,
				b.qty_fail,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_insp,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_insp=convert(CHAR(08),b.date_insp, 112),
				date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
				date_modif=convert(CHAR(08),b.date_modif, 112),
				date_print_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv='20'+substring(b.junpyo_no,3,6),
				b.run_status,
				b.store,
				b.file_no,
				b.post_person,
				wh_post_person='',
				b.wc_code,
				a.po_gubun,
				a.gaijung,
				a.supply,
				b.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
	 			insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
				ship_flag = case when a.ship_flag = 'Y' then '출하' else '양산' end	,	--발송구분		추가 20040716
				brief_trade=master.dbo.fGetVendorName(b.trade_no),
				b.qty,
				b.amut,
				b.price_won,
				b.price_foreign,
				b.amut_won,
				b.amut_foreign,
				b.qty_insp,
				b.order_no,
				b.amut_mold,
				b.appl_mold_qty,
				date_decision=convert(CHAR(08),(case when c.date_decision is null then b.date_insp else c.date_decision end), 112),
				curr_date=convert(char(08),getdate(),112),
				creator=master.dbo.fGetUserName(b.creator)		
		FROM el_cd.dbo.T_va_040 b	
				inner join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.junpyo_no=b.junpyo_no
		WHERE b.junpyo_no = @slip_no 
	end;

CREATE PROCEDURE dbo.sp_creatediagram
	(
		@diagramname 	sysname,
		@owner_id		int	= null, 	
		@version 		int,
		@definition 	varbinary(max)
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
	
		declare @theId int
		declare @retval int
		declare @IsDbo	int
		declare @userName sysname
		if(@version is null or @diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID(); 
		select @IsDbo = IS_MEMBER(N'db_owner');
		revert; 
		
		if @owner_id is null
		begin
			select @owner_id = @theId;
		end
		else
		begin
			if @theId <> @owner_id
			begin
				if @IsDbo = 0
				begin
					RAISERROR (N'E_INVALIDARG', 16, 1);
					return -1
				end
				select @theId = @owner_id
			end
		end
		-- next 2 line only for test, will be removed after define name unique
		if EXISTS(select diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @diagramname)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end
	
		insert into dbo.sysdiagrams(name, principal_id , version, definition)
				VALUES(@diagramname, @theId, @version, @definition) ;
		
		select @retval = @@IDENTITY 
		return @retval
	END;

/*************************************************************************************
 *
 * 	Down_100 : old:SP_Down_Not_receiving_matl_STD)
 *
 * DISCRIPTION		: 기간별 미입고 재료비
 *
 * RELATIVE_FORM	: F_EE_370
 *
 * CREATE_SE		: 김영민
 *
 * CREATE_DAY		: 2009년 12월 08일
 *
 * MODIFICATION_LOG
 *
 *  VER	DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	--------------------	---------     ---------------
 *  1.0	2009-12-08				김영민	       기간별 미입고 재료비
 *  2.0 20100129			국내 전체주문대상으로 수정, 도입/하이젠 추가	
 *  2.1 2023-08-08                 UNGJ         거래선  VARCHAR(8)변경    
 **************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_100]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)		output,
	@out_msg	varchar(100)	output
as
set nocount on

/*

declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_100 'Down_100','2013-08-13 11:00:42.683',@status output,@out_msg output

select @status,@out_msg
*/

--- JJG 수정 Start 프로그램 검증 필요----

select @status='0',@out_msg=' Down stop '
return 

--- JJG 수정 End ----


	declare	@flag		char(01), --1 : 국내품 미입고(주문)
				                  --2 : 도입품 미입고(원가재료비조인)
				                  --3 : 하이젠 모터 미입고(원가재료비조인)
			@from_date		varchar(08),
			@to_date		varchar(08),
			@cnt			int

	select @cnt=0


	select	@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
			@to_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate')


	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	create TABLE [#TEMP_cos01] (
		[project_no] [char] (11)   NOT NULL ,
		[mfg_no] [char] (3)   NOT NULL ,
		[hogi] [smallint] NOT NULL ,
		[part] [char] (2)   NOT NULL ,
		[part_seq] [char] (4)   NOT NULL ,
		[item_no] [char] (15)   NOT NULL ,
		[due_date] [datetime] NOT NULL ,
		[product_code] [char] (2)   NOT NULL ,
		[market_flag] [char] (1)   NOT NULL ,
		[order_select] [char] (1)   NOT NULL ,
		[item_group_sub] [char] (10)   NULL ,
		[block] [char] (1)   NULL ,
		[mp_flag] [char] (1)   NULL ,
		[concern_order_no] [char] (13)   NULL ,
		[concern_order_date] [datetime] NULL ,
		[cont_qty] [real] NOT NULL ,
		[cont_cost] [float] NOT NULL ,
		[cont_amt] [float] NOT NULL ,
		[last_in_date] [datetime] NULL ,
		[last_out_date] [datetime] NULL ,
		[ao_time] [real] NOT NULL ,
		[run_status] [char] (1)   NOT NULL ,
		[run_date] [datetime] NOT NULL ,
		[temp_order_flag] [char] (1)   NOT NULL ,
		[temp_order_cfrm_date] [datetime] NULL ,
		[upd_date] [datetime] NULL ,
		[draw_cfm_date] [datetime] NULL ,
		[sale_qty] [float] NOT NULL ,
		[trade_no] [VARCHAR] (8)   NULL ,
		[plan_due_date] [datetime] NULL ,
		[cfrm_date] [datetime] NULL ,
		[deliv_date] [datetime] NULL ,
		[out_date] [datetime] NULL ,
		[matl_post_person] [char] (4)   NULL ,
		[po_post_person] [char] (4)   NULL ,
		[wh_post_person] [char] (4)   NULL ,
		[ship_post_person] [char] (4)   NULL ,
		[rslt_date] [datetime] NULL ,
		[confirm_flag] [char] (1)   NULL ,
		[ship_flag] [char] (1)   NULL ,
		[vbox_code] [char] (2)   NULL ,
		[box_no] [char] (2)   NULL ,
		[out_factory_flag] [char] (1)   NULL ,
		[treat_method] [char] (1)   NULL ,
		[packing_confirm_date] [datetime] NULL ,
		[prod_qty] [float] NULL ,
		[date_ao] [datetime] NULL ,
		[date_po] [datetime] NULL ,
		[date_kit] [datetime] NULL ,
		[cause_code] [char] (2)   NULL ,
		[prod_amt] [float] NULL ,
		[sale_amt] [float] NULL ,
		[management_flag] [char] (1)   NULL ,
		[giho_draw_flag] [char] (1)   NULL ,
		[select_draw_flag] [char] (1)   NULL ,
		[amt_divide_flag] [char] (1)   NULL ,
		[add_vbox_code] [char] (2)   NULL ,
		[drawlastupdate] [char] (10)   NULL ,
		[part_pdm] [char] (2)   NULL ,
		[gaijung] [varchar] (4)   NULL ,
		[wip_qty] [real] NOT NULL 
	) 

	
	declare	@year		varchar(4),
			@yearmonth	varchar(6)

	select 	@year = left(@to_date,4),
			@yearmonth = left(@to_date,6)

--국내품 미입고(주문)
	-- 미입고 List
	select x.order_no ,a.last_out_date
	into #tempaaaa
	from	(select project_no=left(b.prod_no,11), mfg_no=right(b.prod_no,3), b.part, b.part_seq, b.order_no
			from EL_CD..t_va_020 b with(index=ix_t_va_020_8 nolock)
			where b.run_status between '' and '4') x,
		el_cd..t_ca_011 a with (nolock)
	where x.project_no>'0'
	and a.project_no=x.project_no
	and a.mfg_no=x.mfg_no
	and a.mfg_no not like 'K%'
	and a.part=x.part
	and a.part <> 'CM'
	and a.cont_qty<>0
	and a.part_seq=x.part_seq
	and a.order_select not in ('A','M')
	and a.last_out_date<=@to_date
	and a.cause_code not in ('ZZ')
	and a.gaijung <> 'SPSS'
	and a.cont_qty=a.sale_qty	-- 이화진 : 출하완료 조건(cont_qty=sale_qty)

	-- 완료되었지만 기준일 이후 입고된것 (기준일 전에는 미완료주문이었음)
	select project_no=left(b.prod_no,11), mfg_no=right(b.prod_no,3), b.part, b.part_seq, b.order_no
	into #temp
	from (select order_no from EL_CD..t_va_040 c with (index=ix_t_va_040_5 nolock) where date_io between @to_date + ' 23:59:59' and '20401231') k,
		EL_CD..t_va_020 b  with(index=ix_t_va_020_8 nolock)
	where k.order_no>'0'
	and b.order_no=k.order_no
	and b.run_status = '5'

	insert into #tempaaaa
	select x.order_no,a.last_out_date
	from	#temp x,	el_cd..t_ca_011 a with (nolock)
	where x.mfg_no not like 'K%'
	and a.project_no=x.project_no
	and a.mfg_no=x.mfg_no
	and a.part=x.part
	and a.part_seq=x.part_seq
	and a.part <> 'CM'
	and a.concern_order_no=x.order_no
	and a.order_select not in ('A','M')
	and a.last_out_date<=@to_date
	and a.cause_code not in ('ZZ')
	and a.gaijung <> 'SPSS'

	select	a.order_no,a.item_no,
			c.eng_desc,
			a.gaijung,a.supply,a.run_status,date_due = convert(varchar(10),a.date_due,120),
			date_io = ( select max( convert(varchar(10),e.date_io,120)) from  EL_CD..t_va_040 e with (nolock) where e.order_no = b.order_no ),
			last_out_date = convert(varchar(10),b.last_out_date,120),
			a.prod_no,a.part,a.part_seq,
			a.keep_flag,a.item_unit,a.money_unit,
			a.price,a.price_r,a.qty_order,a.qty_deliv,a.qty_insp,a.qty_acpt,a.qty_input,a.qty_cancel,date_start = convert(varchar(10),a.date_start,120),
			date_deliv = convert(varchar(10),a.date_deliv,120), date_chg = convert(varchar(10),a.date_chg,120),
			a.po_status,a.date_delay,a.insp_select,a.pay_con,a.post_wc,a.lc_no,a.req,a.ao_no, date_po = convert(varchar(10),a.date_po,120),
			a.post_person,
			date_last = convert(varchar(10),a.date_last,120), date_print_po = convert(varchar(10),a.date_print_po,120), a.trade_no,
			brief_trade=master.dbo.fGetVendorName(a.trade_no),
			a.skp,a.po_post_person,a.order_type,a.etc_price,a.last_ot_no,a.po_gubun,
			a.qty_reject,a.issue_no,a.issue_last_no,a.import_flag ,a.market_flag,a.ship_flag,a.draw_no,a.approve_flag,
			approve_date = convert(varchar(10),a.approve_date,120), a.receipt_flag, receipt_date = convert(varchar(10),a.receipt_date,120),
			a.reject_flag,a.reject_date,a.receipt_expect_no,
			not_receipt = a.price * a.qty_order
	into #T_Data_Download1
	from #tempaaaa b
		inner join EL_CD..t_va_020 a
			on a.order_no = b.order_no
		left outer join el_cd..t_cx_060 c
			on c.item_no = a.item_no
	where b.last_out_date between @from_date and @to_date --2010.05.27 이재상K
	and a.gaijung like 'el%'
	order by run_status, date_due, date_io

	select *
	into T_Data_Download1
	from #T_Data_Download1
	
	select a.item_no, apply_price = max(b.apply_price)
	into #temp_610
	from (select distinct item_no from #T_Data_Download1 where price <= 0 ) a,
		 el_cd..t_cx_610 b with (nolock)
	where b.item_no = a.item_no
	and b.price_sort = 'A'
	and b.apply_flag = 'Y'
	and b.date_apply_from = (select max(c.date_apply_from) 
				from el_cd..t_cx_610 c with (nolock)
				where c.item_no = a.item_no
				and c.price_sort = 'A'
				and c.apply_flag = 'Y' )
	group by a.item_no

	update a set 
		price = b.apply_price
	from T_Data_Download1 a, #temp_610 b
	where b.item_no = a.item_no

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download2') and OBJECTPROPERTY(id, 'IsTable') = 1)
 	begin
		drop table T_Data_Download2
	end

	insert INTO #TEMP_cos01
	exec el_nd.dbo.SP_Down_Not_receiving_matl_Sub '2',@from_date,@to_date,@yearmonth 

	select	a.project_no
		,a.mfg_no
		,a.hogi
		,a.part
		,a.part_seq
		,a.item_no
		,ENg_DESC = master.dbo.fGetItemDesc(a.item_no)
		,due_date = convert(varchar(10), a.due_date, 120)
		,a.product_code
		,a.market_flag
		,a.order_select
		,a.item_group_sub
		,a.block
		,a.mp_flag
		,a.concern_order_no
		,concern_order_date = convert(varchar(10), a.concern_order_date, 120)
		,a.cont_qty
		,a.cont_cost
		,a.cont_amt
		,last_in_date = convert(varchar(10), a.last_in_date, 120)
		,last_out_date = convert(varchar(10), a.last_out_date, 120)
		,a.ao_time
		,a.run_status
		,run_date = convert(varchar(10), a.run_date, 120)
		,a.temp_order_flag
		,a.temp_order_cfrm_date
		,upd_date = convert(varchar(10), a.upd_date, 120)
		,draw_cfm_date = convert(varchar(10), a.draw_cfm_date, 120)
		,a.sale_qty
		,a.trade_no
		,brief_trade =  master.dbo.fGetVendorName(a.trade_no)
		,plan_due_date = convert(varchar(10), a.plan_due_date, 120)
		,cfrm_date = convert(varchar(10), a.cfrm_date, 120)
		,a.deliv_date
		,a.out_date
		,a.matl_post_person
		,a.po_post_person
		,a.wh_post_person
		,a.ship_post_person
		,rslt_date = convert(varchar(10), a.rslt_date, 120)
		,a.confirm_flag
		,a.ship_flag
		,a.vbox_code
		,a.box_no
		,a.out_factory_flag
		,a.treat_method
		,packing_confirm_date = convert(varchar(10), a.packing_confirm_date, 120)
		,a.prod_qty
		,date_ao = convert(varchar(10), a.date_ao, 120)
		,a.date_po
		,date_kit = convert(varchar(10), a.date_kit, 120)
		,a.cause_code
		,a.prod_amt
		,a.sale_amt
		,a.management_flag
		,a.giho_draw_flag
		,a.select_draw_flag
		,a.amt_divide_flag
		,a.add_vbox_code
		,a.drawlastupdate
		,a.part_pdm
		,a.gaijung
		,wip_qty
		, B.standard_price
	into T_Data_Download2
	FROM #TEMP_cos01 A LEFT OUTER JOIN el_cd..T_CX_614 B with (nolock)
		ON  A.ITEM_NO = B.ITEM_NO
			AND YEAR = @year

	update a set 
		standard_price =  c.matl_price
	from T_Data_Download2 a
		left outer join el_cd..t_cj_010 c with (nolock)
		on  c.item_no = a.item_no
		and c.year_month like @year + '%'
		and c.year_month = (select max(d.year_month)
				from el_cd..t_cj_010 d 
				where d.year_month like @year + '%'
				and d.item_no = a.item_no)
	where standard_price is null
	and c.matl_price > 0
		
	exec xp_Common_BCP_output @page,@Job_ID,'2'
	
--하이젠 모터 미입고(재료비조인) : 모터의 입고전표가 생산시스템에 없으므로(별도존재), 원가에 출고전표로만 입고확인이 가능함

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download3') and OBJECTPROPERTY(id, 'IsTable') = 1)
		begin
			drop table T_Data_Download3
		end
			
	truncate table #TEMP_cos01

	insert INTO #TEMP_cos01
	exec el_nd.dbo.SP_Down_Not_receiving_matl_Sub '3',@from_date,@to_date,@yearmonth

	select	a.project_no
		,a.mfg_no
		,a.hogi
		,a.part
		,a.part_seq
		,a.item_no
		,ENg_DESC = master.dbo.fGetItemDesc(a.item_no)
		,due_date = convert(varchar(10), a.due_date, 120)
		,a.product_code
		,a.market_flag
		,a.order_select
		,a.item_group_sub
		,a.block
		,a.mp_flag
		,a.concern_order_no
		,concern_order_date = convert(varchar(10), a.concern_order_date, 120)
		,a.cont_qty
		,a.cont_cost
		,a.cont_amt
		,last_in_date = convert(varchar(10), a.last_in_date, 120)
		,last_out_date = convert(varchar(10), a.last_out_date, 120)
		,a.ao_time
		,a.run_status
		,run_date = convert(varchar(10), a.run_date, 120)
		,a.temp_order_flag
		,a.temp_order_cfrm_date
		,upd_date = convert(varchar(10), a.upd_date, 120)
		,draw_cfm_date = convert(varchar(10), a.draw_cfm_date, 120)
		,a.sale_qty
		,a.trade_no
		,brief_trade =  master.dbo.fGetVendorName(a.trade_no)
		,plan_due_date = convert(varchar(10), a.plan_due_date, 120)
		,cfrm_date = convert(varchar(10), a.cfrm_date, 120)
		,a.deliv_date
		,a.out_date
		,a.matl_post_person
		,a.po_post_person
		,a.wh_post_person
		,a.ship_post_person
		,rslt_date = convert(varchar(10), a.rslt_date, 120)
		,a.confirm_flag
		,a.ship_flag
		,a.vbox_code
		,a.box_no
		,a.out_factory_flag
		,a.treat_method
		,packing_confirm_date = convert(varchar(10), a.packing_confirm_date, 120)
		,a.prod_qty
		,date_ao = convert(varchar(10), a.date_ao, 120)
		,a.date_po
		,date_kit = convert(varchar(10), a.date_kit, 120)
		,a.cause_code
		,a.prod_amt
		,a.sale_amt
		,a.management_flag
		,a.giho_draw_flag
		,a.select_draw_flag
		,a.amt_divide_flag
		,a.add_vbox_code
		,a.drawlastupdate
		,a.part_pdm
		,a.gaijung
		,wip_qty
		, B.standard_price
	into T_Data_Download3
	FROM #TEMP_cos01 A LEFT OUTER JOIN el_cd..T_CX_613 B with (nolock)
		ON  A.ITEM_NO = B.ITEM_NO
		AND YEAR = @year
	
	
	update a set 
		a.standard_price =  c.matl_price
	from T_Data_Download3 a
		left outer join el_cd..t_cj_010 c with (nolock)
		on  c.item_no = a.item_no
		and c.year_month like @year + '%'
		and c.year_month = (select max(d.year_month)
				from el_cd..t_cj_010 d 
				where d.year_month like @year + '%'
				and d.item_no = a.item_no)
	where standard_price is null
	and c.matl_price > 0
	
	exec xp_Common_BCP_output @page,@Job_ID,'3'

	select @status='0',@out_msg=' Down Ok ..'

set nocount off;

/*************************************************************************************
 *
 *  Down_110 : old -- sp_Down_Standard_Matl_Account_Detail
 *
 * DISCRIPTION		: 표준 월수불  Download
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: 김영민
 *
 * CREATE_DAY		: 2009년 05월 04일
 *
 * MODIFICATION_LOG
 *
 *  VER	DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	--------------------	---------     ---------------
 *  1.0	2009-05-04				김영민	       월별 원재료 재고 데이터 제공
 *
 *************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_110]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin



/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC sp_Down_Standard_Matl_Account_Detail 'Down_110','2010-08-31 09:38:56.813',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung		varchar(04),
		@year_month		varchar(06)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@year_month=mrp.dbo.fGetOption(@Job_ID,@page,'AccountMonth')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	
	select	year_month,
			item_no,
			eng_desc=master.dbo.fGetItemDesc(a.item_no),
			gaijung,
			store,
			order_select,
			qty_trans ,
			act_amt_trans ,
			qty_input ,
			act_amt_input ,
			qty_output ,
			act_amt_output ,
			qty_stock ,
			act_amt_stock ,
			standard_price ,
			price_burden ,
			std_amt_trans ,
			std_amt_input ,
			std_amt_output ,
			std_amt_stock ,
			matl_price ,
			matl_price_burden ,
			product_code
	into T_Data_Download1
	from	el_cd..t_va_060 a with (nolock)
	where year_month = @year_month
	and gaijung like @o_gaijung + '%'
	order by gaijung, item_no


	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Down_120     (old:SP_Isql_InputDay_PPV)                                                    */   
/*  DISCRIPTION  :  입고일자별 PPV 리스트                                                                        */   
/*                                                                                                               */   
/*  >> MODIFICATION LOG <<                                                                                       */   
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */   
/*  ---------------------------------------------------------------                                              */   
/* 2009/09/16     MRP Downsizing Project   A.J.Jeong    Initialize                                               */   
/* 2010/09/01     MRP Downsizing Project   J.J.Park      Mrp Downsizing Project                                  */   
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/
/*
declare	@status		char(01)	,
				@out_msg	varchar(50) 
				
EXEC SP_Down_120 'Down_120','2011-12-27 12:17:50.670',@status output,@out_msg output

select @status,@out_msg

select mrp.dbo.fGetOption('Down_120','2011-11-29 11:58:00.927','BaseDate')

*/	
CREATE PROCEDURE [dbo].[SP_Down_120]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
as
set nocount on
begin

declare	@o_Gaijung	varchar(04),
				@from_date	varchar(08),	-- 입고기간 From (집계입고기간 From)
				@to_date	varchar(08),	-- 입고기간 To (집계입고기간 To)
				@std_Date	varchar(08),	-- 작년 단가 적용 기점일(2010 년 이면, 2008-12-26)
				@Vendor	    varchar(08),
				@CarryOver 	int,	 -- PPV=0, CarryOver=1
				@MinDiff	float ,
				@BEFORE_YEAR	varchar(04) 

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
		@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate'),
		@Std_Date=mrp.dbo.fGetOption(@Job_ID,@page,'BaseDate'),
		@vendor=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor'),
		@CarryOver=mrp.dbo.fGetOption(@Job_ID,@page,'CarryOver'), 
		@MinDiff=mrp.dbo.fGetOption(@Job_ID,@page,'MinDiff')

--select  @from_date,@To_date,@Std_Date


	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	declare	@year char(04)
 	select	@year = convert(char(04),dateadd(year,-(@CarryOver) ,getdate()),112)   
	select	@BEFORE_YEAR =  SUBSTRING(@Std_Date,1,4) 
 --drop table #temp_610	

/*1 입고정보 .. 전표를 합하지 않음...*/
	select	a.item_no,
		a.supply, a.trade_no, a.qty, 
		price=isnull(price_won,0.0),
		price_won=price_won,
		a.money_unit, a.date_io, date_print_po = isnull(b.date_print_po,a.date_io), --일괄 적흑자는 주문이 없어 입고일을 주문일로 계산
		a.prod_no, b.order_no
	into #temp_040
	from el_cd..t_va_040  a with (NOLOCK)
		left outer join el_cd..t_va_020 b
			on b.order_no = a.order_no
	where a.date_io between @from_date and  @To_date + ' 23:59:00'
	and left(a.gaijung,2) = left(@o_Gaijung,2)
  
	--적용단가 모도번 매칭용
	create table #temp_060 (
		item_no varchar(15),
		seed_item_no varchar(15)
	)
	create index i_#temp_060_1 on #temp_060(item_no)
	
	insert into #temp_060
	select item_no, seed_item_no = master.dbo.fgetMRPseedItemno(item_no)
	from #temp_040
	where item_no > '0'
	group by item_no
	

/*2대상도번에대한 단가변경내역 테이블생성*/
	create table #temp_610 (
		seq int	IDENTITY(1,1),
		item_no varchar(15),
		supply char(1),
		trade_no VARCHAR(8),
		date_apply_before datetime,
		doc_before char(12),
		date_apply_from	datetime,
		date_entry datetime,
		agreement_doc char(12),
		date_apply_after datetime,
		date_apply_15 datetime,
		std_price float,
		apply_price_before float,
		apply_price	float,
		money_unit char(3)
	)
	create index i_#temp_610 on #temp_610(item_no, supply,trade_no)
	

	insert into #temp_610
	select	a.item_no, a.supply, a.trade_no, null,null, 
		b.date_apply_from, b.date_entry, b.agreement_doc, 
		null,null, null,null, b.apply_price, b.money_unit
	from (	select a.item_no, b.seed_item_no, supply, trade_no, money_unit
			from #temp_040 a,  #temp_060 b
			where a.item_no = b.item_no
			group by a.item_no, b.seed_item_no, supply,trade_no,money_unit) a
		left outer join el_cd..t_cx_610 b with (nolock)
			on b.item_no = a.seed_item_no
			and	b.order_select = a.supply 
			and	b.vendor = a.trade_no 
			and	b.money_unit = a.money_unit
			and	b.date_apply_from <= @To_date --'20111225'
			and	b.apply_flag = 'Y'
			and	b.price_sort = 'A'
			and	b.seq = '1'
	order by a.item_no, a.supply, a.trade_no, b.date_apply_from desc
	
	--------- 적용단가별 변경전후 단가 Update -----------  
	update	a set	
		date_apply_after	  = c.date_apply_from
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq - 1

	update	a set
		date_apply_before = c.date_apply_from,
		doc_before	  = c.agreement_doc,
		apply_price_before= c.apply_price
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq + 1 
	--and a.date_apply_from > @Std_Date --기준년 전 단가는 before적용단가를 NULL로 두고 나중에 STD로 넣음   20231231 
	
	update	a set 
		date_apply_15 = dateadd(day,15,date_apply_from)
	from	#temp_610 a
	
/*2-2 도입 단가... 없을때..ex 'AEG16C460*G'     */
	update a set a.apply_price = b.apply_price,
		a.money_unit = b.money_unit,
		a.date_apply_from = b.date_apply_from,
		a.date_entry = b.date_entry
	--select *
	from #temp_610 a
		inner join (select b.item_no, b.supply, b.trade_no, 
						--	apply_price = SUM(b.price*b.qty)/SUM(b.qty),
							apply_price = (case when SUM(b.qty) = 0 then SUM(b.price*b.qty) else SUM(b.price*b.qty)/SUM(b.qty) end),
							money_unit = max(money_unit),
							date_apply_from = min(date_print_po),
							date_entry  = '19510101'
					from #temp_040 b
					group by b.item_no, b.supply, b.trade_no) b
			on b.item_no = a.item_no
			and b.supply = a.supply
			and b.trade_no = a.trade_no
	where a.supply = 'I'
	and a.apply_price is null
 
/*3 입고실적별 입고단가 매칭*/
--입고시 적용된 단가.
--drop table #temp1
	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'Y', formal_flag = 'Y'
	into #temp1
	from #temp_040 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and b.date_apply_from <= a.date_print_po --적용일날 입고는 AFTER와 같으면 안됨.
		/*	and b.date_apply_from = (select max(c.date_apply_from) 
										from #temp_610 c
										where c.item_no = a.item_no
										and	c.supply = a.supply
										and	c.trade_no = a.trade_no
										and	c.money_unit = a.money_unit
										and c.date_apply_from <= a.date_print_po
										and c.date_entry < a.date_io --소급적용여부단가 제외
										)
         */  --20231231 
	where a.order_no is not null --비정규적흑자 제외(SW98F 포함)
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won


---입고시 적용 이전 단가들 적용일 1년 이내.
	--
/*	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'N', formal_flag = 'Y'
	into #temp2
	from #temp1 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and a.seq < b.seq --입고이후 단가 SEQ로 판단
			and b.date_apply_from >= @Std_Date--'20101226'
			--and b.date_entry < a.date_io --주석처리함 소급적용여부 관계없이 ALL
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won
		
---적용일 1년전 가장 최근 단가(일반적으로 표준단가와 같음)
	insert into #temp2
	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'N', formal_flag = 'Y'
	from #temp1 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and b.date_apply_from = (select max(c.date_apply_from) 
										from #temp_610 c
										where c.item_no = a.item_no
										and	c.supply = a.supply
										and	c.trade_no = a.trade_no
										and	c.money_unit = a.money_unit
										and c.date_apply_from < @Std_Date
										)
			and b.seq > a.seq --입고이후 단가 SEQ로 판단
			and b.date_apply_from < a.date_apply_from
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won
	*/   --20231231 	
/*3-2 비정규 적흑자*/
	insert into #temp1
	select seq = 0, a.item_no, a.supply, a.trade_no, date_apply_before = NULL,
		doc_before = NULL, date_apply_from = NULL, date_entry = NULL, agreement_doc = NULL,
		date_apply_after = NULL, date_apply_15 = NULL, std_price = NULL, apply_price_before = NULL,
		apply_price = a.price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'Y', formal_flag = 'N'
	from #temp_040 a
	where a.order_no is null
	group by a.item_no, a.supply, a.trade_no, a.money_unit, a.price, a.price_won

/*	
	insert into #temp1
	select * from #temp2
*/
/*3 표준단가 저장*/
	update	a set	
		std_price = ( case a.supply when 'I' then 
						(select max(standard_price) 
						from el_cd..t_cx_614 b 
						where year = '2019' --@BEFORE_YEAR 
						and b.item_no = a.item_no )
					   else	(select	max(standard_price)
							from el_cd..t_cx_613 b 
							where year = '2019' --@BEFORE_YEAR 
							and b.item_no = a.item_no 
							and b.order_select = a.supply)
					   end)--,
		--apply_price_before = isnull(apply_price_before,
		--											( case a.supply when 'I' then 
		--												(select max(standard_price) 
		--												from el_cd..t_cx_614 b 
		--												where year = '2019' --@BEFORE_YEAR
		--												and b.item_no = a.item_no )
		--											   else	(select	max(standard_price)
		--													from el_cd..t_cx_613 b 
		--													where year = '2019' -- @BEFORE_YEAR 
		--													and b.item_no = a.item_no 
		--													and b.order_select = a.supply)
		--											   end)
		--							   )
	from #temp1 a
/*
if @CarryOver = 0 --PPV
	begin 
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				
				actul_diff_price = apply_price - apply_price_before,
				actul_diff_amut=(apply_price - apply_price_before) * qty,
				
				std_diff_price = case current_flag when 'Y' then ((case supply when 'I' then price_won else apply_price end) - std_price) else 0 end,
				std_diff_amut= case current_flag when 'Y' then ((case supply when 'I' then price_won else apply_price end)  - std_price) * qty else 0 end,

				agreement_doc = isnull(agreement_doc,''), 
				date_apply_from = isnull(convert(varchar(10),date_apply_from,120),''),
				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won,
				current_flag
		into	T_Data_Download1
		from	#temp1 a
		where  abs(apply_price - std_price) >= @MinDiff
		order by item_no,trade_no,supply,qty,date_apply_from
		
	end
	else --CarrayOver
	begin
	*/  --20231231 
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				diff_price = apply_price - apply_price_before,
				amut=(apply_price - apply_price_before)*qty,
				agreement_doc, 
				date_apply_from,
				date_apply_until = dateadd(day,365,date_apply_from),
				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won
		into	T_Data_Download1
		from	#temp1 a
		where date_apply_from between dateadd(year,-(@CarryOver) ,@Std_Date )  -- @from_date)   20231231 
				and convert(char(04),@from_date) + '-12-25 23:59:59'
		and  abs(apply_price - apply_price_before) >= @MinDiff
		order by item_no,trade_no,supply,qty,date_apply_from
			
--	end

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'
end


set nocount off;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Down_120     (old:SP_Isql_InputDay_PPV)                                                    */   
/*  DISCRIPTION  :  입고일자별 PPV 리스트                                                                        */   
/*                                                                                                               */   
/*  >> MODIFICATION LOG <<                                                                                       */   
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */   
/*  ---------------------------------------------------------------                                              */   
/* 2009/09/16     MRP Downsizing Project   A.J.Jeong    Initialize                                               */   
/* 2010/09/01     MRP Downsizing Project   J.J.Park      Mrp Downsizing Project                                  */   
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/
/*
declare	@status		char(01)	,
				@out_msg	varchar(50) 
				
EXEC SP_Down_120 'Down_120','2011-12-27 12:17:50.670',@status output,@out_msg output

select @status,@out_msg

select mrp.dbo.fGetOption('Down_120','2011-11-29 11:58:00.927','BaseDate')

*/	
CREATE PROCEDURE [dbo].[SP_Down_120_TEST]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
as
set nocount on
begin

declare	@o_Gaijung	varchar(04),
				@from_date	varchar(08),	-- 입고기간 From (집계입고기간 From)
				@to_date	varchar(08),	-- 입고기간 To (집계입고기간 To)
				@std_Date	varchar(08),	-- 작년 단가 적용 기점일(2010 년 이면, 2008-12-26)
				@Vendor	    varchar(08),
				@CarryOver 	int,	 -- PPV=0, CarryOver=1
				@MinDiff	float ,
				@BEFORE_YEAR	varchar(04) 

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
		@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate'),
		@Std_Date=mrp.dbo.fGetOption(@Job_ID,@page,'BaseDate'),
		@vendor=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor'),
		@CarryOver=mrp.dbo.fGetOption(@Job_ID,@page,'CarryOver'), 
		@MinDiff=mrp.dbo.fGetOption(@Job_ID,@page,'MinDiff')

--select  @from_date,@To_date,@Std_Date


	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	declare	@year char(04)
 	select	@year = convert(char(04),dateadd(year,-(@CarryOver) ,getdate()),112)   
	select	@BEFORE_YEAR =  SUBSTRING(@Std_Date,1,4) 
 --drop table #temp_610	

/*1 입고정보 .. 전표를 합하지 않음...*/
	select	a.item_no,
		a.supply, a.trade_no, a.qty, 
		price=isnull(price_won,0.0),
		price_won=price_won,
		a.money_unit, a.date_io, date_print_po = isnull(b.date_print_po,a.date_io), --일괄 적흑자는 주문이 없어 입고일을 주문일로 계산
		a.prod_no, b.order_no
	into #temp_040
	from el_cd..t_va_040  a with (NOLOCK)
		left outer join el_cd..t_va_020 b
			on b.order_no = a.order_no
	where a.date_io between @from_date and  @To_date + ' 23:59:00'
	and left(a.gaijung,2) = left(@o_Gaijung,2)
  
	--적용단가 모도번 매칭용
	create table #temp_060 (
		item_no varchar(15),
		seed_item_no varchar(15)
	)
	create index i_#temp_060_1 on #temp_060(item_no)
	
	insert into #temp_060
	select item_no, seed_item_no = master.dbo.fgetMRPseedItemno(item_no)
	from #temp_040
	where item_no > '0'
	group by item_no
	

/*2대상도번에대한 단가변경내역 테이블생성*/
	create table #temp_610 (
		seq int	IDENTITY(1,1),
		item_no varchar(15),
		supply char(1),
		trade_no VARCHAR(8),
		date_apply_before datetime,
		doc_before char(12),
		date_apply_from	datetime,
		date_entry datetime,
		agreement_doc char(12),
		date_apply_after datetime,
		date_apply_15 datetime,
		std_price float,
		apply_price_before float,
		apply_price	float,
		money_unit char(3)
	)
	create index i_#temp_610 on #temp_610(item_no, supply,trade_no)
	

	insert into #temp_610
	select	a.item_no, a.supply, a.trade_no, null,null, 
		b.date_apply_from, b.date_entry, b.agreement_doc, 
		null,null, null,null, b.apply_price, b.money_unit
	from (	select a.item_no, b.seed_item_no, supply, trade_no, money_unit
			from #temp_040 a,  #temp_060 b
			where a.item_no = b.item_no
			group by a.item_no, b.seed_item_no, supply,trade_no,money_unit) a
		left outer join el_cd..t_cx_610 b with (nolock)
			on b.item_no = a.seed_item_no
			and	b.order_select = a.supply 
			and	b.vendor = a.trade_no 
			and	b.money_unit = a.money_unit
			and	b.date_apply_from <= @To_date --'20111225'
			and	b.apply_flag = 'Y'
			and	b.price_sort = 'A'
			and	b.seq = '1'
	order by a.item_no, a.supply, a.trade_no, b.date_apply_from desc
	
	--------- 적용단가별 변경전후 단가 Update -----------  
	update	a set	
		date_apply_after	  = c.date_apply_from
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq - 1

	update	a set
		date_apply_before = c.date_apply_from,
		doc_before	  = c.agreement_doc,
		apply_price_before= c.apply_price
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq + 1 
	--and a.date_apply_from > @Std_Date --기준년 전 단가는 before적용단가를 NULL로 두고 나중에 STD로 넣음   20231231 
	
	update	a set 
		date_apply_15 = dateadd(day,15,date_apply_from)
	from	#temp_610 a
	
/*2-2 도입 단가... 없을때..ex 'AEG16C460*G'     */
	update a set a.apply_price = b.apply_price,
		a.money_unit = b.money_unit,
		a.date_apply_from = b.date_apply_from,
		a.date_entry = b.date_entry
	--select *
	from #temp_610 a
		inner join (select b.item_no, b.supply, b.trade_no, 
						--	apply_price = SUM(b.price*b.qty)/SUM(b.qty),
							apply_price = (case when SUM(b.qty) = 0 then SUM(b.price*b.qty) else SUM(b.price*b.qty)/SUM(b.qty) end),
							money_unit = max(money_unit),
							date_apply_from = min(date_print_po),
							date_entry  = '19510101'
					from #temp_040 b
					group by b.item_no, b.supply, b.trade_no) b
			on b.item_no = a.item_no
			and b.supply = a.supply
			and b.trade_no = a.trade_no
	where a.supply = 'I'
	and a.apply_price is null
 
/*3 입고실적별 입고단가 매칭*/
--입고시 적용된 단가.
--drop table #temp1
	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'Y', formal_flag = 'Y'
	into #temp1
	from #temp_040 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and b.date_apply_from <= a.date_print_po --적용일날 입고는 AFTER와 같으면 안됨.
		/*	and b.date_apply_from = (select max(c.date_apply_from) 
										from #temp_610 c
										where c.item_no = a.item_no
										and	c.supply = a.supply
										and	c.trade_no = a.trade_no
										and	c.money_unit = a.money_unit
										and c.date_apply_from <= a.date_print_po
										and c.date_entry < a.date_io --소급적용여부단가 제외
										)
         */  --20231231 
	where a.order_no is not null --비정규적흑자 제외(SW98F 포함)
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won


---입고시 적용 이전 단가들 적용일 1년 이내.
	--
/*	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'N', formal_flag = 'Y'
	into #temp2
	from #temp1 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and a.seq < b.seq --입고이후 단가 SEQ로 판단
			and b.date_apply_from >= @Std_Date--'20101226'
			--and b.date_entry < a.date_io --주석처리함 소급적용여부 관계없이 ALL
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won
		
---적용일 1년전 가장 최근 단가(일반적으로 표준단가와 같음)
	insert into #temp2
	select b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'N', formal_flag = 'Y'
	from #temp1 a
		inner join #temp_610 b
			on b.item_no = a.item_no
			and	a.supply = b.supply
			and	a.trade_no = b.trade_no
			and	a.money_unit = b.money_unit
			and b.date_apply_from = (select max(c.date_apply_from) 
										from #temp_610 c
										where c.item_no = a.item_no
										and	c.supply = a.supply
										and	c.trade_no = a.trade_no
										and	c.money_unit = a.money_unit
										and c.date_apply_from < @Std_Date
										)
			and b.seq > a.seq --입고이후 단가 SEQ로 판단
			and b.date_apply_from < a.date_apply_from
	group by b.seq, a.item_no, a.supply, a.trade_no, b.date_apply_before,
		b.doc_before, b.date_apply_from, b.date_entry, b.agreement_doc,
		b.date_apply_after, b.date_apply_15, b.std_price, b.apply_price_before,
		b.apply_price, a.money_unit, a.price, 
		a.price_won
	*/   --20231231 	
/*3-2 비정규 적흑자*/
	insert into #temp1
	select seq = 0, a.item_no, a.supply, a.trade_no, date_apply_before = NULL,
		doc_before = NULL, date_apply_from = NULL, date_entry = NULL, agreement_doc = NULL,
		date_apply_after = NULL, date_apply_15 = NULL, std_price = NULL, apply_price_before = NULL,
		apply_price = a.price, a.money_unit, a.price, 
		a.price_won, qty = sum(a.qty), current_flag = 'Y', formal_flag = 'N'
	from #temp_040 a
	where a.order_no is null
	group by a.item_no, a.supply, a.trade_no, a.money_unit, a.price, a.price_won

/*	
	insert into #temp1
	select * from #temp2
*/
/*3 표준단가 저장*/
	update	a set	
		std_price = ( case a.supply when 'I' then 
						(select max(standard_price) 
						from el_cd..t_cx_614 b 
						where year = '2019' --@BEFORE_YEAR 
						and b.item_no = a.item_no )
					   else	(select	max(standard_price)
							from el_cd..t_cx_613 b 
							where year = '2019' --@BEFORE_YEAR 
							and b.item_no = a.item_no 
							and b.order_select = a.supply)
					   end)--,
		--apply_price_before = isnull(apply_price_before,
		--											( case a.supply when 'I' then 
		--												(select max(standard_price) 
		--												from el_cd..t_cx_614 b 
		--												where year = '2019' --@BEFORE_YEAR
		--												and b.item_no = a.item_no )
		--											   else	(select	max(standard_price)
		--													from el_cd..t_cx_613 b 
		--													where year = '2019' -- @BEFORE_YEAR 
		--													and b.item_no = a.item_no 
		--													and b.order_select = a.supply)
		--											   end)
		--							   )
	from #temp1 a
/*
if @CarryOver = 0 --PPV
	begin 
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				
				actul_diff_price = apply_price - apply_price_before,
				actul_diff_amut=(apply_price - apply_price_before) * qty,
				
				std_diff_price = case current_flag when 'Y' then ((case supply when 'I' then price_won else apply_price end) - std_price) else 0 end,
				std_diff_amut= case current_flag when 'Y' then ((case supply when 'I' then price_won else apply_price end)  - std_price) * qty else 0 end,

				agreement_doc = isnull(agreement_doc,''), 
				date_apply_from = isnull(convert(varchar(10),date_apply_from,120),''),
				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won,
				current_flag
		into	T_Data_Download1
		from	#temp1 a
		where  abs(apply_price - std_price) >= @MinDiff
		order by item_no,trade_no,supply,qty,date_apply_from
		
	end
	else --CarrayOver
	begin
	*/  --20231231 
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				diff_price = apply_price - apply_price_before,
				amut=(apply_price - apply_price_before)*qty,
				agreement_doc, 
				date_apply_from,
				date_apply_until = dateadd(day,365,date_apply_from),
				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won
		into	T_Data_Download1
		from	#temp1 a
		where date_apply_from between dateadd(year,-(@CarryOver) ,@Std_Date )  -- @from_date)   20231231 
				and convert(char(04),@from_date) + '-12-25 23:59:59'
		and  abs(apply_price - apply_price_before) >= @MinDiff
		order by item_no,trade_no,supply,qty,date_apply_from
			
--	end

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'
end


set nocount off;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Down_120     (old:SP_Isql_InputDay_PPV)                                                        */
/*  DISCRIPTION  :  입고일자별 PPV 리스트                                                                            */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2009/09/16     MRP Downsizing Project   A.J.Jeong    Initialize                                                   */
/* 2010/09/01     MRP Downsizing Project   J.J.Park      Mrp Downsizing Project                                      */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/
/*
declare	@status		char(01)	,
				@out_msg	varchar(50) 
				
EXEC SP_Down_121 'Down_120','2010-09-01 10:27:11.770',@status output,@out_msg output

select @status,@out_msg
*/	
CREATE PROCEDURE [dbo].[SP_Down_121]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
as
set nocount on
begin

declare	@o_Gaijung	varchar(04),
				@from_date	varchar(08),	-- 입고기간 From (집계입고기간 From)
				@to_date	varchar(08),	-- 입고기간 To (집계입고기간 To)
				@std_Date	varchar(08),	-- 작년 단가 적용 기점일(2010 년 이면, 2008-12-26)
				@Vendor	    varchar(08),
				@CarryOver 	int	 -- PPV=0, CarryOver=1

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
		@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate'),
		@Std_Date=mrp.dbo.fGetOption(@Job_ID,@page,'BaseDate'),
		@vendor=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor'),
		@CarryOver=mrp.dbo.fGetOption(@Job_ID,@page,'CarryOver')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	declare	@year		char(04)
 	select		@year		=convert(char(04),dateadd(year,-(@CarryOver) ,getdate()),112)
 	
	create table #temp_610 (
		seq		int	IDENTITY(1,1),
		item_no		varchar(15),
		supply		char(1),
		trade_no		VARCHAR(8),
	
		date_apply_before datetime,
		doc_before	char(12),
		date_apply_from	datetime,
		agreement_doc	char(12),
		date_apply_after	datetime,
		date_apply_15	datetime,
	
		std_price	float,
		apply_price_before float,
		apply_price	float,
	
		money_unit	char(3)
	)
	create index i_#temp_610 on #temp_610(item_no, supply,trade_no)
	

	--------- 입고기간 전표 리스트 생성 -----------  
	select	item_no, supply, trade_no, qty=sum(qty), 
		price=isnull(price_won,0.0),
		price_won=price_won,
		money_unit
	into	#temp_040
	from	el_cd..t_va_040  a with (index=ix_t_va_040_5 NOLOCK)
	where	date_io between @from_date and @to_date
	and	(@vendor <= '' or trade_no = @vendor)
	and	left(gaijung,2) = left(@o_gaijung,2)
	and	supply <> 'I'
	group by item_no, supply, trade_no, money_unit,price_foreign, price_won

	insert into #temp_040
	select	item_no, supply, trade_no, qty=sum(qty), 
		price=isnull(price_foreign,''),
		price_won=(amut/qty),
		money_unit
	from	el_cd..t_va_040  with (index=ix_t_va_040_5 NOLOCK)
	where	date_io between @from_date and @to_date
	and	(@vendor <= '' or trade_no = @vendor)
	and	left(gaijung,2) = left(@o_gaijung,2)
	and	supply = 'I'
	group by item_no, supply, trade_no, money_unit,price_foreign, price_won, amut, qty

	
	--------- 적용단가 변경후단가 리스트 생성 -----------  
	insert into #temp_610		-- 52초
	select	a.item_no, a.supply,  a.trade_no,
		null,null,b.date_apply_from,b.agreement_doc, null,null,
		null,null,b.apply_price,b.money_unit
	from	(select	item_no, supply,trade_no,price,money_unit
			from	#temp_040
			group by item_no, supply,trade_no,price,money_unit) a,
		  el_cd..t_cx_610 b 
	where	a.item_no > '0'
	and	b.item_no = a.item_no 
	and	b.order_select = a.supply 
	and	b.vendor = a.trade_no 
	and	b.money_unit = a.money_unit
	and	b.date_apply_from <= @to_date
	and	b.apply_flag = 'Y'
	and	b.price_sort = 'A'
	and	b.seq = '1'
	order by a.item_no, a.supply, a.trade_no, b.date_apply_from desc
	
	
	--------- 적용단가별 변경전후 단가 Update -----------  
	update	a set	
		date_apply_after	  = c.date_apply_from
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq - 1 

	update	a set
		date_apply_before = c.date_apply_from,
		doc_before	  = c.agreement_doc,
		apply_price_before= c.apply_price
	from	#temp_610 a, #temp_610 c 
	where	a.item_no > '0'
	and	c.item_no = a.item_no 
	and	c.supply = a.supply 
	and	c.trade_no = a.trade_no
	and	c.seq = a.seq + 1 
	
	update	a set 
		date_apply_15 = dateadd(day,15,date_apply_from)
	from	#temp_610 a
	
	
	--------- 변경전 08.12.25 단가 리스트만 생성 -----------  
	select	item_no, supply, trade_no, date_apply_before, doc_before, date_apply_from, agreement_doc,
		date_apply_after, date_apply_15, std_price, apply_price_before, apply_price, money_unit
	into	#temp3
	from	#temp_610
	where	(date_apply_before is null or date_apply_before <> date_apply_from)
	and	date_apply_from <= @std_date
	group by item_no, supply, trade_no, date_apply_before, doc_before, date_apply_from, agreement_doc,
		date_apply_after, date_apply_15, std_price, apply_price_before, apply_price, money_unit
	order by item_no,supply,trade_no,date_apply_from
	
	--------- 08.12.25 이후 변경후 단가 리스트만 생성 -----------  
	select	item_no, supply, trade_no, date_apply_before, doc_before, date_apply_from, agreement_doc,
		date_apply_after, date_apply_15, std_price, apply_price_before, apply_price, money_unit
	into	#temp5
	from	#temp_610
	where	(date_apply_before is null or date_apply_before <> date_apply_from)
	and	date_apply_from > @std_date
	group by item_no, supply, trade_no, date_apply_before, doc_before, date_apply_from, agreement_doc,
		date_apply_after, date_apply_15, std_price, apply_price_before, apply_price, money_unit
	order by item_no,supply,trade_no,date_apply_from
	
	
	--------- 08.12.25 변경후단가 매칭함. 중복된 것은 마지막 것으로 함 -----------  
	select	a.*, b.price, b.price_won, b.qty
	into	#temp4
	from	#temp5 a, #temp_040 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.apply_price = b.price
	and	a.money_unit = b.money_unit
	
	delete	a
	from	#temp4 a
	where	a.item_no in (select b.item_no from #temp4 b
				group by  b.item_no, b.supply, b.trade_no, b.apply_price, b.money_unit, b.price, b.price_won, b.qty
				having	count(*) > 1)
	and	date_apply_after is not null --마지막은 date_apply_after 값이 NULL
	
	delete	a
	from	#temp_040 a, #temp4 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.price = b.price
	and	a.money_unit = b.money_unit
	and	a.price_won = b.price_won
	
	
	--------- 08.12.25 변경전단가 매칭함. 중복된 것은 마지막 것으로 함 -----------  
	insert into #temp4
	select	a.*,b.price, b.price_won, b.qty
	from	#temp3 a,  #temp_040 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.apply_price = b.price
	and	a.money_unit = b.money_unit
	

	delete	a
	from	#temp4 a, #temp4 b
	where	a.item_no in (select b.item_no from #temp4 b
				group by  b.item_no, b.supply, b.trade_no, b.apply_price, b.money_unit, b.price, b.price_won, b.qty
				having	count(*) > 1)
	and	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.apply_price = b.price
	and	a.money_unit = b.money_unit
	and	a.price_won = b.price_won
	and	a.date_apply_from < b.date_apply_from
	
	delete	a
	from	#temp_040 a, #temp4 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.price = b.price
	and	a.money_unit = b.money_unit
	and	a.price_won = b.price_won
	
	--------- 매칭되는 적용단가가 없는 경우 -----------  
	--------- 적용일자 08.12.25 이전 단가는 변경후단가와 변경전단가와 동일하게 할 준비 -----------  
	insert into #temp4
	select	a.item_no, a.supply, a.trade_no,
		null, null, null, null,
		null, null, null, null,
		a.price, a.money_unit, a.price, a.price_won, sum(qty)
	from #temp_040 a
	group by a.item_no,
		a.supply,
		a.trade_no,
		a.money_unit, a.price, a.price_won


	--------- STD  단가-----------  
	update	a set	
		std_price = ( case a.supply when 'I' then
						(select	max(standard_price) from	el_cd..t_cx_614 b where	year =@year  and	b.item_no = a.item_no )
					else	(select	max(standard_price) from	el_cd..t_cx_613 b 
						where	year = @year and	b.item_no = a.item_no and	b.order_select = a.supply)
					end)
	from	#temp4 a
	
	update	a set	
		std_price = ( case a.supply when 'I' then 
						(select max(standard_price) from	el_cd..t_cx_614 b where	year = @year and	b.item_no = a.item_no )
					   else	(select	max(standard_price) from	el_cd..t_cx_613 b 
						where	year = @year and	b.item_no = a.item_no and	b.order_select = a.supply)
					   end)
	from	#temp5 a
	
	
	------- STD 단가가 없을 경우, 적용단가 08.12.25일 이전 마지막단가 혹은 09년의 최초 적용단가를 STD 단가로 함-----------  
	update	a set	
		std_price = c.apply_price
	from	#temp4 a, #temp_610 c
	where	a.std_price is null 
	and	a.item_no = c.item_no
	and	a.supply = c.supply
	and	c.date_apply_from = isnull((select	max(b.date_apply_from) from #temp3 b 
						where	a.item_no = b.item_no and a.supply = b.supply), 
					(select	min(b.date_apply_from) from #temp5 b 
						where	a.item_no = b.item_no and a.supply = b.supply))
	
	update	a set	
		std_price = c.apply_price
	from	#temp5 a, #temp_610 c
	where	a.std_price is null 
	and	a.item_no = c.item_no
	and	a.supply = c.supply
	and	c.date_apply_from = isnull((select	max(b.date_apply_from) from #temp3 b 
						where	a.item_no = b.item_no and a.supply = b.supply), 
					(select	min(b.date_apply_from) from #temp5 b 
						where	a.item_no = b.item_no and a.supply = b.supply))


	------- 09년 단가 변동 없는 것은 STD 와 변경전 단가 동일하게 함
	select	b.item_no,b.supply,b.trade_no
	into	#temp44
	from	#temp5 a, #temp4 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	group by b.item_no,b.supply,b.trade_no
	
	update	a set	
		apply_price_before=std_price
	from	#temp4 a left outer join #temp44 b
		on a.item_no = b.item_no
		and a.supply = b.supply
		and a.trade_no = b.trade_no
	where	b.item_no is null
	and	b.trade_no is null

	
	------- 08.12.25 적용이전 STD 단가와 변경후단가가 동일할 때, STD 단가를 변경전단가로  적용함 -----------  
	------- 09년도 변경전단가와 변경후단가의 차액을 0 으로 하기 위함
	update a	set 
		apply_price_before = std_price
	from	#temp4 a
	where	std_price = apply_price
	-- and	date_apply_from <= '2008-12-25'
	
	update a	set 
		apply_price_before = std_price
	from	#temp5 a
	where	std_price = apply_price
	-- and	date_apply_from <= '2008-12-25'
	
	
	------- 변경전 단가가 없을 경우, 적용단가 08.12.25일 이전 마지막단가 혹은 09년의 최초 적용단가를 변경전단가로 함-----------  
	update	a 
	set	apply_price_before = c.apply_price
	from	#temp4 a, #temp_610 c
	where	a.apply_price_before is null --3041
	and	a.item_no = c.item_no
	and	a.supply = c.supply
	and	c.date_apply_from = isnull((select	max(b.date_apply_from) from #temp3 b 
						where	a.item_no = b.item_no and a.supply = b.supply), 
					(select	min(b.date_apply_from) from #temp5 b 
						where	a.item_no = b.item_no and a.supply = b.supply))
	
	update	a set	
		apply_price_before = c.apply_price
	from	#temp5 a, #temp_610 c
	where	a.apply_price_before is null --3041
	and	a.item_no = c.item_no
	and	a.supply = c.supply
	and	c.date_apply_from = isnull((select	max(b.date_apply_from) from #temp3 b 
						where	a.item_no = b.item_no and a.supply = b.supply), 
					(select	min(b.date_apply_from) from #temp5 b 
						where	a.item_no = b.item_no and a.supply = b.supply))
	
	------- 변경전단가 없는 것
	update	a set	
		apply_price_before=std_price
	from	#temp4 a
	where	apply_price_before is null
	
	update	a set	
		apply_price_before=std_price
	from	#temp5 a
	where	apply_price_before is null


	------- 도입품은 STD단가를 변경전단가 로 넣음
	update	a set	
		apply_price_before=std_price
	from	#temp4 a
	where	supply = 'I'


	------- 각 단가별 수량 SUM 이력 만들기 ----------- 2008.12.25 이전 이력 안만듦, 이후 만듦
	select	item_no, supply, trade_no, date_apply_before, doc_before, date_apply_from, agreement_doc, date_apply_after,
		std_price, apply_price_before, 
		apply_price=isnull((case supply when 'I' then price_won else apply_price end), ''),
		money_unit,price, price_won, qty
	into	#temp6
	from	#temp4
	where	(date_apply_from <= @std_date or qty=0 or supply = 'I')
	order by date_apply_from
	
	delete	a
	from	#temp4 a
	where	(date_apply_from <= @std_date or qty=0 or supply = 'I')
	
	insert into #temp6
	select	b.item_no, b.supply, b.trade_no, 
		b.date_apply_before, b.doc_before, b.date_apply_from, b.agreement_doc, b.date_apply_after,
		b.std_price, b.apply_price_before, b.apply_price, b.money_unit,
		a.price, a.price_won, a.qty
	from	#temp4 a, #temp5 b
	where	a.item_no = b.item_no
	and	a.supply = b.supply
	and	a.trade_no = b.trade_no
	and	a.date_apply_from >= b.date_apply_from
	order by a.date_apply_from,b.date_apply_from
	
	if @CarryOver = 0 --PPV
	begin 
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				--diff_price = apply_price - apply_price_before,
				diff_price = apply_price - std_price, --PPV는 std차이로 이재상 20110127
				amut=(apply_price - apply_price_before)*qty,
				agreement_doc, 
				date_apply_from,

				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won
		into	T_Data_Download1
		from	#temp6 a
		order by item_no,trade_no,supply,qty,date_apply_from
		
	end
	else --CarrayOver
	begin
		select	item_no, 
				eng_desc= master.dbo.fGetItemDesc(a.item_no),
				supply, 
				qty, 
				std_price, 
				apply_price_before, 
				apply_price,
				diff_price = apply_price - apply_price_before,
				amut=(apply_price - apply_price_before)*qty,
				agreement_doc, 
				date_apply_from,
				date_apply_until = dateadd(day,365,date_apply_from),

				trade_name = master.dbo.fGetVendorName(a.trade_no),
				trade_no,
				price_won
		into	T_Data_Download1
		from	#temp6 a
		where date_apply_from between dateadd(year,-(@CarryOver) ,@from_date) 
												and convert(char(04),dateadd(year,-(@CarryOver) ,@from_date),112)+'-12-25 23:59:59'
		order by item_no,trade_no,supply,qty,date_apply_from
			
	end
	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end


set nocount off;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Down_130     (old:SP_isql_receipt)                                                             */
/*  DISCRIPTION  :  입고데이터 다운로드                                                                              */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2009/05/04     1.0   Y.M.KIM    Initialize                                                                        */
/* 2010/09/02     MRP Downsizing Project   J.J.Park      Mrp Downsizing Project                                      */
/* 2023-08-08                                 UNGJ         거래선  VARCHAR(8)변경                                    */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_130]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin



/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_130 'Down_130','2010-09-02 16:14:27.200',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung	varchar(04),
			@from_date	varchar(08),	-- 입고기간 From 
			@to_date	varchar(17),	-- 입고기간 To
			@std_Date	varchar(08),	-- 올해 단가 적용 기점일
			@Vendor	    varchar(08)	

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
			@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate')+' 23:59:00',
			@vendor=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download2') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download2
	end

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download3') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download3
	end

	declare	@request_emp_id	varchar(20)
	
	select @request_emp_id=request_emp_id
	from x_batch_job_option
	where job_id=@job_id
	and page=@page
	
	select	junpyo_no
		,date_io
		,item_no
		,eng_desc = replace(master.dbo.fGetItemDesc(a.item_no),';',' ')
		,gaijung
		,store
		,supply
		,prod_no
		,order_no
		,qty
		,qty_add
		,amut
		,trade_no
		,wc_code
		,post_person
		,date_issue
		,item_unit
		,io_select
		,matr_amount
		,appl_mold_qty
		,run_status
		,tr
		,insp_select
		,file_no
		,qty_deliv
		,qty_insp
		,qty_acpt
		,qty_special
		,qty_fail
		,price_won
		,price_foreign
		,amut_won
		,amut_foreign
		,money_unit
		,amut_mold
		,date_price
		,date_insp
		,date_modif
		,gu_select
		,RED_JP_NO
		,RED_CODE
		,RED_STATUS
		,SPECIAL_REJ_CODE
		,FACTORY_GUBUN
		,PART
	into T_Data_Download1
	from	el_cd..t_va_040 a with (index=ix_t_va_040_5 nolock)
	where date_io between @from_date and @to_date
	and gaijung like left(@o_gaijung,2) + '%'
	and (@vendor < '0' or trade_no=@vendor)
	order by JUNPYO_NO


	exec xp_Common_BCP_output @page,@Job_ID,'1'

	if @request_emp_id in ('211300','lgjjg')	
	begin
		select	junpyo_no
				,date_io
				,item_no
				,eng_desc = replace(master.dbo.fGetItemDesc(a.item_no),';',' ')
				,gaijung
				,store
				,supply
				,prod_no
				,order_no
				,qty
				,qty_add
				,amut
				,trade_no
				,wc_code
				,post_person
				,date_issue
				,item_unit
				,io_select
				,matr_amount
				,appl_mold_qty
				,run_status
				,tr
				,insp_select
				,file_no
				,qty_deliv
				,qty_insp
				,qty_acpt
				,qty_special
				,qty_fail
				,price_won
				,price_foreign
				,amut_won
				,amut_foreign
				,money_unit
				,amut_mold
				,date_price
				,date_insp
				,date_modif
				,gu_select
				,RED_JP_NO
				,RED_CODE
				,RED_STATUS
				,SPECIAL_REJ_CODE
				,FACTORY_GUBUN
				,PART
		into T_Data_Download2
		from	el_cd..t_va_040 a with (index=ix_t_va_040_5 nolock)
		where date_io between @from_date and @to_date
		and left(gaijung,2)='SP'
		and (@vendor < '0' or trade_no=@vendor)
		order by JUNPYO_NO


		exec xp_Common_BCP_output @page,@Job_ID,'2'
		
		select	junpyo_no
				,date_io
				,item_no
				,eng_desc = replace(master.dbo.fGetItemDesc(a.item_no),';',' ')
				,gaijung
				,store
				,supply
				,prod_no
				,order_no
				,qty
				,qty_add
				,amut
				,trade_no
				,wc_code
				,post_person
				,date_issue
				,item_unit
				,io_select
				,matr_amount
				,appl_mold_qty
				,run_status
				,tr
				,insp_select
				,file_no
				,qty_deliv
				,qty_insp
				,qty_acpt
				,qty_special
				,qty_fail
				,price_won
				,price_foreign
				,amut_won
				,amut_foreign
				,money_unit
				,amut_mold
				,date_price
				,date_insp
				,date_modif
				,gu_select
				,RED_JP_NO
				,RED_CODE
				,RED_STATUS
				,SPECIAL_REJ_CODE
				,FACTORY_GUBUN
				,PART
		into T_Data_Download3
		from	el_cd..t_va_040 a with (index=ix_t_va_040_5 nolock)
		where date_io between @from_date and @to_date
		and left(gaijung,2)='SY'
		and (@vendor < '0' or trade_no=@vendor)
		order by JUNPYO_NO


		exec xp_Common_BCP_output @page,@Job_ID,'3'
	end
	

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Down_140     (old:sp_isql_sagup)                                                               */
/*  DISCRIPTION  :  유무상사급전표                                                                                   */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2009/05/04     1.0   Y.M.KIM    Initialize                                                                        */
/* 2010/09/02     MRP Downsizing Project   J.J.Park      Mrp Downsizing Project                                      */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_140]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin

/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_140 'Down_140','2010-09-23 14:04:12.463',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung	varchar(04),
		@from_date	varchar(08),	-- 입고기간 From 
		@to_date	varchar(08),	-- 입고기간 To
		@std_Date	varchar(08),	-- 올해 단가 적용 기점일
		@Vendor	    varchar(08)	

	declare	@request_emp_id	varchar(20)
	
	select @request_emp_id=request_emp_id
	from x_batch_job_option
	where job_id=@job_id
	and page=@page
	
	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
		@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate')
		

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download2') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download2
	end
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download3') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download3
	end

	select a.jp_no
		,a.trade_no
		,brief_trade = master.dbo.fGetVendorName(a.trade_no)
		,a.item_no
		,eng_desc = master.dbo.fGetItemDesc(a.item_no)
		,a.supply
		,a.date_issue
		,a.order_no
		,a.prod_no
		,a.qty
		,a.price
		,a.amut
		,a.post_person
		,a.date_account
		,a.pass_no
		,a.price_buy
		,in_amut=a.qty * a.price_buy
		,out_amut = b.amt
		,a.gaijung
		,a.out_use
		,a.print_cnt
		,a.invoice_no
		,a.cancel_date
		,std_cost = ( case a.supply when 'i' then(select b.standard_price from el_cd..t_cx_614 b where b.year = left(@to_date,4) and a.item_no = b.item_no )
				else (select c.standard_price from el_cd..t_cx_613 c where c.year = left(@to_date,4) and a.item_no = c.item_no and c.order_select = a.supply) end)
	into T_Data_Download1
	 from el_cd..t_va_050 a with (index=ix_t_va_050_1 nolock)
		left outer join t_mva_041 b with (nolock)
			on b.jp_no = 'G' + a.jp_no
	where a.date_issue between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
	and (@o_gaijung < '0' or left(a.gaijung,2) = left(@o_gaijung,2) )

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	if @request_emp_id in ('211300','lgjjg')	
	begin
		select a.jp_no
			,a.trade_no
			,brief_trade = master.dbo.fGetVendorName(a.trade_no)
			,a.item_no
			,eng_desc = master.dbo.fGetItemDesc(a.item_no)
			,a.supply
			,a.date_issue
			,a.order_no
			,a.prod_no
			,a.qty
			,a.price
			,a.amut
			,a.post_person
			,a.date_account
			,a.pass_no
			,a.price_buy
			,in_amut=a.qty * a.price_buy
			,out_amut = b.amt
			,a.gaijung
			,a.out_use
			,a.print_cnt
			,a.invoice_no
			,a.cancel_date
			,std_cost = ( case a.supply when 'i' then(select b.standard_price from el_cd..t_cx_614 b where b.year = left(@to_date,4) and a.item_no = b.item_no )
					else (select c.standard_price from el_cd..t_cx_613 c where c.year = left(@to_date,4) and a.item_no = c.item_no and c.order_select = a.supply) end)
		into T_Data_Download2
		 from el_cd..t_va_050 a with (index=ix_t_va_050_1 nolock)
			left outer join t_mva_041 b with (nolock)
				on b.jp_no = 'G' + a.jp_no
		where a.date_issue between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
		and (@o_gaijung = 'ELES' and left(a.gaijung,2) = 'SP' ) --ELES신청시 OSCK출력
		
		exec xp_Common_BCP_output @page,@Job_ID,'2'
		
		select a.jp_no
			,a.trade_no
			,brief_trade = master.dbo.fGetVendorName(a.trade_no)
			,a.item_no
			,eng_desc = master.dbo.fGetItemDesc(a.item_no)
			,a.supply
			,a.date_issue
			,a.order_no
			,a.prod_no
			,a.qty
			,a.price
			,a.amut
			,a.post_person
			,a.date_account
			,a.pass_no
			,a.price_buy
			,in_amut=a.qty * a.price_buy
			,out_amut = b.amt
			,a.gaijung
			,a.out_use
			,a.print_cnt
			,a.invoice_no
			,a.cancel_date
			,std_cost = ( case a.supply when 'i' then(select b.standard_price from el_cd..t_cx_614 b where b.year = left(@to_date,4) and a.item_no = b.item_no )
					else (select c.standard_price from el_cd..t_cx_613 c where c.year = left(@to_date,4) and a.item_no = c.item_no and c.order_select = a.supply) end)
		into T_Data_Download3
		 from el_cd..t_va_050 a with (index=ix_t_va_050_1 nolock)
			left outer join t_mva_041 b with (nolock)
				on b.jp_no = 'G' + a.jp_no
		where a.date_issue between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
		and (@o_gaijung = 'ELES' and left(a.gaijung,2) = 'SY' ) --ELES신청시 주차출력
		
		exec xp_Common_BCP_output @page,@Job_ID,'3'
	end

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Down_150     (old:sp_isql_sagup)                                                               */
/*  DISCRIPTION  :  Apply Price Download                                                                             */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  _______________________________________________________________                                                  */
/* 2010/09/09     MRP Downsizing Project   J.G. Jeon      Mrp Downsizing Project                                     */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_150]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_150 'Down_150','2010-09-09 12:39:07.623',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@Gaijung	varchar(04),
		@price_sort	char(01),  -- 단가종류 A:적용단가 D:판매단가
		@price_select	char(01),  -- 단가선택 1:All History 2:최근단가만 
		@from_date	varchar(08),	
		@to_date	varchar(08),	
		@Vendor1	varchar(08),
		@Vendor2	varchar(08),
		@Vendor3	varchar(08)


	select	@Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@price_sort=mrp.dbo.fGetOption(@Job_ID,@page,'PriceSort'),
		@price_select=mrp.dbo.fGetOption(@Job_ID,@page,'PriceSelect'),
		@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
		@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate'),
		@Vendor1=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor1'),
		@Vendor2=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor2'),
		@Vendor3=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor3')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	select 	a.item_no,c.eng_desc,c.item_unit,
		a.order_select,a.vendor,
		brief_trade=master.dbo.fGetVendorName(a.vendor),
		date_apply_from=convert(varchar(08),a.date_apply_from,112),
		a.agreement_doc,
	   	a.apply_price,
		a.apply_flag,
		currency=a.money_unit
	into T_Data_Download1
	from	el_cd..t_cx_610 a with (nolock), 
		el_cd..T_CX_060 c with (nolock)
	where a.vendor in (@vendor1,@vendor2,@vendor3)
	and a.price_sort = @price_sort
	and date_apply_from between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
	and apply_flag = 'Y'
	and (@price_select = '1' or 
		@price_select='2' and 
		a.date_apply_from = (select max(b.date_apply_from)
					from el_cd..t_cx_610 b  with (nolock)
					where b.item_no=a.item_no
					and b.price_sort             =a.price_sort   
					and b.vendor       =a.vendor                   
					and b.order_select    =a.order_select    
					and b.work_mtd         =a.work_mtd         
					and b.money_unit     =a.money_unit 
					and b.apply_flag = 'Y' ) )
	and c.item_no=a.item_no
	and (	left(@gaijung,2)='SY' and left(c.gaijung,2) = left(@gaijung,2) or
		left(@gaijung,2)<>'SY' and isnull(c.gaijung,'') < '0'  ) 
	

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*********************************************************************************************************************/
/*  SP NAME      : SP_Down_160     (old:sp_isql_sagup)                                                               */
/*  DISCRIPTION  :  Open PO Download                                                                                 */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  _______________________________________________________________                                                  */
/* 2010/10/01     MRP Downsizing Project   J.M. Song     Mrp Downsizing Project                                      */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_160]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin



/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_160 'Down_160','2010-09-09 12:39:07.623',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@Gaijung	varchar(04),
			@from_date	varchar(08),	
			@to_date	varchar(08),	
			@Vendor		varchar(08),
			@supply1	char(01),
			@supply2	char(01),
			@supply3	char(01),
			@supply4	char(01)


	select	@Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate'),
			@To_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate'),
			@Vendor=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor'),
			@supply1=mrp.dbo.fGetOption(@Job_ID,@page,'supply1'),
			@supply2=mrp.dbo.fGetOption(@Job_ID,@page,'supply2'),
			@supply3=mrp.dbo.fGetOption(@Job_ID,@page,'supply3'),
			@supply4=mrp.dbo.fGetOption(@Job_ID,@page,'supply4')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	select 	a.run_status,
			a.trade_no,
			brief_trade=master.dbo.fGetVendorName(a.trade_no),

			a.item_no,
			eng_desc=isnull(c.eng_desc,''),
			item_unit=isnull(c.item_unit,''),

			prod_no=a.prod_no+' '+a.part+' '+a.part_seq,
			price=(case when a.supply='I' then a.price_r else a.price end),
			amt=a.qty_order*(case when a.supply='I' then a.price_r else a.price end),
			
			a.order_no,
			date_due=convert(char(08),a.date_due,112),
			date_print_po=convert(char(08),a.date_print_po,112),
			a.supply,
			a.qty_order,
			qty_remain=(a.qty_order - a.qty_cancel-a.qty_input),
			a.po_gubun,
			ship_no=(select isnull(max(d.ship_no),'') from EL_CD..T_EB_050 d where d.project_no = left(a.prod_no,11) and d.mfg_no = substring(a.prod_no,12,3) and d.part = a.part and d.part_seq = a.part_seq)
	into T_Data_Download1
	from	el_cd..t_va_020 a with (index=ix_t_va_020_8 nolock)
				left outer join el_cd..T_CX_060 c with (nolock)
					on	c.item_no=a.item_no
	where a.run_status between '' and '4'
	and a.date_due between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
	and (@vendor < '0' or a.trade_no = @vendor)
	and left(a.gaijung,2)=left(@gaijung,2)
	and (@supply1 < '0' or a.supply in (@supply1,@supply2,@supply3,@supply4) )
	
	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*****************************************************************************************************************
*  SP NAME      : SP_Down_170     (old:sp_isql_sagup)                          
*  DISCRIPTION  : 관세환급 Download                                            
*                                                                              
*  >> MODIFICATION LOG <<                                                      
*  DATE        REQUEST #                      S.E NAME         DESCRIPTION     
*  -------------------------------------------------------------------------
* 2010/12/01     관세환급 다운로드            LGKYM           MRP Downsize 제외 화면 추가 개발
* 2013/05/23     관세환급 다운로드            LGJJG           관세환급 대상 선정 변경(수출품 선정 변경, 대상선정시 추가박스 제외)
* 2023-08-08                                  UNGJ            거래선  VARCHAR(8)변경                                  
*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Down_170]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin


/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 
EXEC SP_Down_170 'DOWN_170','2010-12-01 14:51:20.050',@status output,@out_msg output

select @status,@out_msg

*/

	declare	@year_month varchar(06),
			@from_date	varchar(23),	
			@to_date	varchar(23)

	select	@year_month=mrp.dbo.fGetOption(@Job_ID,@page,'YearMonth')
	
	select @from_date = @year_month + '01 00:00:00',
		@To_date = @year_month+right(convert(char(08),dateadd(d,-1,dateadd(m,1,@year_month+'01')),112),2) + ' 23:59:00' 
			
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
/*
/*기간별 EL수출 출하번호*/
    select a.ship_no
    into #temp_ship_no
    from el_cd..t_ec_020 a with (nolock)
    where a.date_pass between @from_date and @to_date
    and a.product_code in ( 'EL','GE','GL')
    and a.market_flag = 'E'
    group by a.ship_no
    
/*대상 제번 리스트*/
    select distinct b.project_no, b.mfg_no
    into #temp_050
    FROM #temp_ship_no a, el_cd..T_EB_050 b with (nolock)
    WHERE a.ship_no = b.ship_no    
*/
    
/*위의 2개의 SP를 통합함*/    
    select distinct b.project_no, b.mfg_no
    into #temp_050
    from el_cd..t_ec_020 a with (nolock), el_cd..T_EB_050 b with (nolock), el_cd..T_CC_010 c with (nolock)
    where a.date_pass between @from_date and @to_date
    and a.product_code in ( 'EL','GE','GL')
    and b.ship_no = a.ship_no
    and b.box_no <> 'AA'
    and c.project_no = b.project_no
    and c.mfg_no = b.mfg_no
    and c.market_flag = 'E'
    
    
/*지정월 이전 출하 삭제(최초 출하제번만 유효)*/
	delete a
    FROM #temp_050 a
		inner join el_cd..T_EB_050 b with (nolock)
		on b.project_no = a.project_no
		and b.mfg_no = a.mfg_no
		and b.box_no <> 'AA'
	where b.date_ship < @from_date


/*해당 출하번호에 실린 제번,항번의 수량*/
    SELECT b.project_no, b.mfg_no, b.part, b.part_seq, b.item_no, qty =sum(qty)
    INTO #TEMP_050_qty
    FROM #temp_050 a
		inner join el_cd..T_EB_050 b with (nolock)
		on b.project_no = a.project_no
		and b.mfg_no = a.mfg_no
	group by b.project_no, b.mfg_no, b.part, b.part_seq, b.item_no
	order by b.project_no, b.mfg_no, b.part, b.part_seq


/*BOM 전개용 임시테이블 생성*/
    create table #expl_sourceXX(project_no varchar(11), mfg_no varchar(3), item_no varchar(15), qty real)
    create table #expl_source(project_no varchar(11), mfg_no varchar(3), item_no varchar(15), qty real)
    create table #final_resultXX (max_level int, draw_seq_str varchar (1000),ori_item_no varchar(15),p_item_no varchar (15),b_sheet_no varchar (1000),b_line_no varchar (1000),c_item_no char (15),
		b_bom_level int,b_unit_qty numeric(15,3),b_req_qty numeric(15,3) ,b_unit_weight numeric(15,3) ,b_req_weight numeric(15,3),b_mark char (10),b_matl_size char (50),
		i_eng_desc char (30),i_item_group_sub varchar(10),i_block char(01),i_item_select char(1),i_item_unit char (2),
		i_auto_order_flag char(01),i_vendor VARCHAR(08),i_po_post_person char(04),i_size varchar (25),i_quality varchar (25),i_draw_no varchar (25),i_order_select char (1),
		i_keep_flag char(01),i_date_update smalldatetime,i_rev_no char (2),i_date_receive smalldatetime,i_price float,i_rout_type char(05),i_drawlastupdate char(10),
		i_pdmDrawNo varchar(25),i_pdmJakGu varchar(3),i_pdmUniquNo varchar(4),i_pdmPart varchar(2),i_pdmSymBolTypeCode char(1),i_pdmProductCode varchar(3),i_pdmMrpAppliedGubun char(1),err varchar(50))
    create table #result(project_no varchar(11), mfg_no varchar(3),ori_item_no varchar(15), item_no varchar(15), req_qty real, unit_qty real)

	-- !!!수불대장 아이템을 사용!!!, 수량은 출하(EB_050)
    insert into #expl_sourceXX
    select a.project_no, a.mfg_no, b.item_no, qty =sum(qty) --<<해당월출하수량 || 수배수량>>--cont_qty = sum(cont_qty),
    from #TEMP_050_qty a	
		inner loop join el_cd..t_ca_011 b with (nolock)
			on b.project_no = a.project_no
			and b.mfg_no = a.mfg_no
			and b.part = a.part
			and b.part_seq = a.part_seq
			and b.product_code in ('EL','GL','GE')
			and b.market_flag = 'E'
			and b.gaijung like 'EL%'
			--and b.cont_qty > 0 --수배취소지만 이미 출하된것은?? 일단은 포함
    group by a.project_no, a.mfg_no, b.item_no
	order by a.project_no, a.mfg_no, b.item_no

/*사용된 도번 전체를 미리 전개 : 같은 item이 여러 제번에 중복됨.*/
	truncate table #final_resultXX
	truncate table #result

	declare @process_id char(36),
			@item_no varchar(15)

    select @process_id  = newid()

    insert into el_cd..T_CX_066 
    select @process_id, item_no,'1','','','',''
    from #expl_sourceXX
	group by item_no
	
    insert into #final_resultXX
    EXEC el_cd..S_CX_060_001 @process_id, 'PRODQUERY','FORWARD','',100,'PARTLIST','ADILMSXZ','M','N','N','MAXZ'

    insert into #result
    select     
        a.project_no,
        a.mfg_no,
        ori_item_no = ori_item_no,
        item_no = c_item_no,
        req_qty = convert(float,b_req_qty) * a.qty,
        unit_qty = b_req_qty
    from #expl_sourceXX a
		inner join #final_resultXX b
			on b.ori_item_no = a.item_no 
    where i_order_select='I' 
    order by a.project_no,a.mfg_no, c_item_no
    
/*결과 출력*/
    select 
		Data = 
		convert(char(4),b.gaijung)
		+ convert(char(1),b.market_flag)
		+ right(convert(char(11),b.project_no),9)
		+ convert(char(03),b.mfg_no)
		+ convert(char(03),b.model)
		+ right('00' + convert(char(02),b.capa_person),2)
		+ convert(char(02),b.open_type)
		+ convert(char(03),b.speed) 
		+ right(space(07) + convert(varchar(03),b.floor),7)
		+ space(09) --생산주들어갈자리...
		+ convert(char(15),a.item_no)
		+ convert(char(02),c.item_unit)
		+ convert(char(30),c.eng_desc)
		+ convert(char(25),c.size)
		+ convert(char(01),c.order_select)
		+ right('0000000000' + convert(varchar(10),cast(req_qty as decimal(8,2))),10)
		+ right('0000000000' + convert(varchar(10),cast(unit_qty as decimal(8,2))),10)
	into T_Data_Download1
    from #result a, el_cd..t_cc_010 b with (index=PK_T_CC_010_1__15 nolock), el_cd..t_cx_060 c with (nolock)
    where b.project_no = a.project_no
    and b.mfg_no = a.mfg_no
    and c.item_no = a.item_no
	order by b.gaijung,b.market_flag,b.project_no,b.mfg_no

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*************************************************************************************
 * Down_210 : Not Ipgo By Prod_No
 *
 * DISCRIPTION		: 제번별 미입고 자료 제공용 SP (변혜진 과장님 요청 사항)
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: LGJJG
 *
 * CREATE_DAY		: 2021년 10월 25일
 *
 * MODIFICATION_LOG
 *
 *  VER		DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	----------      -------       -----------
 *  1.0		2021-10-25						          initial
 *  1.2     2023-07-18                   UNGJ	      CANCEL 수량에서 제외처리 
 *************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_210]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin
	-- grant exec on SP_Down_210 to applications

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_210 'Down_210','2021-10-25 16:00:36.570',@status output,@out_msg output

select @status,@out_msg

-----

select *
from T_Data_Download1

*/
	declare	@o_yyyymmdd	varchar(08)

	select	@o_yyyymmdd=mrp.dbo.fGetOption(@Job_ID,@page,'BaseDate')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	--/*
	
	select prod_no, sum_amut = sum(price * qty_order)
	into #aa
	from el_cd..t_va_020 with (nolock)
	where run_status = '4'
	and gaijung in ('SPSS','ELES')
	and prod_no >= '0'
	AND qty_cancel = 0                                                        --CANCEL 수량은 제외 반여하여야 함 20230718
	and date_print_po between '20140101' and @o_yyyymmdd + ' 23:59:59'
	group by prod_no


	select b.ORDER_NO, b.AMUT
	into #bb
	from el_cd..t_va_040 b with (nolock)
	where b.date_io >= dateadd(d,1, @o_yyyymmdd)



	insert into #aa
	select a.prod_no, sum_amut=sum(b.amut)
	from #bb b, el_cd..t_va_020 a with (index=PK_T_VA_020_1__27 nolock) 
	where a.order_no = b.order_no
	and a.date_print_po <= @o_yyyymmdd + ' 23:59:59'
	and a.run_status = '5'
	and a.gaijung in ('SPSS','ELES')
	and a.prod_no    >= '0'
	AND A.qty_cancel = 0                                                        --CANCEL 수량은 제외 반여하여야 함 20230718
	group by a.prod_no


	select prod_no, brief_trade = (select b.brief_trade from el_cd..t_cc_010 b where b.project_no = left(a.prod_no,11) and b.mfg_no = right(a.prod_no,3)),
			금액=sum(a.sum_amut)
	into T_Data_Download1
	from #aa a
	group by prod_no
	order by prod_no

	--*/

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*************************************************************************************
 * Down_220 : Sourcing 내역
 *
 * DISCRIPTION		: 월별 Sourcing 자료 제공용 SP (권영백 부장님 요청 사항)
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: LGJJG
 *
 * CREATE_DAY		: 2021년 10월 25일
 *
 * MODIFICATION_LOG
 *
 *  VER		DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	----------      -------       -----------
 *  1.0		2021-10-25						          initial
 *************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_220]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin
	-- grant exec on SP_Down_220 to applications

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_220 'Down_220','2021-10-25 16:00:36.570',@status output,@out_msg output

select @status,@out_msg

-----

select *
from T_Data_Download1

*/
	declare	@o_from_date	varchar(08)
	declare	@o_to_date	varchar(08)

	select	@o_from_date=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate')
	select	@o_to_date=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download2') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download2
	end

	
	select  GAIJUNG,
			Reporting_Entity_ID = 'OEK', 
			PO_Release_Date = (select b.date_print_po from EL_CD..T_VA_020 b WITH (NOLOCK) where b.order_no = a.order_no),
			YEAR=SUBSTRING(convert(varchar(8),date_io,112),1,4), 
			MONTH=SUBSTRING(convert(varchar(8),date_io,112),5,2),
			PO_NO = ORDER_NO, 
			prod_no,
			PART,
			PO_LINE = '',
			PO_Request_date=(select c.date_start from EL_CD..T_VA_020 c WITH (NOLOCK) where c.order_no = a.order_no),
			PO_Receipt_date = date_io,
			vendor = trade_no,
			vendor_name=(select d.brief_trade from EL_CD..T_cx_080 d WITH (NOLOCK) where d.trade_no = a.trade_no),
			Part_Number=ITEM_NO,
			Part_Description=(select e.eng_desc from EL_CD..T_cx_060 e WITH (NOLOCK) where e.item_no = a.ITEM_NO),
			Currency_Code = 'KRW',  -- money_unit,
			spend=amut,
			QTY= qty, 
			UOM=item_unit,
			PRICE=price_won,
			Direct='Direct' 
	into T_Data_Download1
	from EL_CD..T_VA_040 a WITH (NOLOCK)
	where a.DATE_IO between @o_from_date and @o_to_date + ' 23:59:00'  -- 26일, 25일까지로 변경.
	--and a.GAIJUNG = 'SPSS'
	and a.GAIJUNG = 'ELES'
	and a.QTY <> 0
	--ORDER BY GAIJUNG, PO_Receipt_date


	exec xp_Common_BCP_output @page,@Job_ID,'1'


	select  GAIJUNG,
			Reporting_Entity_ID = 'OEK', 
			PO_Release_Date = (select b.date_print_po from EL_CD..T_VA_020 b WITH (NOLOCK) where b.order_no = a.order_no),
			YEAR=SUBSTRING(convert(varchar(8),date_io,112),1,4), 
			MONTH=SUBSTRING(convert(varchar(8),date_io,112),5,2),
			PO_NO = ORDER_NO, 
			prod_no,
			PART,
			PO_LINE = '',
			PO_Request_date=(select c.date_start from EL_CD..T_VA_020 c WITH (NOLOCK) where c.order_no = a.order_no),
			PO_Receipt_date = date_io,
			vendor = trade_no,
			vendor_name=(select d.brief_trade from EL_CD..T_cx_080 d WITH (NOLOCK) where d.trade_no = a.trade_no),
			Part_Number=ITEM_NO,
			Part_Description=(select e.eng_desc from EL_CD..T_cx_060 e WITH (NOLOCK) where e.item_no = a.ITEM_NO),
			Currency_Code = 'KRW',  -- money_unit,
			spend=amut,
			QTY= qty, 
			UOM=item_unit,
			PRICE=price_won,
			Direct='Direct' 
	into T_Data_Download2
	from EL_CD..T_VA_040 a WITH (NOLOCK)
	where a.DATE_IO between @o_from_date and @o_to_date + ' 23:59:00'  -- 26일, 25일까지로 변경.
	and a.GAIJUNG = 'SPSS'
	--and a.GAIJUNG = 'ELES'
	and a.QTY <> 0
	--ORDER BY GAIJUNG, PO_Receipt_date


	exec xp_Common_BCP_output @page,@Job_ID,'2'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*************************************************************************************
 * Down_230 : FG 재고 내역(위치 포함) 조회
 *
 * DISCRIPTION		: FG 재고 내역(위치 포함) 제공용 SP (변혜진 과장님 요청 사항)
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: LGJJG
 *
 * CREATE_DAY		: 2021년 10월 25일
 *
 * MODIFICATION_LOG
 *
 *  VER		DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	----------      -------       -----------
 *  1.0		2021-10-25						          initial
 *************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_230]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin
	-- grant exec on SP_Down_230 to applications

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_230 'Down_230','2021-10-25 16:00:36.570',@status output,@out_msg output

select @status,@out_msg

-----

select *
from T_Data_Download1
*/
	declare	@o_Gaijung varchar(04)
	declare	@o_YearMonth varchar(06)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')
	select	@o_YearMonth=mrp.dbo.fGetOption(@Job_ID,@page,'YearMonth')

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end

--===============================================================

 --1. 시작 : 수행할 연월 변경만 하면 됨. '202109'

	select	a.project_no,a.mfg_no,a.part,a.part_seq,
			amt=sum(matl_import+matl_domestic+matl_burden),
			work_time=sum(work_time),
			matl_other=sum(matl_other),
			labor=sum(labor),
			date_io=max(year_month)
	into #temp_041
	from el_cd..t_na_040_m_ssi a with (nolock), el_cd..t_cc_010 b with (nolock)
	where (year_month_f<'0' or year_month_f> @o_YearMonth)
	and (  a.year_month_e<=@o_YearMonth and a.year_month_e>'0')
	and year_month<=@o_YearMonth
	and a.project_no=b.project_no
	and a.mfg_no=b.mfg_no	
	and b.gaijung=@o_Gaijung
	and (@o_Gaijung='ELES' and '' in ('T','') or @o_Gaijung in ('SPSS','OSES')
		and (''='T' and left(a.mfg_no,1) in ('T','U') or ''='M' and left(a.mfg_no,1) in ('D') or '' not in ('T','M') and left(a.mfg_no,1) not in ('T','U','D'))	
		--and (@market_flag<'0' or b.market_flag in (@market_flag1,@market_flag2))
		and ('' in ('','T') or 
			 ''='X' and (b.market_flag in ('','') or SUBSTRING(a.project_no,5,2)='BE' and LEFT(a.mfg_no,1) in ('R','G') ) or
			 ''='C' and b.market_flag='' or
			 ''='M' and b.market_flag='' or
			 ''='E' and (b.market_flag='' and (SUBSTRING(a.project_no,5,2)<>'BE' or LEFT(a.mfg_no,1) not in ('R','G')) ) 
			)	 
	)
	group  by a.project_no,a.mfg_no,a.part,a.part_seq


--2. 두번째로 수행.

	select a.project_no,a.mfg_no,a.part,a.part_seq,stock_qty=sum(qty)
	into #temp_stock
	from #temp_041 a, el_cd..T_NA_040_Matl b with (nolock)
	where a.project_no=b.project_no
	and a.mfg_no=b.mfg_no	
	and a.part=b.part
	and a.part_seq=b.part_seq
	group by a.project_no,a.mfg_no,a.part,a.part_seq

-- 개별 cost 계산

-- drop table jjg_temp3

--3. jjg_temp3 작성.

	SELECT	c.project_no,c.mfg_no,item_group_sub=isnull(rtrim(ltrim(item_group_sub)),''),
			c.part,c.part_seq,item_no=isnull(a.item_no,''),
			eng_desc=master.dbo.fgetinfo_cx060('eng_desc',a.item_no),
			treat_method=isnull(a.treat_method,''),
			cause_code=isnull(a.cause_code,''),
			vbox_code=isnull(vbox_code,''),
			box_no=isnull(box_no,''),
			cont_qty=isnull(convert(float,a.cont_qty),0.0),
			prod_qty=isnull(convert(float,a.prod_qty),0.0),
			sale_qty=isnull(convert(float,a.sale_qty),0.0),
			stock_qty=isnull(convert(float,b.stock_qty),0.0),
			due_date=isnull(convert(char(08),a.due_date,112),''),
			rslt_date=isnull(convert(char(08),a.rslt_date,112),''),
			last_out_date=isnull(convert(char(08),a.last_out_date,112),''),
			fp=0,
			matl_cost=0,
			matl_other,
			labor,
			
			actual_cost=c.amt,
			st=work_time,
			plsr=isnull((select labor_multi from el_cd..t_cj_020 x where year=left(@o_YearMonth,4) and usage='M' and x.item_no=a.item_no),0),
			fxburden=matl_other,
			total=amt+labor+matl_other,

			rslt_date2=isnull(convert(char(08),c.date_io,112),''),
			concern_order_no=isnull(rtrim(a.concern_order_no),''),
			j_divide_seq=convert(tinyint,null),
			j_shipping_center=convert(char(1),''),
			j_box_income_center=convert(char(1),'')
	into #jjg_temp3
	FROM #temp_041 c
		left outer join #temp_stock b
		on 	b.project_no=c.project_no
			and b.mfg_no=c.mfg_no
			and b.part=c.part
			and b.part_seq=c.part_seq	
		left outer join el_cd..T_CA_011 a with (index=PK_T_CA_011_1__14 NOLOCK)
		on 	a.project_no=c.project_no
			and a.mfg_no=c.mfg_no
			and a.part=c.part
			and a.part_seq=c.part_seq


/*
	select *
	from #jjg_temp3
	where jjg_box_income_center=''
*/

--4. AA UPDATE 작성.
	-- ce/cs
	--select a.project_no, a.mfg_no, a.part, a.part_seq, c.box_income_center, c.shipping_center
	update a set j_shipping_center=c.shipping_center, j_box_income_center=c.box_income_center
	from #jjg_temp3 a, el_cd..t_eb_050 b with (nolock), el_cd..t_eb_040 c with (nolock)
	where a.project_no=b.project_no
	and a.mfg_no=b.mfg_no
	and a.part=b.part
	and a.part_seq=b.part_seq
	and a.box_no in ('AA')
	and b.ref_project_no=c.project_no
	and b.ref_mfg_no=c.mfg_no
	and b.ref_box_no=c.box_no
	and b.ref_divide_seq=c.divide_seq
	--and a.project_no='2018T  0596'
	--and a.mfg_no='R01'
	--and a.part='CS'
	--and a.part_seq='AKA0'

--5. AA가 아닌 것 UPDATE 작성.
	-- 정규박스
	--select a.project_no, a.mfg_no, a.part, a.part_seq, c.box_income_center, c.shipping_center
	update a set j_shipping_center=c.shipping_center, j_box_income_center=c.box_income_center
	from #jjg_temp3 a, el_cd..t_eb_050 b with (nolock), el_cd..t_eb_040 c with (nolock)
	where a.project_no=b.project_no
	and a.mfg_no=b.mfg_no
	and a.part=b.part
	and a.part_seq=b.part_seq
	and a.box_no not in ('AA')
	and b.project_no=c.project_no
	and b.mfg_no=c.mfg_no
	and b.box_no=c.box_no
	and b.divide_seq=c.divide_seq

--6. * 최종 자료 제공.

	select *
	into T_Data_Download1
	from #jjg_temp3 a
	where stock_qty<>0
	order  by a.project_no,a.mfg_no,a.part,a.part_seq

--==============================================================

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*************************************************************************************
 * Down_240 : Purchasing_Obligation 조회
 *
 * DISCRIPTION		: Purchasing_Obligation 제공용 SP (김재진 차장님 요청 사항)
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: LGJJG
 *
 * CREATE_DAY		: 2021년 10월 26일
 *
 * MODIFICATION_LOG
 *
 *  VER		DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	----------      -------       -----------
 *  1.0		2021-10-26						          initial
 *************************************************************************************/
	
CREATE PROCEDURE [dbo].[SP_Down_240]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

as
set nocount on
begin

-- grant exec on SP_Down_240 to applications

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_240 'Down_240','2021-10-25 16:00:36.570',@status output,@out_msg output

select @status,@out_msg

-----

select *
from T_Data_Download1
*/


	declare	@o_yyyymmdd	varchar(08)

	select	@o_yyyymmdd=convert(varchar(8),getdate(),112)

	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end

	--1-----------------------------------------------
	select  b.order_no, b.supply, sum(isnull(b.qty_order * b.price,0))  balance_amt
	into #aa
	from el_cd..t_va_020 b with(nolock)
	where b.date_print_po between '20160101' and @o_yyyymmdd + ' 23:59:00'
	and b.run_status IN ('4')
	and b.supply <> 'I'
	and b.gaijung <> 'SYHP'  
	group by b.order_no, b.supply

	--2-----------------------------------------------
	insert into #aa
	select  b.order_no, b.supply, sum(isnull(b.qty_order * (case b.money_unit when 'WON' then price else b.price_R end),0))  balance_amt
	from el_cd..t_va_020 b with(nolock)
	where b.date_print_po between '20160101' and @o_yyyymmdd + ' 23:59:00'
	and b.run_status IN ('4')
	and b.supply = 'I'
	and b.gaijung <> 'SYHP'   
	group by b.order_no, b.supply

	create index aa_i1 on #aa(order_no)

	--3-----------------------------------------------
	select a.order_no, c.run_status, c.date_due, c.supply, c.money_unit, a.balance_amt, 내수단가=c.price, 수입단가=c.price_r, 
			c.qty_order, c.qty_cancel, 주문잔량=c.qty_order, c.trade_no, 
			거래처명=(select brief_trade from el_cd..t_cx_080 b where b.trade_no = c.trade_no),
			c.item_no, c.gaijung  
	into T_Data_Download1
	from #aa a, el_cd..t_va_020 c with(nolock)
	where c.order_no = a.order_no
	order by c.supply, a.order_no

	--==============================================================

	exec xp_Common_BCP_output @page,@Job_ID,'1'

	select @status='0',@out_msg=' Down Ok ..'

end

set nocount off;

/*************************************************************************
*  SP NAME      : SP_Down_61W 
*  DISCRIPTION  : 발주금액 Download
*                                  
*  >> MODIFICATION LOG <<          
*  DATE        REQUEST #                  S.E NAME      DESCRIPTION 
*  ---------------------------------------------------------------
* 2010/10/05     MRP Downsizing Project   J.M.Song      Initialize
* 2011/04/13											날짜 필드 공백시 "00000000"으로 변경
**************************************************************************/
-- grant exec on SP_Down_61W to applications

CREATE PROCEDURE [dbo].[SP_Down_61W]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON

	declare	@Gaijung			varchar(04),
			@FromDate 	        varchar(08),
			@ToDate		        varchar(08),
			@Supply                   varchar(01),
			@Run_Status            varchar(01),
			@Work_Type            varchar(01)
			
	select	@Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')
	select	@FromDate=mrp.dbo.fGetOption(@Job_ID,@page,'FromDate')
	select	@ToDate=mrp.dbo.fGetOption(@Job_ID,@page,'ToDate')
	select	@Supply=mrp.dbo.fGetOption(@Job_ID,@page,'Supply')
	select	@Run_Status=mrp.dbo.fGetOption(@Job_ID,@page,'Run_Status')
	select	@Work_Type=mrp.dbo.fGetOption(@Job_ID,@page,'Work_Type')
	
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	IF @Work_Type = '1'
	BEGIN
                select       data = gaijung +
                                convert(char(08), order_no) +
                                convert(char(15), a.item_no) +
                                money_unit +
                                supply +
                                isnull(convert(char(08), date_due, 112), '00000000') +
                                run_status +
                                convert(char(08), isnull(trade_no,'')) +
                                right(space(14)+ convert(varchar(14), convert(decimal(14,2), isnull((case when a.supply = 'I' then a.price_r else a.price end), 0))), 14) +
 --                               price=(case when a.supply = 'I' then a.price_r else a.price end),
                                right(space(12)+ convert(varchar(12), convert(decimal(13,2), qty_order - qty_cancel)), 12) + 
 --                               qty_order = qty_order - qty_cancel,
                                right(space(13)+ convert(varchar(13), isnull((case when a.supply = 'I' then a.price_r else a.price end), 0) * a.qty_order), 13) +
 --                               amt=(case when a.supply = 'I' then a.price_r else a.price end)*a.qty_order,
                                right(space(12)+ convert(varchar(12), convert(decimal(12,2), a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject)), 12)
  --                              remain_qty = a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject
                into T_Data_Download1
                from el_cd.dbo.T_VA_020 a with (index = IX_T_VA_020_4 nolock) 
                where date_due between @FromDate + ' 00:00:00' and @ToDate + ' 23:59:00'
                and left(gaijung, 2) = left(@gaijung, 2)
                and (@supply < '0' OR a.supply = @supply)
                and (@run_status < '0' OR a.run_status = @run_status)
        END
	IF @Work_Type = '2'
	BEGIN
                select       data = gaijung +
                                trade_no +
                                isnull(convert(char(08), date_due, 112), '00000000') +
                                right(space(13)+ convert(varchar(13), isnull((case when a.supply = 'I' then a.price_r else a.price end), 0) * a.qty_order), 13)
 --                               amt=(case when a.supply = 'I' then a.price_r else a.price end)*a.qty_order
                into T_Data_Download1
                from el_cd.dbo.T_VA_020 a with (index = IX_T_VA_020_4 nolock) 
                where date_due between @FromDate + ' 00:00:00' and @ToDate + ' 23:59:00'
                and left(gaijung, 2) = left(@gaijung, 2)
                and (@supply < '0' OR a.supply = @supply)
                and (@run_status < '0' OR a.run_status = @run_status)
        END
 	IF @Work_Type = '3'
	BEGIN
                select       data = a.gaijung +
                                convert(char(15), a.item_no) +
                                convert(char(30), master.dbo.fGetItemDesc(a.item_no)) +
                                convert(char(08), isnull(trade_no,'')) +
                                convert(char(30), master.dbo.fGetVendorName(a.trade_no)) + 
                                item_unit +
                                supply +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,4), isnull((case when a.supply = 'I' then a.price_r else a.price end), 0))), 15) +
                                convert(char(12), substring(a.prod_no, 3, 12)) +
                                convert(char(01), isnull(a.insp_select,'')) +
                                run_status +
                                convert(char(08), order_no) +
                                isnull(convert(char(08), date_due, 112), '00000000') +
                                isnull(convert(char(08), date_print_po, 112), '00000000') +
                                isnull(convert(char(08), date_start, 112), '00000000') +
                                isnull(convert(char(08), date_deliv, 112), '00000000') +
                                isnull(convert(char(08), date_po, 112), '00000000') +
                                isnull(convert(char(08), date_chg, 112), '00000000') +
                                isnull(convert(char(08), date_last, 112), '00000000') +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_order - qty_cancel)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_input)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), 0)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_cancel)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_deliv)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_insp)), 15) +
                                right(space(15)+ convert(varchar(15), convert(decimal(15,3), qty_reject)), 15) +
                                + '  ' + part
                into T_Data_Download1
                from el_cd.dbo.T_VA_020 a with (nolock) 
                where ((date_last is not null and date_last between @FromDate + ' 00:00:00' and @ToDate + ' 23:59:00') or
                           (date_last is null and date_start between @FromDate + ' 00:00:00' and @ToDate + ' 23:59:00'))
                and left(gaijung, 2) = left(@gaijung, 2)
                and a.run_status in ('3','4','5')
        END   
				
	exec xp_Common_BCP_output @page,@Job_ID,'1'
	
	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

/**************************************************************************************************************/
/*  SP NAME      : SP_Down_6AF                                                                                */
/*  DISCRIPTION  : 구매 계획 현황 Download                                                                    */ 
/*                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                  S.E NAME      DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                           */
/* 2010/08/16     MRP Downsizing Project   J.G.Jeon      Initialize                                           */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_6AF]	
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON
/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_Down_6AF 'Down_6AF','2010-08-13 14:42:39.333',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@Gaijung			varchar(04),
			@FromOrderNo		varchar(08),
			@ToOrderNo			varchar(08)

	select	@Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')
	select	@FromOrderNo=mrp.dbo.fGetOption(@Job_ID,@page,'FromOrderNo')
	select	@ToOrderNo=mrp.dbo.fGetOption(@Job_ID,@page,'ToOrderNo')
	
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
    select	        id_no=  IDENTITY(int,1,1),
			a.item_no,
--			qty_stock=(select qty_stock from t_mva_061 b where b.item_no = a.item_no and b.gaijung = @gaijung and b.store = 'WH'+@gaijung and b.order_select = a.supply),
			qty_stock=isnull((select qty_stock from t_mva_061 b where b.item_no = a.item_no and b.gaijung = @gaijung and b.store = 'WH'+@gaijung and b.order_select = a.supply),0),
			a.req, 
			a.order_no, 
			a.gaijung, 
			a.supply, 
			a.trade_no, 
			max_order='    ',
			po_post=LEFT(po_post_person,2),
			po_person=substring(po_post_person,3,2), 
			a.insp_select, 
			a.item_unit, 
			a.date_start, 
			a.qty_order,
			eng_desc=master.dbo.fGetItemDesc(a.item_no),
			a.market_flag, 
			post_person=LEFT(a.post_person,2) + ' - ' + SUBSTRING(a.post_person,3,2),
			a.prod_no, 
			a.part, 
			a.skp, 
			brief_trade=master.dbo.fGetVendorName(a.trade_no),
			bad_stock='        ',
			a.money_unit, 
			work_week=substring(master.dbo.fGetWorkWeek_CX030(a.date_due),5,2),
			a.date_due,
			price = ( case when a.money_unit = 'WON' then a.price when a.money_unit < '0' then a.price else a.price_r end )
	into #T_Data_Download1
	from EL_CD..T_VA_020 a with (index=ix_t_va_020_8 NOLOCK)
	where run_status = '1'
	and	left(gaijung,2) = left(@Gaijung,2)
	and	order_no  between @FromOrderNo and @ToOrderNo 
				
/* IDENTITY 열에 바로 형변환을 할 수 없어 임시테이블을 거침 BY SJM*/

--select convert(char(09), '0AUW0010')
        select	right(space(04) + convert(varchar(04), id_no), 4)+';'+
		        convert(char(15), item_no)+';'+
		        right(space(11) + convert(varchar(11), convert(decimal(10,2), qty_stock)),11)+ ';'+
		        right(space(11) + convert(varchar(11), convert(decimal(10,2), req)),11)+';'+convert(char(09), order_no)+ ';'+
		        space(03) + convert(char(04), gaijung) + space(03)+ ';'+
		        convert(char(01), supply)+ ';'+
		        convert(char(08), trade_no)+';'+
		        right(space(08) + convert(varchar(08), max_order), 8)+';'+
		        po_post+';'+
		        po_person+';'+
		        insp_select + space(5)+';'+
		        convert(char(05), item_unit)+';'+
		        convert(char(08), date_start, 112)+';'+
		        right(space(13) + convert(varchar(13), convert(decimal(10,3), qty_order)),13)+ ';'+
		        convert(char(32),eng_desc)+';'+
		        convert(char(02),market_flag)+';'+
		        space(01) + post_person + space(02)+';'+
		        substring(prod_no, 3, 12)+';'+
		        part+';'+
		        skp+';'+
		        convert(char(20),brief_trade)+';'+
		        convert(char(08),bad_stock)+';'+
		        convert(char(03),money_unit)+space(01)+';'+
		        work_week + space(01)+';'+
		        convert(char(08),date_due,112)+';'+
		        right(space(15) + convert(varchar(15), convert(decimal(10,2), price)),15)
        into T_Data_Download1
        from #T_Data_Download1

				
	exec xp_Common_BCP_output @page,@Job_ID,'1'
	
	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Down_8A6                                                                                   */
/*  DISCRIPTION  : 거래처별 입고현황                                                                             */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/08/16     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_Down_8A6]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON
/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 
EXEC SP_Down_8A6 'Down_8A6','2010-08-13 14:42:39.333',@status output,@out_msg output
select @status,@out_msg

*/
	declare	@o_Gaijung		varchar(04),
			@o_from_date	varchar(08),
			@o_to_date		varchar(08),
			@o_Vendor1		varchar(08),
			@o_Vendor2		varchar(08),
			@o_Vendor3		varchar(08),
			@o_Vendor4		varchar(08),
			@o_Vendor5		varchar(08),
			@o_Supply		char(01)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@o_from_date=mrp.dbo.fGetOption(@Job_ID,@page,'from_date'),
			@o_to_date=mrp.dbo.fGetOption(@Job_ID,@page,'to_date'),
			@o_Vendor1=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor1'),
			@o_Vendor2=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor2'),
			@o_Vendor3=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor3'),
			@o_Vendor4=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor4'),
			@o_Vendor5=mrp.dbo.fGetOption(@Job_ID,@page,'Vendor5'),
			@o_Supply=mrp.dbo.fGetOption(@Job_ID,@page,'supply')
	
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	select 	a.item_no,
			a.junpyo_no,
			a.gaijung,
			a.supply,
			eng_desc=isnull(b.eng_desc,''),

			item_group_sub=isnull(b.item_group_sub,''),
               		a.qty,

			price_won = (case when a.qty = 0 then 0
								else a.amut / a.qty end),
			a.amut,
			price_foreign=(case when a.money_unit = 'won' or a.money_unit < '0'
						then 0 
						else a.price_foreign end),
			amut_foreign=(case when a.money_unit = 'won' or a.money_unit < '0'
						then 0 
						else a.amut_foreign end),
			a.money_unit,
			deliv_date='20'+substring(a.junpyo_no,3,6),
			date_io=convert(char(08),a.date_io,112),
			a.trade_no,
			c.BUSINESS_NO,
       		c.brief_trade,
       		a.prod_no,
       		a.ORDER_NO,
       		DATE_PRINT_PO=(case when d.DATE_PRINT_PO is null then '        ' 
							else convert(char(08),d.DATE_PRINT_PO,112) end),
			product_code = isnull((select xx.product_code from EL_CD..t_cc_010 xx 
							where xx.project_no = left(d.prod_no,11)
							and xx.mfg_no = substring(d.prod_no,12,3)),''),
			market_flag = isnull((select yy.market_flag from EL_CD..t_cc_010 yy 
							where yy.project_no = left(d.prod_no,11)
							and yy.mfg_no = substring(d.prod_no,12,3)),'')
	into T_Data_Download1
	from EL_CD..T_VA_040 a with (index=ix_t_va_040_5 nolock)
		left outer join EL_CD..T_CX_060 b
			on b.item_no=a.item_no
		left outer join EL_CD..T_CX_080 c
			on c.trade_no=a.trade_no
		left outer join EL_CD..T_va_020 d
			on d.order_no=a.order_no
	where a.date_io between @o_from_date + ' 00:00:00' and @o_to_date + ' 23:59:00'
	and a.gaijung between left(@o_gaijung ,2) and left(@o_gaijung,2)+'ZZ'
	and (@o_supply < '0' or a.supply=@o_supply)
	and (	@o_vendor1 < '0' or 
			a.trade_no in (@o_vendor1,@o_vendor2,@o_vendor3,@o_vendor4,@o_vendor5)
		)

	exec xp_Common_BCP_output @page,@Job_ID
	
	select @status='0',@out_msg=' Down Ok ..';

/*************************************************************************/
/*  SP NAME      : SP_Down_8CS                                                                             */
/*  DISCRIPTION  : 재고 Download                                                                            */ 
/*                                                                                                                             */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                  S.E NAME      DESCRIPTION                            */
/*  ---------------------------------------------------------------             */
/* 2010/10/05     MRP Downsizing Project   J.M.Song      Initialize                             */
/**************************************************************************/
-- grant exec on SP_Down_8CS to applications

CREATE PROCEDURE [dbo].[SP_Down_8CS]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON

	declare	@Gaijung			varchar(04),
			@Store 	                varchar(06),
			@Print_option	        varchar(01),
			@Year_month           varchar(06),
			@No_stock               varchar(01),
			@Min_amt                 float,
			@person                  varchar(02)
			
	select	@Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')
	select	@Store=mrp.dbo.fGetOption(@Job_ID,@page,'Store')
	select	@Print_option=mrp.dbo.fGetOption(@Job_ID,@page,'Print_option')
	select	@Year_month=mrp.dbo.fGetOption(@Job_ID,@page,'Year_month')
	select	@No_stock=mrp.dbo.fGetOption(@Job_ID,@page,'No_stock')
	select	@Min_amt=(case when isnumeric(mrp.dbo.fGetOption(@Job_ID,@page,'Min_amt')) = 1
	                                                then convert(float, mrp.dbo.fGetOption(@Job_ID,@page,'Min_amt'))
	                                                else -1 end)
	select	@person=mrp.dbo.fGetOption(@Job_ID,@page,'person')
	
	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
        select      data = convert(char(15), a.item_no) + ';' +
                        convert(char(30), isnull(b.eng_desc,'')) + ';' +
                        convert(char(04), a.gaijung) + ';' +
                        a.store + ';' +
                        a.order_select + ';' +
                        convert(char(04), a.post_person) + ';' +
                        convert(char(08), isnull(b.vendor, '')) +  ';' +
                        master.dbo.fGetAccountMonthOfDate(getdate()) + ';' +
                        right(space(14)+ convert(varchar(14), convert(decimal(10,2), price_avg)), 14) + ';' +
                        right(space(14)+ convert(varchar(14), convert(decimal(10,3), qty_trans)), 14) + ';' +
                        right(space(12)+ convert(varchar(12), convert(decimal(10,0), amt_trans)), 12) + ';' +
                        right(space(14)+ convert(varchar(14), convert(decimal(10,3), qty_input)), 14) + ';' +
                        right(space(12)+ convert(varchar(12), convert(decimal(10,0), amt_input)), 12) + ';' +
                        right(space(14)+ convert(varchar(14), convert(decimal(10,3), qty_output)), 14) + ';' +
                        right(space(13)+ convert(varchar(13), convert(decimal(10,0), amt_output)), 13) + ';' +
                        right(space(14)+ convert(varchar(14), convert(decimal(10,3), 0)), 14) + ';' +           --간접출고 수량
                        right(space(13)+ convert(varchar(13), 0), 13) + ';' +                                                --간접출고 금액
                        right(space(14)+ convert(varchar(14), convert(decimal(10,3), qty_stock)), 14) + ';' +
                        right(space(13)+ convert(varchar(13), convert(decimal(10,0), amt_stock)), 13) + ';' +
         isnull(convert(char(08), date_last_input, 112), '        ') + ';' + 
                        isnull(convert(char(08), date_last_output, 112), '        ') + ';' +
                        convert(char(01), isnull (b.abc, ''))
        into T_Data_Download1
        from T_MVA_061 a left outer join el_cd.dbo.T_CX_060 b
        on b.item_no = a.item_no
        where a.store not like 'P%'
        and (@gaijung < '0' or left(a.gaijung,2) = left(@gaijung, 2))
        and (@Min_amt < 0 or a.amt_stock  > @Min_amt)
        and (@person < '0' or right(a.post_person,2)  = @person)
        and (@No_stock = 'Y' or (@No_stock = 'N' and a.amt_stock > 0))
        
	exec xp_Common_BCP_output @page,@Job_ID,'1'
	
	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Down_8IP                                                                                                                                                    */
/*  DISCRIPTION  : 수불명세표 Download                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/13     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_8IP]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON
/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_8IP 'Down_8IP','2010-08-13 14:42:39.333',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung		varchar(04),
		@o_YearMonth		varchar(06),
		@o_Supply		char(01),
		@o_Min_Stock_Amt	float

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@o_Supply=mrp.dbo.fGetOption(@Job_ID,@page,'Supply'),
		@o_YearMonth=mrp.dbo.fGetOption(@Job_ID,@page,'YearMonth'),
		@o_Min_Stock_Amt=convert(float,mrp.dbo.fGetOption(@Job_ID,@page,'Min_Stock_Amt'))


	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	
	select	a.item_no
		,eng_desc=isnull(b.eng_desc,'')
		,a.gaijung
		,a.store
		,a.order_select
		,year_month
		,a.qty_trans
		,a.amt_trans
		,a.qty_input
		,a.amt_input
		,a.qty_output
		,a.amt_output
		,a.qty_stock
		,a.amt_stock
		,a.price_avg
		,item_unit=isnull(b.item_unit,'')	
		,matl_person=b.plan_post_person
		,wh_person=isnull(c.post_person,'????')
	into T_Data_Download1
	from mrp..T_MVA_060 a with (index=IX_T_MVA_060_1 nolock)
		left outer join MRP..T_MVA_061 c
			on 	c.item_no=a.item_no and
				c.gaijung=a.gaijung and
				c.store=a.store and
				c.order_select=a.order_select
		left outer join EL_CD..T_CX_060 b
			on b.item_no=a.item_no
	where a.year_month =  @o_yearmonth 
	and a.gaijung between left(@o_gaijung ,2) and left(@o_gaijung,2)+'ZZ'
	and (@o_supply < '0' or a.order_select=@o_supply)
	and a.amt_stock >= @o_Min_Stock_Amt 
	order by a.item_no,a.order_select 

	exec xp_Common_BCP_output @page,@Job_ID

	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Down_ICD                                                                                                                                                    */
/*  DISCRIPTION  : 재고현황 Download                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/13     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_ICD]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_ICD 'Down_ICD','2010-08-25 12:45:43.253',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung		varchar(04),
		@o_YearMonth		varchar(06)
	
	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@o_YearMonth=mrp.dbo.fGetOption(@Job_ID,@page,'AccountMonth')


	if exists (select * from dbo.sysobjects where id = object_id('T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table T_Data_Download1
	end
	

	if @o_YearMonth > '0'
	begin
		select	a.item_no
				,eng_desc=isnull(b.eng_desc,'')
				,abc=' '
				,venodr=isnull(b.vendor,'')
				,a.gaijung
				,a.store
				,a.order_select
				,year_month
				,a.qty_trans
				,a.qty_input
				,a.qty_output
				,a.qty_stock
				,a.amt_stock
				,a.price_avg
				,standard_price=(case when a.order_select = 'I' 
									then isnull((select d.standard_price
											from el_cd..t_cx_614 d
											where d.year=left(@o_yearmonth,4)
											and d.item_no=a.item_no),0.0)
									else isnull((select e.standard_price
											from el_cd..t_cx_613 e
											where e.year=left(@o_yearmonth,4)
											and e.item_no=a.item_no
											and e.order_select=a.order_select),0.0)
									end)
				,item_unit=isnull(b.item_unit,'')	
				,matl_person=isnull(b.plan_post_person,'')
				,wh_person=isnull(c.post_person,'????')
				,last_output_date=isnull(convert(char(08),c.date_last_output,112),'')
		into #aa
		from mrp..T_MVA_060 a with (index=IX_T_MVA_060_1 nolock)
			left outer join MRP..T_MVA_061 c
				on 	c.item_no=a.item_no and
					c.gaijung=a.gaijung and
					c.store=a.store and
					c.order_select=a.order_select
			left outer join EL_CD..T_CX_060 b
				on b.item_no=a.item_no
		where a.year_month =  @o_yearmonth 
		and a.gaijung between left(@o_gaijung ,2) and left(@o_gaijung,2)+'ZZ'
		and abs(a.qty_stock) > 0.01
		
		update a set
			abc=(case when standard_price*qty_stock < 1000000 
					then 'C'
					else (case when standard_price*qty_stock < 5000000
							then 'B' else 'A' end) 
					end)
		from #aa a	
		
		select *
		into T_Data_Download1
		from #aa
	end
	else
	begin
		select	a.item_no
				,eng_desc=isnull(b.eng_desc,'')
				,abc=' '
				,venodr=isnull(b.vendor,'')
				,a.gaijung
				,a.store
				,a.order_select
				,a.qty_trans
				,a.qty_input
				,a.qty_output
				,a.qty_stock
				,a.amt_stock
				,a.price_avg
				,standard_price=(case when a.order_select = 'I' 
									then isnull((select d.standard_price
											from el_cd..t_cx_614 d
											where d.year=left(@o_yearmonth,4)
											and d.item_no=a.item_no),0.0)
									else isnull((select e.standard_price
											from el_cd..t_cx_613 e
											where e.year=left(@o_yearmonth,4)
											and e.item_no=a.item_no
											and e.order_select=a.order_select),0.0)
									end)
				,item_unit=isnull(b.item_unit,'')	
				,matl_person=isnull(b.plan_post_person,'')
				,wh_person=isnull(a.post_person,'????')
				,last_output_date=isnull(convert(char(08),a.date_last_output,112),'')
		into #bb
		from mrp..T_MVA_061 a 
			left outer join EL_CD..T_CX_060 b
				on b.item_no=a.item_no
		where a.gaijung between left(@o_gaijung ,2) and left(@o_gaijung,2)+'ZZ'
		and abs(a.qty_stock) > 0.01
		
		update a set
			abc=(case when standard_price*qty_stock < 1000000 
					then 'C'
					else (case when standard_price*qty_stock < 5000000
							then 'B' else 'A' end) 
					end)
		from #bb a	
		
		select *
		into T_Data_Download1
		from #bb
	end

	exec xp_Common_BCP_output @page,@Job_ID

	select @status='0',@out_msg=' Down Ok ..'


SET NOCOUNT OFF;

/*************************************************************************************
 *
 * 		: SP_Down_Not_receiving_matl2
 *
 * DISCRIPTION		: 월별 미입고 재료비
 *
 * RELATIVE_FORM	: 
 *
 * CREATE_SE		: 김영민
 *
 * CREATE_DAY		: 2009년 12월 08일
 *
 * MODIFICATION_LOG
 *
 *  VER	DATE		CSR#			SE NAME       DESCRIPTION
 *  ----	----------	--------------------	---------     ---------------
 *  1.0	2009-12-08				김영민	       월별 미입고 재료비
 *  2.0 20100129			국내 전체주문대상으로 수정, 도입/하이젠 추가	
 *  2023-08-09          ITSR72315    UNGJ         거래선  VARCHAR(8)변경           
 *************************************************************************************
 */
	
CREATE PROCEDURE [dbo].[SP_Down_Not_receiving_matl2]
	@flag		char(01),	-- '2' 도입품 미입고(재료비조인) : 도입품은 입고전표가 수입시스템에 있어서, 원가에 출고전표로만 입고확인이 가능함
					-- '3' 하이젠 모터 미입고(재료비조인) : 모터의 입고전표가 생산시스템에 없으므로(별도존재), 원가에 출고전표로만 입고확인이 가능함
	@from_date	varchar(08),
	@to_date	varchar(08)
as
set nocount on

	
	if @flag = '2'
		select	*
		from	el_cd..t_ca_011 with (nolock)
		where	last_out_date between @from_date and @to_date
		and	cause_code not in ('$$','ZZ')	--'ZZ' add
		and	order_select  = 'I'
		and	part <> 'CM'
		and 	cont_qty <> 0
		and	mfg_no not like 'K%'	-- add
		and	gaijung <> 'SPSS'	-- add

	if @flag = '3'
		select	*
		from	el_cd..t_ca_011 with (nolock)
		where	last_out_date between @from_date and @to_date
		and	cause_code not in ('$$','ZZ')	--'ZZ' add
		and	order_select not in ('A','M','I')
		--and	trade_no ='1195056'
		and	trade_no ='35024523'
		and	part <> 'CM'		
		and	mfg_no not like 'K%'	--add
		and	gaijung <> 'SPSS'	--add
		and 	cont_qty<>0

	
set nocount off;

/**************************************************************************************************************/
/*  SP NAME      : SP_Down_UDF                                                                                */
/*  DISCRIPTION  : 출고(원재료비 Download                                                                     */ 
/*                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                   */
/*  ---------------------------------------------------------------                                           */
/* 2010/08/17     MRP Downsizing Project   J.J.Park      Initialize                                           */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                               */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_UDF]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON
/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_UDF 'Down_UDF','2010-08-13 14:42:39.333',@status output,@out_msg output

select @status,@out_msg
*/
	declare	@o_Gaijung		varchar(04),
		@o_from_date		varchar(08),
		@o_to_date		    varchar(08)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@o_from_date=mrp.dbo.fGetOption(@Job_ID,@page,'from_date'),
		@o_to_date=mrp.dbo.fGetOption(@Job_ID,@page,'to_date')

	if exists (select * from dbo.sysobjects where id = object_id('MRP.dbo.T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table MRP.dbo.T_Data_Download1
	end
	
--원재료비

	create table #Down_UDF (
		DOWN_DATE	varchar(08),
		account		varchar(03),
		gaijung		varchar(04),   
		market		char(01),   
		prod_no		varchar(14),
		part		varchar(02),    
		part_seq		varchar(04),
		item_no		varchar(15), 
		store		varchar(06),      
		order_select	char(01),
		qty		float,
		amt		float,     
		item_unit		varchar(02),
		jp_no		varchar(13),
		order_no	varchar(08),   
		vendor		varchar(08),          
		work_center	varchar(06),
		date_io		varchar(08),
		out_use		char(01), 
		add_qty		float,
		out_factory_flag char(01)
	)

	insert into #Down_UDF
	exec  SP_Down_UDF_1 @o_Gaijung,@o_from_date,@o_to_date,'A'   --원재료비

	
	select *
	into MRP.dbo.T_Data_Download1
	from #Down_UDF
	
	exec xp_Common_BCP_output @page,@Job_ID

	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Down_UDF_1                                                                                                                                                    */
/*  DISCRIPTION  : 출고(원재료비,기타재료비 Download                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/17     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_UDF_1]
	@o_Gaijung		varchar(04),
	@o_from_date		varchar(08),
	@o_to_date		varchar(08),
	@flag			char(01)		--A:원재료  B:기타재료비 
AS
SET NOCOUNT ON

	

	select 	DOWN_DATE=LEFT(@O_TO_DATE,6)+'01',
			account=(CASE left(@o_gaijung,2) 	when 'EL' then'WBE'
							when 'SY' then'WBP'
							else 'XXX' end),
			a.gaijung, 
			--c.market_flag,
			market_flag = (case when left(c.mfg_no,1) in ('T','U') then 'T' else c.market_flag end),
			prod_no=a.project_no+a.mfg_no,
			a.part,    
			a.part_seq,

			a.item_no, 
			a.store,      
			a.order_select,
			a.qty,
			a.amt,     
			b.item_unit,
			a.jp_no,
			a.order_no,   
			a.vendor,          
			a.work_center,       
			date_io=convert(char(08),a.date_io,112),
			a.out_use, 
			add_qty=0,
			out_factory_flag=isnull((select d.out_factory_flag 
								from el_cd..t_ca_011 d 
								where d.project_no = a.project_no 
								and d.mfg_no = a.mfg_no
								and d.part = a.part
								and d.part_seq = a.part_seq),'')
	from t_mva_041 a with (index=IX_T_MVA_041_2 nolock)
		left outer join EL_CD..T_CX_060 b (nolock)
			on b.item_no=a.item_no
		left outer join EL_CD..T_CC_010 c (nolock)
			on c.project_no = a.project_no and
				c.mfg_no = a.mfg_no
	where date_io between @o_from_date + ' 00:00:00' and @o_to_date + ' 23:59:59'
	and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
	and a.order_select in ('D','I','L','X','S','Z')
	and left(a.store,1) <> 'P' 
	and (	@flag='A' and not ( a.out_use in ('H', 'S' , 'X' , 'K' , 'V' , 'A') or SKP in ( 'S' , 'X' , 'Z' , 'Y') )  or
		@flag='B' and ( a.out_use in ('H', 'S' , 'X' , 'K' , 'V' , 'A') or a.skp in ( 'S' , 'X' , 'Z' , 'Y') ) )

--out_use ='K' ????????????

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_Down_UDG                                                                                                                                                    */
/*  DISCRIPTION  : 출고(기타재료비) Download                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/17     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Down_UDG]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_Down_UDG 'Down_UDG','2010-08-13 14:42:39.333',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@o_Gaijung		varchar(04),
		@o_from_date		varchar(08),
		@o_to_date		varchar(08)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
		@o_from_date=mrp.dbo.fGetOption(@Job_ID,@page,'from_date'),
		@o_to_date=mrp.dbo.fGetOption(@Job_ID,@page,'to_date')

	if exists (select * from dbo.sysobjects where id = object_id('MRP.dbo.T_Data_Download1') and OBJECTPROPERTY(id, 'IsTable') = 1)
	begin
		drop table MRP.dbo.T_Data_Download1
	end
	
--원재료비

	create table #Down_UDG (
		DOWN_DATE	varchar(08),
		account		varchar(03),
		gaijung		varchar(04), 
		market		char(01), 		  
		prod_no		varchar(14),
		part		varchar(02),    
		part_seq		varchar(04),
		item_no		varchar(15), 
		store		varchar(06),      
		order_select	char(01),
		qty		float,
		amt		float,     
		item_unit		varchar(02),
		jp_no		varchar(13),
		order_no	varchar(08),   
		vendor		varchar(08),          
		work_center	varchar(06),
		date_io		varchar(08),
		out_use		char(01), 
		add_qty		float,
		out_factory_flag char(01)
	)

	insert into #Down_UDG
	exec  SP_Down_UDF_1 @o_Gaijung,@o_from_date,@o_to_date,'B'   --기타재료비

	
	select *
	into MRP.dbo.T_Data_Download1
	from #Down_UDG
	
	exec xp_Common_BCP_output @page,@Job_ID

	select @status='0',@out_msg=' Down Ok ..'

SET NOCOUNT OFF;

CREATE PROCEDURE dbo.sp_dropdiagram
	(
		@diagramname 	sysname,
		@owner_id	int	= null
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
	
		if(@diagramname is null)
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT; 
		
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		delete from dbo.sysdiagrams where diagram_id = @DiagId;
	
		return 0;
	END;

CREATE PROCEDURE [dbo].[SP_Err_Matl_IO_Concurrent]
AS

BEGIN
set nocount on
	declare	@year_month	varchar(06),
			@from_date	varchar(20),
			@to_date	varchar(20),
			@issue_date	varchar(08),
			@user_id	varchar(20)
			
	select	@year_month='201010',
			@from_date='20100926 00:00:00',
			@to_date= '20101025 23:59:00',
			@issue_date=convert(char(08),getdate(),112),
			@user_id='208136'
			

	select c.project_no,c.mfg_no,c.part,c.part_seq,c.item_no,c.cont_qty,jp_qty=b.qty,je_supply=c.order_select,jp_supply=b.supply,junpyo_no,b.gaijung,b.date_io,amut
	into #a1
	from mrp..t_mva_060 a with (index=IX_T_MVA_060_1 nolock),
		el_cd..t_va_040 b with (index=ix_t_va_040_4 nolock),
		el_cd..t_va_020 x with (nolock),el_cd..t_ca_011 c with (nolock)
	where a.year_month=@year_month
	and a.gaijung between 'EL' and 'ELZZ'
--	and a.qty_stock > 0
	and a.order_select <> 'I'
	and b.item_no =a.item_no
	and b.date_io between @from_date and @to_date
	and x.order_no=b.order_no
	and x.ship_flag='Y'
	and c.project_no=left(x.prod_no,11)
	and c.mfg_no=substring(x.prod_no,12,3)
	and c.part=x.part
	and c.part_seq=x.part_seq
	and c.item_no=b.item_no



	select *
	into #a2
	from #a1 a
	where a.project_no > '0'
	and  not exists (select *
			from mrp..t_mva_041 b (nolock)
			where b.project_no=a.project_no
			and b.mfg_no=a.mfg_no
			and b.part=a.part
			and b.part_seq=a.part_seq
			and b.item_no=a.item_no)
		
	update b set 
		prod_qty=0
	from #a2 a,el_cd..t_ca_011 b
	where a.project_no > '0'
	and b.project_no=a.project_no
	and b.mfg_no=a.mfg_no
	and b.part=a.part
	and b.part_seq=a.part_seq
	and b.prod_qty <> 0
		

	select ' exec SP_Common_Issuance_By_PartSeq  ''' + a.gaijung + ''',  '  +
			'''' + a.project_no + ''',  ' +
			'''' + a.mfg_no + ''',   ' +
			'''' + a.part + ''',  ' +
			'''' + a.part_seq + ''',  ' +
			'''' + @issue_date+ ''',0, ' +
			'''' + @user_id + ''', @status	output,@out_msg	output ' + char(13) +
			' select @status,@out_msg '
	from #a2 a
		
		
		

END;

CREATE PROCEDURE [dbo].[SP_Err_Prod_Qty_CA_011]
	@gaijung	varchar(04),
	@from_date	varchar(08)='20100101',
	@to_date	varchar(08)='20101230'
AS

BEGIN
set nocount on
	create table  #aa(
		project_no	varchar(11),
		mfg_no		varchar(03),
		part		varchar(02),
		part_seq	varchar(04),
		cont_qty	float,
		prod_qty	float,
		out_qty		float
	)
		
	if @gaijung = 'SYHP'	
		insert into #aa
		select a.project_no,a.mfg_no,a.part,a.part_seq,
				a.cont_qty,a.prod_qty,
				out_qty=isnull((select sum(b.qty) from mrp..t_mva_041 b 
								where b.project_no=a.project_no
								and b.mfg_no=a.mfg_no
								and b.part=a.part
								and b.part_seq=a.part_seq),0.0)
		from el_cd..t_ca_011 a with (index=ix_ca_011_2 nolock)
		where product_code in ('PS','PT')
		and due_date between @from_date and @to_date
		and abs(cont_qty - prod_qty) > 0.01
	else if @gaijung = 'ELES'	
		insert into #aa
		select a.project_no,a.mfg_no,a.part,a.part_seq,
				a.cont_qty,a.prod_qty,
				out_qty=isnull((select sum(b.qty) from mrp..t_mva_041 b 
								where b.project_no=a.project_no
								and b.mfg_no=a.mfg_no
								and b.part=a.part
								and b.part_seq=a.part_seq),0.0)
		from el_cd..t_ca_011 a with (index=ix_ca_011_2 nolock)
		where product_code in ('EL','GL','GE','DW')
		and due_date between @from_date and @to_date
		and left(a.gaijung,2) = left(@gaijung,2)
		and abs(cont_qty - prod_qty) > 0.01
	else
		insert into #aa
		select a.project_no,a.mfg_no,a.part,a.part_seq,
				a.cont_qty,a.prod_qty,
				out_qty=isnull((select sum(b.qty) from mrp..t_mva_041 b 
								where b.project_no=a.project_no
								and b.mfg_no=a.mfg_no
								and b.part=a.part
								and b.part_seq=a.part_seq),0.0)
		from el_cd..t_ca_011 a with (index=ix_ca_011_2 nolock)
		where product_code in ('EL','ES')
		and due_date between @from_date and @to_date
		and left(a.gaijung,2) = left(@gaijung,2)
		and abs(cont_qty - prod_qty) > 0.01


		update b set 
			prod_qty=a.out_qty
		from #aa a, el_cd..t_ca_011 b
		where a.out_qty <> 0
		and abs(a.prod_qty - a.out_qty) > 0.01
		and abs(a.cont_qty-a.out_qty) < 0.01
		and b.project_no=a.project_no
		and b.mfg_no=a.mfg_no
		and b.part=a.part
		and b.part_seq=a.part_seq


END;

CREATE PROCEDURE dbo.sp_helpdiagramdefinition
	(
		@diagramname 	sysname,
		@owner_id	int	= null 		
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		set nocount on

		declare @theId 		int
		declare @IsDbo 		int
		declare @DiagId		int
		declare @UIDFound	int
	
		if(@diagramname is null)
		begin
			RAISERROR (N'E_INVALIDARG', 16, 1);
			return -1
		end
	
		execute as caller;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner');
		if(@owner_id is null)
			select @owner_id = @theId;
		revert; 
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname;
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId ))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1);
			return -3
		end

		select version, definition FROM dbo.sysdiagrams where diagram_id = @DiagId ; 
		return 0
	END;

CREATE PROCEDURE dbo.sp_helpdiagrams
	(
		@diagramname sysname = NULL,
		@owner_id int = NULL
	)
	WITH EXECUTE AS N'dbo'
	AS
	BEGIN
		DECLARE @user sysname
		DECLARE @dboLogin bit
		EXECUTE AS CALLER;
			SET @user = USER_NAME();
			SET @dboLogin = CONVERT(bit,IS_MEMBER('db_owner'));
		REVERT;
		SELECT
			[Database] = DB_NAME(),
			[Name] = name,
			[ID] = diagram_id,
			[Owner] = USER_NAME(principal_id),
			[OwnerID] = principal_id
		FROM
			sysdiagrams
		WHERE
			(@dboLogin = 1 OR USER_NAME(principal_id) = @user) AND
			(@diagramname IS NULL OR name = @diagramname) AND
			(@owner_id IS NULL OR principal_id = @owner_id)
		ORDER BY
			4, 5, 1
	END;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_IN
 *
 * DISCRIPTION      : DPS 에서 입고 처리
 *
 * RELATIVE_FORM    : I/F (DPS)
 *
 * CREATE_SE        : lgjjg
 *
 * CREATE_DAY       : 2020년 03월 09일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-03-09	오티스 MES 프로젝트		lgjjg		initial
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_IN]
	@order_no	varchar(08),
	@user_id	varchar(10)=''
AS
begin
-- exec SP_IF_DPS_IN '0XX0007R','T00494'
-- grant exec on SP_IF_DPS_IN to applications

	declare @supply_check char(1)

	select @supply_check=supply --*
	from EL_CD..t_va_020
	where order_no = @order_no
	and run_status = '4'

	if @supply_check = 'I'
	begin
		if not exists (select * 
						from el_cd..t_va_011 a 
						where order_no = @order_no 
						and (junpyo_no is null or junpyo_no < '0') )
		begin
			select status= '1', msg_out='입고 예정 상태인 도입품 주문 없음'
			return
		end

		if exists (select count(*) 
						from el_cd..t_va_011 a 
						where order_no = @order_no 
						and (junpyo_no is null or junpyo_no < '0')
						having count(*) > 1 )
		begin
			select status= '2', msg_out='입고 예정 상태인 도입품 주문 중복 존재'
			return
		end
		
		if not exists (select * 
							from el_cd..t_va_020 a 
							where order_no = @order_no 
							and run_status = '4'
							and qty_order > 0 )
		begin
			select status= '3', msg_out='주문 마스터내 입고할 주문 없음'
			return
		end
		
		declare	@item_no		varchar(15),		
				@gaijung		varchar(04),
				@store			varchar(06),
				@order_select	char(01),
				@input_date		varchar(08),
				@o_input_qty	varchar(15),
				@o_amt_won		varchar(15),
				@currency		varchar(03),
				@o_amt_foreign	varchar(15),
				@vendor			varchar(08),
				@prod_no		varchar(14),
				@part			varchar(02),
				@file_no		varchar(20)

		select @item_no=item_no,
				@gaijung=gaijung,
				@store=store,
				@order_select=supply,
				@input_date='',
				@o_input_qty=input_qty,
				@o_amt_won=local_amt,
				@currency=money_unit,
				@o_amt_foreign=foreign_amt,
				@vendor=trade_no,
				@prod_no=prod_no,
				@part=part,
				@file_no='' 
		from el_cd..t_va_011 a 
		where order_no = @order_no 
		and (junpyo_no is null or junpyo_no < '0') 


		EXEC SP_MRP_8AD_1	@ITEM_NO, @GAIJUNG, @STORE, @order_select, '', @o_input_qty, @o_amt_won, @currency, @o_amt_foreign, @vendor, @PROD_NO, @PART, '',@ORDER_NO, @USER_ID

		exec SP_IF_DPS_INSP_COMP	@order_no 
	end
	else if @supply_check <> 'I'
	begin
		if not exists (select * 
							from el_cd..t_va_020 a 
							where order_no = @order_no 
							and run_status = '4'
							and qty_order > 0 )
		begin
			select status= '5', msg_out='주문 마스터내 입고할 주문 없음'
			return
		end

		exec SP_MRP_6IX_1 'P',	 @order_no,	'',			 '',	 @user_id

		exec SP_IF_DPS_INSP_COMP	@order_no 
	end
	else
	begin
		select status= '6', msg_out='입고 대상 주문이 아님'
	end

end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_INLIST
 *
 * DISCRIPTION      : 입고예정 Item 정보를 내려준다.(DPS / 울랄라 제공)
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 01월 30일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-01-30	오티스 MES 프로젝트		송승훈		입고리스트 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_INLIST]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_DPS_INLIST '20200317','20200617'
-- select * from EL_CD.dbo.t_cx_160 
-- select * from EL_CD.dbo.t_va_020 
-- grant exec on SP_IF_DPS_INLIST to applications
/*
select * 
-- update a set insp_comp_date =getdate()
from el_cd.dbo.t_vj_450  a
where order_no='0A030095'


*/
	select a.order_no, a.item_no, a.qty, receipt_expect_no=isnull(b.receipt_expect_no,'')
	into #vj_450
	from el_cd.dbo.t_vj_450 a
	inner join el_cd.dbo.t_va_020 b on a.order_no=b.order_no	
	where insp_comp_date between @from_date and @to_date + ' 23:59:00'
	and b.run_status='4'
	group by a.order_no, a.item_no, a.qty, b.receipt_expect_no

	select 
		--d.dps_id, 
		dps_id=(case when d.zone = 'Z' or d.dps_id>250 then 'Z' 
					   else d.dps_id
					   end ), 
		d.store, 
		d.store_name, 
		d.group_id,
		a.item_no, 
		c.eng_desc, 
		b.qty_order, 
		d.safe_stock_qty,
		a.order_no,
		a.receipt_expect_no
	from #vj_450 a
	inner join el_cd.dbo.t_va_020 b on a.order_no=b.order_no	
	inner join el_cd.dbo.t_cx_060 c on a.item_no=c.item_no
	inner join el_cd.dbo.t_cx_160 d on a.item_no=d.item_no
	order by store
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_INSP_COMP
 *
 * DISCRIPTION      : DPS 입고후 검수테이블에 입고일자업데이트
 *
 * RELATIVE_FORM    : I/F (DPS)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 06일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-06	오티스 MES 프로젝트		송승훈		DPS 입고후 검수테이블에 입고일자업데이트
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_INSP_COMP]
	@order_no varchar(08)
AS
begin
-- exec SP_IF_DPS_INSP_COMP '0A010005'
-- grant exec on SP_IF_DPS_INSP_COMP to applications
	
	update a set ipgo_date=getdate(),ipgo_flag='Y'
	-- select *
	from el_cd.dbo.t_vj_450 a
	where order_no=@order_no
	
end;

/********************************************************************************/
/*  SP NAME          : SP_IF_DPS_ORDER											*/
/*  DESCRIPTION      : 불출대기 출고처리 - 불출대기 대상 조회					*/
/*  RELATIVE_FORM    : DPS (예정)												*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_IF_DPS_ORDER]
	@order_no	varchar(08)

AS
-- grant exec on SP_IF_DPS_ORDER to applications
-- exec SP_IF_DPS_ORDER 'A2010006'
-- create index IX_T_MZE_01_1 ON T_MZE_01 (order_no)
-- exec SP_IF_DPS_ORDER 'A2013021'
/*
select *
from T_MZE_01
select *
from el_cd..t_cx_069


HBA313T3
HBA21305S5     
HBA313T3       
HBA21305W2     

*/

begin

	create table #dps_order	
	(	jp_no		varchar(13), 
		order_no	varchar(8),
		p_item_no   varchar(15),
		item_no		varchar(15),
		eng_desc	varchar(30),
		qty			real,
		qty_out		real,
		qty_stock	real)

	create table #dps_order_final	
	(	seq			int IDENTITY(1,1),
		jp_no		varchar(13), 
		order_no	varchar(8),
		p_item_no   varchar(15),
		item_no		varchar(15),
		eng_desc	varchar(30),
		qty			real,
		qty_out		real,
		qty_stock	real)

	insert into #dps_order
	select b.jp_no, b.order_no, a.item_no, b.item_no, c.eng_desc, b.qty, b.qty_out,
			qty_stock= isnull((select sum(qty_stock) 
								from t_mva_061 d 
								where d.item_no=b.item_no 
								and d.gaijung='SPSS' 
								and d.store='WHSPSS'
--								and d.order_select in ('D','I')),0)
								and d.order_select in ('D','I','S')),0)
	from t_myo_01 a, T_MZE_01 b, el_cd.dbo.t_cx_060 c
	where a.order_no = @order_no
	and a.run_status = '2'
	and b.order_no = a.order_no
	and c.item_no=b.item_no

	insert into #dps_order_final
	select a.*
	from #dps_order a, el_cd..t_cx_069 b
	where a.p_item_no = b.item_no
	and a.item_no = b.citem_no
	and substring(b.mark,3,1) = 'N'


	insert into #dps_order_final
	select a.*
	from #dps_order a, el_cd..t_cx_160 b
	where a.item_no = b.item_no
	and b.zone = 'Z'
	and not exists (select *
					from #dps_order_final b
					where b.jp_no = a.jp_no)
	order by a.jp_no


	insert into #dps_order_final
	select a.*
	from #dps_order a
	where not exists (select *
						from #dps_order_final b
						where b.jp_no = a.jp_no)
	order by jp_no



	select	a.order_no,
			a.jp_no,
			a.item_no, 
			a.eng_desc, 
			a.qty, 
			a.qty_out,
			a.qty_stock,
			stock_check=(case when a.qty <= a.qty_stock then 'OK'
						else 'NOK'
						end),
			c.safe_stock_qty,
			dps_id=(case when c.zone = 'Z' or c.dps_id>250 then 'Z' 
					   else c.dps_id
					   end ), 
			c.store,
			c.store_name, 
			c.group_id
	from #dps_order_final a	left outer join el_cd.dbo.t_cx_160 c on a.item_no=c.item_no
	order by seq

end;

/********************************************************************************/
/*  SP NAME          : SP_IF_DPS_OUT_JP											*/
/*  DESCRIPTION      : 불출대기 출고처리 - 전표별 출고처리 호출					*/
/*  RELATIVE_FORM    : DPS (예정)												*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_IF_DPS_OUT_JP]
	@jp_no		varchar(13),
	@user_id	varchar(10),
	@io_date	char(08)='' 
AS
SET NOCOUNT ON

-- EXEC SP_IF_DPS_OUT_JP 'XA20100010010', 'T00494' 
-- grant exec on SP_IF_DPS_OUT_JP to applications

	declare	@curr_date	char(08)

	select @curr_date=convert(char(08),getdate(),112)

	if @io_date < '0'
	begin
		select @io_date = @curr_date
	end


	declare	@item_no		varchar(15),
			@ze01_qty		real,
--			@proc_qty		real,
			@gaijung		varchar(04),
			@specfic		char(01),
			@order_select	char(01),
			@qty_out		real,
			@ze01_status	char(01)

	select 	@item_no=item_no,
			@ze01_qty=a.qty, 
			@gaijung=gaijung,
			@order_select=order_select,
			@specfic=(case when  @order_select in ('A','M') then 'Y' else '' end)
	from T_MZE_01 a
	where jp_no=@jp_no
	and status = '1'

	if @ze01_qty is null or @ze01_qty <= 0 --or @ze01_status <> '1'
	begin
		select  status='1', out_msg= '출고대상 수량 없음'
		return
	end
	
	--select status='0'
	declare	@status		char(01)='0',
			@out_msg	varchar(50)=''

begin tran SP_IF_DPS_OUT

		exec SP_IF_DPS_OUT_JP_SUB
			@jp_no,
			@item_no,
			@user_id,
			@io_date,
			@status		output,
			@out_msg	output

		if @status > '0'
		begin
			rollback tran SP_IF_DPS_OUT
			select status=@status, out_msg=@out_msg
			return
		end

commit tran SP_IF_DPS_OUT

		select status=@status, out_msg=@out_msg;

/********************************************************************************/
/*  SP NAME          : SP_IF_DPS_OUT_JP_SUB										*/
/*  DESCRIPTION      : 불출대기 출고처리 - 전표별 출고처리						*/
/*  RELATIVE_FORM    : DPS (예정)												*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_IF_DPS_OUT_JP_SUB]
	@jp_no		varchar(13),
	@item_no	varchar(15),
	@user_id	varchar(10),
	@date_io	char(08),
	@status		char(01)		output,
	@out_msg	varchar(100)	output
AS
SET NOCOUNT ON

-- grant exec on SP_IF_DPS_OUT_JP_SUB to applications
-- exec SP_IF_DPS_OUT_JP_SUB 'XA20100010010','HBA21305S5','T00494','20200310', @status output, @out_msg output

	declare	@order_select_check	char(1)
	declare	@ze01_status	char(1)

	select 	@order_select_check = order_select, @ze01_status = status
	from T_MZE_01 a
	where jp_no=@jp_no

	if @ze01_status <> '1'
	begin
		select @status='9', @out_msg='출고가능한 상태가 아닙니다.' 
		return
	end

--	if @order_select_check not in ('D','I')
	if @order_select_check not in ('D','I','S')
	begin
		select @status='1', @out_msg='출고가능한 조달이 아닙니다.' 
		return
	end

	create table #order_select (
		order_select	char(01),
		select_priority	int
	)

--	if @order_select_check = 'I' 
	if @order_select_check in ('I','S') 
	begin
		insert into #order_select select 'D', 1
		insert into #order_select select 'I', 2
		insert into #order_select select 'S', 3
	end
	else
	begin
		insert into #order_select select 'I', 1
		insert into #order_select select 'D', 2
		insert into #order_select select 'S', 3
	end

	declare	@ze01_qty		real,
			@gaijung		varchar(04),
			@order_select	char(01),
			@store			varchar(06),
			@item_no_p		varchar(15),
			@skp			char(01),
			@out_use		char(01),
			@last_jp_seq	tinyint,
			@12_last_jp_seq	tinyint

	declare	@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part			varchar(02),
			@part_seq		varchar(04),
			@order_no		varchar(08),
			@ship_flag		char(01),
			@market_flag	char(01),
			@product_code	varchar(03),
			@item_unit		varchar(02),
			@vendor			varchar(08),
			@qty_stock		real,
			@proc_qty		real,
			@tot_proc_qty	real,
			@io_qty			real,
			@result_amt		float,
			@curr_date_8	char(08)

	select @curr_date_8 = convert(char(08),getdate(),112)				

	if exists (select 	'Y'
				from T_MZE_01 a
				where jp_no=@jp_no
				and qty <= qty_out)
	begin
		select @status='1', @out_msg='기출고 완료 되었습니다' 
		return
	end

	select 	@gaijung=gaijung,
			@ze01_qty=a.qty, -- (case when @qty <= a.qty-a.qty_out then @qty else a.qty-a.qty_out end),
			@out_use=out_use,@skp=skp,@last_jp_seq=last_jp_seq,
			@project_no=project_no,@mfg_no=mfg_no,@part=part,@part_seq=part_seq,
			@order_no=order_no,@vendor=vendor,
			@item_no_p= parent_item_no
	from T_MZE_01 a
	where jp_no=@jp_no
	and status = '1'

	if @ze01_qty is null or @ze01_qty <=0
	begin
		select @status='2', @out_msg='출고 대상 수량이 없습니다' 
		return
	end

	select @tot_proc_qty = 0
	select @proc_qty=@ze01_qty

	if not exists (	select	a.store,a.order_select,a.qty_stock
					from T_MVA_061 a, #order_select c
					where a.gaijung=@gaijung
					and a.item_no=@item_no
					and a.qty_stock > 0
					and c.order_select=a.order_select )
	begin
		select @status='3', @out_msg='출고 대상 재고가 없습니다' 
		return
	end

	update a set status = '4'
	from T_MZE_01 a
	where jp_no=@jp_no
	and status = '1'

	select @status = 0

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select	a.store,a.order_select,a.qty_stock
		from T_MVA_061 a, #order_select c
		where a.gaijung=@gaijung
		and a.item_no=@item_no
		and a.qty_stock > 0
		and c.order_select=a.order_select
		order by c.select_priority
	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	@store,@order_select,@qty_stock

	WHILE (@@FETCH_STATUS = 0 and @status <= '0' and @proc_qty > 0 )	
	begin

		if @proc_qty > @qty_stock
			select @io_qty=@qty_stock,@proc_qty=@proc_qty-@qty_stock
		else
			select @io_qty=@proc_qty,@proc_qty=0
		
		select @tot_proc_qty = @tot_proc_qty + @io_qty

		exec SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@order_select,
			'B',	-- A:입고 B:출고
		 	@date_io,
			@io_qty,
			0,	-- io_amt 
			0,	-- io_matl_amt 
			@result_amt	output,
			@status		output,
			@out_msg	output

		if @status > '0'
		begin
			return
		end

		insert into T_MVA_041
		select	jp_no=left(@jp_no,12)+convert(char(01),@last_jp_seq),
				date_io=(case when @date_io = @curr_date_8 then getdate() else @date_io end),
				gaijung=@gaijung,
				item_no=@item_no,
				store=@store,
				order_select=@order_select,
				skp=@skp,
				project_no=@project_no,
				mfg_no=@mfg_no,
				part=@part,
				part_seq=@part_seq,
				qty=@io_qty,
				amt=@result_amt,
				order_no=@order_no,
				vendor='',
				work_center='',
				out_use=@out_use,
				item_group_sub='',
				scrap_qty=0,
				creator=@user_id

		select @last_jp_seq = @last_jp_seq + 1

	   	FETCH NEXT FROM TTT0 INTO 	@store,@order_select,@qty_stock
	end
	CLOSE TTT0
   	DEALLOCATE TTT0
	
	if @status <= '0' and @tot_proc_qty > 0
	begin
		update a set 
			qty_out=a.qty_out + @tot_proc_qty,
			last_jp_seq=@last_jp_seq,
			status = (case when @tot_proc_qty > 0 then '4' else '1' end)
		from T_MZE_01 a
		where jp_no=@jp_no

		update a set status = '5',date_out=getdate()
		from T_MZE_01 a
		where jp_no=@jp_no 
		and qty <= qty_out

		update a set shortage_mark='P'
		from T_MZE_01 a
		where jp_no=@jp_no
		and qty <> qty_out

		if not exists (	select 'Y'
						from T_MZE_01 a
						where order_no=@order_no 
						and status <> '5'
						and qty > 0)
		begin
			update a set run_status = '3', date_out = getdate()
			from T_MYO_01 a
			where order_no = @order_no
			and run_status = '2'
		end
	
	end;

/********************************************************************************/
/*  SP NAME          : SP_IF_DPS_OUTLIST										*/
/*  DESCRIPTION      : 불출대기 출고처리 - 대상 조회							*/
/*  RELATIVE_FORM    : DPS (예정)												*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_IF_DPS_OUTLIST]
	@from_date	char(08)='',
	@to_date	char(08)='' --,
--	@ao_no			char(08)=''
--	@status		char(01)	output,
--	@out_msg	varchar(50) output

AS
-- grant exec on SP_IF_DPS_OUTLIST to applications
-- exec SP_IF_DPS_OUTLIST '20200303','20200303'
begin

	select a.order_no, a.item_no, b.eng_desc, date_start=convert(varchar(8), a.date_start,112), a.qty_ao --, jp_no
	from T_MYO_01 a with (nolock), el_cd.dbo.t_cx_060 b with (nolock)
	where a.date_start between @from_date and @to_date + ' 23:59:00'
	and a.run_status = '2'
	and b.item_no=a.item_no
	order by a.date_start, a.order_no


	--declare	@status		char(01),
	--		@out_msg	varchar(100)

	--select @status='0',@out_msg='OK'

	/*
	if ((@from_date < '0' or @to_date < '0') and @ao_no < '0')
	begin
		select status='1', out_msg='조회 조건 부족'
		return
	end

	if (DATEDIFF(d,@from_date,@to_date) > 31)
	begin
		select status='2', out_msg='31일 초과 조회 불가'
		return
	end
	*/
	/*
	if @ao_no > '0' 
	begin
		select order_no
		from T_MYO_01 a with (nolock)  --, T_MZE_01 b
		where order_no = @ao_no
		and run_status = '2'
	end
	else
	begin
		select order_no --, jp_no
		from T_MYO_01 a with (nolock)
		where date_start between @from_date and @to_date + ' 23:59:00'
		and run_status = '2'
		and (@ao_no < '0' or order_no=@ao_no)
	end
	*/

--	select status='0', out_msg='OK'
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_SERIALNO
 *
 * DISCRIPTION      : 제조지시번호의 serial no 리스트를 조회한다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 07월 16일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-07-16	오티스 MES 프로젝트		송승훈		제조지시번호의 serial no 리스트를 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_SERIALNO]
	@order_no varchar(08)
AS
begin
-- exec SP_IF_DPS_SERIALNO 'A2029004' 
-- grant exec on SP_IF_DPS_SERIALNO to applications

	select order_no, gecb_serial,ero_spb, power_board, lru_drive, igbt_box, ei_panel
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_STOCKLIST
 *
 * DISCRIPTION      : 재고 Item 정보를 내려준다.(DPS / 울랄라 제공)
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 01월 30일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-01-30	오티스 MES 프로젝트		송승훈		재고리스트
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_STOCKLIST]
	@item_no		varchar(15)=''
AS
begin
-- exec SP_IF_DPS_STOCKLIST_lgssha  
-- exec SP_IF_DPS_STOCKLIST 
-- exec SP_IF_DPS_STOCKLIST  'HBA21305N6'
-- select * from EL_CD.dbo.t_cx_160 
-- select * from EL_CD.dbo.t_va_020 
-- grant exec on SP_IF_DPS_STOCKLIST to applications
/*
select * 
-- update a set insp_comp_date =getdate()
from el_cd.dbo.t_vj_450  a
where order_no='0A030095'


*/
	select 
		a.dps_id, 
		--dps_id=(case when a.zone = 'Z' or a.dps_id>250 then 'Z' 
		--			   else a.dps_id
		--			   end ),
		a.store, 		
		a.store_name, 
		a.group_id,
		a.item_no, 
		eng_desc=isnull(b.eng_desc,''), 
		a.safe_stock_qty,
--		qty_stock=isnull(sum(qty_stock),0),
		qty_stock=isnull(sum(qty_stock),0) - isnull((select sum(isnull(d.qty_bad,0) - isnull(d.qty_tot_input,0)) from el_cd..t_mes_230 d where d.item_no = a.item_no and d.run_status = '1' ),0),
		color = (case when safe_stock_qty>isnull(sum(qty_stock),0) then 'R' else 'B' end),
		zone=max(zone)
	into #cx160
	from el_cd.dbo.t_cx_160 a with (nolock)  
	left outer join el_cd.dbo.t_cx_060 b with (nolock)  
		on b.item_no=a.item_no
	left outer join mrp.dbo.t_mva_061 c with (nolock)  
		on c.item_no=a.item_no 
		and c.gaijung='SPSS' 
		and c.store='WHSPSS'
--		and c.order_select in ('D','I')
		and c.order_select in ('D','I','S')
	where (@item_no < '0' OR a.item_no = @item_no)
	group by a.dps_id, 
		a.store, 
		a.store_name, 
		a.group_id,
		a.item_no, 
		b.eng_desc, 
		a.safe_stock_qty
	order by store
	

	select 
		dps_id,
		--=(case when a.zone = 'Z' or a.dps_id>250 then 'Z' 
		--			   else a.dps_id
		--			   end ),
		a.store, 		
		a.store_name, 
		a.group_id,
		a.item_no, 
		eng_desc,
		a.safe_stock_qty,
		qty_stock,
		color,
		zone
	from #cx160 a
	order by store
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_DPS_WORK_MATCH
 *
 * DISCRIPTION      : 제조지시번호와 QR주문 번호를 매칭하여 업데이트한다.
 *
 * RELATIVE_FORM    : I/F (DPS)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 03월 06일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-03-06	오티스 MES 프로젝트		송승훈		제조지시번호와 주문 번호를 매칭하여 업데이트한다.
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_DPS_WORK_MATCH]
	@order_no varchar(08),
	@cabinet_order_no varchar(08)
AS
begin
-- exec SP_IF_DPS_WORK_MATCH 'A2009001','0A030250'
-- grant exec on SP_IF_DPS_WORK_MATCH to applications
/*
-- select * from mrp.dbo.t_myo_01
select c.citem_no
from mrp.dbo.t_myo_01 a
inner join mrp.dbo.T_MZE_01 b on b.order_no=a.order_no
inner join el_cd.dbo.t_cx_069 c on c.item_no=a.item_no and c.citem_no=b.item_no and substring(mark,3,1)='N'
where a.order_no='A2009001'
select substring('  N ',3,1)
select * from mrp.dbo.T_MZE_01
select * from el_cd.dbo.t_cx_069
*/

	insert into T_AO_Cabinet_Match_Log
	select @order_no, @cabinet_order_no, getdate()

	declare @va_item varchar(15)
	declare @yo_item varchar(15)

	-- 제조지시 불출 목록의 캐비넷 도번과 주문번호의 도번이 일치해야 업데이트함
	select @va_item = rtrim(item_no)
	from el_cd.dbo.t_va_020
	where order_no=@cabinet_order_no

	select @yo_item = rtrim(c.citem_no)
	from mrp.dbo.t_myo_01 a
	inner join mrp.dbo.T_MZE_01 b on b.order_no=a.order_no
	inner join el_cd.dbo.t_cx_069 c on c.item_no=a.item_no and c.citem_no=b.item_no and substring(mark,3,1)='N'
	where a.order_no=@order_no

	if isnull(@yo_item,'')<>isnull(@va_item,'')
	begin
		select status='2', out_msg='제조지시와 주문의 도번이 일치하지 않습니다.', cabinet_item_no = isnull(@va_item,'')
		return
	end

	update a set concern_order_no=@cabinet_order_no
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no

	if @@ROWCOUNT=1
		select status='0', out_msg='업데이트 반영됨', cabinet_item_no = isnull(@va_item,'')
	else
		select status='1', out_msg='반영할 데이터가 없습니다.', cabinet_item_no = isnull(@va_item,'')
	
end;

/*************************************************************************************************************
 *
 * PROCEDURE        : SP_IF_INSP_COMP
 *
 * DISCRIPTION      : 제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *  1.5    2023-07-04	            		    UNGJ		V3  GATEWAY FLOW 추가반영 
 ******************************************************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_INSP_COMP]
	@order_no varchar(08),
	@gecb_no varchar(50),
	@ero_spb varchar(50)='',
	@power_board varchar(50)='',
	@lru_drive varchar(50)='',
	@igbt_box varchar(50)='',
	@ei_panel varchar(50)=''
AS
begin

     declare	@ROUT_TYPE  VARCHAR(5)  

-- exec SP_IF_INSP_COMP 'A2002005','ABCDEF1234567890'
-- grant exec on SP_IF_INSP_COMP to applications

	if exists ( select 'Y' 
					from mrp.dbo.t_myo_01 a
					where order_no=@order_no
					and run_status = '2' )
	begin
		update a set 
			gecb_serial=@gecb_no, 
			ero_spb=@ero_spb,
			power_board=@power_board,
			lru_drive=@lru_drive,
			igbt_box=@igbt_box,
			ei_panel=@ei_panel,
			date_gecb_update= getdate()
		from mrp.dbo.t_myo_01 a
		where order_no=@order_no

		--if @@ROWCOUNT=1
		select status='0', out_msg='업데이트 반영됨'
		
		return
	end

	--V3 인경우  반영 처리  @ROUT_TYPE = 'D0001'  다음 공정이 아닌 생산 완료로 바로 처리 함  20230630  반영 처리  
		 
		  SELECT  @ROUT_TYPE  =  T1.ROUT_TYPE
			FROM  EL_CD.DBO.T_CX_060 T1
		   WHERE  T1.ITEM_NO  = ( SELECT A.ITEM_NO FROM MRP.DBO.T_MYO_01 A WHERE A.ORDER_NO = @order_no )

	IF ( @ROUT_TYPE = 'D0001'  )
		   BEGIN
		     
			  update a set 
					gecb_serial        = @gecb_no, 
					ero_spb            = @ero_spb,
					power_board        = @power_board,
					lru_drive          = @lru_drive,
					igbt_box           = @igbt_box,
					ei_panel           = @ei_panel, 
					qty_finish         = QTY_AO ,               --종료수량
					date_gecb_update   = getdate(),             --GECB수정일시
					date_inspect       = getdate(),             --검사완료일
					--project_move_date  = getdate(),             --장소이동일시  처리하면 않됨 ( 재고 반영에 영향 )
					run_status         = '6'                    --진행상태
				from mrp.dbo.t_myo_01 a
				where order_no  =  @order_no
			
				update b set last_in_date=getdate(), rslt_date=getdate(), run_status='N'
				from mrp.dbo.t_myo_01 a,  EL_CD..T_CA_011 b
				where a.order_no = @order_no
				and b.project_no = a.project_no
				and b.mfg_no     = a.mfg_no
				and b.part       = a.part
				and b.part_seq   = a.part_seq
				and b.ao_no      = a.order_no
				and b.run_status <> 'N'

				select status='0', out_msg='업데이트 반영됨'
				return
		   END 
--------------------------------------------------------------------
	ELSE 
		BEGIN   

	if not exists ( select 'Y' 
					from mrp.dbo.t_myo_01 a
					where order_no=@order_no
					and run_status = '5' -- 공정완료
					and date_store is not null)
	begin
		select status='1', out_msg='검사 대기 상태가 아님'
		return
	end

	--검사완료처리(6)
	--취소(7)
	update a set 
		gecb_serial=@gecb_no, 
		ero_spb=@ero_spb,
		power_board=@power_board,
		lru_drive=@lru_drive,
		igbt_box=@igbt_box,
		ei_panel=@ei_panel,
		date_gecb_update= getdate(), 
		date_inspect=getdate() 
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and date_store is not null
	
	update a set run_status='6'
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and date_store is not null
	and run_status='5'


	update b set last_in_date=getdate(), rslt_date=getdate(), run_status='N'
	from mrp.dbo.t_myo_01 a,  EL_CD..T_CA_011 b
	where a.order_no=@order_no
	and b.project_no=a.project_no
	and b.mfg_no=a.mfg_no
	and b.part=a.part
	and b.part_seq=a.part_seq
	and b.ao_no = a.order_no
	and b.run_status <> 'N'

	EXEC SP_Common_M_Order_PriceSet @order_no

	--if @@ROWCOUNT=1
		select status='0', out_msg='업데이트 반영됨'
	--else
	--	select status='2', out_msg='반영할 데이터가 없습니다.'
	return
  END	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_INSP_COMP
 *
 * DISCRIPTION      : 제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_INSP_COMP_MANUAL]
	@order_no varchar(08),
	@gecb_no varchar(30),
	@date_inspect varchar(8)
AS
begin
-- exec SP_IF_INSP_COMP_MANUAL 'A2002005','ABCDEF1234567890'
-- grant exec on SP_IF_INSP_COMP_MANUAL to applications
	

	

	if (@date_inspect < '0' or ISDATE(@date_inspect) <> 1)
	begin
		select status='1', out_msg='검사 일자가 없거나 정확하지 않음.'
		return
	end 
	--select @date_inspect = getdate()

	if not exists ( select 'Y' 
					from mrp.dbo.t_myo_01 a
					where order_no=@order_no
					--and run_status = '5' -- 공정완료
					and date_store is not null)
	begin
		select status='2', out_msg='검사 대기 상태가 아님'
		return
	end

	--검사완료처리(6)
	--취소(7)
	--update a set run_status='6', gecb_serial=@gecb_no, date_gecb_update= @date_inspect, date_inspect=@date_inspect 
	update a set gecb_serial=@gecb_no, date_gecb_update= @date_inspect, date_inspect=@date_inspect 
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and date_store is not null

	update a set run_status='6'
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and run_status = '5'
	-- select * from el_cd.dbo.t_ex_000 where code_select='M02'

	update b set last_in_date=@date_inspect, rslt_date=@date_inspect, run_status='N'
	from mrp.dbo.t_myo_01 a,  EL_CD..T_CA_011 b
	where a.order_no=@order_no
	and b.project_no=a.project_no
	and b.mfg_no=a.mfg_no
	and b.part=a.part
	and b.part_seq=a.part_seq
	and b.ao_no = a.order_no
	and b.run_status <> 'N'

	EXEC SP_Common_M_Order_PriceSet @order_no

	--if @@ROWCOUNT=1
		select status='0', out_msg='업데이트 반영됨'
	--else
	--	select status='3', out_msg='반영할 데이터가 없습니다.'
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_INSP_COMP
 *
 * DISCRIPTION      : 제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		제조지시번호와 GECB 번호를 매칭하여 업데이트한다.
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_INSP_COMP_MANUAL_time]
	@order_no varchar(08),
	@gecb_no varchar(30),
	@date_inspect varchar(19)
AS
begin
-- grant exec on SP_IF_INSP_COMP_MANUAL_time to applications
-- exec SP_IF_INSP_COMP_MANUAL_time 'A2014029', 'ABRACADABRA', '2020-04-29 15:59:55'
-- exec SP_IF_INSP_COMP_MANUAL_time 'A2014030', 'ABRACADABRA', '2020-04-29 15:59:55'
	

	

	if (@date_inspect < '0' or ISDATE(@date_inspect) <> 1)
	begin
		select status='1', out_msg='검사 일자가 없거나 정확하지 않음.'
		return
	end 
	--select @date_inspect = getdate()

	if not exists ( select 'Y' 
					from mrp.dbo.t_myo_01 a
					where order_no=@order_no
					--and run_status = '5' -- 공정완료
					and date_store is not null)
	begin
		select status='2', out_msg='검사 대기 상태가 아님'
		return
	end

	--검사완료처리(6)
	--취소(7)
	--update a set run_status='6', gecb_serial=@gecb_no, date_gecb_update= @date_inspect, date_inspect=@date_inspect 
	update a set gecb_serial=@gecb_no, date_gecb_update= @date_inspect, date_inspect=@date_inspect 
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and date_store is not null

	update a set run_status='6'
	-- select *
	from mrp.dbo.t_myo_01 a
	where order_no=@order_no
	and run_status = '5'
	-- select * from el_cd.dbo.t_ex_000 where code_select='M02'

	update b set last_in_date=@date_inspect, rslt_date=getdate(), run_status='N'
	from mrp.dbo.t_myo_01 a,  EL_CD..T_CA_011 b
	where a.order_no=@order_no
	and b.project_no=a.project_no
	and b.mfg_no=a.mfg_no
	and b.part=a.part
	and b.part_seq=a.part_seq
	and b.ao_no = a.order_no
	and b.run_status <> 'N'

	EXEC SP_Common_M_Order_PriceSet @order_no

	--if @@ROWCOUNT=1
		select status='0', out_msg='업데이트 반영됨'
	--else
	--	select status='3', out_msg='반영할 데이터가 없습니다.'
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ITEM_FETCH
 *
 * DISCRIPTION      : 수정된 Item 정보를 내려준다.(DPS / 울랄라 제공)
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 01월 30일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-01-30	오티스 MES 프로젝트		송승훈		Item 정보 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ITEM_FETCH]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_ITEM_FETCH '20200520','20200530'
-- select * from EL_CD.dbo.t_cx_160 
-- grant exec on SP_IF_ITEM_FETCH to applications
	select item_no, citem_no into #cx_069 from EL_CD.dbo.t_cx_069

	select	a.item_no, 
			a.eng_desc, 
			a.order_select, 
			rout_type=isnull(a.rout_type,''),
			stock_qty=isnull((select sum(qty_stock)
						from mrp.dbo.t_mva_061 c 
					where c.item_no=a.item_no 
					and c.gaijung='SPSS' 
					and c.order_select in ('D','I')),0),
			safe_stock_qty=isnull(b.safe_stock_qty,0), 
			store=isnull(b.store,''),
			--dps_id=isnull(b.dps_id,'')
			dps_id=isnull((case when b.zone = 'Z' or b.dps_id>250 then 'Z' 
					   else b.dps_id
					   end ),'')
	from EL_CD.dbo.t_cx_060 a
		left outer join EL_CD.dbo.t_cx_160 b on b.item_no=a.item_no
		left outer join mrp.dbo.t_mva_061 c 
		on c.item_no=a.item_no 
		and c.gaijung='SPSS' 
		and c.order_select in ('D','I')
	where date_update between @from_date and @to_date
	and exists(select * from #cx_069 x where x.item_no=a.item_no or x.citem_no=a.item_no)
 
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ORDER_DETAIL_LIST
 *
 * DISCRIPTION      : 제조지시상세를 내려준다
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		제조상세 정보 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ORDER_DETAIL_LIST]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_ORDER_DETAIL_LIST '20191220','20200330'
-- grant exec on SP_IF_ORDER_DETAIL_LIST to applications

	select b.order_no, b.rout_seq, b.wc_code, b.start_time, b.end_time
	from mrp.dbo.t_myo_01 a,mrp.dbo.t_myo_11 b
	where a.date_start between @from_date and @to_date
	and a.order_no=b.order_no
	and a.run_status <> 'Z'
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ORDER_FETCH
 *
 * DISCRIPTION      : QR 캐비닛 주문번호를 읽어 제조지시M/S 정보를 조회한다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		QR 캐비닛 주문번호를 읽어 제조지시M/S 정보를 조회한다.
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ORDER_FETCH]
	@cabinet_order_no varchar(08)
AS
begin
-- exec SP_IF_ORDER_FETCH '0A030250' 
-- grant exec on SP_IF_ORDER_FETCH to applications
	
	select	a.order_no,
			a.item_no,
			a.run_status,
			a.date_start,
			a.qty_ao,
			a.rout_type,
			a.concern_order_no,
			a.gecb_serial
	from mrp.dbo.t_myo_01 a
	where concern_order_no=@cabinet_order_no
	
end

/*
-- 0A010060     
select *
from el_cd..t_ca_011
where project_no like '2020D  M001%'
and concern_order_no='A2009001'

select *
from el_cd.dbo.t_ca_011
where project_no='2020D  M001'

select *
-- update a set concern_order_no='0A030250'
from mrp.dbo.t_myo_01 a
where order_no='A2009001'
*/;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ORDER_LIST
 *
 * DISCRIPTION      : 제조지시마스터를 내려준다
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 02월 03일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		송승훈		제조마스터 정보 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ORDER_LIST]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_ORDER_LIST '20191220','20200330'
-- grant exec on SP_IF_ORDER_LIST to applications
	
	select	a.order_no,
			a.item_no,
			a.run_status,
			a.date_start,
			a.qty_ao,
			a.rout_type,
			a.concern_order_no,
			a.gecb_serial
	from mrp.dbo.t_myo_01 a
	where date_start between @from_date and @to_date
	and run_status <> 'Z'
	
end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ROUT_DETAIL_FETCH
 *
 * DISCRIPTION      : 수정된 공정상세 정보를 내려준다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 01월 30일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-01-30	오티스 MES 프로젝트		송승훈		공정상세 정보 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ROUT_DETAIL_FETCH]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_ROUT_DETAIL_FETCH '20191220','20200330'
-- grant exec on SP_IF_ROUT_DETAIL_FETCH to applications
	select	b.rout_type, 
			b.rout_seq, 
			b.wc_code, 
			b.work_desc, 
			b.manage_point
	from EL_CD.dbo.T_CX_620 a, EL_CD.dbo.T_CX_630 b
	where a.date_update between @from_date and @to_date
	and a.rout_type=b.rout_type	

end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_ROUT_MS_FETCH
 *
 * DISCRIPTION      : 수정된 공정마스터 정보를 내려준다.
 *
 * RELATIVE_FORM    : I/F (Workstation)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2020년 01월 30일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-01-30	오티스 MES 프로젝트		송승훈		공정마스터 정보 조회
 *********************************************************************************/
 
CREATE PROCEDURE [dbo].[SP_IF_ROUT_MS_FETCH]
	@from_date char(08),
	@to_date char(08)
AS
begin
-- exec SP_IF_ROUT_MS_FETCH '20191220','20200330'
-- grant exec on SP_IF_ROUT_MS_FETCH to applications
	select rout_type, rout_desc, date_update 
	from EL_CD.dbo.T_CX_620 a
	where date_update between @from_date and @to_date	
end;

/********************************************************************************/
/*  SP NAME          : SP_IF_ROUTSEQ_Comp										*/
/*  DESCRIPTION      : 공정 완료 처리											*/
/*  RELATIVE_FORM    : WorkStation (예정)										*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_IF_ROUTSEQ_Comp]
	@flag		char(1),  -- S:Start Time, E:End Time
	@order_no	varchar(08),
	@rout_seq	varchar(03),
--	@wc_code	varchar(06),
	@date_issue	datetime=null --, 
	--@qty		real=0

AS
SET NOCOUNT ON
--grant exec on SP_IF_RoutSeq_Comp to applications
/*
	declare	@status		char(01),
			@out_msg	varchar(100)

	select @status='0',@out_msg='OK'  --'공정완료('+@flag+') OK ...'
*/
	declare	@run_status	char(01),
			@item_no	varchar(15),
			--@wc_code	varchar(06),
			@qty		real

	if @rout_seq < '0'
		select @rout_seq='999'

	--if @date_issue is null
		select @date_issue=getdate()

/*
-- 이걸로 테스트 하세요.
declare	@getdate	datetime
select @getdate	= getdate()

EXEC SP_IF_RoutSEQ_Comp 'S', 'A2002005', '010', @getdate

*/
/*
declare	@status		char(01),
		@out_msg	varchar(50), 
declare	@getdate	datetime
select @getdate	= getdate()

EXEC SP_IF_RoutSEQ_Comp 'S', 'A2002005', '010', '' @getdate   --, @status output, @out_msg output  -- 오늘 날짜로 할 것.

select @status, @out_msg
*/

	if not exists (	select  'Y'
					from T_MYO_01
					where order_no = @order_no 
					and run_status in ('3','4')   --jjg 테스트 후 원복할 것.
					and qty_ao > 0)
--					and qty_finish = 0)  -- 결정 필요.
	begin
		select status='1', out_msg='Error : 처리 대상 없음'
		return
	end

	if not exists (	select 	'Y'
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq=@rout_seq
					and status in ('1','4')
					and qty_finish = 0)  
	begin
		select status='2', out_msg='Error : 공정 처리 상태 오류'
		return
	end
	/*
	if exists (select 'y' 
				from T_MYO_11 a
				where a.order_no = @order_no
				and a.rout_seq < @rout_seq
				and (a.start_time is null or a.end_time is null))
	begin
		select status='3', out_msg='Error : 이전 공정 미완료 됨'
		return
	end
	*/
	if @flag = 'S'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.start_time is not null)
		begin
			select status='4', out_msg='Error : 기 공정완료(S) 됨'
			return
		end
	end

	if @flag = 'E'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.end_time is not null)
--					and (a.start_time is null or a.end_time is not null))
		begin
			select status='5', out_msg='Error : 기 공정완료(E) 됨'
			return
		end
	end

	--if @qty = 0
	select @qty=qty_ao
	from T_MYO_01
	where order_no = @order_no 



	declare	@project_no	varchar(11),
			@mfg_no	varchar(03),
			@part		varchar(02),
			@part_seq	varchar(04),
			@manage_point char(1)

	select  @project_no = project_no,
			@mfg_no = mfg_no,
			@part  = part,
			@part_seq = part_seq
	from T_MYO_01 b
	where b.order_no = @order_no

	select @manage_point = manage_point
	from T_MYO_11 a
	where a.order_no=@order_no
	and a.rout_seq=@rout_seq

--	begin tran SP_JOB_T4N0
		
	if @flag = 'S'  -- 공정 Start Time
	begin
		update a set 
			date_start_act=getdate(),
			run_status='4'
		from T_MYO_01 a
		where a.order_no=@order_no
		and run_status = '3'

		update a set 
			status='4',
			start_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
	end
	else  -- 공정 End Time
	begin	
		update a set 
			last_trans_no=last_trans_no+1,
			--act_ready_time=a.act_ready_time+std_ready_time,
			--act_move_time=a.act_move_time+std_move_time,
			act_run_time=(case when start_time is not null then datediff(SECOND, start_time, @date_issue) else 0 end), -- a.act_run_time+std_run_time,  
			qty_finish=@qty, 
			status='5',
			end_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
		
		if @rout_seq = '010'
		begin
			update a set 
				qty_input=@qty --, 
				--date_start_act=getdate(),
				--run_status='4'
			from T_MYO_01 a
			where a.order_no=@order_no
		end

		if @qty > 0  and @manage_point in ('E')
		begin
			update a set qty_finish=@qty,
						 date_store= getdate(),
						 run_status= '5' 
			from T_MYO_01 a
			where a.order_no=@order_no

			-- 누락 공정 완료 처리 START
			update a set qty_input=@qty 
			from T_MYO_01 a
			where a.order_no=@order_no
			and qty_input = 0

			update a set start_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.start_time is NULL

			update a set end_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.end_time is NULL

			-- 누락 공정 완료 처리 END

			update a set prod_qty = @qty,
						 run_date= getdate(),
						 run_status='L', 
						 rslt_date=getdate() 
			from EL_CD..T_CA_011 a
			where a.project_no=@project_no
			and a.mfg_no=@mfg_no
			and a.part=@part
			and a.part_seq=@part_seq
			and a.ao_no = @order_no
/*
			if exists (select  *
				from EL_CD..T_CA_013 a
				where a.project_no=@project_no
				and a.mfg_no=@mfg_no
				and a.part=@part
				and a.part_seq=@part_seq
				and a.io_flag='1'
				and a.date_io=@date_issue)
			begin
				update a set
					qty_io=a.qty_io+@qty
				from EL_CD..T_CA_013 a
				where a.project_no=@project_no
				and a.mfg_no=@mfg_no
				and a.part=@part
				and a.part_seq=@part_seq
				and a.io_flag='1'
				and a.date_io=@date_issue
			end
			else
			begin
				insert into EL_CD..T_CA_013
				select	@project_no,@mfg_no,1,@part,@part_seq,
					io_flag ='1',
					date_io=@date_issue,
					seq_no=1,
					qty_io=@qty,
					amt_io=0,
					create_flag='',
					create_desc='',
					management_flag='' ---?????
			end
*/
		end
	end

	/*
	IF @@ERROR = 0
	BEGIN			
		COMMIT TRAN SP_JOB_T4N0
	END
	ELSE
	BEGIN	
		ROLLBACK TRAN SP_JOB_T4N0
		select status='6',out_msg='공정완료 처리중 에러발생'
		return
	END
	*/
	--select status=@status, out_msg=@out_msg
	select status='0', out_msg='OK'  --'공정완료('+@flag+') OK ...'

SET NOCOUNT OFF;

/********************************************************************************/
/*  SP NAME          : SP_IF_ROUTSEQ_Comp										*/
/*  DESCRIPTION      : 공정 완료 처리											*/
/*  RELATIVE_FORM    : WorkStation (예정)										*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

create PROCEDURE [dbo].[SP_IF_ROUTSEQ_Comp_Manual_Time]
	@flag		char(1),  -- S:Start Time, E:End Time
	@order_no	varchar(08),
	@rout_seq	varchar(03),
	@date_issue	varchar(19)=''
	
AS
SET NOCOUNT ON
--grant exec on SP_IF_ROUTSEQ_Comp_Manual_Time to applications
--exec SP_IF_ROUTSEQ_Comp_Manual_Time 'S', 'A2014029', '030', '2020-04-29 15:55:55'
--exec SP_IF_ROUTSEQ_Comp_Manual_Time 'E', 'A2014029', '030', '2020-04-29 15:59:55'

	declare	@run_status	char(01),
			@item_no	varchar(15),
			--@wc_code	varchar(06),
			@qty		real

	if @rout_seq < '0'
		select @rout_seq='999'

	if @date_issue = ''
		select @date_issue=convert(varchar(19),getdate(),121)

/*
-- 이걸로 테스트 하세요.
declare	@getdate	datetime
select @getdate	= getdate()

EXEC SP_IF_RoutSEQ_Comp 'S', 'A2002005', '010', @getdate

*/
/*
declare	@status		char(01),
		@out_msg	varchar(50), 
declare	@getdate	datetime
select @getdate	= getdate()

EXEC SP_IF_RoutSEQ_Comp 'S', 'A2002005', '010', '' @getdate   --, @status output, @out_msg output  -- 오늘 날짜로 할 것.

select @status, @out_msg
*/

	if not exists (	select  'Y'
					from T_MYO_01
					where order_no = @order_no 
					and run_status in ('3','4')   --jjg 테스트 후 원복할 것.
					and qty_ao > 0)
--					and qty_finish = 0)  -- 결정 필요.
	begin
		select status='1', out_msg='Error : 처리 대상 없음'
		return
	end

	if not exists (	select 	'Y'
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq=@rout_seq
					and status in ('1','4')
					and qty_finish = 0)  
	begin
		select status='2', out_msg='Error : 공정 처리 상태 오류'
		return
	end
	/*
	if exists (select 'y' 
				from T_MYO_11 a
				where a.order_no = @order_no
				and a.rout_seq < @rout_seq
				and (a.start_time is null or a.end_time is null))
	begin
		select status='3', out_msg='Error : 이전 공정 미완료 됨'
		return
	end
	*/
	if @flag = 'S'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.start_time is not null)
		begin
			select status='4', out_msg='Error : 기 공정완료(S) 됨'
			return
		end
	end

	if @flag = 'E'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.end_time is not null)
--					and (a.start_time is null or a.end_time is not null))
		begin
			select status='5', out_msg='Error : 기 공정완료(E) 됨'
			return
		end
	end

	--if @qty = 0
	select @qty=qty_ao
	from T_MYO_01
	where order_no = @order_no 



	declare	@project_no	varchar(11),
			@mfg_no	varchar(03),
			@part		varchar(02),
			@part_seq	varchar(04),
			@manage_point char(1)

	select  @project_no = project_no,
			@mfg_no = mfg_no,
			@part  = part,
			@part_seq = part_seq
	from T_MYO_01 b
	where b.order_no = @order_no

	select @manage_point = manage_point
	from T_MYO_11 a
	where a.order_no=@order_no
	and a.rout_seq=@rout_seq

--	begin tran SP_JOB_T4N0
		
	if @flag = 'S'  -- 공정 Start Time
	begin
		update a set 
			date_start_act=getdate(),
			run_status='4'
		from T_MYO_01 a
		where a.order_no=@order_no
		and run_status = '3'

		update a set 
			status='4',
			start_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
	end
	else  -- 공정 End Time
	begin	
		update a set 
			last_trans_no=last_trans_no+1,
			--act_ready_time=a.act_ready_time+std_ready_time,
			--act_move_time=a.act_move_time+std_move_time,
			act_run_time=(case when start_time is not null then datediff(SECOND, start_time, @date_issue) else 0 end), -- a.act_run_time+std_run_time,  
			qty_finish=@qty, 
			status='5',
			end_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
		
		if @rout_seq = '010'
		begin
			update a set 
				qty_input=@qty --, 
				--date_start_act=getdate(),
				--run_status='4'
			from T_MYO_01 a
			where a.order_no=@order_no
		end

		if @qty > 0  and @manage_point in ('E')
		begin
			update a set qty_finish=@qty,
						 date_store= getdate(),
						 run_status= '5' 
			from T_MYO_01 a
			where a.order_no=@order_no

			-- 누락 공정 완료 처리 START
			update a set qty_input=@qty 
			from T_MYO_01 a
			where a.order_no=@order_no
			and qty_input = 0

			update a set start_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.start_time is NULL

			update a set end_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.end_time is NULL

			-- 누락 공정 완료 처리 END

			update a set prod_qty = @qty,
						 run_date= getdate(),
						 run_status='L', 
						 rslt_date=getdate() 
			from EL_CD..T_CA_011 a
			where a.project_no=@project_no
			and a.mfg_no=@mfg_no
			and a.part=@part
			and a.part_seq=@part_seq
			and a.ao_no = @order_no
/*
			if exists (select  *
				from EL_CD..T_CA_013 a
				where a.project_no=@project_no
				and a.mfg_no=@mfg_no
				and a.part=@part
				and a.part_seq=@part_seq
				and a.io_flag='1'
				and a.date_io=@date_issue)
			begin
				update a set
					qty_io=a.qty_io+@qty
				from EL_CD..T_CA_013 a
				where a.project_no=@project_no
				and a.mfg_no=@mfg_no
				and a.part=@part
				and a.part_seq=@part_seq
				and a.io_flag='1'
				and a.date_io=@date_issue
			end
			else
			begin
				insert into EL_CD..T_CA_013
				select	@project_no,@mfg_no,1,@part,@part_seq,
					io_flag ='1',
					date_io=@date_issue,
					seq_no=1,
					qty_io=@qty,
					amt_io=0,
					create_flag='',
					create_desc='',
					management_flag='' ---?????
			end
*/
		end
	end

	/*
	IF @@ERROR = 0
	BEGIN			
		COMMIT TRAN SP_JOB_T4N0
	END
	ELSE
	BEGIN	
		ROLLBACK TRAN SP_JOB_T4N0
		select status='6',out_msg='공정완료 처리중 에러발생'
		return
	END
	*/
	--select status=@status, out_msg=@out_msg
	select status='0', out_msg='OK'  --'공정완료('+@flag+') OK ...'

SET NOCOUNT OFF;

/********************************************************************************/
/*  SP NAME          : SP_IF_RoutSeq_Comp_Multi_LIne							*/
/*  DESCRIPTION      : Multi Line 공정 완료 처리								*/
/*  RELATIVE_FORM    : WorkStation (예정)										*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/


CREATE PROCEDURE [dbo].[SP_IF_RoutSeq_Comp_Multi_LIne]
	@flag		char(1),  -- S:Start Time, E:End Time
	@order_no	varchar(08),
	@rout_seq	varchar(03),
	@wc_code	varchar(06),
	@manage_point char(1),
	@act_run_time real,
	@date_issue	datetime=null 

AS
SET NOCOUNT ON
-- grant exec on SP_IF_RoutSeq_Comp_Multi_LIne to applications

/*
-- 이걸로 테스트 하세요.
declare	@getdate	datetime
select @getdate	= getdate()

--검사 공정은 반드시 'I' 로 시작해야 함.

-- SP_IF_RoutSeq_Comp_Multi_LIne 'S', 'A2052006', 'B10', 'W00001', 'S',    0, '2021-10-21 02:01:05'
-- SP_IF_RoutSeq_Comp_Multi_LIne 'E', 'A2052006', 'B10', 'W00001', 'E',  103, '2021-10-21 02:01:05'

-- SP_IF_RoutSeq_Comp_Multi_LIne 'S', 'A2052006', 'I30', 'I00004', '',     0, '2021-10-21 06:01:05'
-- SP_IF_RoutSeq_Comp_Multi_LIne 'E', 'A2052006', 'I30', 'I00004', '',  3334, '2021-10-21 06:20:25'

*/
	declare	@run_status	char(01),
			@item_no	varchar(15),
			@qty		real   ,
			@ROUT_TYPE  VARCHAR(5)  

	if @rout_seq < '0'
	begin
		select status='1', out_msg='Error : 공정 순서 입력 오류'
		return
	end

	--if @date_issue is null
	--	select @date_issue=getdate()


if left(@rout_seq,1) <> 'I'
begin
	if not exists (	select  'Y'
					from T_MYO_01
					where order_no = @order_no 
					and run_status in ('3','4')   --jjg 테스트 후 원복할 것.
					and qty_ao > 0)
	begin
		select status='1', out_msg='Error : 처리 대상 없음'
		return
	end

	if @flag = 'S'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq)
		begin
			select status='2', out_msg='Error : 해당 공정순서가 이미 존재함'
			return
		end

		insert into T_MYO_11
		select	order_no=a.order_no,
			rout_seq=@rout_seq,
			wc_code=@wc_code,
			qty_finish=0,
			std_ready_time=0,
			std_run_time=0,
			std_move_time=0,
			act_ready_time=0,
			act_run_time=0,
			act_move_time=0,
			date_start=NULL, -- 미사용 필드
			date_due=a.due_date,
			date_finish=NULL, -- 미사용 필드
			pre_rout_seq='',
			next_rout_seq='',
			status='1', 
			skp='',
			manage_point=@manage_point,
			last_trans_no=0,
			work_mtd='',
			start_time=NULL,
			end_time=NULL,
			update_date=NULL,
			update_user=NULL,
			entry_date=getdate()
		from T_MYO_01 a
		where a.order_no = @order_no

	end

	if @flag = 'E'
	begin

		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.end_time is not null)
		begin
			select status='4', out_msg='Error : 해당 공정 순서는 이미 완료상태임'
			return
		end


		if not exists (select 'y' 
						from T_MYO_11 a
						where a.order_no = @order_no
						and a.rout_seq = @rout_seq)
		begin
			--select status='3', out_msg='Error : 해당 공정 순서가 없어 공정완료 처리 불가함'
			--return
			insert into T_MYO_11
			select	order_no=a.order_no,
					rout_seq=@rout_seq,
					wc_code=@wc_code,
					qty_finish=0,
					std_ready_time=0,
					std_run_time=0,
					std_move_time=0,
					act_ready_time=0,
					act_run_time=0,
					act_move_time=0,
					date_start=NULL, -- 미사용 필드
					date_due=a.due_date,
					date_finish=NULL, -- 미사용 필드
					pre_rout_seq='',
					next_rout_seq='',
					status='1', 
					skp='',
					manage_point='',
					last_trans_no=0,
					work_mtd='',
					start_time=@date_issue,
					end_time=NULL,
					update_date=NULL,
					update_user=NULL,
					entry_date=getdate()
			from T_MYO_01 a
			where a.order_no = @order_no
		end

	end

	select @qty=qty_ao
	from T_MYO_01
	where order_no = @order_no 

	declare	@project_no	varchar(11),
			@mfg_no	varchar(03),
			@part		varchar(02),
			@part_seq	varchar(04) --,
			--@manage_point char(1)

	select  @project_no = project_no,
			@mfg_no = mfg_no,
			@part  = part,
			@part_seq = part_seq
	from T_MYO_01 b
	where b.order_no = @order_no

--	begin tran SP_JOB_T4N0
		
	if @flag = 'S'  -- 공정 Start Time
	begin
		update a set 
			date_start_act=getdate(),
			run_status='4'
		from T_MYO_01 a
		where a.order_no=@order_no
		and run_status = '3'

		update a set 
			status='4',
			start_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
	end
	else  -- 공정 End Time
	begin	
		update a set 
			last_trans_no=last_trans_no+1,
			act_run_time=@act_run_time,  
			qty_finish=@qty, 
			manage_point=@manage_point,
			status='5',
			end_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
		
		if 1 = ( select count(*)
				 from t_myo_11
				 where order_no = @order_no )
		begin
			update a set qty_input = @qty
			from T_MYO_01 a
			where a.order_no=@order_no
		end

		if @qty > 0  and @manage_point in ('E')
		begin
			update a set qty_finish=@qty,
						 date_store= getdate(),
						 run_status= '5' 
			from T_MYO_01 a
			where a.order_no=@order_no

			-- 누락 공정 완료 처리 START
			update a set qty_input=@qty 
			from T_MYO_01 a
			where a.order_no=@order_no
			and qty_input = 0

			update a set start_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.start_time is NULL

			update a set end_time = @date_issue,
					     qty_finish=(CASE when qty_finish =0  then @qty else qty_finish end),
					     status='5'  --(CASE when status <> '5'  then '5' else status end)
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq<=@rout_seq
			and a.end_time is NULL

			-- 누락 공정 완료 처리 END

			update a set prod_qty = @qty,
						 run_date= getdate(),
						 run_status='L', 
						 rslt_date=getdate() 
			from EL_CD..T_CA_011 a
			where a.project_no=@project_no
			and a.mfg_no=@mfg_no
			and a.part=@part
			and a.part_seq=@part_seq
			and a.ao_no = @order_no
			and a.run_status not in ('N','R')
		end
	end
end

if left(@rout_seq,1) = 'I'
begin
	if not exists (	select  'Y'
					from T_MYO_01
					where order_no = @order_no 
					and qty_ao > 0)
	begin
		select status='6', out_msg='Error : 처리 대상 없음'
		return
	end

	if @flag = 'S'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq)
		begin
			select status='7', out_msg='Error : 해당 공정순서가 이미 존재함'
			return
		end

		insert into T_MYO_11
		select	order_no=a.order_no,
			rout_seq=@rout_seq,
			wc_code=@wc_code,
			qty_finish=0,
			std_ready_time=0,
			std_run_time=0,
			std_move_time=0,
			act_ready_time=0,
			act_run_time=0,
			act_move_time=0,
			date_start=NULL, -- 미사용 필드
			date_due=a.due_date,
			date_finish=NULL, -- 미사용 필드
			pre_rout_seq='',
			next_rout_seq='',
			status='1', 
			skp='',
			manage_point='',
			last_trans_no=0,
			work_mtd='',
			start_time=@date_issue,
			end_time=NULL,
			update_date=NULL,
			update_user=NULL,
			entry_date=getdate()
		from T_MYO_01 a
		where a.order_no = @order_no

	end

	if @flag = 'E'
	begin
		if exists (select 'y' 
					from T_MYO_11 a
					where a.order_no = @order_no
					and a.rout_seq = @rout_seq
					and a.end_time is not null)
		begin
			select status='9', out_msg='Error : 해당 공정 순서는 이미 완료상태임'
			return
		end

		if not exists (select 'y' 
						from T_MYO_11 a
						where a.order_no = @order_no
						and a.rout_seq = @rout_seq)
		begin
			--select status='8', out_msg='Error : 해당 공정 순서가 없어 공정완료 처리불가함'
			--return

			insert into T_MYO_11
			select	order_no=a.order_no,
				rout_seq=@rout_seq,
				wc_code=@wc_code,
				qty_finish=0,
				std_ready_time=0,
				std_run_time=0,
				std_move_time=0,
				act_ready_time=0,
				act_run_time=0,
				act_move_time=0,
				date_start=NULL, -- 미사용 필드
				date_due=a.due_date,
				date_finish=NULL, -- 미사용 필드
				pre_rout_seq='',
				next_rout_seq='',
				status='1', 
				skp='',
				manage_point='',
				last_trans_no=0,
				work_mtd='',
				start_time=@date_issue,
				end_time=NULL,
				update_date=NULL,
				update_user=NULL,
				entry_date=getdate()
			from T_MYO_01 a
			where a.order_no = @order_no
		end

	end

	select @qty=qty_ao
	from T_MYO_01
	where order_no = @order_no 



--	begin tran SP_JOB_T4N0
		
	if @flag = 'S'  -- 공정 Start Time
	begin
		update a set 
			status='4',
			start_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
	end
	else  -- 공정 End Time
	begin	
		update a set 
			last_trans_no=last_trans_no+1,
			act_run_time=@act_run_time,
			qty_finish=@qty, 
			status='5',
			end_time = @date_issue
		from T_MYO_11 a
		where a.order_no=@order_no
		and a.rout_seq=@rout_seq
		
		if exists ( select 'Y'
					from T_MYO_11 a
					where a.order_no=@order_no
					and a.rout_seq=@rout_seq
					and a.start_time is NULL )
		begin
			update a set start_time = @date_issue
			from T_MYO_11 a
			where a.order_no=@order_no
			and a.rout_seq=@rout_seq
			and a.start_time is NULL
		end


	end
end

	select status='0', out_msg='OK'  --'공정완료('+@flag+') OK ...'

SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_Main_Purchasing_Order_Release                                                                                                                                              */
/*  DISCRIPTION  :  주문집행 (오더별)                                                                                                                       */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/04     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_Main_Purchasing_Order_Release]
	@gaijung	varchar(04),
	@order_no	varchar(08)
AS
SET NOCOUNT ON

/*
--grant exec on [SP_Main_Purchasing_Order_Release] to applications
declare	@status		char(01)		,
	@out_msg	varchar(100)	

exec SP_Common_Purchasing_Order_Confirm 'ELES','0AAT0030',@status output,@out_msg output

select @status ,@out_msg 

*/

	declare	@status		char(01),
			@out_msg	varchar(100) 

	if not exists (select *
				from el_cd..t_va_020 a
				where a.order_no = @order_no
				and (trade_no > '0' or a.supply = 'I')
				and run_status < '4')
	begin
		SELECT status='1',out_msg=' Vendor ?????'
		return
	end

	update a set 
		run_status='3'
	from el_cd..t_va_020 a
	where a.order_no = @order_no
	
	exec mrp..SP_Common_Purchasing_Order_Release
		@gaijung,
		@order_no,
		@status			output,
		@out_msg		output
	
	SELECT status=@status,out_msg=@out_msg

SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MCP_310_1                                                                                                                                              */
/*  DISCRIPTION  :  유상판매대상 조회                                                                                                                    */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/18     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*****************************************************************************************************************/
/*  trade_no = '1123761'(오티스 엘리베이터(유) 인천공장) */
/*****************************************************************************************************************/
CREATE PROCEDURE [dbo].[SP_MCP_310_1]
	@gaijung	varchar(04),
	@out_use	char(01) = 'S'
as

	IF @out_use in ('S','K')
	BEGIN
		select 	order_select=(select c.order_select from el_cd..t_cx_060 c where c.item_no = a.item_no),
				order_no = '',				--직송 주문 번호
				gaijung = a.gaijung,				--계정
				a.item_no,					--품번
				out_use = (case when a.trade_no ='1123761' then 'K' else 'S' end),				--불출용도
				redgubun = '',				--흑적구분
				vendor=trade_no,				--거래처
				confirm_qty,				--승인수량
				req_qty,					--요청수량
				req_date = convert(varchar(08), req_date, 112),	--요청일자
				req_out_date = convert(varchar(08), req_date, 112),	--출고일		
				seq,					--순번
				store='WH'+@gaijung,
				stock_qty=isnull((select sum(b.qty_stock)
						from t_mva_061 b
						where b.item_no=a.item_no
						and b.gaijung=@gaijung),0 )				
		from 	EL_CD..t_vj_300 a
		where 	approve_flag = 'Y'
		and	(confirm_flag is null or confirm_flag = 'N')
		and (@gaijung < '0' or a.gaijung = @gaijung)
		and ((a.trade_no = '1123761' and @out_use = 'K') or (a.trade_no <> '1123761' and @out_use = 'S'))
		--and exists (select 'y' 
		--			from t_mva_061 c
		--			where c.item_no=a.item_no 
		--			and c.qty_stock >= a.req_qty
		--			and c.gaijung = a.gaijung)
		order by item_no, req_date, seq
	END
	ELSE
	BEGIN
		select 	a.order_select,
				a.order_no,				--직송 주문 번호
				gaijung = b.gaijung,				--계정
				a.item_no,					--품번
				out_use = 'V',				--불출용도
				redgubun = '',				--흑적구분
				vendor = a.trade_no,				--거래처
				confirm_qty = b.qty_order,				--승인수량
				req_qty = a.order_qty,					--요청수량
				req_date = convert(varchar(08), req_date, 112),	--요청일자
				req_out_date = convert(varchar(08), a.date_due, 112),	--출고일		
				seq = id_identity,					--순번
				store=isnull((select x.to_store 
						from T_MZR_03 x 
						where x.gaijung=b.gaijung 
						and x.order_select = b.supply),''),
				stock_qty=isnull((select sum(b.qty_stock)
						from t_mva_061 b
						where b.item_no=a.item_no
						and b.gaijung=a.gaijung),0 )
		from 	EL_CD..t_vj_310 a, EL_CD..T_VA_020 b 
		where 	a.input_flag = 'Y'
		and	(a.sagub_flag is null or a.sagub_date is null)
		and	b.order_no=a.order_no
		and (@gaijung < '0' or a.gaijung = @gaijung)
		--and	left(b.gaijung,2) = left(@gaijung,2)
		--and (@gaijung < '0' or a.gaijung = @gaijung)
		and b.gaijung = a.gaijung
		order by a.item_no, req_date, id_identity
	END;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MCP_310_2                                                                                                                                              */
/*  DISCRIPTION  :  유상판매입력                                                                                                                            */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/22     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MCP_310_2]
	@item_no		varchar(15),
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	char(01),
	@vendor			varchar(08),
	@qty			varchar(10),
	@req_date		varchar(08),
	@seq     		int,
	@out_Use	   	char(01) = 'S',
	@user_id		varchar(08)=''
as
--exec MRP.dbo.sp_MCP_310_2 '2R16579A','ELES','','','1088096','300','20100114',1,'S','lgjjg'

	declare	@order_no	varchar(08),
			@jp_no		varchar(13)

	select @order_no=''

	IF @out_Use =  'V'
	begin
		select @order_no=order_no
		from EL_CD..t_vj_310 a
		where 	id_identity = @seq	
	end

	declare	@status		char(01),
			@out_msg	varchar(100)

	exec SP_Common_Item_Sale
		@order_no		,
		@item_no		,
		@gaijung		,
		@store			,
--ssh		'',				--@store		,
		@order_select		,
		@vendor		,
		'',				--@o_prod_no		,
		'',				--@o_red_gubun		,
		'',				--@o_date_io		,
		@qty,				--승인수량
		'0',				--@o_sale_price		,
		@out_use		,
		@req_date		,
		@seq     		,
		@user_id		,
		@jp_no			output,
		@status			output,
		@out_msg		output

	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	IF @out_Use in ('S','K','A') --사급대체 추가
		update  a	set
			jp_no = right(@jp_no,12),
			confirm_date = convert(varchar(08), getdate(), 112),
			confirm_flag = 'Y'
		from el_cd..t_vj_300 a
		where 	item_no = @item_no
		and	trade_no = @vendor
		and	req_date = @req_date
		and	seq = @seq
	ELSE
		update  a	set
			jp_no = right(@jp_no,12),
			sagub_date = convert(varchar(08), getdate(), 112),
			sagub_flag = 'Y',
			step = 10
		from el_cd..t_vj_310 a
		where 	id_identity = @seq		

	select status='0',out_msg=' 유상판매처리 OK ..',jp_no=@jp_no;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MCP_530_1                                                                                                                                                    */
/*  DISCRIPTION  : 매출처리                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/09     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MCP_530_1]
	@gaijung		varchar(04),
	@ship_no		varchar(12),
	@date_action	char(08)
AS
SET NOCOUNT ON

/*

exec MRP.dbo.SP_MCP_530_1 'ELES','ELE091130004',''

*/
	declare	@status		char(01),
			@out_msg	varchar(100)

	if @date_action < '0'
		select @date_action=convert(char(08),getdate(),112)

	if isdate(@date_action)=0
	begin
		select status='1',out_msg=' 출하일자를 재입력하세요 ???'
		return
	end

	exec mrp..SP_Common_Shipping_by_ShipNo	
		@gaijung,@ship_no,@date_action,@status output,@out_msg output

	select	status=@status,out_msg=@out_msg;

/********************************************************************************/
/*  SP NAME          : SP_MES_005_1												*/
/*  DESCRIPTION      : 제조 생산 계획 조회										*/
/*  RELATIVE_FORM    : mes_005													*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/*  1.1    2020-02-13	제조(착수)일 추가		LGNCJ		Initial				*/
/*						, T_MYO_01 b											*/
/*						and b.order_no = a.ao_no								*/
/*						and b.run_status='1'									*/
/*  1.2    2020-03-04	출력 필드추가			LGNCJ		Initial				*/
/*						제조지시번호 생성일, cabinet주문번호					*/
/*  1.3    2023-05-23   ITSR71672               UNGJ                            */   
/*                       date_store의 내용을  date_inspect으로 변경 반영  요구  */ 
/********************************************************************************/

--주문생성과 입고는 프로그램에서 호출하면됨.
CREATE PROCEDURE [dbo].[SP_MES_005_1]
	@Date_Flag       char(1),         -- 'P': 생산계획일, 'M': 제조착수일(생산일)
	@From_date       char(8),
	@To_date         char(8),
	@State_Flag      char(1),         -- 'A' : ALL, 'M' : 제조 지시전, 'Z': 불출대기 전
	@Rout_Comp_Flag  char(1),         -- 'A' : ALL, 'Y' : 공정완료, 'N': 공정미완료
	@Sort_Flag       char(1),         -- '1' : ITEM_NO + DUE_DATE + 제번 , '2' : DUE_DATE + ITEM_NO + 제번
	@Date_Start      char(8),	      -- 제조 착수일.
	@Item_no         varchar(15)=''	  -- 대상 품목번호.
as
begin
/*
--grant exec on SP_MES_005_1 to applications
	declare	@status		char(01),
			@out_msg	varchar(100)

	select @status='0',@out_msg='OK'

	SP_MES_005_1 'M', '20200115', '20200415', 'A', 'Y','1', ''      -- 빠르게 조회 됨.
	SP_MES_005_1 'P', '20200115', '20200415', 'A', 'N','1', ''      -- 빠르게 조회 됨.
	SP_MES_005_1 'P', '20200115', '20200115', 'Z', '1', '' ,''      -- 늦게 조회 됨. --15초  ==> 빠름
	SP_MES_005_1 'P', '20200115', '20200115', 'A', '1', '' ,''      -- 늦게 조회 됨. --21초  ==> 빠름
	SP_MES_005_1 'M', '20200115', '20200115', 'M', '1', '' ,''      -- 빠르게 조회 됨. ==> 빠름
	SP_MES_005_1 'M', '20200115', '20200115', 'Z', '1', '' ,''      -- 늦게 조회 됨. --15초 ==> 빠름
	SP_MES_005_1 'M', '20200115', '20200115', 'A', '1', '' ,''      -- 늦게 조회 됨. --21초 ==> 빠름
*/	

	CREATE TABLE #AA
	(ao_no            char(8),
	 ITEM_NO          varchar(15),
	 eng_desc         varchar(30), 
	 cont_qty         real,
	 PROJECT_NO       char(11),
	 MFG_NO		      char(3),	
	 date_start       smalldatetime,
	 PART		      char(2),
	 part_seq	      char(4),
	 due_date	      smalldatetime,
	 date_regen       smalldatetime,
	 concern_order_no char(8),
	 ze01_exists	  char(1),
	 matl_out_date	  datetime,
	 date_store		  datetime)

	if @Date_Flag = 'P'    -- 생산계획일로 조회
	BEGIN
		if @State_Flag = 'M'   -- 제조지시 전 데이터
		begin
			insert into #AA
			select	ao_no,
					ITEM_NO= rtrim(ltrim(a.ITEM_NO)),
					eng_desc=(select c.eng_desc from el_cd..t_cx_060 c with (nolock) where c.item_no = a.item_no),
					cont_qty,
					a.PROJECT_NO,
					a.MFG_NO,
					date_start = null,
					a.PART,
					a.part_seq,
					a.due_date,
					date_regen=NULL,
					concern_order_no='',
					ze01_exists='N',
					matl_out_date=null,
					date_store=null
			from el_cd..T_CA_011 a--, T_MYO_01 b
			where a.due_date between @From_date and @To_date
			and a.date_ao is null
			and (a.ao_no is NULL or a.ao_no < '0')
			and a.order_select = 'M'
			and a.project_no like '20__D__M%'
			and a.mfg_no like 'D%'
			and a.cont_qty > 0  --jjg
			--and @Rout_Comp_Flag in ('A','N')
			--and b.order_no = a.ao_no
			--and b.run_status='1'
		end

		else if @State_Flag = 'Z'  -- 불출대기 전 데이터
		begin
			insert into #AA
			select	a.ao_no,
					ITEM_NO= rtrim(ltrim(a.ITEM_NO)),
					eng_desc=(select c.eng_desc from el_cd..t_cx_060 c with (nolock) where c.item_no = a.item_no),
					a.cont_qty,
					a.PROJECT_NO,
					a.MFG_NO,
					b.date_start,
					a.PART,
					a.part_seq,
					a.due_date,
					b.date_regen,
					b.concern_order_no,
					ze01_exists='N',
					matl_out_date=b.date_out,
					date_store=  B.date_inspect                                                              --20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			from el_cd..T_CA_011 a with (index=ix_ca_011_2), T_MYO_01 b
			where a.product_code > '0'
			and a.due_date between @From_date and @To_date
			and a.project_no like '20%'
			and a.project_no like '20__D__M%'
			and a.mfg_no like 'D%'
			and a.date_ao is not null
			and a.ao_no > '0'
			and a.order_select = 'M'
			and b.order_no = a.ao_no
--			and b.run_status='1'
			and b.run_status in ('0','1')
			and a.cont_qty > 0  --jjg
			--and @Rout_Comp_Flag in ('A','N')
		end
		else if @State_Flag = 'A'   -- 전체 데이터
		begin
			insert into #AA
			select	a.ao_no,
					ITEM_NO= rtrim(ltrim(a.ITEM_NO)),
					eng_desc=(select c.eng_desc from el_cd..t_cx_060 c with (nolock) where c.item_no = a.item_no),
					a.cont_qty,
					a.PROJECT_NO,
					a.MFG_NO,
					b.date_start,
					a.PART,
					a.part_seq,
					a.due_date,
					b.date_regen,
					b.concern_order_no,
					ze01_exists=(case when b.out_create_date is not null then 'Y' else 'N' end),
					matl_out_date= b.date_out,
					date_store= B.date_inspect                                                                    --20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			from el_cd..T_CA_011 a  with (index=ix_ca_011_2) left outer join t_myo_01 b on b.order_no = a.ao_no 																						
			where a.product_code > '0'
			and a.due_date between @From_date and @To_date
			--and a.date_ao is null
			--and a.ao_no < '0'
			and a.order_select = 'M'
			and a.project_no like '20__D__M%'
			and a.mfg_no like 'D%'
			and a.cont_qty > 0  --jjg
			and (@Rout_Comp_Flag = 'A' or 
				 @Rout_Comp_Flag = 'N' and  b.date_inspect is null or 
				 @Rout_Comp_Flag = 'Y' and  b.date_inspect is not null )

			--20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			--and (@Rout_Comp_Flag = 'A' or 
			--	 @Rout_Comp_Flag = 'N' and  b.date_store is null or 
			--	 @Rout_Comp_Flag = 'Y' and  b.date_store is not null )
		end
	end
	else if @Date_Flag = 'M'    -- 제조착수일로 조회
	BEGIN
		if @State_Flag = 'Z'  -- 불출대기 전 데이터
		begin
			insert into #AA
			select	a.ao_no,
					ITEM_NO= rtrim(ltrim(a.ITEM_NO)),
					eng_desc=(select c.eng_desc from el_cd..t_cx_060 c with (nolock) where c.item_no = a.item_no),
					a.cont_qty,
					a.PROJECT_NO,
					a.MFG_NO,
					b.date_start,
					a.PART,
					a.part_seq,
					a.due_date,
					b.date_regen,
					b.concern_order_no,
					ze01_exists='N',
					matl_out_date= b.date_out,
					date_store= B.date_inspect                                                                --20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			from el_cd..T_CA_011 a, T_MYO_01 b with (index=IX_T_MYO_01_2)
			where b.date_start between @From_date and @To_date
			--and b.run_status='1'
			and b.run_status in ('0','1')
			--and (@Rout_Comp_Flag = 'A' or 
			--	 @Rout_Comp_Flag = 'N' and  b.date_store is null or 
			--	 @Rout_Comp_Flag = 'Y' and  b.date_store is not null )
			and a.project_no = b.project_no
			and a.mfg_no = b.mfg_no
			and a.part = b.part
			and a.part_seq = b.part_seq
			and a.ao_no = b.order_no 
			and a.date_ao is not null
			and a.ao_no > '0'
			and a.cont_qty > 0  --jjg
--			and a.order_select = 'M'
--			and a.project_no like '20__D__M%'
--			and a.mfg_no like 'D%'
		end
		else if @State_Flag = 'A'  -- 전체 데이터
		begin
			insert into #AA
			select	a.ao_no,
					ITEM_NO= rtrim(ltrim(a.ITEM_NO)),
					eng_desc=(select c.eng_desc from el_cd..t_cx_060 c with (nolock) where c.item_no = a.item_no),
					a.cont_qty,
					a.PROJECT_NO,
					a.MFG_NO,
					b.date_start,
					a.PART,
					a.part_seq,
					a.due_date,
					b.date_regen,
					b.concern_order_no,
					ze01_exists=(case when b.out_create_date is not null then 'Y' else 'N' end),
					matl_out_date=b.date_out,
					date_store= B.date_inspect                                                                           --20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			from t_myo_01 b with (index=IX_T_MYO_01_2) inner join el_cd..T_CA_011 a on a.project_no = b.project_no
																						and a.mfg_no = b.mfg_no
																						and a.part = b.part
																						and a.part_seq = b.part_seq
																						and a.ao_no = b.order_no 
																						and a.cont_qty > 0  --jjg
			where b.date_start between @From_date and @To_date
			and (@Rout_Comp_Flag = 'A' or 
				 @Rout_Comp_Flag = 'N' and  b.date_inspect is null or 
				 @Rout_Comp_Flag = 'Y' and  b.date_inspect is not null )
			--20230523일  b.date_store 을  B.date_inspect으로 변경 요구 
			--and (@Rout_Comp_Flag = 'A' or 
			--	 @Rout_Comp_Flag = 'N' and  b.date_store is null or 
			--	 @Rout_Comp_Flag = 'Y' and  b.date_store is not null )


			--and b.run_status in ('1','2')
			--and a.project_no like '20__D__M%'
			--and a.mfg_no like 'D%'
			--and a.order_select = 'M'
			--and a.ao_no = b.order_no 
			--and a.date_ao is null
			--and a.ao_no < '0'
		end
	end
		
	IF @Sort_Flag = '1'
		select *
		from #AA
		where (@item_no < '0' or item_no = @item_no)	
		order by ITEM_NO, DUE_DATE, PROJECT_NO, MFG_NO, PART, part_seq
	else
		select *
		from #AA
		where (@item_no < '0' or item_no = @item_no)	
		order by DUE_DATE, ITEM_NO, PROJECT_NO, MFG_NO, PART, part_seq
end;

/********************************************************************************/
/*  SP NAME          : SP_MES_005_2												*/
/*  DESCRIPTION      : 제조 생산 계획 - 제조지시 생성							*/
/*  RELATIVE_FORM    : mes_005													*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_MES_005_2]
	@PROJECT_NO  char(11),
	@MFG_NO		char(3),	
	@PART		char(2),
	@part_seq	char(4),
	@date_start char(8),
	@user_id	varchar(10)
AS
begin
/* 
--grant exec on SP_MES_005_2 to applications
	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_MES_005_2 ....

select @status,@out_msg

-- exec MRP.DBO.SP_MES_005_2  '2020D  M001' ,'D01' ,'W1' ,'CAB0' ,'20200302'
*/

	declare	@status		char(01),
			@out_msg	varchar(50) 

	select @status='0', @out_msg='OK'

	declare	@o_gaijung		varchar(04),
			@curr_date		smalldatetime,
			@curr_year		char(04),
			@next_year		char(04)

	select @curr_date = convert(char(08),getdate(),112)
	select @curr_year = left(convert(char(08),getdate(),112),4)
	select @next_year = left(convert(char(08),dateadd(year,1,getdate()),112),4)

	if @date_start < @curr_date 
	begin
		select status= '1', out_msg='제조착수일이 현재일 보다 이전입니다.'
		return
	end

	select	@o_gaijung='SPSS'

	declare	@curr_fact_gubun	char(03),
			@next_fact_gubun	char(03)

	select @curr_fact_gubun=left(master.dbo.fGetCodeDesc('Z28', @o_gaijung+@curr_year),3)
	select @next_fact_gubun=left(master.dbo.fGetCodeDesc('Z28', @o_gaijung+@next_year),3)




	select	project_no,
			mfg_no,
			part,
			part_seq,
			item_no,
			cont_qty,
			due_date=(case when @curr_date > due_date then @curr_date else due_date end),
			order_select,
			ship_flag = (case when treat_method = 'D' and cause_code = '@@' or ship_flag <> 'Y' then 'N' else 'Y' end),
			week='      ',
			a.market_flag,
			fact_gubun=convert(varchar(3),'')
	into #GISFT2F
	from el_cd..T_CA_011 a with (index=ix_ca_011_3 nolock)
	where PROJECT_NO = @PROJECT_NO
	and MFG_NO = @MFG_NO
	and PART = @PART
	and part_seq = @part_seq
	and date_ao is null
	and gaijung=@o_gaijung
	and cont_qty > +0
	and order_select in ('M')  
	and out_factory_flag not in ('K','D','A')
	and confirm_flag in ('Y','A')
	and not (treat_method = 'D' and cause_code <> '@@')

	if not exists (	select	'Y'
					from #GISFT2F )
	begin
		select status= '1', out_msg='제조지시 생성 대상이 아닙니다'
		return
	end

	if not exists (	select	'Y'
					from #GISFT2F A, el_cd..t_cx_060 b, el_cd..t_cx_630 c
					where b.item_no = a.item_no
					and c.rout_type = b.rout_type  )
	begin
		select status= '2', out_msg='공정 순서가 존재하지 않습니다.'
		return
	end

	update a set week=master.dbo.fGetWorkWeek_CX030(@date_start)
	from #GISFT2F a

	update a set fact_gubun=(case when left(week,4) > @curr_year then @next_fact_gubun else @curr_fact_gubun end)
	from #GISFT2F a

	CREATE TABLE #T_MYO_01_Regen
	(	order_no varchar(8) NOT NULL,
		item_no varchar(15) NOT NULL,
		due_date smalldatetime NULL,
		date_start smalldatetime NULL,
		qty_ao real NOT NULL,
		rout_type varchar(5) NULL,
		wc_code varchar(6) NULL,
		next_store varchar(6) NOT NULL,
		project_no varchar(11) NULL,
		mfg_no varchar(3) NULL,
		part varchar(2) NULL,
		part_seq varchar(4) NULL,
		ship_flag char(1) NOT NULL,
		market_flag char(1) NOT NULL )


	declare	@code		varchar(10),		
			@code_output	varchar(20),		
			@qty		real,
			@item_no	varchar(15),
			@week		varchar(06),
			@rout_type	varchar(05),
			@wc_code	varchar(06),
			@due_date	smalldatetime,
			@ship_flag	char(01),
			@fact_gubun	char(03),
			@market_flag	char(01)

	select 	@item_no=item_no,
			@due_date=due_date,	
			@week=week,
			@fact_gubun=fact_gubun,
			@ship_flag=ship_flag,
			@qty=cont_qty,
			@market_flag=market_flag
	from #GISFT2F a

	select @code=@fact_gubun+right(@week,2)

	exec sp_numbering_output 'A06',@code,@code_output output

	IF LEN(rtrim(@code_output)) <> 8
	begin
		select @status='3', @out_msg='제조지시 채번 Error'
	end
	else 
	begin
		insert into #T_MYO_01_Regen
		select 	order_no=@code_output
			,item_no=@item_no
			,due_date=@due_date
			,date_start=@date_start
			,qty_ao=@qty
			,rout_type=x.rout_type
			,wc_code=x.wc_code
			,next_store=(case when @ship_flag='Y' then 'PW' else 'MM' end)+@o_gaijung
			,project_no=@project_no
			,mfg_no=@mfg_no
			,part=@part
			,part_seq=@part_seq
			,ship_flag=@ship_flag
			,market_flag=@market_flag
		from EL_CD..T_CX_060 x
		where item_no=@item_no

	--** 수불대장에 제조지시일자 Setting **
	
		update b set date_ao=@curr_date,
						ao_no = a.order_no,
						concern_order_no=a.order_no,
						confirm_flag='A',
						run_date=getdate(),
						upd_date=getdate()
		from #T_MYO_01_Regen a,EL_CD..T_CA_011 b
		where a.ship_flag = 'Y'
		and b.project_no=a.project_no
		and b.mfg_no=a.mfg_no
		and b.part=a.part
		and b.part_seq=a.part_seq

	--** 제조발주 생성 **

		insert into T_MYO_01 (order_no, item_no, gaijung,   run_status, due_date,	date_regen, date_start, date_start_act, date_store, date_out,
							  date_chg,	date_ao, qty_ao,    qty_input,  qty_finish, qty_rej,	qty_rework, qty_cancel,	    rout_type,  plan_status,
							  ao_need,	wc_code, rwk_ao_no,	next_store,	project_no,	mfg_no,		part,		part_seq,		ship_flag,	market_flag, 
							  last_ot_no, box_no, divide_seq, concern_order_no, place, update_user, create_pgm, date_gecb_update, date_inspect, to_project_confirm, to_project_confirm_id  )
		select 	order_no=a.order_no
			,item_no=a.item_no
			,gaijung=@o_gaijung
			,run_status='0'
			,due_date=a.due_date
			,date_regen=getdate()
			,date_start=a.date_start
			,date_start_act=null
			,date_store=null
			,date_out=null
			,date_chg=getdate()
			,date_ao=getdate()
			,qty_ao=a.qty_ao
			,qty_input=0
			,qty_finish=0
			,qty_rej=0
			,qty_rework=0
			,qty_cancel=0
			,rout_type=a.rout_type
			,plan_status=''
			,ao_need=''
			,wc_code=a.wc_code
			,rwk_order_no=''
			,next_store=(case when @ship_flag='Y' then 'PW' else 'MM' end)+@o_gaijung
			,project_no=a.project_no
			,mfg_no=a.mfg_no
			,part=a.part
			,part_seq=a.part_seq
			,ship_flag=a.ship_flag
			,market_flag=a.market_flag
			,last_ot_no=0
			,box_no= SUBSTRING(a.part_seq,1,1) + substring(a.part, 2,1)  --a.part + left(a.part_seq,2)
			,divide_seq= ASCII(SUBSTRING(a.part_seq,3,1)) - 64  --a.part + left(a.part_seq,2)
--			,box_no= SUBSTRING(a.part,2,1) + substring(a.part_seq, 1,3)  --a.part + left(a.part_seq,2)
			,concern_order_no=''
			,place = 'S'
			,@user_id -- @user_id
			,'Online'
			, NULL
			, NULL
			,''
			,''
		from #T_MYO_01_Regen a

		--if @status = '0'
		--begin
		--	exec SP_Common_Rounting_EXPL	@code_output,	@status output, @out_msg	output
		----	select status= @status, out_msg=@out_msg
		--end
	end	
	if @status = '0'
	begin
		select status= @status, out_msg=@out_msg, order_no=	@code_output
	end
	else
	begin
		select status= @status, out_msg=@out_msg
	end
	
end;

/********************************************************************************/
/*  SP NAME          : SP_MES_005_3												*/
/*  DESCRIPTION      : 제조 생산 계획-착수일 저장								*/
/*  RELATIVE_FORM    : mes_005													*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_MES_005_3]
	@order_no char(8),
	@date_start char(8),
	@updater varchar(10)=''
	
as
begin
--grant exec on SP_MES_005_3 to applications
-- SP_MES_005_3 

	declare	@status		char(01),
			@out_msg	varchar(100)

	select @status='0',@out_msg='OK'
	 
	IF Exists (select 'Y' 
				from T_MYO_01 
				where order_no = @order_no 
				and date_out is not null)
	begin
		select @status='1',@out_msg='이미 출고된 제조지시입니다.'
	end
	else
	begin

		insert into T_MYO_01_History
		select order_no,
		item_no,
		gaijung,
		run_status,
		due_date,
		date_regen,
		date_start,
		date_start_act,
		date_store,
		date_out,
		date_chg,
		date_ao,
		qty_ao,
		qty_input,
		qty_finish,
		qty_rej,
		qty_rework,
		qty_cancel,
		rout_type,
		plan_status,
		ao_need,
		wc_code,
		rwk_ao_no,
		next_store,
		project_no,
		mfg_no,
		part,
		part_seq,
		ship_flag,
		market_flag,
		last_ot_no,
		box_no,
		divide_seq,
		concern_order_no,
		print_flag,
		place,
		gecb_serial,
		out_create_date,
		print_date,
		place_move_date,
		to_project_no,
		to_mfg_no,
		to_part,
		to_part_seq,
		project_move_date,
		to_project_match_id,
		to_project_match_date,
		place_move_expect_no,
		qrm_read_center,
		qrm_read_person,
		qrm_read_date,
		qrm_read_confirm,
		place_move_receiver,
		date_bundle,
		bundle_person,
		to_box_no,
		to_divide_seq,
		update_user,
		create_pgm,
		date_gecb_update,
		date_inspect,
		to_project_confirm,
		to_project_confirm_id,
		 'B', getdate(), @updater  -- 'B' : Before, 'A' : After
		from T_MYO_01 a
		where order_no = @order_no 

		if (@date_start = '20501231') 
		begin
			if not exists (select *
							from t_mze_01
							where order_no = @order_no
							and qty > 0  )
			begin
				update a set date_start = @date_start, date_chg=getdate(), run_status = 'Z'
				from T_MYO_01 a
				where order_no = @order_no 
			end
			else
			begin
				select @status='2', @out_msg='삭제불가. 불출대기 수량 존재'
				select status=@status,out_msg=@out_msg
				return
			end
		end
		else
		begin
			update a set date_start = @date_start, date_chg=getdate()
			from T_MYO_01 a
			where order_no = @order_no 
		end

/*
		update a set date_start = @date_start, date_chg=getdate()
		from T_MYO_01 a
		where order_no = @order_no 
*/

		insert into T_MYO_01_History
		select order_no,
		item_no,
		gaijung,
		run_status,
		due_date,
		date_regen,
		date_start,
		date_start_act,
		date_store,
		date_out,
		date_chg,
		date_ao,
		qty_ao,
		qty_input,
		qty_finish,
		qty_rej,
		qty_rework,
		qty_cancel,
		rout_type,
		plan_status,
		ao_need,
		wc_code,
		rwk_ao_no,
		next_store,
		project_no,
		mfg_no,
		part,
		part_seq,
		ship_flag,
		market_flag,
		last_ot_no,
		box_no,
		divide_seq,
		concern_order_no,
		print_flag,
		place,
		gecb_serial,
		out_create_date,
		print_date,
		place_move_date,
		to_project_no,
		to_mfg_no,
		to_part,
		to_part_seq,
		project_move_date,
		to_project_match_id,
		to_project_match_date,
		place_move_expect_no,
		qrm_read_center,
		qrm_read_person,
		qrm_read_date,
		qrm_read_confirm,
		place_move_receiver,
		date_bundle,
		bundle_person,
		to_box_no,
		to_divide_seq,
		update_user,
		create_pgm,
		date_gecb_update,
		date_inspect,
		to_project_confirm,
		to_project_confirm_id, 
		'A', getdate(), @updater  -- ' 'B' : Before, 'A' : After
		from T_MYO_01 a
		where order_no = @order_no 

		update a set date_start = @date_start --, date_chg=getdate()
		from t_mze_01 a
		where order_no = @order_no 

	END
		
	select status=@status,out_msg=@out_msg

	/* T_MYO_01 변경시 T_MYO_01_History 도 변경해야 함.
	--T_MYO_01_History 생성
	before_after char(10) NULL,
	update_date datetime NULL,
	update_user varchar(10) NULL
	*/

end;

/*************************************************************************************************************/
/*  SP NAME      : SP_MES_019                                                                                                                                                    */
/*  DISCRIPTION  : 생산 완료 제품 재고 조회                                                                                                                            */ 
/*                                                                                                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                                                                                   */ 
/*  DATE        REQUEST #       S.E NAME    DESCRIPTION                                                                                    */
/*  --------------------------------------------------------                                                                            */
/* 2020/04/20   MES Project     lgjjg       Initialize                                                                                              */
/**************************************************************************************************************/
CREATE procedure [dbo].[SP_MES_019_1]
	@flag	char(1),  -- S:재고조회, P:생산조회, M:매칭조회, A:생산,매칭조회
	@from_date	varchar(8)='',
	@to_date	varchar(8)='',
	@item_no	varchar(15)='',
	@Gaijung	char(4)=''

AS
set nocount on
-- grant exec on SP_MES_019_1 to applications
-- exec SP_MES_019_1  'A', '20200201' ,'20200427' ,'' ,''
-- exec SP_MES_019_1  'P', '20200402' ,'20200403' ,'' ,''
-- exec SP_MES_019_1  'M', '20200402' ,'20200403' ,'' ,''
-- exec SP_MES_019_1  'A', '20200402' ,'20200403' ,'' ,''
-- exec SP_MES_019_1  'A', '20200402' ,'20200403' ,'KAA21310ACB1' ,''
-- exec SP_MES_019_1  'A', '20200402' ,'20200403' ,'KAA21310ACB2' ,''
-- exec SP_MES_019_1  'A', '20200402' ,'20200403' ,'HBA21305S5' ,''
-- exec SP_MES_019_1  'S', '20200402' ,'20200421' ,'KAA21310ACB1' ,''
-- exec SP_MES_019_1  'S', '20200402' ,'20200403' ,'KAA21310ACB2' ,''
-- exec SP_MES_019_1  'S', '20200402' ,'20200403' ,'HBA21305S5' ,''
/*
SELECT date_inspect, project_move_date, * 
-- update a set project_move_date = '2020-04-03 00:00:00.000'
FROM T_MYO_01 A
WHERE order_no like 'A2014%'

WHERE order_no = 'A2014022'

item_no	sh_no	line_no	citem_no
KAA21310ACB1	1	1	HBA21305S5


*/
begin

/*
select *
from el_cd..t_cx_069
*/
-- exec SP_MES_019_1  'S'


		if (@item_no > '0' and not exists ( select 'y' from el_cd..t_cx_069 with (nolock) where item_no = @item_no))
		begin
			select status = '1', out_msg = '생산 ITEM 이 아닙니다'
			return
		end

		create table #aa
		( item_no varchar(15),
		  songdo real,
		  asan real,
		  nambu real,
		  sinsungsa real)

		insert into #aa
		select	a.item_no, 
				--eng_desc=(select f.eng_desc from el_cd..t_cx_060 f where f.item_no = a.item_no),
				songdo = isnull(sum((case when gaijung=a.gaijung and place='S' and a.run_status in ('6','7','8') and a.project_move_date is NULL then isnull(qty_ao,0) else 0 end)),0), 
				asan = isnull(sum((case when gaijung=a.gaijung and place='A' and a.run_status in ('6','7','8') and a.project_move_date is NULL then isnull(qty_ao,0) else 0 end)),0), 
				nambu = isnull(sum((case when gaijung=a.gaijung and place='N'  and a.run_status in ('6','7','8') and a.project_move_date is NULL then isnull(qty_ao,0) else 0 end)),0), 
				sinsungsa =  isnull((select sum(isnull(b.req_qty,0)) from el_cd..t_ep_010 b with (nolock) where b.item_no = a.item_no and b.run_status in ('4','5') ),0) --,
				--sinsungsa_complete_Match =  (select sum(isnull(c.req_qty,0)) from el_cd..t_ep_010 c with (nolock) where c.gaijung=a.gaijung and c.item_no = a.item_no and c.run_status in ('6','7') )		
		from mrp..t_myo_01 a with (nolock)
		where a.date_inspect is not null
		and (@item_no < '0' or item_no = @item_no)	
--		and a.gaijung = @Gaijung
		group by a.item_no

		select	a.item_no, --eng_desc=convert(varchar(30),''),
				songdo_Stock_qty= songdo, 
				asan_Stock_qty= asan, 
				nambu_Stock_qty= nambu - sinsungsa,
				sinsungsa_Stock_qty= sinsungsa,
				Stock_qty= songdo + asan + (nambu -sinsungsa) + sinsungsa,
				Prod_qty=0, 
				match_qty = 0
		into #bb
		from #aa a
		--group by item_no
		order by item_no

	if @flag <> 'S'
	begin
		insert into #bb
		select item_no, songdo_Stock_qty=0, asan_Stock_qty=0, nambu_Stock_qty=0, sinsungsa_Stock_qty=0, Stock_qty=0, Prod_qty=sum(isnull(qty_finish,0)), match_qty = sum(0)
		from t_myo_01 a with (nolock)
		where (@flag in ('P','A') and date_inspect between @from_date and @to_date + ' 23:59:59' )
		group by item_no

		insert into #bb
		select item_no, songdo_Stock_qty=0, asan_Stock_qty=0, nambu_Stock_qty=0, Stock_qty=0, sinsungsa_Stock_qty=0, Prod_qty=sum(0), match_qty = sum(isnull(qty_ao,0))
		from t_myo_01 a with (nolock)
		where (@flag in ('M','A') and project_move_date between @from_date and @to_date + ' 23:59:59' )
		group by item_no
	end

	select a.item_no, b.eng_desc, 
			songdo_Stock_qty=sum(isnull(songdo_Stock_qty,0)), 
			asan_Stock_qty=sum(isnull(asan_Stock_qty,0)), 
			nambu_Stock_qty=sum(isnull(nambu_Stock_qty,0)), 
			sinsungsa_Stock_qty=sum(isnull(sinsungsa_Stock_qty,0)), 
			Stock_qty=sum(isnull(Stock_qty,0)), 
			Prod_qty=sum(isnull(Prod_qty,0)), 
			match_qty=sum(isnull(match_qty,0))
	from #bb a, el_cd..t_cx_060 b with (nolock)
	where b.item_no = a.item_no
	group by a.item_no, b.eng_desc
	order by a.item_no

	select status = '0', out_msg = '정상조회 완료'
	--select * from #aa
	--select * from #bb
end;

/********************************************************************************/
/*  SP NAME          : SP_MES_020_1												*/
/*  DESCRIPTION      : 제조 출고 및 반품처리 - 수불대장 체크					*/
/*  RELATIVE_FORM    : mes_005													*/
/*  CREATE_DAY       : 2020년 04월 27일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-04-27	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

create PROCEDURE [dbo].[SP_MES_020_1]
	@PROJECT_NO  char(11),
	@MFG_NO		 char(3),	
	@PART		 char(2),
	@part_seq	 char(4)
AS
begin
/* 
--grant exec on SP_MES_020_1 to applications
-- exec MRP.DBO.SP_MES_020_1  '2020D  M001' ,'D01' ,'W4' ,'AAD0' 
*/


	if exists ( select 'Y'
				from el_cd..t_ca_011 
				where project_no = @project_no
				and mfg_no = @mfg_no
				and part = @part
				and part_seq = @part_seq )
	begin
		select status = '0', msg_out = '수불체크 정상'
	end
	else
	begin
		select status = '1', msg_out = '에러(수불대장 미존재)'
	end

end;

/********************************************************************************/
/*  SP NAME          : SP_MES_022_0                     						*/
/*  DESCRIPTION      : 불출대기 추가 삭제용 제조지시 조회						*/
/*  RELATIVE_FORM    : mes_022          										*/
/*  CREATE_DAY       : 2020년 04월 24일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-04-24	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/
 
create PROCEDURE [dbo].[SP_MES_022_0]
	@from_date	char(08)='',
	@to_date	char(08)='',
	@order_no	varchar(08)
AS

SET NOCOUNT ON
--grant exec on SP_MES_022_0 to applications
/*
--EXEC SP_MES_022_0 '20200303','20200403',''
*/
BEGIN
		select a.order_no, a.item_no, b.eng_desc, date_start=convert(varchar(8), a.date_start,112), a.qty_ao --, jp_no
		from T_MYO_01 a with (nolock), el_cd.dbo.t_cx_060 b with (nolock)
		where ( @order_no > '0' and a.order_no = @order_no or
				@order_no < '0' and a.date_start between @from_date and @to_date + ' 23:59:00' )
		and a.run_status = '2'
		and (a.concern_order_no is NULL or a.concern_order_no < '0')
		and b.item_no=a.item_no
		order by a.date_start, a.order_no

END;

/********************************************************************************/
/*  SP NAME          : SP_MES_022_1                     						*/
/*  DESCRIPTION      : 불출대기 추가 삭제            							*/
/*  RELATIVE_FORM    : mes_022          										*/
/*  CREATE_DAY       : 2020년 04월 24일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-04-24	오티스 MES 프로젝트		LGJJG		Initial				*/
/*  1.1    2020-04-24	오티스 MES 프로젝트		LGNCJ		OUTPUT변수 변경		*/
/********************************************************************************/
create PROCEDURE [dbo].[SP_MES_022_1]
	@flag		char(01),  -- 'S':조회, 'I':추가, 'D':삭제 
	@order_no	varchar(08),
	@jp_no		varchar(13)='',
	@item_no	varchar(15)='',
	@qty		real=0,
	@user_id	varchar(10)
	--@status		char(01)		output,
	--@msg_out	varchar(100)	output
AS

SET NOCOUNT ON
--grant exec on SP_MES_022_1 to applications
/*
declare	@status		char(01),
		@out_msg	varchar(50) 

EXEC SP_MES_022_1 'I','A2014025', '', 'HAA26800AJ1', 0, 'T00494'
EXEC SP_MES_022_1 'S','A2014025', 'XA20140250210', '', 0, 'T00494'
exec  MRP.DBO.SP_MES_022_1 'S','A2014023','','',0,'T00494'

EXEC SP_MES_022_1 'I','A2014025', '', 'HAA26800AJ1', 0, 'T00494' 

select @status, @out_msg
*/
BEGIN
	--output 변경

	if not exists (select * from T_MYO_01 where order_no = @order_no)
	begin
		select status='1', msg_out='Error(해당하는 제조지시번호 없음)'
		return
	end

	declare	@last_ot_no		tinyint,
			@run_status		char(01),
			@curr_year		char(04),
			@gaijung		varchar(04),
			@str			varchar(10),
			@leadtime		int,
			@out_use		char(01),
			@date_start		smalldatetime,
			@parent_item_no	varchar(15),
			@wc_code		varchar(06),
			@due_date		smalldatetime,
			@concern_order_no char(8)
			
			  --,
--			@base_flag		char(01)		/** 1:제조시작일자  2:제조납기기준 ***/

	select 	@last_ot_no=last_ot_no, @run_status=run_status, @gaijung=gaijung,        @out_use=ao_need,
			@date_start=date_start, @due_date=due_date,     @parent_item_no=item_no, @wc_code=wc_code, @concern_order_no=concern_order_no
	from T_MYO_01
	where order_no = @order_no

	if (@run_status <> '2' or (@concern_order_no is not NULL and @concern_order_no > '0'))
	begin
		select status='2', msg_out='Error(주문매칭전 불출대기 상태가 아님)'
		return
	end

	IF @flag = 'S'
	begin		
		select	jp_no, item_no, order_no, order_select, project_no,	mfg_no,	part, part_seq,	parent_item_no, vendor, wc_code, gaijung,
				store, skp,	out_use, shortage_mark,	last_jp_seq, qty, qty_out, date_start, date_due, date_out, unit_qty, creator,
				date_entry,	status,	create_pgm,	date_update, update_user
		from	t_mze_01 
		where order_no = @order_no
	end


	IF @flag = 'D'
	begin		

		if not exists (select * from T_MZE_01 where order_no = @order_no and jp_no = @jp_no)
		begin
			--select @order_no, @jp_no
			select status='3', msg_out='Error(해당하는 불출대기 없음)'
			return
		end

		if exists (select * from T_MZE_01 where order_no = @order_no and jp_no = @jp_no and qty =0)
		begin
			--select @order_no, @jp_no
			select status='4', msg_out='Error(이미 삭제된 불출대기 전표입니다)'
			return
		end

		update a set qty = 0, date_update = getdate(), update_user = @user_id
		from T_MZE_01 a
		where order_no = @order_no
		and jp_no = @jp_no

		select status='0', msg_out='OK(불출대기 삭제 완료)'
		return		
	end

	IF @flag = 'I'
	begin	

		if @qty < 1 
		begin
			select status='5', msg_out='Error(수량이 0 입니다.)'
			return
		end

		if not exists (select 'Y'
						from EL_CD..T_CX_160 a, el_cd..t_cx_060 b
						where a.item_no = @item_no
						and b.item_no = a.item_no)
		begin
			select status='6', msg_out='Error(적치대용 ITEM이 아닙니다.)'
			return
		end

		insert into T_MZE_01
		select	jp_no= 'X'+ @order_no + ( select master.dbo.fMakeStrSeq(max(substring(b.JP_NO,10,3)) + 1, 3) from t_mze_01 b where b.order_no = @order_no) + '0',
				item_no=@item_no,  -- 입력 필수 항목(1/2)
				order_no=@order_no,
				order_select=(select b.order_select from el_cd..t_cx_060 b where b.item_no = @item_no),
				project_no=a.project_no,
				mfg_no=a.mfg_no,
				part=a.part,
				part_seq=a.part_seq,
				parent_item_no=a.item_no,
				vendor='',
				wc_code=a.wc_code,
				gaijung=a.gaijung,
				store='WH' + a.gaijung,
				skp='',
				out_use='',
				shortage_mark='',
				last_jp_seq=0,
				qty=@qty,   -- 입력 필수 항목(2/2)
				qty_out=0,
				date_start=a.date_start,
				date_due=a.due_date,
				date_out=NULL,  --dateadd(d,0-@leadtime,(case when @base_flag='1' then @date_start else @due_date end)),
				unit_qty=1,
				creator = @user_id,  
				date_entry = getdate(),
				status = '1',
				create_pgm='T_MES_022',
				date_update = getdate(),
				update_user = @user_id
		from T_MYO_01 a
		where order_no = @order_no


		update a set last_ot_no=last_ot_no + 1
		from T_MYO_01 a
		where order_no = @order_no

		select status='0', msg_out='OK(불출대기 생성)' --, last_ot_no = null

	END

END;

/*********************************************************************************
 *
 * PROCEDURE        : SP_MES_027_1
 *
 * DISCRIPTION      : 제조지시 캐비닛주문 및 검사정보 관리
 *
 * RELATIVE_FORM    : MES_027(제조지시 캐비닛주문 및 검사정보 관리)
 *
 * CREATE_SE        : 송승훈
 *
 * CREATE_DAY       : 2021년 12월 16일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2021-12-16	ITSR35538				lgjjg		제조지시 캐비닛주문 및 검사정보 관리
 *********************************************************************************/
  
create PROCEDURE [dbo].[SP_MES_027_1]
	@flag				char(01),
	@order_no			varchar(8)='',
	@Cabinet_order_no	varchar(8)='',
	@concern_order_no	varchar(8)='',
	@gecb_serial		varchar(50)='',
	@ero_spb			varchar(50)='',
	@power_board		varchar(50)='',
	@lru_drive			varchar(50)='',
	@igbt_box			varchar(50)='',
	@ei_panel			varchar(50)='',
	@updater			varchar(10)=''

as
-- exec SP_MES_027_1 'S','AEA13C133'
-- grant exec on SP_MES_027_1 to applications

	--declare @flag char(01)
	--declare	@order_no varchar(8)

	--select @flag = 'S'
	--select @order_no = 'A2021014'

	select @order_no = ltrim(rtrim(@order_no))

	if (@order_no < '0' and @Cabinet_order_no < '0') 
	begin
		return
	end


	if (@flag = 'S' and (len(@order_no) < 7 and len(@Cabinet_order_no) < 8)) or (@flag in ( 'M','A') and len(@order_no) < 8)
	begin
		return
	end

/*
	SELECT *
	from	t_myo_01 
	where order_no like @order_no + '%'
*/


	if @flag = 'S'
	BEGIN


		select	a.order_no,
				item_no=ltrim(rtrim(a.item_no)),
				eng_desc=(select ltrim(rtrim(b.eng_desc)) from el_cd..t_cx_060 b where b.item_no = a.item_no),
				a.gaijung,
				run_status=isnull((select c.code_desc from el_cd.dbo.t_ex_000 c where c.code_select='M02' and c.code=a.run_status),''),  
				due_date=convert(varchar(10),a.due_date,121),
				a.qty_ao,
				a.rout_type,
				a.project_no,
				a.mfg_no,
				a.part,
				a.part_seq,
				concern_order_no=ltrim(rtrim(a.concern_order_no)),
				gecb_serial=ltrim(rtrim(a.gecb_serial)),
				ero_spb=ltrim(rtrim(a.ero_spb)),
				power_board=ltrim(rtrim(a.power_board)),
				lru_drive=ltrim(rtrim(a.lru_drive)),
				igbt_box=ltrim(rtrim(a.igbt_box)),
				ei_panel=ltrim(rtrim(a.ei_panel))
		from	t_myo_01 a with (nolock)
		where (@order_no < '0' or order_no like @order_no + '%' )
		and (@Cabinet_order_no < '0' or concern_order_no = @Cabinet_order_no)


	end
	else if @flag IN ( 'M','A')
	begin
		insert into T_MYO_01_History
		select order_no, item_no, gaijung, run_status, due_date, date_regen, date_start, date_start_act, date_store, date_out, date_chg, date_ao, qty_ao, qty_input, qty_finish, qty_rej, qty_rework,
		qty_cancel, rout_type, plan_status, ao_need, wc_code, rwk_ao_no, next_store, project_no, mfg_no, part, part_seq, ship_flag, market_flag, last_ot_no, box_no, divide_seq, concern_order_no,
		print_flag, place, gecb_serial, out_create_date, print_date, place_move_date, to_project_no, to_mfg_no, to_part, to_part_seq, project_move_date, to_project_match_id, to_project_match_date,
		place_move_expect_no, qrm_read_center, qrm_read_person, qrm_read_date, qrm_read_confirm, place_move_receiver, date_bundle, bundle_person, to_box_no, to_divide_seq, update_user, create_pgm,
		date_gecb_update, date_inspect, to_project_confirm, to_project_confirm_id, 'B', getdate(), @updater  -- 'B' : Before, 'A' : After
		from T_MYO_01 a
		where order_no = @order_no

		update a set concern_order_no=@concern_order_no,
						gecb_serial=@gecb_serial,
						ero_spb=@ero_spb,
						power_board=@power_board,
						lru_drive=@lru_drive,
						igbt_box=@igbt_box,
						ei_panel=@ei_panel
		from	t_myo_01 a
		where order_no = @order_no

		insert into T_MYO_01_History
		select order_no, item_no, gaijung, run_status, due_date, date_regen, date_start, date_start_act, date_store, date_out, date_chg, date_ao, qty_ao, qty_input, qty_finish, qty_rej, qty_rework,
		qty_cancel, rout_type, plan_status, ao_need, wc_code, rwk_ao_no, next_store, project_no, mfg_no, part, part_seq, ship_flag, market_flag, last_ot_no, box_no, divide_seq, concern_order_no,
		print_flag, place, gecb_serial, out_create_date, print_date, place_move_date, to_project_no, to_mfg_no, to_part, to_part_seq, project_move_date, to_project_match_id, to_project_match_date,
		place_move_expect_no, qrm_read_center, qrm_read_person, qrm_read_date, qrm_read_confirm, place_move_receiver, date_bundle, bundle_person, to_box_no, to_divide_seq, update_user, create_pgm,
		date_gecb_update, date_inspect, to_project_confirm, to_project_confirm_id, 'A', getdate(), @updater  -- ' 'B' : Before, 'A' : After
		from T_MYO_01 a
		where order_no = @order_no

	end;

/*********************************************************************************
 *
 * PROCEDURE        : SP_IF_INSP_COMP
 *
 * DISCRIPTION      : 검사 조회
 *
 * RELATIVE_FORM    : I/F (WORKSTATION)
 *
 * CREATE_SE        : 나창주
 *
 * CREATE_DAY       : 2020년 03월 31일
 *
 * MODIFICATION_LOG
 *
 *  VER    DATE         CSR#                    SE NAME		DESCRIPTION
 *  ----   ----------   --------------------    ---------   ---------------
 *  1.0    2020-02-03	오티스 MES 프로젝트		나창주		검사 조회
 *********************************************************************************/
 -- EXEC SP_MES_205_1 '5', '20221101', '20221115'
 CREATE PROCEDURE [dbo].[SP_MES_205_1]
	@Flag char(01),-- 5:공정완료일, 6:검사처리일
	@From_date char(8),
	@To_date char(8)
AS
--grant exec on SP_MES_205_1 to applications
BEGIN
	SET NOCOUNT ON
	if @Flag = '5'
	begin
		SELECT order_no, 
		gecb_serial=isnull(a.gecb_serial,''),
		--(case when isnull(a.gecb_serial,'')='' then 
		--(select substring(pcb,10,12) from [cwdbs03\messys].mes.dbo.PROSECUTOR_OK_TBL b where b.order_no=a.order_no) 
		--else a.gecb_serial end), 
		date_gecb_update
		FROM T_MYO_01 a
		WHERE date_store BETWEEN @From_date AND @To_date + ' 23:59:00'
	end
	else if @Flag = '6'
	begin
		SELECT order_no, 
		gecb_serial,
		date_gecb_update
		-- select gecb_serial,*
		FROM T_MYO_01 a
		WHERE date_inspect BETWEEN @From_date AND @To_date + ' 23:59:00'
	end
END;

/********************************************************************************/
/*  SP NAME          : SP_MES_210_IN_OUT_LIST_UPDATE       						*/
/*  DESCRIPTION      : IN-OUT-LIST 반영(수작업 처리 후 DPS 반영)     			*/
/*  RELATIVE_FORM    : F_MES_210          										*/
/*  CREATE_DAY       : 2020년 08월 25일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-09-16	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/
create PROCEDURE [dbo].[SP_MES_210_IN_OUT_LIST_UPDATE]
	@order_no	varchar(08),
	@user_id	varchar(10)
AS

SET NOCOUNT ON
--grant exec on SP_MES_210_IN_OUT_LIST_UPDATE to applications
/*
SELECT * FROM  in_out_list a
exec MRP.DBO.SP_MES_210_IN_OUT_LIST_UPDATE '0XX000IA','T00494'
select * from T_MES_210_HISTORY
*/
BEGIN

	if not exists (select * from in_out_list where order_no = @order_no and ( (status is NULL OR status <> 'OK') OR (dps_status is NULL OR dps_status <> 'OK')))
	begin
		select status='1', out_msg='Error(상태를 반영할 대상이 아닙니다)'
		return
	end

	if left(@order_no,1) = 'A'
	begin
		select status='2', out_msg='Error(주문번호 양식이 아닙니다.)'
		return
	end

	insert into	T_MES_210_HISTORY
	select 	@order_no, getdate(), @user_id

	update a set status = 'OK', dps_status = 'OK'
	from in_out_list a
	where a.order_no = @order_no
	and in_out_type = 'IN'

	select status='0', out_msg='OK(DPS IN-OUT-LIST OK 반영완료)'

END;

/*************************************************************************************************************/
/*  SP NAME      : SP_MES_220                                                                                                                                                    */
/*  DISCRIPTION  : 자재 재고 현황                                                                                                                            */ 
/*                                                                                                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                                                                                   */ 
/*  DATE        REQUEST #         S.E NAME      DESCRIPTION                                                                                    */
/*  ---------------------------------------------------------------                                                                            */
/* 2020/04/14     MES Project     J.G.Jeon      Initialize                                                                                              */
/**************************************************************************************************************/
CREATE procedure [dbo].[SP_MES_220_1]
	@Gaijung			char(4),
	@plan_post_person	varchar(4),
	@fr_date_start		varchar(8),
	@to_date_start		varchar(8),
	@item_no			varchar(15)='',
	@chk_Bad			char(1)=''

AS
set nocount on

-- grant exec on SP_MES_220_1 to applications
-- exec SP_MES_220_1  'SPSS' ,'JGE' ,'20200402' ,'20200502' ,''
-- exec SP_MES_220_1  'SPSS' ,'' ,'20200402' ,'20200502' ,''  -- 전체
-- exec MRP.dbo.SP_MES_220_1 'SPSS', 'JGEB', '20200704', '20200724', '', 'N'
-- exec MRP.dbo.SP_MES_220_1 'SPSS', 'JGEB', '20200401', '20200531', '', 'N'
-- exec MRP.dbo.SP_MES_220_1 'SPSS', 'JGEB', '20200401', '20200531', '', 'Y'
-- exec MRP.dbo.SP_MES_220_1 'SPSS', 'JGEB', '20200725', '20200814', '', 'Y'
begin
	create table #aa
	( item_no		 varchar(15),
	  va61_qty_stock float,
	  ze01_qty		 float )

	if @plan_post_person < '0'
	begin
		select @plan_post_person = ''
	end

	/*
	if @plan_post_person in ('담당자무')
	begin
		select @plan_post_person = 'ZZZZ'
	end

	select *
	from el_cd..t_mes_230

	*/
	insert into #aa
	select b.item_no, qty_stock, 0
	from mrp..t_mva_061 a with (nolock), el_cd..t_cx_060 b with (nolock)
	where (@item_no <'0' or a.item_no like '%' + @item_no + '%')
	and a.gaijung = @Gaijung
	--and a.order_select in ('D','I')
	and abs(a.qty_stock) > 0.001
	and (@plan_post_person < '0' or 
		(@plan_post_person = 'ZZZZ' and (b.plan_post_person < '0' or b.plan_post_person is null)) or
		 b.plan_post_person like @plan_post_person+'%')
	and b.item_no = a.item_no

	insert into #aa
	select a.item_no, 0, a.qty - a.qty_out
	from mrp..t_mze_01 a with (nolock), el_cd..t_cx_060 b with (nolock)
	where a.status = '1'
	and a.date_start between @fr_date_start and @to_date_start + ' 23:59:59'
	and (@item_no <'0' or a.item_no like '%' + @item_no + '%')
	and a.gaijung = @Gaijung
	and a.qty > 0
	and a.qty > a.qty_out 
	and (@plan_post_person < '0' or 
		(@plan_post_person = 'ZZZZ' and (b.plan_post_person < '0' or b.plan_post_person is null)) or
		 b.plan_post_person like @plan_post_person+'%')
	and b.item_no = a.item_no

	select item_no, va61_qty_stock=sum(va61_qty_stock), ze01_qty=sum(ze01_qty) 
	into #bb
	from #aa
	group by item_no
/*
	select  gaijung=@gaijung,
			plan_post_person=isnull(c.plan_post_person,''), 
			a.item_no,
			eng_desc= c.eng_desc,
			c.order_select,
			va61_qty_stock, 
			bad_qty = isnull((isnull(d.qty_bad,0) - isnull(d.qty_tot_input,0)),0),
			val_qty = va61_qty_stock - ( isnull((isnull(d.qty_bad,0) - isnull(d.qty_tot_input,0)),0) ),
			ze01_qty,
			store_name=isnull(b.store_name,''), 
			safe_stock_qty,
			dps_id=isnull((case when b.zone = 'Z' then 'Z' else b.dps_id end ),'')
	into #cc
	from #bb a inner join el_cd..t_cx_060 c on c.item_no = a.item_no
			   left outer join el_cd..t_cx_160 b on b.item_no = a.item_no
			   left outer join el_cd..t_mes_230 d on d.item_no = a.item_no and d.run_status = '1'	
*/			   

	select  gaijung=@gaijung,
			plan_post_person=isnull(c.plan_post_person,''), 
			a.item_no,
			eng_desc= c.eng_desc,
			c.order_select,
			va61_qty_stock, 
			bad_qty = isnull((select sum(isnull(d.qty_bad,0) - isnull(d.qty_tot_input,0)) from el_cd..t_mes_230 d where d.item_no = a.item_no and d.run_status = '1' ),0),
			val_qty = va61_qty_stock - isnull((select sum(isnull(d.qty_bad,0) - isnull(d.qty_tot_input,0)) from el_cd..t_mes_230 d where d.item_no = a.item_no and d.run_status = '1' ),0),
			ze01_qty,
			store_name=isnull(b.store_name,''), 
			safe_stock_qty,
			dps_id=isnull((case when b.zone = 'Z' then 'Z' else b.dps_id end ),'')
	into #cc
	from #bb a inner join el_cd..t_cx_060 c on c.item_no = a.item_no
			   left outer join el_cd..t_cx_160 b on b.item_no = a.item_no
--			   left outer join el_cd..t_mes_230 d on d.item_no = a.item_no and d.run_status = '1'	
			   
			   		   


	select gaijung,
			plan_post_person, 
			item_no,
			eng_desc,
			order_select,
			va61_qty_stock, 
			bad_qty,
			val_qty,
			ze01_qty,
			store_name, 
			safe_stock_qty,
			dps_id
	from #cc
	where (@chk_Bad = 'N' OR (@chk_Bad = 'Y' and bad_qty > 0)) 
	order by plan_post_person, item_no

end

/*
select qty_bad - qty_tot_input, *
from el_cd..t_mes_230
where run_status = '1'
*/;

/********************************************************************************/
/*  SP NAME          : SP_MES_022_1                     						*/
/*  DESCRIPTION      : 불출대기 추가 삭제            							*/
/*  RELATIVE_FORM    : mes_022          										*/
/*  CREATE_DAY       : 2020년 04월 24일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-04-24	오티스 MES 프로젝트		LGJJG		Initial				*/
/*  1.1    2020-04-24	오티스 MES 프로젝트		LGNCJ		OUTPUT변수 변경		*/
/********************************************************************************/
CREATE PROCEDURE [dbo].[SP_MES_221_1]
	@flag		char(01),  -- 'S':조회, 'B':점등하기, 'O':출고상태만들기
	@order_no	varchar(08),
	@jp_no		varchar(13)='',
	@user_id	varchar(10)

AS

SET NOCOUNT ON
--grant exec on SP_MES_221_1 to applications
/*
declare	@status		char(01),
		@out_msg	varchar(50) 

EXEC SP_MES_221_1 'I','A2014025', '', 'HAA26800AJ1', 0, 'T00494'
EXEC SP_MES_221_1 'S','A2014025', 'XA20140250210', '', 0, 'T00494'
EXEC  MRP.DBO.SP_MES_221_1 'S','A2014023','','',0,'T00494'

EXEC SP_MES_221_1 'I','A2014025', '', 'HAA26800AJ1', 0, 'T00494' 

select @status, @out_msg

exec  MRP.DBO.SP_MES_221_1  'S','A2014023','','T00494'
A2014023

*/
BEGIN

	if not exists (select * from T_MYO_01 where order_no = @order_no)
	begin
		select status='1', msg_out='Error(해당하는 제조지시번호 없음)'
		return
	end

	/*
	declare	@last_ot_no		tinyint,
			@run_status		char(01),
			@curr_year		char(04),
			@gaijung		varchar(04),
			@str			varchar(10),
			@leadtime		int,
			@out_use		char(01),
			@date_start		smalldatetime,
			@parent_item_no	varchar(15),
			@wc_code		varchar(06),
			@due_date		smalldatetime,
			@concern_order_no char(8)
			
	select 	@last_ot_no=last_ot_no, @run_status=run_status, @gaijung=gaijung,        @out_use=ao_need,
			@date_start=date_start, @due_date=due_date,     @parent_item_no=item_no, @wc_code=wc_code, @concern_order_no=concern_order_no
	from T_MYO_01
	where order_no = @order_no
	*/

	/*
	if (@run_status <> '2')
	begin
		select status='2', msg_out='Error(출고 상태가 아닙니다.)'
		return
	end
	*/

	IF @flag = 'S'
	begin		
		select	a.order_no, a.jp_no, a.item_no, 
				dps_id=(case when c.zone = 'Z' then 'Z' 
							 else c.dps_id
							 end ), 
				a.qty, a.qty_out, date_out=convert(varchar(19),a.date_out,121), 
				prod_flag = a.status, dps_flag=b.status,
				prod_status = (case  when a.qty = 0 then '삭제' 
									when a.status = '1' then '미출고' 
									when a.status = '5' then '출고완료' 
									else ''
									end),
				dps_status = (case  when b.status = 'ING' then 'ING(출고중)' 
									when b.status = 'OK' then 'OK(출고완료)' 
									when b.status = 'NO' then 'NO(미출고)' 
									else ''
									end),
				status=(case when a.qty = 0 then '삭제된 불출대기' 
							 when a.status = '5' and b.status = 'OK' then '정상' 
							 when a.status = '5' and b.status = 'ING' then 'DPS 상태를 출고완료로 변경필요' 
							 when a.status = '5' and b.status = 'NO' then 'DPS 상태를 출고완료로 변경필요' 
							 when a.status = '1' and b.status = 'OK' then 'PROD 출고 대상.' 
							 when a.status = '1' and b.status = 'ING' then 'DPS 점등 대상' 
							 when a.status = '1' and b.status = 'NO' then '정상' 
							 else ''
							 end),
				check_flag= (case when b.status = 'ING' then 'FALSE'		
								  when a.status = '5' and b.status = 'NO' then 'FALSE'
								  ELSE 'TRUE'
								  end)
--				a.unit_qty, a.creator,	a.date_entry,	a.status,	a.create_pgm,	a.date_update, a.update_user
		into #aa
		from	mrp..t_mze_01 a, mrp..in_out_list b, el_cd..t_cx_160 c
		where a.order_no = @order_no
		and b.jp_no = a.jp_no
		and c.item_no = a.item_no

		select *
		from #aa a
		order by jp_no

		return
	end

	IF @flag = 'B'
	begin		

		if not exists (select * from T_MZE_01 where order_no = @order_no and jp_no = @jp_no)
		begin
			--select @order_no, @jp_no
			select status='3', msg_out='Error(해당하는 불출대기 없음)'
			return
		end

		if exists (select * from T_MZE_01 where order_no = @order_no and jp_no = @jp_no and qty =0)
		begin
			--select @order_no, @jp_no
			select status='4', msg_out='Error(이미 삭제된 불출대기 전표입니다)'
			return
		end

		insert into	t_mes_221_history
		select 	@flag, @order_no, @jp_no, getdate(), @user_id

		--select A.*
		update a set dps_status = null
		from mrp..in_out_list a
		where a.order_no = @order_no
		and a.jp_no = @jp_no

		select status='0', msg_out='OK(점등 완료)'
		return		
	end

	IF @flag = 'O'
	begin	

		insert into	t_mes_221_history
		select 	@flag, @order_no, @jp_no, getdate(), @user_id

		--select *
		update a set status = 'OK'
		from mrp..in_out_list A --, #AA B
		where order_no = @order_no
		and jp_no = @jp_no


		select status='0', msg_out='OK(출고완료로 변경 완료)' --, last_ot_no = null
		return
	end

END;

/*************************************************************************************************************/
/*  SP NAME      : SP_MES_230                                                                                */
/*  DISCRIPTION  : MES System 모니터링                                                                       */ 
/*                                                                                                           */
/*  >> MODIFICATION LOG <<                                                                                   */ 
/*  DATE        REQUEST #         S.E NAME      DESCRIPTION                                                  */
/*  ---------------------------------------------------------------                                          */
/* 2020/04/27     MES Project     lgjjg         Initialize                                                   */
/**************************************************************************************************************/
CREATE procedure [dbo].[SP_MES_230_1]
	--@Gaijung			char(4),
	--@plan_post_person	varchar(4),
	--@fr_date_start		varchar(8),
	--@to_date_start		varchar(8),
	--@item_no			varchar(15)=''

AS
set nocount on
begin

-- exec SP_MES_230_1
-- grant exec on SP_MES_230_1 to applications
-- exec SP_MES_230_1  'SPSS' ,'JGE' ,'20200402' ,'20200502' ,''
-- exec SP_MES_230_1  'SPSS' ,'' ,'20200402' ,'20200502' ,''  -- 전체


	select *
	into #aa
	from IN_OUT_LIST a

	--select *
	--from #aa a
	--where status = 'ING'

--- 1. 입고 완료 주문 DPS에선 아직 입고 중 ---
	select b.order_no, b.run_status, a.*
	from #aa a, el_cd..t_va_020 b
	where a.status = 'ING'
	and b.order_no = a.order_no
	and in_out_type = 'IN'
	and b.run_status = '5'

--- 2. 출고 완료 불출대기 DPS에선 아직 입고 중 ---
	select b.jp_no, b.qty, b.qty_out, b.status, a.*
	from #aa a, mrp..t_mze_01 b
	where a.status = 'ING'
	and b.jp_no = a.jp_no
	and a.in_out_type = 'OUT'
	and b.qty > 0
	and b.qty_out > 0


--- 3. 검수 후 DPS 입고 대상인 경우 DPS에 안올라온 주문 (서버 DOWN 등의 문제로) ---
	select *
	into #bb
	from el_cd..t_vj_450 a 
	where insp_date between '20200507' and '20200507 23:59:59'
	and ipgo_date is null

	select a.*
	from in_out_list a, #bb b
	where b.order_no = a.order_no


/*
status : OK
dps_status : NULL/OK

select *
from #temp2

begin

	select *
	from IN_OUT_LIST



	--- GECB 체크 ---
	select a.order_no
	into #aa
	from t_myo_01 a
	where a.date_start >= dateadd(d, -10, getdate())

	select b.*
	into #temp1
	from #aa a, [cwdbs03\messys].mes.dbo.PROSECUTOR_OK_TBL b
	where b.order_no = a.order_no

	select a.pcb, gecb_serial= substring(a.pcb,10,12), b.* 
	from #temp1 a, t_myo_01 b
	where b.order_no = a.order_no
	and (b.date_inspect is NULL 	or (b.gecb_serial is NULL or b.gecb_serial  < '0'))

	select *
	into #temp2
	from IN_OUT_LIST

	select *
	from #temp2 a, el_cd..t_va_020 b
	where in_out_type = 'IN'
	and dps_status = 'OK'
	and b.order_no = a.order_no
	and b.run_status <> 5

	select a.*
	from #temp2 a, el_cd..t_va_020 b
	where in_out_type = 'IN'
	and dps_status = 'OK'
	and status = 'ING'
	and b.order_no = a.order_no
	and b.run_status = 5

	select a.*
	from #temp2 a, el_cd..t_va_020 b
	where in_out_type = 'IN'
	and status = 'ING'
	and b.order_no = a.order_no
	and b.run_status = 5

		select *
	from #temp2 a
	where in_out_type = 'IN'


	select a.* 
	from #temp1 a, t_myo_01 b
	where a.reg_dt >= dateadd(d, -30, getdate())
	and b.order_no = a.order_no
	and (b.date_inspect is NULL 	or (b.gecb_serial is NULL or b.gecb_serial  < '0'))

	select a.pcb, b.gecb_serial,gecb=substring(a.pcb,10,12),*
	-- update b set run_status='6',date_inspect=reg_dt,date_gecb_update=reg_dt,gecb_serial=substring(a.pcb,10,12)
	from #temp1 a, mrp.dbo.t_myo_01 b
	where a.order_no=b.order_no
	--and b.gecb_serial is null
	--and substring(a.pcb,10,12)<> b.gecb_serial
	order by b.order_no
*/
end;

/*************************************************************************************************************
*                                                                        
*  SP NAME      : SP_MES_240_1                                                                               
*  DISCRIPTION  : MES System  출하제번 Maching 취소                                                   
*  ALTER  SE    : UNGJ                                        
*                                                                        
*      >> MODIFICATION LOG <                                             
*                                                                        
*  DATE              REQUEST #       S.E NAME         DESCRIPTION              
*  ------------------------------------------------------------------------------------------------------------
 * 2023/06/09       ITSR72593         UNGJ          Matching 취소 화면 개발    
***************************************************************************************************************/
CREATE  PROCEDURE  [dbo].[SP_MES_240_1]
	  @ORDER_NO   	            VARCHAR(8)       --ORDER_NO 
	, @JOB_ID                   VARCHAR(10)      --작업자ID      
	, @JOB_GBN                  VARCHAR(1)       --처리구분       S : SELECT  ,  U : 취소처리 
	
-- EXEC MRP.DBO.SP_MES_240_1  'A213707X', 'SYSTEM', 'U'   
-- EXEC MRP.DBO.SP_MES_240_1  'A2109197', 'SYSTEM', 'S'        --A2109197
AS
  SET NOCOUNT ON 
BEGIN

  DECLARE   @RETURN_MESSAGE         VARCHAR(255)   =  ''           --리턴메시지
	      , @RETURN_VALUE           CHAR(1)        =  ''           --리턴구분
		  , @PROJECT_NO             VARCHAR(11)    =  ''           --프로젝트번호
	      , @MFG_NO                 VARCHAR(3)     =  ''           --항번
	      , @PART                   VARCHAR(2)     =  ''           --파트
	      , @PART_SEQ               VARCHAR(4)     =  ''           --파트항번
		  , @RUN_STATUS             VARCHAR(1)     =  ''           --진행상태구분
		  , @TO_PROJECT_MATCH_DATE  VARCHAR(8)     =  ''           --프로젝트매핑일자 
		  , @CLOSE_DATE             VARCHAR(8)     =  ''           --마감일자     
          , @SEQ                    INT            =  0            --이력순번 
          , @JOB_DATE               SMALLDATETIME  =  ''           --시스템일자 

  SELECT  @JOB_DATE   = GETDATE()                                  --작업일시 매핑 

  --마감일자를 가져온다 
  SELECT @CLOSE_DATE  =  CONVERT(VARCHAR(8), T1.CLOSE_DATE, 112) 
    FROM EL_CD.DBO.T_EX_080 T1
   WHERE T1.CLOSE_CODE  =  'A' 


  IF ( @JOB_GBN = 'S' )                                     --조회 조건 
       BEGIN  
			 SELECT T1.ORDER_NO                                                                    --제조지시번호
			      , T1.ITEM_NO                                                                     --도번 
				  , T3.ENG_DESC                                                                    --품명
				  , T1.TO_PROJECT_NO                                                               --TO_프로젝트번호
				  , T1.TO_MFG_NO                                                                   --TO_항번
				  , T1.TO_PART                                                                     --TO_파트
				  , T1.TO_PART_SEQ                                                                 --TO_파트항번
				  , CONVERT(VARCHAR(8),T1.TO_PROJECT_MATCH_DATE , 112)     TO_PROJECT_MATCH_DATE   --매핑일자
				  , ( SELECT A.CODE_DESC FROM  EL_CD.DBO.T_EX_000 A WHERE A.CODE_SELECT = 'M02' 
				          AND A.CODE  = T1.RUN_STATUS )                    STATUS                  --STATUS 
                  , @CLOSE_DATE                                            CLOSE_DATE              --마감일자
			/*	  ,( SELECT SUBSTRING(P.SHIP_NO,1,3)+'-'+ SUBSTRING(P.SHIP_NO,4,6)+
				          '-'+SUBSTRING(P.SHIP_NO,10,3) 
					  FROM 
					   ( SELECT  MAX(A.SHIP_NO)      SHIP_NO
							FROM EL_CD.DBO.T_EB_050 A
						   WHERE A.PROJECT_NO =  T1.TO_PROJECT_NO
							 AND A.MFG_NO     =  T1.TO_MFG_NO  
							 AND A.PART      =  T1.TO_PART 
							 AND A.PART_SEQ  =  T1.TO_PART_SEQ 
							 AND SUBSTRING(A.SHIP_NO,4,9)  =  (  SELECT MAX(SUBSTRING(B.SHIP_NO,4,9))
																   FROM EL_CD.DBO.T_EB_050 B
																  WHERE B.PROJECT_NO =  T1.TO_PROJECT_NO
																	AND B.MFG_NO     =  T1.TO_MFG_NO  
																	AND B.PART      =  T1.TO_PART 
																	AND B.PART_SEQ  =  T1.TO_PART_SEQ 
																) 
						 
						 ) P   )                                          SHIP_NO       */         --출하번호

			 	  , ( SELECT  STRING_AGG ( SUBSTRING(A.SHIP_NO,1,3)+'-'+ SUBSTRING(A.SHIP_NO,4,6)+
				          '-'+SUBSTRING(A.SHIP_NO,10,3)  ,' / ')
					    FROM EL_CD.DBO.T_EB_050 A
                       WHERE A.PROJECT_NO =  T1.TO_PROJECT_NO
                         AND A.MFG_NO     =  T1.TO_MFG_NO  
                         AND  A.PART      =  T1.TO_PART 
                         AND  A.PART_SEQ  =  T1.TO_PART_SEQ  )              SHIP_NO               --출하번호

				  , T1.PROJECT_NO                                                                  --제조프로젝트
				  , T1.MFG_NO                                                                      --제조항번
				  , T1.PART                                                                        --제조파트
				  , T1.PART_SEQ                                                                    --제조파트항번
		      , CONVERT(VARCHAR(8),T1.DATE_INSPECT , 112)                DATE_INSPECT          --생산완료일
				  , CONVERT(VARCHAR(8),T2.LAST_OUT_DATE , 112)               LAST_OUT_DATE         --출하일자 
			   FROM MRP.DBO.T_MYO_01                   T1
					LEFT OUTER JOIN EL_CD.DBO.T_CA_011 T2  ON T1.TO_PROJECT_NO  = T2.PROJECT_NO  AND T1.TO_MFG_NO    = T2.MFG_NO 
														  AND T1.TO_PART        = T2.PART        AND T1.TO_PART_SEQ  = T2.PART_SEQ 
				  , EL_CD.DBO.T_CX_060 T3
			  WHERE 1  =    1 
				AND T1.ITEM_NO    =  T3.ITEM_NO 
				--AND ISNULL(T1.TO_PROJECT_NO,'')  !=  ''   
				--AND ISNULL(T2.LAST_OUT_DATE,'')   =  ''                                                               --미출하만 조회 되도록 처리 
				--AND CONVERT(VARCHAR(8), T1.TO_PROJECT_MATCH_DATE, 112)  >  @CLOSE_DATE                                --마감 체크
				--AND CONVERT(VARCHAR(8), T1.TO_PROJECT_MATCH_DATE, 112) BETWEEN @MATCH_DATE_FR AND @MATCH_DATE_TO
				AND T1.ORDER_NO  =  @ORDER_NO 	
			  ORDER BY  T1.ORDER_NO
      END

 ELSE                                             --매핑 삭제 처리 
      BEGIN

	        SELECT @PROJECT_NO             = T1.TO_PROJECT_NO           --TO_프로젝트번호   
                 , @MFG_NO                 = T1.TO_MFG_NO               --TO_항번
                 , @PART                   = T1.TO_PART                 --TO_파트
                 , @PART_SEQ               = T1.TO_PART_SEQ             --TO_파트항번
				 , @RUN_STATUS             = T1.RUN_STATUS              --진행상태구분
			     , @TO_PROJECT_MATCH_DATE  = CONVERT(VARCHAR(8), T1.TO_PROJECT_MATCH_DATE, 112)
			  FROM MRP.DBO.T_MYO_01 T1
             WHERE T1.ORDER_NO  = @ORDER_NO  

		     /* 매핑처리한 대상이 아닌 프로젝트 체크 "RUN_STATUS"로 체크 불가 합니다 진행이 9->8로 처리되는 경우가 존재 함 */   
			IF  ( ISNULL(@PROJECT_NO,'')  =  '' ) 
				BEGIN 
					SELECT @RETURN_VALUE = 'N', @RETURN_MESSAGE = '해당 제조지시번호가 매핑처리한 대상이 아닙니다.'   
					GOTO  END_PROC
					RETURN
				END

			 /* 출하처리된 프로젝트는 제외 불가 반영 */ 
			IF  EXISTS  (  SELECT  *  
				  		     FROM  EL_CD.DBO.T_CA_011 T1
                            WHERE  T1.PROJECT_NO  = @PROJECT_NO 
                              AND  T1.MFG_NO      = @MFG_NO 
                              AND  T1.PART        = @PART 
                              AND  T1.PART_SEQ    = @PART_SEQ 
						      AND  ISNULL(T1.LAST_OUT_DATE,'')  != '' )   --출하일자가 존재하다고 봄 
				BEGIN 
					SELECT @RETURN_VALUE = 'N', @RETURN_MESSAGE = '해당 제조지시번호가 출하처리되여 불가합니다.'   
					GOTO  END_PROC
					RETURN
				END


			/*마감을 체크하여야 하는지 확인 */
            IF ( @CLOSE_DATE >=  @TO_PROJECT_MATCH_DATE )
				BEGIN 
					SELECT @RETURN_VALUE = 'N', @RETURN_MESSAGE = '해당 제조지시번호는 마감처리되여 처리 불가합니다.'   
					GOTO  END_PROC
					RETURN
				END 

			SELECT  @SEQ = ISNULL(( SELECT MAX(A.SEQ) 
					  				  FROM EL_CD.DBO.T_PROJECT_HST A
						 			 WHERE A.JOB_DATE   =    @JOB_DATE ), 0 ) + 1   

            --해당 PROJECT에대한 이력 정보  
			INSERT INTO  EL_CD.DBO.T_PROJECT_HST
			   (   JOB_DATE 
				 , SEQ  
				 , PGM_NAME  
				 , ORDER_NO 
				 , PROJECT_NO  
				 , MFG_NO  
				 , PART  
				 , PART_SEQ  
				 , REF  
				 , JOB_ID
				) 
			SELECT @JOB_DATE
				 , @SEQ
				 , 'SP_MES_240_1'
				 , T1.ORDER_NO
				 , T1.TO_PROJECT_NO 
				 , T1.TO_MFG_NO
				 , T1.TO_PART
				 , T1.TO_PART_SEQ 
				 , T1.PROJECT_NO + '/' + T1.MFG_NO + '/' + T1.PART + '/' + T1.PART_SEQ + '/' + '매핑삭제'
				 , @JOB_ID
			  FROM MRP.DBO.T_MYO_01 T1
			 WHERE ORDER_NO  =  @ORDER_NO

			 --20230718일 수불장에 last_in_date 를 NULL 처리 추가반영
			 UPDATE T2 
			    SET T2.LAST_IN_DATE  =  NULL
			   FROM MRP.DBO.T_MYO_01  T1
			  INNER JOIN  EL_CD.DBO.T_CA_011  T2 ON T1.TO_PROJECT_NO = T2.PROJECT_NO AND T1.TO_MFG_NO    = T2.MFG_NO
                                                AND T1.TO_PART       = T2.PART       AND T1.TO_PART_SEQ  = T2.PART_SEQ
		  	  WHERE T1.ORDER_NO  =  @ORDER_NO


	   
	        -- 생산제조 매핑정보 CLEAR 처리 
			UPDATE T1 
			   SET T1.TO_PROJECT_NO         =  '' 
				 , T1.TO_MFG_NO             =  '' 
				 , T1.TO_PART	            =  ''
				 , T1.TO_PART_SEQ           =  ''
				 , T1.PROJECT_MOVE_DATE     =  NULL
				 , T1.TO_PROJECT_MATCH_ID   =  ''
				 , T1.TO_PROJECT_MATCH_DATE =  NULL
				 , T1.TO_BOX_NO             =  ''
				 , T1.TO_DIVIDE_SEQ         =  NULL    
				 , T1.TO_PROJECT_CONFIRM_ID =  ''
				 , T1.TO_PROJECT_CONFIRM    =  NULL  --place_move_receiver 
				 , T1.RUN_STATUS            =  ( CASE WHEN ISNULL(T1.PLACE_MOVE_RECEIVER,'') = '' THEN '7'  ELSE '8' END )  --place_move_receiver 있으면 8(아산이동)로 Update 
			 FROM MRP.DBO.T_MYO_01 T1
			WHERE ORDER_NO  =  @ORDER_NO
	 END 

END 

END_PROC:

   SELECT @RETURN_VALUE, @RETURN_MESSAGE;

/****** 개체: 저장 프로시저 dbo.S_EX_000_1    스크립트 날짜: 02-06-08 오전 11:14:06 ******/
/****** Object:  Stored Procedure dbo.S_EX_000_1    Script Date: 00-06-17 오후 8:18:05 ******/
CREATE PROCEDURE  [dbo].[SP_MEX_000_1]
	@flag				char(01),	/* S:Select M:update A:insert */
	@code_select		varchar(10)='',
	@code_select_desc	varchar(50)='',
	@table_name			varchar(20)='',
	@length				int=0,
	@min_length			int=0
AS
	exec EL_CD..S_EX_001_2 
		@flag,
		@code_select,
		@code_select_desc,
		@table_name,
		@length,
		@min_length;

CREATE PROCEDURE [dbo].[SP_MEX_020_1]
	@flag			char(01),	/** A:insert  m:update***/
	@code_select	varchar(20)='',
	@code			varchar(20)='',
	@code_desc		varchar(50)='',
	@update_man		varchar(10)=''
AS
set nocount on

	exec el_cd..S_EX_020_2
		@flag		,	/** A:insert  m:update***/
		@code_select	,
		@code		,
		@code_desc	,
		@update_man;

CREATE PROCEDURE  [dbo].[SP_MEX_310_1]
	@flag				char(01),	/* S:Select M:update A:insert */
	@code_select		varchar(10)='',
	@code_select_desc	varchar(50)='',
	@code_len			int=0,
	@seq_len			int=0,
	@code_type			char(01)=''
AS

	exec el_cd..S_EX_310_1
		@flag	,	
		@code_select	,
		@code_select_desc	,
		@code_len	,
		@seq_len	,
		@code_type;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_001_1                                                                                                                                              */
/*  DISCRIPTION  :  Schedule JOB Management                                                                                                            */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/29     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_001_1]
	@flag				char(01),
	@job_id				varchar(20)='',
	@description		varchar(100)='',
	@start_time			varchar(05)='',
	@job_type			char(01)='',
	@priority			int=0,
	@use_flag			char(01)='U',
	@schedule_job_name	varchar(50)=''
as
--S_MRP_001_1 'S'

	if @flag = 'S'
	begin
		if @job_type = ''
		begin
			select	job_id,
					description,
					job_option=(case when job_option < '0' then 'No Option' else job_option end),
					start_time,
					job_type,
					schedule_job_name,
					priority,
					use_flag
			from x_batch_job
			where (@job_id < '0' OR job_id like '%'+rtrim(@job_id)+'%')
		end
		else
		begin
			select	job_id,
					description,
					job_option=(case when job_option < '0' then 'No Option' else job_option end),
					start_time,
					job_type,
					schedule_job_name,
					priority,
					use_flag
			from x_batch_job
			where job_type = @job_type and (@job_id < '0' OR job_id like '%'+rtrim(@job_id)+'%')
		end
	end
	else if @flag = 'M'
	begin	
		if not exists ( select 'Y'
						from x_batch_job a
						where job_id=@job_id )
		begin
			insert into x_batch_job
			select	@job_id,
					@description,
					'',
					@start_time,
					upper(@job_type),
					@schedule_job_name,
					@priority,
					upper(@use_flag)
		end
		else 
		begin
			update a set
				description=@description,
				start_time=@start_time,
				job_type=upper(@job_type),
				schedule_job_name=@schedule_job_name,
				priority=@priority,
				use_flag=upper(@use_flag)
			from x_batch_job a
			where job_id=@job_id

			if @job_type <> 'S'  -- 주기적인 작업 Option 삭제
			begin
				delete a 
				from x_batch_job_option_period a
				where job_id=@job_id
			end
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from x_batch_job a
		where job_id=@job_id

		delete a 
		from x_batch_job_option_period a
		where job_id=@job_id

		delete a 
		from x_batch_job_option_field a
		where job_id=@job_id
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_002_1                                                                                                                                              */
/*  DISCRIPTION  :  Periodical Schedule JOB Management                                                                                                            */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/29     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_002_1]
	@flag			char(01),
	@job_id			varchar(20),
	@period_type	varchar(01)='',
	@run_week		int=0,
	@run_weekday	varchar(07)=''
AS
--exec  SP_MRP_002_1 'S','MRP_6BB'

	select @period_type=upper(@period_type)

	if @flag='S'
	begin
		select 	a.job_id, a.description, 
				period_type=ISNULL(b.period_type,'D'),
				run_week=ISNULL(b.run_week,0),
				run_weekday=isnull(b.run_weekday,'0000000'),
				start_time=isnull(start_time,'')
		from X_Batch_Job a left join  X_Batch_Job_Option_Period b
		on a.job_id=b.job_id
		where a.job_id=@job_id
		and job_type='S'
		and use_flag='Y'	
	end
	else
	begin
		if exists(select * from X_Batch_Job_Option_Period where job_id=@job_id)
		begin
			update b set
				period_type=@period_type,
				run_week=@run_week,
				run_weekday=@run_weekday
			from X_Batch_Job a ,  X_Batch_Job_Option_Period b
			where a.job_id=@job_id
			and a.job_type='S'
			and a.use_flag='Y'	
			and a.job_id=b.job_id
		end
		else
		begin
			insert into X_Batch_Job_Option_Period
			select 	a.job_id,
					period_type=@period_type,
					run_week=@run_week,
					run_weekday=@run_weekday
			from X_Batch_Job a
			where a.job_id=@job_id
			and job_type='S'
			and use_flag='Y'	
		end	
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_003_1                                                                                                                                                    */
/*  DISCRIPTION  : Batch Job Delete & Start                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/25     MRP Downsizing Project   S.H. Song      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_003_1]
	@flag				char(01),	/**  S:조회   M:수정**/
	@job_id				varchar(30)='',
	@page				varchar(24)='',
	@planned_date_time	varchar(24)='',
	@priority			int=0
AS
set nocount on

--exec MRP.dbo.SP_MRP_003_1 'S'

	if @flag = 'S'
	begin
		exec mrp.dbo.xp_Common_Schedule_Job_Inquiry 'N','',@job_id
		return
	end

	if @flag = 'M'
	begin
		if isdate(@planned_date_time) = 0
			return
			
		if isnumeric(@priority)=0
			return
			
		update a set
			planned_date_time=@planned_date_time,
			priority =@priority
		from X_batch_JOB_OPTION a
		where a.job_id = @job_id
		and page=@page	
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_004_1                                                                                                                                                    */
/*  DISCRIPTION  : Batch Job Delete & Start                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/25     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_004_1]
	@flag			char(01),	/**  S:조회   D:작업삭제  P:작업시작 **/
	@job_id			varchar(30)='',
	@page			varchar(24)='',
	@request_emp_id	varchar(10)=''
AS
set nocount on

/*

exec SP_MRP_004_1 'P','SCH_200','2010-09-25 14:57:38.340','lgjjg'
*/

	if @flag = 'S'
	begin
		exec mrp.dbo.xp_Common_Schedule_Job_Inquiry 'A','',@job_id
		return
	end

	if @flag = 'D'
	begin
		delete a
		from mrp.dbo.x_batch_job_option a with (index=PK_X_Job_Option)
		where a.job_id = @job_id
		and a.page =  @page

		delete a
		from mrp.dbo.x_batch_job_current a
		where a.job_id = @job_id
		and a.page =  @page
	end

	if @flag = 'P'
	begin
		if exists ( select * from mrp.dbo.X_batch_job_Current )
		begin
			select status='1',out_msg='진행중인 작업이 있읍니다..조치후 작업요망???'
			return
		end

		update a set
			run_start_date =null,
			run_end_date =null
		from X_batch_JOB_OPTION a
		where a.job_id = @job_id
		and page=@page	
		
		delete a
		from X_Batch_JOB_Error a
		where job_id=@job_id
		and page = @page
	
		begin tran aa
		insert into mrp.dbo.X_batch_job_Current  values (@job_id,@page)
		commit tran aa
	
		EXEC msdb.dbo.sp_start_job 'JOB Runner' 

		select status='0',out_msg='Job Start OK ...'
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_005_1                                                                                                                                                    */
/*  DISCRIPTION  : Batch Job Result Inquiry                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/25     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_005_1]
	@flag		char(01),	-- 실행계획시간  A:All,  P:현재이전 N:현재이후
	@user_id	varchar(20),
	@job_id		varchar(50)
AS
set nocount on

--exec MRP.dbo.SP_MRP_005_1 'A','',''

	exec mrp.dbo.xp_Common_Schedule_Job_Inquiry @flag,@user_id,@job_id
	
	select job=' Current Running Job ==> ' + a.job_id + ' / ' + b.description + ' / ' + convert(varchar(24),a.page,121)
	from X_Batch_Job_Current a
		inner join X_Batch_Job b
			on b.job_id=a.job_id;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_006_1                                                                                                                                                    */
/*  DISCRIPTION  : Menu Management                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_006_1]
	@flag			char(01),	/** A:insert  m:update***/
	@program		varchar(30)='',
	@program_name	varchar(50)='',
	@level			varchar(30)='',
	@program_type	char(01)='',
	@security_level	int=0,
	@chng_id		varchar(10)=''
AS
set nocount on
--exec MRP.dbo.SP_MRP_006_1 'S'
--exec MRP.dbo.SP_MRP_006_1 'A','MRP_009','AA','009010','P',''
	select @program=upper(@program)

	declare	@domain	varchar(30),
			@app_program	varchar(10)


	select	@program_type=upper(@program_type)

	select	@domain='지원공장',
			@app_program='NewMrp'

	exec SP_MRP_010_2 'MRP_006'

	if @flag='S'
		select	program=a.program,
				program_name=b.program_name,
				security_level=b.security_level,
				level,
				program_type=a.program_type,
				chng_id=a.chng_id
		from common.dbo.app_prog_mem_info a,common.dbo.program_info b
		where a.domain=@domain
		and a.app_program=@app_program
		and a.program like '%'+rtrim(@program)+'%'
		and a.level like rtrim(@level)+'%'
		and b.program=a.program
		order by a.program
	else if @flag = 'M'
	begin	
		if not exists (select *
			from common.dbo.program_info a
			where program=@program)
		begin
			insert into common.dbo.program_info
			select	program=@program,
					program_name=@program_name,
					security_level=@security_level,
					develop_id='',
					develop_date=getdate(),
					develop_chng_id='',
					develop_chng_date=getdate(),
					status='S',
					version='1.0',
					chng_date=getdate(),
					chng_id=@chng_id,
					request_no=1,
					p_id='D376CB0D-E644-4180-A982-CEB71D35C018'
		end
		else
		begin					
			update a set
				security_level=@security_level,
				program_name=@program_name
			from common.dbo.program_info a
			where a.program=@program
			and (a.program_name <> @program_name or security_level <> @security_level)
		end
		
		if not exists (select *
				from common.dbo.app_prog_mem_info a
				where a.domain=@domain
				and a.app_program=@app_program
				and a.program=@program)
		begin
			insert into common.dbo.app_prog_mem_info
			select	domain=@domain
				,app_program=@app_program
				,program=@program
				,chng_date=getdate()
				,chng_id=@chng_id
				,program_type=@program_type
				,level=@level		
		end
		else
		begin
			update a set
				level=@level,
				program_type=@program_type,
				chng_id=@chng_id
			from common.dbo.app_prog_mem_info a
			where a.domain=@domain
			and a.app_program=@app_program
			and a.program=@program
		end
	end
	else if @flag='D'
		delete a
		from common.dbo.app_prog_mem_info a
		where a.domain=@domain
		and a.app_program=@app_program
		and a.program=@program;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_007_1                                                                                                                                                    */
/*  DISCRIPTION  : Batch Job Request                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_007_1]
	@flag			char(01),	/** A:작업요청  S:조회***/
	@job_id			varchar(20)='',
	@page			varchar(24)='',
	@page_option	varchar(255)='',
	@user_id		varchar(10)=''
AS
set nocount on
--"exec MRP.dbo.SP_MRP_007_1 'A','MRP_6EI','Gaijung=ELES&DueDate=20091210'"

	declare	@domain			varchar(20),
			@app_program	varchar(20),
			@description	varchar(50),
			@job_type		char(01),
			@code			varchar(20)

	select	@domain='지원공장',@app_program='MRP'

	if @flag = ''
	begin
		exec mrp.dbo.xp_Common_Schedule_Job_Inquiry 'A',@user_id,@job_id
	end
	else if @flag='S'
	begin
		create table #aa (
			field	varchar(20),
			value	varchar(20)
		)

		if @page > ''
		begin
			select @page_option=a.Page_Option
			from mrp.dbo.x_batch_job_option a
			where a.job_id=@job_id
			and a.page=@page
		end
		else
		begin
			select @page_option=a.job_option,@description=description,@job_type=job_type
			from mrp.dbo.x_batch_job a
			where job_id = @job_id
		end

		declare	@token	varchar(200),
				@field	varchar(20),
				@value	varchar(20)

		WHILE (len(rtrim(@page_option)) > 0)	
		begin
			select @page_option=ltrim(rtrim(@page_option))

			if charindex('&',@page_option)> 0
			begin
				select @token=left(@page_option,charindex('&',@page_option)-1)
				if charindex('=',@token)>'0'
				begin
					select @field=left(@token,charindex('=',@token)-1)
					select @value=substring(@token,charindex('=',@token)+1,200)
				end
				else
				begin 
					select @field=@token,@value=''
				end

				insert into #aa 
				select @field,@value

				select @page_option=rtrim(ltrim(substring(@page_option,charindex('&',@page_option)+1,200)))
			end
			else
			begin
				select @token=@page_option
				if charindex('=',@token)>'0'
				begin
					select @field=left(@token,charindex('=',@token)-1)
					select @value=substring(@token,charindex('=',@token)+1,200)
				end
				else
				begin 
					select @field=@token,@value=''
				end

				insert into #aa 
				select @field,@value

				select @page_option=''
			end
		end

		select a.*,b.field_desc
		from #aa a left outer join X_batch_job_option_field b
			on b.job_id=@job_id
			and b.option_field = a.field
		order by b.priority
	end
	else if @flag = 'A'
	begin
		select @code=mrp.dbo.fCheckBatchOption(@job_id,@page_option)
		if @code > '0'
		begin
			select status='1',out_msg=@code
			return
		end
		
		if exists (SELECT *
			from mrp.dbo.x_batch_job a
			where a.job_id=@job_id
			and a.job_type='S')
		begin					
			delete a
			from mrp.dbo.x_batch_job_option a with (index=IX_X_Batch_Job_Option_3)
			where run_end_date is null
			and job_id = @job_id
			and (@page_option='' or left(Page_Option,12)=left(@page_option,12))
		end
	
		
		insert into mrp.dbo.x_batch_job_option
		select	@job_id,
				page=getdate(),
				request_emp_id=@user_id,
				run_start_date=null,
				run_end_date=null,
				run_result='',
				Page_Option=@page_option,
				run_status='',
				planned_date_time=(case when a.job_type ='S'
						then mrp.dbo.fn_Common_Next_schedule_Date(a.job_id,
								convert(char(08),dateadd(day,
									(case when a.start_time > '08:00'  then  -1 else 0 end),
										getdate()),112) + ' ' + a.start_time)
						else (case when a.start_time > '08:00' 
								then convert(char(08),getdate(),112) + ' ' + a.start_time + ':00'
								else convert(char(08),dateadd(day,1,getdate()),112) + ' ' + a.start_time + ':00'
								end)
						end),
				priority=a.priority,
				file_name1='',
				file_name2='',
				file_name3=''
		from mrp.dbo.x_batch_job a
		where a.job_id=@job_id

		select status='0',out_msg=' Request OK ...'
		return
	end

	select job_type=@job_type;

CREATE PROCEDURE  [dbo].[SP_MRP_008_1]
	@flag			char(01),	
	@user_id		varchar(10),
	@user_name_k	varchar(20),
	@gaijung		varchar(4)='',
	@mrp_post		char(02)='',
	@mrp_person		char(02)='' 

AS
--exec MRP.dbo.SP_MRP_008_1 'S','lg',''

	if @flag = 'S'  -- user_id
	begin
		SELECT 	user_id, user_name_k, 	
				gaijung=isnull(gaijung,''), 
				mrp_post=isnull(mrp_post,''),
				mrp_person=isnull(mrp_person,'')
		FROM 	common.dbo.user_info (nolock)
		where   user_id like ltrim(@user_id) + '%'
		and user_name_k like '%' + ltrim(@user_name_k) + '%'
		and active_flag = 'C'
		ORDER BY user_id
	end
	else if @flag = 'M'
	begin
		IF @user_id <> '209559' OR @gaijung <> 'SYHP'
		BEGIN
			update a set
				gaijung=upper(@gaijung),
				mrp_post=upper(@mrp_post),
				mrp_person=upper(@mrp_person)
			from common.dbo.user_info a
			where user_id = @user_id
		END
		select '0'
	end;

/****** 개체: 저장 프로시저 dbo.S_EX_020_1    스크립트 날짜: 02-06-08 오전 11:14:06 ******/
/****** Object:  Stored Procedure dbo.S_EX_020_1    Script Date: 00-06-17 오후 8:18:05 ******/
/****** Object:  Stored Procedure dbo.S_EX_020_1    Script Date: 2000-05-15 오후 7:36:49 ******/
CREATE PROCEDURE [dbo].[SP_MRP_009_1]
	@flag			char(01),	/** A:insert  m:update***/
	@post			varchar(02)='',
	@person			varchar(02)='',
	@user_id		varchar(10)='',
	@user_name_k	varchar(50)='',
	@chng_id		varchar(10)=''
AS
set nocount on
--exec MRP.dbo.SP_MRP_009_1 'S'

	if @flag='S'
		select	post=a.mrp_dept_person1,
				person=a.mrp_dept_person2,
				user_id=a.emp_num,
				user_name_k=b.user_name_k,
				chng_id=a.userid,
				last_update=a.last_update
		from common.dbo.T_MR_101 a,common.dbo.user_info b
		where a.mrp_dept_person1 like rtrim(@post)+'%'
		and a.mrp_dept_person2 like rtrim(@person)+'%'
		and a.emp_num like rtrim(@user_id)+'%'
		and b.user_id=a.emp_num
		and rtrim(b.user_name_k) like rtrim(@user_name_k)+'%'
		order by user_id
	else if @flag = 'M'
	begin
		if not exists (select *
				from common.dbo.T_MR_101 a
				where mrp_dept_person1=@post
				and mrp_dept_person2=@person)
		begin
			insert into common.dbo.T_MR_101
			select	mrp_dept_person1=@post,
					mrp_dept_person2=@person,
					'',
					'',
					user_id=@user_id,
					'1',
					last_update=getdate(),
					@chng_id
		end
		else
		begin
			update a set
				emp_num=@user_id,
				last_update=getdate(),
				userid=@chng_id
			from common.dbo.T_MR_101 a
			where mrp_dept_person1=@post
			and mrp_dept_person2=@person
		end
	end
	else if @flag='D'
		delete a
		from common.dbo.T_MR_101 a
		where mrp_dept_person1=@post
		and mrp_dept_person2=@person;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_010_1                                                                                                                                                    */
/*  DISCRIPTION  : Project Develop Status                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/12     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_010_1]
	@flag				char(01),
	@ProgramID			varchar(20),
	@NewProgrmID		varchar(20)='',   -- flag='S'일때는 조회 조건
	@Screen_Design		varchar(08)='',
	@DocumentID			varchar(15)='',
	@ScreenDocu			varchar(08)='',
	@SpecDocu			varchar(08)='',
	@codingDate			varchar(08)='',
	@flowDocuFlag		char(01)='',
	@flowDocu			varchar(08)='',
	@developer_test_date	varchar(08)='',
	@test_docu_date		varchar(08)='',
	@user_name			varchar(20)='',
	@user_test_date		varchar(08)='',
	@remark				varchar(50)=''
AS
--exec  SP_MRP_010_1 'S','mrp_4'

	if @flag='S'
	begin
		select	ProgramID,
				program_name=(case when b.program_name is not null then b.program_name else a.Description+'**' end),
				NewProgrmID=isnull(NewProgrmID,''),
				Screen_Design=(case when Screen_Design is null then '' else convert(char(08),Screen_Design,112) end),
				DocumentID=isnull(DocumentID,''),
				ScreenDocu=(case when ScreenDocu is null then '' else convert(char(08),ScreenDocu,112) end),
				SpecDocu=(case when SpecDocu is null then '' else convert(char(08),SpecDocu,112) end),
				CodingDate=(case when CodingDate is null then '' else convert(char(08),CodingDate,112) end),
				flowDocuFlag=isnull(flowDocuFlag,''),
				flowDocu=(case when flowDocu is null then '' else convert(char(08),flowDocu,112) end),
				test_docu_date=(case when test_docu_date is null then '' else convert(char(08),test_docu_date,112) end),
				remark=isnull(remark,''),
				last_test_date=(case when last_test_date is null then '' else convert(char(08),last_test_date,112) end),
				developer_test_date=(case when developer_test_date is null then '' else convert(char(08),developer_test_date,112) end),
				test_count=isnull(test_count,0),
				user_name=isnull(a.user_name,''),
				user_test_date=(case when user_test_date is null then '' else convert(char(08),user_test_date,112) end)
		from X_develop_status a left join  common.dbo.program_info b
			on a.ProgramID=b.program
		where left(a.NewProgrmID,4) <>  'XXXX'
		and substring(a.ProgramID,5,1) <> 'Y'
		and substring(a.remark,1,3) <> 'XXX'
		and  (		(a.ProgramID like '%'+rtrim(@ProgramID)+'%' or 
					a.NewProgrmID  like '%'+rtrim(@ProgramID)+'%' )
				and  (	@NewProgrmID = 'ALL' or 
					@NewProgrmID = 'Cod' and CodingDate is null or 
					@NewProgrmID = 'Log' and last_test_date is null or 
					@NewProgrmID = 'Dev' and developer_test_date is null or 
					@NewProgrmID = '3rd' and test_docu_date is null or 
					@NewProgrmID = 'Use' and user_test_date is null )  
			or
				@NewProgrmID = 'user' and a.user_name like '%' + @ProgramID + '%' )
	end
	else if @flag='D'
	begin
		delete a
		from X_develop_status a 
		where a.ProgramID = @ProgramID
	end
	else
	begin
		if exists(select * from X_develop_status where ProgramID=@ProgramID)
		begin
			update A set
				NewProgrmID=@NewProgrmID,
				Screen_Design=(case when isdate(@Screen_Design)=1 then @Screen_Design else null end),
				DocumentID=@DocumentID,
				ScreenDocu=(case when isdate(@ScreenDocu)=1 then @ScreenDocu else null end),
				SpecDocu=(case when isdate(@SpecDocu)=1 then @SpecDocu else null end),
				CodingDate=(case when isdate(@CodingDate)=1 then @CodingDate else null end),
				flowDocuFlag=@flowDocuFlag,
				flowDocu=(case when isdate(@flowDocu)=1 then @flowDocu else null end),
				test_docu_date=(case when isdate(@test_docu_date)=1 then @test_docu_date else null end),
				developer_test_date=(case when isdate(@developer_test_date)=1 then @developer_test_date else null end),
				user_name=@user_name,
				user_test_date=(case when isdate(@user_test_date)=1 then @user_test_date else null end),
				remark=isnull(@remark,'')
			from X_develop_status a 
			where a.ProgramID=@ProgramID
		end
		else
		begin
			insert into X_develop_status
			select 	@ProgramID,
					Description='',
					NewProgrmID=@NewProgrmID,
					Screen_Design=@Screen_Design,
					DocumentID=@DocumentID,
					ScreenDocu=(case when @ScreenDocu < '0' then null else @ScreenDocu end),
					SpecDocu=(case when @SpecDocu < '0' then null else @SpecDocu end),
					CodingDate=(case when @CodingDate < '0' then null else @CodingDate end),
					flowDocuFlag=@flowDocuFlag,
					flowDocu=@flowDocu,
					test_docu_date=(case when @test_docu_date < '0' then null else @test_docu_date end),
					remark=@remark,
					last_test_date=null,
					test_count=0,
					developer_test_date=(case when @developer_test_date < '0' then null else @developer_test_date end),
					user_name=@user_name,
					user_test_date=(case when isdate(@user_test_date)=1 then @user_test_date else null end)
		end	
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_010_1                                                                                                                                                    */
/*  DISCRIPTION  : Project Develop Status                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/12     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_010_2]
	@ProgramID			varchar(30)
AS
BEGIN
	declare @a char(01)
	
	select @a='1'
	
	--update A set
	--	Last_Test_Date=getdate(),
	--	Test_Count=isnull(Test_Count,0)+1
	--from X_develop_status a 
	--where a.ProgramID like @ProgramID + '%' or
	--	a.NewProgrmID like @ProgramID + '%'

END;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_011_1                                                                                                                                              */
/*  DISCRIPTION  :  작업결과조회 By Page                                                                                                             */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/18     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_011_1]
	@page_no		varchar(24)
as

	select *
	from mrp.dbo.x_batch_job_error
	where page=@page_no
	order by report_sort,seq,error_message;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_012_1                                                                                                                                              */
/*  DISCRIPTION  :  Batch Job Option Field Management                                                                                                            */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         option_field                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/18     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_012_1]
	@flag			char(01),
	@job_id			varchar(20)='',
	@option_field	varchar(50)='',
	@field_desc		varchar(50)='',
	@o_priority		varchar(01)='',
	@check_method_1	varchar(10)='',
	@check_method_2	varchar(10)='',
	@must_fill		char(01)=''
as
--S_MRP_001_1 'S'
	declare	@priority	int

	select @priority = (case when  isnumeric(@o_priority)=0 then 1 else convert(int,@o_priority) end)
		 
	if @flag = 'S'
		select	job_id,
				option_field,
				field_desc,
				priority,
				check_method_1,
				check_method_2,
				must_fill
		from x_batch_job_option_field
		where job_id = @job_id
		order by priority
	else if @flag = 'M'
	begin
		if not exists (select * 
				from x_batch_job_option_field a
				where job_id=@job_id
				and option_field=@option_field)
		begin
			insert into x_batch_job_option_field
			select	@job_id,
					@option_field,
					@field_desc,
					@priority,
					@check_method_1,
					@check_method_2,
					@must_fill
			select '0',' Insert OK ...'
		end
		else
		begin
			update a set
				field_desc=@field_desc,
				priority=@priority,
				check_method_1=@check_method_1,
				check_method_2=@check_method_2,
				must_fill=@must_fill
			from x_batch_job_option_field a
			where job_id=@job_id
			and option_field=@option_field
			select '0',' Update OK ...'
		end		
	end
	else if @flag = 'D'
	begin
		if  exists (select * 
				from x_batch_job_option_field a
				where job_id=@job_id
				and option_field=@option_field)
		begin
			delete a 
			from x_batch_job_option_field a
			where job_id=@job_id
			and option_field=@option_field
			select '0',' Delete OK ...'
		end
		else
			select '1',' Not Existed ???'
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_012_2                                                                                                                                              */
/*  DISCRIPTION  :  Batch Job Option Field Management                                                                                                            */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         option_field                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/18     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_012_2]
	@job_id			varchar(20),
	@option_fields	varchar(200)
as

	update a set
		job_option=@option_fields
	from x_batch_job a
	where job_id=@job_id;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_400_1                                                                                    */
/*  DISCRIPTION  : 납품예정번호별 주문조회                                                                         */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                        */
/*  ---------------------------------------------------------------                                                */
/* 2010/09/07     MRP Downsizing Project   J.J.Park      Initialize                                                */
/*  1.5 2023-10-30  ITSR72315               UNGJ        납품예정일  VARCHAR(20)                                    */
/*******************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_400_1] 
	@expcect_no	varchar(20), 	--납품예정번호 
	@trade_no	varchar(08)='',
	@item_no	varchar(15)=''	--품목번호
as
set nocount on
--exec mrp.dbo.SP_MRP_400_1  'B101268610081604','',''

	if @expcect_no < '0'
	begin
		select ''
		from el_cd..t_va_020
		where 1=2
		return
	end

	select 	prod_no_all=a.prod_no+a.part+a.part_seq,
			eng_desc = master.dbo.fGetItemDesc(a.item_no),
			a.supply,		--조달
			a.item_no,
			a.qty_order,
			date_due = convert(varchar(08), a.date_due, 112),		--납기
			a.order_no,
			a.qty_deliv, 
			a.qty_insp, 
			a.qty_deliv - a.qty_insp qty_fail, 
			a.qty_acpt, 
			a.qty_input,
			a.qty_cancel, 
			a.qty_reject, 
			a.insp_select, 
			a.ship_flag, 
			a.run_status  ,  
			vendor=a.trade_no,
			brief_trade = master.dbo.fGetVendorName(a.trade_no)
	from el_cd..t_va_020 a with (index=IX_T_VA_020_7 NOLOCK) 
	where 	a.receipt_expect_no = @expcect_no	
	and	(@trade_no < '0' or a.trade_no = @trade_no )
	and	( @item_no < '0' or a.item_no = @item_no)
	and      a.approve_flag = 'Y'
	and      a.receipt_flag = 'Y'   --승인/접수된 대상만 납품예정리스트 생성대상	
--	order by a.order_no, a.item_no, a.prod_no

	union 

	select 	prod_no_all=a.prod_no+a.part+a.part_seq,
			eng_desc = master.dbo.fGetItemDesc(a.item_no),
			a.supply,		--조달
			a.item_no,
			a.qty_order,
			date_due = convert(varchar(08), a.date_due, 112),		--납기
			a.order_no,
			a.qty_deliv, 
			a.qty_insp, 
			a.qty_deliv - a.qty_insp qty_fail, 
			a.qty_acpt, 
			a.qty_input,
			a.qty_cancel, 
			a.qty_reject, 
			a.insp_select, 
			a.ship_flag, 
			a.run_status   ,
			vendor=a.trade_no,
			brief_trade = master.dbo.fGetVendorName(a.trade_no)
	from el_cd..t_va_020 a with (index=IX_T_VA_020_A NOLOCK) 
	where 	a.box_receipt_expect_no = @expcect_no	
	and	(@trade_no < '0' or a.trade_no = @trade_no )
	and	( @item_no < '0' or a.item_no = @item_no)
	and      a.approve_flag = 'Y'
	and      a.receipt_flag = 'Y'   --승인/접수된 대상만 납품예정리스트 생성대상	
	order by a.order_no, a.item_no, prod_no_all;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_44A_1                                                                                                                                                    */
/*  DISCRIPTION  : 수불옵션관리                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_44A_1]
	@flag				char(01),	/* S:Select M:update A:insert */
	@gaijung			varchar(04),
	@store				varchar(06)='',
	@order_select		char(01)='',
	@price_option		char(01)='',
	@account_option		char(01)='',          
	@close_year_month	char(06)='',
	@current_year		varchar(04)=''
AS
--exec mrp.dbo.sp_mrp_44b_1 'A','ELES','X','D','N','2','200910',''
	if @flag = 'S'
		SELECT 	*
		FROM 	T_MZR_A1 (nolock)
		where   left(gaijung,2) = left(@gaijung,2) 
		ORDER BY gaijung,store,order_select
	else if @flag = 'M'
	begin
		if  exists (select *
					from T_MZR_A1 a
					where gaijung=@gaijung
					and store = @store
					and order_select = @order_select)
		begin
			update a set
					price_option=@price_option,
					account_option=@account_option,
					close_year_month=@close_year_month
			from T_MZR_A1 a
			where gaijung=@gaijung
			and store = @store
			and order_select = @order_select
		end
		else
		begin
			insert into T_MZR_A1 values (
					@gaijung,
					@store,
					@order_select,
					@price_option,
					@account_option,
					@close_year_month,
					@current_year)
		end
		select 0,'OK'
	end
	else if @flag = 'D'
	begin
		delete a
		from T_MZR_A1 a
		where gaijung=@gaijung
		and store = @store
		and order_select = @order_select

		select 0,'OK'
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_44B_1                                                                                                                                                    */
/*  DISCRIPTION  : 납품옵션관리                                                                                                                    */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_44B_1]
	@flag			char(01),	/* S:Select M:update A:insert */
	@gaijung		varchar(04),
	@order_select	char(01)='',
	@price_decision	char(01)='',
	@date_flag		char(01)='',            --단다
	@acpt_option	char(03)='',
	@acpt_zero_flag	char(01)='',
	@acpt_delay1	int=0,
	@acpt_delay2	int=0,
 	@qty_acpt		int=0,
	@insp_qty_flag	char(01)='',   --검수여부
	@to_store		varchar(10)='',
	@user_id		varchar(10)=''
AS
--exec mrp.dbo.sp_mrp_44b_1 'S','ELES'

	declare	@zr03_price_decision	char(1),		--*.주문단가결정구분 (1)입력단가적용 (2)적용단가MAST참조 ***
			@zr03_acpt_option	char(3),		--* 납품단가적용구분 (1)입력단가 (2)적용단가 (3)주문시단가적용***
			@zr03_acpt_zero_flag	char(1),		--*납품시단가허용구분(Y)단가ZERO허용(N)단가ZERO처리불가***
			@zr03_date_flag		char(1),		--* 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자***
			@zr03_acpt_delay1	smallint,		--* 납기전허용일수 ***
			@zr03_acpt_delay2	smallint,		--* 납기후허용일수***
			@zr03_qty_acpt		float,		--* 납품허용수량% ***
			@zr03_to_store		varchar(6),	--* 대표창고 ***
			@zr03_insp_qty_flag	char(01)		--* 검수여부 *


	if @flag = 'S'
		select	gaijung,
				order_select,
				price_decision,
				acpt_option1,
				acpt_option2,
				acpt_option3,
				acpt_zero_flag,
				date_flag,
				acpt_delay1,
				acpt_delay2,
				qty_acpt,
				to_store,
				insp_qty_flag,
				updater=isnull(updater,''),
				update_date=isnull(convert(varchar(24),update_date,120),'')
		FROM 	T_MZR_03 (nolock)
		where   left(gaijung,2) = left(@gaijung,2) 
		ORDER BY gaijung,order_select

--sp_fields T_MZR_03
	else
	begin 
		if @flag = 'M'
			if  exists (select *
					from T_MZR_03 a
					where gaijung=@gaijung
					and order_select = @order_select)
			begin
				update a set
					price_decision=@price_decision,
					acpt_option1=left(@acpt_option,1),
					acpt_option2=substring(@acpt_option,2,1),
					acpt_option3=substring(@acpt_option,3,1),
					acpt_zero_flag=@acpt_zero_flag,
					date_flag=@date_flag,
					acpt_delay1=@acpt_delay1,
					acpt_delay2=@acpt_delay2,
					qty_acpt=@qty_acpt,
					to_store=@to_store,
					insp_qty_flag=@insp_qty_flag,
					updater=@user_id,
					update_date=getdate()
				from T_MZR_03 a
				where gaijung=@gaijung
				and order_select = @order_select
			end
			else 
			begin
				insert into T_MZR_03 values (
						@gaijung,
						@order_select,
						@price_decision,
						left(@acpt_option,1),
						substring(@acpt_option,2,1),
						substring(@acpt_option,3,1),
						@acpt_zero_flag,
						@date_flag,
						@acpt_delay1,
						@acpt_delay2,
						@qty_acpt,
						@to_store,
						@insp_qty_flag,
						@user_id,
						getdate())
			end
		else if @flag = 'D'
		begin
			delete a
			from T_MZR_03 a
			where gaijung=@gaijung
			and order_select = @order_select	
		end
		select 0,'OK'
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4AH_1                                                                                                                                                    */
/*  DISCRIPTION  : 대치품목관리                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/11     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_4AH_1]
	@flag			char(01),	/* S:Select M:update A:insert */
	@item_no		varchar(15),
	@item_no_r		varchar(15)='',
	@updater		varchar(10)=''
AS
--exec MRP.dbo.SP_MRP_4AH_1 'S',''
--exec MRP.dbo.SP_MRP_4AH_1 'A','aea13c133*a','aea13c133*a','lgjjg'
	declare	@status		char(01),
			@out_msg	varchar(100)

	select @status='0',@out_msg='OK'
	select @item_no=upper(@item_no),@item_no_r=upper(@item_no_r)

	if @flag = 'S'
		SELECT 	item_no,
			item_no_desc=master.dbo.fGetItemDesc(a.item_no),
			item_no_r,
			item_no_r_desc=master.dbo.fGetItemDesc(a.item_no_r),
			updater,
			update_date=convert(varchar(10),update_date,112)
		FROM 	T_MYA_16 a (nolock)
		where   (@item_no<'0' or item_no like @item_no + '%')
		ORDER BY item_no,item_no_r

	else
	begin 
		if @flag in ('M','A')
		begin
			if  exists (select *
					from T_MYA_16 a
					where item_no=@item_no
					and item_no_r=@item_no_r)
			begin
				select @status='1',@out_msg=' Already exists ???? ,확인바람'
			end

			else if  @item_no=@item_no_r
			begin
				select @status='1',@out_msg='동일한 Item을 등록할수 없음'
			end

			else if  not exists (select *
					from el_cd.dbo.t_cx_060
					where item_no=@item_no)
			begin
				select @status='1',@out_msg=@item_no + '이 Item M/S 에 존재하지않음????'
			end
			
			else if  not exists (select *
					from el_cd.dbo.t_cx_060
					where item_no=@item_no_r)
			begin
				select @status='1',@out_msg=@item_no_r + '이 Item M/S 에 존재하지않음????'
			end
			else
			begin
				insert into T_MYA_16 values (
						@item_no,
						@item_no_r,
						@updater,
						getdate())
			end
		end
		else if @flag = 'D'
		begin
			delete a
			from T_MYA_16 a
			where item_no=@item_no
			and item_no_r = @item_no_r
		end

	end
		
	select status=@status,out_msg=@out_msg;

/*****************************************************************************************/
/*                                                                               	     */
/*  PROCEDURE    : SP_MRP_4AP_1	                                          		         */
/*                     							  	                                     */
/*  									                                                 */
/*  DESCRIPTION  :                                                                       */
/*  ALTER  SE    :                                      		  			             */
/*                     							                                     	 */
/*  CREATE_DAY   :                                                      			     */
/*                                                                        				 */
/*		>> MODIFICATION LOG <<					                                         */ 
/*							                  	                                         */
/*									                                                     */
/*  DATE        REQUEST #       S.E NAME         DESCRIPTION	                 	  	 */
/*  -------------------------------------------------------------------------------------*/
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경          */
/*****************************************************************************************/

/** schedule job 관리 ***/

--Exec MRP.dbo.SP_MRP_4AP_1 'M','AEG01C183*A_OLD','MT','S','1024709', 0 , 0 ,'0',' ', 0  , 0 , 0 ,'0','N',' ',' ','JGES','    ','       ','',' ',0 ,'WON','C',' '
--exec MRP.dbo.SP_MRP_4AP_1 'M','AEG01C183*A_OLD','EA','S','1024709',  , 0 ,'0',' ',  , 0 , 0 ,'0','N',' ',' ','JGES','    ','       ','',' ',0 ,'WON','C',' '
--exec MRP.dbo.SP_MRP_4AP_1 'M','AEG01C183*A_OLD','MT','S','1024709', '' , 0 ,'0',' ', ''  , 0 , 0 ,'0','N',' ',' ','JGES','    ','       ','',' ',0 ,'WON','C',' '

CREATE PROCEDURE [dbo].[SP_MRP_4AP_1]
	@flag				char(01),
	@item_no			varchar(15)='',
	@item_unit			varchar(02)='',
	@order_select		char(01)='',
	@vendor				varchar(08)='',
	@vendor2			varchar(08)='',
	@min_order_qty		int=0,
	@multiple_qty		int=0,
	@auto_order_flag	char(01)='',
	@keep_flag			char(01)='',
	@lead_time			int=0,
	@lead_time1			int=0,
	@lead_time2			int=0,
	@insp_select		char(01)='',
	@prod_stop_flag		char(01)='',
	@mold_flag			char(01)='',   	     	
	@plan_post_person	varchar(04)='',
	@po_post_person		varchar(04)='',
	@maker				varchar(07)='',
	@store				varchar(06)='',
	@abc				char(01)='',
	@loss_rate			real=0.0,
	@money_unit			varchar(03)='',
	@item_select		char(01)='',
	@order_style		char(01)=''
as
--S_MRP_4AP_1 'S'

	if @flag = 'S'
	BEGIN
		set rowcount 100
		select	item_no=isnull(item_no,''),
				eng_desc=isnull(eng_desc,''),
				item_unit=isnull(item_unit,''),
				order_select=isnull(order_select,''),
				
				vendor=isnull(vendor,''),
				vendor2=isnull(vendor2,''),
				
				min_order_qty=isnull(min_order_qty,0),
				multiple_qty=isnull(multiple_qty,0),
				
				auto_order_flag=isnull(auto_order_flag,'N'),
				keep_flag=isnull(keep_flag,''),

				lead_time=isnull(lead_time,0),
				lead_time1=isnull(lead_time1,0),
				lead_time2=isnull(lead_time2,0),
				
				insp_select=isnull(insp_select,'N'),
				prod_stop_flag=isnull(prod_stop_flag,'N'),
				mold_flag=isnull(mold_flag,'N'),
			     	     	
				plan_post_person=isnull(plan_post_person,''),
				po_post_person=isnull(po_post_person,''),
				
				maker=isnull(maker,''),
				store=isnull(store,''),
				abc=isnull(abc,''),
				loss_rate=isnull(loss_rate,0),
				money_unit=isnull(money_unit,''),
				item_select=isnull(item_select,''),
				order_style=isnull(order_style,''),
				draw_no=isnull(draw_no,''),
				size=isnull(size,''),
				quality=isnull(quality,''),
				price=0
		from EL_CD..T_CX_060
		where item_no  between rtrim(@item_no) and rtrim(@item_no)+'ZZZ'
		set rowcount 0
	end
	else if @flag IN ( 'M','A')
	begin
		select @item_unit=upper(@item_unit)
		select @plan_post_person=upper(@plan_post_person)
		select @po_post_person=upper(@po_post_person)
		select @store=upper(@store)
		select @insp_select=upper(@insp_select)
		select @prod_stop_flag=upper(@prod_stop_flag)
		select @mold_flag=upper(@mold_flag)
	
	
		declare @ori_order_select varchar(01)

		select @ori_order_select=order_select
		from el_cd..T_CX_060 a
		where item_no = @item_no

		if @flag = 'M' and
			((@ori_order_select='I' and @order_select<>'I')or
			 (@ori_order_select<>'I' and @order_select='I')) 
		begin
			select status = '1', out_msg = '도입 변경은 MRPCS에서 변경하세요.'
			return
		end


		update a set
			item_unit=@item_unit,
			order_select=@order_select,
			
			vendor=@vendor,
			vendor2=@vendor2,
			
			min_order_qty=@min_order_qty,
			multiple_qty=@multiple_qty,
			
			auto_order_flag=(CASE when @auto_order_flag < '0' and @order_select = 'I' 
								then 'N' else @auto_order_flag end),
			keep_flag=@keep_flag,

			lead_time=@lead_time,
			lead_time1=@lead_time1,
			lead_time2=@lead_time2,
			
			insp_select=@insp_select,
			prod_stop_flag=@prod_stop_flag,
			mold_flag=@mold_flag,
			     	     	
			plan_post_person=@plan_post_person,
			po_post_person=@po_post_person,
			
			maker=@maker,
			store=@store,
			abc=@abc,
			loss_rate=@loss_rate,
			money_unit=@money_unit,
			item_select=@item_select,
			order_style=@order_style

		from EL_CD..T_CX_060 a
		where item_no=@item_no
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4CJ_1                                                                                                                                                    */
/*  DISCRIPTION  : BOM Management                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/10     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_4CJ_1]
	@flag		char(01),	/** A:insert  m:update***/
	@item_no	varchar(15),
	@o_sh_no	varchar(04)='',
	@o_line_no	varchar(02)='',
	@citem_no	varchar(15)='',
	@o_unit_qty	varchar(10)='',
	@o_weight	varchar(10)='',
	@mark3		char(01)='',
	@mark4		char(01)='',
	@matl_size	varchar(30)=''

AS
set nocount on

	declare	@sh_no		smallint,
			@line_no	smallint,
			@unit_qty	float,
			@weight		float

	if @flag='S'
	begin
		select	a.*,
				eng_desc=master.dbo.fGetItemDesc(a.citem_no)
		from EL_CD.dbo.T_CX_062 a
		where a.item_no=@item_no
		order by a.sh_no,a.line_no

		if not exists (select * from el_cd.dbo.t_cx_060 where item_no=@item_no)
			select status='1',out_msg=' Item No를 재입력하세요 ??'
		else
			select status='0',out_msg=' Inquiry OK ...'

		return
	end

	if @o_sh_no < '00' and isnumeric(@o_sh_no) = 0
	begin
		select status='1',out_msg=' Sheet No를 재입력하세요 ??'
		return
	end
	select @sh_no=convert(smallint,@o_sh_no)

	if @o_line_no < '00' and isnumeric(@o_line_no) = 0
	begin
		select status='1',out_msg=' Line No를 재입력하세요 ??'
		return
	end
	select @line_no=convert(smallint,@o_line_no)

	if @flag='D'
	begin
		delete a
		from EL_CD.dbo.T_CX_062 a
		where a.item_no=@item_no
		and a.sh_no=@sh_no	
		and a.line_no = @line_no

		select status='0',out_msg=' Delete OK ...'
		return
	end
	

	if not exists (select * from el_cd.dbo.t_cx_060 where item_no=@citem_no)
	begin
		select status='1',out_msg=' Child Item No를 재입력하세요 ??'
		return
	end
	
	if @o_unit_qty > '0' and isnumeric(@o_unit_qty)=0
	begin
		select status='1',out_msg=' Unit Qty를 재입력하세요 ??'
		return
	end
	select @unit_qty=convert(float,@o_unit_qty)

	if @mark3 > '0' and @mark3 not in ('S','X')
	begin
		select status='1',out_msg=' Sale Type을 재입력하세요 ??'
		return
	end

	if @mark4 > '0' and @mark4 not in ('I','D','S','X','Z')
	begin
		select status='1',out_msg=' Special Supply를 재입력하세요 ??'
		return
	end


	if @o_weight > '0' and isnumeric(@o_weight)=0
	begin
		select status='1',out_msg=' Weight를 재입력하세요 ??'
		return
	end
	select @weight=convert(float,@o_weight)

	
	if @flag = 'M'
	begin
		if not exists (select *
				from EL_CD.dbo.T_CX_062 a
				where a.item_no=@item_no
				and a.sh_no=@sh_no	
				and a.line_no = @line_no)
		begin
			insert into EL_CD.dbo.T_CX_062
			select	item_no=upper(@item_no),
					sh_no=@sh_no,
					line_no=@line_no,
					citem_no=upper(@citem_no),
					unit_qty=@unit_qty,
					date_kit=null,
					part_all='',
					weight=@weight,
					from_method='',
					to_method='',
					mark = '  '+convert(char(01),upper(@mark3))+convert(char(01),upper(@mark4)),
					matl_size=@matl_size

			select status='0',out_msg=' Insert OK ...'
		end
		else
		begin
			update a set
				citem_no=upper(@citem_no),
				unit_qty=@unit_qty,
				weight=@weight,
				mark = convert(char(02),left(a.mark,2))+convert(char(01),upper(@mark3))+convert(char(01),upper(@mark4)),
				matl_size=@matl_size
			from EL_CD.dbo.T_CX_062 a
			where a.item_no=@item_no
			and a.sh_no=@sh_no	
			and a.line_no = @line_no

			select status='0',out_msg=' Update OK ...'
		end
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4AQ_1                                                                                    */
/*  DISCRIPTION  : 거래처조회 & 관리                                                                                   */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                        */
/*  ---------------------------------------------------------------                                                */
/* 2010/03/08     MRP Downsizing Project   J.J.Park      Initialize                                                */
/* 2023-02-10  주소자리 60 -> 500으로 변경 반영                                                                           */
/*******************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_4QA_1]
	@flag			char(01),	--S:조회, M:Update,D:Delete,A:insert 
	@Vendor			varchar(08),
	@brief_trade	varchar(30),
	@po_post_person	varchar(04)='',
	@business_no	varchar(15)='',
	@repnt_name		varchar(20)='',
--	@repnt_id_no	varchar(20)='',
	@tel_no			varchar(20)='',
	@value_vendor	varchar(01)='',
	@address		varchar(500)='',
	@business_kind	varchar(01)='',
	@user_id		varchar(10)=''
AS
--exec MRP.dbo.SP_MRP_4QA_1 'A','3000000','','','','','','','','','lgjjg'

	if @flag = 'S'  -- Vendor
	begin
		set rowcount 100
		if @brief_trade = ''
			select	trade_no,
					brief_trade,
					po_post_person,
					business_no,
					repnt_name,
					repnt_id_no,
					area_tel_no,
					tel_no,
					date_found,
					business_kind,
					date_enter=convert(varchar(24),date_enter,121),
					pay_con,
					value_vendor,
					address,
					post,
					person,
					input_flag,
					last_update=convert(varchar(24),last_update,120),
					old_trade_no,
					update_user_id
			FROM 	el_cd..T_cx_080 a
			where   trade_no like ltrim(@Vendor) + '%'
			ORDER BY trade_no
		else
			select	trade_no,
					brief_trade,
					po_post_person,
					business_no,
					repnt_name,
					repnt_id_no,
					area_tel_no,
					tel_no,
					date_found,
					business_kind,
					date_enter=convert(varchar(24),date_enter,121),
					pay_con,
					value_vendor,
					address,
					post,
					person,
					input_flag,
					last_update=convert(varchar(24),last_update,120),
					old_trade_no,
					update_user_id
			FROM 	el_cd..T_cx_080 a
			where   brief_trade like '%' + ltrim(@brief_trade) + '%'
			ORDER BY brief_trade
		set rowcount 0

	end
	else if @flag = 'M'
	begin
		if not exists (select *
						 FROM el_cd..T_cx_080 a
						where trade_no = @vendor)
		begin
			insert into EL_CD..T_cx_080
			        ( trade_no , brief_trade, po_post_person, business_no, repnt_name, repnt_id_no, area_tel_no, tel_no  
                         , date_found, business_kind, date_enter, pay_con, value_vendor, address, post, person, input_flag, last_update  
                         , old_trade_no, update_user_id, qc_apply_flag, ASIS_trade_no )  
			select	trade_no=@vendor,
					@brief_trade,
					@po_post_person,
					@business_no,
					@repnt_name,
					'',		--,@repnt_id_no
					area_tel_no='',
					@tel_no,
					date_found=null,
					@business_kind,
					date_enter=getdate(),
					pay_con='',
					@value_vendor,
					@address,
					post='',
					person='',
					input_flag='',
					last_update=getdate(),
					old_trade_no='',
					update_user_id=@user_id,
					qc_apply_flag='' ,
					@vendor

			select status='0',out_msg='  Insert OK ...'
		end
		else
		begin	
			update a set
				trade_no=@vendor,
				brief_trade=@brief_trade,
				po_post_person=@po_post_person,
				business_no=@business_no,
				repnt_name=@repnt_name,
				tel_no=@tel_no,
				business_kind=@business_kind,
				value_vendor=@value_vendor,
				address=@address,
				last_update=getdate(),
				update_user_id=@user_id 
				--ASIS_trade_no = @vendor
			FROM 	el_cd..T_cx_080 a
			where   trade_no = @vendor

			select status='0',out_msg='  Update OK ...'
		end
	end
	else if @flag = 'D'
	begin
		if not exists (select *
			FROM 	el_cd..T_cx_080 a
			where   trade_no = @vendor)
		begin
			select status='1',out_msg=' Vendor Not Found ???'
			return
		end

		delete a
		FROM 	el_cd..T_cx_080 a
		where   trade_no = @vendor
	end;

/*********************************************************************************************************************/
/*  SP NAME      : SP_MRP_4SI_1                                                                                      */
/*  DISCRIPTION  :  단가 조회 & 재료비관리                                                                           */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/01/29     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_4SI_1]
	@flag			char(01),
	@item_no		varchar(15),
	@price_sort		varchar(01),
	@vendor			varchar(08)='',
	@supply			varchar(01)='',
	@apply_date		char(08)='',
	@matl_price		float=0
as

	if @flag = 'S'
	begin
		select	eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.vendor,
				vendor_name=master.dbo.fGetVendorName(a.vendor),
				a.order_select,
				work_mtd,
				money_unit,
				seq,
				date_apply_from=convert(char(08),date_apply_from,112),
				apply_flag,
				apply_price,
				etc_price,
				agreement_doc,
				price_condition,
				apply_lot,
				date_entry=convert(varchar(20),date_entry,120),
				emp_id,
				change_reason,
				matl_price,
				lobar_time,
				labor_rate,
				retrieve_rate,
				date_update=convert(varchar(20),date_update,120),
				etc
		from EL_CD..T_CX_610 a
		where item_no = @item_no--master.dbo.fGetMrpSeedItemno(@item_no)
		and price_sort=@price_sort
		and (@vendor<'0' or vendor=@vendor)
		and (@supply<'0' or a.order_select=@supply)
		and (isdate(@apply_date)=0 or  date_apply_from >= @apply_date)
		order by date_apply_from desc, date_entry desc
	end
	else if @flag = 'M'
	begin
		update a set
			matl_price=@matl_price
		from EL_CD..T_CX_610 a
		where item_no = @item_no
		and price_sort=@price_sort
		and vendor=@vendor
		and a.order_select=@supply
		and date_apply_from = @apply_date
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4SU_1                                                                                                                                                    */
/*  DISCRIPTION  : Mold Management                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/05     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_4SU_1]
	@flag			char(01),	/** S:Inquiry M:update D:Delete A:insert ***/
	@mold_sort		char(01),
	@item_no		varchar(15),
	@vendor			varchar(08)='',
	@mold_status	char(01)='',
	@mold_price		varchar(15)='',
	@qty_mold_limit	varchar(15)='',
	@date_mold		varchar(08)='',
	@user_id		varchar(10)=''
AS
set nocount on

--exec MRP.dbo.SP_MRP_4SU_1 'S','A',''

	if @flag='S'
		select	mold_sort,
				a.item_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				a.vendor,
				brief_trade=master.dbo.fGetVendorName(a.vendor),
				mold_price,
				qty_mold_limit,
				date_mold=convert(char(08),date_mold,112),
				qty_mold_total,
				mold_status,
				date_entry=convert(varchar(24),a.date_entry,120),
				date_update=convert(varchar(24),a.date_update,120),
				update_user_id
		from	mrp.dbo.t_mya_152  a
		where	a.mold_sort = @mold_sort
		and	a.item_no between @item_no and rtrim(@item_no)+'ZZZZ'
		order by a.item_no,a.vendor
	else if @flag = 'M'
	begin
		if not exists (select *
				from mrp.dbo.T_MYA_152 a
				where	a.mold_sort = @mold_sort
				and	a.item_no = @item_no
				and	a.vendor = @vendor)
			insert into mrp.dbo.T_MYA_152
			select	@mold_sort,
					upper(@item_no),
					@vendor,
					convert(float,@mold_price),
					convert(float,@qty_mold_limit),
					@date_mold,
					0,
					@mold_status,
					getdate(),
					getdate(),
					@user_id	
		else
		begin	
			update a set
				mold_price=convert(float,@mold_price),
				qty_mold_limit=convert(float,@qty_mold_limit),
				date_mold=@date_mold,
				mold_status=@mold_status,
				date_update=getdate(),
				update_user_id=@user_id
			from	mrp.dbo.t_mya_152  a
			where	a.mold_sort = @mold_sort
			and	a.item_no = @item_no
			and	a.vendor = @vendor

			if @mold_status in ('A')
				update a set
					mold_flag='Y'
				from	el_cd.dbo.t_ya_060  a
				where	a.item_no = @item_no
		end
	end
	else if @flag='D'
		delete a
		from	mrp.dbo.t_mya_152  a
		where	a.mold_sort = @mold_sort
		and	a.item_no = @item_no
		and	a.vendor = @vendor;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4UA_1                                                                                                                                                    */
/*  DISCRIPTION  : Sampling Table 관리 (시료크기)                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_4UA_1]
	@flag				char(01),
	@insp_range			varchar(02)='',
	@sample_times		int=0,
	@acpt_quality_level	varchar(10),
	@sample_letter		char(01)='',
	@sample_size		int=0,
	@acpt_qty			int=0,
	@reject_qty			int=0
as
--S_MRP_001_1 'S'
--	exec MRP.dbo.SP_MRP_4UB_1 'S',''

	select @insp_range=upper(@insp_range)
	select @sample_letter=upper(@sample_letter)

	if @flag = 'S'
		select	insp_range,
				sample_times,
				acpt_quality_level,
				sample_letter,
				sample_size,
				acpt_qty,
				reject_qty
		from T_MYI_11
		where (@insp_range < '0' OR insp_range like rtrim(@insp_range)+'%')
		and (@acpt_quality_level < '0' OR acpt_quality_level like rtrim(@acpt_quality_level)+'%')
		order by insp_range,sample_times,acpt_quality_level,sample_letter
	else if @flag = 'M'
	begin
		if not exists (	select 'Y'
						from T_MYI_11 a
						where insp_range=@insp_range
						and sample_times=@sample_times
						and acpt_quality_level=@acpt_quality_level
						and sample_letter=@sample_letter)
		begin			
			insert into T_MYI_11
			select	@insp_range,
					@sample_times,
					@acpt_quality_level,
					@sample_letter,
					@sample_size,
					@acpt_qty,
					@reject_qty
		end
		else 
		begin
			update a set
				sample_size=@sample_size,
				acpt_qty=@acpt_qty,
				reject_qty=@reject_qty
			from T_MYI_11 a
			where insp_range=@insp_range
			and sample_times=@sample_times
			and acpt_quality_level=@acpt_quality_level
			and sample_letter=@sample_letter

		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from T_MYI_11 a
		where insp_range=@insp_range
		and sample_times=@sample_times
		and acpt_quality_level=@acpt_quality_level
		and sample_letter=@sample_letter
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_4UB_1                                                                                                                                                    */
/*  DISCRIPTION  : Sampling Table 관리 (시료문자)                                                                                                                                   */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_4UB_1]
	@flag			char(01),
	@insp_level		varchar(02)='',
	@sample_letter	char(01)='',
	@lot_size_from	int=0,
	@lot_size_to	int=0
as
BEGIN
--	exec MRP.dbo.SP_MRP_4UB_1 'S',''

	select @insp_level=upper(@insp_level)
	select @sample_letter=upper(@sample_letter)

	if @flag = 'S'
		select	insp_level,sample_letter,lot_size_from,lot_size_to
		from T_MYI_13
		where (@insp_level < '0' OR insp_level like rtrim(@insp_level)+'%')
		order by insp_level,sample_letter
	else if @flag = 'M'
	begin
		if not exists (select *
						 FROM T_MYI_13 a
						where insp_level = @insp_level
						and sample_letter = @sample_letter )
		begin
			insert into T_MYI_13
			select	@insp_level,@sample_letter,@lot_size_from,@lot_size_to
		end
		else
		begin
			update a set
				lot_size_from=@lot_size_from,
				lot_size_to=@lot_size_to
			from T_MYI_13 a
			where insp_level=@insp_level
			and sample_letter=@sample_letter
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from T_MYI_13 a
		where insp_level=@insp_level
		and sample_letter=@sample_letter
	end
END;

/*****************************************************************************************/
/*                                                                               	     */
/*  PROCEDURE    : SP_MRP_4UF_1	                                          		         */
/*                     							  	                                     */
/*  									                                                 */
/*  DESCRIPTION  :                                                                       */
/*  ALTER  SE    :                                      		  			             */
/*                     							                                     	 */
/*  CREATE_DAY   :                                                      			     */
/*                                                                        				 */
/*		>> MODIFICATION LOG <<					                                         */ 
/*							                  	                                         */
/*									                                                     */
/*  DATE        REQUEST #       S.E NAME         DESCRIPTION	                 	  	 */
/*  -------------------------------------------------------------------------------------*/
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경          */
/*****************************************************************************************/
/** sampling rule  관리***/

/*
select a.*,b.program_name 
--update b set program_name='Production'

from common..app_prog_mem_info a,common..program_info b 
where len(a.level)=3 and  b.program=a.program
and a.level='002' 
*/

CREATE PROCEDURE [dbo].[SP_MRP_4UF_1]
	@flag			char(01),
	@item_no		varchar(15)='',
	@vendor			varchar(08)='',
	@insp_mtd		varchar(02)='',
	@insp_level		varchar(02)='',
	@sample_times	int=0,
	@insp_range		varchar(02)='',
	@acpt_quality_level	varchar(10)=''
as
--SP_MRP_4UF_1 's'
--exec MRP.dbo.SP_MRP_4UF_1 'A','AEG08C734*D','1012613','SA','S3',1,'NI','1.000'

	select @item_no=upper(@item_no)
	select @insp_mtd=upper(@insp_mtd)
	select @insp_level=upper(@insp_level)
	select @insp_range=upper(@insp_range)

	if @flag = 'S'
	begin
		set rowcount 100
		select	item_no,
				vendor,
				insp_mtd,
				insp_level,
				sample_times,
				insp_range,
				acpt_quality_level,
				last_range,
				insp_advan,
				date_insp_range,
				date_mtd,
				deliv_total,
				qty_lot_acpt,
				qty_lot_fail,
				qty_acpt_cont,
				qty_fail_cont,
				insp_cont_flag,
				deliv_delay,
				amut_deliv,
				date_deliv,
				date_order,
				qty_acpt_total,
				qty_return_total,
				date_entry,
				date_update=convert(varchar(30),date_update,121)
		from T_MYA_151
		where item_no between rtrim(@item_no) and rtrim(@item_no)+'ZZZZZ'
		and vendor between rtrim(@vendor) and rtrim(@vendor)+'ZZZZ'
		order by item_no,vendor
		set rowcount 0
	end
	else if @flag = 'M'
	begin
		if not exists ( select 'Y'
						from T_MYA_151 a
						where item_no=@item_no
						and vendor=@vendor )
		begin	
			insert into T_MYA_151 (item_no,	vendor,	insp_mtd,	insp_level,	sample_times,
					insp_range,	acpt_quality_level,	date_entry,	date_update)
			values (@item_no,	@vendor,	@insp_mtd,	@insp_level,	@sample_times,
					@insp_range,	@acpt_quality_level,	getdate(),	getdate() )
		end
		else 
		begin
			update a set
				insp_mtd=@insp_mtd,
				insp_level=@insp_level,
				sample_times=@sample_times,
				insp_range=@insp_range,
				acpt_quality_level=@acpt_quality_level,
				date_update=getdate()
			from T_MYA_151 a
			where item_no=@item_no
			and vendor=@vendor
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from T_MYA_151 a
		where item_no=@item_no
		and vendor=@vendor
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_57H_1                                                                                                                                                    */
/*  DISCRIPTION  : 품목별 창고이동처리용 조회                                                                                                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_57H_1]
	@gaijung		varchar(04),
	@item_no		varchar(15),
	@from_due_date	varchar(08),
	@to_due_date	varchar(08),
	@select			char(1) /*Y:이동 N:생산*/
AS
SET NOCOUNT ON

--exec mrp.dbo.sp_mrp_57h_1 'ELES','2R21105*A','20100801','20100820','Y', 'lgjjg'

	if @select = 'Y'	
	begin
		select	prod_no=a.project_no+a.mfg_no,
				hogi,
				part,
				part_seq,
				item_no,
				due_date=convert(char(08),due_date,112),
				product_code,
				market_flag,
				order_select,
				item_group_sub,
				block,
				mp_flag,
				concern_order_no,
				concern_order_date,
				cont_qty,
				cont_cost,
				cont_amt,
				last_in_date,
				last_out_date,
				ao_time,
				run_status,
				run_date,
				upd_date,
				draw_cfm_date,
				sale_qty,
				trade_no,
				plan_due_date,
				cfrm_date,
				deliv_date,
				out_date,
				matl_post_person,
				po_post_person,
				wh_post_person,
				ship_post_person,
				rslt_date,
				confirm_flag,
				ship_flag,
				vbox_code,
				box_no,
				out_factory_flag,
				treat_method,
				packing_confirm_date,
				prod_qty,
				proc_qty=cont_qty-prod_qty,
				date_ao,
				date_po,
				date_kit,
				cause_code,
				prod_amt,
				sale_amt,
				management_flag,
				giho_draw_flag,
				select_draw_flag,
				amt_divide_flag,
				add_vbox_code,
				part_pdm,
				gaijung
		from EL_CD..T_CA_011 a with (index=IX_CA_011_8 nolock)
		where a.item_no =  @item_no
		and a.due_date between @from_due_date and @to_due_date
		and left(a.gaijung,2)=left(@gaijung,2)
		and a.prod_qty < cont_qty
		and a.cause_code <> 'ZZ'
		and a.order_select not in ('A','M')
		and a.gaijung = @gaijung
		and a.part <> 'RA'
		and a.ship_flag = 'Y'
		and out_factory_flag not in ('Y','D','A')
		and date_ao is not null
		and confirm_flag in ('Y','A')
		and isnull(treat_method,'') <> 'D' 
--		and len(rtrim(concern_order_no)) <> 8
	end
	else if @select = 'N'
	begin
		select	prod_no=a.project_no+a.mfg_no,
				hogi,
				part,
				part_seq,
				item_no,
				due_date=convert(char(08),due_date,112),
				product_code,
				market_flag,
				order_select,
				item_group_sub,
				block,
				mp_flag,
				concern_order_no,
				concern_order_date,
				cont_qty,
				cont_cost,
				cont_amt,
				last_in_date,
				last_out_date,
				ao_time,
				run_status,
				run_date,
				upd_date,
				draw_cfm_date,
				sale_qty,
				trade_no,
				plan_due_date,
				cfrm_date,
				deliv_date,
				out_date,
				matl_post_person,
				po_post_person,
				wh_post_person,
				ship_post_person,
				rslt_date,
				confirm_flag,
				ship_flag,
				vbox_code,
				box_no,
				out_factory_flag,
				treat_method,
				packing_confirm_date,
				prod_qty,
				proc_qty=cont_qty-prod_qty,
				date_ao,
				date_po,
				date_kit,
				cause_code,
				prod_amt,
				sale_amt,
				management_flag,
				giho_draw_flag,
				select_draw_flag,
				amt_divide_flag,
				add_vbox_code,
				part_pdm,
				gaijung
		from EL_CD..T_CA_011 a with (index=IX_CA_011_8 nolock)
		where a.item_no =  @item_no
		and a.due_date between @from_due_date and @to_due_date
		and left(a.gaijung,2)=left(@gaijung,2)
		and ( a.prod_qty = cont_qty or a.cause_code = 'ZZ')
		and a.order_select not in ('A','M')
		and a.gaijung = @gaijung
		and a.part <> 'RA'
		and a.ship_flag = 'Y'
		and out_factory_flag not in ('Y','D','A')
		and date_ao is not null
		and confirm_flag in ('Y','A')
		and treat_method <> 'D' 
--		and len(rtrim(concern_order_no)) <> 8
	end
	else
	begin
		select	prod_no=a.project_no+a.mfg_no,
				hogi,
				part,
				part_seq,
				item_no,
				due_date=convert(char(08),due_date,112),
				product_code,
				market_flag,
				order_select,
				item_group_sub,
				block,
				mp_flag,
				concern_order_no,
				concern_order_date,
				cont_qty,
				cont_cost,
				cont_amt,
				last_in_date,
				last_out_date,
				ao_time,
				run_status,
				run_date,
				upd_date,
				draw_cfm_date,
				sale_qty,
				trade_no,
				plan_due_date,
				cfrm_date,
				deliv_date,
				out_date,
				matl_post_person,
				po_post_person,
				wh_post_person,
				ship_post_person,
				rslt_date,
				confirm_flag,
				ship_flag,
				vbox_code,
				box_no,
				out_factory_flag,
				treat_method,
				packing_confirm_date,
				prod_qty,
				proc_qty=cont_qty-prod_qty,
				date_ao,
				date_po,
				date_kit,
				cause_code,
				prod_amt,
				sale_amt,
				management_flag,
				giho_draw_flag,
				select_draw_flag,
				amt_divide_flag,
				add_vbox_code,
				part_pdm,
				gaijung
		from EL_CD..T_CA_011 a with (index=IX_CA_011_8 nolock)
		where a.item_no =  @item_no
		and a.due_date between @from_due_date and @to_due_date
		and left(a.gaijung,2)=left(@gaijung,2)
		and a.order_select not in ('A','M')
		and a.gaijung = @gaijung
		and a.part <> 'RA'
		and a.ship_flag = 'Y'
		and out_factory_flag not in ('Y','D','A')
		and date_ao is not null
		and confirm_flag in ('Y','A')
		and isnull(treat_method,'') <> 'D' 
--JJG 테스트 후 풀기		and len(rtrim(concern_order_no)) <> 8
	end

	if not exists (select * from el_cd..t_cx_060 a where a.item_no=@item_no )
	begin
		select status='1',out_msg=' Item Not Found ????',eng_desc='????'
		return
	end

	select status='0',out_msg=' Inquiry OK ...',
			eng_desc=master.dbo.fGetItemDesc(@item_no), 
			stock_qty=(select isnull(sum(b.qty_stock),0) 
									from t_mva_061 b 
									where b.item_no = @item_no 
									and b.gaijung = @gaijung);

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_57H_2                                                                                                                                                    */
/*  DISCRIPTION  : 수불항번별 창고이동처리                                                                                                                     */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_57H_2]
	@gaijung		varchar(04),
	@project_no		varchar(11),
	@mfg_no			varchar(03),
	@part			varchar(02),
	@part_seq		varchar(04),
	@date_io		varchar(08),
	@qty			float,
	@user_id		varchar(10)
AS
SET NOCOUNT ON

	declare	@status		char(01),
			@out_msg	varchar(100)

	if isdate(@date_io)=0
	begin
		select 	status='1',out_msg=' Please Check 출고일자 ???'
		return
	end

	exec SP_Common_Issuance_By_PartSeq 
		@gaijung,
		@project_no,
		@mfg_no,
		@part,
		@part_seq,
		@date_io,
		@qty,
		@user_id,
		@status		output,
		@out_msg	output

	select status=@status,out_msg=@out_msg;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_5AQ_1                                                                                                                                              */
/*  DISCRIPTION  :  수불대장 조회 & 수정                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_5AQ_1]
	@opt_flag		char(01),
	@prod_no		varchar(14)='',
	@part			varchar(02)='',
	@part_seq		varchar(04)='',
	@date_ao		varchar(08)='',
	@date_po		varchar(08)='',
	@user_id		varchar(08)=''

AS

--SP_MRP_5AQ_1 'S',''
--SP_MRP_5AQ_1 '2I08100600001'
set nocount on

	if @opt_flag = 'S'
	begin
		select	project_no,
				mfg_no,
				hogi,
				part,
				part_seq,
				item_no,
				due_date=convert(char(08),due_date,112),
				product_code,
				market_flag,
				order_select,
				item_group_sub,
				block,
				mp_flag,
				concern_order_no,
				concern_order_date=convert(char(08),concern_order_date,112),
				cont_qty,
				cont_cost,
				cont_amt,
				last_in_date=convert(char(08),last_in_date,112),
				last_out_date=convert(char(08),last_out_date,112),
				ao_time,
				run_status,
				run_date=convert(char(08),run_date,112),
				temp_order_flag,
				temp_order_cfrm_date=convert(char(08),temp_order_cfrm_date,112),
				upd_date=convert(char(08),upd_date,112),
				draw_cfm_date=convert(char(08),draw_cfm_date,112),
				sale_qty,
				trade_no,
				plan_due_date=convert(char(08),plan_due_date,112),
				cfrm_date=convert(char(08),cfrm_date,112),
				deliv_date=convert(char(08),deliv_date,112),
				out_date=convert(char(08),out_date,112),
				matl_post_person,
				po_post_person,
				wh_post_person,
				ship_post_person,
				rslt_date=convert(char(08),rslt_date,112),
				confirm_flag,
				ship_flag,
				vbox_code,
				box_no,
				out_factory_flag,
				treat_method,
				packing_confirm_date=convert(char(08),packing_confirm_date,112),
				prod_qty,
				date_ao=convert(char(08),date_ao,112),
				date_po=convert(char(08),date_po,112),
				date_kit=convert(char(08),date_kit,112),
				cause_code,
				prod_amt,
				sale_amt,
				management_flag,
				giho_draw_flag,
				select_draw_flag,
				amt_divide_flag,
				add_vbox_code,
				drawlastupdate,
				part_pdm,
				gaijung,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				prod_no=a.project_no+'/'+a.mfg_no+'/'+a.part+'/'+a.part_seq,
				brief_trade=master.dbo.fGetVendorName(a.trade_no)
		FROM EL_CD..T_CA_011 a
		WHERE a.project_no = left(@prod_no,11)
		and a.mfg_no=substring(@prod_no,12,3)
		and a.part=@part
		and a.part_seq=@part_seq 

--sp_fields T_CA_011
		select status='0',out_msg=' Inquiry OK ...'
	end
	else if @opt_flag = 'M'
	begin

		if @date_ao > '0' and isdate(@date_ao)=0
		begin
			select status='1',out_msg='발송발주일자를 재입력하세요???'
			return
		end

		if @date_po > '0' and isdate(@date_po)=0
		begin
			select status='1',out_msg='종속발주일자를 재입력하세요???'
			return
		end

		update a set
			date_ao=(case when @date_ao < '0' then null else @date_ao end),
			date_po=(case when @date_po < '0' then null else @date_po end)
		from el_cd.dbo.t_ca_011 a
		WHERE a.project_no = left(@prod_no,11)
		and a.mfg_no=substring(@prod_no,12,3)
		and a.part=@part
		and a.part_seq=@part_seq 

		select status='0',out_msg=' Update OK ...'
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_5T3_1                                                                                                                                                    */
/*  DISCRIPTION  : Part Remark 관리                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_5T3_1]
	@flag		char(01),
	@project_no	varchar(11),
	@mfg_no		varchar(3),
	@part		varchar(02) = '',
	@part_pdm	varchar(02) = '',
	@printseq	int=0,
	@remark		varchar(200)='',
	@user_id	varchar(07)=''
as
--exec mrp.dbo.SP_MRP_5T3_1 'S',','2009F  0300','E01',''

	select @project_no=upper(@project_no)
	select @mfg_no=upper(@mfg_no)
	select @part=upper(@part)
	select @part_pdm=upper(@part_pdm)

	if @flag = 'S'
		select	*
		from el_cd..t_cc_013
		where	project_no = @project_no
		  and	mfg_no = @mfg_no
		  and (@part < '0' or part =@part)
		order by part,part_pdm,printseq
	else if @flag = 'M'
	begin
		if not exists ( select 'Y'
						from EL_CD..T_CC_013 a
						where	project_no = @project_no
						and	mfg_no = @mfg_no
						and	part=@part
						and	part_pdm=@part_pdm
						and	printseq=@printseq )
		begin
			insert into EL_CD..T_CC_013
			select	@project_no,
					@mfg_no,
					@part,
					@part_pdm,
					@printseq,
					@remark,
					upd_emp_id=@user_id,
					upd_date=getdate()
		end
		else 
		begin
			update a set
				remark=@remark,
				upd_emp_id=@user_id,
				upd_date=getdate()
			from EL_CD..T_CC_013 a
			where	project_no = @project_no
			and	mfg_no = @mfg_no
			and	part=@part
			and	part_pdm=@part_pdm
			and	printseq=@printseq
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from EL_CD..T_CC_013 a
		where	project_no = @project_no
		and	mfg_no = @mfg_no
		and	part=@part
		and	part_pdm=@part_pdm
		and	printseq=@printseq

		insert into T_CC_013_DEL_LOG
		select	@project_no,@mfg_no,@part,
				@part_pdm,
				@printseq,
				SYSTEM_USER, host_name(), app_name(), getdate(),
				'DELETE'		
	end;

--******************************************************************************************************************/
--  SP NAME      : SP_MRP_6BB                                                                                                                                                    */
--  DISCRIPTION  : 주문일괄 확정                                                                                                                         */ 
--                                                                                                                                                                                                  */
--  >> MODIFICATION LOG <<                                                                                                                                                       */ 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
--  ---------------------------------------------------------------                                                                                  */
-- 2010/02/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
--*************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6BB]
	@job_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output

AS
SET NOCOUNT ON
--SP_GISF6BB 2

	declare	@o_gaijung	varchar(04),
			@order_no	varchar(08)

	select	@o_gaijung=mrp.dbo.fGetOption(@job_id,@page,'GAIJUNG')

	DECLARE TTT SCROLL CURSOR FOR
		select order_no
		from EL_CD..T_VA_020 a with (index=ix_t_va_020_8)
		where a.run_status = '3'
		and left(a.gaijung,2) = left(@o_gaijung,2)
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @order_no

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec SP_Common_Purchasing_Order_Release_RB
			@o_gaijung,
			@order_no,
			@status		output,
			@out_msg	output	  	

		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

		FETCH NEXT FROM TTT INTO @order_no
	end
	CLOSE TTT
   	DEALLOCATE TTT

	select @status='',@out_msg='Good...';

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6EA_1                                                                                  */
/*  DISCRIPTION  : 비정규 주문처리                                                                               */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/02/05     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6EA_1]
	@o_gaijung		varchar(04),
	@o_item_no		varchar(15),
	@o_vendor		varchar(08),
	@o_supply		char(01),
	@o_money_unit	varchar(03),
	@x_qty			varchar(10),
	@o_ship_flag	char(01),
	@po_gubun		char(01),
	@due_date		varchar(08),
	@prod_no		varchar(14),
	@part			char(02),
	@part_seq		varchar(04),
	@user_id		varchar(10)=''
	
AS
SET NOCOUNT ON
--exec MRP.dbo.SP_MRP_6EA_1  'ELES','AEA27C992*C    ','1172049','I','','1.0','?','1','20100930','HWASUNG07AAA  ','07','AAA0','lgjjg'

	declare	@status		char(01),
			@out_msg	varchar(100),
			@order_no	varchar(08),
			@o_qty		float

	if not exists(select * from el_cd..t_cx_060 where item_no = @o_item_no)
	begin
		select status = '1', out_msg = 'item_no 입력후 작업하세요???'
		return
	end

	if @o_vendor < '0'
	begin
		select status = '100', out_msg = '입력후 작업하세요...', vendor, order_select, money_unit
		from el_cd..t_cx_060
		where item_no = @o_item_no
		return
	end

	if isnumeric(@x_qty)=0
	begin
		select status='1',out_msg=' 수량을 재입력 하세요 ???'
		return
	end

	select @o_qty=convert(float,@x_qty)

	if @o_ship_flag='?'
		select @o_ship_flag=(case when exists (select * from el_cd..t_ca_011 
					where project_no=left(@prod_no,11)
					and mfg_no=substring(@prod_no,12,3)
					and part=@part
					and part_seq=@part_seq
					and item_no=@o_item_no) then 'Y' else 'N' end)

	exec SP_Common_P_Order_Informal_Creation_RB
		@o_gaijung,
		@o_item_no,
		@o_vendor,
		@o_supply,
		@o_money_unit	,
		@o_qty,
		@o_ship_flag,
		@po_gubun,	
		@due_date,
		@prod_no,
		@part,
		@part_seq,
		@user_id,
		@order_no	output,
		@status		output,
		@out_msg	output		

	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end
	else
	begin
		select status='0',out_msg=' 비정규 발주 OK ..',order_no=@order_no,run_status
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
	end

	EXEC mrp.dbo.SP_Common_Va020_Inquiry '2',@order_no;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6EC                                                                                      */
/*  DISCRIPTION  : 구매발송(보수품) Regen                                                                          */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #             S.E NAME         DESCRIPTION                                                 */
/*  ---------------------------------------------------------------                                                */
/* 2021/03/03   META Project          LGJJG            Initialize                                                  */
/* 2023/12/31   ITSR79758             UNGJ            오티스 주문번호 구성시 "E"자 제외                            */
/*******************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6EC]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON
/*
-- grant exec on SP_MRP_6EC to applications

declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_MRP_6EC 'MRP_6EC','2010-11-25 09:14:01.320',@status output,@out_msg output

select @status,@out_msg

*/
BEGIN
--return 
	declare	@o_Gaijung			varchar(04),
			@o_DueDate			varchar(08),
			@curr_date			varchar(08),
			@curr_year			char(04),
			@Code				varchar(20),
			@year_last_char		char(01)

	declare	@ya14_price			float,
			@ya14_matl_price	float,
			@ya14_date_apply	varchar(08)

	declare	@zr03_date_flag		char(1)		/** 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자**/

	select @curr_date = convert(char(08),getdate(),112)
	select @curr_year = left(convert(char(08),getdate(),112),4)

	select @year_last_char=right(@curr_year,1)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@o_DueDate=mrp.dbo.fGetOption(@Job_ID,@page,'DueDate')

	declare	@user_id	varchar(10)

	select @user_id=mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page)

--*** Dummy,원재료 발주 제외 Setting ***

	if @o_Gaijung = 'SYHP'
	begin
		return
	end
	else
	begin
		update a set
			date_ao=@curr_date,confirm_flag='A',
			concern_order_no = (case when a.concern_order_no is null then '' else a.concern_order_no end),
			run_date=getdate(),
			run_status='A'
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
--and ((project_no = '2012f  2246' and mfg_no = 'R01') or (project_no = '2012F  1616' and mfg_no = 'R01'))		
		and a.Gaijung=@o_Gaijung
		and a.due_date between '20210101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and a.order_select  in ('S','X','Z','D','I','L') 
		and b.item_no=a.item_no
		and a.market_flag = 'C'
--		and (substring(a.project_no,5,1) <> 'D' AND substring(a.project_no,8,1) <> 'M')
		and (	b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@'
		       )
	end

	create table #MRP_6EC (
		project_no	varchar(11),
		mfg_no		varchar(03),
		part		varchar(02),
		part_seq		varchar(04),
		order_select	char(01)
	)


	if @o_Gaijung = 'SYHP'
	begin
		return
	end
	else
	begin
		insert into #MRP_6EC
		select	a.project_no,a.mfg_no,a.part,part_seq,a.order_select
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung=@o_Gaijung
		and a.due_date between '20210101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and (a.order_select  in ('S','X','Z','D') or (a.order_select = 'I' and (a.item_no like 'H6%' or a.item_no = 'AEN77C708*A' or a.item_no = 'AEN77C708*B' or a.item_no = 'AEN77C708*C')))
		and b.item_no=a.item_no
		and a.market_flag = 'C'
--		and (substring(a.project_no,5,1) <> 'D' AND substring(a.project_no,8,1) <> 'M')
		and not (b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
				 b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
				 a.ship_flag <> 'Y'  or
				 a.cont_qty = 0 or 
				 a.cause_code  in ('IM','ZZ') or
				 a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
						  a.out_factory_flag  in ('K','D','A','Y') or
						  (a.treat_method is not null and a.treat_method = 'D') and  a.cause_code <> '@@'
		       )
	end

	declare	@project_no			varchar(11),
			@mfg_no				varchar(03),
			@part				varchar(02),
			@part_seq			varchar(04),
			@order_select		char(01),
			@order_no			varchar(08),
			@seq				int,
			@save_order_select	char(01)

	select @seq=9995

	DECLARE TTT SCROLL CURSOR FOR
		select	project_no,mfg_no,part,part_seq,order_select
		from #MRP_6EC a
		order by a.order_select
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@order_select
			
	select @save_order_select=''

	WHILE (@@FETCH_STATUS = 0)	
	begin
		if @seq < 0 or @seq >= 9995
		begin

		   IF ( @curr_year >  '2023' )
		     exec master.dbo.sp_Numbering_output_BALJU 'A07',@year_last_char,@Code output              --20240101  작업 반영 처리 
           ELSE  
			 exec master.dbo.sp_Numbering_output 'A07',@year_last_char,@Code output
			
			select @seq=5
		end
		else
			select @seq=@seq+5

		if @save_order_select <> @order_select
		begin
			select @save_order_select=@order_select
			
			if not exists (select * from T_MZR_03
							where gaijung=@o_gaijung
							and order_select=@order_select)
			begin
				insert into X_Batch_JOB_Error values (@page,@job_id,'1',getdate(),'납품 Option Not Found in SP_MRP_6EH ??? ')	
				return
			end
			
			select	@zr03_date_flag=date_flag
			from T_MZR_03
			where gaijung=@o_gaijung
			and order_select=@order_select				
		end

		select @order_no=@Code+master.dbo.fMakeStrSeq(@seq, 4)

		exec SP_Common_ShipItem_Regen
			@Job_ID,
			@page,
			@project_no,
			@mfg_no,
			@part,
			@part_seq,
			@zr03_date_flag,
			@order_no,
			'MRP_6EC',
			@status		output,
			@out_msg	output

		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@order_select
	end
	CLOSE TTT
   	DEALLOCATE TTT
END;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6EF_1                                                                                                                                                    */
/*  DISCRIPTION  : 제번별 구매발송 발주용 조회                                                                                                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6EF_1]
	@gaijung	varchar(04),
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02)
AS
SET NOCOUNT ON

--sp_fields T_CA_011


	if @Gaijung = 'SYHP'
	begin
		select	a.*,prod_no=a.project_no+a.mfg_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				due_date8=convert(char(08),due_date,112)
		from EL_CD..T_CA_011 a ,EL_CD..T_CX_060 b
		where a.project_no =  @project_no
		and a.mfg_no=@mfg_no
		and (a.part = @part or @part < '0')
		and a.date_ao is null
		and a.Gaijung=@Gaijung
		and a.due_date between '20090101' and '20301231'
		and a.confirm_flag in ('Y','A')
		and (	substring(part_seq,3,1) = 'A'  and a.order_select not in ('A','M') or 
			substring(part_seq,3,1) = 'A'  and a.order_select in ('A','M') and out_factory_flag = 'S' or 
			substring(part_seq,3,1) <> 'A'  and a.order_select not in ('A','M')  and out_factory_flag <> 'S')
		and b.item_no=a.item_no
		and not (b.item_select in ('D','H','R') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@'
		       )
		order by a.part,part_seq
	end
	else
	begin
		select	a.*,prod_no=a.project_no+a.mfg_no,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				due_date8=convert(char(08),due_date,112)
		from EL_CD..T_CA_011 a ,EL_CD..T_CX_060 b
		where a.project_no =  @project_no
		and a.mfg_no=@mfg_no
		and (a.part = @part or @part < '0')
		and a.date_ao is null
		and a.Gaijung=@Gaijung
		and a.due_date between '20090101' and '20301231'
		and a.confirm_flag in ('Y','A')
		and a.order_select  in ('S','X','Z','D') 
--full set 도입?		and a.order_select  in ('S','X','Z','D','I','L') 
		and b.item_no=a.item_no
		and not (b.item_select in ('D','H','R') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@'
		       )
		order by a.part,part_seq
	end

	select status='0',out_msg=' Inquiry OK ...';

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6EF_2                                                                                                                                                    */
/*  DISCRIPTION  : 수불항번별 구매발송발주                                                                                                                    */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6EF_2]
	@gaijung	varchar(04),
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02),
	@part_seq	varchar(04),
	@user_id	varchar(10)
AS
SET NOCOUNT ON

	declare	@status			char(01),
			@out_msg		varchar(100),
			@initial		varchar(03),
			@code			varchar(08),
			@order_select	char(01)

	if @Gaijung = 'SYHP'
	begin
		if not exists (select	*
			from EL_CD..T_CA_011 a ,EL_CD..T_CX_060 b
			where a.project_no =  @project_no
			and a.mfg_no=@mfg_no
			and a.part = @part 
			and a.part_seq=@part_seq
			and a.date_ao is null
			and a.Gaijung=@Gaijung
			and a.due_date between '20090101' and '20301231'
			and a.confirm_flag in ('Y','A')
			and  (	substring(part_seq,3,1) = 'A'  and a.order_select not in ('A','M') or 
				substring(part_seq,3,1) = 'A'  and a.order_select in ('A','M') and out_factory_flag = 'S' or 
				substring(part_seq,3,1) <> 'A'  and a.order_select not in ('A','M')  and out_factory_flag <> 'S') 
			and b.item_no=a.item_no
			and not (b.item_select in ('D','H','R') or 	--*** Dummy Item,원재료 자동발주 제외 ****
				b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
				a.cont_qty = 0 or 
				a.cause_code  in ('IM','ZZ') or
				a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
			              a.out_factory_flag  in ('K','D','A','Y') or
			              a.treat_method = 'D' and  a.cause_code <> '@@'
			       ) )
		begin
			select status='1',out_msg=' 발주 대상이 아님.  Please Check ???',order_no=''
			return
		end
	end
	else
	begin
		if not exists (select	*
			from EL_CD..T_CA_011 a ,EL_CD..T_CX_060 b
			where a.project_no =  @project_no
			and a.mfg_no=@mfg_no
			and a.part = @part 
			and a.part_seq=@part_seq
			and a.date_ao is null
			and a.Gaijung=@Gaijung
			and a.due_date between '20090101' and '20301231'
			and a.confirm_flag in ('Y','A')
			and a.order_select  in ('S','X','Z','D') 
	--full set 도입?		and a.order_select  in ('S','X','Z','D','I','L') 
			and b.item_no=a.item_no
			and not (b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
				b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
				a.ship_flag <> 'Y'  or
				a.cont_qty = 0 or 
				a.cause_code  in ('IM','ZZ') or
				a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
			              a.out_factory_flag  in ('K','D','A','Y') or
			              a.treat_method = 'D' and  a.cause_code <> '@@'
				       ) )
		begin
			select status='1',out_msg=' 발주 대상이 아님.  Please Check ???',order_no=''
			return
		end
	end

	select	@order_select=(case when order_select in ('A','M') then 'D' else order_select end)
	from el_cd..t_ca_011 a
	where a.project_no =  @project_no
	and a.mfg_no=@mfg_no
	and a.part = @part
	and a.part_seq = @part_seq

	declare	@zr03_date_flag		char(1)		/** 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자**/

	if not exists (select * from T_MZR_03
					where gaijung=@gaijung
					and order_select=@order_select)
	begin
		select status='1',out_msg='납품 Option Not Found in Purchasing_Order_Release '
		return
	end
	
	select	@zr03_date_flag=date_flag
	from T_MZR_03
	where gaijung=@gaijung
	and order_select=@order_select		
	
	if @gaijung = 'SPSS'
		select @Initial=right(left(convert(char(08),getdate(),112),4),1)+'XX'
	else if @gaijung = 'SYHP'
		select @Initial=right(left(convert(char(08),getdate(),112),4),1)+'YY'
	else
		select @Initial=right(left(convert(char(08),getdate(),112),4),1)+'ZZ'
		
		
	exec master.dbo.sp_Numbering_output 'A11',@initial,@Code output

	exec SP_Common_ShipItem_Regen
		'MRP_6EI',
		null,
		@project_no,
		@mfg_no,
		@part,
		@part_seq,
		@zr03_date_flag,
		@Code,
		@user_id,
		@status		output,
		@out_msg	output

	select status=@status,out_msg=@out_msg,order_no=@Code;

--*******************************************************************************************************************
--  SP NAME      : SP_MRP_6EH                                                                                                                                                    **
--  DISCRIPTION  : 구매종속 Regn                                                                                                                                  ** 
--                                                                                                                                                                                                  **
--  >> MODIFICATION LOG <<                                                                                                                                                       ** 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           **
--  ---------------------------------------------------------------                                            
-- 2010/01/16     MRP Downsizing Project   J.J.Park      Initialize                                                 
-- 2023/12/31     ITSR79758                    UNGJ               오티스 주문번호 구성시 "E"자 제외                                                             **
--**************************************************************************************************************

CREATE PROCEDURE [dbo].[SP_MRP_6EH]
	@job_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_MRP_6EH 'MRP_6EH','2010-09-19 10:29:51.867',@status output,@out_msg output

select @status,@out_msg

--select * from X_batch_job_option where job_id='MRP_6EH'

exec MRP.dbo.SP_MRP_007_1 '','MRP_6EH'
*/

	declare	@o_gaijung		varchar(04),
			@o_date_due		varchar(08),
			@o_part			char(02),
			@o_order_select	char(01),
			@curr_date		varchar(08),
			@curr_year		char(04),
			@Code			varchar(20),
			@year_last_char	char(01)

	declare	@ya14_price			float,
			@ya14_matl_price	float,
			@ya14_date_apply	varchar(08)

	declare	@zr03_date_flag		char(1)		--* 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자***

	declare	@user_id	varchar(10)

	select @user_id=request_emp_id
	from mrp.dbo.x_batch_job_option
	where job_id=@job_id
	and page=@page

	select @curr_date = convert(char(08),getdate(),112)
	select @curr_year = left(convert(char(08),getdate(),112),4)


	select @year_last_char=right(@curr_year,1)

	select	@o_gaijung=mrp.dbo.fGetOption(@job_id,@page,'GAIJUNG'),
			@o_date_due=mrp.dbo.fGetOption(@job_id,@page,'DueDate')


--*** Dummy,원재료 발주 제외 Setting ***

--BOM전개가 필요 없는 제통 PO REGEN 제거
	update a set
		date_po=getdate(),run_date=getdate(),confirm_flag='A'
	from EL_CD..T_CA_011 a with (index=ix_ca_011_4)
	where a.date_po is null
	and a.Gaijung=@o_Gaijung
	and a.due_date between '20090101' and @o_date_due
	and a.confirm_flag in ('Y','A')
	and (	a.order_select in ('D','I','L') or 
		a.treat_method='D' and a.cause_code <> '@@' or 
		a.part = 'RA' or 
		a.cause_code  in ('IM','ZZ') or
		a.order_select = 'M' and out_factory_flag = 'S' or
		a.ship_flag = 'N' or
		out_factory_flag  in ('K','D','A','Y') )


--* PS010 :  GISS6EH1 ****
	create table #GISF6EH (
		project_no	varchar(11),
		mfg_no		varchar(03),
		part		varchar(02),
		part_seq		varchar(04),
		item_no		varchar(15),
		cont_qty		float,
		due_date	varchar(08),
		order_select	char(01),
		ship_flag	char(01),
		market_flag	char(01)
	)


	insert into #GISF6EH
	select	project_no,mfg_no,part,part_seq,item_no,
			cont_qty,
			due_date= convert(char(08),due_date,112),
	--			due_date=(case when @curr_date > due_date then @curr_date else due_date end),
			order_select=(case when order_select in ('A','M') then 'M' else order_select end),
			ship_flag = (case when treat_method = 'D' and cause_code = '@@' or ship_flag <> 'Y' then 'N' else 'Y' end),
			a.market_flag
	from EL_CD..T_CA_011 a with (index=ix_ca_011_4)
	where a.date_po is null
	and a.Gaijung=@o_Gaijung
	and a.due_date between '20090101' and @o_date_due
	and a.confirm_flag in ('Y','A')
	and not (a.order_select in ('D','I','L') or 
		(a.treat_method is not null and a.treat_method = 'D') and a.cause_code <> '@@' or 
		a.part = 'RA' or 
		a.cause_code  in ('IM','ZZ') or
		a.order_select = 'M' and out_factory_flag = 'S' or
		a.ship_flag = 'N' or
		out_factory_flag  in ('K','D','A','Y') )


	select distinct item_no,order_select
	into #selected
	from #GISF6EH


	delete from T_MTP_01 where page=@page and order_flag='S'
	delete from X_Batch_JOB_Error where page=@page and job_id=@job_id

	exec SP_Common_BOM_EXPL 'S',@job_id,@page


	select	a.project_no,a.mfg_no,a.part,part_seq,
			item_no=b.child_item_no,
			order_select=b.child_order_select,
			due_date=convert(char(08),a.due_date,112),
			qty=a.cont_qty*b.qty,
			a.market_flag,
	--		a.week,
			order_no=convert(varchar(08),''),
			each_order_flag=(case when c.keep_flag in ('K','C','',' ') or 
						@o_gaijung in ('SYHP') or c.auto_order_flag in ('E') 
						then 'Y' else 'N' end),
			b.special
	into #ZA_1	
	from #GISF6EH a	
		inner join T_MTP_01 b
			on b.parent_item_no=a.item_no
			and b.parent_order_select = a.order_select
		inner join EL_CD..T_CX_060 c
			on c.item_no = b.child_item_no
	where b.page=@page
	and b.order_flag='S'
	and b.parent_item_no <> b.child_item_no	--* 발송자체는 제외****
	and b.child_order_select <> 'I'
	and c.item_select not in ('D','H','R')		--** Dummy Item,원재료 자동발주 제외 *****
 	and c.auto_order_flag <> 'N'	--** 자동발주 여부 Check   Logic 추가 보완 필요 ****

	


--** 납기Setting ****

	update a set
		due_date=mrp.dbo.fn_Common_Due_Date_Set (
							'GISF6EH',@o_gaijung,a.due_date,
							a.special,a.market_flag,
							b.lead_time1,b.lead_time2,@curr_date)
	from #ZA_1 a
		left outer join EL_CD..T_CX_060 b
			on b.item_no=a.item_no
	where a.item_no > '0'


--* 주문생성 GISS6EH4****

	declare	@qty			float,
			@req_qty		float,
			@item_no		varchar(15),
			@wc_code		varchar(06),
			@due_date		varchar(08),
			@date_apply		varchar(08),
			@date_start		varchar(08),
			@project_no		varchar(11),
			@mfg_no			varchar(03),
			@part			varchar(02),
			@part_seq		varchar(04),
			@ship_flag		char(01),
			@order_select	char(01),
			@market_flag	char(01),
			@vendor			varchar(08),
			@money_unit		varchar(03),
			@over_order_qty	int,
			@multiple_qty	int,
			@seq			int,
			@save_order_select	char(01),
			@over_order_qty_diff	int,
			@qty_order		int,
			@plan_post_person	varchar(04),
			@pay_con		varchar(05),
			@each_order_flag	char(01),
			@po_post_person	varchar(04)


	select @seq=9995

	truncate table T_MVA_020_Regen


--begin tran SP_GISF6EH

	DECLARE TTT SCROLL CURSOR FOR
		select 	a.item_no,due_date,order_select,each_order_flag,
				project_no,mfg_no,part,part_seq,qty=sum(qty),market_flag=max(a.market_flag)
		from #ZA_1 a
		where a.each_order_flag='Y' 
		group by a.item_no,a.due_date,order_select,project_no,mfg_no,part,part_seq,each_order_flag
		union		
		select 	a.item_no,due_date,order_select,each_order_flag,
				project_no='Summary_P',mfg_no='',part='',part_seq='',qty=sum(qty),market_flag=max(market_flag)
		from #ZA_1 a
		where not (a.each_order_flag='Y' )
		group by a.item_no,a.due_date,order_select,each_order_flag
		order by order_select
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @item_no,@due_date,@order_select,@each_order_flag,
			@project_no,@mfg_no,@part,@part_seq,@qty,@market_flag

	select @save_order_select=''

	WHILE (@@FETCH_STATUS = 0)	
	begin
		select @over_order_qty=0

		select 	@over_order_qty=over_order_qty
		from mrp..T_mva_020_over
		where item_no=@item_no
		
		select 	@multiple_qty=0,@plan_post_person='',
				@vendor='',@money_unit= 'WON' 

		select 	@multiple_qty=isnull(multiple_qty,0),
				@plan_post_person=isnull(plan_post_person,''),
				@vendor=isnull(vendor,''),
				@money_unit=(case when money_unit > '0' then money_unit else 'WON' end)
		from EL_CD..T_CX_060
		where item_no=@item_no

		if @save_order_select <> @order_select
		begin
			select @save_order_select=@order_select

			if not exists (select * from T_MZR_03
							where gaijung=@o_gaijung
							and order_select=@order_select)
			begin
				insert into X_Batch_JOB_Error values (@page,@job_id,'1',getdate(),'납품 Option Not Found in SP_MRP_6EH ??? ')	
				return
			end
			
			select	@zr03_date_flag=date_flag
			from T_MZR_03
			where gaijung=@o_gaijung
			and order_select=@order_select		
		end

		select @date_apply = (case when @zr03_date_flag = '1' 
					then @due_date 
					else (case when @zr03_date_flag='2' then @curr_date else @date_start end) end)

		select @req_qty=@qty,@qty_order=@req_qty


		--* 잉여발주수량 감안 , LOT 발주 감안****
		if @order_select not in ('S','X','Z') and (@over_order_qty > 0 or @multiple_qty > 0)
		begin
			exec SP_Common_Order_Qty_Compute
				@req_qty,
				@over_order_qty,
				@multiple_qty,
				@qty_order			output,	--발주할 수량
				@over_order_qty_diff		output	--차이

			if @over_order_qty_diff <> 0
			begin
				update a set
					over_order_qty = over_order_qty + @over_order_qty_diff
				from mrp..T_mva_020_over a
				where item_no=@item_no
			end
		end

		if @qty_order > 0
		begin
			if @seq < 0 or @seq >= 9995
			begin
			   IF ( @curr_year > '2023' )
				    exec sp_Numbering_output_BALJU 'A07',@year_last_char,@Code output
               ELSE
			        exec sp_Numbering_output   'A07',@year_last_char,@Code output

				select @seq=5
			end
			else
				select @seq=@seq+5

--
			exec SP_Common_Price_Fetch
				@item_no,
				'A',			    --** price_sort ****
				@vendor,	
				@order_select,	
				'',			        --** work_mtd  ****
				@money_unit,
				@date_apply,		--** apply_date ****   
				'N',			    --** etc_apply_flag ****
				
				@ya14_price		output,
				@ya14_matl_price		output,
				@ya14_date_apply	output,
				@status			output,
				@out_msg		output


			if @status > '0'
				insert into X_Batch_JOB_Error values (@page,@job_id,'2',getdate(),@out_msg)	

			select @pay_con='',@po_post_person=''

			select	@pay_con=isnull(c.pay_con,''),
					@po_post_person=isnull(c.post,'')+isnull(c.person,'')
			from el_cd..T_CX_080 c
			where trade_no=@vendor


			insert into EL_CD..T_VA_020
			select	order_no=@Code+( CASE WHEN @curr_year > '2023' THEN  master.dbo.fMakeNumString_BALJU(35,@seq, 4)  ELSE  master.dbo.fMakeNumString(36,@seq, 4) END ), 
					item_no=@item_no,
					gaijung=@o_gaijung,
					supply=@order_select,
					run_status=mrp.dbo.fn_Common_PO_Run_status(@o_gaijung,@plan_post_person,@part,@order_select,@item_no,@vendor),
			
					date_due=@due_date,
					keep_flag=(case when @each_order_flag = 'Y'  then 'K' else '' end),
					item_unit=isnull(b.item_unit,''),
					money_unit=@money_unit,
					price=@ya14_price,
					price_r=0,
					qty_order=@qty_order,
					qty_deliv=0,
					qty_insp=0,
					qty_acpt=0,
					qty_input=0,
					qty_cancel=0,
					date_start=getdate(),
					date_deliv=null,
					date_chg=null,
					po_status=(case when @curr_date  > @due_date then 'P' else  'N'  end),
					date_delay=null,
					insp_select=isnull(b.insp_select,''),
					pay_con=@pay_con,
					post_wc='',
					prod_no=@project_no+@mfg_no,
					lc_no='',
					req=@req_qty,
					ao_no='NONE',
					date_po=getdate(),
					post_person=@plan_post_person,
					date_last=null,
					date_print_po=null,
					trade_no=@vendor,
					skp=(case when @order_select in ('S','X','Z') then @order_select else '' end),
			
					po_post_person=isnull((case when @o_gaijung in ('ELES') then @po_post_person else b.po_post_person end),''),
					order_type=@curr_date,
					etc_price=0,
					last_ot_no=0,
					po_gubun='1',
					qty_reject=0,
					issue_no='',
					issue_last_no=0,
					import_flag='',
					market_flag=@market_flag,
					part_seq=@part_seq,
					part=@part,
					ship_flag='N',
					draw_no=isnull(b.draw_no,''),
					approve_flag='',
					approve_date=null,
					receipt_flag='',
					receipt_date=null,
					reject_flag='',
					reject_date=null,
					receipt_expect_no='',
					packing_vendor='',
					box_receipt_expect_no='',
					approver='',
					box_no='',
					creator='MRP_6EH'
			from EL_CD..T_CX_060 b
			where b.item_no=@item_no
		end
	
	  	FETCH NEXT FROM TTT INTO @item_no,@due_date,@order_select,@each_order_flag,
				@project_no,@mfg_no,@part,@part_seq,@qty,@market_flag

	end
	CLOSE TTT
   	DEALLOCATE TTT

--select 'T_MVA_020_Regen',* from T_MVA_020_Regen


--* 수불대장에 종속발주일자 Setting ***

	update y set 
		date_po=@curr_date,run_date=@curr_date,confirm_flag='A'
	from (select distinct a.project_no,a.mfg_no,a.part,a.part_seq from #ZA_1 a) x,EL_CD..T_CA_011 y
	where y.project_no=x.project_no
	and y.mfg_no=x.mfg_no
	and y.part=x.part
	and y.part_seq=x.part_seq
	
	IF @@ERROR = 0
	BEGIN
--		COMMIT TRAN SP_GISF6EH
		select @status='',@out_msg='Good...'
	END
	ELSE
	BEGIN	
--		ROLLBACK TRAN SP_GISF6EH
		select @status='1',@out_msg='Error ???'
	END;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6EI                                                                                      */
/*  DISCRIPTION  : 구매발송 Regn                                                                                   */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                        */
/*  ---------------------------------------------------------------                                                */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                */
/* 2023/12/31     ITSR79758                    UNGJ               오티스 주문번호 구성시 "E"자 제외                */
/*******************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6EI]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON
/*
	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_MRP_6EI 'MRP_6EI','2010-11-25 09:14:01.320',@status output,@out_msg output

select @status,@out_msg

*/

	declare	@o_Gaijung			varchar(04),
			@o_DueDate			varchar(08),
			@curr_date			varchar(08),
			@curr_year			char(04),
			@Code				varchar(20),
			@year_last_char		char(01)

	declare	@ya14_price			float,
			@ya14_matl_price	float,
			@ya14_date_apply	varchar(08)

	declare	@zr03_date_flag		char(1)		/** 단가MASTER적용일구분 ( )계획일자(1)납기일자(2)주문일자**/

	select @curr_date = convert(char(08),getdate(),112)
	select @curr_year = left(convert(char(08),getdate(),112),4)

	select @year_last_char=right(@curr_year,1)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung'),
			@o_DueDate=mrp.dbo.fGetOption(@Job_ID,@page,'DueDate')

	declare	@user_id	varchar(10)

	select @user_id=mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page)

--*** Dummy,원재료 발주 제외 Setting ***

	if @o_Gaijung = 'SYHP'
	begin
		update a set
			date_ao=@curr_date,confirm_flag='A',
			concern_order_no = (case when a.concern_order_no is null then '' else a.concern_order_no end),
			run_date=getdate(),
			run_status='A'
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung=@o_Gaijung
	--	and (@o_ClaimFlag='Y' and part='CM' or @o_ClaimFlag<>'Y' and part<>'CM')
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and b.item_no=a.item_no
		and (	b.item_select in ('D','H') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.cont_qty = 0 or 

			not (substring(part_seq,3,1) = 'A'  and a.order_select not in ('A','M') or 
				substring(part_seq,3,1) = 'A'  and a.order_select in ('A','M') and out_factory_flag = 'S' or 
				substring(part_seq,3,1) <> 'A'  and a.order_select not in ('A','M')  and out_factory_flag <> 'S') or

			a.cause_code  in ('IM','ZZ') or
			a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@'
		       )
	--		a.part not  in ('CM')  and
	--		substring(a.project_no,10,1) not in ('X','P','K')  ) 
	end
	else
	begin
		update a set
			date_ao=@curr_date,confirm_flag='A',
			concern_order_no = (case when a.concern_order_no is null then '' else a.concern_order_no end),
			run_date=getdate(),
			run_status='A'
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
--and ((project_no = '2012f  2246' and mfg_no = 'R01') or (project_no = '2012F  1616' and mfg_no = 'R01'))		
		and a.Gaijung=@o_Gaijung
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and a.order_select  in ('S','X','Z','D','I','L') 
		and b.item_no=a.item_no
		and (	b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              a.treat_method = 'D' and  a.cause_code <> '@@'
		       )
	end

	create table #MRP_6EI (
		project_no	varchar(11),
		mfg_no		varchar(03),
		part		varchar(02),
		part_seq		varchar(04),
		order_select	char(01)
	)


	if @o_Gaijung = 'SYHP'
	begin
		insert into #MRP_6EI
		select	a.project_no,a.mfg_no,a.part,a.part_seq,
			order_select=(case when a.order_select in ('A','M')
					 then 'D'
					else a.order_select end)
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
		and a.Gaijung=@o_Gaijung
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
		and (	substring(part_seq,3,1) = 'A'  and a.order_select not in ('A','M') or 
			substring(part_seq,3,1) = 'A'  and a.order_select in ('A','M') and out_factory_flag = 'S' or 
			substring(part_seq,3,1) <> 'A'  and a.order_select not in ('A','M')  and out_factory_flag <> 'S')
		and b.item_no=a.item_no
		and not (b.item_select in ('D','H') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              (a.treat_method is not null and a.treat_method = 'D') and  a.cause_code <> '@@'
		       )
	end
	else
	begin
		insert into #MRP_6EI
		select	a.project_no,a.mfg_no,a.part,part_seq,a.order_select
		from EL_CD..T_CA_011 a with (index=ix_ca_011_3),EL_CD..T_CX_060 b
		where a.date_ao is null
--and ((project_no = '2012f  2246' and mfg_no = 'R01') or (project_no = '2012F  1616' and mfg_no = 'R01'))		
		and a.Gaijung=@o_Gaijung
		and a.due_date between '20090101' and @o_DueDate
		and a.confirm_flag in ('Y','A')
--		and (a.order_select  in ('S','X','Z','D') or (a.order_select = 'I' and a.item_no like 'H6%'))
		and (a.order_select  in ('S','X','Z','D') or (a.order_select = 'I' and (a.item_no like 'H6%' or a.item_no = 'AEN77C708*A' or a.item_no = 'AEN77C708*B' or a.item_no = 'AEN77C708*C')))
--full set 도입?		and a.order_select  in ('S','X','Z','D','I','L') 
		and b.item_no=a.item_no
		and not (b.item_select in ('D') or 	--*** Dummy Item,원재료 자동발주 제외 ****
			b.auto_order_flag = 'N'  or 	--*** 자동발주 여부 Check   Logic 추가 보완 필요 ***
			a.ship_flag <> 'Y'  or
			a.cont_qty = 0 or 
			a.cause_code  in ('IM','ZZ') or
			a.vbox_code is not null and a.vbox_code > '0' and  vbox_code <> 'XX' and a.cause_code <> '@@'  or
		              a.out_factory_flag  in ('K','D','A','Y') or
		              (a.treat_method is not null and a.treat_method = 'D') and  a.cause_code <> '@@'
		       )
	end

	declare	@project_no			varchar(11),
			@mfg_no				varchar(03),
			@part				varchar(02),
			@part_seq			varchar(04),
			@order_select		char(01),
			@order_no			varchar(08),
			@seq				int,
			@save_order_select	char(01)

	select @seq=9995

	DECLARE TTT SCROLL CURSOR FOR
		select	project_no,mfg_no,part,part_seq,order_select
		from #MRP_6EI a
		order by a.order_select
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@order_select
			
	select @save_order_select=''

	WHILE (@@FETCH_STATUS = 0)	
	begin
		if @seq < 0 or @seq >= 9995
		begin

		   IF ( @curr_year > '2023' ) 
		       exec master.dbo.sp_Numbering_output_BALJU 'A07',@year_last_char,@Code output     --20240101 반영
           ELSE      
			   exec master.dbo.sp_Numbering_output 'A07',@year_last_char,@Code output
			
			select @seq=5
		end
		else
			select @seq=@seq+5

		if @save_order_select <> @order_select
		begin
			select @save_order_select=@order_select
			
			if not exists (select * from T_MZR_03
							where gaijung=@o_gaijung
							and order_select=@order_select)
			begin
				insert into X_Batch_JOB_Error values (@page,@job_id,'1',getdate(),'납품 Option Not Found in SP_MRP_6EH ??? ')	
				return
			end
			
			select	@zr03_date_flag=date_flag
			from T_MZR_03
			where gaijung=@o_gaijung
			and order_select=@order_select				
		end

		select @order_no=@Code+master.dbo.fMakeStrSeq(@seq, 4)

		exec SP_Common_ShipItem_Regen
			@Job_ID,
			@page,
			@project_no,
			@mfg_no,
			@part,
			@part_seq,
			@zr03_date_flag,
			@order_no,
			'MRP_6EI',
			@status		output,
			@out_msg	output

		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@order_select
	end
	CLOSE TTT
   	DEALLOCATE TTT
   	
if @o_Gaijung = 'ELES'   	
begin
	insert into el_cd.dbo.T_VA_020_REGEN_HISTORY
	select * from el_cd.dbo.t_va_020
	where order_no like '2%'
	and item_no in ('PK_FAA320R4','PK_FAA320R3')
	and date_start >= GETDATE() - 1
end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6IA_1                                                                                                                                              */
/*  DISCRIPTION  :  주문분배용 조회                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/03/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6IA_1]
	@opt_gaijung	varchar(04),
	@order_no		varchar(08)
AS
--exec SP_MRP_6IA_1 '7DRU4500'
set nocount on

	declare	@status		char(01),
			@out_msg	varchar(100),
			@run_status	char(01),
			@qty_remain	float,
			@supply		char(01),
			@gaijung	varchar(04),
			@order_type	varchar(08)

	if not exists (select * FROM el_cd.dbo.T_va_020 a WHERE a.order_no = @order_no )
	begin
		select status='1',out_msg=' Order No  Not Found ????'
		return
	end

	select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
		@supply=supply,@gaijung=gaijung,@order_type=order_type
	FROM el_cd.dbo.T_va_020 a	
	WHERE a.order_no = @order_no 

	if  @order_type > '00000000' and exists (select * FROM el_cd.dbo.T_va_020 a 
			WHERE a.order_no between left(@order_no,7)+(case when right(@order_no,1)='0' then '1' else '6' end ) 
				and left(@order_no,7)+(case when right(@order_no,1)='0' then '4' else '9' end ) )
	begin
		select status='1',out_msg=' 기분배된 주문은 분배 불가 ????'
		return
	end


	if @order_type > '00000000' and right(@order_no,1) not in ('0','5')
	begin
		select status='1',out_msg=' 자동발주용 주문만 분배 가능  ????'
		return
	end

	if left(@gaijung,2) <>  left(@opt_gaijung,2)
	begin
		select status='1',out_msg=' 다른 사업부의 주문입니다.  분배 불가  ???'
		return
	end

	if @run_status >= '5'
	begin
		select status='1',out_msg='완료,취소된 주문은 분배 불가  ???'
		return
	end


	if @run_status = '4'
	begin
		select status='1',out_msg='주문집행된 주문은 분배 불가  ???'
		return
	end

	if @qty_remain <= 0
	begin
		select status='2',out_msg='주문수량이 없읍니다 ???'
		return
	end

	select status='0',out_msg='내용을 입력하고 처리하세요 .....'

	exec mrp.dbo.SP_Common_Va020_Inquiry '3',@order_no;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6IA_2                                                                                                                                                   */
/*  DISCRIPTION  : 주문수량분배                                                                                                           */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/03/02     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6IA_2]
	@flag		char(01),	--c:Cehck  P:process
	@o_gaijung	varchar(04),
	@o_order_no	varchar(08),
	@cnt		int,
	@o_qty		varchar(10),
	@o_vendor	varchar(10),
	@user_id	varchar(07)
	
AS
SET NOCOUNT ON

	declare	@order_no	varchar(08),
			@curr_date	char(08),
			@Initial	char(03),
			@order_type	char(08),
			@qty		float,
			@run_status	char(01)

	select @curr_date = convert(char(08),getdate(),112)
	select @Initial=substring(@curr_date,4,1)+'ZZ'

	
	if isnumeric(@o_qty)=0
	begin
		select status='1',out_msg=' 수량을 재입력 하세요 ???'
		return
	end

	if not exists (select * from el_cd..t_cx_080 where trade_no=@o_vendor)
	begin
		select status='1',out_msg=' Vendor를 재입력 하세요 ???'
		return
	end

	if not exists (select * from el_cd..t_va_020 where order_no=@o_order_no)
	begin
		select status='1',out_msg=' Order Not Found ??'
		return
	end


	select @order_type=order_type,@run_status=run_status
	from el_cd..t_va_020
	where order_no=@o_order_no

	if @run_status > '3'
	begin
		select status='1',out_msg=' 주문집행이후는 분배불가  ???'
		return
	end

	if @flag='C'
	begin
		select status='0',out_msg=' Check OK ...',brief_trade=master.dbo.fGetVendorName(@o_vendor)
		return
	end

	select *
	into #aa
	from el_cd..t_va_020
	where order_no=@o_order_no

	select @order_type=order_type
	from #aa


	select @qty=convert(float,@o_qty)

	if @cnt = 0
		select @order_no=@o_order_no
	else
	begin
		if @order_type > '00000000' 
			select @order_no=left(@o_order_no,4)+
				right('000'+convert(varchar(04),convert(int,substring(@o_order_no,5,4))+@cnt),4)
		else
			exec sp_Numbering_output 'A11',@Initial,@order_no output
	end

begin tran MRP_6IA_2

	if @cnt=0 
		update a set
			date_last=getdate(),
			qty_order=@qty,
			trade_no=@o_vendor,
			price=0,
			price_r=0
		from EL_CD..T_VA_020 a
		where order_no=@o_order_no
	else
	begin
		update a set
			order_no=@order_no,
			date_last=getdate(),
			qty_order=@qty,
			trade_no=@o_vendor,
			order_type='00000000',
			price=0,
			price_r=0
		from #aa  a
	
		
		insert into EL_CD..T_VA_020
		select *
		from #aa

		if  @@rowcount = 0
		begin
			rollback tran MRP_6IA_2
			select status='1',out_msg='주문 Insert Error (' + @order_no + ') ???'
			return
		end
	end

	select status='0',out_msg=' 주문분배 OK ...',order_no=@order_no

	commit tran MRP_6IA_2;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6IU_1                                                                                  */
/*  DISCRIPTION  :  사급품 불출 전개                                                                             */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/03/15     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6IU_1]
	@opt_flag		char(01),
	@order_no		varchar(08),
	@store			varchar(06)='',
	@user_id		varchar(08)=''
AS
--SP_MRP_6IU_1 'S',''
--SP_MRP_6IU_1 '2I08100600001'
set nocount on

	declare	@run_status	char(01),
			@po_status	char(01),
			@po_gubun	char(01),
			@last_ot_no	int,
			@skp		char(01),
			@trade_no	varchar(08),
			@status		char(01),
			@out_msg	varchar(100)	


	if @opt_flag = 'S'
		select	a.*,
				qty_queue=a.qty_deliv-a.qty_input-a.Qty_reject,
				qty_balance=a.qty_order-a.qty_cancel-(a.qty_deliv-a.qty_reject),
				prod_no_all=a.prod_no+'/' + a.part+'/'+a.part_seq,
				eng_desc=master.dbo.fGetItemDesc(a.item_no),
				curr_date=convert(char(08),getdate(),112),
				mold_flag=isnull((select c.mold_flag from EL_CD..T_CX_060 c where c.item_no=a.item_no),''),
				brief_trade=master.dbo.fGetVendorName(a.trade_no)
		from EL_CD..T_VA_020 a
		where a.order_no = @order_no


	if not exists (select * from EL_CD..T_VA_020 where order_no = @order_no)
	begin
		select status='1',out_msg=' Order Not Found ???'
		return
	end

	select @run_status=run_status,@po_status=po_status,@po_gubun=po_gubun,@last_ot_no=last_ot_no,
			@skp=skp,@trade_no=trade_no
	from EL_CD..T_VA_020 
	where order_no = @order_no

/*
               MOVE W-IO-ORDER-NO        TO W-SAVE-ORDER-NO
               MOVE W-IO-STORE           TO W-SAVE-STORE
               MOVE SPACES               TO W-IO-DATA-AREA
                                             W-IO-NEXT-KEY-AREA
               MOVE W-SAVE-ORDER-NO      TO W-IO-ORDER-NO
               MOVE W-SAVE-STORE         TO W-IO-STORE

     
*/
	if not (@run_status = '4' or @run_status = '5' and @po_status <> '5')
	begin
		select status='1',out_msg=' 주문집행 or 완료중 미불출만 전개가 가능함 ???'
		return
	end

	if @po_gubun not in ('1','2','4','5')
	begin
		select status='1',out_msg=' 양산품(1)만 사급전개 대상 품목입니다 ???'
		return
	end

	if @last_ot_no <> 0
	begin
		select status='1',out_msg=' 이미 사급불출전개가 끝난 주문서입니다 ???'
		return
	end
       
	if @skp not in ('S','X','Z')
	begin
		select status='1',out_msg=' 사급 전개 대상 품목이 아닙니다 ???'
		return
	end


	if not exists (select * from EL_CD..T_CX_080 where trade_no = @trade_no)
	begin
		select status='1',out_msg=' 거래처가 틀림. 수정후 작업하세요 ???'
		return
	end


	if @opt_flag = 'S'
	begin
		select status='0',out_msg = '전개 가능합니다 .....'
		return
	end

	else if @opt_flag = 'P'
	begin
		exec SP_Common_Issue_ready_Creation_PO
			@order_no,
			@store,
			@status		output,
			@out_msg	output

		if @status > '0'
			select status=@status,out_msg=@out_msg
		else
			select status='0',out_msg=' 전개 되었읍니다...'
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6IX_1                                                                                                                                              */
/*  DISCRIPTION  :  입회검사품 입고 처리                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6IX_1]
	@flag			char(01),
	@order_no		varchar(08)='',
	@input_date		char(08)='',
	@store			char(06)='',
	@user_id		varchar(08)='',
	@receipt_method_flag	char(01)='L'	--납품방식 L:Each N:Box   
as
/*
--exec MRP.dbo.SP_MRP_6IX_1 'P','0AB79490','1','709','lgjjg'
exec MRP.dbo.SP_MRP_6IX_1 'P','00030265','20100811','','lgjjg'
*/

-- if getdate() >= '20171026 00:00:00' and getdate() <= '20171026 23:59:00'
-- if getdate() >= '20181025 21:00:00' and getdate() <= '20181026 23:59:00'
-- if getdate() >= '20191025 17:30:00' and getdate() <= '20191029 00:01:00'
-- if getdate() >= '20201024 12:30:00' and getdate() <= '20201026 15:00:00'
-- if getdate() >= '20211025 17:00:00' and getdate() <= '20211026 15:00:00'
-- if getdate() >= '20221025 17:00:00' and getdate() <= '20221026 15:00:00'
-- if getdate() >= '20231025 17:00:00' and getdate() <= '20231026 15:00:00'--20231025 KDG
   if getdate() >= '20241025 17:00:00' and getdate() <= '20241028 15:00:00'--20241025_KDG
   begin
         --select @status='1',@out_msg='재고실사관계로입출고불가...'
         return -11
   end
   
	if @flag = 'S'
		select	a.*,
			qty_queue=a.qty_deliv-a.qty_input-a.Qty_reject,
			qty_balance=a.qty_order-a.qty_cancel-(a.qty_deliv-a.qty_reject),
			prod_no_all=a.prod_no+a.part+a.part_seq,
			eng_desc=master.dbo.fGetItemDesc(a.item_no),
			curr_date=convert(char(08),getdate(),112),
			mold_flag=isnull((select c.mold_flag from EL_CD..T_CX_060 c where c.item_no=a.item_no),'')
		from EL_CD..T_VA_020 a left outer join EL_CD..T_VA_040 b
			on b.order_no=a.order_no
		where a.order_no = @order_no
	else if @flag = 'P'
	begin
		/*
		if @receipt_method_flag = 'N'
		begin
			declare	@gaijung	varchar(04),
					@project_no	varchar(11),
					@mfg_no		varchar(03),
					@part		varchar(02),
					@part_seq	varchar(04),
					@ship_flag	char(01)
					
			select	@gaijung=gaijung,
					@project_no=left(prod_no,11),
					@mfg_no=substring(prod_no,12,3),
					@part=part,
					@part_seq=part_seq,
					@ship_flag=ship_flag
			from el_cd..t_va_020 
			where order_no=@order_no
					

			if @gaijung='SPSS' and @ship_flag = 'Y'
			begin
--제통(수불대장) Update
				update a set
					run_status='N',
					rslt_date=isnull(a.rslt_date,convert(char(08),getdate(),112)),
					last_in_date=convert(char(08),getdate(),112)
				from el_cd..t_ca_011 a
				where a.project_no=@project_no
				and a.mfg_no=@mfg_no
				and a.part=	@part
				and a.part_seq=	@part_seq
				and a.run_status < 'N'
				
				select status='0',out_msg=' DC 입고처리 OK ..',slip_no='',
						qty=0,date_io=isnull(convert(char(08),getdate(),112),'')
						
				return
			end
		end
		*/
		
		declare	@status		char(01),
				@out_msg	varchar(100),
				@slip_no	varchar(13)

--납품

		exec MRP..SP_Common_Matl_Arrival	
							@order_no,
							0,		--delivered_qty
							0,		-- entry_price
							@user_id,
							@slip_no	output,
							@status		output,
							@out_msg	output

		if @status > '0'
		begin
			select status=@status,out_msg=@out_msg
			return
		end

		if exists (select	*
			from EL_CD..T_VA_020 a
			where a.order_no = @order_no
			and insp_select = 'Y')
		begin
			select status='1',out_msg=' 납품완료, 입회검사품은 검사처리 불가 ????'
			return
		end
	
		if exists (select *
			from el_cd..t_va_040 
			where junpyo_no=@slip_no
			and run_status = '2')
		begin
			declare	@qty_acpt	float,
				@qty_reject	float
--검사	
			exec SP_Common_Matl_Inspection
					@slip_no,
					0	,		-- fail_qty
					'A'		,	--lot_decision
			      		''	,	--fail_code1
			      		''	,	--fail_code1
			      		''	,	--fail_code1
					@user_id,
					@qty_acpt	output,
					@qty_reject	output,
					@status		output,
					@out_msg	output

			if @status > '0'
			begin
				select status=@status,out_msg=@out_msg
				return
			end
		end

		if not exists (select *
			from el_cd..t_va_040 
			where junpyo_no=@slip_no
			and run_status = '3')
		begin
			select status='1',out_msg='System Error ???'
			return
		end
			
		declare	@amut		float
--입고
		exec SP_Common_Matl_Input
				@slip_no,
				@input_date,
		      	@store,	
				@user_id,
				@amut		output,
				@status		output,
				@out_msg	output,
				@receipt_method_flag

		if @status > '0'
			select status=@status,out_msg=@out_msg,slip_no=''
		else
			select status='0',out_msg=' 입회 검사품 입고처리 OK ..',slip_no=@slip_no,
				a.qty,date_io=isnull(convert(char(08),date_io,112),'')
			from EL_CD..T_VA_040 a
			where junpyo_no=@slip_no
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6MC_1                                                                                                                                              */
/*  DISCRIPTION  :  주문별 납품이력조회                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/12     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6MC_1]
	@order_no	varchar(08)
AS
--exec MRP.dbo.SP_MRP_6MC_1 ''
set nocount on

	exec mrp.dbo.SP_Common_Va020_Inquiry '4',@order_no 

	select junpyo_no,date_io=convert(varchar(24),date_io,121),qty_deliv,qty_acpt,
			amut,amut_won,amut_mold,run_status
	from el_cd..t_va_040 a with (index=IDX_T_VA_040_001 nolock)
	where order_no = @order_no
	and @order_no > '0'
	order by date_io,junpyo_no;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6QD_1                                                                                                                                              */
/*  DISCRIPTION  :  주문변경                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/26     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6QD_1]
	@flag			char(01),	-- S:inquiry  P:Change 
	@change_type	char(01),	-- D:duedate V:vendor Q:qty C:주문취소
	@order_no		varchar(08),
	@change_data	varchar(10)='0',
	@base_no		varchar(40)='',
	@user_id		varchar(08)=''
AS
--exec SP_MRP_6QJ_1 '7DRU4500'
set nocount on

	declare	@status		char(01),
			@out_msg	varchar(100),
			@run_status	char(01),
			@qty_remain	float,
			@supply		char(01)

	if @flag = 'S'
	begin
		exec mrp.dbo.SP_Common_Va020_Inquiry '5',@order_no

		select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				@supply=supply
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 

		if @run_status <> '4'
		begin
			select status='1',out_msg='주문집행상태에서만 작업 가능합니다 ???'
			return
		end

		if @qty_remain <= 0
		begin
			select status='2',out_msg='주문잔량이 없읍니다 ???'
			return
		end

		select status='0',out_msg='내용을 변경하고 처리하세요 .....'
		return
	end


	if @flag='P'
	begin
		exec SP_Common_Purchasing_Order_Change
				@change_type,	-- D:duedate V:vendor Q:qty C:주문취소
				@order_no,
				@change_data,
				@base_no,
				@user_id,
				@status		output,
				@out_msg	output
		if @status = '0'
		begin
			update a set
		 		a.MRP_UPDATE_FLAG = 'Y',
				a.MRP_UPDATE_DATE = getdate()
			from el_cd..t_vj_200 a
			where  a.order_no = @order_no 
			and    a.request_flag = 'Y'
			and		a.confirm_flag = 'Y'
			and	(a.mrp_update_flag = 'N' or a.mrp_update_flag is null)
		end

		select status=@status,out_msg=@out_msg
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6QG_1                                                                                                                                              */
/*  DISCRIPTION  :  주문별 변경이력조회                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/04/16     MRP Downsizing Project   S.H.SONG      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6QG_1]
	@order_no	varchar(08)
AS

--exec MRP.dbo.SP_MRP_6QG_1 ''

set nocount on
	exec mrp.dbo.SP_Common_Va020_Inquiry '6',@order_no
	
	select	order_no,
			DATE_ACT=convert(varchar(24), DATE_ACT,120)
			,prev_date=convert(char(08), DATE_DUE,112)
			,next_date=isnull(convert(char(08), DATE_CHG,112),'')
			,CHG_TYPE 
			,next_qty=(case when chg_type in ('C','P') then OPEN_ORDER-qty_chg else QTY_CHG   end)
			,prev_qty=OPEN_ORDER  
			,BASE_NO=POST_PERSON + ' (' + BASE_NO + ')'
			,APPROVE_FLAG=isnull(APPROVE_FLAG,'N')
			,APPROVE_DATE =isnull(convert(char(08), APPROVE_DATE,112),'')
			,RECEIPT_FLAG=isnull(RECEIPT_FLAG,'N')
			,RECEIPT_DATE =isnull(convert(char(08), RECEIPT_DATE,112),'')
			,REJECT_FLAG=isnull(REJECT_FLAG,'N')
			,REJECT_DATE =isnull(convert(char(08), REJECT_DATE,112),'')
			,new_order_no
	from	el_cd..t_va_030 
	where order_no = @order_no
	order by DATE_ACT;

/*********************************************************************************************************************/
/*  SP NAME      : SP_MRP_6QJ_1                                                                                      */
/*  DISCRIPTION  :  주문조회 및 관리                                                                                 */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/01/26     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6QJ_1]
	@flag		char(01),	-- S:inquiry  M:Update D:Delete V:vendor change
	@order_no	varchar(08),
	@vendor		varchar(08)='',
	@supply		char(01)='',
	@prod_no_all	varchar(20)='',

	@item_unit	varchar(02)='',
	@gaijung	varchar(04)='',
	@money_unit	varchar(03)='',
	@market_flag	char(01)='',
	@po_gubun	char(01)='',

	@due_date	varchar(08)='',
	@date_start	varchar(08)='',
	@ship_flag	char(01)='',
	@user_id	varchar(08)='',
	@post_person	varchar(04)=''
AS

--exec SP_MRP_6QJ_1 'S','00020205'
--exec mrp.dbo.SP_MRP_6QJ_1  'M','0AD30065','1012689','D','','20100212','20100202','',''
--exec MRP.dbo.SP_MRP_6QJ_1  'V','0A7B0400','1088096','','','','','','','','','','','LGJJG'

set nocount on

	declare	@status		char(01),
			@out_msg	varchar(100),
			@run_status	char(01),
			@qty_remain	float

	select	@run_status=run_status,@qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			@gaijung=(case when @gaijung < '0' then a.gaijung else @gaijung end)
	FROM el_cd.dbo.T_va_020 a	
	WHERE a.order_no = @order_no 

	if @flag in ('S')
	begin
		exec SP_Common_Va020_Inquiry '1',@order_no 

		if @run_status >= '5'
		begin
			select status='2',out_msg=' 주문완료이후 작업 불가  ???'
			return
		end
	
		if @qty_remain <= 0
		begin
			select status='2',out_msg='주문잔량이 없읍니다 ???'
			return
		end

		if @flag='S'
		begin
			select status='0',out_msg='내용을 변경하고 처리하세요 .....'
			return
		end
	end

	if @flag='V'
	begin
		declare @origin_vendor	varchar(08)
		
		select	@supply=supply,
				@prod_no_all=prod_no+PART+part_seq,
				@item_unit=item_unit,
				@gaijung=gaijung,
				@money_unit	=money_unit,
				@market_flag=market_flag,
				@po_gubun=po_gubun,
				@due_date=convert(char(08),(case when date_due > getdate() then date_due else dateadd(day,1,getdate()) end),112),
				@date_start=convert(char(08),date_start,112),
				@ship_flag=ship_flag,
				@origin_vendor = trade_no
		FROM el_cd.dbo.T_va_020 a	
		WHERE a.order_no = @order_no 
		
		if @origin_vendor = @vendor
		begin
			select status='2',out_msg='업체코드 동일 ?????'
			return
		end
		
		select @flag='M'
	end

		
	exec mrp..SP_Common_Order_Update
		@flag		,	-- M:Update D:Delete
		@order_no	,
		@vendor		,
		@supply		,
		@prod_no_all	,
		@item_unit,
		@gaijung	,
		@money_unit	,
		@market_flag	,
		@po_gubun	,

		@due_date	,
		@date_start	,
		@ship_flag	,
		@user_id	,
		@post_person,
		@status		output,
		@out_msg	output

	select status=@status,out_msg=@out_msg;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6U4_1                                                                                                                                                    */
/*  DISCRIPTION  :  검사결과입력 처리                                                                                                                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_6U4_1]
	@opt_flag		char(01),
	@slip_no		varchar(13),
	@entry_fail_qty	float=0,		
	@entry_lot_flag	char(01)='',
  	@fail_code_1	varchar(03)='',
  	@fail_code_2	varchar(03)='',
  	@fail_code_3	varchar(03)='',
	@user_id		varchar(08)=''
AS

--SP_MRP_6U4_1 '2I08100600001'
set nocount on

	if @opt_flag = 'S'
		SELECT  b.item_no,
			a.trade_no,
			eng_desc=master.dbo.fGetItemDesc(b.item_no),
			prod_no=a.prod_no+a.part+a.part_seq,
			a.qty_order,		
			b.qty_deliv,
			b.qty_acpt,
			b.qty_fail,
			a.qty_cancel,
			a.qty_reject,
			a.market_flag,
			a.date_delay,
			qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			qty_insp_ready=a.qty_deliv-a.qty_insp,
			date_start=convert(CHAR(08),a.date_start, 112),
			date_due=convert(CHAR(08),a.date_due, 112),
			date_insp=convert(CHAR(08),b.date_insp, 112),
			date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
			date_modif=convert(CHAR(08),b.date_modif, 112),
			date_print_po=convert(CHAR(08),a.date_print_po, 112),
			date_deliv=convert(CHAR(08),a.date_deliv, 112),
			b.run_status,
			b.red_code,
			b.red_jp_no,
			b.store,
			b.file_no,
			b.post_person,
			b.wc_code,
			a.po_gubun,
			a.gaijung,
			a.supply,
			a.price,
			b.money_unit,
			a.item_unit,
			draw_no=substring(a.draw_no,1,20),
	 		a.receipt_expect_no,						--납품예정번호		추가 20040620
	 		box_receipt_expect_no=(case when a.box_receipt_expect_no > '0' 
					then a.box_receipt_expect_no
					else isnull((select max(c.receipt_expect_no) 
						from el_cd.dbo.t_eb_050 b,el_cd.dbo.t_eb_040 c
						where b.project_no=left(a.prod_no,11)
						and b.mfg_no=substring(a.prod_no,12,3)
						and b.part=a.part
						and b.part_seq=a.part_seq
						and b.ref_project_no < '0'
						and c.project_no=b.project_no	
						and c.mfg_no=b.mfg_no
						and c.box_no=b.box_no
						and c.divide_seq = b.divide_seq
						and c.receipt_expect_no > '0') ,'') end),				--박스납품예정번호
	 		insp_select = case when a.insp_select = 'Y' then '검사' else '비검사' end , --검사구분		추가 20040716
			ship_flag = case when a.ship_flag = 'Y' then '출하' else '양산' end	,	--발송구분		추가 20040716
			a.part,
			b.trade_no,
			brief_trade=master.dbo.fGetVendorName(b.trade_no),
			packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
			prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''),
			box_no=isnull(a.box_no,''),
			b.qty,
			b.price_won,
			b.amut,
			b.amut_foreign,
			b.qty_insp,
			b.order_no,
			b.amut_mold,
			b.appl_mold_qty,
			insp_mtd=b.insp_mtd,
			lot_flag=isnull(c.lot_flag,''),
			insp_level=isnull(c.insp_level,''),
			range_cur=isnull(c.range_cur,''),
			insp_emp_id=isnull(c.insp_emp_id,''),
			vendor_grade=isnull(c.vendor_grade,''),
			fail_reason=isnull(c.fail_reason,''),
			qty_sample=isnull(c.qty_sample,0),
			sample_fail=isnull(c.sample_fail,0),
			acpt=isnull(c.acpt,0),
			rjt=isnull(c.rjt,0),
			sample_times=isnull(c.sample_times,0),
			date_decision=convert(CHAR(08),c.date_decision, 112),
			fail_code_1=isnull(c.fail_code_1,''),
			fail_code_2= isnull(c.fail_code_2,''),
			fail_code_3=isnull(c.fail_code_3,'')
		FROM el_cd.dbo.T_va_040 b	
				inner join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.junpyo_no=b.junpyo_no
		WHERE b.junpyo_no = @slip_no 
	else if @opt_flag = 'P'
	begin
		declare	@qty_acpt	float,
				@qty_reject	float,
				@status		char(01),
				@out_msg	varchar(100)

		exec SP_Common_Matl_Inspection
				@slip_no,
				@entry_fail_qty	,		
				@entry_lot_flag		,
		      	@fail_code_1	,
		      	@fail_code_2	,
		      	@fail_code_3	,
				@user_id,
				@qty_acpt	output,
				@qty_reject	output,
				@status		output,
				@out_msg	output

	
		if @status > '0'
			select status=@status,out_msg=@out_msg,qty_acpt=@qty_acpt,qty_reject=@qty_reject
		else
			select status='0',out_msg=' 검사처리 OK ...',qty_acpt=@qty_acpt,qty_reject=@qty_reject, run_status = '3'
--			select status='0',out_msg=' 검사처리 OK ...',qty_acpt=@qty_acpt,qty_reject=@qty_reject

		select	a.order_no, a.item_no, 
				eng_desc =master.dbo.fGetItemDesc(a.item_no),
				b.date_due, date_insp=convert(varchar(10), a.date_insp,121), a.qty_acpt, a.trade_no, 
				trade = master.dbo.fGetVendorName(a.trade_no),
				b.prod_no, b.part, b.part_seq
		from el_cd..t_va_040 a, el_cd..t_va_020 b
		where a.junpyo_no = @slip_no
		and a.order_no = b.order_no
	end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6UA_1                                                                                                                                              */
/*  DISCRIPTION  :  남품 처리                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_6UA_1]
	@flag			char(01),
	@order_no		varchar(08)='',
	@delivered_qty	float=0,
	@entry_price	float=0,
	@user_id		varchar(08)=''
as
--	exec MRP.dbo.SP_MRP_6UA_1 'S','9B030530'

	if @flag = 'S'
	begin
		exec mrp.dbo.SP_Common_Va020_Inquiry '7',@order_no

		select	junpyo_no,date_io=convert(varchar(24),date_io,121),qty_deliv,qty_acpt,
				amut,amut_won,amut_mold,run_status
		from el_cd..t_va_040 a with (index=IDX_T_VA_040_001 nolock)
		where order_no = @order_no
		and @order_no > '0'
		order by date_io,junpyo_no 
	end
	else if @flag = 'P'
	begin
		declare	@status		char(01),
				@out_msg	varchar(100),
				@slip_no	varchar(13)

		exec MRP..SP_Common_Matl_Arrival	@order_no,
				@delivered_qty,	-- 0이면 전량 납품
				@entry_price,	-- Option이 납품단가이면 적용
				@user_id,
				@slip_no	output,
				@status		output,
				@out_msg	output

		if @status > '0'
			select status=@status,out_msg=@out_msg,slip_no=''
		else
			select status='0',out_msg='납품처리 OK ...',slip_no=@slip_no, qty_deliv = ( select qty_deliv from el_cd.dbo.t_va_040 where junpyo_no = @slip_no) 
	end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6VC_1                                                                                                                                                    */
/*  DISCRIPTION  :  납품전표조회  & Update                                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_6VC_1]
	@flag		char(01),	-- S:Inquiry P:Change Process 
	@gaijung	varchar(04),
	@junpyo_no	varchar(13),
	@o_supply	char(01)='',
	@o_qty_deliv	float=0,
	@store		varchar(06)='',
	@currency	varchar(03)='',
	@user_id	varchar(08)=''
AS

--exec SP_MRP_6VC_1 '7DRU4500'
--SP_MRP_6VC_1 '2I08100600001'
set nocount on

BEGIN 

	exec SP_MRP_010_2 'MRP_6VC'

	declare	@va040_run_status	char(01),
		@qty_deliv	float,
		@qty_acpt	float,
		@order_select	char(01)

	if @flag='S'
	begin
		SELECT  b.item_no,
			b.trade_no,
			eng_desc=master.dbo.fGetItemDesc(b.item_no),
			prod_no=a.prod_no+a.part+a.part_seq,
			a.qty_order,		
			b.qty_deliv,
			b.qty_acpt,
			b.qty_fail,
			a.qty_cancel,
			a.qty_reject,
			a.market_flag,
			a.date_delay,
			qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			qty_insp_ready=a.qty_deliv-a.qty_insp,
			date_start=convert(CHAR(08),a.date_start, 112),
			date_due=convert(CHAR(08),a.date_due, 112),
			date_insp=convert(CHAR(08),b.date_insp, 112),
			date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
			date_modif=convert(CHAR(08),b.date_modif, 112),
			date_print_po=convert(CHAR(08),a.date_print_po, 112),
			date_deliv=convert(CHAR(08),a.date_deliv, 112),
			b.run_status,
			b.red_code,
			b.red_jp_no,
			b.store,
			b.file_no,
			b.post_person,
			b.wc_code,
			creator=master.dbo.fGetUserName(b.creator),
			a.po_gubun,
			b.gaijung,
			supply=upper(b.supply),
			a.price,
			b.money_unit,
			b.item_unit,
			draw_no=substring(a.draw_no,1,20),
	 		a.receipt_expect_no,						--납품예정번호		추가 20040620
	 		box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
	 		insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
			ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
			a.part,
			brief_trade=master.dbo.fGetVendorName(b.trade_no),
			packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
			prod_vendor = isnull((select master.dbo.fGetVendorName(b.vendor) from  el_cd.dbo.t_cx_060 b where b.item_no = a.item_no),''),
			box_no=isnull(a.box_no,''),
			b.qty,
			b.price_won,
			b.amut,
			b.amut_foreign,
			b.qty_insp,
			b.order_no,
			b.amut_mold,
			b.appl_mold_qty,
			insp_mtd=b.insp_mtd,
			lot_flag=isnull(c.lot_flag,''),
			insp_level=isnull(c.insp_level,''),
			range_cur=isnull(c.range_cur,''),
			insp_emp_id=isnull(c.insp_emp_id,''),
			fail_reason=isnull(c.fail_reason,''),
			qty_sample=isnull(c.qty_sample,0),
			sample_fail=isnull(c.sample_fail,0),
			acpt=isnull(c.acpt,0),
			rjt=isnull(c.rjt,0),
			date_decision=convert(CHAR(08),c.date_decision, 112),
			fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
		FROM el_cd.dbo.T_va_040 b	
				left outer join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.JUNPYO_NO=b.JUNPYO_NO
		WHERE b.JUNPYO_NO = @junpyo_no 
		and left(b.gaijung,2) = left(@gaijung,2)

		SELECT  @va040_run_status=b.run_status,
			@qty_deliv=b.qty_deliv,
			@qty_acpt=b.qty_acpt
		FROM el_cd.dbo.T_va_040 b	
		WHERE b.JUNPYO_NO = @junpyo_no 

		if @va040_run_status > '3'
			select status='1',out_msg=' 자재입고후는 수정불가 ????'
		else if @qty_acpt <> 0 and @qty_acpt <> @qty_deliv 
			select status='2',out_msg=' 부분합격인 경우 수정불가 ????'
		else
			select status='0',out_msg=' Inquiry OK ..'
	end

	if @flag = 'P'
	begin
		declare	@va020_run_status	char(01),
			@order_no		varchar(08)

		SELECT  @order_no=a.order_no,
			@va020_run_status=b.run_status,
			@va040_run_status=a.run_status,
			@qty_deliv=a.qty_deliv,
			@qty_acpt=a.qty_acpt,
			@order_select=a.supply
		FROM el_cd.dbo.T_va_040 a,el_cd..t_va_020 b
		WHERE a.JUNPYO_NO = @junpyo_no 
		and b.order_no=a.order_no

		if @va040_run_status > '3'
		begin
			select status='1',out_msg=' 자재입고후는 수정불가 ????'
			return
		end

		if @va020_run_status > '4'
		begin
			select status='1',out_msg=' 완료된 주문입니다 수정불가 ????'
			return
		end

		if @qty_acpt <> 0 and @qty_acpt <> @qty_deliv 
		begin
			select status='2',out_msg=' 부분합격인 경우 수정불가 ????'
			return
		end

		if @qty_deliv < @o_qty_deliv
		begin
			select status='3',out_msg=' 납품수량은 증가는 불가 ????'
			return
		end

		if @store > '0' and not exists ( select * from mrp..T_Mzr_a1 
						where gaijung=@gaijung
						and store = @store
						and order_select = @order_select )
		begin
			select status='3',out_msg=' 창고코드 재입력하세요 ????'
			return
		end
	
		declare	@qty	float

		select @qty=@o_qty_deliv - @qty_deliv 

		update a set
			store=@store,
			run_status=( case when a.qty_deliv + @qty = 0 then '6' else a.run_status end),
			qty_deliv=a.qty_deliv + @qty,
			qty_insp = a.qty_insp + (case when a.qty_insp = 0 then 0 else @qty end),
			qty_acpt = a.qty_acpt + (case when a.qty_acpt = 0 then 0 else @qty end),
			supply=@o_supply,
			price_won=0,
			DATE_MODIF=getdate()
		FROM el_cd.dbo.T_va_040 a
		WHERE a.junpyo_no = @junpyo_no 

		update a set
			supply=@o_supply,
			qty_deliv=a.qty_deliv + @qty,
			qty_insp = a.qty_insp + (case when a.qty_insp = 0 then 0 else @qty end),
			qty_acpt = a.qty_acpt + (case when a.qty_acpt = 0 then 0 else @qty end)
		FROM el_cd.dbo.T_va_020 a
		WHERE a.order_no = @order_no

		select status='0',out_msg=' Update OK ..'
	end
--2X09122400003


end;

/*********************************************************************************************************************/
/*  SP NAME      : SP_MRP_6XK                                                                                        */
/*  DISCRIPTION  :  　수입시스템의 도입자재 도착정보로 공장  입고처리                                                */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  ---------------------------------------------------------------                                                  */
/* 2010/02/11     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6XK]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
as
SET NOCOUNT ON
/*
declare	@status		char(01)	,
		@out_msg	varchar(100) 
exec	 SP_MRP_6XK 'MRP_6XK','2010-08-19 15:22:38.420',	@status	output,	@out_msg output
select @status	,	@out_msg 
*/
	declare	@o_Gaijung		varchar(04)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')

	CREATE TABLE #600UIM01(
		id int identity(1,1),
		[saupjag_code] [char](1) NULL,
		[unit_code] [char](1) NULL,
		[pr_no] [char](11) NULL,
		[project_no] [char](14) NULL,
		[ipgo_slip_nbr] [char](10) NULL,
		[item_no] [char](15) NULL,
		[ITEM_UNIT] [char](1) NULL,
		[item_seq] [char](2) NULL,
		[ipgo_qty] [char](12) NULL,
		[unit_measure] [char](3) NULL,
		[price] [char](16) NULL,
		[IPGO_FAMOUNT] [char](16) NULL,
		[currency_unit] [char](3) NULL,
		[price_cond] [char](3) NULL,
		[w_price] [char](13) NULL,
		[won_amt] [char](13) NULL,
		[section] [char](4) NULL,
		[req_no] [char](11) NULL,
		[file_no] [char](8) NULL,
		[ship_ctr] [char](2) NOT NULL,
		[order_no] [char](11) NOT NULL,
		[order_hang] [char](3) NOT NULL,
		[CLEAR_DATE] [char](8) NULL,
		[IPGO_DATE] [char](8) NULL,
		[input_date] [char](8) NULL,
	) 
 
 
 
	INSERT INTO #600UIM01
	EXEC otkrsefim01.GISSSFA0..S_IPGO_CW
	
	-- Global Product 팀 입고정보를 주문과 연계시킴
	update a set pr_no = b.order_no
	from #600UIM01 a, EL_CD..T_VA_020 b
	where a.item_no like 'H6%' 
	and b.item_no = a.item_no
	and b.supply = 'I'
	and b.qty_order = a.ipgo_qty
	and b.run_status < '5'
		
	declare	@id				int,
			@order_no		varchar(08),
			@item_no		varchar(15),
			@prod_no		varchar(14),
			@qty			float,
			@price_foreign		float,
			@amt_foreign		float,
			@price_won		float,
			@amt_won		float,
			@file_no			varchar(10),
			@money_unit		varchar(03),
			@date_io		varchar(08),
			@store			varchar(06),
			@va020_item_no		varchar(15),
			@va020_qty_order	float,
			@qty_remain		float,
			@vendor			varchar(08), 
			@junpyo_no		varchar(13)



	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select	id,
				order_no=pr_no,
				item_no,
				prod_no='20'+project_no,
				qty=a.ipgo_qty,
				price_foreign=a.price,
				amt_foreign=a.ipgo_famount,
				price_won=w_price,
				amt_won=a.won_amt,
				file_no=a.file_no,
				money_unit=a.currency_unit,
				date_io=a.IPGO_DATE
		from #600UIM01 a
		where not exists ( select 'y' 
							from T_600UIM01_HISTORY b 
							where b.file_no = a.file_no 
							and b.ship_ctr = a.ship_ctr 
							and b.order_no = a.order_no 
							and b.order_hang = a.order_hang
							and b.result_status = '0' )

	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	
		@id, @order_no,@item_no,@prod_no,@qty,@price_foreign,@amt_foreign,@price_won,@amt_won,
		@file_no,@money_unit,@date_io

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @status = '0'

		if @order_no < '0' and left(@item_no ,2) = 'H6'  --'H6' 로 변경해야 함. H6AK도 있음. JJG MRP TEST
		begin
			select	@order_no=order_no
			from el_cd..t_va_020 a with(index=IX_T_VA_020_C nolock)
			where item_no=@item_no
		end

		if @order_no > '0'
		begin
			select @store=to_store
			from T_MZR_03
			where gaijung=@o_gaijung
			and order_select = 'I'

			exec SP_Common_Matl_Input_Import_AUTO
				@item_no,		
				@o_gaijung,
				@store,
				'I',		--@order_select,
			
				@date_io,
				@qty,
				@amt_won,
				@money_unit,
				@amt_foreign,
				@vendor,
				@prod_no,
				'',		--@part,
				@file_no,
				@order_no,
				'',		--@user_id,
				@junpyo_no	output,
				@status		output,
				@out_msg	output

			exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg
			
   			insert	into T_600UIM01_HISTORY
   			select	convert(varchar(8), GETDATE(),112),
					GETDATE(),
					saupjag_code,
					unit_code,
					pr_no,
					project_no,
					ipgo_slip_nbr,
					item_no,
					ITEM_UNIT,
					item_seq,
					ipgo_qty,
					unit_measure,
					price,
					IPGO_FAMOUNT,
					currency_unit,
					price_cond,
					w_price,
					won_amt,
					section,
					req_no,
					file_no,
					ship_ctr,
					order_no,
					order_hang,
					CLEAR_DATE,
					IPGO_DATE,
					input_date,
					@status,
					@out_msg
   			from #600UIM01
   			where id = @id
   			
		end

	   	FETCH NEXT FROM TTT0 INTO 	
			@id, @order_no,@item_no,@prod_no,@qty,@price_foreign,@amt_foreign,@price_won,@amt_won,
			@file_no,@money_unit,@date_io
	end
	CLOSE TTT0
   	DEALLOCATE TTT0
   	

	select @status='0', @out_msg=' 수입데이타 입고처리  OK ...'

SET NOCOUNT OFF;

/*********************************************************************************************************************/
/*  SP NAME      : SP_MRP_6XN                                                                                        */
/*  DISCRIPTION  : 수입시스템의 물품대 정보를 Download 함                                                            */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  -----------------------------------------------------------------------                                          */
/* 2011/10/27     Lee, hwajin request          J.G.Jeon         Initialize                                           */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6XN]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
as
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(100) 
exec	 SP_MRP_6XN 'MRP_6XN','2010-08-19 15:22:38.420',	@status	output,	@out_msg output
select @status	,	@out_msg 
*/
	declare	@o_Gaijung		varchar(04)

	select	@o_Gaijung=mrp.dbo.fGetOption(@Job_ID,@page,'Gaijung')

	CREATE TABLE #600UIM01(
		id int identity(1,1),
		[saupjag_code] [char](1) NULL,
		[unit_code] [char](1) NULL,
		[pr_no] [char](11) NULL,
		[project_no] [char](14) NULL,
		[ipgo_slip_nbr] [char](10) NULL,
		[item_no] [char](15) NULL,
		[ITEM_UNIT] [char](1) NULL,
		[item_seq] [char](2) NULL,
		[ipgo_qty] [char](12) NULL,
		[unit_measure] [char](3) NULL,
		[price] [char](16) NULL,
		[IPGO_FAMOUNT] [char](16) NULL,
		[currency_unit] [char](3) NULL,
		[price_cond] [char](3) NULL,
		[w_price] [char](13) NULL,
		[won_amt] [char](13) NULL,
		[section] [char](4) NULL,
		[req_no] [char](11) NULL,
		[file_no] [char](8) NULL,
		[ship_ctr] [char](2) NOT NULL,
		[order_no] [char](11) NOT NULL,
		[order_hang] [char](3) NOT NULL,
		[CLEAR_DATE] [char](8) NULL,
		[IPGO_DATE] [char](8) NULL,
		[input_date] [char](8) NULL,
	) 
 
	INSERT INTO #600UIM01
	EXEC otkrsefim01.GISSSFA0..S_IPGO_CW
	
	-- Global Product 팀 입고정보를 주문과 연계시킴
	update a set pr_no = b.order_no
	from #600UIM01 a, EL_CD..T_VA_020 b
	where a.item_no like 'H6%' 
	and b.item_no = a.item_no
	and b.supply = 'I'
	and b.qty_order = a.ipgo_qty
	and b.run_status < '5'
		
	declare	@id				int,
			@order_no		varchar(08),
			@item_no		varchar(15),
			@prod_no		varchar(14),
			@qty			float,
			@price_foreign		float,
			@amt_foreign		float,
			@price_won		float,
			@amt_won		float,
			@file_no			varchar(10),
			@money_unit		varchar(03),
			@date_io		varchar(08),
			@store			varchar(06),
			@va020_item_no		varchar(15),
			@va020_qty_order	float,
			@qty_remain		float,
			@vendor			varchar(08),
			@junpyo_no		varchar(13)


	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select	id,
				order_no=pr_no,
				item_no,
				prod_no='20'+project_no,
				qty=a.ipgo_qty,
				price_foreign=a.price,
				amt_foreign=a.ipgo_famount,
				price_won=w_price,
				amt_won=a.won_amt,
				file_no=a.file_no,
				money_unit=a.currency_unit,
				date_io=a.IPGO_DATE
		from #600UIM01 a
		where not exists ( select 'y' 
							from T_600UIM01_HISTORY b 
							where b.file_no = a.file_no 
							and b.ship_ctr = a.ship_ctr 
							and b.order_no = a.order_no 
							and b.order_hang = a.order_hang
							and b.result_status = '0' )

	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	
		@id, @order_no,@item_no,@prod_no,@qty,@price_foreign,@amt_foreign,@price_won,@amt_won,
		@file_no,@money_unit,@date_io

	WHILE (@@FETCH_STATUS = 0 )	
	begin
		select @status = '0'

		if @order_no < '0' and left(@item_no ,2) = 'H6'  --'H6' 로 변경해야 함. H6AK도 있음. JJG MRP TEST
		begin
			select	@order_no=order_no
			from el_cd..t_va_020 a with(index=IX_T_VA_020_C nolock)
			where item_no=@item_no
		end

		if @order_no > '0'
		begin
			select @store=to_store
			from T_MZR_03
			where gaijung=@o_gaijung
			and order_select = 'I'

			exec SP_Common_Matl_Input_Import_AUTO
				@item_no,		
				@o_gaijung,
				@store,
				'I',		--@order_select,
			
				@date_io,
				@qty,
				@amt_won,
				@money_unit,
				@amt_foreign,
				@vendor,
				@prod_no,
				'',		--@part,
				@file_no,
				@order_no,
				'',		--@user_id,
				@junpyo_no	output,
				@status		output,
				@out_msg	output

			exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg
			
   			insert	into T_600UIM01_HISTORY
   			select	convert(varchar(8), GETDATE(),112),
					GETDATE(),
					saupjag_code,
					unit_code,
					pr_no,
					project_no,
					ipgo_slip_nbr,
					item_no,
					ITEM_UNIT,
					item_seq,
					ipgo_qty,
					unit_measure,
					price,
					IPGO_FAMOUNT,
					currency_unit,
					price_cond,
					w_price,
					won_amt,
					section,
					req_no,
					file_no,
					ship_ctr,
					order_no,
					order_hang,
					CLEAR_DATE,
					IPGO_DATE,
					input_date,
					@status,
					@out_msg
   			from #600UIM01
   			where id = @id
   			
		end

	   	FETCH NEXT FROM TTT0 INTO 	
			@id, @order_no,@item_no,@prod_no,@qty,@price_foreign,@amt_foreign,@price_won,@amt_won,
			@file_no,@money_unit,@date_io
	end
	CLOSE TTT0
   	DEALLOCATE TTT0
   	

	select @status='0', @out_msg=' 수입데이타 입고처리  OK ...'

SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_6YA_1                                                                                  */
/*  DISCRIPTION  : 주문집행용 조회                                                                               */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/02/04     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_6YA_1]
	@gaijung	    varchar(04),
	@from_due_date	varchar(08),
	@to_due_date	varchar(08),
	@vendor		    varchar(08)='',
	@prod_no	    varchar(14)= '',
	@part		    varchar(2)= ''
	
AS
SET NOCOUNT ON

--exec mrp.dbo.sp_mrp_6ya_1 'ELES','20090101','20100101'
--exec mrp.dbo.sp_mrp_6ya_1 'ELES','',''


	exec SP_MRP_010_2 'MRP_6YA'


	if @from_due_date < '0' or isdate(@from_due_date)=0
		select @from_due_date='20000101'

	if @to_due_date < '0' or isdate(@to_due_date)=0
		select @to_due_date=convert(char(08),dateadd(mm,2,getdate()),112)

set rowcount 100
	select	a.order_no
		,a.item_no
		,a.supply
		,run_status
		,date_due=convert(char(08),a.date_due,112)
		,a.price
		,price_r
		,qty_order
		,qty_deliv
		,qty_insp
		,qty_acpt
		,qty_input
		,qty_cancel
		,date_start
		,date_deliv
		,date_chg
		,po_status
		,date_delay
		,post_wc
		,prod_no=a.prod_no + ' ' + a.part + ' ' + a.part_seq
		,lc_no
		,req
		,ao_no
		,date_po
		,post_person
		,date_last
		,date_print_po
		,a.trade_no
		,skp
		,order_type
		,etc_price
		,last_ot_no
		,po_gubun
		,qty_reject
		,issue_no
		,issue_last_no
		,import_flag
		,a.market_flag
		,part_seq
		,part
		,ship_flag
		,brief_trade=master.dbo.fGetVendorName(a.trade_no)
		,eng_desc=master.dbo.fGetItemDesc(a.item_no)
	from EL_CD..T_VA_020 a with (index=ix_t_va_020_8)
	where a.run_status  between '1' and '3'
	and a.gaijung between left(@gaijung,2) and  left(@gaijung,2) + 'ZZ'
	and a.date_due between @from_due_date and @to_due_date
	and (a.trade_no = @vendor or @vendor = '')
	and (a.prod_no = @prod_no or @prod_no = '')
	and (a.part = @part or @part = '')
	order by order_no
set rowcount 0

	select status='0',out_msg=' Inquiry OK ...'
--sp_fields T_VA_020
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_6YA_2                                                                                                                                                    */
/*  DISCRIPTION  : 오더별 주문집행                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_6YA_2]
	@gaijung		varchar(04),
	@order_no		varchar(08)
AS
SET NOCOUNT ON

	declare	@status		char(01),
		@out_msg	varchar(100)

	exec SP_MRP_010_2 'MRP_6YA'

	exec	SP_Common_Purchasing_Order_Release
		@gaijung,
		@order_no,
		@status		output,
		@out_msg	output

	if @status > '0'
		select status=@status,out_msg=@out_msg
	else
		select status='0',out_msg=' Order Release OK ...'
		


SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AA_1                                                                                                                                              */
/*  DISCRIPTION  :  자재입고 처리                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_8AA_1]
	@opt_flag		char(01),
	@slip_no		varchar(13),
	@input_date		char(08)='',
    @store			varchar(06)='',
	@user_id		varchar(08)=''

AS

--exec MRP.dbo.SP_MRP_8AA_1 'P','2X10010600021',1,'20100106','WHELES','lgjjg'	
--SP_MRP_8AA_1 '2I08100600001'
set nocount on

BEGIN 


	if @opt_flag = 'S'
		exec SP_Common_Va040_Inquiry '1',@slip_no
	else if @opt_flag = 'P'
	begin
		declare	@amut	float,
				@status		char(01),
				@out_msg	varchar(100)

		exec SP_MRP_010_2 'MRP_8AA'

		exec SP_Common_Matl_Input
			@slip_no,
			@input_date,
		    @store,
			@user_id,
			@amut		output,
			@status		output,
			@out_msg	output


		select status=@status,out_msg=@out_msg

		if @status = '0'
			exec SP_Common_Va040_Inquiry '1',@slip_no

	end


end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AC_1                                                                                  */
/*  DISCRIPTION  : 입고 적자 처리                                                                                */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/02/08     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_8AC_1]
	@flag				char(01),	--S:Inquiry  P:입고반품
	@o_gaijung			varchar(04),
	@before_junpyo_no	varchar(13),
	@red_code			char(01)='',
	@o_proc_qty			varchar(10)='',
	@date_io			varchar(08)='',
	@user_id			varchar(10)=''
AS
SET NOCOUNT ON

/*
exec MRP.dbo.SP_MRP_8AC_1 'S','ELES','2X09041510047'

exec MRP.dbo.SP_MRP_8AC_1 'P','ELES','2X10020400001','136','WHELES','WON','lgjjg'
exec MRP.dbo.SP_MRP_8AC_1 'P','ELES','2X10020400001','2','-136',''
*/

	declare	@status		char(01),
			@out_msg	varchar(100) ,
			@curr_date	char(08),
			@proc_qty	float

	select @curr_date=convert(char(08),getdate(),112)

	declare	@item_no		varchar(15),
			@supply			char(01),
			@gaijung		varchar(04),
			@store			varchar(06),
			@vendor			varchar(08),
			@order_no		varchar(08)

	declare	@before_qty				float,
			@before_run_status		char(01),
			@before_money_unit		varchar(03),

			@before_mold_appl_qty	float,
			@before_mold_price		float,
			@before_amut_mold		float,

			@before_matr_amount		float,
			@before_amut_won		float,
			@before_amut_foreign	float,
			@before_price_won		float,
			@before_price_foreign	float

	declare	@after_mold_appl_qty	float,
			@after_amut_mold		float,
			@after_matr_amount		float,
			@after_amut_won			float,
			@after_amut_foreign		float

	if @flag='S'
	begin
		SELECT  b.junpyo_no,
				b.item_no,
				a.trade_no,
				eng_desc=master.dbo.fGetItemDesc(b.item_no),
				prod_no=a.prod_no+a.part+a.part_seq,
				a.qty_order,		
				b.qty_deliv,
				b.qty_acpt,
				b.qty_fail,
				a.qty_cancel,
				a.qty_reject,
				a.market_flag,
				a.date_delay,
				qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
				qty_insp_ready=a.qty_deliv-a.qty_insp,
				date_start=convert(CHAR(08),a.date_start, 112),
				date_due=convert(CHAR(08),a.date_due, 112),
				date_insp=convert(CHAR(08),b.date_insp, 112),
				date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
				date_modif=convert(CHAR(08),b.date_modif, 112),
				date_print_po=convert(CHAR(08),a.date_print_po, 112),
				date_deliv=convert(CHAR(08),a.date_deliv, 112),
				b.run_status,
				b.red_code,
				b.red_jp_no,
				b.red_status,
				b.store,
				b.file_no,
				b.post_person,
				b.wc_code,
				a.po_gubun,
				a.gaijung,
				a.supply,
				a.price,
				b.money_unit,
				a.item_unit,
				draw_no=substring(a.draw_no,1,20),
	 			a.receipt_expect_no,						--납품예정번호		추가 20040620
	 			box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
	 			insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
				ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
				a.part,
				brief_trade=master.dbo.fGetVendorName(b.trade_no),
				packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
				prod_vendor = isnull((select master.dbo.fGetVendorName(c.vendor) from  el_cd.dbo.t_cx_060 c where c.item_no = a.item_no),''),
				box_no=isnull(a.box_no,''),
				b.qty,
				b.price_won,
				b.amut,
				b.amut_foreign,
				b.qty_insp,
				b.order_no,
				b.amut_mold,
				b.appl_mold_qty,
				insp_mtd=b.insp_mtd,
				lot_flag=isnull(c.lot_flag,''),
				insp_level=isnull(c.insp_level,''),
				range_cur=isnull(c.range_cur,''),
				insp_emp_id=isnull(c.insp_emp_id,''),
				fail_reason=isnull(c.fail_reason,''),
				qty_sample=isnull(c.qty_sample,0),
				sample_fail=isnull(c.sample_fail,0),
				acpt=isnull(c.acpt,0),
				rjt=isnull(c.rjt,0),
				date_decision=convert(CHAR(08),c.date_decision, 112),
				fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
		FROM el_cd.dbo.T_va_040 b	
				inner join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.JUNPYO_NO=b.JUNPYO_NO
		WHERE b.JUNPYO_NO = @before_junpyo_no 
		and left(b.gaijung,2) = left(@o_gaijung,2)
	end

	if not exists (select *
		from EL_CD..T_VA_040 a
		where junpyo_no=@before_junpyo_no
		and left(a.gaijung,2)=left(@o_gaijung,2) )
	begin
		select status='1',out_msg='적자 처리할 전표가 없읍니다???'
		return
	end

	select	@before_qty=a.qty,
			@before_run_status=a.run_status,
			@before_money_unit=a.money_unit,
			@supply=a.supply,
			@item_no=a.item_no,
			@store=a.store,
			@before_mold_appl_qty=a.appl_mold_qty,
			@before_mold_price=(case when a.appl_mold_qty <> 0 then a.amut_mold/a.appl_mold_qty else 0 end),
			@before_amut_mold=a.amut_mold,
			@vendor=a.trade_no,
			@order_no=a.order_no,
			@gaijung=a.gaijung,
			@before_matr_amount=a.MATR_AMOUNT,
			@before_amut_won=a.AMUT_WON,
			@before_amut_foreign=a.AMUT_FOREIGN,
			@before_price_won=a.PRICE_WON,
			@before_price_foreign=a.PRICE_foreign
	from EL_CD..T_VA_040 a
	where junpyo_no=@before_junpyo_no

	if @before_run_status <> '5'
	begin
		select status='1',out_msg='입고되지 않은 전표, 적자불가 ???'
		return
	end

	if @before_qty < 0
	begin
		select status='1',out_msg='적자전표는 적자처리 불가 ??'
		return
	end

	if @flag = 'S'
	begin
		select status='0',out_msg=' Inquiry OK ...'
		return
	end
		
	if isnumeric(@o_proc_qty) = 0 
	begin
		select status='1',out_msg='적자수량을 재입력하세요 ??'
		return
	end

	select @proc_qty = convert(float,@o_proc_qty)

	if @proc_qty >= 0 
	begin
		select status='1',out_msg='적자수량은 0 보다 작아야 함 ??'
		return
	end

	if @before_qty + @proc_qty < 0
	begin
		select status='1',out_msg='적자요구량이 잔량을 초과 ???'
		return
	end

	declare	@sum_red_qty	float
 	select @sum_red_qty=isnull((select sum(qty) 
					from EL_CD..T_VA_040 a with (index=IX_T_VA_040_6 nolock)
					where red_jp_no=@before_junpyo_no),0)

	if @before_qty < @proc_qty + @sum_red_qty * (-1)
	begin
		select status='1',out_msg='적자처리가능수량을 초과하였읍니다 ???'
		return
	end

	if not (@red_code > '0' and @red_code < '7')
	begin
		select status='1',out_msg='적자코드 재입력하세요 ???'
		return
	end

	if @supply = 'I' and @proc_qty+@before_qty <> 0
	begin
		select status='1',out_msg='도입적자는 전량만 가능 ???'
		return
	end

	if @date_io < '0'
		select @date_io=@curr_date

	else if isdate(@date_io)=0
	begin
		select status='1',out_msg='적자일자를 재입력하세요 ???'
		return
	end
	
--관련 수량,금액 계산
	declare	@amt		float,
			@result_amt	float


	if @before_qty + @proc_qty = 0
	begin
		select	@after_matr_amount = 0 - @before_matr_amount
		select	@after_amut_won = 0 - @before_amut_won
		select	@after_amut_foreign = 0 - @before_amut_foreign
	end
	else
	begin
		select 	@after_matr_amount=round(@before_matr_amount / @before_qty*@proc_qty,0)
		select 	@after_amut_won=round(@before_price_won * @proc_qty,0)
		select 	@after_amut_foreign=round(@before_price_foreign * @proc_qty,0)
	end

	declare	@mold_price	float,
		@qty_mold_appl	float

	select @after_mold_appl_qty=0,@mold_price=0,@qty_mold_appl=0,@after_amut_mold=0

	if @before_mold_appl_qty > 0 
	begin
		if @before_mold_appl_qty > 0-@proc_qty
		begin
			select @after_mold_appl_qty = @proc_qty
			select @after_amut_mold=round(@after_mold_appl_qty*@before_mold_price,0)
		end
		else
		begin
			select	@after_mold_appl_qty = 0 - @before_mold_appl_qty,
				@after_amut_mold= 0 - @before_amut_mold
		end
	end

	select @amt=@after_amut_won+@after_amut_mold  -- +@after_matr_amount  jjg 수정 20111222

begin tran MRP_8AC_1

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
			@item_no,
			@gaijung,
			@store,
			@supply,
			'A',	--* A:입고 B:출고 **
	 		@date_io,
			@proc_qty,
			@amt,
			@after_matr_amount,
			@result_amt	output,
			@status 		output,
			@out_msg	output
	if @status > '0'
	begin
		rollback tran MRP_8AC_1
		select status=@status,out_msg=@out_msg
		return
	end

	if @after_mold_appl_qty <> 0
		exec SP_Common_Mold_Compute_and_Base_Update
				'2',
				@item_no,
				@vendor	,
				@after_mold_appl_qty,
				@mold_price			output,
				@qty_mold_appl		output

	declare	@initial			varchar(08),
			@after_junpyo_no	varchar(13)

	select @initial='2' + (case when @supply = 'I' then 'I' else 'X' end) +right(@curr_date,6)
	exec sp_Numbering_output 'A09',@Initial,@after_junpyo_no output

	
	insert into EL_CD..T_VA_040
	select	@after_junpyo_no
			,date_io=(case when @date_io = @curr_date then getdate() else @date_io end)
			,a.item_no
			,a.gaijung
			,a.store
			,a.supply
			,a.prod_no
			,a.order_no
			,qty = @proc_qty
			,qty_add=0
			,amut=@amt    
--			,amut=@amt-@after_matr_amount  jjg 수정 20111222

			,a.trade_no
			,a.wc_code
			,a.post_person
			,date_issue=@date_io
			,a.item_unit
			,io_select='4'
			,@after_matr_amount
			,appl_mold_qty=@after_mold_appl_qty
			,run_status='5'
			,tr=''
			,insp_select='N'
			,insp_mtd=''
			,file_no=a.file_no
			,qty_deliv = @proc_qty
			,qty_insp = @proc_qty
			,qty_acpt = @proc_qty
			,qty_special=0
			,qty_fail=0
			,price_won=a.price_won
			,price_foreign=a.price_foreign
			,amut_won=@after_amut_won
			,amut_foreign=@after_amut_foreign
			,a.money_unit
			,amut_mold=@after_amut_mold
			,date_price=@date_io
			,date_insp=getdate()
			,date_modif=getdate()
			,gu_select=''
--exec MRP.dbo.SP_MRP_8AC_1 'P','ELES','2X10020805136','1','-1',''

			,red_jp_no=@before_junpyo_no
			,red_code=@red_code
			,red_status=(case when @proc_qty + @before_qty = 0 then '0' else '1' end)
			,a.special_rej_code
			,a.factory_gubun
			,a.part
			,creator=@user_id
	from EL_CD..T_va_040 a
	where junpyo_no=@before_junpyo_no

	if  @@rowcount = 0
	begin
		rollback tran MRP_8AC_1
		select status='1',out_msg='입고적자전표 Insert Error (' + @after_junpyo_no + ') ???'
		return
	end
	
	update a set
		run_status=(case when a.run_status = '5' then '4' else a.run_status end),
		date_chg=getdate(),
		po_status = (case when a.po_status in ('4','5') then 'N' else a.po_status end),
		qty_deliv = a.qty_deliv + @proc_qty,
		qty_insp = a.qty_insp + @proc_qty,
		qty_acpt = a.qty_acpt + @proc_qty,
		qty_input = a.qty_input + @proc_qty,
		date_deliv = (case when a.po_status in ('4','5') then getdate() else a.date_deliv end)
	from EL_CD..T_VA_020 a
	where order_no = @order_no

	update a	set 
		red_junpyo_no = @after_junpyo_no
	from EL_CD..T_VJ_810 a
	where 	junpyo_no = @before_junpyo_no

	select status='0',out_msg=' 입고반품 OK ...',slip_no=@after_junpyo_no

	commit tran MRP_8AC_1;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AD_1                                                                                                                                                    */
/*  DISCRIPTION  : 도입품 수동 입고 처리                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_8AD_1]
	@item_no		varchar(15),		
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select		char(01),

	@input_date		varchar(08),
	@o_input_qty		varchar(15),
	@o_amt_won		varchar(15),
	@currency		varchar(03),
	@o_amt_foreign		varchar(15),
	@vendor			varchar(08),
	@prod_no		varchar(14),
	@part			varchar(02),
	@file_no			varchar(20),
	@order_no		varchar(08),
	@user_id		varchar(08)
AS

--exec MRP.dbo.SP_MRP_8AD_1 ','','ELES','WHELES','I','','','','','','','','','','','lgjjg'
	declare	@status		char(01),
		@out_msg	varchar(100)

	--exec SP_MRP_010_2 'MRP_8AD'

	declare	@junpyo_no	varchar(13),
		@input_qty	float,
		@amt_won	float,
		@amt_foreign	float,
		@matr_amt	float,
		@result_amt	float

	if isnumeric(@o_input_qty)=0
	begin
		select status='1',out_msg=' 입고수량 Error ???'
		return
	end


	if isnumeric(@o_amt_won)=0
	begin
		select status='1',out_msg=' 원화금액 Error ???'
		return
	end

/* jjg 강창길C 요청: 미착잔액 정리시 원화금액으로만 정리하므로 아래 체크 없앰.
	if isnumeric(@o_amt_foreign)=0 and @order_select = 'I'
	begin
		select status='1',out_msg=' 외화금액 Error ???'
		return
	end
*/
	select @input_qty=convert(float,@o_input_qty)
	select @amt_won=convert(float,@o_amt_won)
	select @amt_foreign=convert(float,@o_amt_foreign)


	exec mrp..SP_Common_Matl_Input_Manual
		@item_no,		
		@gaijung,
		@store,
		@order_select,
	
		@input_date,
		@input_qty,
		@amt_won,
		@currency,
		@amt_foreign,
		@vendor,
		@prod_no,
		@part,
		@file_no,
		@order_no,
		@user_id,
		@junpyo_no	output,
		@status		output,
		@out_msg	output
	if @status >'0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	select status='0',out_msg=(case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	SELECT  b.junpyo_no,
		b.item_no,
		b.trade_no,
		eng_desc=master.dbo.fGetItemDesc(b.item_no),
		prod_no=b.prod_no+b.part+isnull(a.part_seq,''),
		a.qty_order,		
		b.qty_deliv,
		b.qty_acpt,
		b.qty_fail,
		a.qty_cancel,
		a.qty_reject,
		a.market_flag,
		a.date_delay,
		qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
		qty_insp_ready=a.qty_deliv-a.qty_insp,
		date_start=convert(CHAR(08),a.date_start, 112),
		date_due=convert(CHAR(08),a.date_due, 112),
		date_insp=convert(CHAR(08),b.date_insp, 112),
		date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
		date_modif=convert(CHAR(08),b.date_modif, 112),
		date_print_po=convert(CHAR(08),a.date_print_po, 112),
		date_deliv=convert(CHAR(08),a.date_deliv, 112),
		b.run_status,
		b.red_code,
		b.red_jp_no,
		b.store,
		b.file_no,
		b.post_person,
		b.wc_code,
		a.po_gubun,
		b.gaijung,
		b.supply,
		a.price,
		b.money_unit,
		b.item_unit,
		draw_no=substring(a.draw_no,1,20),
 		a.receipt_expect_no,						--납품예정번호		추가 20040620
 		box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
 		insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
		ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
		a.part,
		brief_trade=master.dbo.fGetVendorName(b.trade_no),
		packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
		prod_vendor = isnull((select master.dbo.fGetVendorName(c.vendor) from  el_cd.dbo.t_cx_060 c where c.item_no = a.item_no ),''),
		box_no=isnull(a.box_no,''),
		b.qty,
		b.price_won,
		b.amut,
		b.amut_foreign,
		b.qty_insp,
		b.order_no,
		b.amut_mold,
		b.appl_mold_qty,
		insp_mtd=b.insp_mtd,
		lot_flag=isnull(c.lot_flag,''),
		insp_level=isnull(c.insp_level,''),
		range_cur=isnull(c.range_cur,''),
		insp_emp_id=isnull(c.insp_emp_id,''),
		fail_reason=isnull(c.fail_reason,''),
		qty_sample=isnull(c.qty_sample,0),
		sample_fail=isnull(c.sample_fail,0),
		acpt=isnull(c.acpt,0),
		rjt=isnull(c.rjt,0),
		date_decision=convert(CHAR(08),c.date_decision, 112),
		fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
	FROM el_cd.dbo.T_va_040 b	
			left outer join el_cd.dbo.T_va_020 a
				on a.order_no=b.order_no
			left outer join mrp.dbo.T_MVA_040_Inspection c
				on c.junpyo_no=b.junpyo_no
	WHERE b.junpyo_no = @junpyo_no;

/**************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AD_1_Gaijung_Change                                                                */
/*  DISCRIPTION  : 도입품 수동 입고 처리_계정대체용. (MRPCS의 F_CP_370에서만 사용함)                          */ 
/*                                                                                                            */
/*  >> MODIFICATION LOG <<                                                                                    */ 
/*  DATE        REQUEST #                S.E NAME         DESCRIPTION                                         */
/*  ---------------------------------------------------------------                                           */
/* 2021/03/02   META 계정 대체용         LGJJG            Initialize                                          */
/**************************************************************************************************************/

CREATE PROCEDURE  [dbo].[SP_MRP_8AD_1_Gaijung_Change]
	@item_no		varchar(15),		
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select		char(01),

	@input_date		varchar(08),
	@o_input_qty		varchar(15),
	@o_amt_won		varchar(15),
	@currency		varchar(03),
	@o_amt_foreign		varchar(15),
	@vendor			varchar(08),
	@prod_no		varchar(14),
	@part			varchar(02),
	@file_no			varchar(20),
	@order_no		varchar(08),
	@user_id		varchar(08)
AS
-- grant exec on SP_MRP_8AD_1_Gaijung_Change to applications
-- exec MRP.dbo.SP_MRP_8AD_1_Gaijung_Change '3R53717C','OSES','WHOSES','D','20210302','2','187400.00','WON','','1123759','SW98F  S999E01','v_in_part','','','T00494'
	declare	@status		char(01),
		@out_msg	varchar(100)

	--exec SP_MRP_010_2 'MRP_8AD'

	declare	@junpyo_no	varchar(13),
		@input_qty	float,
		@amt_won	float,
		@amt_foreign	float,
		@matr_amt	float,
		@result_amt	float

	if isnumeric(@o_input_qty)=0
	begin
		select status='1',out_msg=' 입고수량 Error ???'
		return
	end


	if isnumeric(@o_amt_won)=0
	begin
		select status='1',out_msg=' 원화금액 Error ???'
		return
	end

/* jjg 강창길C 요청: 미착잔액 정리시 원화금액으로만 정리하므로 아래 체크 없앰.
	if isnumeric(@o_amt_foreign)=0 and @order_select = 'I'
	begin
		select status='1',out_msg=' 외화금액 Error ???'
		return
	end
*/
	select @input_qty=convert(float,@o_input_qty)
	select @amt_won=convert(float,@o_amt_won)
	select @amt_foreign=convert(float,@o_amt_foreign)


	exec mrp..SP_Common_Matl_Input_Manual_Gaijung_Change
		@item_no,		
		@gaijung,
		@store,
		@order_select,
	
		@input_date,
		@input_qty,
		@amt_won,
		@currency,
		@amt_foreign,
		@vendor,
		@prod_no,
		@part,
		@file_no,
		@order_no,
		@user_id,
		@junpyo_no	output,
		@status		output,
		@out_msg	output
	if @status >'0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	select status='0',out_msg=(case when @order_select = 'I' then '도입품 입고 처리 OK...'
										else '매입품 입고 처리 OK...'
										end )

	SELECT  b.junpyo_no,
		b.item_no,
		b.trade_no,
		eng_desc=master.dbo.fGetItemDesc(b.item_no),
		prod_no=b.prod_no+b.part+isnull(a.part_seq,''),
		a.qty_order,		
		b.qty_deliv,
		b.qty_acpt,
		b.qty_fail,
		a.qty_cancel,
		a.qty_reject,
		a.market_flag,
		a.date_delay,
		qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
		qty_insp_ready=a.qty_deliv-a.qty_insp,
		date_start=convert(CHAR(08),a.date_start, 112),
		date_due=convert(CHAR(08),a.date_due, 112),
		date_insp=convert(CHAR(08),b.date_insp, 112),
		date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
		date_modif=convert(CHAR(08),b.date_modif, 112),
		date_print_po=convert(CHAR(08),a.date_print_po, 112),
		date_deliv=convert(CHAR(08),a.date_deliv, 112),
		b.run_status,
		b.red_code,
		b.red_jp_no,
		b.store,
		b.file_no,
		b.post_person,
		b.wc_code,
		a.po_gubun,
		b.gaijung,
		b.supply,
		a.price,
		b.money_unit,
		b.item_unit,
		draw_no=substring(a.draw_no,1,20),
 		a.receipt_expect_no,						--납품예정번호		추가 20040620
 		box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
 		insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
		ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
		a.part,
		brief_trade=master.dbo.fGetVendorName(b.trade_no),
		packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
		prod_vendor = isnull((select master.dbo.fGetVendorName(c.vendor) from  el_cd.dbo.t_cx_060 c where c.item_no = a.item_no ),''),
		box_no=isnull(a.box_no,''),
		b.qty,
		b.price_won,
		b.amut,
		b.amut_foreign,
		b.qty_insp,
		b.order_no,
		b.amut_mold,
		b.appl_mold_qty,
		insp_mtd=b.insp_mtd,
		lot_flag=isnull(c.lot_flag,''),
		insp_level=isnull(c.insp_level,''),
		range_cur=isnull(c.range_cur,''),
		insp_emp_id=isnull(c.insp_emp_id,''),
		fail_reason=isnull(c.fail_reason,''),
		qty_sample=isnull(c.qty_sample,0),
		sample_fail=isnull(c.sample_fail,0),
		acpt=isnull(c.acpt,0),
		rjt=isnull(c.rjt,0),
		date_decision=convert(CHAR(08),c.date_decision, 112),
		fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
	FROM el_cd.dbo.T_va_040 b	
			left outer join el_cd.dbo.T_va_020 a
				on a.order_no=b.order_no
			left outer join mrp.dbo.T_MVA_040_Inspection c
				on c.junpyo_no=b.junpyo_no
	WHERE b.junpyo_no = @junpyo_no;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AF_1                                                                                                                                                    */
/*  DISCRIPTION  :  도입 입고금액 수정                                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/19     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8AF_1]
	@flag		char(01),	-- S:Inquiry P:Change Process 
	@gaijung	varchar(04),
	@junpyo_no	varchar(13),
	@o_amt		float=0,
	@currency	varchar(03)='',
	@o_foreign_amt	float=0,
	@user_id	varchar(08)=''
AS

--exec SP_MRP_8AF_1 '7DRU4500'
--SP_MRP_8AF_1 '2I08100600001'
set nocount on

BEGIN 

	exec SP_MRP_010_2 'MRP_8AF'

	declare	@va040_run_status	char(01),
		@qty_deliv	float,
		@qty_acpt	float,
		@order_select	char(01)

	if @flag='S'
	begin
		SELECT  b.item_no,
			b.trade_no,
			eng_desc=master.dbo.fGetItemDesc(b.item_no),
			prod_no=a.prod_no+a.part+a.part_seq,
			a.qty_order,		
			b.qty_deliv,
			b.qty_acpt,
			b.qty_fail,
			a.qty_cancel,
			a.qty_reject,
			a.market_flag,
			a.date_delay,
			qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			qty_insp_ready=a.qty_deliv-a.qty_insp,
			date_start=convert(CHAR(08),a.date_start, 112),
			date_due=convert(CHAR(08),a.date_due, 112),
			date_insp=convert(CHAR(08),b.date_insp, 112),
			date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
			date_modif=convert(CHAR(08),b.date_modif, 112),
			date_print_po=convert(CHAR(08),a.date_print_po, 112),
			date_deliv=convert(CHAR(08),a.date_deliv, 112),
			b.run_status,
			b.red_code,
			b.red_jp_no,
			b.store,
			b.file_no,
			b.post_person,
			b.wc_code,
			a.po_gubun,
			b.gaijung,
			supply=upper(b.supply),
			a.price,
			b.money_unit,
			b.item_unit,
			draw_no=substring(a.draw_no,1,20),
	 		a.receipt_expect_no,						--납품예정번호		추가 20040620
	 		box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
	 		insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
			ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
			a.part,
			brief_trade=master.dbo.fGetVendorName(b.trade_no),
			packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
			prod_vendor = isnull((select master.dbo.fGetVendorName(c.vendor) from  el_cd.dbo.t_cx_060 c where c.item_no = a.item_no),''),
			box_no=isnull(a.box_no,''),
			b.qty,
			b.price_won,
			b.amut,
			b.amut_foreign,
			b.qty_insp,
			b.order_no,
			b.amut_mold,
			b.appl_mold_qty,
			insp_mtd=b.insp_mtd,
			lot_flag=isnull(c.lot_flag,''),
			insp_level=isnull(c.insp_level,''),
			range_cur=isnull(c.range_cur,''),
			insp_emp_id=isnull(c.insp_emp_id,''),
			fail_reason=isnull(c.fail_reason,''),
			qty_sample=isnull(c.qty_sample,0),
			sample_fail=isnull(c.sample_fail,0),
			acpt=isnull(c.acpt,0),
			rjt=isnull(c.rjt,0),
			date_decision=convert(CHAR(08),c.date_decision, 112),
			fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
		FROM el_cd.dbo.T_va_040 b	
				left outer join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.JUNPYO_NO=b.JUNPYO_NO
		WHERE b.JUNPYO_NO = @junpyo_no 
		and left(b.gaijung,2) = left(@gaijung,2)

		SELECT  @va040_run_status=b.run_status,
			@qty_deliv=b.qty_deliv,
			@qty_acpt=b.qty_acpt
		FROM el_cd.dbo.T_va_040 b	
		WHERE b.JUNPYO_NO = @junpyo_no 

		if @va040_run_status <> '5'
			select status='1',out_msg=' 자재입고전에는 수정불가 ????'
		else
			select status='0',out_msg=' Inquiry OK ..'

		return
	end

--	if @flag = 'P'

--  declare @va020_run_status	char(01), jjg with kcg 주문없이 금액 수정 가능해야 하므로 변경 20111222.

	declare	@order_no		varchar(08),
		@va040_amut_won	float,
		@item_no		varchar(15),
		@va040_gaijung		varchar(04),
		@va040_store		varchar(06),
		@va040_date_io		varchar(08)

	SELECT  @order_no=a.order_no,
		--@va020_run_status=b.run_status,  jjg with kcg 주문없이 금액 수정 가능해야 하므로 변경 20111222.
		@va040_run_status=a.run_status,
		@qty_deliv=a.qty_deliv,
		@qty_acpt=a.qty_acpt,
		@order_select=a.supply,
		@va040_amut_won=a.amut_won,
		@item_no=a.item_no,
		@va040_gaijung=a.gaijung,
		@va040_store=a.store,
		@va040_date_io=convert(varchar(08),a.date_io,112)
	FROM el_cd.dbo.T_va_040 a
	WHERE a.JUNPYO_NO = @junpyo_no 

	--FROM el_cd.dbo.T_va_040 a,el_cd..t_va_020 b  --jjg with kcg 주문없이 금액 수정 가능해야 하므로 이하 3줄 변경 20111222. 
	--WHERE a.JUNPYO_NO = @junpyo_no 
	--and b.order_no=a.order_no


	if @va040_run_status <> '5'
	begin
		select status='1',out_msg=' 자재입고전에는 수정불가 ????'
		return
	end

	if @o_amt < 0
	begin
		select status='1',out_msg=' 금액이 0보다 커야 합니다 ????'
		return
	end

	declare	@qty	float

	declare	@amut_won_diff	float,
		@status		char(01),
		@out_msg	varchar(100)

	select @amut_won_diff=@o_amt - @va040_amut_won

	declare	@result_amt	float

begin tran MRP_8AF_1

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
		@item_no,
		@va040_gaijung,
		@va040_store,
		@order_select,
		'A',	/* A:입고 B:출고 **/
	 	@va040_date_io,
		0,
		@amut_won_diff,
		0,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran MRP_8AF_1
		select status=@status,out_msg=@out_msg
		return
	end

--전표 Update
	update a set
		amut_won=a.amut_won + @amut_won_diff,
		amut=a.amut + @amut_won_diff,
		money_unit=@currency,
		amut_foreign=@o_foreign_amt,
		price_won= (a.amut + @amut_won_diff)/a.qty,
		date_modif=getdate()
	from EL_CD..T_VA_040 a
	where junpyo_no=@junpyo_no


	commit tran MRP_8AF_1
	select status='0',out_msg=' 도입 입고금액 수정 OK ..'

end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AJ_1                                                                                  */
/*  DISCRIPTION  : 입고 적흑자 처리                                                                              */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/08/10     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8AJ_1]
	@flag			char(01),	--S:Inquiry  P:입고적흑자
	@gaijung		varchar(04),
	@before_junpyo_no	varchar(13),
	@date_io		varchar(08)='',
	@user_id		varchar(10)=''

AS
SET NOCOUNT ON

/*
exec MRP.dbo.SP_MRP_8AJ_1 'P','ELES','2X10050300026','20090501','lgjjg'

*/

	exec SP_MRP_010_2 'MRP_8AJ'


	declare	@status		char(01),
		@out_msg	varchar(100) ,
		@curr_date	char(08)

	select @curr_date=convert(char(08),getdate(),112)

	declare	@item_no		varchar(15),
		@supply			char(01),
		@store			varchar(06),
		@vendor			varchar(08),
		@order_no		varchar(08)

	declare	@before_matr_amount	float,
		
		@in_amt			float


	declare	@io_date	varchar(08),
		@date_apply	varchar(08),
		@run_status	char(01),
		@va040_gaijung	varchar(04)
		
	declare	@product_code		varchar(03),
		@money_unit		varchar(03),
		@code			char(08),
		@va020_qty_order	float,
		@va040_qty_deliv		float,
		
		@va020_price		float,
		
		@result_amt		float,
		

		@date_print_po		varchar(08),
		@due_date		varchar(08),
		@date_start		varchar(08),

		@va040_price		float,
		@po_gubun		char(01),
		@qty			float,
		@diff_in_amt		float,
		@diff_in_MATR_AMOUNT	float

	if @flag='S'
	begin
		SELECT  b.junpyo_no,
			b.item_no,
			a.trade_no,
			eng_desc=master.dbo.fGetItemDesc(b.item_no),
			prod_no=a.prod_no+a.part+a.part_seq,
			a.qty_order,		
			b.qty_deliv,
			b.qty_acpt,
			b.qty_fail,
			a.qty_cancel,
			a.qty_reject,
			a.market_flag,
			a.date_delay,
			qty_remain=a.qty_order-a.qty_cancel-a.qty_deliv+a.qty_reject,
			qty_insp_ready=a.qty_deliv-a.qty_insp,
			date_start=convert(CHAR(08),a.date_start, 112),
			date_due=convert(CHAR(08),a.date_due, 112),
			date_insp=convert(CHAR(08),b.date_insp, 112),
			date_io=isnull(convert(CHAR(08),b.date_io, 112),''),
			date_modif=convert(CHAR(08),b.date_modif, 112),
			date_print_po=convert(CHAR(08),a.date_print_po, 112),
			date_deliv=convert(CHAR(08),a.date_deliv, 112),
			b.run_status,
			b.red_code,
			b.red_jp_no,
			b.red_status,
			b.store,
			b.file_no,
			b.post_person,
			b.wc_code,
			a.po_gubun,
			a.gaijung,
			a.supply,
			a.price,
			b.money_unit,
			a.item_unit,
			draw_no=substring(a.draw_no,1,20),
	 		a.receipt_expect_no,						--납품예정번호		추가 20040620
	 		box_receipt_expect_no=a.box_receipt_expect_no,			--박스납품예정번호
	 		insp_select = (case when a.insp_select = 'Y' then 'Y' else 'N' end) , --검사구분		추가 20040716
			ship_flag = case when a.ship_flag = 'Y' then 'Y' else 'N' end	,	--발송구분		추가 20040716
			a.part,
			brief_trade=master.dbo.fGetVendorName(b.trade_no),
			packing_vendor=master.dbo.fGetVendorName(a.packing_vendor),
			prod_vendor = isnull((select master.dbo.fGetVendorName(c.vendor) from  el_cd.dbo.t_cx_060 c where c.item_no = a.item_no),''),
			box_no=isnull(a.box_no,''),
			b.qty,
			b.price_won,
			b.amut,
			b.amut_foreign,
			b.qty_insp,
			b.order_no,
			b.amut_mold,
			b.appl_mold_qty,
			insp_mtd=b.insp_mtd,
			lot_flag=isnull(c.lot_flag,''),
			insp_level=isnull(c.insp_level,''),
			range_cur=isnull(c.range_cur,''),
			insp_emp_id=isnull(c.insp_emp_id,''),
			fail_reason=isnull(c.fail_reason,''),
			qty_sample=isnull(c.qty_sample,0),
			sample_fail=isnull(c.sample_fail,0),
			acpt=isnull(c.acpt,0),
			rjt=isnull(c.rjt,0),
			date_decision=convert(CHAR(08),c.date_decision, 112),
			fail_code=isnull(c.fail_code_1,'')+' ' + isnull(c.fail_code_2,'')+' ' + isnull(c.fail_code_3,'')
		FROM el_cd.dbo.T_va_040 b	
				inner join el_cd.dbo.T_va_020 a
					on a.order_no=b.order_no
				left outer join mrp.dbo.T_MVA_040_Inspection c
					on c.JUNPYO_NO=b.JUNPYO_NO
		WHERE b.JUNPYO_NO = @before_junpyo_no 
		and left(b.gaijung,2) = left(@gaijung,2)
	end

	if not exists (select *
		from EL_CD..T_VA_040 a
		where junpyo_no=@before_junpyo_no
		and left(a.gaijung,2)=left(@gaijung,2) )
	begin
		select status='1',out_msg='적흑자 처리할 전표가 없읍니다???'
		return
	end

	select	@run_status=a.run_status,
		@supply=a.supply,
		@item_no=a.item_no,
		@store=a.store,
		
		@vendor=a.trade_no,
		@order_no=a.order_no,

		@before_matr_amount=a.MATR_AMOUNT,

		@in_amt=a.amut-a.amut_mold,

		@order_no=order_no,@va040_qty_deliv=qty_deliv,
		
		@va040_gaijung=gaijung,@item_no=item_no,@vendor=trade_no,
		@money_unit=money_unit,
		@store=a.store,
		@order_no=order_no,
		@qty=a.qty
	from  EL_CD..T_VA_040  a
	where junpyo_no=@before_junpyo_no


	if @run_status <> '5'
	begin
		select status='1',out_msg='입고되지 않은 전표, 적흑자불가 ???'
		return
	end

	if @qty < 0
	begin
		select status='1',out_msg='적자전표는 적흑자처리 불가 ??'
		return
	end

	if @flag = 'S'
	begin
		select status='0',out_msg=' Inquiry OK ...'
		return
	end
		
	
	
	declare	@sum_red_qty	float
 	select @sum_red_qty=isnull((select sum(qty) 
					from EL_CD..T_VA_040 a with (index=IX_T_VA_040_6 nolock)
					where red_jp_no=@before_junpyo_no),0)

	if @qty <= @sum_red_qty
	begin
		select status='1',out_msg='적자처리가능수량을 초과하였읍니다 ???'
		return
	end


	if @date_io < '0'
		select @date_io=@curr_date

	else if isdate(@date_io)=0
	begin
		select status='1',out_msg='적자일자를 재입력하세요 ???'
		return
	end
	

	declare	@curr_date_8		char(08),
		@proc_date_io_datetime	datetime,
		@proc_date_io_8		char(08),
		@proc_matl_price		float

	select @curr_date_8 = convert(char(08),getdate(),112)

	if @date_io < '0'
		select @date_io=@curr_date_8

	else if @date_io > @curr_date_8
	begin
		select @status='1',@out_msg='입고일자가 현재일자보다 큽니다???'
		return
	end

	if  @date_io = @curr_date_8
		select @proc_date_io_datetime = getdate()
	else
		select @proc_date_io_datetime = convert(datetime,@date_io)
		
	
	if not exists (select * from EL_CD..T_VA_020 where order_no=@order_no)
	begin
		select @status='1',@out_msg='주문서가 없읍니다 ???'
		return
	end

	select 	@date_print_po=convert(char(08),date_print_po,112),
		@date_start=convert(char(08),date_start,112),
		@va020_qty_order=qty_order,
		@due_date=convert(char(08),date_due,112),
		@po_gubun=po_gubun,
		@va020_price=price
	from EL_CD..T_VA_020 a
	where order_no=@order_no


-- 납품단가 Fetch
	declare	@entry_price	float
	select	@proc_matl_price=0,@entry_price=0

	exec SP_Common_Input_Price_Search
		@va040_gaijung,
		@supply,
		@item_no,
		@vendor,
		@entry_price,
		@va040_price,
		@money_unit,
		@date_print_po,
		@due_date,
		@date_start,
		@va040_price		output,
		@proc_matl_price	output,
		@status				output,
		@out_msg			output
	
	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

--sp_fields t_va_040


	if @po_gubun = '2' or @supply not in ('X','Z')
		select @proc_matl_price=0

	select	@diff_in_amt =  round(@va040_price * @qty,0)  - @in_amt,
		@diff_in_MATR_AMOUNT=  round(@proc_matl_price * @qty,0)  - @before_matr_amount

begin tran MRP_8AJ_1

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
		@item_no,
		@va040_gaijung,
		@store,
		@supply,
		'A',	/* A:입고 B:출고 **/
	 	@date_io,
		0,		--@qty,
		@diff_in_amt,
		@diff_in_MATR_AMOUNT,		--@matr_amt,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran MRP_8AJ_1
		select status=@status,out_msg=@out_msg
		return
	end

	declare	@initial			varchar(08),
		@return_junpyo_no	varchar(13),
		@after_junpyo_no		varchar(13)


	select @initial='2' + (case when @supply = 'I' then 'I' else 'X' end) +right(@curr_date,6)
	exec sp_Numbering_output 'A09',@Initial,@return_junpyo_no output
	exec sp_Numbering_output 'A09',@Initial,@after_junpyo_no output

--적자전표 Insert
	insert into EL_CD..T_VA_040
	select	junpyo_no=@return_junpyo_no
		,date_io=@proc_date_io_datetime
		,item_no
		,gaijung
		,store
		,supply
		,prod_no
		,order_no
		,qty=0-qty
		,qty_add=0-qty_add
		,amut=0-amut
		,trade_no
		,wc_code
		,post_person
		,date_issue
		,item_unit
		,io_select
		,matr_amount=0-matr_amount
		,appl_mold_qty=0-appl_mold_qty
		,run_status
		,tr
		,insp_select
		,insp_mtd
		,file_no
		,qty_deliv=0-qty_deliv
		,qty_insp=0-qty_insp
		,qty_acpt=0-qty_acpt
		,qty_special=0-qty_special
		,qty_fail=0-qty_fail
		,price_won
		,price_foreign
		,amut_won=0-amut_won
		,amut_foreign=0-amut_foreign
		,money_unit
		,amut_mold=0-amut_mold
		,date_price
		,date_insp=getdate()
		,date_modif=getdate()
		,gu_select
		,red_jp_no=@before_junpyo_no
		,red_code='1'
		,red_status='0'
		,special_rej_code
		,factory_gubun
		,part
		,creator=@user_id
	from	el_cd..t_va_040 
	where	junpyo_no=@before_junpyo_no

	if  @@rowcount = 0
	begin
		rollback tran MRP_8AJ_1
		select status='1',out_msg='입고적자전표 Insert Error (' + @return_junpyo_no + ') ???'
		return
	end


--흑자전표 Insert
	insert into EL_CD..T_VA_040
	select	junpyo_no=@after_junpyo_no
		,date_io=@proc_date_io_datetime
		,item_no
		,gaijung
		,store
		,supply
		,prod_no
		,order_no
		,qty
		,qty_add
		,amut= round(@va040_price * @qty,0) + amut_mold
		,trade_no
		,wc_code
		,post_person
		,date_issue
		,item_unit
		,io_select
		,matr_amount=round(@proc_matl_price * @qty,0)
		,appl_mold_qty
		,run_status
		,tr
		,insp_select
		,insp_mtd
		,file_no
		,qty_deliv
		,qty_insp
		,qty_acpt
		,qty_special
		,qty_fail
		,price_won=@va040_price
		,price_foreign
		,amut_won= round(@va040_price * @qty,0)
		,amut_foreign
		,money_unit
		,amut_mold
		,date_price=getdate()
		,date_insp
		,date_modif=getdate()
		,gu_select
		,red_jp_no=''
		,red_code=''
		,red_status=''
		,special_rej_code
		,factory_gubun
		,part
		,creator=@user_id
	from	el_cd..t_va_040 
	where	junpyo_no=@before_junpyo_no

	if  @@rowcount = 0
	begin
		rollback tran MRP_8AJ_1
		select status='1',out_msg='입고흑자전표 Insert Error (' + @after_junpyo_no + ') ???'
		return
	end


--입고금액 집계 Update

	update a set	
		amut_won = a.amut_won +(case when @supply <> 'i' then @diff_in_amt else 0.0 end),
		amut_import = a.amut_import + (case when @supply = 'i' then @diff_in_amt else 0.0 end)
	from EL_CD..t_va_010 a with (index=PK___1__40)
	where 	trade_no = @vendor
	  and   in_date = @date_io
	  and 	gaijung = @va040_gaijung

	if @@rowcount = 0
	begin	
		insert into EL_CD..t_va_010
		select	@vendor,@date_io,@va040_gaijung, 
				amut_won=(case when @supply <> 'i' then @diff_in_amt else 0.0 end),
				0,0,0,0,0,0,0,
				amut_import=(case when @supply = 'i' then @diff_in_amt else 0.0 end)
	end

	commit tran MRP_8AJ_1
	select status='0',out_msg=' 입고 적흑자 처리 OK ...',return_slip_no=@return_junpyo_no,
		after_slip_no=@after_junpyo_no

SET NOCOUNT OFF;

--*****************************************************************************************************************--
--  SP NAME      : SP_MRP_8AR_1                                                                                                                                                    --
--  DISCRIPTION  : 입고금액 확정용 조회                                                                                                              -- 
--                                                                                                                                                                                                  --
--  >> MODIFICATION LOG <<                                                                                                                                                       -- 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           --
--  ---------------------------------------------------------------                                                                                  --
-- 2010/02/23     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 --
--************************************************************************************************************--

CREATE PROCEDURE [dbo].[SP_MRP_8AR_1]
	@gaijung		varchar(04),
	@year_month		varchar(08)
AS
SET NOCOUNT ON
--exec mrp.dbo.sp_mrp_8AR_1 'ELES','','MRP_8AR1'

	exec SP_MRP_010_2 'MRP_8AR'

	
--결산기간정보
	
	select	junpyo_no,item_no,
		eng_desc=master.dbo.fGetItemDesc(a.item_no),
		supply,
		qty,price_won,amut_won,matr_amount
	from el_cd..T_va_040 a
	where run_status = '4' 
	and date_io between master.dbo.fGetStartDateOfPeriod(@year_month) + ' 00:00:00'  
				and master.dbo.fGetEndDateOfPeriod(@year_month) + ' 23:59:00'
	and  supply in ('X','Z')
	and left(a.gaijung,2)=left(@gaijung,2)


--;

--*****************************************************************************************************************--
--  SP NAME      : SP_MRP_8AR_2                                                                                                                                                    --
--  DISCRIPTION  : 입고금액 확정   처리                                                                                                                 -- 
--                                                                                                                                                                                                  --
--  >> MODIFICATION LOG <<                                                                                                                                                       -- 
--  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           --
--  ---------------------------------------------------------------                                                                                  --
-- 2010/02/23     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 --
-- 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  
--************************************************************************************************************--

CREATE PROCEDURE [dbo].[SP_MRP_8AR_2]
	@o_gaijung		varchar(04),
	@junpyo_no		varchar(13),
	@o_entry_price		varchar(10)
AS
SET NOCOUNT ON
--exec MRP.dbo.SP_MRP_8AR_2 'ELES','2X10021100088','265625'

	declare	@status		char(01),
		@out_msg	varchar(100)

	declare	@proc_price		float,
		@ya14_matl_price		float,
		@entry_price		float

	exec SP_MRP_010_2 'MRP_8AR'

	if isnumeric(@o_entry_price)=0
	begin
               	select status='1',out_msg=' 단가 재입력1 ???'
		return
	end

	select @entry_price=convert(float,@o_entry_price)

	if @entry_price <= 0
	begin
               	select status='1',out_msg=' 단가 재입력2 ???'
		return
	end


	if not exists (select * from el_cd..t_va_040 where junpyo_no=@junpyo_no)
	begin
               	select status='1',out_msg=' 납품서MASTER에　존재하지않읍니다.???'
		return
	end

	declare	@qty		float,
		@va020_price	float,
		@gaijung	varchar(04),
		@item_no	varchar(15),
		@order_select	char(01),
		@run_status	char(01),
		@vendor		varchar(08),
		@money_unit	varchar(03),
		@order_no	varchar(08),
		@date_print_po	varchar(08),
		@due_date	varchar(08),
		@date_start	varchar(08)

	if not exists (select * from el_cd..t_va_040 where junpyo_no=@junpyo_no)
	begin
               	select status='1',out_msg=' 납품서MASTER에　존재하지않읍니다.???'
		return
	end

	declare	@va040_matr_amount	float,
		@va040_amut_won	float,
		@va040_gaijung		varchar(04),
		@va040_store		varchar(06),
		@va040_date_io		varchar(08),
		@po_gubun		char(01)	,
		@va040_price_won	float

	select	@qty=a.qty,@gaijung=gaijung,@order_select=supply,@item_no=item_no,@run_status=run_status,
		@vendor=trade_no,@money_unit=money_unit,@va040_price_won=price_won,
		@va040_matr_amount=matr_amount,@va040_amut_won=amut_won,
		@va040_gaijung=gaijung,@va040_store=store,
		@va040_date_io=convert(char(08),date_io,112),
		@order_no=order_no
	from el_cd..t_va_040 a
	where a.junpyo_no=@junpyo_no

	if @run_status <> '4' 
	begin
               	select status='1',out_msg=' 금액 확정처리할 전표가 아닙니다1 ???'
		return
	end

	if @order_select not in ('X','Z')
	begin
               	select status='1',out_msg=' 금액 확정처리할 전표가 아닙니다2 ???'
		return
	end

	if @va040_store < '0'
	begin
		select @va040_store=isnull((select to_store
			from t_mzr_03
			where gaijung=@va040_gaijung
			and order_select = @order_select),'')
	end


	if left(@gaijung,2) <> left(@o_gaijung,2)
	begin
               	select status='1',out_msg=' 처리할 권한이 없읍니다 ???'
		return
	end

	if @qty = 0
	begin
               	select status='1',out_msg=' 입고수량이 없읍니다 ???'
		return
	end

	select 	@date_print_po=convert(char(08),date_print_po,112),
		@due_date=convert(char(08),date_due,112),
		@date_start=convert(char(08),date_start,112),
		@va020_price=price,@po_gubun=po_gubun
	from EL_CD..T_VA_020 a
	where order_no=@order_no

	exec SP_Common_Input_Price_Search
		@gaijung,
		@order_select,
		@item_no,
		@vendor,
		@entry_price,
		@va020_price,
		@money_unit,
		@date_print_po,
		@due_date,
		@date_start,
		@proc_price		output,
		@ya14_matl_price		output,           --**추가logic ????*
		@status			output,
		@out_msg		output

	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	if @order_select in ('X','Z') and @ya14_matl_price = 0
	begin
		select status='1',out_msg=' 재료비 단가 없음 ???'
		return
	end

	declare	@matr_amount_new	float,
		@amut_won_new		float,
		@matr_amount_diff	float,
		@amut_won_diff		float

	select @matr_amount_new=round(@ya14_matl_price*@qty,0)

	select @matr_amount_diff = @matr_amount_new - @va040_matr_amount

	select @amut_won_new = round(@proc_price * @qty,0)

	select @amut_won_diff = @amut_won_new - @va040_amut_won


	declare	@result_amt	float

begin tran MRP_8AR_2

--재고 & 월수불 Update
	exec  SP_Common_Stock_Update
		@item_no,
		@va040_gaijung,
		@va040_store,
		@order_select,
		'A',	/* A:입고 B:출고 **/
	 	@va040_date_io,
		0,
		@amut_won_diff,
		@matr_amount_diff,
		@result_amt	output,
		@status 		output,
		@out_msg	output
	if @status > '0'
	begin
		rollback tran MRP_8AR_2
		select status=@status,out_msg=@out_msg
		return
	end

--전표 Update
	update a set
		run_status='5',
		date_modif=getdate(),
		amut_won=a.amut_won + @amut_won_diff,
		amut=a.amut + @amut_won_diff,
		matr_amount = a.matr_amount + @matr_amount_diff
	from EL_CD..T_VA_040 a
	where junpyo_no=@junpyo_no

	select	status='0',out_msg=' 입고금액 확정 OK ...'

	commit tran MRP_8AR_2;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8AX_1                                                                                                                                                    */
/*  DISCRIPTION  : input Summary                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/02     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_8AX_1]
	@flag		char(01),	-- 1:in_amt  2:in_amt - mold 3: mold amt 4: sale_amt 5:import
	@year_month	varchar(06), -- year,year_month
	@gaijung	varchar(04),
	@flag1		char(1)='A'   -- A:전체 1:상반기 2:하반기
AS
set nocount on
--exec MRP.dbo.SP_MRP_8AX_1 '1','201010','eles','1'

	declare	@from_date	smalldatetime,
			@to_date	smalldatetime
			
	
	if isdate(@year_month) = 0
	begin
		select *
		from el_cd..t_va_010 
		where 1=2
	
		return
	end
	

	if len(rtrim(@year_month)) = 4
	begin
		select	@from_date=left(@year_month,4)+'0101 00:00'
		select	@to_date=left(@year_month,4)+'1231 23:59'
	end
	else
	begin
		if @flag1 = '1'
		begin
			select	@from_date=left(@year_month,6)+'01 00:00'
			select	@to_date=left(@year_month,6)+'15 23:59'
		end
		else if @flag1 = '2'
		begin
			select	@from_date=left(@year_month,6)+'16 00:00'
			select	@to_date=convert(char(08),dateadd(day,-1,dateadd(m,1,left(@year_month,6)+'01')),112) + ' 23:59'
		end
		else
		begin
			select	@from_date=left(@year_month,6)+'01 00:00'
			select	@to_date=convert(char(08),dateadd(day,-1,dateadd(m,1,left(@year_month,6)+'01')),112) + ' 23:59'
		end
	end
	
	select	trade_no=a.trade_no,
			brief_trade=master.dbo.fGetVendorName(a.trade_no),
			month=convert(int,substring(convert(char(08),a.in_date,112),5,2)),
			amt=sum((case when @flag in ('1','2') then a.amut_won else 0.0 end) +
					(case when @flag in ('1','3') then a.amut_mold else 0.0 end) +
					(case when @flag in ('5') then a.amut_import else 0.0 end) +
					(case when @flag in ('4') then a.sale_amt else 0.0 end)   )
	from el_cd..t_va_010 a with (index=IX_T_VA_010_1 nolock)
	where a.in_date between @from_date and @to_date
	and left(a.gaijung,2) = left(@gaijung,2)
	group by a.trade_no,substring(convert(char(08),a.in_date,112),5,2)
	having abs(sum((case when @flag in ('1','2') then a.amut_won else 0.0 end) +
					(case when @flag in ('1','3') then a.amut_mold else 0.0 end) +
					(case when @flag in ('5') then a.amut_import else 0.0 end) +
					(case when @flag in ('4') then a.sale_amt else 0.0 end)   )) > 0.1
	order by a.trade_no,substring(convert(char(08),a.in_date,112),5,2);

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8B2                                                                                                                                                    */
/*  DISCRIPTION  : 입고 일괄 처리 (입고대기분)                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/03     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8B2]
	@job_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
	@out_msg	varchar(100) 

EXEC SP_MRP_8B2 'MRP_8B2','2010-02-03 11:04:54.147',@status output,@out_msg output

select @status,@out_msg
*/

	exec SP_MRP_010_2 'MRP_8B2'

	declare	@o_gaijung	varchar(04),
		@o_InputDate	char(08),
		@slip_no	varchar(13),
		@amut		float,
		@user_id	varchar(10),
		@today		char(8)

	select @user_id=mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page)

	select	@o_gaijung=mrp.dbo.fGetOption(@job_id,@page,'GAIJUNG')
	select	@o_InputDate=mrp.dbo.fGetOption(@job_id,@page,'InputDate')
	select	@today = CONVERT(char(8),getdate(),112)

	if (@o_InputDate > '0' and @o_InputDate <> @today )
	begin
		select @status = '1', @out_msg = '지금은 당일로만 입고 처리 됩니다. 옵션의 입고일과 현재일이 다릅니다.'
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg
		RETURN
	END

	DECLARE TTT SCROLL CURSOR FOR
		select slip_no=JUNPYO_NO
		from EL_CD..t_va_040 a with (index=ix_t_va_040_5 nolock)
		where a.date_io is null
		and a.run_status = '3'
		and a.supply <> 'I'
		and a.qty_acpt > 0
		and left(a.gaijung,2)=left(@o_gaijung,2)
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @slip_no

	WHILE (@@FETCH_STATUS = 0)	
	begin
		select @status='',@out_msg=''

		exec SP_Common_Matl_Input
			@slip_no,
			@o_InputDate,
			'',			--@store,
			@user_id,
			@amut		output,
			@status		output,
			@out_msg	output
		select @out_msg = @slip_no + ' ' + @out_msg
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg
	
	  	FETCH NEXT FROM TTT INTO @slip_no

	end
	CLOSE TTT
   	DEALLOCATE TTT

	
	

SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8EB_1                                                                                                                                              */
/*  DISCRIPTION  :  출고전표 조회 & 수정                                                                                                                               */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/28     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_8EB_1]
	@flag		char(01),	-- S:inquiry  M:Update
	@jp_no		varchar(13),
	@prod_no	varchar(14)='',
	@part		varchar(02)='',
	@part_seq	varchar(06)='',
	@out_use	char(01)='',
	@user_id	varchar(08)=''
AS

--exec SP_MRP_8EB_1 '7DRU4500'

set nocount on

BEGIN 

	
	exec SP_MRP_010_2 'MRP_8EB'

	declare	@status		char(01),
		@out_msg	varchar(100),
		@run_status	char(01),
		@supply		char(01)

	if @flag = 'S'
	begin
		SELECT  a.jp_no,
			eng_desc=master.dbo.fGetItemDesc(a.item_no)
			,date_io=convert(varchar(24),date_io,120)
			,gaijung
			,item_no
			,store
			,order_select
			,skp
			,project_no
			,mfg_no
			,part
			,part_seq
			,qty
			,amt
			,order_no
			,vendor
			,brief_trade=master.dbo.fGetVendorName(a.vendor)
			,work_center
			,out_use
			,item_group_sub
			,scrap_qty
			,etc_slip_no=isnull((select rtrim(c.jp_no) from el_cd..t_va_050 c where c.jp_no = substring(a.jp_no,2,20)),'')
			,creator=master.dbo.fGetUserName(a.creator)		
		FROM mrp.dbo.T_mva_041 a	
		WHERE a.jp_no = @jp_no 

		if @run_status >= '5'
		begin
			select status='1',out_msg='완료,취소된 제번은 수정 불가  ???'
			return
		end

		select status='0',out_msg=' Inquiry OK ....'
		return

	end


	if @flag='M'
	begin

		if not exists (select *
				from el_cd..t_ca_011 a
				where project_no=upper(substring(@prod_no,1,11))
				and mfg_no=upper(substring(@prod_no,12,3))
				and part=@part
				and part_seq=@part_seq)
		begin
			select status='1',out_msg=' 제통과 불일치 ,제번 Ckeck 바람 ???'
			return
		end


		update a set
			project_no=upper(substring(@prod_no,1,11)),
			mfg_no=upper(substring(@prod_no,12,3)),
			part=upper(@part),
			part_seq=upper(@part_seq),
			out_use=UPPER(@out_use)
		FROM mrp.dbo.T_mva_041 a	
		WHERE a.jp_no = @jp_no 

		select status='0',out_msg=' Update OK ....'
	end




end;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8ID_1                                                                                                                                                    */
/*  DISCRIPTION  : 재고조회                                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/04/22     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8ID_1]
	@item_no	varchar(15)
	
AS
SET NOCOUNT ON
--exec mrp.dbo.sp_mrp_8id_1 ''

	set rowcount 100
	
	select	item_no
		,gaijung
		,store
		,order_select
		,qty_stock
		,price_avg
		,eng_desc=master.dbo.fGetItemDesc(a.item_no),
		date_last_input=isnull(convert(varchar(24),a.date_last_input,120),''),
		date_last_output=isnull(convert(varchar(24),a.date_last_output,120),'')
	from mrp.dbo.T_MVA_061 a with (nolock)
	where a.item_no between @item_no and @item_no + 'ZZZ'
	order by a.item_no,a.gaijung,a.store,a.order_select
	set rowcount 0
	
	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8IV_0                                                                                                                                                    */
/*  DISCRIPTION  : 일자구간 구하기                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/06/16     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8IV_0]
	
AS
SET NOCOUNT ON

	select from_date = convert(char(08),dateadd(d,1,close_date),112),to_date=convert(char(08),getdate(),112)
	from el_cd..t_ex_080
	where close_code='G'



	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8IV_1                                                                                                                                                    */
/*  DISCRIPTION  : 입출고 이력조회                                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/08     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8IV_1]
	@item_no		varchar(15),
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select		char(01),
	@input_output_select	char(01),
	@from_io_date		varchar(08)='',
	@to_io_date		varchar(08)=''
	
AS
SET NOCOUNT ON
--		exec mrp.dbo.sp_mrp_8iv_1 'AEA10C613*B','ELES','WHELES','I','20091101','20091231'

	declare	@year	char(04),
			@f_date	datetime,
			@t_date	datetime

	exec SP_MRP_010_2 'MRP_8IV'


	if @from_io_date < '0' or isdate(@from_io_date)=0
		select @f_date=dateadd(d,-30,getdate())
	else
		select @f_date=@from_io_date + ' 00:00:00'

	if @to_io_date < '0' or isdate(@to_io_date)=0
		select @t_date=getdate()
	else
		select @t_date=@to_io_date+ ' 23:59:00'
	
	select @year=left(close_year_month,4)
	from mrp.dbo.t_MZR_A1
	where gaijung= @gaijung
	and store=@store
	and order_select = @order_select
	
	select a.*,
		price_trans=amt_trans/(case when qty_trans = 0 then 1.0 else qty_trans end),
		price_input=amt_input/(case when qty_input = 0 then 1.0 else qty_input end),
		price_output=amt_output/(case when qty_output = 0 then 1.0 else qty_output end)
	from mrp.dbo.T_MVA_061 a
	where item_no=@item_no
	and gaijung=@gaijung
	and store=@store
	and order_select = @order_select
	

	if @input_output_select = 'I'
		select date_io = convert(varchar(24),a.date_io,120),
				jp_no=JUNPYO_NO,flag=1,qty=qty+qty_add,amt=amut+matr_amount,
				b.prod_no,partSeq=b.part+b.part_seq,
				b.order_no,
				remark=''
		from EL_CD.dbo.T_VA_040 a with (index=ix_t_va_040_4 nolock)
			left outer join el_cd.dbo.T_VA_020 b
				on b.order_no=a.order_no
		where a.item_no=@item_no
		and a.gaijung=@gaijung
		and a.store=@store
		and a.supply = @order_select
		and a.date_io between @f_date and @t_date
		order by date_io desc,flag desc

	else if @input_output_select = 'O'
		select date_io = convert(varchar(24),a.date_io,120),
				jp_no,flag=2,qty,amt,
				prod_no=a.project_no+a.mfg_no,partSeq=a.part+a.part_seq,
				a.order_no,
				remark=isnull((select b.remark from mrp.dbo.T_OUT_REMARK b where b.jp_no = a.jp_no),0)
		from mrp.dbo.T_MVA_041 a with (index=IX_T_MVA_041_1 nolock)
		where a.item_no=@item_no
		and a.gaijung=@gaijung
		and a.store=@store
		and a.order_select = @order_select
		and a.date_io between @f_date and @t_date
		order by date_io desc,flag desc

	else
		select x.*
		from (
			select date_io = convert(varchar(24),a.date_io,120),
					jp_no=JUNPYO_NO,flag=1,qty=qty+qty_add,amt=amut+matr_amount,
					b.prod_no,partSeq=b.part+b.part_seq,
					b.order_no,
					remark=''
			from EL_CD.dbo.T_VA_040 a with (index=ix_t_va_040_4 nolock)
				left outer join el_cd.dbo.T_VA_020 b
					on b.order_no=a.order_no
			where a.item_no=@item_no
			and a.gaijung=@gaijung
			and a.store=@store
			and a.supply = @order_select
			and a.date_io between @f_date and @t_date
	
			union
	
			select date_io = convert(varchar(24),a.date_io,120),
					jp_no,flag=2,qty,amt,
					prod_no=a.project_no+a.mfg_no,partSeq=a.part+a.part_seq,
					a.order_no,
					remark=isnull((select b.remark from mrp.dbo.T_OUT_REMARK b where b.jp_no = a.jp_no),'')
			from mrp.dbo.T_MVA_041 a with (index=IX_T_MVA_041_1 nolock)
			where a.item_no=@item_no
			and a.gaijung=@gaijung
			and a.store=@store
			and a.order_select = @order_select
			and a.date_io between @f_date and @t_date) x
		order by x.date_io desc,x.flag desc
	
	
	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8IZ_1                                                                                                                                                    */
/*  DISCRIPTION  : 월수불 조회                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/10     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8IZ_1]
	@item_no	varchar(15),
	@gaijung	varchar(04),
	@store		varchar(06),
	@order_select	char(01)
AS
SET NOCOUNT ON

--exec mrp.dbo.sp_mrp_8iz_1 'AEA01D447*A ','ELES','WHELES','D'
	declare	@curr_year_month	char(06),	
			@from_year_month	char(06)
	
	exec SP_MRP_010_2 'MRP_8IZ'

	select	@curr_year_month=left(convert(char(08),dateadd(mm,1,getdate()),112),6),
			@from_year_month=left(convert(char(08),dateadd(mm,-20,getdate()),112),6)

	select a.*,
		price_trans=amt_trans/(case when qty_trans = 0 then 1.0 else qty_trans end),
		price_input=amt_input/(case when qty_input = 0 then 1.0 else qty_input end),
		price_output=amt_output/(case when qty_output = 0 then 1.0 else qty_output end)
	from mrp.dbo.T_MVA_061 a
	where item_no=@item_no
	and gaijung=@gaijung
	and store=@store
	and order_select = @order_select
	
	select a.*,
		from_date=convert(char(08),b.from_date,112),
		to_date=convert(char(08),b.to_date,112)
	from mrp.dbo.T_MVA_060 a
		left outer join EL_CD..T_CX_month b
		on b.year_month=a.year_month
	where a.item_no=@item_no
	and a.gaijung=@gaijung
	and a.store=@store
	and a.order_select = @order_select
	and a.year_month between @from_year_month and '204012'
	order by a.year_month  desc
	
	

--3R58336A 

	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8JE                                                                                                                                                    */
/*  DISCRIPTION  : 년이월처리                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/31     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8JE]
	@job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

/*

declare	@status		char(01),
	@out_msg	varchar(50) 
exec SP_MRP_8JE 'MRP_8JE','2010-09-01 16:09:18.800',@status output,@out_msg output
select @status,@out_msg


*/
	exec SP_MRP_010_2 'MRP_8JE'

	declare	@o_to_year			char(04),
		@prev_Year		char(04),
		@o_gaijung		varchar(04)

	select	@o_gaijung=mrp.dbo.fGetOption(@job_ID,@page,'Gaijung'),
		@o_to_year=mrp.dbo.fGetOption(@job_ID,@page,'year')
		

	select	@prev_year=left(convert(char(08),dateadd(year,-1,@o_to_year+'0101'),112),4)
	

--월수불처리 대상 선정

/*
	select distinct a.gaijung,a.order_select,a.store
	into #GISF8JE1
	from T_MVA_060 a with (index=IX_T_MVA_060_1)
	where a.year_month between @prev_year+'12' and @o_to_year+'12'
	and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
*/	

	select distinct a.gaijung,a.order_select,a.store
	into #GISF8JE1
	from T_MZR_A1 a
	where a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'				
	and a.current_year = @prev_year


	
	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),gaijung+'/'+store+'/'+order_select+' 수불 option 없음 ???'
	from #GISF8JE1 a
	where not exists (select *
			from T_MZR_A1 b 
			where b.gaijung=a.gaijung
			and b.store=a.store
			and b.order_select = a.order_select)

	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 수불 option 없음 ???,Error Message 확인요'
		return
	end


	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),gaijung+'/'+store+'/'+order_select+' ' + @prev_year+ '/12월수불이 마감되지 않음 ???'
	from #GISF8JE1 a
	where not exists (select *
			from T_MZR_A1 b
			where b.gaijung=a.gaijung
			and b.store=a.store
			and b.order_select = a.order_select
			and b.close_year_month = @prev_year+'12')

	if @@rowcount > 0
	begin
		select @status='1',@out_msg=@prev_year + '/12월수불이 미마감 ???'
		return
	end

	if not exists (select *
		from #GISF8JE1 a,T_MZR_A1 b
		where a.gaijung > '0'
		and b.gaijung=a.gaijung
		and b.store=a.store
		and b.order_select = a.order_select
		and b.close_year_month < @o_to_year+'01')
	begin
		select @status='1',@out_msg=@o_gaijung+' 년이월 처리대상이 없음 ???'
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg
		return
	end
	


	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),a.item_no+'/'+a.gaijung+'/'+a.store+'/'+a.order_select+' 마지막 월수불재고와 현재고 불일치 ???'
	from T_MVA_061 a,T_MVA_060 b
	where a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
	and b.item_no=a.item_no
	and b.gaijung=a.gaijung
	and b.store=a.store
	and b.order_select = a.order_select
	and b.year_month = (select max(c.year_month)
				from T_MVA_060 c
				where c.item_no=a.item_no
				and c.gaijung=a.gaijung
				and c.store=a.store
				and c.order_select = a.order_select)

	and (abs(b.qty_stock -a.qty_stock)>1 or abs(b.amt_stock - a.amt_stock)>1)

	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 마지막 월수불재고와 현재고 불일치 ???,Error Message 확인요'
		return
	end




	declare	@gaijung	varchar(04),
		@store		varchar(06),
		@order_select	char(01)

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select gaijung,store,order_select
		from #GISF8JE1
		

	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO @gaijung,@store,@order_select

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec      SP_Common_Matl_Year_Carry_Process
			@gaijung,
			@store,
			@order_select,
			@o_to_year,
			@prev_Year,
			@status output,
			@out_msg output


		select @out_msg= @gaijung + '/' + @store+ '/' + @order_select + ' ' + @out_msg
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	   	FETCH NEXT FROM TTT0 INTO 	@gaijung,@store,@order_select
	end
	CLOSE TTT0
   	DEALLOCATE TTT0

	select status='0',out_msg='년이월 처리 OK ...결과 확인 요망 '


	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8JH_1                                                                                                                                                   */
/*  DISCRIPTION  : 수불집계표 발행                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/13     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/
-- exec SP_MRP_8JH 'ELES', '201008', '201008'

CREATE PROCEDURE [dbo].[SP_MRP_8JH_1]
	@gaijung	varchar(04),
	@year_month	varchar(06)
AS
SET NOCOUNT ON
--SP_MRP_8JH_1 'eles','201008'
	

	exec SP_MRP_010_2 'MRP_8JH'

	create table #tmp(
		gaijung			varchar(04),
		store			varchar(06),
		order_select 		char(01),
		order_select_desc	varchar(50),
		amt_trans		float,
		amt_input		float,
		amt_output		float,
		amt_stock		float,
		sort			int,
		qty_trans		float,
		qty_input			float,
		qty_output		float,
		qty_stock		float
	)
	
	insert into #tmp
	select 	gaijung, 
		store, 
		order_select,
		order_select_desc=order_select,
		amt_trans=sum(amt_trans),
		amt_input=round(sum(amt_input),0,0),
		amt_output=round(sum(amt_output),0,0),
		amt_stock=sum(amt_stock),
		sort=1,
		qty_trans=sum(qty_trans),
		qty_input=sum(qty_input),
		qty_output=sum(qty_output),
		qty_stock=sum(qty_stock)
	from T_MVA_060 a 
	where year_month = @year_month 
	and left(gaijung,2) = left(@gaijung,2)
	group by gaijung,store,order_select

	insert into #tmp
	select 	gaijung, 
		store, 
		order_select,
		order_select_desc='무상사급 재료비',
		amt_trans=qty_trans,
		amt_input=qty_input,
		amt_output=qty_output,
		amt_stock=qty_stock,
		sort=2,
		0,0,0,0
	from #tmp
	where order_select in ('X','Z')
	and sort=1

	insert into #tmp
	select 	gaijung, 
		store, 
		order_select,
		order_select_desc='무상사급 가공비',
		amt_trans=amt_trans-qty_trans,
		amt_input=amt_input-qty_input,
		amt_output=amt_output-qty_output,
		amt_stock=amt_stock-qty_stock,
		sort=3,
		0,0,0,0
	from #tmp
	where order_select  in ('X','Z')
	and sort=1


	select	gaijung,
		store=store + ' ' +  substring(master.dbo.fGetCodeDesc('A92',a.store),3,30),
		order_select_desc,
		amt_trans,
		amt_input,
		amt_output,
		amt_stock,sort
	from #tmp a
	order by gaijung,store, order_select, sort


	select	order_select,
		amt_trans=sum(amt_trans),
		amt_input=sum(amt_input),
		amt_output=sum(amt_output),
		amt_stock=sum(amt_stock)
	from #tmp a
	WHERE sort=1
	group by order_select
	order  by order_select
	



	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8JP                                                                                                                                                    */
/*  DISCRIPTION  : 월수불처리                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8JP]
	@job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

/*
truncate table x_batch_job_error
declare	@status		char(01),
	@out_msg	varchar(50) 
exec SP_MRP_8JP 'MRP_8JP','2010-01-29 17:58:49.720',@status output,@out_msg output
select @status,@out_msg
select * from x_batch_job_error


*/
	exec SP_MRP_010_2 'MRP_8JP'

	declare	@o_Year_Month		char(06),
			@prev_Year_Month	char(06),
			@o_gaijung		varchar(04),
			@o_store		varchar(06),
			@o_supply		char(01)

	select	@o_year_month=mrp.dbo.fGetOption(@job_ID,@page,'AccountMonth'),
			@o_gaijung=mrp.dbo.fGetOption(@job_ID,@page,'Gaijung'),
			@o_store=mrp.dbo.fGetOption(@job_ID,@page,'store'),
			@o_supply=mrp.dbo.fGetOption(@job_ID,@page,'supply')

	select	@prev_year_month=left(convert(char(08),dateadd(month,-1,convert(smalldatetime,@o_year_month+'01')),112),6)

	

--월수불처리 대상 선정

	select distinct a.gaijung,a.order_select,a.store
	into #GISF8JP1
	from T_MVA_060 a with (index=IX_T_MVA_060_1 nolock),EL_CD..T_EX_000 b
	where a.year_month=@o_year_month
	and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
	and (@o_store < '0' or a.store=@o_store)
	and (@o_supply < '0' or a.order_select=@o_supply)
	and left(master.dbo.fGetCodeDesc('A92',a.store),1)='B'


	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),gaijung+store+order_select+' 수불 option 없음 ???'
	from #GISF8JP1 a
	where not exists (select *
			from T_MZR_A1 b
			where b.gaijung=a.gaijung
			and b.store=a.store
			and b.order_select = a.order_select)

	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 수불 option 없음 ???'
		return
	end

	insert into X_BATCH_JOB_ERROR
	select @page,@job_ID,'1',getdate(),a.gaijung+a.store+a.order_select+' 수불 마감 되었음 ???'
	from #GISF8JP1 a,T_MZR_A1 b
	where a.gaijung > '0'
	and b.gaijung=a.gaijung
	and b.store=a.store
	and b.order_select = a.order_select
	and b.close_year_month >= @o_year_month
	
	if @@rowcount > 0
	begin
		select @status='1',@out_msg=' 수불 마감 되었음 ???'
		return
	end
	

--대상 선정

	declare	@from_date		char(08),
			@to_date		char(08),
			@item_no		varchar(15),
			@gaijung		varchar(04),
			@store			varchar(06),
			@order_select	char(01)

	exec master.dbo.s_cx_month_1 @o_year_month,@from_date output, @to_date output

	DECLARE TTT0 CURSOR LOCAL SCROLL  FOR
		select distinct item_no,gaijung,store,order_select
		from T_MVA_060 a with (index=IX_T_MVA_060_1)
		where a.year_month between @prev_year_month and @o_year_month
		and a.gaijung between left(@o_gaijung,2) and left(@o_gaijung,2)+'ZZ'
		and (	a.year_month=@prev_year_month and a.qty_stock > 0 or
			a.year_month=@o_year_month)
		

	OPEN TTT0

   	FETCH NEXT FROM TTT0 INTO 	@item_no,@gaijung,@store,@order_select

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec      SP_Common_IO_Each_Accounting
			@item_no,
			@gaijung,
			@store,
			@order_select,
			@o_year_month,
			@prev_Year_Month,
			@from_date,
			@to_date,
			@status output,
			@out_msg output


		select @out_msg= @item_no + ' ' + @gaijung + ' ' + @store+ ' ' + @order_select + ' ' + @out_msg
		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	   	FETCH NEXT FROM TTT0 INTO 	@item_no,@gaijung,@store,@order_select
	end
	CLOSE TTT0
   	DEALLOCATE TTT0

	select status='0',out_msg='월수불 처리 OK ...결과 확인 요망 '


	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_8JT_1                                                                                                                                                    */
/*  DISCRIPTION  : 재고 1개 레코드별 월수불처리     (수불옵션 Check 포함)                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_8JT_1]
	@flag			char(01),	--S:Inquiry   P:월수불처리 
	@item_no		varchar(15),
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select		char(01),
	@year_month		char(06)=''
AS
SET NOCOUNT ON

/*
exec       SP_MRP_8JT_1 'P',
	'AEN53C579*D',
	'ELES',
	'WHELES',
	'D',
	'201001'

*/

	declare	@prev_Year_Month	char(06),
		@status			char(01),
		@out_msg		varchar(100)
	


	
--월수불처리 대상 선정



	declare	@zra1_price_option	char(01)	,
			@zra1_account_opt	char(01)	,
			@zra1_close_month	char(06),
			@next_from_date		char(08),
			@next_to_date		char(08)


	if @flag='S'
	begin
		exec SP_MRP_8IZ_1	@item_no,@gaijung,@store,@order_select
		return
	end

	exec SP_MRP_010_2 'MRP_8JT'


	if isdate(@year_month+'01')=0
	begin
		select status='1',out_msg=' 년월을 재입력하세요 ????'
		return
	end

	select	@prev_year_month=left(convert(char(08),dateadd(month,-1,convert(smalldatetime,@year_month+'01')),112),6)
		
	exec SP_Common_Information_ZRA1
		@gaijung,
		@store,
		@order_select,
		'20401231',
		@zra1_price_option	output,
		@zra1_account_opt	output,
		@zra1_close_month	output,
		@next_from_date		output,
		@next_to_date		output,
		@status			output,
		@out_msg		output


	if @status > '0'
	begin
		select status=@status,out_msg=@out_msg
		return
	end

	if @zra1_close_month >= @year_month
	begin
		select status='2',out_msg=@gaijung+@store+@order_select+' 수불 마감 되었음 ???'
		return
	end

	declare	@from_date	char(08),
			@to_date	char(08)

	exec master.dbo.s_cx_month_1 @year_month,@from_date output, @to_date output

	exec SP_Common_IO_Each_Accounting
		@item_no,
		@gaijung,
		@store,
		@order_select,
		@year_month,
		@prev_Year_Month,
		@from_date,
		@to_date,
		@status output,
		@out_msg output

	IF @status > '0'
	BEGIN
		select status=@status,out_msg=@out_msg
		return
	END


	select status='0',out_msg='수불  OK ...'
	
SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[SP_MRP_8JT_ONLINE]
	@gaijung		varchar(04),
	@store			varchar(06),
	@order_select	varchar(01),
	@year_month		char(06),
	@o_item_no		varchar(15)	/** space면 모든 item 수불처리  ***/
AS
SET NOCOUNT ON

	declare	@prev_Year_Month	char(06),
			@item_no_from		varchar(15),
			@item_no_to			varchar(15),
			@item_no			varchar(15),
			@status				char(01),
			@out_msg			varchar(50)
	

	if @o_item_no < '0'
		select @item_no_from='',@item_no_to='ZZZZZZZZZZZZZZZ'
	else
		select @item_no_from=@o_item_no,@item_no_to=@o_item_no

	select	@prev_year_month=left(convert(char(08),dateadd(month,-1,convert(smalldatetime,@year_month+'01')),112),6)

	
--당월 입출고가 없는 item에 대한 월수불 생성 
	

--월수불처리 대상 선정

	declare	@zra1_price_option	char(01)	,
			@zra1_account_opt	char(01)	,
			@zra1_close_date	smalldatetime,
			@zra1_year_carry_flag	char(01)

	exec SP_Common_Information_ZRA1
		@gaijung,
		@store,
		@order_select,
		@zra1_price_option	output,
		@zra1_account_opt	output,
		@zra1_close_date	output,
		@zra1_year_carry_flag	output

	if @zra1_year_carry_flag is null
	begin
		select status='1',out_msg=@gaijung+@store+@order_select+' 수불 option 없음 ???'
		return
	end
	
	if @zra1_close_date >= @year_month+'01' 
	begin
		select status='1',out_msg=@gaijung+@store+@order_select+' 수불 마감 되었음 ???'
		return
	end

	if @zra1_year_carry_flag in ('1','2')
	begin
		select status='1',out_msg=@gaijung+@store+@order_select+' 년이월중 ???'
		return
	end

	
	declare	@from_date	char(08),
			@to_date	char(08)

	exec master.dbo.s_cx_month_1 @year_month,@from_date output, @to_date output

	DECLARE TTT SCROLL CURSOR FOR
		select item_no
		from T_MVA_060 a with (index=PK_T_MVA_060 nolock)
		where a.year_month=@year_month
		and a.gaijung = @gaijung
		and a.item_no between @item_no_from and @item_no_to
		and a.store=@store
		and a.order_select=@order_select
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @item_no

	WHILE (@@FETCH_STATUS = 0)	begin
		begin tran SP_MRP_8JT_ONLINE 

--item별 월수불처리
		exec      SP_Common_IO_Each_Accounting
			@gaijung,
			@store,
			@order_select,
			@year_month,
			@item_no,
			@prev_Year_Month,
			@from_date,
			@to_date,
			@status output,
			@out_msg output

		IF @@ERROR = 0 and  @status = ''
		BEGIN
			COMMIT TRAN SP_MRP_8JT_ONLINE
		END
		ELSE
		BEGIN	
			ROLLBACK TRAN SP_MRP_8JT_ONLINE
			CLOSE TTT
			DEALLOCATE TTT
			select status='1',out_msg=@item_no+'수불처리중 Error, 재시도 바람??'
			return
		END


	  	FETCH NEXT FROM TTT INTO @item_no
	end
	CLOSE TTT
   	DEALLOCATE TTT

	
SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8ML_1                                                                                  */
/*  DISCRIPTION  :  비정규출고／반품 입력                                                                        */ 
/*                                                                                                               */
/*  >> MODIFICATION LOG <<                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                      */
/*  ---------------------------------------------------------------                                              */
/* 2010/03/19     MRP Downsizing Project   J.J.Park      Initialize                                              */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                  */
/*****************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8ML_1]
	@gubun		char(01),	-- A:출고  B:출고반품

	@gaijung	varchar(04),
	@item_no	varchar(15),
	@store		varchar(06),
	@supply		char(01),

	@o_qty		varchar(10),

	@io_date	varchar(08),

	@skp		char(01),
	@vendor		varchar(08),
	@out_use	char(01),

	@prod_no	varchar(14),
	@part		varchar(02),
	@part_seq	varchar(04),

	@order_no	varchar(08),

	@user_id	varchar(08)='',
	@Remark		varchar(255)=''
AS

--exec MRP.dbo.SP_MRP_8ML_1  'B''ELES','AEN57C325*A','WHELES','D','27.00','20100415','1','','1','98F  S999E01','TM','AAA0','S999E01'

--SP_MRP_8ML_1 '2I08100600001'
set nocount on

BEGIN 

	exec SP_MRP_010_2 'MRP_8ML'

	select	@item_no=upper(@item_no),
		@store=upper(@store),
		@skp=upper(@skp),
		@prod_no=upper(@prod_no),
		@part=upper(@part),
		@part_seq=upper(@part_seq),
		@order_no=upper(@order_no)
		
	declare	@market_flag	char(01),
		@qty		float,
		@curr_date	char(08)

	select	@curr_date=convert(char(08),getdate(),112)

	if @io_date < '0'
		select @io_date = @curr_date


	if @gubun not in ('A','B')
	begin
		select status='1',out_msg=' 출고구분 재입력하세요 ????'
		return
	end

     
	if @supply not in ('D','I','S','X','Z')
	begin
		select status='1',out_msg=' Supply 재입력하세요 ????'
		return
	end
  
  
     	if  not exists (select *
		from el_cd..t_cx_060 a
		where a.item_no = @item_no)
	begin
		select status='1',out_msg=' Item No 재입력하세요 ????'
		return
	end

	if isnumeric(@o_qty)=0
	begin
		select status='1',out_msg=' Quantity 재입력하세요 ????'
		return
	end

	select @qty = convert(float,@o_qty)

	if @qty <= 0
	begin
		select status='1',out_msg=' Quantity는 0보다 커야 함 ????'
		return
	end

	if isdate(@io_date)=0
	begin
		select status='1',out_msg=' 출고일자 재입력 ???'
		return
	end
	
     	if  not exists (select *
		from mrp..t_mzr_a1 a
		where a.gaijung = @gaijung
		and store=@store
		and order_select=@supply)
	begin
		select status='1',out_msg=' Store 재입력하세요 ????'
		return
	end

--	if @prod_no not like '%98F  S999%'
	if (@prod_no not like '%98F  S999%' and @prod_no not like '%98F  S888%')	
	begin
	     	if not exists (select *
			from el_cd..t_CC_010 a
			where a.project_no = left(@prod_no,11)
			and a.mfg_no = substring(@prod_no,12,3))
		begin
			select status='1',out_msg=' Prod No  재입력하세요 ????'
			return
		end

	     	if  not exists (select *
			from el_cd..t_CC_010 a
			where a.project_no = left(@prod_no,11)
			and a.mfg_no = substring(@prod_no,12,3)
			and left(a.gaijung,2) = left(@gaijung,2)  )
		begin
			select status='1',out_msg=' 처리할 권한이 없는 제번 ????'
			return
		end
	end

     	if  exists (select *
		from el_cd..t_CC_010 a
		where a.project_no = left(@prod_no,11)
		and a.mfg_no = substring(@prod_no,12,3)
		and a.suju_close_flag in ('C','L') )
	begin
		select status='1',out_msg=' Prod No  Canceled ????'
		return
	end


	select @market_flag=market_flag
	from el_cd..t_CC_010 a
	where a.project_no = left(@prod_no,11)
	and a.mfg_no = substring(@prod_no,12,3)

	--if @prod_no not like '%98F  S999%'
	--begin
	--     	if  not exists (select *
	--		from el_cd..t_Ca_011 a
	--		where a.project_no = left(@prod_no,11)
	--		and a.mfg_no = substring(@prod_no,12,3)
	--		and a.part=@part
	--		and a.part_seq = @part_seq)
	--	begin
	--		select status='1',out_msg=' 수불대장에 없는 정보입니다 ????'
	--		return
	--	end
	--end

    if  @skp not in ('S','X','1')
	begin
		select status='1',out_msg=' SKP 재입력하세요 ????'
		return
	end

	if @skp > '1'
	begin
	     	if  not exists (select *
			from el_cd..t_cx_080 a
			where a.trade_no = @vendor)
		begin
			select status='1',out_msg=' Vendor 재입력하세요 ????'
			return
		end
	end

	declare	@result_amt	float,
		@status		char(01),
		@out_msg	varchar(100)

	if @gubun = 'B'
		select @qty = 0 - @qty

begin tran MRP_8ML_1

	exec  SP_Common_Stock_Update
		@item_no,
		@gaijung,
		@store,
		@supply,
		'B',	--* A:입고 B:출고 **
	 	@io_date,
		@qty,
		0,
		0,
		@result_amt	output,
		@status 		output,
		@out_msg	output

	if @status > '0'
	begin
		rollback tran MRP_8ML_1
		select status=@status,out_msg=@out_msg
		return
	end
	

--2.출고전표 생성

	declare	@code	varchar(08),
		@issue_slip_no	varchar(13)

	select @code='G2'+ right(@curr_date,6)
	exec master.dbo.sp_Numbering_output 'A10',@code,	@issue_slip_no output


	insert into t_mva_041
	select	jp_no=@issue_slip_no
		,date_io=(case when @io_date = @curr_date then getdate() else @io_date end)
		,gaijung=@gaijung
		,item_no=@item_no
		,store=@store
		,order_select=@supply
		,skp=@skp
		,project_no=left(@prod_no,11)
		,mfg_no=substring(@prod_no,12,3)
		,part=@part
		,part_seq=@part_seq
		,qty=@qty
		,amt=@result_amt
		,order_no=@order_no
		,vendor=@vendor
		,work_center=''
		,out_use=@out_use
		,item_group_sub=''
		,scrap_qty=0
		,creator=@user_id

	if  @@rowcount = 0
	begin
		rollback tran MRP_8ML_1
		select status='1',out_msg='출고전표 Insert Error (' + @issue_slip_no + ') ???'
		return
	end

	if @Remark > '0'
	begin
		insert into mrp.dbo.T_OUT_REMARK
		select jp_no=@issue_slip_no, Remark=@Remark
	end

	commit tran MRP_8ML_1
	select status='0',out_msg=(case when @gubun = 'A' then '출고'  else '출고반품' end) + ' 처리 OK ..',slip_no=@issue_slip_no

	SELECT  a.jp_no
		,eng_desc=master.dbo.fGetItemDesc(a.item_no)
		,date_io=convert(varchar(24),date_io,120)
		,gaijung
		,item_no
		,store
		,order_select
		,skp
		,project_no
		,mfg_no
		,part
		,part_seq
		,qty
		,amt
		,order_no
		,vendor
		,brief_trade=master.dbo.fGetVendorName(a.vendor)
		,work_center
		,out_use
		,item_group_sub
		,scrap_qty
	FROM mrp.dbo.T_mva_041 a	
	WHERE a.jp_no = @issue_slip_no 

end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_8UM_1                                                                                                                               */
/*  DISCRIPTION  :  유상판매전표조회                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/22     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_8UM_1]
	@slip_no		varchar(12)

as

	if len(rtrim(@slip_no))=8
		select	jp_no
			,vendor=trade_no
			,brief_trade=master.dbo.fGetVendorName(a.trade_no)
			,item_no
			,eng_desc=master.dbo.fGetItemDesc(a.item_no)
			,gaijung
			,supply
			,prod_no
			,order_no
	
			,date_issue=convert(char(08),date_issue,112)
	
			,qty
			,price
			,amut
	
			,post_person
	
			,date_account=convert(char(08),date_account,112)
			,pass_no
	
			,price_buy
			,issue_amt
			,out_use
	
			,print_cnt
			,invoice_no
			,cancel_date
		from	el_cd..t_va_050  a
		where order_no=@slip_no
	else
		select	jp_no
			,vendor=trade_no
			,brief_trade=master.dbo.fGetVendorName(a.trade_no)
			,item_no
			,eng_desc=master.dbo.fGetItemDesc(a.item_no)
			,gaijung
			,supply
			,prod_no
			,order_no
	
			,date_issue=convert(char(08),date_issue,112)

			,qty
			,price
			,amut
	
			,post_person
	
			,date_account=convert(char(08),date_account,112)
			,pass_no
	
			,price_buy
			,issue_amt
			,out_use
	
			,print_cnt
			,invoice_no
			,cancel_date
		from	el_cd..t_va_050  a
		where jp_no=@slip_no;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_9SM_0                                                                                                                                              */
/*  DISCRIPTION  :  유상판매입력 준비                                                                                                                            */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/23     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_9SM_0]
	@order_no		varchar(08)
as
BEGIN
--exec  SP_MRP_9SM_0 '9B687780'

--exec MRP.dbo.SP_MRP_9SM_1 '9B001965','','','','','','','','','','','','lgjjg'
	declare	@status		char(01),
		@out_msg	varchar(100),
		@jp_no		varchar(13)

	exec SP_MRP_010_2 'MRP_9SM'

	select *
	from EL_CD..t_va_020
	where order_no=@order_no
	
end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_9SM_1                                                                                                                                              */
/*  DISCRIPTION  :  유상판매입력                                                                                                                            */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/02/22     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_9SM_1]
	@o_order_no		varchar(08)='',
	@o_item_no		varchar(15)='',
	@o_gaijung		varchar(04)='',
	@o_store		varchar(06)='',
	@o_supply		char(01)='',
	@o_vendor		varchar(08)='',
	@o_prod_no		varchar(14)='',
	@o_red_gubun		char(01)='',
	@o_date_io		varchar(08)='',
	@o_sale_qty		varchar(10)='0',
	@o_sale_price		varchar(10)='0',
	@o_out_use		char(01)='',
	@user_id		varchar(08)=''

as
BEGIN

--exec MRP.dbo.SP_MRP_9SM_1 '9B001965','','','','','','','','','','','','lgjjg'
	declare	@status		char(01),
			@out_msg	varchar(100),
			@jp_no		varchar(13)

	exec SP_MRP_010_2 'MRP_9SM'

	if @o_out_use = 'S' and @o_vendor = '1123761' 
	begin
		select @o_out_use = 'K'
	end

	exec	SP_Common_Item_Sale
		@o_order_no		,
		@o_item_no		,
		@o_gaijung		,
		@o_store		,
		@o_supply		,
		@o_vendor		,
		@o_prod_no		,
		@o_red_gubun		,
		@o_date_io		,
		@o_sale_qty		,
		@o_sale_price		,
		@o_out_use		,
		'',			--@o_req_date	
		0,			--@o_seq     		int,

		@user_id		,
		@jp_no			output,
		@status			output,
		@out_msg		output

	select status=@status,out_msg=@out_msg,jp_no=@jp_no

	if @status = '0'
		exec SP_MRP_8UM_1 @jp_no

	
end;

/****** 개체: 저장 프로시저 dbo.S_CB_080    스크립트 날짜: 02-06-08 오전 11:13:47 ******/
/****************************************************************************************/
/*                                                                            						*/
/*  SP NAME      : S_CB_080	                                                 				*/
/*                                                                            						*/
/*  DESCRIPTION  : 대일정 정보 Download 		  					*/
/*									      		*/
/*  OUTPUT PARAM : NONE							      	*/
/*                                                                            						*/
/*                                                                            						*/
/*			>> MODIFICATION LOG <<		                      			*/
/*									      		*/
/*  DATE        REQUEST #       S.E NAME         DESCRIPTION		      			*/
/*  ----------------------------------------------------------------------------------	*//*  ?????   	??       	     ???     	INITIAL DESIGN		      			*/
/*  03/03/12    080-009	     lgkhy		Download대상 필드 추가(대수, model_type)	 	*/
/****************************************************************************************/
CREATE PROCEDURE SP_MRP_CB_082	
	@gaijung	varchar(4),
	@upd_date_from	smalldatetime,
	@upd_date_to	smalldatetime
as
--SP_MRP_CB_082 'ELES','20090601','20090602'
  	select	x.project_no,
		x.mfg_no,
		x.part,
		x.plan_date
    	from	T_CC_030 x with (index=IX_T_CC_030_2 nolock),T_CC_010 i
--향후 upd_date를 index추가
	where	x.plan_date BETWEEN @upd_date_from AND @upd_date_to
	and	x.part between '' and 'ZZ'
	and	x.point='4'
	and	x.confirm_flag='Y'
	and	i.project_no=x.project_no
	and	i.mfg_no=x.mfg_no
	and	left(i.gaijung,2)=left(@gaijung,2);

/*********************************************************************************************************************/
/*  SP NAME      : SP_MRP_ICC_1                                                                                      */
/*  DISCRIPTION  :  원재료 / 유상판매 List                                                                           */ 
/*                                                                                                                   */
/*  >> MODIFICATION LOG <<                                                                                           */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                          */
/*  --------------------------------------------------------------_                                                  */
/* 2010/04/06     MRP Downsizing Project   J.J.Park      Initialize                                                  */
/* 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                      */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_ICC_1]
	@from_date	varchar(08),
	@to_date	varchar(08)
AS
--exec SP_MRP_ICC_1 '20100101','20100131'
set nocount on
BEGIN 

	--exec SP_MRP_010_2 'MRP_ICC'

	create table #aa (
		trade_no	varchar(08),
		gaijung		varchar(04),
		first_amt	float,
		second_amt	float,
		tot_amt		float,
		biz			varchar(03)
	)

	insert into #aa 
	select 	a.trade_no,
			a.gaijung,
			first_amt=sum(case when right(convert(char(08),a.date_io,112),2) < '16'
					then a.amut  else 0 end),
			second_amt=sum(case when right(convert(char(08),a.date_io,112),2) > '15'
					then a.amut  else 0 end),
			tot_amt=sum(a.amut),
			''
	from EL_CD..T_VA_040 a
	where a.date_io between @from_date + ' 00:00:00' and @to_date + ' 23:59:00'
	and a.supply in ('D','S','X','Z')
	group by a.trade_no,a.gaijung

	update a set
		Biz = (case a.gaijung when  'SYHP'	then 'WBP'
				when 'SYSS' then 'WBP'
				when 'SPSS' then 'GBO'
				when 'OSES' then 'OSE'
				else (case when a.gaijung > 'EL' and a.gaijung < 'ELZZ'
					then  'WBE' else '???' end) end)
	from #aa a
   
	select 	b.business_no,
			a.trade_no,
			brief_trade=isnull(b.brief_trade,'< VENDOR NOT FOUND >'),
			a.Biz,
			a.gaijung,
			a.first_amt,
			a.second_amt,
			a.tot_amt,
			vat_amt=(case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end)
	from #aa  a left outer join EL_CD..T_CX_080 b
		on b.trade_no = a.trade_no
	order by a.biz,b.business_no,a.trade_no,a.gaijung

	create table #bb (
		trade_no	varchar(08),
		gaijung		varchar(04),
		first_amt	float,
		second_amt	float,
		tot_amt		float,
		first_cost	float,
		second_cost	float,
		tot_cost	float,
		biz			varchar(03)
	)

	insert into #bb
	select 	a.trade_no,
			a.gaijung,
			first_amt=sum(case when right(convert(char(08),a.date_issue,112),2) < '16'
					then a.amut  else 0 end),
			second_amt=sum(case when right(convert(char(08),a.date_issue,112),2) > '15'
					then a.amut  else 0 end),
			tot_amt=sum(a.amut),
			first_cost=sum(case when right(convert(char(08),a.date_issue,112),2) < '16'
					then round(a.price_buy*a.qty,0)  else 0 end),
			second_cost=sum(case when right(convert(char(08),a.date_issue,112),2) > '15'
					then round(a.price_buy*a.qty,0)  else 0 end),
			tot_cost=sum(round(a.price_buy*a.qty,0)),
			''
	from EL_CD..T_VA_050  a with (index=ix_t_va_050_1 nolock) 
	where a.date_issue between @from_date + ' 00:00:00' and @to_date + ' 23:58:00'
	and a.out_use not in ('R')
	group by a.trade_no,a.gaijung

	update a set
		Biz = (case a.gaijung when  'SYHP'	then 'WBP'
				when 'SYSS' then 'WBP'
				when 'SPSS' then 'GBO'
				when 'OSES' then 'OSE'
				else (case when a.gaijung > 'EL' and a.gaijung < 'ELZZ'
					then  'WBE' else '???' end) end)
	from #bb a
   
	select 	b.business_no,
			a.trade_no,
			brief_trade=isnull(b.brief_trade,'< VENDOR NOT FOUND >'),
			a.Biz,
			a.gaijung,
			a.first_amt,
			a.second_amt,
			a.tot_amt,
			vat_amt=(case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end),
			a.first_cost,
			a.second_cost,
			a.tot_cost
	from #bb  a left outer join EL_CD..T_CX_080 b
		on b.trade_no = a.trade_no
	order by a.biz,b.business_no,a.trade_no,a.gaijung

--Grand Total  원재료입고
	select 	Biz,
			descr=biz + ' Total',
			first_amt=sum(a.first_amt),
			second_amt=sum(a.second_amt),
			tot_amt=sum(a.tot_amt),
			vat_amt=sum((case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end))
	from #aa  a
	group by a.biz
	union all
	select 	Biz='XXX',
			descr=' Grand Total',
			first_amt=sum(a.first_amt),
			second_amt=sum(a.second_amt),
			tot_amt=sum(a.tot_amt),
			vat_amt=sum((case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end))
	from #aa  a
	order by a.biz

--Grand Total  판매

	select 	Biz,
			descr=biz + ' Total',
			first_amt=sum(a.first_amt),
			second_amt=sum(a.second_amt),
			tot_amt=sum(a.tot_amt),
			vat_amt=sum((case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end)),
			first_cost=sum(a.first_cost),
			second_cost=sum(a.second_cost),
			tot_cost=sum(a.tot_cost)
	from #bb  a
	group by a.biz
	union all
	select 	Biz='XXX',
			descr=' Grand Total',
			first_amt=sum(a.first_amt),
			second_amt=sum(a.second_amt),
			tot_amt=sum(a.tot_amt),
			vat_amt=sum((case when right(@to_date,2) > '15' then floor(tot_amt*0.1) else 0 end)),
			first_cost=sum(a.first_cost),
			second_cost=sum(a.second_cost),
			tot_cost=sum(a.tot_cost)
	from #bb  a
	order by a.biz

end;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_T1A_1                                                                                                                                              */
/*  DISCRIPTION  :  Spec Code Management  & Inquiry                                                                                                */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/29     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/



CREATE PROCEDURE [dbo].[SP_MRP_T1A_1]
	@flag			char(01),
	@product_code		varchar(02),
	@spec_code		varchar(05)='',
	@spec_name		varchar(40)='',
	@spec_type		varchar(20)='',
	@value_type		varchar(05)='',
	@floor_code		char(01)='',
	@unit			varchar(05)=''
as
BEGIN
--exec MRP.dbo.SP_MRP_T1A_1 'S','DW',''
--exec MRP.dbo.SP_MRP_T1A_1 'M','D0000','호기','STA','VTC','N'

set nocount on

	exec SP_MRP_010_2 'MRP_T1A'

	if @flag = 'S'
		select	spec_code
			,spec_name
			,spec_type
			,value_type
			,floor_code
			,unit
		from	el_cd..t_ex_200 
		where product_code=@product_code
--ssh		and  spec_code >= @spec_code
			and spec_code like @spec_code + '%'
	else if @flag = 'M'
	begin
		if not exists ( select 'Y'
		 				from el_cd..t_ex_200 a
						where product_code=@product_code
						and spec_code = @spec_code )
		begin	
			insert into el_cd..t_ex_200 
			select	@product_code
				,upper(@spec_code)
				,@spec_name
				,@spec_type
				,@value_type
				,@floor_code
				,@unit
		end
		else
		begin
			update a set
				spec_code=upper(@spec_code),
				spec_name=@spec_name,
				spec_type=@spec_type,
				value_type=@value_type,
				floor_code=@floor_code,
				unit=@unit
			from	el_cd..t_ex_200 a
			where product_code=@product_code
			and  spec_code = @spec_code
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from	el_cd..t_ex_200  a
		where product_code=@product_code
		and  spec_code = @spec_code
	end
END


set nocount on;

/*****************************************************************************************************************/
/*  SP NAME      : SP_MRP_T1B_1                                                                                                                                              */
/*  DISCRIPTION  :  Spec Value Code Management  & Inquiry                                                                                                */ 
/*                                                                                                                                                                                                         */
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/01/29     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/



CREATE PROCEDURE [dbo].[SP_MRP_T1B_1]
	@flag			char(01),
	@product_code		varchar(02),
	@spec_code		varchar(05),
	@value_item_code	int=0,
	@value_item_name	varchar(30)='',
	@priority			int=0
as
BEGIN
--exec MRP.dbo.SP_MRP_T1B_1 'S','GL','L'
--exec MRP.dbo.SP_MRP_T1B_1 'M','D0000','호기','STA','VTC','N'

set nocount on

	exec SP_MRP_010_2 'MRP_T1B'

	if @flag = 'S'
	begin
		set rowcount 400
		select	spec_code,
			spec_name=(select b.spec_name from el_cd..T_EX_200 b 
					where b.product_code=a.product_code
					and b.spec_code=a.spec_code)
			,value_item_code
			,value_item_name
			,priority
		from	el_cd..t_ex_210 a
		where product_code=@product_code
		and  spec_code like rtrim(@spec_code)+'%'
		set rowcount 0
		
	end
	else if @flag = 'M'
	begin
		if not exists ( select 'Y'
						from	el_cd..t_ex_210 a
						where product_code=@product_code
						and 	spec_code = @spec_code
						and	value_item_code=@value_item_code )
		begin	
			insert into el_cd..t_ex_210 
			select	b.product_code
				,upper(b.spec_code)
				,@value_item_code
				,@value_item_name
				,value_type=b.value_type
				,@priority
			from el_cd..T_EX_200 b 
			where b.product_code=@product_code
			and b.spec_code=@spec_code
		end
		else
		begin
			update a set 
					value_item_name=@value_item_name,
					priority=@priority
			from el_cd..t_ex_210 a
			where product_code=@product_code
			and spec_code = @spec_code
			and	value_item_code=@value_item_code
		end
	end
	else if @flag = 'D'
	begin
		delete a 
		from	el_cd..t_ex_210  a
		where product_code=@product_code
		and 	spec_code = @spec_code
		and	value_item_code=@value_item_code
	end
END


set nocount on;

/**************************************************************************
*
*  PROCEDURE    : SP_MRP_T1E_1
**  DESCRIPTION  :  제번대장 조회 & 수정
*
*  CREATE_DAY   : 2010.01.15                                         	  
*
*		>> MODIFICATION LOG <<
**  DATE        REQUEST #       S.E NAME         DESCRIPTION
*  ---------------------------------------------------------------
* 2000/11/09          	         S.H.Song	    INITIAL DESIGN
* 2023-02-10   주소자리 60 -> 500으로 변경 반영
**************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_T1E_1]
	@flag			char(01),
	@prod_no 		varchar(14),
	@cost_model		varchar(10)='',
	@model_type		varchar(30)='',
	@equip_count	int='',
	@trade_no		varchar(10)='',
	@inst_address    varchar(500)='',
	@model			varchar(10)='',
	@use_type		varchar(10)='',
	@capa_person    varchar(10)='',
	@load_type		varchar(10)='',
	@open_type		varchar(10)='',
	@speed			varchar(10)='',
	@floor			varchar(10)='',
	@stop_count		varchar(10)='',
	@money_unit		varchar(10)='',
	@exchange_rate	float='',
	@brief_trade	varchar(30)='',
	@product_code   varchar(10)='',
	@inst_site_tel	varchar(15)='',
	@prod_prod_no_status    char(1)='',
	@inst_emp_id	varchar(10)='',
	@unit_no		varchar(20)='',
	@upd_emp_id		varchar(6)=''
	
AS

--exec SP_MRP_T1E_1 '7DRU4500'

set nocount on

BEGIN 

	declare	@project_no 	varchar(11),
		@mfg_no 	varchar(03)

	select 	@project_no=left(@prod_no,11)
	select 	@mfg_no=substring(@prod_no,12,3)

	exec SP_MRP_010_2 'MRP_T1E'

--sp_fields t_cc_010
	if @flag = 'S'
	begin
		select	prod_no=project_no+mfg_no
				,gaijung
				,product_code
				,market_flag
				,model_type
				,cost_model
				,equip_count
				,country_no
				,money_unit
				,exchange_rate
				,tech_post_person
				,inst_address
				,inst_site_tel
				,trade_no
				,brief_trade
				,sale_emp_id
				,inst_emp_id
				,recv_date=convert(varchar(08),recv_date,112)
				,cont_date=convert(varchar(08),cont_date,112)
				,entry_due_date=convert(varchar(08),entry_due_date,112)
				,main_due_date=convert(varchar(08),main_due_date,112)
				,bidding_no
				,go1_date=convert(varchar(08),go1_date,112)
				,go2_date=convert(varchar(08),go2_date,112)
				,fact_cont_amt
				,fact_add_cont_amt
				,inst_cont_amt
				,inst_add_cont_amt
				,fact_real_cost
				,inst_real_cost
				,fact_prod_amt
				,inst_prod_amt
				,fact_sale_amt
				,inst_sale_amt
				,fact_bidding_cost
				,inst_bidding_cost
				,fact_suju_cost
				,inst_suju_cost
				,suju_close_flag
				,suju_close_date
				,suju_flag
				,upd_emp_id
				,upd_date=convert(varchar(24),upd_date,121)
				,cont_amt_a_block
				,cont_amt_b_block
				,cont_amt_c_block
				,remark_f1
				,spec_flag
				,final_spec_date
				,cw_fact_cont_amt
				,ti_flag
				,hd_flag
				,model
				,use_type
				,capa_person
				,load_type
				,open_type
				,speed
				,floor
				,stop_count
				,confirm_flag
				,lgo_ico_flag
				,sale_ship_no
				,hanaro_complete
				,prod_complete
				,prod_prod_no_status
				,backup_flag_mrp
				,backup_date_mrp
				,recovery_date_mrp
				,unit_no
		FROM 	el_cd.dbo.t_cc_010 b	
		where 	project_no=@project_no
		and	mfg_no=@mfg_no

		select status='0',out_msg=' Inquiry  OK...'
	end


	if @flag = 'M'
	begin
		update a set
			cost_model	=	@cost_model,
			model_type	=	@model_type,
			equip_count	=	@equip_count,
			trade_no	=	@trade_no,
			inst_address	=	@inst_address,
			model	=	@model,
			use_type	=	@use_type,
			capa_person	=	@capa_person,
			load_type	=	@load_type,
			open_type	=	@open_type,
			speed	=	@speed,
			floor	=	@floor,
			stop_count	=	@stop_count,
			money_unit	=	@money_unit,
 			exchange_rate	=	@exchange_rate,
 			product_code	=	@product_code,
 			brief_trade	=	@brief_trade,
 			inst_site_tel	=	@inst_site_tel,
			prod_prod_no_status	=	@prod_prod_no_status,
			inst_emp_id	=	@inst_emp_id,
			unit_no		=	upper(@unit_no),
			upd_emp_id	=	@upd_emp_id,
			upd_date	=	getdate()
		from EL_CD..T_CC_010 a
		where project_no=@project_no
		and mfg_no=@mfg_no

		select status='0',out_msg=' Update  OK...'
	end
end;

CREATE PROCEDURE [dbo].[SP_MRP_T2D_1]
		@PROJECT_NO	VARCHAR(11),
		@MFG_NO 	VARCHAR(03),
		@PART1		VARCHAR(02),
		@PART2		VARCHAR(02),
		@PART3		VARCHAR(02),
		@PART4		VARCHAR(02),
		@PART5		VARCHAR(02),
		@MPFLAG		CHAR(01)
AS
set nocount on
BEGIN 

	exec SP_MRP_010_2 'MRP_T2D'

	exec EL_CD..S_EA_040_1_CC
		@PROJECT_NO	,
		@MFG_NO 	,
		@PART1		,
		@PART2		,
		@PART3		,
		@PART4		,
		@PART5		,
		@MPFLAG	


END;

/********************************************************************************/  
/*  SP NAME          : SP_MRP_T2F            */  
/*  DESCRIPTION      : 제조 Regen_Batch 작업         */  
/*  RELATIVE_FORM    : MRP_T2F             */  
/*  CREATE_DAY       : 2020년 01월 30일           */  
/*                    */  
/*  >> MODIFICATION LOG <<              */  
/*                    */  
/*  VER    DATE         CSR#                    SE NAME     DESCRIPTION   */  
/*  ----   ----------   --------------------    ---------   ---------------  */  
/*  1.0    2020-01-30 오티스 MES 프로젝트  LGJJG  Initial    */  
/********************************************************************************/  
  
CREATE PROCEDURE [dbo].[SP_MRP_T2F]  
 @MRP_id  varchar(20),  
 @page  datetime,  
 @status  char(01) output,  
 @out_msg varchar(50) output  
  
AS  
SET NOCOUNT ON  
-- grant exec on SP_MRP_T2F to applications  
/*   
declare @status  char(01),  
  @out_msg varchar(50)   
  
EXEC SP_MRP_T2F 'MRP_T2F','2020-01-02 15:07:48.403',@status output,@out_msg output  
  
select @status,@out_msg  
*/  
  
 declare @o_gaijung  varchar(04),  
  @curr_date  smalldatetime,  
  @curr_year  char(04),  
  @next_year  char(04),  
  @cnt int,  
  @due_date_to datetime  
  
 select @o_gaijung=mrp.dbo.fGetOption(@MRP_id,@page,'GAIJUNG')  
 select @cnt=mrp.dbo.fGetOption(@MRP_id,@page,'DueDate')  
  
 select @due_date_to=convert(varchar(10), master.dbo.fGetWorkDate(getdate(), @cnt), 121) + ' 23:59:59'  
-- select @due_date_to=convert(varchar(10), dateadd(d,@cnt,getdate()),121) + ' 23:59:59'  -- working day 걸기  
  
 select @curr_date = convert(char(08),getdate(),112)  
 select @curr_year = left(convert(char(08),getdate(),112),4)  
 select @next_year = left(convert(char(08),dateadd(year,1,getdate()),112),4)  
  
 declare @curr_fact_gubun char(03),  
   @next_fact_gubun char(03)  
  
 select @curr_fact_gubun=left(master.dbo.fGetCodeDesc('Z28', @o_gaijung+@curr_year),3)  
 select @next_fact_gubun=left(master.dbo.fGetCodeDesc('Z28', @o_gaijung+@next_year),3)  
  
 select project_no,mfg_no,part,part_seq,item_no,  
  cont_qty,  
  due_date=(case when @curr_date > due_date then @curr_date else due_date end),  
  order_select,  
  ship_flag = (case when treat_method = 'D' and cause_code = '@@' or ship_flag <> 'Y' then 'N' else 'Y' end),  
  week='      ',  
  a.market_flag,  
  fact_gubun=convert(varchar(3),'')  
 into #GISFT2F  
 from el_cd..T_CA_011 a --with (index=PK_T_CA_011_1__14 nolock)  
 where a.project_no like '20__D__M%'  
 and a.mfg_no like 'D%'  
 and a.order_select = 'M'  
 and a.date_ao is null  
 and a.gaijung=@o_gaijung  
 and due_date between '20200101' and @due_date_to  
    and cont_qty > +0  
    and out_factory_flag not in ('K','D','A')  
 and confirm_flag in ('Y','A')  
    and not (treat_method = 'D' and cause_code <> '@@')  
  
 if not exists (select 'Y' from #GISFT2F )  
 begin  
   select @status='1',@out_msg='제조지시 생성 대상 없음'  
   return  
 end  
  
 update a set  
  week=master.dbo.fGetWorkWeek_CX030(a.due_date)  
 from #GISFT2F a  
  
 update a set  
  fact_gubun=(case when left(week,4) > @curr_year then @next_fact_gubun else @curr_fact_gubun end)  
 from #GISFT2F a  
  
begin tran SP_GISFT2F  
  
 select a.project_no, a.mfg_no, a.part, a.part_seq,  
   a.item_no,  
   a.order_select,  
   a.due_date,  
   a.ship_flag,  
   qty=a.cont_qty,  
   a.market_flag,  
   a.fact_gubun,  
   a.week,  
   order_no=convert(varchar(08),'')  
 into #YO_1  
 from #GISFT2F a, EL_CD..T_CX_060 c  
 where c.item_no = a.item_no  
 and c.item_select <> 'D'   --** Dummy item 제외 ***  
  
 declare @code  varchar(10),    
   @code_output varchar(20),    
   @qty  real,  
   @item_no varchar(15),  
   @week  varchar(06),  
   @rout_type varchar(05),  
   @wc_code varchar(06),  
   @due_date smalldatetime,  
   @project_no varchar(11),  
   @mfg_no varchar(03),  
   @part  varchar(02),  
   @part_seq varchar(04),  
   @ship_flag char(01),  
   @fact_gubun char(03),  
   @market_flag char(01)  
  
  
 truncate table T_MYO_01_Regen  
  
 DECLARE TTT SCROLL CURSOR FOR  
  select  a.item_no,due_date,week,fact_gubun,  
    project_no,mfg_no,part,part_seq,ship_flag,  
    qty,a.market_flag  
  from #YO_1 a  
  
 OPEN TTT  
  
   FETCH NEXT FROM TTT INTO @item_no,@due_date,@week,@fact_gubun,  
   @project_no,@mfg_no,@part,@part_seq,@ship_flag,@qty,@market_flag  
  
 WHILE (@@FETCH_STATUS = 0) begin  
  
  select @code=@fact_gubun+right(@week,2)  
  
  exec sp_numbering_output 'A06',@code,@code_output output  
  -- exec sp_numbering_output_ORDER 'A06',@code,@code_output output       --ORDER_NO에 대한 1000이상일때 처리 FLOW 
  
  insert into T_MYO_01_Regen  
  select  order_no=@code_output  
   ,item_no=@item_no  
   ,due_date=@due_date  
   ,date_start=@due_date  
   ,qty_ao=@qty  
   ,rout_type=x.rout_type  
   ,wc_code=x.wc_code  
   ,next_store=(case when @ship_flag='Y' then 'PW' else 'MM' end)+@o_gaijung  
   ,project_no=@project_no  
   ,mfg_no=@mfg_no  
   ,part=@part  
   ,part_seq=@part_seq  
   ,ship_flag=@ship_flag  
   ,market_flag=@market_flag  
  from EL_CD..T_CX_060 x  
  where item_no=@item_no  
  
    FETCH NEXT FROM TTT INTO @item_no,@due_date,@week,@fact_gubun,  
    @project_no,@mfg_no,@part,@part_seq,@ship_flag,@qty,@market_flag  
   
 end  
 CLOSE TTT  
    DEALLOCATE TTT  
  
 update a set order_no=b.order_no  
 from #YO_1 a,T_MYO_01_Regen b with (index=IX_T_MYO_01_Regen_1 nolock)  
 where b.project_no=a.project_no  
 and b.mfg_no=a.mfg_no  
 and b.part=a.part  
 and b.part_seq=a.part_seq  
  
--** 수불대장에 제조지시일자 Setting **   
 update b set date_ao=@curr_date,  
     ao_no = a.order_no,  
     concern_order_no=a.order_no,  
     confirm_flag='A',  
     run_date=getdate(),  
     upd_date=getdate()  
 from T_MYO_01_Regen a,EL_CD..T_CA_011 b  
 where a.ship_flag = 'Y'  
 and b.project_no=a.project_no  
 and b.mfg_no=a.mfg_no  
 and b.part=a.part  
 and b.part_seq=a.part_seq  
  
--** 제조발주 생성 **  
 insert into T_MYO_01 (order_no, item_no, gaijung,   run_status, due_date, date_regen, date_start, date_start_act, date_store, date_out,  
        date_chg, date_ao, qty_ao,    qty_input,  qty_finish, qty_rej, qty_rework, qty_cancel,     rout_type,  plan_status,  
        ao_need, wc_code, rwk_ao_no, next_store, project_no, mfg_no,  part,  part_seq,  ship_flag, market_flag,   
        last_ot_no, box_no, divide_seq, concern_order_no, place, update_user, create_pgm, date_gecb_update, date_inspect, to_project_confirm, to_project_confirm_id  )  
 select  order_no=a.order_no  
  ,item_no=a.item_no  
  ,gaijung=@o_gaijung  
  ,run_status='0'  
  ,due_date=a.due_date  
  ,date_regen=getdate()  
  ,date_start=a.due_date  
  ,date_start_act=null  
  ,date_store=null  
  ,date_out=null  
  ,date_chg=getdate()  
  ,date_ao=getdate()  
  ,qty_ao=a.qty_ao  
  ,qty_input=0  
  ,qty_finish=0  
  ,qty_rej=0  
  ,qty_rework=0  
  ,qty_cancel=0  
  ,rout_type=a.rout_type  
  ,plan_status=''  
  ,ao_need=''  
  ,wc_code=a.wc_code  
  ,rwk_order_no=''  
  ,next_store=(case when @ship_flag='Y' then 'PW' else 'MM' end)+@o_gaijung  
  ,project_no=a.project_no  
  ,mfg_no=a.mfg_no  
  ,part=a.part  
  ,part_seq=a.part_seq  
  ,ship_flag=a.ship_flag  
  ,market_flag=a.market_flag  
  ,last_ot_no=0  
  ,box_no= SUBSTRING(a.part_seq,1,1) + substring(a.part, 2,1)    
  ,divide_seq= ASCII(SUBSTRING(a.part_seq,3,1)) - 64    
  ,concern_order_no=''  
  ,place = 'S'  
  ,'MRP_T2F' -- @user_id  
  ,'Batch'  
  , NULL  
  , NULL  
  ,''  
  ,''  
 from T_MYO_01_Regen a  
   
 IF @@ERROR = 0  
 BEGIN  
  COMMIT TRAN SP_GISFT2F  
  select @status='0',@out_msg='Good...'  
 END  
 ELSE  
 BEGIN   
  ROLLBACK TRAN SP_GISFT2F  
  select @status='2',@out_msg='Error ???'  
 END  
  
 exec xp_Common_Batch_Job_Error_Insert @page,@MRP_id,'1',@status,@out_msg  
  
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_T7M                                                                                                                                                    */
/*  DISCRIPTION  : 대일정 변경에 따른 납기변경  수불대장,주문                                                                                                                               */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/06/17     MRP Downsizing Project   J.M. Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_T7M]
	@MRP_id	varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output

AS
SET NOCOUNT ON

/*

declare	@status		char(01)	,
	@out_msg	varchar(50) 
EXEC SP_MRP_T7M 'MRP_T7M','2010-09-18 11:39:27.467',@status output,@out_msg output
select @status,@out_msg

select *
from el_cd..t_cc_030
where project_no='2009f  0431'
and mfg_no='e01'
and point='4'
and part='01'

	declare	@upd_date_from		smalldatetime,
			@upd_date_to		smalldatetime

	select @upd_date_from=dateadd(day,-13,getdate()),@upd_date_to=getdate()
	select @upd_date_from,@upd_date_to	
	select @upd_date_from=convert(varchar(08),dateadd(day,-1,getdate()),112),@upd_date_to=convert(varchar(08),getdate(),112)

	select @upd_date_from,@upd_date_to
*/

	declare	@upd_date_from		smalldatetime,
			@upd_date_to		smalldatetime

	-- 납기가 시간개념으로 되어 일자로 변경함(lgssha:20140714)
	--select @upd_date_from=dateadd(day,-1,getdate()),@upd_date_to=getdate()
	select @upd_date_from=convert(varchar(08),dateadd(day,-3,getdate()),112),@upd_date_to=convert(varchar(08),getdate(),112)
	
--제통 납기 변경
	
	--exec SP_MRP_010_2 'MRP_T7M'

begin tran MRP_T7M

	update k set
		upd_date=getdate(),
		due_date= (case when datediff(day,x.plan_date,getdate()) > 0 --pladate가 현재보다 작으면
				then convert(varchar(8),getdate(),112) else x.plan_date end)
    	from	(select project_no,mfg_no,part,plan_date
			from EL_CD..T_CC_030 x with (index=IX_T_CC_030_1 nolock)
			where	x.point='4'
			and	x.confirm_date BETWEEN @upd_date_from AND @upd_date_to
			and	x.confirm_flag='Y' 
			and exists (select * 
				from EL_CD..T_CC_010 y  with (index=PK_T_CC_010_1__15 nolock)
				where 	y.project_no=x.project_no 
				and	y.mfg_no=x.mfg_no))x,
		EL_CD..T_CA_011 k with (index=PK_T_CA_011_1__14 nolock) 
	where	x.project_no > '0'
	and	k.project_no=x.project_no 
	and	k.mfg_no=x.mfg_no 
	and	k.part=x.part
	and k.due_date <> x.plan_date
	and	k.last_out_date is null
 	and	k.last_in_date is null
 	and	k.rslt_date is null
 	and	k.cont_qty > 0

--주문 납기 변경
	select	b.order_no,
			date_due=b.date_due,
			from_date = (select c.chg_bfr_plan_date
					from  el_cd..t_cc_031 c with (nolock)
					where c.project_no = a.project_no
					and c.mfg_no = a.mfg_no
					and c.hogi = a.hogi
					and c.block = a.block
					and c.part = a.part
					and c.point = '4'
					and c.chng_date = a.min_chng_date),
			to_date = (select c.chg_afr_plan_date
					from  el_cd..t_cc_031 c with (nolock)
					where c.project_no = a.project_no
					and c.mfg_no = a.mfg_no
					and c.hogi = a.hogi
					and c.block = a.block
					and c.part = a.part
					and c.point = '4'
					and c.chng_date = a.max_chng_date),
			date_diff = 0
	into #temp
	from (	select distinct a.project_no, a.mfg_no, a.hogi, a.block, a.part, 
				min_chng_date = min(a.chng_date), 
				max_chng_date = max(a.chng_date)
			from el_cd..t_cc_031 a with (index=IX_T_CC_031_1 nolock), el_cd..t_cc_030 b
			where a.point = '4'
			and a.chng_date BETWEEN  convert(varchar(10),dateadd(day,-1,getdate()),120) + ' 20:00:01' and convert(varchar(10),getdate(),120) + ' 20:00:00' 
			and b.project_no = a.project_no
			and b.mfg_no = a.mfg_no
			and b.hogi = a.hogi
			and b.block = a.block
			and b.point = a.point 
			--and b.confirm_flag = 'Y' --주석처리함 2011-11-26 성진수C 확인
			group by a.project_no, a.mfg_no, a.hogi, a.block, a.part ) a, 
		
		EL_CD..T_VA_020 b with (index=IX_T_VA_020_D nolock)
	where a.project_no >'0'
	and b.prod_no=a.project_no + a.mfg_no 
	and b.part = a.part
	and b.run_status <> '5'
	and b.qty_deliv = 0
	and (b.receipt_expect_no is null or b.receipt_expect_no < '0')
	and (b.box_receipt_expect_no is null or b.box_receipt_expect_no < '0')
	and b.gaijung <> 'SYHP'
	and not exists (select 'Y' 
					from  el_cd..t_ca_011_emergency_due_date c
					where c.project_no = substring(b.prod_no,1,11)
					and c.mfg_no = substring(b.prod_no,12,3)
					and c.part = b.part
					and c.upd_date >= convert(varchar(8),getdate(),112))


	delete a
	from #temp a
	where datediff(day,a.from_date,a.to_date) = 0

	
	update a set 
		date_diff = datediff(day,from_date,to_date)
	from #temp a


	--대일정 변경일수 만큼 주문납기를 당기거나 연기시킴, 단 오늘(포함)보다 이전이면 내일로 바꿈
	update a set
		date_due = convert(varchar(8),(case when convert(varchar(8),dateadd(day, date_diff, date_due),112) <= convert(varchar(8),getdate(),112)
					then dateadd(day, 1, getdate())
					else  dateadd(day, date_diff, date_due) end),112)
	from #temp a

	
	--work_calendar를 참고하여 휴일(주말)이면 바로앞의 근무일로.
	update a set
		date_due = convert(varchar(08),(case when b.work_date is null 
							then a.date_due
							else (select max(c.work_date) 
								from el_cd..t_cx_030 c
								where c.work_date <= b.work_date 
								and c.holiday = 'N' ) end )	,112)
	from #temp a left outer join el_cd..t_cx_030 b
		on a.date_due = b.work_date

	insert into EL_CD..T_VA_030
	select	a.order_no
		,date_act=getdate()
		,date_due=b.date_due
		,date_start=b.date_start
		,date_chg=a.date_due
		,chg_type=(case when a.date_diff > 0 then 'D' else 'E' end)
		,qty_chg=b.qty_order-b.qty_cancel
		,open_order=b.qty_order-b.qty_cancel
		,post_person=b.post_person
		,base_no=convert(char(12),'SAHAN_'  + substring(convert(varchar(08), getdate(), 112), 3, 6))
		,price=b.price
		,price_r=b.price_r
		,TRADE_NO=b.trade_no
		,gaijung=b.gaijung
		,approve_flag=null
		,approve_date=null
		,receipt_flag=null
		,receipt_date=null
		,reject_flag=null
		,reject_date=null
		,new_order_no=''
	from #temp a,EL_CD..T_VA_020 b
	where b.order_no = a.order_no

	if  @@error <> 0
	begin
		rollback tran MRP_T7M
		select @status='1',@out_msg='주문변경 Insert Error  ???'
		return
	end

	update b set
		date_due=a.date_due,
		date_last=getdate()
	from #temp a,EL_CD..T_VA_020 b
	where b.order_no = a.order_no

	
	select @status='0',@out_msg='Good...'

	commit tran MRP_T7M

	

SET NOCOUNT OFF;

/********************************************************************************/
/*  SP NAME          : SP_MRP_TTF												*/
/*  DESCRIPTION      : 제조상세 Regen_Batch 작업								*/
/*  RELATIVE_FORM    : MRP_TTF													*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_TTF]
	@MRP_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON
-- grant exec on SP_MRP_TTF to applications
/*
declare	@status		char(01),
		@out_msg	varchar(50) 

EXEC SP_MRP_TTF 'MRP_TTF','2020-01-03 16:24:17.947',@status output,@out_msg output

select @status,@out_msg
*/

/*** 제조 작업상세 전개  *****/


	select @status='0',@out_msg='return...'
	return


	declare	@o_gaijung		varchar(04),
			@ao_no			varchar(08)

	select	@o_gaijung=mrp.dbo.fGetOption(@MRP_id,@page,'GAIJUNG')

	update a set rout_type=b.rout_type
	from T_MYO_01 a with (index=IX_T_MYO_01_1) ,EL_CD..T_CX_060 b
	where a.gaijung = @o_gaijung
	and a.run_status = '0'
	and (a.rout_type is NULL or a.rout_type < '0')
	and b.item_no=a.item_no
	and b.rout_type > '0'


	select ao_no=order_no
	into #GISFTTF
	from T_MYO_01 a with (index=IX_T_MYO_01_1 nolock)
	where a.gaijung = @o_gaijung
	and a.run_status = '0'
	and a.rout_type > '0'
	and exists ( select 'Y' from el_cd..t_cx_630 b where b.rout_type = a.rout_type )
	
	DECLARE TTT SCROLL CURSOR FOR
		select ao_no
		from #GISFTTF a 

	OPEN TTT

  	FETCH NEXT FROM TTT INTO @ao_no

	WHILE (@@FETCH_STATUS = 0)	
	begin
		exec SP_Common_Rounting_EXPL	@ao_no,	@status output,@out_msg	output

		exec xp_Common_Batch_Job_Error_Insert @page,@MRP_id,'1',@status,@out_msg

	  	FETCH NEXT FROM TTT INTO @ao_no

	end
	CLOSE TTT
   	DEALLOCATE TTT

	select @status='0',@out_msg='Good...'


SET NOCOUNT OFF;

/********************************************************************************/
/*  SP NAME          : SP_MRP_TTG												*/
/*  DESCRIPTION      : 불출대기 생성_Batch 작업									*/
/*  RELATIVE_FORM    : MRP_TTG													*/
/*  CREATE_DAY       : 2020년 01월 30일											*/
/*																				*/
/*  >> MODIFICATION LOG <<														*/
/*																				*/
/*  VER    DATE         CSR#                    SE NAME	    DESCRIPTION			*/
/*  ----   ----------   --------------------    ---------   ---------------		*/
/*  1.0    2020-01-30	오티스 MES 프로젝트		LGJJG		Initial				*/
/********************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_TTG]
	@MRP_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
AS
SET NOCOUNT ON

-- grant exec on SP_MRP_TTG to applications
/*	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_MRP_TTG 'MRP_TTG','2020-02-04 15:00:57.330',@status output,@out_msg output

select @status,@out_msg
*/

/*** 불출대기 생성 ***/

/*
declare 	@MRP_id		varchar(20),
			@page		datetime
			select @MRP_id = 'MRP_TTG'
			select @page='2020-02-04 15:00:57.330'
*/

	declare	@o_gaijung	varchar(04),
			@o_emergency_flag	char(01),
			@curr_date	smalldatetime,
			@order_no	varchar(08),
			@next_year	char(04),
			@cnt int,
			@date_start_to	datetime

	select	@o_gaijung=mrp.dbo.fGetOption(@MRP_id,@page,'GAIJUNG')
	select	@cnt=mrp.dbo.fGetOption(@MRP_id,@page,'DateStart')

	select @date_start_to=convert(varchar(10), master.dbo.fGetWorkDate(getdate(), @cnt), 121) + ' 23:59:59'

	select	a.item_no, a.order_no
	into #GISFTTG
	from t_MYO_01 a with (index=IX_T_MYO_01_2 nolock), el_cd..t_ca_011 b with (nolock)  
	where a.gaijung=@o_gaijung
	and a.last_ot_no = 0
	and a.date_start <= @date_start_to
--	and a.run_status = '1'
	and a.run_status in ('0','1')
	and a.qty_ao > 0  
	and b.project_no = a.project_no  
	and b.mfg_no = a.mfg_no  
	and b.part = a.part  
	and b.part_seq = a.part_seq  
	and b.cont_qty > 0 

/*
	select	item_no,order_no
	into #GISFTTG
	from t_MYO_01 a with (index=IX_T_MYO_01_2 nolock)
	where gaijung=@o_gaijung
	and last_ot_no = 0
	and date_start <= @date_start_to
	and run_status = '1'
	--and order_no between 'IX' and 'IXZZZZZ'
*/

	DECLARE TTT SCROLL CURSOR FOR
		select order_no
		from #GISFTTG

	OPEN TTT

  	FETCH NEXT FROM TTT INTO @order_no

	WHILE (@@FETCH_STATUS = 0)	begin

		select @status='0',@out_msg='OK..'

		exec SP_Common_Issue_ready_Creation_AO
			@order_no, 
			'MRP_TTG',
			@status		output,
			@out_msg	output

		exec xp_Common_Batch_Job_Error_Insert @page,@MRP_id,'1',@status,@out_msg

	  	FETCH NEXT FROM TTT INTO @order_no

	end
	CLOSE TTT
   	DEALLOCATE TTT

SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[SP_MRP_TTK]
	@MRP_id		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(50) output
	
AS
SET NOCOUNT ON

	--@@@    sp_common_routSeq_comp 이용  @@@@

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_TV3                                                                                                                                                    */
/*  DISCRIPTION  : 창고이동처리(Batch)                                                                                                                                 */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/01     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_TV3]
	@job_id		varchar(30),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output

AS
SET NOCOUNT ON

/*

declare	@status		char(01),
	@out_msg	varchar(100) 

exec SP_MRP_TV3 'MRP_TV3','2010-02-01 11:06:14.687',
	@status		output,
	@out_msg	output
select @status,@out_msg

*/
--** 창고이동처리 (일괄)  **

	exec SP_MRP_010_2 'MRP_TV3'


	declare	@o_gaijung		varchar(04),
			@o_start_date	char(08),
			@o_end_date		char(08),
			@o_io_date		char(08)

	declare	@project_no	varchar(11),
			@mfg_no		varchar(03),
			@part		varchar(02),
			@part_seq	varchar(04),
			@proc_qty	float

	select	@o_gaijung=mrp.dbo.fGetOption(@job_id,@page,'Gaijung')
	select	@o_start_date=mrp.dbo.fGetOption(@job_id,@page,'FromDueDate')
	select	@o_end_date=mrp.dbo.fGetOption(@job_id,@page,'ToDueDate')
	select	@o_io_date=mrp.dbo.fGetOption(@job_id,@page,'IssueDate')


	declare	@user_id	varchar(10)

	select @user_id=mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page)
	
	DECLARE TTT SCROLL CURSOR FOR

		select	project_no,mfg_no,part,part_seq,proc_qty=cont_qty-prod_qty
		from EL_CD..T_CA_011 a with (index=ix_ca_011_2 nolock)
		where a.product_code in ('GL','GE','EL','DW','PS','PT')  
		and a.due_date between @o_start_date and @o_end_date
		and a.prod_qty < cont_qty
		and a.cause_code <> 'ZZ'
		and a.order_select not in ('A','M')
		and a.gaijung = @o_gaijung
		and a.part <> 'RA'
		and a.ship_flag = 'Y'
		and out_factory_flag not in ('Y','D','A')
		and date_ao is not null
		and confirm_flag in ('Y','A')
		and treat_method <> 'D' 
		and len(rtrim(concern_order_no)) <> 8



	OPEN TTT

  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@proc_qty

	WHILE (@@FETCH_STATUS = 0)	begin

		exec SP_Common_Issuance_By_PartSeq
			@o_gaijung,
			@project_no,
			@mfg_no,
			@part,
			@part_seq,
			@o_io_date,
			@proc_qty,
			@user_id,
			@status		output,
			@out_msg	output

		exec xp_Common_Batch_Job_Error_Insert @page,@job_id,'1',@status,@out_msg

	  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no,@part,@part_seq,@proc_qty

	end
	CLOSE TTT
   	DEALLOCATE TTT

	select @status='',@out_msg='Good...'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_TVN_1                                                                                                                                                    */
/*  DISCRIPTION  : 제번별 창고이동처리용 조회                                                                                                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/02     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_TVN_1]
	@gaijung	varchar(04),
	@project_no	varchar(11),
	@mfg_no		varchar(03),
	@part		varchar(02)
AS
SET NOCOUNT ON

--sp_fields T_CA_011

	exec SP_MRP_010_2 'MRP_TVN'

	if  left(@gaijung,2)='SY'
	begin
		select	prod_no=a.project_no+a.mfg_no
			,hogi
			,part
			,part_seq
			,a.item_no
			,eng_desc=master.dbo.fGetItemDesc(a.item_no)
			,due_date=convert(char(08),due_date,112)
			,a.product_code
			,market_flag
			,order_select=(case when a.order_select = 'M' and a.out_factory_flag = 'S' and a.ship_flag = 'N'
					then 'D'
					else a.order_select
					end)
			,a.item_group_sub
			,a.block
			,a.mp_flag
			,concern_order_no
			,concern_order_date
			,cont_qty
			,cont_cost
			,cont_amt
			,last_in_date
			,last_out_date
			,ao_time
			,run_status
			,run_date
			,a.upd_date
			,draw_cfm_date
			,sale_qty
			,trade_no
			,plan_due_date
			,cfrm_date
			,deliv_date
			,out_date
			,a.matl_post_person
			,a.po_post_person
			,a.wh_post_person
			,a.ship_post_person
			,rslt_date
			,confirm_flag
			,a.ship_flag
			,a.vbox_code
			,a.box_no
			,out_factory_flag
			,treat_method
			,packing_confirm_date
			,prod_qty
			,proc_qty=cont_qty-prod_qty
			,date_ao
			,date_po
			,date_kit
			,cause_code
			,prod_amt
			,sale_amt
			,management_flag
			,giho_draw_flag
			,select_draw_flag
			,amt_divide_flag
			,add_vbox_code
			,part_pdm
			,a.gaijung
		from EL_CD..T_CA_011 a 
		where a.project_no =  @project_no
		and a.mfg_no=@mfg_no
		and (a.part = @part or @part < '0')
	 	and left(a.gaijung,2)=left(@gaijung,2)
	 	and a.prod_qty < cont_qty
	 	and a.cause_code <> 'ZZ'
	 	and (a.ship_flag = 'Y' and a.out_factory_flag < '0' or
			a.order_select = 'M' and a.out_factory_flag = 'S' and a.ship_flag = 'N')
	 	and date_ao is not null
	 	and confirm_flag in ('Y','A')
	 	and treat_method <> 'D' 
	end
	else
	begin
		select	prod_no=a.project_no+a.mfg_no
			,hogi
			,part
			,part_seq
			,a.item_no
			,eng_desc=master.dbo.fGetItemDesc(a.item_no)
			,due_date=convert(char(08),due_date,112)
			,a.product_code
			,market_flag
			,a.order_select
			,a.item_group_sub
			,a.block
			,a.mp_flag
			,concern_order_no
			,concern_order_date
			,cont_qty
			,cont_cost
			,cont_amt
			,last_in_date
			,last_out_date
			,ao_time
			,run_status
			,run_date
			,a.upd_date
			,draw_cfm_date
			,sale_qty
			,trade_no
			,plan_due_date
			,cfrm_date
			,deliv_date
			,out_date
			,a.matl_post_person
			,a.po_post_person
			,a.wh_post_person
			,a.ship_post_person
			,rslt_date
			,confirm_flag
			,a.ship_flag
			,a.vbox_code
			,a.box_no
			,out_factory_flag
			,treat_method
			,packing_confirm_date
			,prod_qty
			,proc_qty=cont_qty-prod_qty
			,date_ao
			,date_po
			,date_kit
			,cause_code
			,prod_amt
			,sale_amt
			,management_flag
			,giho_draw_flag
			,select_draw_flag
			,amt_divide_flag
			,add_vbox_code
			,part_pdm
			,a.gaijung
		from EL_CD..T_CA_011 a 
		where a.project_no =  @project_no
		and a.mfg_no=@mfg_no
		and (a.part = @part or @part < '0')
	 	and left(a.gaijung,2)=left(@gaijung,2)
	 	and a.prod_qty < cont_qty
	 	and a.cause_code <> 'ZZ'
	 	and a.order_select not in ('A','M')
	 	and a.part <> 'RA'
	 	and a.ship_flag = 'Y'
	 	and out_factory_flag not in ('Y','D','A')
	 	and date_ao is not null
	 	and confirm_flag in ('Y','A')
	 	and treat_method <> 'D' 
	 	and len(rtrim(isnull(concern_order_no,''))) <> 8	 	
--	 	and len(rtrim(concern_order_no)) <> 8
	end

--exec mrp.dbo.sp_mrp_TVN_1 'SYHP','2010GB 0592','X01','MD'

	select status='0',out_msg=' Inquiry OK ...'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_TVN_2                                                                                                                                                    */
/*  DISCRIPTION  : 수불항번별 창고이동처리                                                                                                                     */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/02     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_MRP_TVN_2]
	@gaijung		varchar(04),
	@project_no		varchar(11),
	@mfg_no		varchar(03),
	@part			varchar(02),
	@part_seq		varchar(04),
	@date_io		varchar(08),
	@qty			float,
	@user_id		varchar(10)
AS
SET NOCOUNT ON

	declare	@status		char(01),
		@out_msg	varchar(100)

	exec SP_MRP_010_2 'MRP_TVN'

	if @date_io < '0'
		select @date_io = convert(char(08),getdate(),112)

	if isdate(@date_io)=0
	begin
		select 	status='1',out_msg=' Please Check 출고일자 ???'
		return
	end

	exec	SP_Common_Issuance_By_PartSeq 
		@gaijung,
		@project_no,
		@mfg_no,
		@part,
		@part_seq,
		@date_io,
		@qty,
		@user_id,
		@status		output,
		@out_msg	output

	select status=@status,out_msg=@out_msg,prod_qty,proc_qty=cont_qty-prod_qty
	from EL_CD..T_CA_011 a
	where project_no=@project_no
	and mfg_no=@mfg_no
	and part=@part
	and part_seq=@part_seq
	


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_TWA_1                                                                                                                                                    */
/*  DISCRIPTION  : 매출처리용 조회                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/09     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_TWA_1]
	@gaijung		varchar(04),
	@product_code	char(02),
	@market_flag	char(01),
	@date_from		char(08),
	@date_to		char(08)
AS
SET NOCOUNT ON

/*

exec mrp.dbo.sp_mrp_TWA_1 'ELES','DW','C','',''
exec mrp.dbo.sp_mrp_TWA_1 'ELES','EL','E','20091101','20091201'
exec MRP.dbo.SP_MRP_TWA_1 'P','ELES','2X10020400001','2','-136',''
*/

	exec SP_MRP_010_2 'MRP_TWA'

	if @date_from < '0'
		select @date_from=convert(char(08),dateadd(d,-10,getdate()),112)

	if @date_to < '0'
		select @date_to=convert(char(08),getdate(),112)

	if isdate(@date_from)=0
	begin
		select status='1',out_msg=' 시작일자를 재입력하세요 ???'
		return
	end

	if isdate(@date_to)=0
	begin
		select status='1',out_msg=' 종료일자를 재입력하세요 ???'
		return
	end

	select status='0',out_msg=' Inquiry OK ...'


	exec EL_CD..S_EC_300_1
		@market_flag,
		@product_code,
		@date_from,
		@date_to;

/*******************************************************************************************************************/
/*  SP NAME      : SP_MRP_TWA_2                                                                                                                                                    */
/*  DISCRIPTION  : 매출처리                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/02/09     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_MRP_TWA_2]
	@gaijung		varchar(04),
	@ship_no		varchar(12),
	@date_action		char(08)
AS
SET NOCOUNT ON

/*

exec MRP.dbo.SP_MRP_TWA_2 'ELES','ELE091130004',''

*/
	declare	@status		char(01),
		@out_msg	varchar(100)

	exec SP_MRP_010_2 'MRP_TWA'


	if @date_action < '0'
		select @date_action=convert(char(08),getdate(),112)

	if isdate(@date_action)=0
	begin
		select status='1',out_msg=' 출하일자를 재입력하세요 ???'
		return
	end

	exec mrp..SP_Common_Shipping_by_ShipNo	
		@gaijung,@ship_no,@date_action,@status output,@out_msg output

	select	status=@status,out_msg=@out_msg;

CREATE PROCEDURE dbo.sp_renamediagram
	(
		@diagramname 		sysname,
		@owner_id		int	= null,
		@new_diagramname	sysname
	
	)
	WITH EXECUTE AS 'dbo'
	AS
	BEGIN
		set nocount on
		declare @theId 			int
		declare @IsDbo 			int
		
		declare @UIDFound 		int
		declare @DiagId			int
		declare @DiagIdTarg		int
		declare @u_name			sysname
		if((@diagramname is null) or (@new_diagramname is null))
		begin
			RAISERROR ('Invalid value', 16, 1);
			return -1
		end
	
		EXECUTE AS CALLER;
		select @theId = DATABASE_PRINCIPAL_ID();
		select @IsDbo = IS_MEMBER(N'db_owner'); 
		if(@owner_id is null)
			select @owner_id = @theId;
		REVERT;
	
		select @u_name = USER_NAME(@owner_id)
	
		select @DiagId = diagram_id, @UIDFound = principal_id from dbo.sysdiagrams where principal_id = @owner_id and name = @diagramname 
		if(@DiagId IS NULL or (@IsDbo = 0 and @UIDFound <> @theId))
		begin
			RAISERROR ('Diagram does not exist or you do not have permission.', 16, 1)
			return -3
		end
	
		-- if((@u_name is not null) and (@new_diagramname = @diagramname))	-- nothing will change
		--	return 0;
	
		if(@u_name is null)
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @theId and name = @new_diagramname
		else
			select @DiagIdTarg = diagram_id from dbo.sysdiagrams where principal_id = @owner_id and name = @new_diagramname
	
		if((@DiagIdTarg is not null) and  @DiagId <> @DiagIdTarg)
		begin
			RAISERROR ('The name is already used.', 16, 1);
			return -2
		end		
	
		if(@u_name is null)
			update dbo.sysdiagrams set [name] = @new_diagramname, principal_id = @theId where diagram_id = @DiagId
		else
			update dbo.sysdiagrams set [name] = @new_diagramname where diagram_id = @DiagId
		return 0
	END;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_100_1                                                                                                                                                     */
/*  DISCRIPTION  : Create Order data for Import System                                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/
--grant exec on SP_SCH_100_1 to applications

CREATE PROCEDURE [dbo].[SP_SCH_100_1] 
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_100_1  'SCH_100','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/

	declare	@from_date	smalldatetime,
			@to_date	smalldatetime,
			@work_date	smalldatetime

	select 	@from_date = convert(smalldatetime,convert(varchar(08),dateadd(day,-10,getdate()),112)),
			@to_date = convert(smalldatetime,convert(varchar(08),dateadd(day,20,getdate()),112)), 
			@work_date = convert(smalldatetime,convert(varchar(08),getdate(),112))
	create table #item(item_no varchar(15))
	
	if not exists(select * from EL_BD..T_IM_001_HANARO where work_gubun = 'IMPORTUP' and  work_date = @work_date)
	begin
		insert into EL_BD..T_IM_001_HANARO
		select 'IMPORTUP',@work_date,'1',getdate(),getdate()
	end
	else 
	begin
		update a set
		 	lastupdate_date = getdate(),
			work_status = '1'
		from EL_BD..T_IM_001_HANARO a
		where work_gubun = 'IMPORTUP' and  work_date = @work_date
	end
	
	delete j
	from EL_BD..T_VA_020_HANARO j  
			left join EL_CD..T_VA_020 i  
				on	i.order_no = j.order_no
	where i.order_no is null 

	update i set
	 	i.item_no = i.item_no,
		i.gaijung = i.gaijung,
		i.supply = j.supply,
		i.run_status = j.run_status,
		i.date_due = j.date_due,
		i.keep_flag = j.keep_flag,
		i.item_unit = j.item_unit,
		i.money_unit = j.money_unit,
		i.price = j.price,
		i.price_r = j.price_r,
		i.qty_order = j.qty_order,
		i.qty_deliv = j.qty_deliv,
		i.qty_insp = j.qty_insp,
		i.qty_acpt = j.qty_acpt,
		i.qty_input = j.qty_input,
		i.qty_cancel = j.qty_cancel,
		i.date_start = j.date_start,
		i.date_deliv = j.date_deliv,
		i.date_chg = j.date_chg,
		i.po_status = j.po_status,
		i.date_delay = j.date_delay,
		i.insp_select = j.insp_select,
		i.pay_con = j.pay_con,
		i.post_wc = j.post_wc,
		i.prod_no = j.prod_no,
		i.lc_no = j.lc_no,
		i.req = j.req,
		i.ao_no = j.ao_no,
		i.date_po = j.date_po,
		i.post_person = j.post_person,
		i.date_last = j.date_last,
		i.date_print_po = j.date_print_po,
		i.trade_no = j.trade_no,
		i.skp = j.skp,
		i.po_post_person = j.po_post_person,
		i.order_type = j.order_type,
		i.etc_price = j.etc_price,
		i.last_ot_no = j.last_ot_no,
		i.po_gubun = j.po_gubun,
		i.qty_reject = j.qty_reject,
		i.issue_no = j.issue_no,
		i.issue_last_no = j.issue_last_no,
		i.import_flag = j.import_flag,
		i.market_flag = j.market_flag,
		i.tn01_seq_all = j.part_seq,
		i.part = j.part,
		i.ship_flag = j.ship_flag,
		i.draw_no = j.draw_no,
		i.hanaro_last_update = getdate()
	from EL_BD..T_VA_020_HANARO i, EL_CD..T_VA_020 j
	where 	i.order_no > '0'
	and j.order_no = i.order_no 
	and	j.supply = 'I'
	and 	(j.date_start between @from_date and @to_date 
		or j.date_last between @from_date and @to_date 
		or j.date_chg between @from_date and @to_date 
		or j.date_due between @from_date and @to_date)
	
	insert into EL_BD..T_VA_020_HANARO
	select 	i.order_no,i.item_no,		
			gaijung = i.gaijung, --case when i.gaijung = 'SPSS' then 'ELES' else i.gaijung end,    -- jjg 2009/05/24 반영
			i.supply,i.run_status,
			i.date_due,i.keep_flag,i.item_unit,i.money_unit,i.price,
			i.price_r,i.qty_order,i.qty_deliv,i.qty_insp,i.qty_acpt,
			i.qty_input,i.qty_cancel,i.date_start,i.date_deliv,i.date_chg,
			i.po_status,i.date_delay,i.insp_select,i.pay_con,i.post_wc,
			i.prod_no,i.lc_no,i.req,i.ao_no,i.date_po,
			i.post_person,i.date_last,i.date_print_po,i.trade_no,i.skp,
			i.po_post_person,i.order_type,i.etc_price,i.last_ot_no,i.po_gubun,
			i.qty_reject,i.issue_no,i.issue_last_no,i.import_flag,i.market_flag,
			i.part_seq,i.part,i.ship_flag,i.draw_no,getdate()
	from EL_CD..T_VA_020 i 
		left join EL_BD..T_VA_020_HANARO j 
			on	i.order_no = j.order_no
	where  i.supply = 'I'
	and	i.run_status in ('4','5')  --방승현 대리 요청. 2004-08-12
	and	i.item_no not like ('H6%')	--Global Product 팀 주문은 수입으로 넘기지 않음(수입에 선주문됨) by sjm 2010-03-15
	and j.order_no is null 

	
	insert into #item
	select distinct item_no from EL_BD..T_VA_020_HANARO
	where hanaro_last_update between @from_date and @to_date
	
	
	update i set
		i.eng_desc=j.eng_desc,
		i.item_group_sub=isnull(j.item_group_sub,''),
		i.block=	isnull(j.block,''),
		i.item_select=isnull(j.item_select,''),
		i.item_unit=isnull(j.item_unit,''),
		i.auto_order_flag=	isnull(j.auto_order_flag,''),
		i.vendor=isnull(j.vendor,''),
		i.po_post_person=isnull(j.po_post_person,''),
		i.size=isnull(j.size,''),
		i.quality=	isnull(j.quality,''),
		i.draw_no=isnull(j.item_no,''),
		i.order_select=	isnull(j.order_select,''),
		i.keep_flag=	isnull(j.keep_flag,''),
		i.date_update=	j.date_update,
		i.rev_no=	isnull(j.rev_no,'00'),
		i.date_receive=	j.date_receive,
		i.price=	isnull(j.price,0),
		i.rout_type=	isnull(j.rout_type,''),
		i.common_flag=	isnull(j.common_flag,''),
		i.drawlastupdate=	isnull(j.drawlastupdate,''),
		i.pdmDrawNo=	isnull(j.pdmDrawNo,''),
		i.pdmJakGu=	isnull(j.pdmJakGu,''),
		i.pdmUniquNo=	isnull(j.pdmUniquNo,''),
		i.pdmPart=	isnull(j.pdmPart,''),
		i.pdmSymBolTypeCode=isnull(j.pdmSymBolTypeCode,''),
		i.pdmProductCode=isnull(j.pdmProductCode,''),
		i.pdmMrpAppliedGubun=isnull(j.pdmMrpAppliedGubun,'L'),
		i.order_style=	isnull(j.order_style,''),
		i.money_unit=	isnull(j.money_unit,'WON'),
		i.item_div=	isnull(j.item_div,''),
		i.gaijung	 = isnull(j.gaijung,''),
		i.hanaro_last_update = getdate()
	from EL_BD..T_CX_060_HANARO i, EL_CD..T_CX_060 j, #item k
	where i.item_no = j.item_no and j.item_no = k.item_no and k.item_no = i.item_no
	
	
	insert into EL_BD..T_CX_060_HANARO
	select 	i.item_no,
		i.eng_desc,
		isnull(i.item_group_sub,''),
		isnull(i.block,''),
		isnull(i.item_select,''),
		isnull(i.item_unit,''),
		isnull(i.auto_order_flag,''),
		isnull(i.vendor,''),
		isnull(i.po_post_person,''),
		isnull(i.size,''),
		isnull(i.quality,''),
		isnull(i.draw_no,i.item_no),
		isnull(i.order_select,''),
		isnull(i.keep_flag,''),
		i.date_update,
		isnull(i.rev_no,'00'),
		i.date_receive,
		isnull(i.price,0),
		isnull(i.rout_type,''),
		isnull(i.common_flag,''),
		isnull(i.drawlastupdate,''),
		isnull(i.pdmDrawNo,''),
		isnull(i.pdmJakGu,''),
		isnull(i.pdmUniquNo,''),
		isnull(i.pdmPart,''),
		isnull(i.pdmSymBolTypeCode,''),
		isnull(i.pdmProductCode,''),
		isnull(i.pdmMrpAppliedGubun,''),
		isnull(i.order_style,''),
		isnull(i.money_unit,'WON'),
		isnull(i.item_div,''),
		isnull(i.gaijung,''),
		getdate()
	from (select i.* from EL_CD..T_CX_060 i, #item j where	i.item_no = j.item_no) i left join  EL_BD..T_CX_060_HANARO j on
		i.item_no = j.item_no
	where j.item_no is null
	
	update a set
	 	lastupdate_date = getdate(),
		work_status = '2'
	from  EL_BD..T_IM_001_HANARO a
	where work_gubun = 'IMPORTUP' and  work_date = @work_date


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_400UZA02                                                                                                                                                     */
/*  DISCRIPTION  : Whisper Flex 수배 제번 생산계획일정 확정시 구매담당자에게 자동 통보                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/
--grant exec on SP_SCH_110_1 to applications

CREATE PROCEDURE [dbo].[SP_SCH_110_1] 
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_110_1  'SCH_110','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg
*/
	select a.project_no, a.mfg_no, a.part, plan_date = convert(varchar(10),a.plan_date,121)
	into #temp
	from el_cd..t_cc_030 a with (index=IX_T_CC_030_1 nolock)
		left outer join el_cd..t_cc_031 b
		on	b.project_no = a.project_no and
			b.mfg_no = a.mfg_no and
			b.hogi = a.hogi and
			b.block = a.block and
			b.part = a.part and
			b.point = a.point and
			b.chng_date < convert(varchar(08),a.confirm_date,112) --확정일에 변경된 것
	where a.confirm_date between dateadd(d,-1,getdate()) and getdate() -- 전날 확정
	and a.point = '4'
	and a.plan_date > dateadd(m,-6,getdate())	--검색시간 단축
	and b.project_no is null

	select a.*
		,b.part_seq
		,b.cont_qty
		,b.item_no
	into #temp1
	from #temp a, el_cd..t_ca_011 b
	where a.project_no > '0'
	and b.project_no = a.project_no
	and b.mfg_no = a.mfg_no
	and b.part = a.part
	and item_no in 
	('AEA03C859*C', 'AEA03C859*D', 'AEA03C859*F',
	'AEA27C901*D', 'AEA27C901*E', 'AEA27C901*G')

	declare @project_no	varchar(11),
			@mfg_no	varchar(03),
			@part	varchar(02),
			@part_seq	varchar(04),
			@item_no	varchar(15),
			@plan_date	varchar(10),
			@cont_qty	float,
			
			@recipients	varchar(255),
			@subject	varchar(255),
			@mail_message	varchar(4000)
	
	
	if exists(select * from #temp1)
	begin
		select @mail_message = '******Whisper Flex 수배 제번 생산계획일정 확정 알림********' + char(13) + char(10)  + char(13) + char(10) 
		select @mail_message =  @mail_message + '    제     번   ' + char(9) + '파트' + char(9) + '항번' + char(9) + '   도      번         ' + char(9) + '생산계획일' + char(9) + '     수    량' + char(13) + char(10) 

		
		DECLARE CUR CURSOR FOR
			SELECT project_no, mfg_no, part, part_seq, item_no, cont_qty,plan_date
			FROM #temp1 
			OPEN	CUR
			FETCH NEXT FROM CUR INTO @project_no, @mfg_no, @part, @part_seq, @item_no, @cont_qty,@plan_date
			
			--한 레코드식 가져오기
			WHILE(@@FETCH_STATUS=0)
			BEGIN
				select @mail_message = @mail_message + @project_no + @mfg_no + char(9) + @part + char(9)  + @part_seq + char(9)  + @item_no  + char(9) + @plan_date  + char(9)
				select @mail_message = @mail_message + right(space(18) + convert(varchar(18),convert(numeric(15,2),@cont_qty)),18) + char(13) + char(10) 
			
				FETCH NEXT FROM CUR INTO @project_no, @mfg_no, @part, @part_seq, @item_no, @cont_qty,@plan_date
			END
		
		CLOSE CUR
		DEALLOCATE CUR
		
		/*Info. Mail Send*/
		select @mail_message = @mail_message + char(13) + char(10) + char(13) + char(10) + '본 메일은 자동 발송 되었습니다.'
		--자동 통보 담당자 : 박대실K, 유정균K
		EXEC msdb.dbo.sp_send_dbmail @profile_name='GP OTIS LG CNS(Chang-Won)',
									@recipients='daespark@otis.co.kr;jgyoo@otis.co.kr',
									@blind_copy_recipients = 'lgkym@otis.co.kr',
									@subject='Whisper Flex 수배 제번 생산계획일정 확정 알림',
									@body=@mail_message 
		
		--exec master..xp_sendmail @recipients = 'daespark@otis.co.kr;jgyoo@otis.co.kr',
		--			@blind_copy_recipients = 'lgkym@otis.co.kr',
		--			@subject = 'Whisper Flex 수배 제번 생산계획일정 확정 알림' , 
		--			@message = @mail_message
		--select @mail_message
	end
	else
	begin
		select @mail_message = @mail_message + '없음' + char(13) + char(10) 
		select @mail_message = @mail_message + '스케줄작업 S_SCH_400UZA02'

		--exec master..xp_sendmail @recipients= 'lgkym@otis.co.kr',	
		--			@subject = 'Whisper Flex 수배 제번 생산계획일정 확정 알림(금일없음)' , 
		--			@message = @mail_message
		EXEC msdb.dbo.sp_send_dbmail @profile_name='GP OTIS LG CNS(Chang-Won)',
									@recipients='lgkym@otis.co.kr',
									@subject='Whisper Flex 수배 제번 생산계획일정 확정 알림(금일없음)',
									@body=@mail_message					
	end

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_120_1                                                                                                                                                     */
/*  DISCRIPTION  : Kit 자동 접수 & Kit                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   Y.M.Kim      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_120_1] 
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_120_1  'SCH_120','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	declare @request_date varchar(8)
	select @request_date  = convert(varchar(8), dateadd(day, -10, getdate()),112)

	exec el_cd.dbo.s_ea_080_8 @request_date ,'EL'
	exec el_cd.dbo.s_ea_080_8 @request_date ,'DW'
	exec el_cd.dbo.s_ea_080_8 @request_date ,'ES'
	exec el_cd.dbo.s_ea_080_8 @request_date ,'GE'
	exec el_cd.dbo.s_ea_080_8 @request_date ,'GL'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_130_1]                                                                                                                                                     */
/*  DISCRIPTION  : DB Reorganization                                              */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/
--grant exec on SP_SCH_130_1 to applications

CREATE PROCEDURE [dbo].[SP_SCH_130_1] 
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_130_1  'SCH_130','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	exec common.dbo.S_MG_000

	

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_140_1                                                                                                                                                     */
/*  DISCRIPTION  : Daily WorksBilling                                                                                                                         */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/
--grant exec on SP_SCH_140_1 to applications

CREATE PROCEDURE [dbo].[SP_SCH_140_1] 
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_140_1  'SCH_140','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/

	exec el_cd.dbo.S_CE_100_2_ADD_DAILY

	exec el_cd.dbo.S_CE_120_1 ' '

	exec el_cd.dbo.S_CE_120_1_DAILY '',''
	
	

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_150_1                                                                                                                                                    */
/*  DISCRIPTION  : Packing Vendor Setting                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_150_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_150_1 'SCH_150','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	exec el_cd.dbo.S_EB_300_Packing_confirm

	

SET NOCOUNT OFF;

/*********************************************************************************
 *
 * PROCEDURE		: SP_SCH_160_1
 *
 * DISCRIPTION		: 주문정보 생성시 검사정보가 없는 Item에 대한 임시 검사 정보 생성
 *
 * RELATIVE FORM	: Schedule Job
 *
 * ALTER  SE		: 박석호
 *
 * ALTER  DAY		: 2003년 4월 24일
 *
 * MODIFICATION_LOG
 *
 *  VER	DATE		CSR#			SE NAME	DESCRIPTION
 *  ----	----------	--------------------	---------	---------------
 *  1.0	2003-04-24	CE) EL QC_482-008	박석호		임시 검사정보의 Table 일원화 (T_QC_048)
 *  2.0	2003-10-23	C2003102101000000722	박석호		무검사일 때의 Default 값 변경
 *  2.1	2004-02-09	C2004020501000000469	박석호		승인자 변경
 *	2006-09-27	[CE) EL QC-482-066]	정아전		임시 부품검사 기준 정보의 확정 방식 개선
 *  								(before	: 저장 -> 작구 -> 확정 -> 종료, after	: 저장 -> 종료, 확정대상 조회 및 승인 추가)
 * 2023-08-08                               UNGJ         거래선  VARCHAR(8)변경                                   
 *******************************************************************************/

CREATE PROCEDURE [dbo].[SP_SCH_160_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_160_1 'SCH_160','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg
*/

	create  table #TEMP_ITEM
	(
		item_no		varchar(15),
		vendor_no	varchar(08)
	)

	INSERT INTO #TEMP_ITEM
	SELECT	distinct item_no,trade_no
	from el_cd..T_va_020 a with (index=ix_t_va_020_B nolock)
	where approve_date between dateadd(day,-3,getdate()) and getdate()
	and run_status < '5'
	and trade_no > '0'
	and a.DATE_START <= convert(char(08),getdate()-180, 112)
	and left(a.gaijung,2) <> 'SY'

	--거래처 상태 'Z' 인 것 삭제
	delete 	a
	from 	#TEMP_ITEM a
	where	exists ( select *
					from el_cd..t_cx_080 b
					where 	a.vendor_no = b.trade_no
					and 	b.value_vendor='Z') 
		or
	
	--검사정보 있는것 삭제
			exists (select *
					from	EL_QC.dbo.T_QC_042 b
					where	a.item_no = b.item_no
					and	a.vendor_no = b.vendor_no)

		or
	
	----임시검사정보 있는것 삭제
			exists (select *
					from	EL_QC.dbo.T_QC_048 b
					where	a.item_no = b.item_no
					and		a.vendor_no = b.vendor_no)
					

	--도번 Item Relation이 존재하는 경우 
	select	b.draw_no, a.item_no, a.vendor_no
	into	#TEMP_RELATION_EXIST
	from	#TEMP_ITEM a,	EL_QC.dbo.T_QC_043 b
	where	a.item_no = b.item_no

	--도번 Item Relation이 존재하지 않는 경우 
	select	a.item_no, a.vendor_no
	into	#TEMP_RELATION_NOTEXIST
	from	#TEMP_ITEM a left join
		EL_QC.dbo.T_QC_043 b
	on	a.item_no = b.item_no
	where	b.item_no is null

	--도번 Item Relation 이 존재하고, 임시검사정보에 존재하지 않는 경우
	select	a.draw_no, a.item_no, a.vendor_no
	into	#TEMP_TEMP_NOTEXIST
	from	#TEMP_RELATION_EXIST a 
		left join EL_QC.dbo.T_QC_048 b
			on	a.item_no = b.item_no and
				a.vendor_no = b.vendor_no
	where	b.item_no is null	
	
	--도번 Item Relation 이 존재하지 않고, 도번검사정보가 존재하는 경우
	select	a.draw_no, a.item_no, a.vendor_no, b.apply_flag
	into	#TEMP_DRAW_EXIST
	from	#TEMP_TEMP_NOTEXIST a,	EL_QC.dbo.T_QC_041 b
	where	a.draw_no = b.draw_no
	and	a.vendor_no = b.vendor_no

	--도번 Item Relation과 도번검사정보가 존재하지 않는 경우
	select	a.draw_no, a.item_no, a.vendor_no
	into	#TEMP_DRAW_NOTEXIST
	from	#TEMP_TEMP_NOTEXIST a
		left join EL_QC.dbo.T_QC_041 b
			on	a.draw_no = b.draw_no and
				a.vendor_no = b.vendor_no
	where	b.draw_no is null	


	
	-- 주차 ITEM은 임시검사정보 생성에서 제외

	DELETE	a
	FROM	#TEMP_DRAW_EXIST a, EL_CD.dbo.T_CX_060 b
	where	a.item_no = b.item_no
	and	b.gaijung = 'SYHP'

	DELETE	a
	FROM	#TEMP_DRAW_NOTEXIST a, EL_CD.dbo.T_CX_060 b
	where	a.item_no = b.item_no
	and	b.gaijung = 'SYHP'

	DELETE	a
	FROM	#TEMP_RELATION_NOTEXIST a, EL_CD.dbo.T_CX_060 b
	where	a.item_no = b.item_no
	and	b.gaijung = 'SYHP'


	--거래처별 검사정보 없고, 도번Item Relation 존재하고, 도번 검사정보가 존재하지 않는 경우 (#TEMP_DRAW_NOTEXIST)
	BEGIN

		--도번 검사정보 임시생성
		--2003-10-23 검사수준, 검사엄격도, 최종검사엄격도, 엄격도진행방향 Data 변경
		insert into EL_QC.dbo.T_QC_041
		select 	distinct draw_no,
			vendor_no,
			insp_method = case when substring( draw_no, 1, 1 ) = 'K' then 'AL' else 'NO' end,
			insp_level = '',
			accept_quality_level = 0,
			approval_person = EL_QC.dbo.fGetQcApprover( draw_no, 'D' ),
			sampling_count = 0,
			insp_strict_range = '',
			final_insp_strict_range = '',
			strict_range_direction = '',
			strict_last_update = getdate(),
			insp_method_last_update = getdate(),
			change_desc = '주문정보 생성시 검사정보 없어서 무검사로 도번 검사정보생성',
--			change_desc = 'Order',
			apply_flag = '0',
			userID = 'SYSTEM',
			last_update = getdate()
		from	#TEMP_DRAW_NOTEXIST
	


/*--------------------------------------------------------------------
-- 	GSS의 진행에 따라 
-- 	임시검사 정보 생성 Logic Holding 요청 --2009-10-14 이종헌K 요청
----------------------------------------------------------------------
		--item 검사정보 임시생성
		--2003-10-23 검사수준, 검사엄격도, 최종검사엄격도, 엄격도진행방향 Data 변경
		insert into EL_QC.dbo.T_QC_048
		select 	item_no,
			vendor_no,
			draw_no,
			insp_method = case when substring( item_no, 1, 1 ) = 'K' then 'AL' else 'NO' end,
			insp_level = '',
			accept_quality_level = 0,
			approval_person = EL_QC.dbo.fGetQcApprover( item_no, 'I' ),
			sampling_count = 0,
			insp_strict_range = '',
			final_insp_strict_range = '',
			strict_range_direction = '',
			strict_last_update = getdate(),
			insp_method_last_update = getdate(),
			change_desc = '주문 정보 생성시 검사정보 없어서 무검사로 검사정보 생성',
--			change_desc = 'Order',
			userID = 'SYSTEM',
			last_update = getdate(),
			confirm_flag = '0',

			source = 'Order',
			mgt_contents = 'NODRW',
			mgt_userID = 'SYSTEM',
			mgt_date = getdate()
		from	#TEMP_DRAW_NOTEXIST
--------------------------------------------------------------------*/

	END

	--도번Item Relation이 존재하지 않는 경우(#TEMP_RELATION_NOTEXIST)
	--2003-10-23 검사수준, 검사엄격도, 최종검사엄격도, 엄격도진행방향 Data 변경
	BEGIN

		--도번Item Relation이 존재하는 것과 존재하지 않는 것에서, 
		--						동일 도번이 있는 것은 
		--						도번Item Relation 만 추가하고, 임시검사정보에 추가하지 않음
		--						동일 도번이 없는 것은, 임시검사정보에 추가함.		
		
		--도번Item Relation 없는 것 Draw_no 를 ITEM M/S 에서 구함
		select	b.draw_no, a.*
		into	#TEMP_RELATION_NOTEXIST_DRAW
		from	#TEMP_RELATION_NOTEXIST a, 	EL_CD.dbo.T_CX_060 b
		where	a.item_no = b.item_no

		--도번Item Relation 존재하는 것과 존재하지 않는 것에서 동일 도번을 가진 것만 추려냄
		select	b.*
		into	#TEMP_RELATION_DRAW_ITEM
		from	#TEMP_RELATION_EXIST a, #TEMP_RELATION_NOTEXIST_DRAW b
		where	a.draw_no = b.draw_no

		--도번Item Relation 존재하는 것과 존재하지 않는 것에서 동일 도번을 가진 것만 추려내서 삭제 - 임시검사정보 추가 하지 않기 위함
		delete	b
		from	#TEMP_RELATION_EXIST a, #TEMP_RELATION_NOTEXIST_DRAW b
		where	a.draw_no = b.draw_no

		--도번Item Relation 존재하는 도번 에서, 존재하는 Item 삭제 - 없는 것만 도번Item Relation 에 추가하기 위함
		delete	a
		from	#TEMP_RELATION_DRAW_ITEM a, el_qc..T_QC_043 b with (index=PK_T_QC_043)
		where	a.item_no = b.item_no

		--도번Item Relation 없는 것 생성 - 임시검사정보 거치지 않고.
		insert into el_qc..T_QC_043
		select	distinct a.item_no, b.draw_no, b.unique_flag,b.kit_item_flag,'SYSTEM',getdate()
		from	#TEMP_RELATION_DRAW_ITEM a,	el_qc..T_QC_043 b with (index=idx_T_QC_043_002)
		where	a.draw_no = b.draw_no

		--도번Item Relation 존재하는 도번 에서, 존재하는 Item 삭제 - 없는 것만 도번Item Relation 에 추가하기 위함
		delete	a
		from	#TEMP_RELATION_DRAW_ITEM a, el_qc..T_QC_042 b with (index=PK_T_QC_042)
		where	a.item_no = b.item_no
		and	a.vendor_no = b.vendor_no

		--도번Item Relation 없어서 생성한 것 중 검사정보가 없는 Item의 업체별 검사정보를 생성
		insert into el_qc..T_QC_042
		select distinct j.item_no,
			j.vendor_no,
			j.draw_no,
			insp_method=case when substring( j.item_no, 1, 1 ) = 'K' then 'AL' else 'NO' end,
			insp_level='',
			accept_quality_level=0.0000,
			i.approval_person,
			sampling_count=0,
			insp_strict_range='',
			final_insp_strict_range='',
			strict_range_direction='',
			strict_last_update = getdate(),
			insp_method_last_update =getdate(),
			change_desc = '주문정보 생성시 존재하는 도번의 신규 ITEM에 대한 검사정보 생성',
			userID = 'SYSTEM',
			getdate(),
			bmp_flag = 'Y'	--2.0
		from	#TEMP_RELATION_DRAW_ITEM j,	el_qc..T_QC_041 i
		where	j.draw_no = i.draw_no		
		

/*-- 존재도번-신규Item-신규거래처 = 임시검사정보 생성

		--도번Item Relation 존재하는 도번 에서, 존재하는 거래처 삭제 - 없는 것만 도번거래처 Relation 에 추가하기 위함
		delete	a
		from	#TEMP_RELATION_DRAW_ITEM a, 
			T_QC_041 b with (index=PK_T_QC_042)
		where	a.draw_no = b.draw_no
		and	a.vendor_no = b.vendor_no

		--도번거래처 Relation 없어서 생성한 것 중 검사정보가 없는 도번의 업체별 검사정보를 전수검사로 생성
		insert into T_QC_041
		select distinct j.draw_no, 
			j.vendor_no,
			insp_method=case when substring( j.item_no, 1, 1 ) = 'K' then 'AL' else 'NO' end,
			insp_level='',
			accept_quality_level=0.0000,
			i.approval_person,
			sampling_count=0,
			insp_strict_range='',
			final_insp_strict_range='',
			strict_range_direction='',
			strict_last_update = getdate(),
			insp_method_last_update =getdate(),
			change_desc = '주문정보 생성시 존재하는 도번의 신규 ITEM에 대한 검사정보 생성',
			apply_flag = '0',
			userID = 'SYSTEM',
			getdate()
		from	T_QC_041 i,
			#TEMP_RELATION_DRAW_ITEM j
		where	i.draw_no = j.draw_no

*/



/*--------------------------------------------------------------------
-- 	GSS의 진행에 따라 
-- 	임시검사 정보 생성 Logic Holding 요청 --2009-10-14 이종헌K 요청
----------------------------------------------------------------------
		insert into EL_QC.dbo.T_QC_048
		select 	item_no,
			vendor_no,
			draw_no = '',
			insp_method = case when substring( item_no, 1, 1 ) = 'K' then 'AL' else 'NO' end,
			insp_level = '',
			accept_quality_level = 0,
			approval_person = EL_QC.dbo.fGetQcApprover( item_no, 'I' ),
			sampling_count = 0,
			insp_strict_range = '',
			final_insp_strict_range = '',
			strict_range_direction = '',
			strict_last_update = getdate(),
			insp_method_last_update = getdate(),
			change_desc = '주문정보 생성시  도번을 모름',
			userID = 'SYSTEM',
			last_update = getdate(),
			confirm_flag = '0',
			source = 'Order',
			mgt_contents = 'NORELAT',
			mgt_userID = 'SYSTEM',
			mgt_date = getdate()
		from	#TEMP_RELATION_NOTEXIST_DRAW
--------------------------------------------------------------------*/

	END


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_170_1                                                                                                                                                 */
/*  DISCRIPTION  : T_VA_010 Table Rebulid-                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/23     MRP Downsizing Project   J.M.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_170_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS

set nocount on 

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_170_1 'SCH_170','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg
*/
	declare @start_date smalldatetime,
			@end_date   smalldatetime
	
	select @start_date = convert(char(08),dateadd(day,-40,getdate()),112) + ' 00:00'
	select @end_date   = convert(char(08),getdate(),112) + ' 23:59'

	update a set
		amut_won_not = 0,
		amut_won=0,
		amut_mold=0,
		sale_amt=0,
		amut_import=0.0
	from el_cd..t_va_010 a with (index=IX_T_VA_010_1)
	where in_date between @start_date and @end_date

/***물품대***/
	select	trade_no,in_date=convert(char(08),date_io,112),gaijung,
			amut_won=sum(case when a.supply <> 'I' then amut_won else 0.0 end),
			amut_mold=sum(amut_mold),
			amut_import=sum(case when a.supply = 'I' then amut_won else 0.0 end)
	into #temp
	from el_cd..t_va_040 a with (index=ix_t_va_040_5 nolock)
	where date_io between @start_date and @end_date
	and store <> 'WHOEM'
	group by trade_no,convert(char(08),date_io,112),gaijung 

	update b set
		amut_won = a.amut_won,
		amut_mold = a.amut_mold,
		amut_import = a.amut_import
	from #temp a,el_cd..t_va_010  b with (index=PK___1__40)
	where a.trade_no > '0'
	and b.trade_no = a.trade_no
	and b.in_date  = a.in_date
	and b.gaijung  = a.gaijung

	insert into el_cd..t_va_010
	select 	trade_no,
			in_date,
			gaijung,
			amut_won,
			0,
			amut_mold,
			amut_mold_not = 0,
			sale_amt = 0,
			amut_won_all_acnt = 0,
			amut_etc_acnt = 0,
			amut_confirm = 0,
			amut_import
	from #temp a
	where not exists (select *
						from el_cd..t_va_010 b with (index=PK___1__40 nolock)
						where b.trade_no = a.trade_no
						and b.in_date  = a.in_date
						and b.gaijung  = a.gaijung)

	
/** 유상판매 ***/
	select trade_no,in_date=convert(char(08),date_issue,112),gaijung,sale_amt=sum(amut)
	into #temp1
	from el_cd..t_va_050  with (index=ix_t_va_050_1 nolock)
	where date_issue between @start_date and @end_date 
	and trade_no > '0'
	group by trade_no,convert(char(08),date_issue,112),gaijung 

	update b set
		sale_amt = a.sale_amt
	from #temp1 a,el_cd..t_va_010  b with (index=PK___1__40)
	where a.trade_no > '0'
	and b.trade_no = a.trade_no
	and b.in_date  = a.in_date
	and b.gaijung  = a.gaijung
	
	insert into el_cd..t_va_010
	select 	trade_no,
			in_date,
			gaijung,
			0,
			0,
			0,
			amut_mold_not = 0,
			sale_amt,
			amut_won_all_acnt = 0,
			amut_etc_acnt = 0,
			amut_confirm = 0,
			amut_import=0
	from #temp1 a
	where not exists (select *
						from el_cd..t_va_010 b with (index=PK___1__40 nolock)
						where b.trade_no = a.trade_no
						and b.in_date  = a.in_date
						and b.gaijung  = a.gaijung)
						
	select @status='0',@out_msg=' OK ...'

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_180_1                                                                                                                                                    */
/*  DISCRIPTION  : Copy Item/Bom from PDM                                                                                                                          */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/03     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_180_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_180_1 'SCH_180','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	exec el_cd.dbo.S_CX_ITEM_BOM

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_190_1                                                                                                                                                  */
/*  DISCRIPTION  : Copy SPec From PDM                                                                                                        */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/03     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[SP_SCH_190_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
	@out_msg	varchar(50) 

EXEC SP_SCH_190_1 'SCH_190','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/

	exec el_qc.dbo.S_QC_SPEC_PDM
	exec el_qc.dbo.S_QC_SPEC_HANARO


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : SP_SCH_200_1                                                                                                                                                    */
/*  DISCRIPTION  : Garbage Collection                                                                                                                        */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/09/03     MRP Downsizing Project   S.H.Song      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_200_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
	
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC [SP_SCH_200_1] 'SCH_200','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	
--Batch JOB Error History Delete
	delete a
	from mrp.dbo.X_Batch_JOB_Error a
	where page between '19100101' and dateadd(day,-30,getdate())


--출하한지 3개월 이상된 ChectSheet 삭제	
	EXEC EL_QC.dbo.S_QC_203_001
	
--VAN Board Delete
	select ref,aa=max(expire_date)
	into	#temp
	from	el_cd..t_board
	WHERE	OPEN_FLAG = '1'
	group by ref 


	delete	a
	from	el_cd..t_board a,#temp b
	where	b.aa < getdate()
	  and	a.ref = b.ref
	  AND	a.OPEN_FLAG = '1'
	  
--t_vj_000 Delete
	delete a
	from el_cd.dbo.T_VJ_000 a
	where update_date < dateadd(day,-10,getdate())

----T_CX_066 Delete
	truncate table el_cd.dbo.T_CX_066

----T_00_000 Delete
	truncate table el_cd.dbo.T_00_000

----T_CP_410,T_CP_411 Delete
	--truncate table el_cd.dbo.T_CP_410
	--truncate table el_cd.dbo.T_CP_411
	
----T_EB_001 Delete
	truncate table el_cd.dbo.T_EB_001

----T_PB_000 Delete
	delete a
	from el_cd.dbo.T_PB_000 a
	where update_date < dateadd(day,-10,getdate())


----T_PB_004 Delete
	delete a
	FROM el_cd.dbo.T_PB_004 a
	where plan_date < dateadd(day,-100,getdate())



SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_210_1]                                                                                  */
/*  DISCRIPTION  : 납품예정번호 완료 처리(잔)                                                                      */ 
/*                                                                                                                 */
/*  >> MODIFICATION LOG <<                                                                                         */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                        */
/*  ---------------------------------------------------------------                                                */
/* 2010/10/13     MRP Downsizing Project   J.J. Park      Initialize                                               */
/*  23/10/30     ITSR72315                   UNGJ            거래선 코드 변경 작업  				               */
/*******************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_210_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_210_1 'SP_SCH_210','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	update a set   
		input_date = (select max(x.date_last) from el_cd..t_va_020 x where x.receipt_expect_no=a.receipt_expect_no)
	from el_cd..t_vj_401 a
	where a.input_date is null
	and a.cancel_flag <> 'y'
	and exists (select * from el_cd..t_va_020 b where b.receipt_expect_no=a.receipt_expect_no)
	and not exists (select * from el_cd..t_va_020 b where b.receipt_expect_no=a.receipt_expect_no and b.run_status <> '5')

	update a set   
		receipt_date = a.input_date
	from el_cd..t_vj_401 a
	where a.receipt_date is  null
	and a.cancel_flag <> 'y'
	and a.input_date is not null




	select x.receipt_expect_no,cnt=sum(x.cnt)
	into #aa_aaa
	from (	select a.receipt_expect_no,cnt=count(*)
		from el_cd..t_vj_401_box a with (index=IX_T_VJ_401_BOX_7 nolock)
			inner join el_cd..t_eb_040 x with (index=IX_T_EB_040_A nolock)
				on x.receipt_expect_no=a.receipt_expect_no
			inner join el_cd..t_eb_050 y with (index=PK_T_EB_050_2__75 nolock)
				on	y.project_no=x.project_no and 
					y.mfg_no=x.mfg_no and
					y.box_no=x.box_no and
					y.divide_seq=x.divide_seq
			inner join el_cd..t_ca_011 z
				on	z.project_no=y.project_no and
					z.mfg_no=y.mfg_no and
					z.part=y.part and
					z.part_seq=y.part_seq
			inner join el_cd..t_va_020 w
				on w.order_no=z.concern_order_no
		where a.remain_cnt between 1 and 999999
		and left(a.receipt_expect_no,1) in ('B','A','N')
		and a.cancel_flag <> 'Y'
		and a.receipt_date is  not null
	
		and (y.ref_project_no is null or y.ref_project_no < '0')

		and z.order_select not in ('A','M')
		and z.concern_order_no > '0'
		and len(rtrim(z.concern_order_no)) < 9

		and w.supply <> 'I'
		and w.run_status <> '5'
		--and (w.trade_no <> '1195056' or (w.trade_no = x.packing_trade_no)) 
		and (w.trade_no <> '35024523' or (w.trade_no = x.packing_trade_no)) 
		group by a.receipt_expect_no

		union

		select a.receipt_expect_no,cnt=count(*)
		from el_cd..t_vj_401_box a with (index=IX_T_VJ_401_BOX_7 nolock)
			inner join el_cd..t_eb_040 x with (index=IX_T_EB_040_A nolock)
				on x.receipt_expect_no=a.receipt_expect_no
			inner join el_cd..t_eb_050 y with (index=IX_T_EB_050_2 nolock)
				on	y.ref_project_no=x.project_no and 
					y.ref_mfg_no=x.mfg_no and
					y.ref_box_no=x.box_no and
					y.ref_divide_seq=x.divide_seq
			inner join el_cd..t_ca_011 z
				on	z.project_no=y.project_no and
					z.mfg_no=y.mfg_no and
					z.part=y.part and
					z.part_seq=y.part_seq
			inner join el_cd..t_va_020 w
				on w.order_no=z.concern_order_no
		where a.remain_cnt between 1 and 999999
		and left(a.receipt_expect_no,1) in ('B','A','N')
		and a.cancel_flag <> 'Y'
		and a.receipt_date is  not null

		and z.order_select not in ('A','M')
		and z.concern_order_no > '0'
		and len(rtrim(z.concern_order_no)) < 9

		and w.supply <> 'I'
		and w.run_status < '5'
		--and (w.trade_no <> '1195056' or (w.trade_no = x.packing_trade_no)) 
		and (w.trade_no <> '35024523' or (w.trade_no = x.packing_trade_no)) 
		group by a.receipt_expect_no ) x
	group by x.receipt_expect_no




	insert into #aa_aaa
	select a.receipt_expect_no,cnt=count(*)
	from el_cd..t_vj_401_box a,el_cd..t_va_020 w with (index=IX_T_VA_020_A nolock)
	where left(a.receipt_expect_no,1)='C'
	and a.remain_cnt > 0
	and a.cancel_flag <> 'Y'
	and a.receipt_date is  not null
	and w.box_receipt_expect_no=a.receipt_expect_no
	and w.supply <> 'I'
	and w.run_status < '5'
	group by a.receipt_expect_no

	
	--주문잔량 초기화(다음날 누적되는 것 방지)
	update a set 
		remain_cnt=0
	from el_cd..t_vj_401_box a
	where remain_cnt > 0
	and cancel_flag <> 'Y'
	and a.receipt_date is  not null

	update b set 
		remain_cnt=a.cnt
	from #aa_aaa a,el_cd..t_vj_401_box b with (index=PK_T_VJ_401_BOX)
	where a.receipt_expect_no > '0'
	and b.receipt_expect_no=a.receipt_expect_no

/*품절해결품 주문잔량에 포함 (2010CW자재SCR_010), 다수제번 무시*/

	select b.receipt_expect_no, a.project_no, a.mfg_no, a.part, a.part_seq
	into #temp
	from el_cd..t_eb_050 a with (nolock), el_cd..t_eb_040 b with (nolock)
	--where a.date_shortage_resolve between dateadd(d,-7,getdate()) and getdate()
	where a.date_shortage_resolve between '20091101' and getdate()
	and a.shortage_flag = 'Z'
	and not exists(select 'Y' from el_cd..t_eb_050 x with (nolock)
			where x.project_no = a.project_no
			and x.mfg_no = a.mfg_no
			and x.part = a.part
			and x.part_seq = a.part_seq
			and x.shortage_flag = 'Y')
	and b.project_no = a.project_no
	and b.mfg_no = a.mfg_no
	and b.box_no = a.box_no
	and b.divide_seq = b.divide_seq
	and left(b.receipt_expect_no,1) in ('B','A','N')


	
	select a.receipt_expect_no, cnt = count(distinct order_no)
	into #temp2
	from #temp a, el_cd..t_ca_011 b with (nolock), el_cd..t_va_020 c with (nolock)
	where b.project_no = a.project_no
	and b.mfg_no = a.mfg_no
	and b.part = a.part
	and b.part_seq = a.part_seq
	and c.order_no = b.concern_order_no
	and c.run_status <> '5'
	group by a.receipt_expect_no


	--주문에 납품서번호를 Update해야 할까??	>> 추가수배주문과 구분이 되지 않아 주석처리함! (20100709)
-- 	update c set c.box_receipt_expect_no =  a.receipt_expect_no, c.box_no = b.box_no
-- 	--select c.order_no,  c.*, a.receipt_expect_no, b.box_no
-- 	from #temp a, t_ca_011 b, t_va_020 c--, t_vj_401_box d
-- 	where b.project_no = a.project_no
-- 	and b.mfg_no = a.mfg_no
-- 	and b.part = a.part
-- 	and b.part_seq = a.part_seq
-- 	and c.order_no = b.concern_order_no
-- 	and c.run_status <> '5'
-- 	and d.receipt_expect_no = a.receipt_expect_no
-- 	and d.input_date is null --도착처리 전의 주문만 유효 (추가수배품에 들어가는 것방지)

	/*품절해결시 주문잔량 추가 */
	update b set 
		b.remain_cnt = b.remain_cnt + cnt
	--select a.receipt_expect_no, cnt, b.remain_cnt
	from #temp2 a, el_cd..t_vj_401_box b
	where b.receipt_expect_no = a.receipt_expect_no

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_220_1]                                                                                                                                                    */
/*  DISCRIPTION  : CTC 시간집계                                                                                                                            */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/13     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_220_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_220_1 'SP_SCH_220','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/
	select GETDATE()
	--exec el_cd..S_NB_050_2 ''


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_230_1]                                                                                                                                                    */
/*  DISCRIPTION  : 이동계획을 위한 파트별 Factory Price생성                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/13     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_230_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_230_1 'SP_SCH_230','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg
*/
	declare @from_yyyymm	char(06),
			@cur_yyyymm		char(06),
			@n				int

	select @cur_yyyymm = substring(convert(char(08),getdate(),112),1,6)

	select @n = 0
	while(@n < 5)
	begin
		select @from_yyyymm = substring(convert(char(08),dateadd(month,@n-1,@cur_yyyymm+'01'),112),1,6)

		exec el_cd.dbo.S_CA_030_FP_PLAN @from_yyyymm

		select @n= @n +1
	end

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_240_1]                                                                                                                                                    */
/*  DISCRIPTION  : 공장 제번 완료 Set                                                                                                                           */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/14     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_240_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_240_1 'SP_SCH_240','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg
*/


--공장 제번 완료 Set 

	declare	@close_month	char(06),
			@project_no	varchar(11),
			@mfg_no	varchar(03),
			@gaijung	char(04)

	declare sds_cursor cursor for 	
		select gaijung,project_no,mfg_no
		from el_cd.dbo.t_cc_010
		where market_flag='C'
		and (hanaro_complete is null or hanaro_complete < '0')
		and gaijung in ( 'ELES' ) --,'SYHP')
	
	open sds_cursor
	FETCH NEXT FROM sds_cursor INTO @gaijung,@project_no,@mfg_no
	WHILE (@@fetch_status <> -1)
	BEGIN
		IF (@@fetch_status <> -2)
		BEGIN
			exec el_nd.dbo.S_Market_Flag_C_Complete_Check @gaijung,@project_no,@mfg_no,@close_month output
		
			if @close_month > '0'
			begin
				update a set
					hanaro_complete=@close_month,backup_date_mrp='19500101'
				from el_cd.dbo.T_CC_010 a
				where project_no=@project_no	
				and mfg_no=@mfg_no
			end
		END
		FETCH NEXT FROM sds_cursor INTO @gaijung,@project_no,@mfg_no
	END
	DEALLOCATE sds_cursor

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_250_1]                                                                                                                                                    */
/*  DISCRIPTION  : DBCC CHECKDB                                                                                                                           */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/14     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_250_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_250_1 'SP_SCH_250','2010-05-12 14:40:55.857',@status output,@out_msg output

select @status,@out_msg

*/

--	DBCC checkdb(tempdb)  -- by sjm 20101109   tempdb에 checkdb는 허용하지 않음 (http://blog.consultdba.com/2010/05/dbcc-checkdb-and-tempdb.html)
	DBCC checkdb(common)
	DBCC checkdb(el_bd) 
	DBCC checkdb(el_qc)
	DBCC checkdb(mrp)
	DBCC checkdb(el_cd)


SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_260_1]                                                                                                                                                    */
/*  DISCRIPTION  : Data Backup & Delete                                                                                                                        */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/14     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_260_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_260_1 'SP_SCH_260','2010-10-14 12:43:43.993',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@project_no	varchar(11),
			@mfg_no		varchar(03)
			

	create table #backup (
		project_no	varchar(11),
		mfg_no		varchar(03)
	)

	insert into #backup
	exec common.dbo.S_BK_010_0_CWDBS03

	DECLARE TTT SCROLL CURSOR FOR
		select	top 150 project_no,mfg_no
		from #backup 
		order by project_no
		
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no
			
	WHILE (@@FETCH_STATUS = 0)	
	begin

		exec OKRDA0D.backup_sys.dbo.S_BK_010_1_Subsidiary_CWDBS03
			@project_no,@mfg_no,@status,@out_msg
		
		exec xp_Common_Batch_Job_Error_Insert 
				@page,@job_id,'1',@status,@out_msg
	
		FETCH NEXT FROM TTT INTO @project_no,@mfg_no

	end
	CLOSE TTT
   	DEALLOCATE TTT

	select @status='0',@out_msg=' Backup & Delete OK ...'
	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : [SP_SCH_270_1]                                                                                                                                                    */
/*  DISCRIPTION  : Data Backup & Delete -CWDS26                                                                                                                       */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/10/14     MRP Downsizing Project   J.J. Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[SP_SCH_270_1]
	@Job_ID		varchar(20),
	@page		datetime,
	@status		char(01)	output,
	@out_msg	varchar(100) output
AS
SET NOCOUNT ON

/*
declare	@status		char(01)	,
		@out_msg	varchar(50) 

EXEC SP_SCH_270_1 'SP_SCH_270','2011-11-30 16:12:46.420',@status output,@out_msg output

select @status,@out_msg

*/
	declare	@project_no	varchar(11),
			@mfg_no		varchar(03)
-- pdm 데이터 백업하지 않음(2019-03-15 lgssha)			
/*
	create table #backup (
		project_no	varchar(11),
		mfg_no		varchar(03)
	)
	
	insert into #backup
	exec common.dbo.S_BK_010_0_CWDS26 '','Y'

	DECLARE TTT SCROLL CURSOR FOR
		select	top 150 project_no,mfg_no
		from #backup 
		order by project_no
		
	OPEN TTT

  	FETCH NEXT FROM TTT INTO @project_no,@mfg_no
			
	WHILE (@@FETCH_STATUS = 0)	
	begin

		exec OKRDA0D.backup_sys.dbo.S_BK_010_1_Subsidiary_CWDS26
			@project_no,@mfg_no,@status,@out_msg
		
		exec xp_Common_Batch_Job_Error_Insert 
				@page,@job_id,'1',@status,@out_msg
	
		FETCH NEXT FROM TTT INTO @project_no,@mfg_no

	end
	CLOSE TTT
   	DEALLOCATE TTT
	*/
	select @status='0',@out_msg=' Backup & Delete OK ...'
	
SET NOCOUNT OFF;

CREATE PROCEDURE dbo.sp_upgraddiagrams
	AS
	BEGIN
		IF OBJECT_ID(N'dbo.sysdiagrams') IS NOT NULL
			return 0;
	
		CREATE TABLE dbo.sysdiagrams
		(
			name sysname NOT NULL,
			principal_id int NOT NULL,	-- we may change it to varbinary(85)
			diagram_id int PRIMARY KEY IDENTITY,
			version int,
	
			definition varbinary(max)
			CONSTRAINT UK_principal_name UNIQUE
			(
				principal_id,
				name
			)
		);


		/* Add this if we need to have some form of extended properties for diagrams */
		/*
		IF OBJECT_ID(N'dbo.sysdiagram_properties') IS NULL
		BEGIN
			CREATE TABLE dbo.sysdiagram_properties
			(
				diagram_id int,
				name sysname,
				value varbinary(max) NOT NULL
			)
		END
		*/

		IF OBJECT_ID(N'dbo.dtproperties') IS NOT NULL
		begin
			insert into dbo.sysdiagrams
			(
				[name],
				[principal_id],
				[version],
				[definition]
			)
			select	 
				convert(sysname, dgnm.[uvalue]),
				DATABASE_PRINCIPAL_ID(N'dbo'),			-- will change to the sid of sa
				0,							-- zero for old format, dgdef.[version],
				dgdef.[lvalue]
			from dbo.[dtproperties] dgnm
				inner join dbo.[dtproperties] dggd on dggd.[property] = 'DtgSchemaGUID' and dggd.[objectid] = dgnm.[objectid]	
				inner join dbo.[dtproperties] dgdef on dgdef.[property] = 'DtgSchemaDATA' and dgdef.[objectid] = dgnm.[objectid]
				
			where dgnm.[property] = 'DtgSchemaNAME' and dggd.[uvalue] like N'_EA3E6268-D998-11CE-9454-00AA00A3F36E_' 
			return 2;
		end
		return 1;
	END;

CREATE PROCEDURE [dbo].[xp_Active_Object_List]
	
AS
SET NOCOUNT ON

	
/** 사용하는 JOB List **/

	select *
	from x_menu
	where use_flag='Y'
	and flag='P'
	


/** 사용하는 programList **/
	select *
	from x_object a
	where a.use_flag='Y' 
	and type='Program'
	order by  USE_COUNT DESC


/** job별 programList **/
	select distinct b.parent_id,b.child_id
	from x_menu a,x_object_relation b
	where a.use_flag='Y' 
	and a.flag not in ('MENU')
	and a.job_type in ('BAT','BMP','MPP')
	and b.Parent_ID = a.child_id
	and b.Parent_type='JOB'
	and b.Child_Type='ProgList'
	order by  b.parent_id,b.child_id

/**사용하는 Segment List ***/
	select c.child_id,cnt=count(*),description=max(d.description),use_flag=max(d.use_flag)
	from x_menu a,x_object_relation b,x_object_relation c,x_object d
	where a.use_flag='Y' 
	and a.flag not in ('MENU')
	and a.job_type in ('BAT','BMP','MPP')
	and b.Parent_ID = a.child_id
	and b.Parent_type='JOB'
	and b.Child_Type='ProgList'
	and c.parent_id= b.child_id
	and c.parent_type='Program'
	and c.child_type='Segment'
	and d.id=c.child_id
	and d.type='segment'
	group by c.child_id
	order by  count(*) 

/** job별 Segment List ***/
	select distinct b.parent_id,d.*
	from x_menu a,x_object_relation b,x_object_relation c,x_object d
	where a.use_flag='Y' 
	and a.flag not in ('MENU')
	and a.job_type in ('BAT','BMP','MPP')
	and b.Parent_ID = a.child_id
	and b.Parent_type='JOB'
	and b.Child_Type='ProgList'
	and c.parent_id= b.child_id
	and c.parent_type='Program'
	and c.child_type='Segment'
	and d.id=c.child_id
	and d.type='segment'
	order by  b.parent_id,d.id
	
/**사용하는 Field List ***/
	select c.child_id,cnt=count(*)
	from x_menu a,x_object_relation b,x_object_relation c
	where a.use_flag='Y' 
	and a.flag not in ('MENU')
	and a.job_type in ('BAT','BMP','MPP')
	and b.Parent_ID = a.child_id
	and b.Parent_type='JOB'
	and b.Child_Type='ProgList'
	and c.parent_id= b.child_id
	and c.parent_type='Program'
	and c.child_type='Field'
	group by c.child_id
	order by  count(*) desc

/** job별 Field List ***/
	select b.parent_id,c.child_id,cnt=count(*)
	from x_menu a,x_object_relation b,x_object_relation c
	where a.use_flag='Y' 
	and a.flag not in ('MENU')
	and a.job_type in ('BAT','BMP','MPP')
	and b.Parent_ID = a.child_id
	and b.Parent_type='JOB'
	and b.Child_Type='ProgList'
	and c.parent_id= b.child_id
	and c.parent_type='Program'
	and c.child_type='Field'
	group by  b.parent_id,c.child_id
	order by  b.parent_id,c.child_id
	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/**************************************************************************************************************/

CREATE PROCEDURE [dbo].[xp_Anal_Condition]
AS
--xp_Anal_Condition
SET NOCOUNT ON
	declare	@str	varchar(1000),
			@indi	int,
			@open_par	int,
			@close_par	int,
			@mid_open_par	int
set rowcount 10
	DECLARE TTT SCROLL CURSOR FOR
		select cond_expr
		from mrp.dbo.T_MYT_06
		where product_code='el'
	OPEN TTT
set rowcount 0

  	FETCH NEXT FROM TTT INTO @str
			

	WHILE (@@FETCH_STATUS = 0)	
	begin
		select 'before=',@str
			
		select @str=replace(replace(replace(@str,' ',''),'or','|'),'and','&')

		select 'after=',@str
		

		select @indi=1
		while(@indi=1)
		begin
			select @open_par=charindex('(',@str) 

			if @open_par > 0
			begin
				select @close_par=charindex(')',@str)
				if @close_par < 1
					select 'not found )'
				else
				begin
					select @mid_open_par=charindex('(',substring(@str,@open_par+1,@close_par-@open_par-2))
					if @mid_open_par > 0
						select 'Added logic needed'
					else
						select ''
				end
			end
			
			select @indi=0
		end		
		
	  	FETCH NEXT FROM TTT INTO @str
	end
	CLOSE TTT
   	DEALLOCATE TTT;

/*******************************************************************************************************************/
/*  SP NAME      : xp_Common_Batch_Job_Error_Insert                                                                                                                                                    */
/*  DISCRIPTION  : Error Message Insert                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/26     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/



CREATE PROCEDURE xp_Common_Batch_Job_Error_Insert
	@page		datetime,
	@job_id		varchar(50),
	@report_sort	char(01),
	@status		char(01),
	@error_message	varchar(255)
	
AS

SET NOCOUNT ON

	if @status > '0'
	begin
	
		begin tran Common_Batch_Job_Error_Insert
	
		insert into X_Batch_JOB_Error values 
			(@page,@job_id,@report_sort,getdate(),@error_message)
	
		commit tran Common_Batch_Job_Error_Insert
	end

SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : xp_Common_BCP_output                                                                                                                                                    */
/*  DISCRIPTION  : BCP Output                                                                                                                      */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/08/25     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[xp_Common_BCP_output]
	@page			datetime,
	@job_id			varchar(50),
	@file_suffix	varchar(01)='1',
	@deliminator	varchar(02)=';'
	
AS
set nocount on

--exec xp_Common_BCP_output '2012-04-12 14:26:32.900','Down_ICD'

	declare	@sql				varchar(4000),
			@server				varchar(100),
			@server2			varchar(100),
			@server_Data_File	varchar(500),
			@server_header_File	varchar(500),
			@server_Result_File	varchar(500),
			@server_Result_File2	varchar(500),
			@ftp_file			varchar(500)

	select @server='D:\FTP\system\'
	select @server2='D:\FTP\system\'

	select @ftp_file = @server + '_Ftp.bat'

	select	@server_Result_File=@server +
			mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page) + '_' +
			@Job_ID + '_' +
			replace(replace(convert(varchar(30),@page,121),':','_'),' ','_') +
			@file_suffix +  '.txt'

	select	@server_Result_File2=@server2 +
			mrp.dbo.fn_Common_Job_Option_Request_UserID(@job_id,@page) + '_' +
			@Job_ID + '_' +
			replace(replace(convert(varchar(30),@page,121),':','_'),' ','_') +
			@file_suffix +  '.txt'
			
			
	select	@server_Data_File=@server + '.data.txt'
	select	@server_header_File=@server + '.head.txt'

	select @sql = 'T_Data_Download' + @file_suffix
	
	truncate table T_Data_Download0
	
	insert into T_Data_Download0
	exec sp_fields_name_merge @sql

	/* FTP Upload*/

	select @sql = 'echo BCP " select * from mrp..T_Data_Download' + @file_suffix + ' " queryout  ' + 
			@server_Data_File + ' -c -t' + @deliminator + ' -Ucwop -Pcwmssqladmin!03 -S ' + 
			convert(varchar(20),serverproperty('servername')) + ' > ' + @ftp_file
	exec master..xp_cmdshell  @sql 

	select @sql = 'echo BCP " select * from mrp..T_Data_Download0 " queryout  ' + 
			@server_header_File + ' -c -t' + @deliminator + ' -Ucwop -Pcwmssqladmin!03 -S ' + 
			convert(varchar(20),serverproperty('servername'))  + ' >> ' + @ftp_file
	exec master..xp_cmdshell  @sql 

	select @sql = 'echo copy ' + @server_header_File + '+' + @server_Data_File  + ' ' + @server_Result_File +
		 ' >> ' + @ftp_file
	exec master..xp_cmdshell @sql

	select @sql = 'echo del ' + @server_header_File  + ' >> ' + @ftp_file
	exec master..xp_cmdshell @sql

	select @sql = 'echo del ' + @server_Data_File +  ' >> ' + @ftp_file
	exec master..xp_cmdshell @sql

	select @sql = 'echo del ' + @ftp_file + ' >> ' + @ftp_file
	exec master..xp_cmdshell @sql


 	exec master..xp_cmdshell @ftp_file

	
	select @sql='  update a set ' + char(13) +
			' 	file_name' + @file_suffix + ' = '''  + @server_Result_File2 + '''' + char(13) +
			' from mrp.dbo.X_batch_JOB_OPTION a ' + char(13) +
			' where a.job_id =''' +  @job_id + '''' + char(13) +
			' and a.page=''' + convert(varchar(30),@page,121) + '''' 
	exec (@sql);

CREATE PROCEDURE [dbo].[xp_Common_Job_End_Setting]
	@job_id		varchar(20),
	@page		datetime,
	@status		char(01),
	@desc		varchar(50)
	
AS

SET NOCOUNT ON

begin tran SP_Common_Job_End_Setting

	update a set
		run_end_date=getdate(),run_status=@status,run_result=@desc
	from X_batch_job_option a
	where job_id=@job_id
	and page = @page

	delete a
	from X_batch_job_Current a with (xlock)
	where page = @page

commit tran SP_Common_Job_End_Setting
	
SET NOCOUNT OFF;

CREATE                PROCEDURE xp_Common_Job_Option_alter
	
AS

SET NOCOUNT ON


	declare	@1stWeekDay	int,
		@1stWeek	int,
		@CurrWeekDay	int,
		@CurrWeek	int,
		@WeekSeq	int

	select @CurrWeekDay=datepart(dw,getdate())
	select @1stWeekDay=datepart(dw,left(convert(char(08),getdate(),112),6)+'01')

	select @1stWeek=datepart(wk,left(convert(char(08),getdate(),112),6)+'01')
	select @CurrWeek=datepart(wk,getdate())

	select @WeekSeq = @CurrWeek - @1stWeek - (case when @1stWeekDay <= @CurrWeekDay then 0 else 1 end) + 1


	insert into X_batch_job_option
	select	job_id=a.job_id
		,page=getdate()
		,request_emp_id='System'
		,run_start_date=null
		,run_end_date=null
		,run_result=''
		,Page_Option=a.Page_Option
		,run_status=''
		,start_date_time=convert(char(08),getdate(),112) + ' ' + start_time + ':00'
		,priority
	from X_JOB_OPTION_PERIOD a,X_Batch_Job b
	where b.job_id=a.job_id
	and b.use_flag='Y'
	and b.job_type = 'S'
	and (	a.period_type='D'  or 
		a.period_type='W'  and substring(a.run_weekday,@CurrWeekDay,1)='1' or
		a.period_type = 'M' and a.run_week = @WeekSeq and substring(a.run_weekday,@CurrWeekDay,1)='1')
	
	
SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : [xp_Common_Job_Option_Create]                                                                                                                                             */
/*  DISCRIPTION  :  정기작업 추가                                                                                                                         */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/08/13     MRP Downsizing Project   Y.M.Kim      Initialize                                                                                                              */
/*********************************************************************************************************************/




CREATE PROCEDURE [dbo].[xp_Common_Job_Option_Create]
	@job_id		varchar(100),
	@page		datetime=null
	
AS
--xp_Common_Job_Option_Create 'mrp_6ei','2010-08-13 16:23:29.327'

SET NOCOUNT ON

	declare	@planned_date_time	datetime
			
	select @planned_date_time=MRP.dbo.fn_Common_Next_schedule_Date(@job_id,
				dateadd(day,
					(case when a.start_time+':00' <= substring(convert(varchar(24),getdate(),120),12,8)
							then  0 else -1 end),
					convert(char(08),getdate(),112) + ' ' + a.start_time + ':00' ) )
	from X_batch_JOB a
	where a.job_id = @job_id
		
	if @planned_date_time is not null
	begin
		insert into X_batch_job_option
		select	job_id=a.job_id
			,page=getdate()
			,a.request_emp_id
			,run_start_date=null
			,run_end_date=null
			,run_result=''
			,Page_Option=a.Page_Option
			,run_status=''
			,planned_date_time=@planned_date_time
			,a.priority
			,'','',''
		from X_batch_JOB_OPTION a
		where a.job_id = @job_id
		and page=@page

	end



SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[xp_Common_Job_Option_Fetch]
	@job_id		varchar(20)	output,
	@page		datetime		output
	
AS

SET NOCOUNT ON
/*
declare	@job_id		varchar(20)	,
	@page		datetime		
exec             SP_Common_Job_Option_Fetch
	@job_id		output,
	@page		output
select @job_id		,	@page		

*/
	select @page=null

	select @page=page,@job_id=job_id
	from X_batch_job_Current a
	
SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : xp_Common_job_runner                                                                                                                                               */
/*  DISCRIPTION  :  대기중인 작업 수행                                                                                                                         */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/03/13     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/


CREATE PROCEDURE [dbo].[xp_Common_job_runner]

AS
SET NOCOUNT ON
--2010-10-18 08:50:31.003

	declare	@statement			nvarchar(500),
			@job_id				varchar(20),
			@page				datetime,
			@run_end_date		datetime,
			@schedule_job_name	varchar(50),
			@status				char(01),
			@out_msg			varchar(100),
			@ParmDefinition		nvarchar(100)


	exec xp_Common_Job_Option_Fetch @job_id output,@page output

	select @schedule_job_name=schedule_job_name
	from X_batch_JOB a
	where a.job_id = @job_id

	select @run_end_date=run_end_date
	from X_batch_JOB_OPTION a
	where a.job_id = @job_id
	and page=@page
	
	exec xp_Common_Job_Start_setting @job_id,@page

	SET @statement=N'EXEC ' + @schedule_job_name + ' @job_id ,@page,@status output,@out_msg output '
	SET @ParmDefinition = N' @job_id varchar(20),@page datetime,@status char(01) output,@out_msg varchar(100) output '

	EXECUTE sp_executesql @statement, @ParmDefinition,
			@job_id,@page,@status output,@out_msg output

	exec xp_Common_Job_End_setting @job_id ,@page,@status,@out_msg

	if @run_end_date is null	--신규작업이면
		exec xp_Common_Job_Option_Create @job_id,@page


SET NOCOUNT OFF;

/*****************************************************************************************************************/
/*  SP NAME      : xp_Common_Job_Start_Setting                                                                                                                                               */
/*  DISCRIPTION  :  작업 시작 표시                                                                                                                         */ 
/*  >> MODIFICATION LOG <<                                                                                                                                                                   */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                                       */
/*  ---------------------------------------------------------------                                                                                              */
/* 2010/03/13     MRP Downsizing Project   J.J.Park      Initialize                                                                                                              */
/*********************************************************************************************************************/

CREATE PROCEDURE [dbo].[xp_Common_Job_Start_Setting]
	@job_id		varchar(20),
	@page		datetime
	
AS

SET NOCOUNT ON

begin tran SP_Common_Job_Start_Setting

	update a set
		run_start_date=getdate(),run_result='작업이 시작되었읍니다',run_end_date=null
	from X_batch_job_option a
	where job_id=@job_id
	and page = @page

commit tran SP_Common_Job_Start_Setting

	
SET NOCOUNT OFF;

/*******************************************************************************************************************/
/*  SP NAME      : xp_Common_Schedule_Job_Inquiry                                                                                                                                                    */
/*  DISCRIPTION  : Batch Job Result Inquiry                                                                                                                             */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/01/25     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[xp_Common_Schedule_Job_Inquiry]
	@flag		char(01),	-- 실행계획시간  A:All,  N:실행전/중 C:실행후
	@user_id	varchar(20),
	@job_id		varchar(50)
	
AS
set nocount on

--exec MRP.dbo.SP_MRP_005_1 'C','lgjjg',''

	

--2010-08-18 11:54:06.657

--select * update a set run_end_date=null from x_batch_job_option a where run_end_date='2010-08-18 11:55:04.763'

set rowcount 200
	if @flag = 'N'
		select 	a.job_id
			,page=convert(varchar(24),a.page,121)
			,request_emp_id
			,run_start_date=convert(varchar(24),a.run_start_date,121)
			,run_end_date=convert(varchar(24),a.run_end_date,121)
			,run_result
			,Page_Option=(case when Page_Option < '0' then 'No Option' else Page_Option end)
			,a.run_status
			,planned_date_time=convert(varchar(24),a.planned_date_time,120)
			,a.priority
			,job_desc=isnull(b.program_name,c.description)
			,color=(case when a.run_end_date is not null 
					then 'Grey'
					else (case when a.run_start_date is not null
						then (case when datediff(mi,a.run_start_date,getdate()) > 20
							then 'Red' else 'Green' end)
						else 'White'
						end)
					end),
			file_name1=isnull(a.file_name1,''),
			file_name2=isnull(a.file_name2,''),
			file_name3=isnull(a.file_name3,''),
			err_exist=(case when exists (select *
						from mrp.dbo.x_batch_job_error b
						where b.page=a.page
						and b.job_id=a.job_id) then 'Y' else 'N' end),
			run_time=0
		from mrp.dbo.x_batch_job_option a with (index=IX_X_Batch_Job_Option_4 nolock)
			left outer join common..program_info b
				on b.program=a.job_id
			left outer join mrp.dbo.x_batch_job c
				on c.job_id=a.job_id
		where a.planned_date_time between dateadd(d,-20,getdate()) and '20400101'
		and a.job_id like rtrim(@job_id) + '%'
		and (@user_id < '0' or  a.request_emp_id=@user_id)
		and	a.run_end_date is null
		order by a.planned_date_time desc,a.page desc
	else if @flag = 'C'
		select 	a.job_id
			,page=convert(varchar(24),a.page,121)
			,request_emp_id
			,run_start_date=convert(varchar(24),a.run_start_date,121)
			,run_end_date=convert(varchar(24),a.run_end_date,121)
			,run_result
			,Page_Option=(case when Page_Option < '0' then 'No Option' else Page_Option end)
			,a.run_status
			,planned_date_time=convert(varchar(24),a.planned_date_time,120)
			,a.priority
			,job_desc=isnull(b.program_name,c.description)
			,color=(case when a.run_end_date is not null 
					then 'Grey'
					else (case when a.run_start_date is not null
						then (case when datediff(mi,a.run_start_date,getdate()) >10
							then 'Red' else 'Green' end)
						else 'White'
						end)
					end),
			file_name1=isnull(a.file_name1,''),
			file_name2=isnull(a.file_name2,''),
			file_name3=isnull(a.file_name3,''),
			err_exist=(case when exists (select *
						from mrp.dbo.x_batch_job_error b
						where b.page=a.page
						and b.job_id=a.job_id) then 'Y' else 'N' end),
			run_time=datediff(ss,a.run_start_date,a.run_end_date)
		from mrp.dbo.x_batch_job_option a with (index=IX_X_Batch_Job_Option_4 nolock)
			left outer join common..program_info b
				on b.program=a.job_id
			left outer join mrp.dbo.x_batch_job c
				on c.job_id=a.job_id
		where a.planned_date_time between dateadd(d,-20,getdate()) and '20400101'
		and a.job_id like rtrim(@job_id) + '%'
		and (@user_id < '0' or  a.request_emp_id=@user_id )
		and	a.run_end_date is not null
		order by a.planned_date_time desc,a.page desc
	else
		select 	a.job_id
			,page=convert(varchar(24),a.page,121)
			,request_emp_id
			,run_start_date=convert(varchar(24),a.run_start_date,121)
			,run_end_date=convert(varchar(24),a.run_end_date,121)
			,run_result
			,Page_Option=(case when Page_Option < '0' then 'No Option' else Page_Option end)
			,a.run_status
			,planned_date_time=convert(varchar(24),a.planned_date_time,120)
			,a.priority
			,job_desc=isnull(b.program_name,c.description)
			,color=(case when a.run_end_date is not null 
					then 'Grey'
					else (case when a.run_start_date is not null
						then (case when datediff(mi,a.run_start_date,getdate()) >10
							then 'Red' else 'Green' end)
						else 'White'
						end)
					end),
			file_name1=isnull(a.file_name1,''),
			file_name2=isnull(a.file_name2,''),
			file_name3=isnull(a.file_name3,''),
			err_exist=(case when exists (select *
						from mrp.dbo.x_batch_job_error b
						where b.page=a.page
						and b.job_id=a.job_id) then 'Y' else 'N' end),
			run_time=(case when a.run_end_date is not null 
						then datediff(ss,a.run_start_date,a.run_end_date)
						else 0
						end)
		from mrp.dbo.x_batch_job_option a with (index=IX_X_Batch_Job_Option_4 nolock)
			left outer join common..program_info b
				on b.program=a.job_id
			left outer join mrp.dbo.x_batch_job c
				on c.job_id=a.job_id
		where a.planned_date_time between dateadd(d,-20,getdate()) and '20401231'
		and a.job_id like rtrim(@job_id) + '%'
		and (@user_id < '0' or  a.request_emp_id=@user_id)
		order by a.planned_date_time desc,a.page desc
	

set rowcount 0;

/*******************************************************************************************************************/
/*  SP NAME      : xp_Common_Scheduler                                                                                                                                                    */
/*  DISCRIPTION  :  Job   Scheduler                                                                                                                                  */ 
/*                                                                                                                                                                                                  */
/*  >> MODIFICATION LOG <<                                                                                                                                                       */ 
/*  DATE        REQUEST #                      S.E NAME         DESCRIPTION                                                                                           */
/*  ---------------------------------------------------------------                                                                                  */
/* 2010/03/19     MRP Downsizing Project   J.J.Park      Initialize                                                                                                 */
/**************************************************************************************************************/


CREATE PROCEDURE [dbo].[xp_Common_Scheduler]
		@job_id		varchar(30)=''
AS

SET NOCOUNT ON

--select * delete from X_batch_job_option where job_id='mrp_6ei' 
--delete from X_batch_job_option where job_id='mrp_6ei' 
--xp_Common_Scheduler 'MRP_6EI'
--select * from X_batch_job_option where job_id='mrp_6ei'
--select * from X_batch_job_Current where 


	declare	@page		datetime,
		@job_desc	varchar(50)


	select @page = null,@job_desc=''

	if exists (select * from X_batch_job_Current)
		return

	select @page=y.page,@job_id=y.job_id,@job_desc=x.schedule_job_name
	from (select top 1 a.job_id,a.page,b.schedule_job_name
			from X_batch_job_option a,X_batch_job b
			where a.run_start_date is null
			and a.planned_date_time between '20090101' and dateadd(mi,-1,getdate())
			and (@job_id < '0' or a.job_id = @job_id)
			and b.job_id=a.job_id
			and b.use_flag = 'Y'
			order by a.planned_date_time,a.priority) x,X_batch_job_option y
	where y.job_id=x.job_id
	and y.page=x.page

	if @page is null
		return
	
	begin tran aa
	insert into X_batch_job_Current  values (@job_id,@page)
	commit tran aa

	WaitFor Delay '00:00:01'
	
	EXEC msdb.dbo.sp_start_job 'JOB Runner' 

	

SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[xp_Common_Scheduler_Recovery]
	
	
AS

SET NOCOUNT ON

	delete from X_Batch_JOB_Current

	
SET NOCOUNT OFF;

CREATE PROCEDURE [dbo].[xp_object_contents_1]
		@id		varchar(10),
		@type		varchar(10),
		@seq		smallint,
		@contents 	varchar(255)
		
AS


	select @contents=rtrim(@contents)

	if  len(@contents) >= 8 and isnumeric(right(@contents,8))=1
		select @contents=rtrim(substring(@contents,1,len(@contents)-8))

	if len(@contents) > 8
		insert into x_object_contents values (@ID,@type,@seq,@contents);

CREATE PROCEDURE [dbo].[xp_object_List_1]
	@path		varchar(100)
AS

	
	while charindex('.',@path) > 0
	begin
		select @path = substring(@path,charindex('.',@path)+1,100)
	end

	select type=(case @path	when 'COPYLIB' 	then 'Segment'
				when 'PROCLIB' 	then 'Proc'
				when 'JCLPDS'	then 'JCL'
				when 'SORBPDS'	then 'Program'
				when 'SUB'	then 'Program'
				when 'SOROPDS'	then 'Program'
				when 'SORPDS'	then 'MFS'
				when 'SORPDSI'	then 'PSB'
				when 'SYSIN'	then 'SYSIN' else '' end),
		subtype=(case @path	when 'COPYLIB' 	then ''
					when 'PROCLIB' 	then ''
					when 'JCLPDS'	then ''
					when 'SORBPDS'	then 'BBB'
					when 'SUB'	then 'SUB'
					when 'SOROPDS'	then 'MPP'
					when 'SORPDS'	then ''
					when 'SORPDSI'	then ''
					when 'SYSIN'	then '' else '' end);

CREATE PROCEDURE [dbo].[xp_object_List_2]
	@ID		varchar(10),
	@type		varchar(10),
	@sub_type	varchar(10)
AS

	declare	@stat	char(01)
	

	if  not exists (select * from x_object where id=@id and type=@type)
	begin
		insert into x_object values (@ID,@type,@sub_type,'','',0,'','xp_objectList_2 ADD')
		select @stat='0'
	end
	else if  exists (select * from x_object where id=@id and type=@type and sub_type=@sub_type)
		select @stat='0'
	else
		select @stat='1'

	if @stat='0'
	begin
		delete from x_object_contents where id=@id and type=@type
	end

	select stat=@stat;
